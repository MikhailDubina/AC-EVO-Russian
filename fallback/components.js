(function (factory) {
    typeof define === 'function' && define.amd ? define(factory) :
    factory();
})((function () { 'use strict';

    var MinFontSize = 10;
    var MaxFontSize = 32;
    var FontSizeFactor = 10;

    const rootElement = document.getElementsByTagName('html')[0];


    /** @returns {HTMLElement} */
    function q(query, owner) {
        if (!owner) owner = document;
        return owner.querySelector(query)
    }
    /** @returns {NodeList} */
    function qAll(query, owner) {
        if (!owner) owner = document;
        return owner.querySelectorAll(query);
    }
    function qev(query, ev, del, owner) {
        var target = typeof query === 'object' ? query : q(query, owner);
        target.addEventListener(ev, del);
    }

    /** @returns {HTMLElement[]} */
    function qAllArray(query, owner = document) {
        var elements = qAll(query, owner);
        return Array.from(elements);
    }

    function fillTemplate(templateString, templateVars) {
        Object.keys(templateVars).forEach(element => {
            templateVars[element] = "<span>" + templateVars[element] + "</span>";
        });
        return new Function("return `" + templateString + "`;").call(templateVars);
    }

    function IsObjectEmpty(target_object) {
        return Object.keys(target_object).length == 0;
    }


    /** add event listener from all */
    function qevAll(query, ev, del, owner = document, options = {}) {
        var eventTypes = ev.split(" ");
        qAllArray(query, owner).forEach(element => {
            eventTypes.forEach(type => {
                element.addEventListener(type, del, options);
            });
        });
    }


    function qevAllOnce(query, event, fn, owner = document) {
        var eventTypes = event.split(" ");
        qAllArray(query, owner).forEach(element => {
            eventTypes.forEach(type => {
                onceEvent(element, type, fn);
            });
        });
    }

    function onceEvent(element, event, fn) {
        var func = function (e) {
            element.removeEventListener(event, func);
            element.hasEvent[event] = false;
            fn(e);
        };
        if (!element.hasEvent)
            element.hasEvent = {};
        else if (element.hasEvent[event]) {
            return;
        }
        element.hasEvent[event] = true;
        element.addEventListener(event, func);
    }

    function qevOnce(query, event, fn, owner = document) {
        var element = $.q(query, owner);
        onceEvent(element, event, fn);
    }

    /** remove event listener from all */
    function qrevAll(query, ev, del, owner = document) {
        var eventTypes = ev.split(" ");
        qAllArray(query, owner).forEach(element => {
            eventTypes.forEach(type => {
                // console.log("removing", type, element.tagName, element.hasEvent, element.id);
                element.removeEventListener(type, del);
            });
        });
    }

    function setCommand(command_name, command_data, handler_success, handler_rejection, silent) {
        if (!command_data) command_data = {};
        if (silent === false) console.log("setCommand", command_name, command_data);
        command_data.__Type = command_name;
        engine.call(command_name, command_data)
            .then(handler_success, handler_rejection)
            .catch((reason) => {
                console.log("Failed setCommand", command_name, reason);
            });
    }

    function triggerUICommand(command_name, command_data, silent) {
        if (!command_data) command_data = {};
        if (silent === false) {
            console.groupCollapsed("OnUICommand", command_name, command_data);
            // console.trace("OnUICommand", command_name, command_data, typeof command_data);
            console.groupEnd();
        }
        command_data.__Type = command_name;
        engine.trigger("OnUICommand", command_name, command_data);
    }

    function roundTo(val, step) {
        return Math.round(val / step) * step;
    }

    // window.triggerUICommand(command_name, command_data, silent) {
    //     triggerUICommand(command_name, command_data, silent);
    // }

    window.message = (message_type, payload) => {
        payload.__Type = message_type;
        return payload;
    };

    window.roundToStep = function (val, step) {
        return roundTo(val, step);
    };

    window.roundToStepPercentString = function (val, step) {
        console.log("round!");
        return roundTo(val * 100, step) + "%";
    };

    function requestResource(url) {
        const request = new XMLHttpRequest();
        const promise = new Promise(function (resolve, reject) {
            request.onload = (response) => {
                if (request.status == 200) {
                    resolve({ template: request.responseText, url: url });
                } else {
                    reject(response);
                }
            };
            request.onerror = reject;
        });
        request.open('GET', url);
        request.send();
        return promise;
    }

    function waitForFrames(callback = () => { }, count = 3, handle = { id: -1 }) {
        if (window.reloading) {
            return;
        }
        if (count === 0) return callback();
        count--;
        handle.id = requestAnimationFrame(() => { waitForFrames(callback, count, handle); });
    }

    window.getFloatAsPercentString = function (value) {
        return (value * 100) + "%";
    };
    var firstresize = true;

    function resize() {

        console.log("Rezize", window.innerWidth, window.innerHeight);

        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;

        const scaleFactorX = windowWidth / 1280;
        const scaleFactorY = windowHeight / 720;

        var scalefactor = Math.min(scaleFactorX, scaleFactorY);
        var fontSize = FontSizeFactor * scalefactor;

        fontSize = Math.max(MinFontSize, fontSize);
        fontSize = Math.min(MaxFontSize, fontSize);

        window["FontScale"] = FontSizeFactor / fontSize;
        window["FontSize"] = fontSize;

        window["ScaleFactors"] = [scalefactor, scaleFactorX, scaleFactorY];
        document.querySelector("html").setAttribute("style", "--scaleFactorX: " + scaleFactorX + "; --fontSize: " + fontSize + "px; --fontScale:" + window["FontScale"]);


        // if (debounceResizeMessage) {
        //     clearTimeout(debounceResizeMessage);
        // }

        // debounceResizeMessage = setTimeout(() => {

        //     var svgElements = document.querySelectorAll('svg');
        //     for (var i = 0; i < svgElements.length; i++) {
        //         var svg = svgElements[i];
        //         if (svg.classList.contains("noredraw")) {
        //             continue;
        //         }
        //         var parent = svg.parentNode;
        //         svg.parentNode.removeChild(svg);
        //         parent.appendChild(svg);
        //     }
        //     if (svgElements.length > 0) console.log('Redrew SVG elements', svgElements.length);
        //     console.log("Resized", windowWidth, windowHeight, window["FontScale"], fontSize);
        // }, 100);


        rootElement.style.fontSize = `${fontSize}px`;
        $.waitForFrames(() => {
            engine.trigger('onResize', firstresize);
            firstresize = false;
        }, 3);
        
    }

    function loadUIConfig(fromfile = false) {
        console.log("Dev mode: loadUIConfig");

        if (fromfile) {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", "uiconfig.json");
            xhr.onload = (e) => {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        console.log("DEV mode: retrieved uiconfig.json");
                        const cfg = JSON.parse(xhr.responseText);
                        if (cfg) {
                            window["ksUIConfig"] = cfg;
                            if (!window["ksUIConfigFile"])
                                engine.createJSModel("ksUIConfigFile", ksUIConfig);
                            else {
                                engine.unregisterModel(ksUIConfigFile);
                                engine.createJSModel("ksUIConfigFile", ksUIConfig);
                            }
                            storeUIConfig(xhr.responseText);
                        } else {
                            storeUIConfig();
                        }
                    }
                    else {
                        storeUIConfig();
                    }
                }
                window["ksUIConfigLoaded"] = true;
            };
            xhr.onerror = (e) => {
                console.error(xhr.statusText);
                window["ksUIConfigLoaded"] = true;
            };
            xhr.send(null);
        } else {
            console.log("DEV mode: retrieved ksUIConfig from localStorage");
            window["ksUIConfig"] = getStoredUIConfig();
            if (!window["ksUIConfigFile"])
                engine.createJSModel("ksUIConfigFile", ksUIConfig);
            else {
                engine.unregisterModel(ksUIConfigFile);
                engine.createJSModel("ksUIConfigFile", ksUIConfig);
            }
        }


    }

    function getStoredUIConfig() {
        return JSON.parse(localStorage.getItem("ksUIConfig"));
    }

    function storeUIConfig(config_text) {
        localStorage.setItem("ksUIConfig", config_text ? config_text : JSON.stringify(window["ksUIConfig"]));
    }

    function isFirstLoad() {
        return localStorage.getItem("game_loaded") != 'true';
    }

    function isDevMode() {
        return navigator.userAgent.indexOf("{Dev}") > -1;
    }

    function isTester() {
        return navigator.userAgent.indexOf("{Tester}") > -1;
    }


    window["ksUIConfig"] = {};
    window["ksUIConfigLoaded"] = false;

    if (isDevMode()) ;

    var $$1 = /*#__PURE__*/Object.freeze({
        __proto__: null,
        q: q,
        qAll: qAll,
        qev: qev,
        qAllArray: qAllArray,
        fillTemplate: fillTemplate,
        IsObjectEmpty: IsObjectEmpty,
        qevAll: qevAll,
        qevAllOnce: qevAllOnce,
        onceEvent: onceEvent,
        qevOnce: qevOnce,
        qrevAll: qrevAll,
        setCommand: setCommand,
        triggerUICommand: triggerUICommand,
        roundTo: roundTo,
        requestResource: requestResource,
        waitForFrames: waitForFrames,
        resize: resize,
        loadUIConfig: loadUIConfig,
        getStoredUIConfig: getStoredUIConfig,
        storeUIConfig: storeUIConfig,
        isFirstLoad: isFirstLoad,
        isDevMode: isDevMode,
        isTester: isTester
    });

    /*---------------------------------------------------------------------------------------------
     *  Copyright (c) Coherent Labs AD. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/

    const newLinesRegExp = new RegExp('^\s+|\s+$', 'g');
    const NATIVE_TEXT_FIELD_ELEMENTS = ['input', 'textarea'];
    window.GUIComponentsDefinedElements = {};

    /**
     * Checks if the passed element is a native text field
     * @param {HTMLElement} element
     * @returns {boolean}
     */
    function isNativeTextField(element) {
        return NATIVE_TEXT_FIELD_ELEMENTS.indexOf(element.tagName.toLowerCase()) > -1;
    }

    // eslint-disable-next-line max-lines-per-function, require-jsdoc
    const components = function () {
        /**
         * This is the base class that holds all functionality shared between custom components
         * and native elements
         */
        class Validator {
            /**
             * Check if element is child of a form
             * @param {HTMLElement} element
             * @returns {boolean}
             */
            static isFormElement(element) {
                element = element.parentElement;
                while (element) {
                    if (element.tagName === 'GAMEFACE-FORM-CONTROL' || element.tagName === 'gameface-form-control') return true;
                    element = element.parentElement;
                }

                return false;
            }

            /**
             * Check if element value is bigger than element maxlength
             * @returns {boolean}
             */
            static tooLong() {
                return false;
            }

            /**
             * Check if element value is less than element minlength
             * @returns {boolean}
             */
            static tooShort() {
                return false;
            }

            /**
             * Checks if the value of an element is bigger than its max attribute
             * @returns {boolean}
            */
            static rangeOverflow() {
                return false;
            }

            /**
             * Checks if the value of an element is smaller than its min attribute
             * @returns {boolean}
            */
            static rangeUnderflow() {
                return false;
            }

            /**
             * Check if element is required and its value is missing
             * @param {HTMLElement} element
             * @returns {boolean}
             */
            static valueMissing(element) {
                return element.hasAttribute('required') && !element.value;
            }

            /**
             * Check if element name is missing
             * @param {HTMLElement} element
             * @returns {boolean}
             */
            static nameMissing(element) {
                return !element.name && !element.getAttribute('name');
            }

            /**
             * Check if an element is required
             * @param {HTMLElement} element
             * @returns {boolean}
            */
            static isRequired(element) {
                return element.hasAttribute('required');
            }

            /**
             * Checks if there is a custom error for the element
             * @returns {boolean}
             */
            static customError() {
                return false;
            }

            /**
             * Checks if element is going to be serialized.
             * If an element doesn't have a name it will not be serialized.
             * Used to determine if an element should be validated.
             * @param {HTMLElement} element
             * @returns {boolean}
            */
            static willSerialize(element) {
                return this.nameMissing(element) ? false : true;
            }

            /* eslint-disable require-jsdoc */
            static isBadURL() {
                return false;
            }

            static isBadEmail() {
                return false;
            }
            /* eslint-enable require-jsdoc */
        }

        /**
         * The NativeElementValidator uses the methods from the Validator class
         * All native elements tha don't support methods like isFormElement, tooLong, tooShort
         * etc.. will be wrapped in this class in order to enable us to validate native and
         * custom elements using the same methods.
         * */
        class NativeElementValidator {
            /* eslint-disable require-jsdoc */

            constructor(element) {
                this.element = element;
            }

            isFormElement() {
                return Validator.isFormElement(this.element);
            }

            tooLong() {
                if (isNativeTextField(this.element)) return TextFieldValidator.tooLong(this.element);
                return Validator.tooLong();
            }

            tooShort() {
                if (isNativeTextField(this.element)) return TextFieldValidator.tooShort(this.element);
                return Validator.tooShort();
            }

            rangeOverflow() {
                if (isNativeTextField(this.element)) return TextFieldValidator.rangeOverflow(this.element);
                return Validator.rangeOverflow();
            }

            rangeUnderflow() {
                if (isNativeTextField(this.element)) return TextFieldValidator.rangeUnderflow(this.element);
                return Validator.rangeUnderflow();
            }

            valueMissing() {
                return Validator.valueMissing(this.element);
            }

            nameMissing() {
                return Validator.nameMissing(this.element);
            }

            customError() {
                return Validator.customError();
            }

            isRequired() {
                return Validator.isRequired(this.element);
            }

            willSerialize() {
                return Validator.willSerialize(this.element);
            }

            isBadEmail() {
                if (isNativeTextField(this.element)) return TextFieldValidator.isBadEmail(this.element);
                return false;
            }

            isBadURL() {
                if (isNativeTextField(this.element)) return TextFieldValidator.isBadURL(this.element);
                return false;
            }
            /* eslint-enable require-jsdoc */
        }

        /**
         * The CustomElementValidator is inherited by custom elements in order to gain the
         * validation function from the Validator class.
         * This class can not be used to wrap the native elements as it inherits the
         * HTMLElement which can not be instantiated using the new keyword.
        */
        class CustomElementValidator extends HTMLElement {
            /* eslint-disable require-jsdoc */

            isFormElement() {
                return Validator.isFormElement(this);
            }

            tooLong() {
                return Validator.tooLong(this);
            }

            tooShort() {
                return Validator.tooShort(this);
            }

            valueMissing() {
                return Validator.valueMissing(this);
            }

            nameMissing() {
                return Validator.nameMissing(this);
            }

            customError() {
                return Validator.customError();
            }

            isRequired() {
                return Validator.isRequired(this);
            }

            rangeOverflow() {
                return Validator.rangeOverflow(this);
            }

            rangeUnderflow() {
                return Validator.rangeUnderflow(this);
            }

            willSerialize() {
                return Validator.willSerialize(this);
            }

            isBadEmail() {
                return Validator.isBadEmail(this);
            }

            isBadURL() {
                return Validator.isBadURL(this);
            }
            /* eslint-enable require-jsdoc */
        }

        /**
         * Class that implements the commong validation methods for the text fields
         */
        class TextFieldValidator {
            /**
             * Most of the custom elements will not need this check however,
             * we call all validation methods in order to determine if an element is valid.
             * Each element that needs this check implements it itself.
             * @param {HTMLElement} element
             * @returns {boolean}
             */
            static tooLong(element) {
                const maxLength = element.getAttribute('maxlength');
                if (!maxLength) return false;
                return element.value.length > parseFloat(maxLength);
            }

            /**
            * Most of the custom elements will not need this check however,
            * we call all validation methods in order to determine if an element is valid.
            * Each element that needs this check implements it itself.
            * @param {HTMLElement} element
            * @returns {boolean}
            */
            static tooShort(element) {
                const minLength = element.getAttribute('minlength');
                if (!minLength) return false;
                return element.value.length < parseFloat(minLength);
            }

            /**
            * Most of the custom elements will not need this check however,
            * we call all validation methods in order to determine if an element is valid.
            * Each element that needs this check implements it itself.
            * @param {HTMLElement} element
            * @returns {boolean}
            */
            static rangeOverflow(element) {
                const max = element.getAttribute('max');
                if (!max) return false;
                return parseFloat(element.value) > parseFloat(max);
            }

            /**
             * Most of the custom elements will not need this check however,
             * we call all validation methods in order to determine if an element is valid.
             * Each element that needs this check implements it itself.
             * @param {HTMLElement} element
             * @returns {boolean}
             */
            static rangeUnderflow(element) {
                const min = element.getAttribute('min');
                if (!min) return false;
                return parseFloat(element.value) < parseFloat(min);
            }

            /**
             * Checks if the text field with type url has a valid url by its pattern
             * @param {HTMLElement} element
             * @returns {boolean}
             */
            static isBadURL(element) {
                if (element.getAttribute('type') !== 'url') return false;
                const pattern = element.pattern || element.getAttribute('pattern');
                if (!pattern) return false;
                if (!element.value.match(pattern)) return true;
                return false;
            }

            /**
             * Checks if the text field element with type email is valid
             * @param {HTMLElement} element
             * @returns {boolean}
             */
            static isBadEmail(element) {
                if (element.getAttribute('type') !== 'email') return false;
                if (!element.value.match('@')) return true;
                return false;
            }
        }

        const GF_COMPONENT_SLOT_TAG_NAME = 'component-slot';
        const KEYCODES = {
            DOWN: 40,
            LEFT: 37,
            RIGHT: 39,
            UP: 38,
            HOME: 36,
            END: 35,
            ENTER: 13,
            ESCAPE: 27,
            TAB: 9,
            SHIFT: 16,
            CTRL: 17,
            SPACE: 32,
            PAGE_UP: 33,
            PAGE_DOWN: 34,
            LETTER_A: 65,
        };

        /**
         * Class that defines the Gameface components
         */
        class GamefaceComponents {
            // eslint-disable-next-line require-jsdoc
            constructor() {
                window.GUIComponentsDefinedElements = {};
                this.imported = this.imported || [];
                this.KEYCODES = KEYCODES;
                this.cachedComponents = {};

                this.CustomElementValidator = CustomElementValidator;
                this.NativeElementValidator = NativeElementValidator;
                this.TextFieldValidator = TextFieldValidator;
                this.Validator = Validator;
            }

            /**
             * Create and add a script tag with given url.
             * @param {string} url
            */
            importScript(url) {
                const script = document.createElement('script');
                script.setAttribute('src', url);
                document.body.appendChild(script);
            }

            /**
             * Loads an html by given url.
             * @param {string} url
             * @returns {promise} resolved with the html as text.
            */
            loadHTML(url) {
                return this.loadResource(url).then((result) => {
                    return result.template;
                });
            }

            /**
             * Creates a promise which resolves when a custom element was defined.
             * Saves the promise for each defined component.
             * @param {string} name - the name of the custom element
             * @returns {promise} - the previously saved promise it any or a new one
            */
            whenDefined(name) {
                // if (window.GUIComponentsDefinedElements[name] !== undefined) {
                //     console.warn("Already defined", name);
                //     return window.GUIComponentsDefinedElements[name].promise;
                // }

                const defined = window.GUIComponentsDefinedElements[name] = {};
                defined.promise = new Promise((resolve, reject) => {
                    defined.resolve = resolve;
                    defined.reject = reject;
                });
                return defined.promise;
            }

            /**
             * Defines a custom element.
             * @param {string} name - the name of the element.
             * @param {Object} element - the object which describes the element.
            */
            defineCustomElement(name, element) {

                // if (window.GUIComponentsDefinedElements[name]) {
                //     console.warn("Already defined", name);
                //     return;
                // }

                this.whenDefined(name);

                if (!customElements.get(name)) {
                    customElements.define(name, element);
                    // customElements.whenDefined(name).then((value) => {
                    //     if (element.name != customElements.get(name).name) {
                    //         console.error("customElements not defined", name, element.name, customElements.get(name).name);
                    //     }
                    // });
                }

                if (typeof element != "function") {
                    console.warn("defineCustomElement", name, typeof element);
                    return;
                }

                //window.GUIComponentsDefinedElements[name].resolve(element);
            }

            /**
             * Imports a component by given url.
             * It will automatically try to import style.css and script.js if these
             * files' names were not explicitly specified.
             * @param {string} url - the url of the component
            */
            importComponent(url) {
                requestAnimationFrame(() => {
                    this.importScript(url + '/script.js');
                });
            }

            /**
             * Removes back and forward slashes from string
             * @param {string} path
             * @returns {string}
             */
            removeSlashes(path) {
                return path.replace(/[/|\\]/g, '');
            }

            /**
             * Remove new lines from the beginning of templates,
             * because template.firstChild.cloneNode will clone an empty
             * string and will return an empty template.
             * @param {string} template
             * @returns {string}
            */
            removeNewLines(template) {
                return template.replace(newLinesRegExp, '').trim();
            }

            /**
             * Removes the copyright notice from the template
             * @param {string} template
             * @returns {string} the template without the copyright notice
            */
            removeCopyrightNotice(template) {
                return template.replace(`<!--Copyright (c) Coherent Labs AD. All rights reserved. Licensed under the MIT License. See License.txt in the project root for license information. -->`, '').trim();
            }

            /**
             * Used when the element has already been rendered.
             * Return the already rendered template instead of
             * loading and slotting its elements.
             *
             * @param {HTMLElement} component - the component that was rendered
             * @returns {Promise<HTMLElement>} - a promise that will resolve with the rendered template
            */
            resolveWithTemplate(component) {
                return new Promise((resolve) => {
                    resolve({
                        template: component.template.cloneNode(true),
                        url: component.url,
                    });
                });
            }

            /**
             * Uses an XMLHttpRequest to load an external file.
             * @param {string} component - the url of the file.
             * @returns {promise} - a promise that is resolved with the file's text content.
            */
            loadResource(component) {

                //console.log("components.loadResource", component.tagName, component.url, component.constructor.name);

                if (component.template && typeof component.template === 'string') {

                    if (component.isRendered) return this.resolveWithTemplate(component);
                    const element = document.createElement('div');
                    const template = this.removeCopyrightNotice(component.template);
                    element.innerHTML = this.removeNewLines(template);

                    return new Promise((resolve) => {
                        resolve({
                            template: element.firstChild.cloneNode(true),
                            url: component.url,
                        });
                    });
                }

                if (typeof component.template === 'object' && component.isRendered) {
                    //console.log("loadResource object");
                    return this.resolveWithTemplate(component);
                }

                if (window.__optimize) {
                    const id = this.removeSlashes(component.url);
                    const element = document.getElementById(id).firstChild;
                    // fallback to XHR
                    if (!element) return this.requestResource(component.url);

                    return new Promise((resolve) => {
                        resolve({ template: element.cloneNode(true), url: component.url });
                    });
                }

                //console.warn("components.loadResource", "last resort", component.tagName, component.url, component.constructor.name);

                return this.requestResource(component.url);
            }

            retry = 0;

            /**
             * Execute an XMLHttpRequest to load a resource by url.
             * @param {string} url - the path to the resource
             * @returns {promise} - promise which resolves with the loaded resource
            */
            requestResource(url) {
                console.warn("components.requestResource", url);
                const request = new XMLHttpRequest();
                const promise = new Promise(function (resolve, reject) {
                    request.onload = (response) => {
                        if (request.status == 200) {
                            const tempEl = document.createElement('div');
                            tempEl.innerHTML = request.responseText;
                            resolve({ template: tempEl.firstChild.cloneNode(true), url: url });
                        } else {
                            reject(response);
                        }
                    };
                    request.onerror = reject;
                });
                request.open('GET', url);
                request.send();
                return promise;
            }

            /**
             * Recursively finds the slot elements in a given element.
             * @param {HTMLElement} parent - the element which is searched for slots.
             * @param {string} parentElName
             * @param {object} result - a key:value object containing the slot elements
             * under their data-name as value:
             * { <my-slot-name>: HTMLElement }
             * @returns {Object} result
            */
            findSlots(parent, parentElName, result = {}) {
                const children = parent.children;
                const length = children.length;

                for (let i = 0; i < length; ++i) {
                    const child = children[i];
                    const childTagName = child.tagName.toLowerCase();

                    if (child instanceof ComponentSlot) {
                        const name = child.dataset.name;
                        if (!result[name]) result[name] = [];
                        result[name].push(child);
                        this.findSlots(child, parentElName, result);
                    } else if (child.hasAttribute('slot')) {
                        const slot = child.getAttribute('slot');
                        if (!result[slot]) result[slot] = [];
                        result[slot].push(child);
                        this.findSlots(child, parentElName, result);
                        // the scrollable container is the ONLY component that can hold
                        // slots of another elements; we allow this in order achieve
                        // better integration of the scrollbar inside other components
                        // The WebComponents and the standard slot elements don't support
                        // such behavior; an element handles only its own slots. The scrollable
                        // container is an exception from this rule.
                    } else if (childTagName === 'gameface-scrollable-container' ||
                        (childTagName !== GF_COMPONENT_SLOT_TAG_NAME &&
                            parentElName !== childTagName &&
                            !window.GUIComponentsDefinedElements[childTagName])) {
                        // if the child is another nested element don't look for slots in it
                        this.findSlots(child, parentElName, result);
                    }
                }

                return result;
            }

            /**
             * Will replace the slot element
             * @param {HTMLElement[]} source
             * @param {HTMLElement} target
             */
            replaceSlots(source, target) {
                const fakeRoot = target[0];
                if (source.length && fakeRoot.childNodes.length) {
                    while (fakeRoot.firstChild) {
                        fakeRoot.removeChild(fakeRoot.lastChild);
                    }
                }
                // remove the slot so that it can be replaced
                const parent = fakeRoot.parentNode;
                parent.removeChild(fakeRoot);

                for (let i = 0; i < source.length; ++i) {
                    parent.appendChild(source[i]);
                }
            }

            /**
             * Transfers the slottable elements into their slots.
             * @param {HTMLElement} source - the element containing the slottable elements.
             * @param {HTMLElement} target - the element containing the slots elements.
            */
            transferContent(source, target) {
                // if (target.closest("ks-page-gamemode")) {
                //     console.warn(target.tagName, "transferContent", target.childNodes.length, source.childNodes.length, target.innerHTML);
                // }

                while (target.childNodes.length > 0) {
                    const nodes = target.childNodes;
                    target.removeChild(nodes[nodes.length - 1]);
                }
                while (source.childNodes.length > 0) {
                    const nodes = source.childNodes;
                    const node = nodes[0];
                    source.removeChild(node);
                    target.appendChild(node);
                }
            }

            /**
             * Renderes an element only if it wasn't rendered before that
             * @param {HTMLElement} element
             * @returns {boolean} - true if it was rendered, false if not
            */
            renderOnce(element, callback) {
                if (element.isRendered || !element.isConnected) {
                    return false;
                }

                // if (element.tagName == "ks-page-gamemode") {
                //     console.warn(element.tagName, "> renderOnce", element.isRendered);
                // }

                if (customElements.get(element.tagName)) {
                    if (element.constructor.name != customElements.get(element.tagName).name) {
                        console.warn(element.tagName, "renderOnce for", element.constructor.name, "registered with", customElements.get(element.tagName).name);
                    }
                }
                //}
                this.render(element, callback);
                element.isRendered = true;

                return true;
            }

            /**
            * Renders an element's content into its template.
            * @param {HTMLElement} element - the element into which to render the content
            */
            render(element, callback) {
                const templateRoot = document.createElement('div');
                templateRoot.appendChild(element.template);

                const parentElName = element.tagName.toLowerCase();

                const templateSlots = this.findSlots(templateRoot, parentElName);
                const userSlots = this.findSlots(element, parentElName);

                // use for...of instead of for...in for better performance
                const userSlotsKeys = Object.keys(userSlots);
                const templateSlotsKeys = Object.keys(templateSlots);

                // there's no point in looping over userSlots if there aren't
                // corresponding template slots
                if (templateSlotsKeys.length) {
                    for (const userSlot of userSlotsKeys) {
                        if (!userSlots[userSlot] || !templateSlots[userSlot]) continue;
                        this.replaceSlots(userSlots[userSlot], templateSlots[userSlot]);
                    }
                }

                if (customElements.get(element.tagName) && element.constructor.name != customElements.get(element.tagName).name) {
                    console.warn(element.tagName, "render", element.constructor.name, "registered with", customElements.get(element.tagName).name);
                }

                this.transferContent(templateRoot, element);
                if (callback)
                    callback(this);
            }

            /**
             * Used to render.
             * @param {HTMLElement} element - the element which will be rendered
             * @param {string} targetContainerSelector - the selector of the parent element
             * @param {Array<HTMLElement>} children - the child elements that need to go into the parent
             */
            transferChildren(element, targetContainerSelector, children) {
                const templateRoot = document.createElement('div');
                templateRoot.appendChild(element.template);
                const container = templateRoot.querySelector(targetContainerSelector);

                children.forEach(child => container.appendChild(child));

                this.transferContent(templateRoot, element);
            }

            /**
             * Delay the execution of a callback function by n amount of frames.
             * Used to retrieve the computed styles of elements.
             * @param {Function} callback - the function that will be executed.
             * @param {number} count - the amount of frames that the callback execution
             * should be delayed by.
             * @returns {any}
            */
            waitForFrames(callback = () => { }, count = 3) {
                if (window.reloading) return;
                if (count === 0) return callback();
                count--;
                return requestAnimationFrame(() => { return this.waitForFrames(callback, count) });
            }

            /**
             * Checks if the current user agent is Cohtml
             * @returns {boolean}
            */
            isBrowserGameface() {
                return navigator.userAgent.match('Cohtml');
            }
        }

        const components = new GamefaceComponents();

        /**
         * Class used to import gameface components
         */
        class ComponentImport extends HTMLElement {
            /* eslint-disable require-jsdoc */
            constructor() {
                super();
            }

            connectedCallback() {
                const url = `/components/${this.dataset.url}/`;
                const componentName = `gameface-${this.dataset.url}`;

                if (components.imported.indexOf(componentName) === -1) {
                    components.importComponent(url);
                    components.imported.push(componentName);
                }
                this.appendChild(document.createElement(componentName));
            }
            /* eslint-enable require-jsdoc */
        }

        /**
         * Class that will handle gameface components slot element
         */
        class ComponentSlot extends HTMLElement {
            /* eslint-disable require-jsdoc */

            constructor() {
                super();

                this.originalAppendChild = this.appendChild;
                this.originalInsertBefore = this.insertBefore;
                this.originalReplaceChild = this.replaceChild;
                this.originalRemoveChild = this.removeChild;

                this.appendChild = (node) => {
                    const child = this.originalAppendChild(node);
                    this.disptachSlotChange(child);

                    return child;
                };

                this.insertBefore = (newNode, referenceNode) => {
                    const child = this.originalInsertBefore(newNode, referenceNode);
                    this.disptachSlotChange(child);

                    return child;
                };

                this.replaceChild = (newChild, oldChild) => {
                    const replacedNode = this.originalReplaceChild(newChild, oldChild);
                    this.disptachSlotChange(replacedNode);

                    return replacedNode;
                };

                this.removeChild = (child) => {
                    const removedNode = this.originalRemoveChild(child);
                    this.disptachSlotChange(removedNode);

                    return removedNode;
                };
            }

            disptachSlotChange(child) {
                this.dispatchEvent(new CustomEvent('slotchange'), {
                    target: this,
                    child: child,
                });
            }

            /* eslint-enable require-jsdoc */
        }

        var retries = 0;

        function register() {
            if (!customElements || !customElements.whenDefined || !customElements.get || !customElements.define) {
                console.warn("GameFace components customElements non init - retrying");
                if (retries < 5) {
                    waitForFrames(() => {
                        register();
                        retries++;
                    }, 1);
                } else {
                    console.error("GameFace components customElements non init - giving up");
                    window.location.reload(true);
                }
            } else {
                components.defineCustomElement('component-import', ComponentImport);
                components.defineCustomElement(GF_COMPONENT_SLOT_TAG_NAME, ComponentSlot);
            }
        }

        register();

        return components;
    };

    var components$1 = components();

    var verticalTemplate$1 = "<!--Copyright (c) Coherent Labs AD. All rights reserved. Licensed under the MIT License. See License.txt in the project root for license information. -->\r\n<div class=\"guic-vertical-rangeslider-wrapper\">\r\n    <div class=\"guic-vertical-rangeslider\">\r\n        <div class=\"guic-vertical-rangeslider-bar\"></div>\r\n        <div class=\"guic-vertical-rangeslider-handle\"></div>\r\n    </div>\r\n</div>\r\n";

    var verticalTemplateTwoHandles = "<!--Copyright (c) Coherent Labs AD. All rights reserved. Licensed under the MIT License. See License.txt in the project root for license information. -->\r\n<div class=\"guic-vertical-rangeslider-wrapper\">\r\n    <div class=\"guic-vertical-rangeslider\">\r\n        <div class=\"guic-vertical-rangeslider-handle handle-0\"></div>\r\n        <div class=\"guic-vertical-rangeslider-bar\"></div>\r\n        <div class=\"guic-vertical-rangeslider-handle handle-1\"></div>\r\n    </div>\r\n</div>\r\n";

    var horizontalTemplate$1 = "<!--Copyright (c) Coherent Labs AD. All rights reserved. Licensed under the MIT License. See License.txt in the project root for license information. -->\r\n<div class=\"guic-horizontal-rangeslider-wrapper\">\r\n    <div class=\"guic-horizontal-rangeslider\">\r\n        <div class=\"guic-horizontal-rangeslider-bar\"></div>\r\n        <div class=\"guic-horizontal-rangeslider-handle\"></div>\r\n    </div>\r\n</div>\r\n";

    var horizontalTemplateTwoHandles = "<!--Copyright (c) Coherent Labs AD. All rights reserved. Licensed under the MIT License. See License.txt in the project root for license information. -->\r\n<div class=\"guic-horizontal-rangeslider-wrapper\">\r\n    <div class=\"guic-horizontal-rangeslider\">\r\n        <div class=\"guic-horizontal-rangeslider-handle handle-0\"></div>\r\n        <div class=\"guic-horizontal-rangeslider-bar\"></div>\r\n        <div class=\"guic-horizontal-rangeslider-handle handle-1\"></div>\r\n    </div>\r\n</div>\r\n";

    /*---------------------------------------------------------------------------------------------
     *  Copyright (c) Coherent Labs AD. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/

    const orientationUnitsNames$1 = new Map([
        ['vertical', {
            mouseAxisCoords: 'clientY',
            size: 'height',
            position: 'top',
            coordinate: 'y',
        }],
        ['horizontal', {
            mouseAxisCoords: 'clientX',
            size: 'width',
            position: 'left',
            coordinate: 'x',
        }]
    ]);

    /* eslint-disable linebreak-style */

    const ORIENTATIONS = ['vertical', 'horizontal'];
    const SPACE_BETWEEN_GRID_POLS = 10;
    const CustomElementValidator = components$1.CustomElementValidator;

    const customHandleVariableNames = {
        SINGLE: 'customHandle',
        LEFT: 'customHandleLeft',
        RIGHT: 'customHandleRight',
    };

    /**
     * Rangeslider component, allows you to specify a numeric value by using a slider.
     * It must be no less than a given value, and no more than another given value.
     */
    class Rangeslider extends CustomElementValidator {

        #debug = false;
        #parentid;
        #uniqueid;
        _min;
        _max;
        _off;
        _value;
        _index;
        _values;
        _precision = 0;
        _sizes;


        get sizes() {
            if (this._sizes == undefined ||
                (this._sizes.width == 0 &&
                    this._sizes.height == 0)
            ) {
                this._sizes = this.getRangeSliderSize();
            }
            return this._sizes;
        }

        set sizes(value) {
            this._sizes = value;
        }

        resetSize() {
            this._sizes = undefined;
        }

        set precision(value) {
            this._precision = value;
        }

        get precision() {
            return this._precision;
        }

        set off(value) {
            this._off = value;
        }

        get off() {
            return this._off;
        }

        /**
         * Sets the minimum value of the slider
         * @param {number} value
         */
        set min(value) {
            this._min = value;
        }

        /**
         * Gets the minimum value of the slider
         * @returns {number}
         */
        get min() {
            return this._min;
        }

        /**
         * Sets the maximum value of the slider
         * @param {number} value
         */
        set max(value) {
            this._max = value;
        }

        /**
         * Gets the maximum value of the slider
         * @returns {number}
         */
        get max() {
            return this._max;
        }

        // eslint-disable-next-line require-jsdoc
        get value() {
            return this._value[0];
        }

        // eslint-disable-next-line require-jsdoc
        set value(value) {
            this._value = value;
        }

        get values() {
            return this._values;
        }

        set values(value) {
            this._values = value;
        }

        get index() {
            return this._index;
        }

        set index(value) {
            this._index = value;
        }

        setValue(newvalue) {

            let target = 0;

            if (this.#debug) {
                console.warn(">>> newvalue", newvalue);
                console.warn(">>> _values", this._values);
            }

            if (this._values && this._values.length > 0) {
                target = newvalue * (100 / (this._values.length - 1));
                if (this.#debug)
                    console.warn(">> setValue valuesarray", target, newvalue);
            } else {

                target =
                    this.twoHandles ?
                        [
                            Rangeslider.valueToPercent(newvalue[0] - this.min, this.min, this.max),
                            Rangeslider.valueToPercent(newvalue[1] - this.min, this.min, this.max)
                        ] :
                        Rangeslider.valueToPercent(newvalue - this.min, this.min, this.max);

                if (this.#debug)
                    console.warn(">> setValue (0)", target, newvalue, this.min, this.max);
            }

            if (this.#initialized) {
                if (this.#debug)
                    console.warn(">> setValue initialized", target, newvalue);

                this.twoHandles ?
                    target.forEach((p, i) => this.updateSliderPosition(p, i)) :
                    this.updateSliderPosition(target, 0);


            }

            if (this.#debug) {
                console.warn(">> setValue end", newvalue, target);
            }

        }

        /**
         * Converts a value to percent in a range
         * @param {number} value - the value to be converted
         * @param {number} min - the minimum value of the range
         * @param {number} max - the maximum number of the range
         * @returns {number} - returns the value in percent
         */
        static valueToPercent(value, min, max, debug = false) {
            if (debug) {
                console.trace("valueToPercent", value, min, max, ((value) * 100) / (max - min));
            }
            return ((value) * 100) / (max - min);
        }

        /**
         * Restricts a given value in a range
         * @param {number} val - the value to be restricted
         * @param {number} min - the minimum value of the range
         * @param {number} max - the maximum number of the range
         * @returns {number}
         */
        static clamp(val, min, max) {
            return Math.min(Math.max(val, min), max);
        }

        // eslint-disable-next-line require-jsdoc
        constructor() {
            super();
            this.#uniqueid = 'xxxx-xxxx-xxx-xxxx'.replace(/[x]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });

            this.onMouseDown = this.onMouseDown.bind(this);
            this.onMouseMove = this.onMouseMove.bind(this);
            this.onMouseUp = this.onMouseUp.bind(this);

            this._value = [];

        }

        /**
         * Will display a custom error if the slider has two handles and it is wrapped inside a gameface form control element
         * @returns {boolean}
         */
        customError() {
            if (this.hasAttribute('two-handles')) {
                console.warn('gameface-rangeslider component does not support form data when "two-handles" attribute is used!');
                return true;
            }

            return false;
        }

        /**
         * Checks if the range slider has value
         * @returns {boolean}
         */
        valueMissing() {
            if (!this._value && !this._value[0]) return true;
            return false;
        }

        /**
         * Called when the element was attached to the DOM.
         */
        connectedCallback() {

            if (customElements.get && customElements.get(this.tagName)) {
                if (this.constructor.name != customElements.get(this.tagName).name) {
                    console.error("Class mismatch", this.tagName, this.constructor.name, customElements.get(this.tagName).name);
                    //delete components.definedElements[this.tagName];
                    //components.defineCustomElement(this.tagName, this);
                    //console.error(components.definedElements[this.tagName].constructor.name);
                    ksUI.inPlaceRecovery(this);

                    // if (!ksUI.reloading) {
                    //     ksUI.reloading = true;
                    //     $.waitForFrames(() => {
                    //         console.error("reloading for", this.tagName, customElements.get(this.tagName).name);
                    //         window.location.reload(true);
                    //     }, 1);
                    // }
                    return;
                }
            }

            if (this.closest("ks-slider")) {
                this.#parentid = this.closest("ks-slider").getAttribute("id");
                this.#debug = this.closest("ks-slider").hasAttribute("debug");
            }

            if (this.#debug)
                console.log("slider.connectedCallback", this.#uniqueid, "connected:", this.isConnected, "rendered:", this.isRendered);

            // check if component has already been rendered if not
            if (!this.isRendered) {
                // use the template for the current slider orientation and number of handles
                this.template = this.getTemplate(this.orientation, this.twoHandles);
                if (this.#debug) {
                    console.warn("isRendered getTemplate", this.orientation, this.twoHandles);
                }
            }

            // Load the template
            components$1
                .loadResource(this)
                .then((result) => {
                    this.template = result.template;
                    // render the template
                    components$1.renderOnce(this);
                    // do the initial setup - add event listeners, assign members
                    this.setup();
                }).catch(err => console.error(JSON.stringify(err)));
        }

        #disconnected;

        disconnectedCallback() {
            //if (this.#parentid) {
            if (this.#debug)
                console.log("slider.disconnectedcallback", this.#parentid, this.#uniqueid);
            //}
            this.#disconnected = true;
            //console.log("disconnectedCallback", this.#uniqueid);
            cancelAnimationFrame(this.#waitforframeid);
        }

        /**
         * Checks if the orientation passed is vertical or horizontal, if it's neither it's set to horizontal
         * @param {string} orientation - the orientation string
         * @returns {string} - horizontal or vertical;
         */
        checkOrientation(orientation) {
            return ORIENTATIONS.includes(orientation) ? orientation : 'horizontal';
        }

        /**
         * Gets the correct template to be loaded for the rangeslider
         * @param {string} orientation - the orientation of the slider
         * @param {boolean} twoHandles - if there are two handles
         * @returns {string}
         */
        getTemplate(orientation, twoHandles) {
            if (this.#debug) {
                console.warn("getTemplate", orientation, twoHandles);
            }
            if (orientation === 'vertical') {
                return twoHandles ? verticalTemplateTwoHandles : verticalTemplate$1;
            }

            return twoHandles ? horizontalTemplateTwoHandles : horizontalTemplate$1;
        }

        /**
         * Will validate the custom handle selector and if element with that selector exists.
         * @param {string} customHandleSelector
         * @param {HTMLElement} customHandleElement
         */
        validateCustomHandle(customHandleSelector, customHandleElement) {
            if (customHandleSelector && !customHandleElement) {
                console.warn(`Unable to find element with selector - "${customHandleSelector}" that will be used for displaying the range slider value.`);
            }
        }

        /**
         * Will set the thumb if this option is enabled
         */
        setThumb() {
            // if the thumb attribute is added, the thumbs are created
            if (this.thumb) {
                // creates two thumbs
                this.twoHandles ? this._value.forEach(val => this.buildThumb(val)) : this.buildThumb(this.value);

                this.thumbElement = !this.twoHandles ?
                    [this.querySelector(`.guic-${this.orientation}-rangeslider-thumb`)] :
                    this.querySelectorAll(`.guic-${this.orientation}-rangeslider-thumb`);
            }
        }

        /**
         * Will initialize the custom handles variables
         */
        initCustomhandles() {
            const customHandleSelectors = {
                SINGLE: this.getAttribute('custom-handle'),
                LEFT: this.getAttribute('custom-handle-left'),
                RIGHT: this.getAttribute('custom-handle-right'),
            };

            for (const key of Object.keys(customHandleSelectors)) {
                const customHandleVariableName = customHandleVariableNames[key];
                const customHandleSelector = customHandleSelectors[key];

                this[customHandleVariableName] = customHandleSelector ? document.querySelector(customHandleSelector) : null;
                this.validateCustomHandle(customHandleSelector, this[customHandleVariableName]);
            }
        }

        #waitforframeid;
        #initialized = false;

        get hasValuesArray() {
            return Array.isArray(this._values) && this._values.length > 0;
        }

        /**
         * Sets up the rangeslider, draws the additional things like grid and thumbs, attaches the event listeners
         */
        setup() {

            //this.#waitforframeid = components.waitForFrames(() => {
            if (!this.isConnected) return;

            if (this.#debug)
                console.log("slider.setup", this.#uniqueid, "connected:", this.isConnected, "rendered:", this.isRendered);

            if (this.hasAttribute("precision"))
                this.precision = parseInt(this.getAttribute("precision")) || 0;

            // if an array is passed these are the values of the array
            this._values = this.hasAttribute('values') ? JSON.parse(this.getAttribute('values')) : null;

            // if an array is passed


            // the step of the slider
            this.step = parseFloat(this.getAttribute("step")) || 1;
            const _step = parseFloat(Number(this.step.toFixed(this.precision)));

            this.step = isNaN(_step) ? 1 : _step;


            // the slider orientation, can be 'vertical' or 'horizontal'
            this.orientation = this.checkOrientation(this.getAttribute('orientation'));
            // if there will be two handles
            this.twoHandles = !this.hasValuesArray && this.hasAttribute('two-handles');
            if (this.#debug) {
                console.warn("twoHandles", this.twoHandles, this.hasAttribute('two-handles'), this.hasValuesArray);
            }

            // if there is a grid
            this.grid = this.hasAttribute('grid');
            // if there are thumbs
            this.thumb = this.hasAttribute('thumb');
            this.fromCenter = this.hasAttribute('fromcenter');


            /**
             * The names of the units are different for the two slider types.
             * ['clientY', 'height', 'top', 'y'] for vertical and
             * ['clientX', 'width', 'left', 'x'] for horizontal
             */
            this.units = orientationUnitsNames$1.get(this.orientation);

            // saves the size of the rangeslider so we don't have to request it on every action
            this.sizes = this.getRangeSliderSize();

            this.rangeslider = this.querySelector(`.guic-${this.orientation}-rangeslider`);
            this.handle = !this.twoHandles ?
                [this.querySelector(`.guic-${this.orientation}-rangeslider-handle`)] :
                this.querySelectorAll(`.guic-${this.orientation}-rangeslider-handle`);

            this.bar = this.querySelector(`.guic-${this.orientation}-rangeslider-bar`);
            //if (this.#debug) console.warn(1, this.value);

            this.setMinAndMax();



            this.setHandleValues();
            //if (this.#debug) console.warn(2, this.value);

            // if the grid attribute is added, the grid is created
            if (this.grid) {
                this.hasValuesArray ? this.buildArrayGrid() : this.buildGrid();
            }

            this.setThumb();
            //if (this.#debug) console.warn(3, this.value);

            //if (this.hasAttribute("debug"))
            if (this.#parentid && this.#debug) {
                console.log("slider.setup hasValuesArray", this.#parentid, this.hasValuesArray, this.getAttribute('values'), this.#uniqueid);
            }

            // sets the initial percent of the handles

            let percent = this.twoHandles ?
                [0, 100] :
                [Rangeslider.valueToPercent(
                    this.hasValuesArray ? this._values.indexOf(this.value) : this.value - this.min,
                    this.hasValuesArray ? 0 : this.min,
                    this.hasValuesArray ? this._values.length - 1 : this.max, this.#debug)];
            if (this.#debug) console.warn(7, this.value, this._value, percent, this.max);

            // if an array is passed the percent changes
            if (this.hasValuesArray) {
                percent = this._values.findIndex(el => el == this._value) * (100 / (this._values.length - 1));
            }

            if (this.#debug) {
                console.warn(percent);
            }
            //if (this.#debug) console.warn(8, this.value);

            if (!this.#initialized) {
                this.twoHandles ?
                    percent.forEach((p, i) => {
                        this.updateSliderPosition(p, i, false);
                    }) :
                    this.updateSliderPosition(percent, 0, false);
                //if (this.#debug) console.warn(9, this.value);
            }

            this.initCustomhandles();
            this.updateCustomHandles();
            this.attachEventListener();

            if (!this.#initialized) {
                this.onInitialized();
                this.#initialized = true;
            }

            this.onAfterSetup(this);

            //}, 0);

            //if (this.#parentid)
            //  console.log("slider.setup hasValuesArray frameid", this.#parentid, this.hasValuesArray, this.getAttribute('values'), this.#waitforframeid);
        }

        onAfterSetup(sender) {

        }

        onInitialized() {

        }

        /**
         * Builds the grid
         */
        buildGrid() {
            // calculates the number of pols the grid will have based on the size of the slider
            const numberOfPols = Math.round(this.sizes[this.units.size] / SPACE_BETWEEN_GRID_POLS / 4) * 4; // here we round to a number that is divisible by 4 and to make sure, the last pol has a number
            const grid = document.createElement('div');
            grid.classList.add(`guic-${this.orientation}-rangeslider-grid`);
            for (let i = 0; i <= numberOfPols; i++) {
                // each forth poll will be larger with a value added
                if (i % (numberOfPols / 4) === 0) {
                    grid.appendChild(
                        this.createGridPol(
                            parseFloat((parseFloat(this.min) + (this.max - this.min) * (i / numberOfPols)).toFixed(2))
                        )
                    );
                    continue;
                }
                grid.appendChild(this.createGridPol());
            }

            this.rangeslider.appendChild(grid);
        }

        /**
         * Builds a different grid if an array is passed
         */
        buildArrayGrid() {
            const grid = document.createElement('div');
            grid.classList.add(`guic-${this.orientation}-rangeslider-grid`);
            // builds only pols for the values of the array
            for (let i = 0; i < this._values.length; i++) {
                const entry = this._values[i];
                grid.appendChild(this.createGridPol(entry));
            }

            this.rangeslider.appendChild(grid);
        }

        /**
         * Creates a grid pol
         * @param {number} value - value of the grid pol
         * @returns {HTMLDivElement}
         */
        createGridPol(value) {
            const polContainer = document.createElement('div');
            polContainer.classList.add(`guic-rangeslider-${this.orientation}-grid-pol-container`);

            polContainer.innerHTML = `
            <div class="guic-rangeslider-${this.orientation}-grid-pol guic-rangeslider-${this.orientation}-pol-without-text"></div>
        `;

            // checks if the passed value is a string or number and then makes a pol with value
            if (typeof value === 'number' || typeof value === 'string') {
                polContainer.innerHTML = `
                <div class="guic-rangeslider-${this.orientation}-grid-pol"></div>
                
            `;
            }

            return polContainer;
        }

        /**
         * Creates the thumb element
         * @param {number | string} value - the initial value of the thumb
         */
        buildThumb(value) {
            const thumb = document.createElement('div');
            thumb.classList.add(`guic-${this.orientation}-rangeslider-thumb`);
            thumb.textContent = value;
            this.rangeslider.appendChild(thumb);
        }

        /**
         * Gets the rangeslider dimensions
         * @returns {DOMRect}
         */
        getRangeSliderSize() {
            return this.querySelector(`.guic-${this.orientation}-rangeslider-wrapper`).getBoundingClientRect();
        }

        /**
         * Sets the min and max value of the rangeslider
         */
        setMinAndMax() {
            // if we have an array we set the min and max values to the first and last entry of the array
            if (this.hasValuesArray) {
                this.min = this._values[0];
                this.max = this._values[this._values.length - 1];
                return;
            }

            const _min = parseFloat(this.getAttribute('min'));
            const _max = parseFloat(this.getAttribute('max'));

            this.min = isNaN(_min) ? 0 : _min;
            this.max = isNaN(_max) ? 100 : _max;

            //console.error(">>>",this.min,this.max,this.step,this.getAttribute('max'));
        }

        /**
         * Sets the value of the handles
         */
        setHandleValues() {
            // if there are two handles we set their values to the min and max

            if (this.twoHandles) {
                this.value = [this.min, this.max];
                return;
            }

            if (this.hasValuesArray) {
                if (this.hasAttribute('value') && !isNaN(this.getAttribute('value'))) {
                    this.value = [this.getAttribute('value')];
                }
                return;
            }

            if (this.#debug) console.warn("setHandleValues", this.getAttribute('value'), this.min);

            this.value = [parseFloat(this.getAttribute('value'))] || [this.min];

            /*
                    console.log("setHandleValues", this.getAttribute('value'), this.value, this.min, this.max, 
                    " / ", 
                    this.min <= this.value, this.max >= this.value[0]);
            */
            // checks if the value provided is less than the min or more than the max and sets it to the minimum value



            this.value = this.min <= this.value && this.max >= this.value
                ? [this.value] :
                [this.min];

        }

        /**
         * Calculates the value of the handle based on the position of the handle
         * @param {number} percent - the percent position
         * @returns {number} - the value of the handle
         */
        calculateHandleValue(percent) {

            //(this.max - this.min) * (percent / 100)

            let val = parseFloat(this.min + (this.max - this.min) * (percent / 100));
            if (this.#debug) {
                console.warn(
                    "calculateHandleValue", percent, this.value, this.min, this.max, this.max - this.min, "/",
                    val);
                //Rangeslider.valueToPercent(val, this.min, this.max, true);

            }

            return val;
        }

        /**
         * Attaches the event listener
         */
        attachEventListener() {
            this.querySelector(`.guic-${this.orientation}-rangeslider-wrapper`).addEventListener('mousedown', this.onMouseDown);
        }

        /**
         * Will update the handles values depending of if they are two or a single one
         * @returns {void}
         */
        updateCustomHandles() {
            if (this.twoHandles) {
                if (this.customHandleLeft && this._value[0] !== undefined) {
                    this.customHandleLeft.textContent = this._value[0];
                }

                if (this.customHandleRight && this._value[1] !== undefined) {
                    this.customHandleRight.textContent = this._value[1];
                }

                return;
            }

            if (this.customHandle && this._value[0] !== undefined) this.customHandle.textContent = this._value[0];
        }

        /**
         * If we have two handles we need to clamp each so that it doesn't pass beyond the other handle
         * @param {number[]} clampRange
         * @param {number} index
         * @returns {number[]}
         */
        clampTwoHandles(clampRange, index, percentStep) {
            const handleZeroPosition = this.handle[0].style[this.units.position];
            const handleOnePosition = this.handle[1].style[this.units.position];

            if (this.#debug) {
                console.warn("clampTwoHandles", handleZeroPosition, handleOnePosition, percentStep);
            }

            if (index === 0) {
                clampRange = this.orientation === 'vertical' ?
                    [0, 100 - parseFloat(handleOnePosition)] :
                    [0, parseFloat(handleOnePosition) - percentStep];
            } else if (index === 1) {
                clampRange = this.orientation === 'vertical' ?
                    [100 - parseFloat(handleZeroPosition), 100] :
                    [parseFloat(handleZeroPosition) + percentStep, 100];
            }

            return clampRange;
        }

        /**
         * Returns the disance between the two handles
         * @returns {number}
         */
        getDistanceBetweenTwoHandles() {

            const firstHandlePositionValue = this.handle[0].style[this.units.position];
            const secondHandlePositionValue = this.handle[1]?.style[this.units.position];

            return this.twoHandles ?
                Math.abs(parseFloat(firstHandlePositionValue) - parseFloat(secondHandlePositionValue)) :
                0;
        }

        /**
         * Will set the bar styles
         * @param {number} index
         * @param {number} percent
         */
        setBarStyles(index, percent) {
            if (isNaN(percent)) return;
            // we get the distance between two handles to set the width of the bar to
            const distanceBetweenHandles = this.getDistanceBetweenTwoHandles();

            if (!this.fromCenter) {
                this.bar.style[this.units.size] = this.twoHandles ? `${distanceBetweenHandles}%` : `${percent}%`;
            } else {
                const value = 50 - percent;

                this.bar.style[this.units.size] = Math.abs(value) + "%";
                this.bar.style[this.units.position] = (value <= 0 ? "50" : percent) + "%";
                //this.bar.style[this.units.size] = this.twoHandles ? `${distanceBetweenHandles}%` : `${percent}%`;
            }

            if (this.twoHandles && index === 0) {
                this.bar.style[this.units.position] = `${this.orientation === 'vertical' ? 100 - percent : percent}%`;
            }
        }

        /**
         * Updates the positions of the handles and the width of the bar
         * @param {number} percent
         * @param {number} index - the index of the handle we want to update
         */
        updateSliderPosition(percent, index, preventEventIfSame = false) {
            if (isNaN(percent)) return;
            // The percent of the step that is set, if the values are an array, the step is between each array value
            let percentStep =

                this.hasValuesArray ?
                    100 / (this._values.length - 1) :
                    Rangeslider.valueToPercent(this.step, this.min, this.max, this.#debug);


            if (this.#debug) {
                console.warn("updateSliderPosition", this.twoHandles ? this._value[index] : this.value, percent, index, preventEventIfSame);
            }

            // the range which should be clamped
            let clampRange = [0, 100];

            if (this.twoHandles && this.handle[1].style[this.units.position]) {
                clampRange = this.clampTwoHandles(clampRange, index, percentStep);
            }

            //console.warn("clampRange", clampRange, Math.round(percent / percentStep) * percentStep);

            // the provided percent is clamped
            percent = Rangeslider.clamp(Math.round(percent / percentStep) * percentStep, ...clampRange);
            this.handle[index].style[this.units.position] = `${this.orientation === 'vertical' ? 100 - percent : percent}%`;

            this.setBarStyles(index, percent);

            const oldvalue = this.hasValuesArray ? this._value[index] : parseFloat(this._value[index].toFixed(this.precision));


            this._value[index] = this.hasValuesArray ?
                this._values[percent / percentStep] :
                parseFloat(this.calculateHandleValue(percent).toFixed(this.precision));


            if (this.#debug) {
                //console.log("pre", this.calculateHandleValue(percent).toFixed(2));
                console.warn("updateSliderPosition 2", this._value, this._values, percent, index, preventEventIfSame, percentStep);
            }


            if (this.thumb) {
                this.thumbElement[index].innerHTML = this._value[index];
                this.thumbElement[index].style[this.units.position] =
                    `${this.orientation === 'vertical' ? 100 - percent : percent}%`;
            }

            //console.warn("oldvalue", index, oldvalue, this._value[index], `min:${this.min}`);

            // dispatching a custom event with the rangeslider values only when necessary
            if (oldvalue != this._value[index] && !preventEventIfSame) {
                if (this.#debug) console.log("slider.update", this._value[index], this.hasValuesArray, oldvalue, this._value, preventEventIfSame);
                this.index = percent / percentStep;
                this.dispatchEvent(new CustomEvent('sliderupdate', { detail: { value: this._value, index: percent / percentStep } }));
            } else {
                this.index = percent / percentStep;
            }
        }

        /**
         * Calculates the position of the slider in percent based on the mouse coordinates
         * @param {MouseEvent} e
         * @returns {Number} Position in percent
         */
        getHandlePercent(e) {
            // we calculate the offsetX or offsetY of the click event
            const size = this.sizes[this.units.coordinate];
            const mouseCoords = e[this.units.mouseAxisCoords];

            let offset = document.body.scrollLeft + mouseCoords - size;
            if (this.orientation === 'vertical') {
                offset = size + this.sizes[this.units.size] - (document.body.scrollTop + mouseCoords);
            }

            return Rangeslider.valueToPercent(offset, 0, this.sizes[this.units.size]);
        }

        /**
         * Executed on mousedown. Sets the handle to the clicked coordinates and attaches event listeners to the document
         * @param {MouseEvent} e
         */
        onMouseDown(e) {
            // creates the active handle
            this.activeHandle = 0;

            const percent = this.getHandlePercent(e);

            // get the closest handle to the click if we have two handles
            if (this.twoHandles) {
                const distance = [];

                for (let i = 0; i < this.handle.length; i++) {
                    const pos = parseInt(this.handle[i].style[this.units.position]);
                    distance.push(Math.abs(pos - percent));
                }

                this.activeHandle =
                    this.orientation === 'vertical' ?
                        distance.reverse().indexOf(Math.min(...distance)) :
                        distance.indexOf(Math.min(...distance));
            }

            this.updateSliderPosition(percent, this.activeHandle);

            // attaching event listeners on mousedown so we don't have them attached all the time
            document.addEventListener('mousemove', this.onMouseMove);
            document.addEventListener('mouseup', this.onMouseUp);
        }

        /**
         * Moving the handle with the mouse
         * @param {MouseEvent} e
         */
        onMouseMove(e) {
            const percent = this.getHandlePercent(e);

            if (document.body.classList.contains("ui-locked")) return;

            this.updateSliderPosition(percent, this.activeHandle);
        }

        /**
         * Removes the event listeners that we attach in onMouseDown
         */
        onMouseUp() {
            document.removeEventListener('mousemove', this.onMouseMove);
            document.removeEventListener('mouseup', this.onMouseUp);
        }
    }

    components$1.defineCustomElement('gameface-rangeslider', Rangeslider);

    /*
     * A javascript-based implementation of Spatial Navigation.
     *
     * Copyright (c) 2022 Luke Chang.
     * https://github.com/luke-chang/js-spatial-navigation
     *
     * Licensed under the MPL 2.0.
     */
     (function ($) {

      /************************/
      /* Global Configuration */
      /************************/
      // Note: an <extSelector> can be one of following types:
      // - a valid selector string for "querySelectorAll" or jQuery (if it exists)
      // - a NodeList or an array containing DOM elements
      // - a single DOM element
      // - a jQuery object
      // - a string "@<sectionId>" to indicate the specified section
      // - a string "@" to indicate the default section
      var GlobalConfig = {
        selector: '',           // can be a valid <extSelector> except "@" syntax.
        straightOnly: false,
        straightOverlapThreshold: 0.5,
        rememberSource: false,
        disabled: false,
        defaultElement: '',     // <extSelector> except "@" syntax.
        enterTo: '',            // '', 'last-focused', 'default-element'
        leaveFor: null,         // {left: <extSelector>, right: <extSelector>,
        //  up: <extSelector>, down: <extSelector>}
        restrict: 'self-first', // 'self-first', 'self-only', 'none'
        tabIndexIgnoreList:
          'a, input, select, textarea, button, iframe, [contentEditable=true]',
        navigableFilter: null
      };

      var REVERSE = {
        'left': 'right',
        'up': 'down',
        'right': 'left',
        'down': 'up'
      };

      var EVENT_PREFIX = 'sn:';
      var ID_POOL_PREFIX = 'section-';

      /********************/
      /* Private Variable */
      /********************/
      var _idPool = 0;
      var _ready = false;
      var _pause = false;
      var _sections = {};
      var _sectionCount = 0;
      var _defaultSectionId = '';
      var _lastSectionId = '';
      var _duringFocusChange = false;

      /************/
      /* Polyfill */
      /************/
      var elementMatchesSelector =
        Element.prototype.matches ||
        Element.prototype.matchesSelector ||
        Element.prototype.mozMatchesSelector ||
        Element.prototype.webkitMatchesSelector ||
        Element.prototype.msMatchesSelector ||
        Element.prototype.oMatchesSelector ||
        function (selector) {
          var matchedNodes =
            (this.parentNode || this.document).querySelectorAll(selector);
          return [].slice.call(matchedNodes).indexOf(this) >= 0;
        };

      /*****************/
      /* Core Function */
      /*****************/
      function getRect(elem) {
        var cr = elem.getBoundingClientRect();
        const style = getComputedStyle(elem);
        var margins = {
          top: ksUI.getPxFromRem(style.marginTop),
          left: ksUI.getPxFromRem(style.marginLeft),
          bottom: ksUI.getPxFromRem(style.marginBottom),
          right: ksUI.getPxFromRem(style.marginRight),
        };

        var rect = {
          left: cr.left + margins.left,
          top: cr.top + margins.top,
          right: cr.right + margins.right,
          bottom: cr.bottom + margins.bottom,
          width: cr.width + margins.left + margins.right,
          height: cr.height + margins.top + margins.bottom
        };
        rect.element = elem;
        rect.center = {
          x: rect.left + Math.floor(rect.width / 2),
          y: rect.top + Math.floor(rect.height / 2)
        };
        rect.center.left = rect.center.right = rect.center.x;
        rect.center.top = rect.center.bottom = rect.center.y;
        return rect;
      }

      function partition(rects, targetRect, straightOverlapThreshold) {
        var groups = [[], [], [], [], [], [], [], [], []];

        for (var i = 0; i < rects.length; i++) {
          var rect = rects[i];
          var center = rect.center;
          var x, y, groupId;

          if (center.x < targetRect.left) {
            x = 0;
          } else if (center.x <= targetRect.right) {
            x = 1;
          } else {
            x = 2;
          }

          if (center.y < targetRect.top) {
            y = 0;
          } else if (center.y <= targetRect.bottom) {
            y = 1;
          } else {
            y = 2;
          }

          groupId = y * 3 + x;
          groups[groupId].push(rect);

          if ([0, 2, 6, 8].indexOf(groupId) !== -1) {
            var threshold = straightOverlapThreshold;

            if (rect.left <= targetRect.right - targetRect.width * threshold) {
              if (groupId === 2) {
                groups[1].push(rect);
              } else if (groupId === 8) {
                groups[7].push(rect);
              }
            }

            if (rect.right >= targetRect.left + targetRect.width * threshold) {
              if (groupId === 0) {
                groups[1].push(rect);
              } else if (groupId === 6) {
                groups[7].push(rect);
              }
            }

            if (rect.top <= targetRect.bottom - targetRect.height * threshold) {
              if (groupId === 6) {
                groups[3].push(rect);
              } else if (groupId === 8) {
                groups[5].push(rect);
              }
            }

            if (rect.bottom >= targetRect.top + targetRect.height * threshold) {
              if (groupId === 0) {
                groups[3].push(rect);
              } else if (groupId === 2) {
                groups[5].push(rect);
              }
            }
          }
        }

        return groups;
      }

      function generateDistanceFunction(targetRect) {
        return {
          nearPlumbLineIsBetter: function (rect) {
            var d;
            if (rect.center.x < targetRect.center.x) {
              d = targetRect.center.x - rect.right;
            } else {
              d = rect.left - targetRect.center.x;
            }
            return d < 0 ? 0 : d;
          },
          nearHorizonIsBetter: function (rect) {
            var d;
            if (rect.center.y < targetRect.center.y) {
              d = targetRect.center.y - rect.bottom;
            } else {
              d = rect.top - targetRect.center.y;
            }
            return d < 0 ? 0 : d;
          },
          nearTargetLeftIsBetter: function (rect) {
            var d;
            if (rect.center.x < targetRect.center.x) {
              d = targetRect.left - rect.right;
            } else {
              d = rect.left - targetRect.left;
            }
            return d < 0 ? 0 : d;
          },
          nearTargetTopIsBetter: function (rect) {
            var d;
            if (rect.center.y < targetRect.center.y) {
              d = targetRect.top - rect.bottom;
            } else {
              d = rect.top - targetRect.top;
            }
            return d < 0 ? 0 : d;
          },
          topIsBetter: function (rect) {
            return rect.top;
          },
          bottomIsBetter: function (rect) {
            return -1 * rect.bottom;
          },
          leftIsBetter: function (rect) {
            return rect.left;
          },
          rightIsBetter: function (rect) {
            return -1 * rect.right;
          }
        };
      }

      function prioritize(priorities) {
        var destPriority = null;
        for (var i = 0; i < priorities.length; i++) {
          if (priorities[i].group.length) {
            destPriority = priorities[i];
            break;
          }
        }

        if (!destPriority) {
          return null;
        }

        var destDistance = destPriority.distance;

        destPriority.group.sort(function (a, b) {
          for (var i = 0; i < destDistance.length; i++) {
            var distance = destDistance[i];
            var delta = distance(a) - distance(b);
            if (delta) {
              return delta;
            }
          }
          return 0;
        });

        return destPriority.group;
      }

      function navigate(target, direction, candidates, config) {
        if (!target || !direction || !candidates || !candidates.length) {
          return null;
        }

        var rects = [];
        for (var i = 0; i < candidates.length; i++) {
          var rect = getRect(candidates[i]);
          if (rect) {
            rects.push(rect);
          }
        }
        if (!rects.length) {
          return null;
        }

        var targetRect = getRect(target);
        if (!targetRect) {
          return null;
        }

        var distanceFunction = generateDistanceFunction(targetRect);

        var groups = partition(
          rects,
          targetRect,
          config.straightOverlapThreshold
        );

        var internalGroups = partition(
          groups[4],
          targetRect.center,
          config.straightOverlapThreshold
        );

        var priorities;

        switch (direction) {
          case 'left':
            priorities = [
              {
                group: internalGroups[0].concat(internalGroups[3])
                  .concat(internalGroups[6]),
                distance: [
                  distanceFunction.nearPlumbLineIsBetter,
                  distanceFunction.topIsBetter
                ]
              },
              {
                group: groups[3],
                distance: [
                  distanceFunction.nearPlumbLineIsBetter,
                  distanceFunction.topIsBetter
                ]
              },
              {
                group: groups[0].concat(groups[6]),
                distance: [
                  distanceFunction.nearHorizonIsBetter,
                  distanceFunction.rightIsBetter,
                  distanceFunction.nearTargetTopIsBetter
                ]
              }
            ];
            break;
          case 'right':
            priorities = [
              {
                group: internalGroups[2].concat(internalGroups[5])
                  .concat(internalGroups[8]),
                distance: [
                  distanceFunction.nearPlumbLineIsBetter,
                  distanceFunction.topIsBetter
                ]
              },
              {
                group: groups[5],
                distance: [
                  distanceFunction.nearPlumbLineIsBetter,
                  distanceFunction.topIsBetter
                ]
              },
              {
                group: groups[2].concat(groups[8]),
                distance: [
                  distanceFunction.nearHorizonIsBetter,
                  distanceFunction.leftIsBetter,
                  distanceFunction.nearTargetTopIsBetter
                ]
              }
            ];
            break;
          case 'up':
            priorities = [
              {
                group: internalGroups[0].concat(internalGroups[1])
                  .concat(internalGroups[2]),
                distance: [
                  distanceFunction.nearHorizonIsBetter,
                  distanceFunction.leftIsBetter
                ]
              },
              {
                group: groups[1],
                distance: [
                  distanceFunction.nearHorizonIsBetter,
                  distanceFunction.leftIsBetter
                ]
              },
              {
                group: groups[0].concat(groups[2]),
                distance: [
                  distanceFunction.nearPlumbLineIsBetter,
                  distanceFunction.bottomIsBetter,
                  distanceFunction.nearTargetLeftIsBetter
                ]
              }
            ];
            break;
          case 'down':
            priorities = [
              {
                group: internalGroups[6].concat(internalGroups[7])
                  .concat(internalGroups[8]),
                distance: [
                  distanceFunction.nearHorizonIsBetter,
                  distanceFunction.leftIsBetter
                ]
              },
              {
                group: groups[7],
                distance: [
                  distanceFunction.nearHorizonIsBetter,
                  distanceFunction.leftIsBetter
                ]
              },
              {
                group: groups[6].concat(groups[8]),
                distance: [
                  distanceFunction.nearPlumbLineIsBetter,
                  distanceFunction.topIsBetter,
                  distanceFunction.nearTargetLeftIsBetter
                ]
              }
            ];
            break;
          default:
            return null;
        }

        if (config.straightOnly) {
          priorities.pop();
        }

        var destGroup = prioritize(priorities);
        if (!destGroup) {
          return null;
        }

        //console.trace("SPATIAL NAV", destGroup);

        var dest = null;
        if (config.rememberSource &&
          config.previous &&
          config.previous.destination === target &&
          config.previous.reverse === direction) {
          for (var j = 0; j < destGroup.length; j++) {
            if (destGroup[j].element === config.previous.target) {
              dest = destGroup[j].element;
              break;
            }
          }
        }

        if (!dest) {
          dest = destGroup[0].element;
        }

        return dest;
      }

      /********************/
      /* Private Function */
      /********************/
      function generateId() {
        var id;
        while (true) {
          id = ID_POOL_PREFIX + String(++_idPool);
          if (!_sections[id]) {
            break;
          }
        }
        return id;
      }

      function parseSelector(selector) {
        var result = [];
        try {
          if (selector) {
            if ($) {
              result = $(selector).get();
            } else if (typeof selector === 'string') {
              result = [].slice.call(document.querySelectorAll(selector));
            } else if (typeof selector === 'object' && selector.length) {
              result = [].slice.call(selector);
            } else if (typeof selector === 'object' && selector.nodeType === 1) {
              result = [selector];
            }
          }
        } catch (err) {
          console.error(err);
        }
        return result;
      }

      function matchSelector(elem, selector) {
        if ($) {
          return $(elem).is(selector);
        } else if (typeof selector === 'string') {
          return elementMatchesSelector.call(elem, selector);
        } else if (typeof selector === 'object' && selector.length) {
          return selector.indexOf(elem) >= 0;
        } else if (typeof selector === 'object' && selector.nodeType === 1) {
          return elem === selector;
        }
        return false;
      }

      function getCurrentFocusedElement() {
        var activeElement = document.activeElement;
        if (activeElement && activeElement !== document.body) {
          return activeElement;
        }
      }

      function extend(out) {
        out = out || {};
        for (var i = 1; i < arguments.length; i++) {
          if (!arguments[i]) {
            continue;
          }
          for (var key in arguments[i]) {
            if (arguments[i].hasOwnProperty(key) &&
              arguments[i][key] !== undefined) {
              out[key] = arguments[i][key];
            }
          }
        }
        return out;
      }

      function exclude(elemList, excludedElem) {
        if (!Array.isArray(excludedElem)) {
          excludedElem = [excludedElem];
        }
        for (var i = 0, index; i < excludedElem.length; i++) {
          index = elemList.indexOf(excludedElem[i]);
          if (index >= 0) {
            elemList.splice(index, 1);
          }
        }
        return elemList;
      }

      function checkParents(elem) {
        while (elem && elem.parentNode) {
          let elemStyle = getComputedStyle(elem);
          if ((elemStyle.visibility != "visible" || elemStyle.display == "none" || elemStyle.opacity == 0 || elemStyle.content == "'disabled'") && elemStyle.content != "'focus-children'") {
            //console.log("parent hidded", elemStyle.content, elem);
            return false;
          }
          elem = elem.parentNode;
        }
        return true;
      }

      function isNavigable(elem, sectionId, verifySectionSelector) {
        if (!elem || !sectionId ||
          !_sections[sectionId] || _sections[sectionId].disabled) {
          return false;
        }

        let elemStyle = window.getComputedStyle(elem);

        if ((elem.offsetWidth <= 0 && elem.offsetHeight <= 0 )|| elem.classList.contains("disabled") ||
          elem.hasAttribute('disabled') || elem.hasAttribute('readonly') || elem.closest(".disabled") || elem.closest("[disabled]") || elem.closest("[readonly]")
          || elemStyle.display == "none" || elemStyle.content == "'disabled'" || !checkParents(elem.parentNode)
        ) {
          //console.log("element hidded", elemStyle.content, elem, elem.offsetHeight, elemStyle.display);
          return false;
        }
        //console.log("getting style for", elem.tagName, elem.className, elemStyle.pointerEvents);
        if (verifySectionSelector &&
          !matchSelector(elem, _sections[sectionId].selector)) {
          return false;
        }
        if (typeof _sections[sectionId].navigableFilter === 'function') {
          if (_sections[sectionId].navigableFilter(elem, sectionId) === false) {
            return false;
          }
        } else if (typeof GlobalConfig.navigableFilter === 'function') {
          if (GlobalConfig.navigableFilter(elem, sectionId) === false) {
            return false;
          }
        }
        return true;
      }

      function getSectionId(elem) {
        for (var id in _sections) {
          if (!_sections[id].disabled &&
            matchSelector(elem, _sections[id].selector)) {
            return id;
          }
        }
      }

      function getSectionNavigableElements(sectionId) {
        //console.warn("SPATIAL NAV getSectionNavigableElements", sectionId);
        return parseSelector(_sections[sectionId].selector).filter(function (elem) {
          return isNavigable(elem, sectionId);
        });
      }

      function getSectionDefaultElement(sectionId) {
        //console.warn("SPATIAL NAV getSectionDefaultElement", sectionId);
        var defaultElement = parseSelector(_sections[sectionId].defaultElement).find(function (elem) {
          return isNavigable(elem, sectionId, true);
        });
        if (!defaultElement) {
          return null;
        }
        return defaultElement;
      }

      function getSectionLastFocusedElement(sectionId) {
        var lastFocusedElement = _sections[sectionId].lastFocusedElement;
        if (!isNavigable(lastFocusedElement, sectionId, true)) {
          return null;
        }
        //console.warn("SPATIAL NAV found last focused");
        return lastFocusedElement;
      }

      function fireEvent(elem, type, details, cancelable) {
        if (arguments.length < 4) {
          cancelable = true;
        }
        var evt = document.createEvent('CustomEvent');
        evt.initCustomEvent(EVENT_PREFIX + type, true, cancelable, details);
        return elem.dispatchEvent(evt);
      }

      function focusElement(elem, sectionId, direction) {
        if (!elem) {
          return false;
        }

        var currentFocusedElement = getCurrentFocusedElement();

        var silentFocus = function () {
          if (currentFocusedElement) {
            currentFocusedElement.blur();
          }
          elem.focus();
          focusChanged(elem, sectionId);
        };

        if (_duringFocusChange) {
          silentFocus();
          return true;
        }

        _duringFocusChange = true;

        if (_pause) {
          silentFocus();
          _duringFocusChange = false;
          return true;
        }

        if (currentFocusedElement) {
          var unfocusProperties = {
            nextElement: elem,
            nextSectionId: sectionId,
            direction: direction,
            native: false
          };
          if (!fireEvent(currentFocusedElement, 'willunfocus', unfocusProperties)) {
            _duringFocusChange = false;
            return false;
          }
          currentFocusedElement.blur();
          fireEvent(currentFocusedElement, 'unfocused', unfocusProperties, false);
        }

        var focusProperties = {
          previousElement: currentFocusedElement,
          sectionId: sectionId,
          direction: direction,
          native: false
        };
        if (!fireEvent(elem, 'willfocus', focusProperties)) {
          _duringFocusChange = false;
          return false;
        }
        elem.focus();
        fireEvent(elem, 'focused', focusProperties, false);
        
        _duringFocusChange = false;

        focusChanged(elem, sectionId);
        return true;
      }

      function focusChanged(elem, sectionId) {
        if (!sectionId) {
          sectionId = getSectionId(elem);
        }
        if (sectionId) {
          _sections[sectionId].lastFocusedElement = elem;
          _lastSectionId = sectionId;
        }
        
        let focus_indicator = elem.closest(".focus-indicator");
        if (focus_indicator) {
          focus_indicator.classList.toggle("is-focused", true);
          ksUI.indicateFocus(focus_indicator, true);
        } else {
          ksUI.indicateFocus(elem, true);
        }

        //console.trace("SPATIAL NAV", elem, sectionId);
      }

      function focusExtendedSelector(selector, direction) {
        if (selector.charAt(0) == '@') {
          if (selector.length == 1) {
            return focusSection();
          } else {
            var sectionId = selector.substr(1);
            return focusSection(sectionId);
          }
        } else {
          var next = parseSelector(selector)[0];
          if (next) {
            var nextSectionId = getSectionId(next);
            if (isNavigable(next, nextSectionId)) {
              return focusElement(next, nextSectionId, direction);
            }
          }
        }
        return false;
      }

      function focusSection(sectionId) {
        var range = [];
        var addRange = function (id) {
          if (id && range.indexOf(id) < 0 &&
            _sections[id] && !_sections[id].disabled) {
            range.push(id);
          }
        };

        if (sectionId) {
          addRange(sectionId);
        } else {
          addRange(_defaultSectionId);
          addRange(_lastSectionId);
          Object.keys(_sections).map(addRange);
        }

        for (var i = 0; i < range.length; i++) {
          var id = range[i];
          var next;

          if (_sections[id].enterTo == 'last-focused') {
            next = getSectionLastFocusedElement(id) ||
              getSectionDefaultElement(id) ||
              getSectionNavigableElements(id)[0];
          } else {
            next = getSectionDefaultElement(id) ||
              getSectionLastFocusedElement(id) ||
              getSectionNavigableElements(id)[0];
          }

          if (next) {
            return focusElement(next, id);
          }
        }

        return false;
      }

      function fireNavigatefailed(elem, direction) {
        fireEvent(elem, 'navigatefailed', {
          direction: direction
        }, false);
      }

      function gotoLeaveFor(sectionId, direction) {
        if (_sections[sectionId].leaveFor &&
          _sections[sectionId].leaveFor[direction] !== undefined) {
          var next = _sections[sectionId].leaveFor[direction];

          if (typeof next === 'string') {
            if (next === '') {
              return null;
            }
            return focusExtendedSelector(next, direction);
          }

          if ($ && next instanceof $) {
            next = next.get(0);
          }

          var nextSectionId = getSectionId(next);
          if (isNavigable(next, nextSectionId)) {
            return focusElement(next, nextSectionId, direction);
          }
        }
        return false;
      }

      function focusNext(direction, currentFocusedElement, currentSectionId, ignore_extSelector = false) {
        var extSelector =
          currentFocusedElement.getAttribute('data-sn-' + direction);
        if (typeof extSelector === 'string' && !ignore_extSelector) {
          if(extSelector === "NONE") {
            return false;
          }
          if (extSelector === '' ||
            !focusExtendedSelector(extSelector, direction)) {
            fireNavigatefailed(currentFocusedElement, direction);
            focusNext(direction, currentFocusedElement, currentSectionId, true);
            return false;
          }
          return true;
        }

        var sectionNavigableElements = {};
        var allNavigableElements = [];
        for (var id in _sections) {
          sectionNavigableElements[id] = getSectionNavigableElements(id);
          allNavigableElements =
            allNavigableElements.concat(sectionNavigableElements[id]);
        }

        var config = extend({}, GlobalConfig, _sections[currentSectionId]);
        var next;

        if (config.restrict == 'self-only' || config.restrict == 'self-first') {
          var currentSectionNavigableElements =
            sectionNavigableElements[currentSectionId];

          next = navigate(
            currentFocusedElement,
            direction,
            exclude(currentSectionNavigableElements, currentFocusedElement),
            config
          );

          if (!next && config.restrict == 'self-first') {
            next = navigate(
              currentFocusedElement,
              direction,
              exclude(allNavigableElements, currentSectionNavigableElements),
              config
            );
          }
        } else {
          next = navigate(
            currentFocusedElement,
            direction,
            exclude(allNavigableElements, currentFocusedElement),
            config
          );
        }

        if (next) {
          _sections[currentSectionId].previous = {
            target: currentFocusedElement,
            destination: next,
            reverse: REVERSE[direction]
          };

          var nextSectionId = getSectionId(next);

          if (currentSectionId != nextSectionId) {
            var result = gotoLeaveFor(currentSectionId, direction);
            if (result) {
              return true;
            } else if (result === null) {
              fireNavigatefailed(currentFocusedElement, direction);
              return false;
            }

            var enterToElement;
            switch (_sections[nextSectionId].enterTo) {
              case 'last-focused':
                enterToElement = getSectionLastFocusedElement(nextSectionId) ||
                  getSectionDefaultElement(nextSectionId);
                break;
              case 'default-element':
                enterToElement = getSectionDefaultElement(nextSectionId);
                break;
            }
            if (enterToElement) {
              next = enterToElement;
            }
          }

          return focusElement(next, nextSectionId, direction);
        } else if (gotoLeaveFor(currentSectionId, direction)) {
          return true;
        }

        fireNavigatefailed(currentFocusedElement, direction);
        return false;
      }

      function onFocus(evt) {
        var target = evt.target;

        if (target !== window && target !== document &&
          _sectionCount && !_duringFocusChange) {
          var sectionId = getSectionId(target);
          if (sectionId) {
            if (_pause) {
              focusChanged(target, sectionId);
              return;
            }

            var focusProperties = {
              sectionId: sectionId,
              native: true
            };

            if (!fireEvent(target, 'willfocus', focusProperties)) {
              _duringFocusChange = true;
              target.blur();
              _duringFocusChange = false;
            } else {
              fireEvent(target, 'focused', focusProperties, false);
              focusChanged(target, sectionId);
            }
          }
        }
      }

      function onBlur(evt) {
        var target = evt.target;

        let focus_indicator = target.closest(".focus-indicator");
        if (focus_indicator) {
          focus_indicator.classList.toggle("is-focused", false);
        }

        if (target !== window && target !== document && !_pause &&
          _sectionCount && !_duringFocusChange && getSectionId(target)) {
          var unfocusProperties = {
            native: true
          };
          if (!fireEvent(target, 'willunfocus', unfocusProperties)) {
            _duringFocusChange = true;
            setTimeout(function () {
              target.focus();
              _duringFocusChange = false;
            });
          } else {
            fireEvent(target, 'unfocused', unfocusProperties, false);
          }
        }
      }

      /*******************/
      /* Public Function */
      /*******************/
      var SpatialNavigation = {
        init: function () {
          if (!_ready) {
            //window.addEventListener('keydown', onKeyDown);
            //window.addEventListener('keyup', onKeyUp);
            window.addEventListener('focus', onFocus, true);
            window.addEventListener('blur', onBlur, true);
            _ready = true;
          }
        },

        uninit: function () {
          window.removeEventListener('blur', onBlur, true);
          window.removeEventListener('focus', onFocus, true);
          //window.removeEventListener('keyup', onKeyUp);
          //window.removeEventListener('keydown', onKeyDown);
          SpatialNavigation.clear();
          _idPool = 0;
          _ready = false;
        },

        clear: function () {
          _sections = {};
          _sectionCount = 0;
          _defaultSectionId = '';
          _lastSectionId = '';
          _duringFocusChange = false;
        },

        // set(<config>);
        // set(<sectionId>, <config>);
        set: function () {
          var sectionId, config;

          if (typeof arguments[0] === 'object') {
            config = arguments[0];
          } else if (typeof arguments[0] === 'string' &&
            typeof arguments[1] === 'object') {
            sectionId = arguments[0];
            config = arguments[1];
            if (!_sections[sectionId]) {
              throw new Error('Section "' + sectionId + '" doesn\'t exist!');
            }
          } else {
            return;
          }

          for (var key in config) {
            if (GlobalConfig[key] !== undefined) {
              if (sectionId) {
                _sections[sectionId][key] = config[key];
              } else if (config[key] !== undefined) {
                GlobalConfig[key] = config[key];
              }
            }
          }

          if (sectionId) {
            // remove "undefined" items
            _sections[sectionId] = extend({}, _sections[sectionId]);
          }
        },

        // add(<config>);
        // add(<sectionId>, <config>);
        add: function () {
          var sectionId;
          var config = {};

          if (typeof arguments[0] === 'object') {
            config = arguments[0];
          } else if (typeof arguments[0] === 'string' &&
            typeof arguments[1] === 'object') {
            sectionId = arguments[0];
            config = arguments[1];
          }

          if (!sectionId) {
            sectionId = (typeof config.id === 'string') ? config.id : generateId();
          }

          if (_sections[sectionId]) {
            throw new Error('Section "' + sectionId + '" has already existed!');
          }

          _sections[sectionId] = {};
          _sectionCount++;

          SpatialNavigation.set(sectionId, config);

          return sectionId;
        },

        getSections: function () {
          return _sections;
        },

        remove: function (sectionId) {
          if (!sectionId || typeof sectionId !== 'string') {
            throw new Error('Please assign the "sectionId"!');
          }
          if (_sections[sectionId]) {
            _sections[sectionId] = undefined;
            _sections = extend({}, _sections);
            _sectionCount--;
            if (_lastSectionId === sectionId) {
              _lastSectionId = '';
            }
            return true;
          }
          return false;
        },

        disable: function (sectionId) {
          if (_sections[sectionId]) {
            _sections[sectionId].disabled = true;
            return true;
          }
          return false;
        },

        enable: function (sectionId) {
          if (_sections[sectionId]) {
            _sections[sectionId].disabled = false;
            return true;
          }
          return false;
        },

        pause: function () {
          _pause = true;
        },

        resume: function () {
          _pause = false;
        },

        // focus([silent])
        // focus(<sectionId>, [silent])
        // focus(<extSelector>, [silent])
        // Note: "silent" is optional and default to false
        focus: function (elem, silent) {
          var result = false;

          //console.log("focus", elem.tagName);

          if (silent === undefined && typeof elem === 'boolean') {
            silent = elem;
            elem = undefined;
          }

          var autoPause = !_pause && silent;

          if (autoPause) {
            SpatialNavigation.pause();
          }

          if (!elem) {
            result = focusSection();
          } else {
            if (typeof elem === 'string') {
              if (_sections[elem]) {
                result = focusSection(elem);
              } else {
                result = focusExtendedSelector(elem);
              }
            } else {
              if ($ && elem instanceof $) {
                elem = elem.get(0);
              }

              var nextSectionId = getSectionId(elem);
              if (isNavigable(elem, nextSectionId)) {
                result = focusElement(elem, nextSectionId);
              }
            }
          }

          if (autoPause) {
            SpatialNavigation.resume();
          }

          return result;
        },

        // move(<direction>)
        // move(<direction>, <selector>)
        move: function (direction, selector) {
          direction = direction.toLowerCase();
          if (!REVERSE[direction]) {
            return false;
          }

          var elem = selector ?
            parseSelector(selector)[0] : getCurrentFocusedElement();
          if (!elem) {
            return false;
          }

          var sectionId = getSectionId(elem);
          if (!sectionId) {
            return false;
          }

          var willmoveProperties = {
            direction: direction,
            sectionId: sectionId,
            cause: 'api'
          };

          if (!fireEvent(elem, 'willmove', willmoveProperties)) {
            return false;
          }

          return focusNext(direction, elem, sectionId);
        },

        // makeFocusable()
        // makeFocusable(<sectionId>)
        makeFocusable: function (sectionId) {
          var doMakeFocusable = function (section) {
            var tabIndexIgnoreList = section.tabIndexIgnoreList !== undefined ?
              section.tabIndexIgnoreList : GlobalConfig.tabIndexIgnoreList;
            parseSelector(section.selector).forEach(function (elem) {
              if (!matchSelector(elem, tabIndexIgnoreList)) {
                if (!elem.getAttribute('tabindex')) {
                  elem.setAttribute('tabindex', '-1');
                }
              }
            });
          };

          if (sectionId) {
            if (_sections[sectionId]) {
              doMakeFocusable(_sections[sectionId]);
            } else {
              throw new Error('Section "' + sectionId + '" doesn\'t exist!');
            }
          } else {
            for (var id in _sections) {
              doMakeFocusable(_sections[id]);
            }
          }
        },

        setDefaultSection: function (sectionId) {
          if (!sectionId) {
            _defaultSectionId = '';
          } else if (!_sections[sectionId]) {
            throw new Error('Section "' + sectionId + '" doesn\'t exist!');
          } else {
            _defaultSectionId = sectionId;
          }
        },

        enter: function () {
          let elem = getCurrentFocusedElement();
          if (elem && (elem.classList.contains("disabled") || elem.hasAttribute("disabled") || elem.hasAttribute("readonly") || elem.closest(".disabled") || elem.closest("[disabled]") || elem.closest("[readonly]"))) {
            return false;
          }
          if (elem && !fireEvent(elem, 'enter-down')) {
            //if (preventDefault)
            return false;
          }
          return true;
        }
      };

      window.SpatialNavigation = SpatialNavigation;

      /**********************/
      /* CommonJS Interface */
      /**********************/
      if (typeof module === 'object') {
        module.exports = SpatialNavigation;
      }

     
    })();

    var SpatialNavigation$1 = SpatialNavigation;

    const eCommandResponse = {
        OK: "OK",
        Restart: "RESTART",
        Failed: "FAILED"
    };

    const eRacingSetting = {
        Off: "RacingSetting_OFF",
        On: "RacingSetting_ON",
        Free: "RacingSetting_FREE"
    };

    const eBackendResponse = {
        OK: "RESPONSEOK",
        NoUser: "NOUSER",
        BackendDisconnected: "BACKENDDISCONNECTED",
        ServerNotRegistered: "SERVER_NOT_REGISTERED"
    };

    const eJoinErrorMessage = {
        OK: "JoinErrorMessage_OK",
        WrongCar: "JoinErrorMessage_WRONG_CAR",
        ServerFull: "JoinErrorMessage_SERVER_FULL",
        WrongPassword: "JoinErrorMessage_WRONG_PASSWORD",
        ServerClosed: "JoinErrorMessage_SERVER_CLOSED",
        RequirementsNotMet: "JoinErrorMessage_REQUIREMENTS_NOT_MET",
        WrongCarCategory: "JoinErrorMessage_WRONG_CAR_CATEGORY",
        WrongCarPerformanceIndicator: "JoinErrorMessage_WRONG_CAR_PERFORMANCE_INDICATOR",
        ClientOutdated: "JoinErrorMessage_CLIENT_OUTDATED",
        ServerOutdated: "JoinErrorMessage_SERVER_OUTDATED",
        ClientRejected: "JoinErrorMessage_CLIENT_REJECTED"
    };

    const eGameModeType = {
        None: "GameModeType_NONE",
        Practice: "GameModeType_PRACTICE",
        RaceWeekend: "GameModeType_RACE_WEEKEND",
        SRORace: "GameModeType_SRO_RACE",
        InstantRace: "GameModeType_INSTANT_RACE",
        Superpole: "GameModeType_SUPERPOLE",
        Cruise: "GameModeType_CRUISE",
        Drift: "GameModeType_DRIFT",
        AtoB: "GameModeType_A_TO_B",
        Hotstint: "GameModeType_HOTSTINT",
        Rally: "GameModeType_RALLY",
        Hotlap: "GameModeType_HOTLAP",
        TestDrive: "GameModeType_TEST_DRIVE",

        // UI only for MP
        Trackday: "GameModeType_TRACKDAY"
    };

    const eGameModeTypeArray = [
        eGameModeType.None,
        eGameModeType.RaceWeekend,
        eGameModeType.SRORace,
        eGameModeType.InstantRace,
        eGameModeType.Superpole,
        eGameModeType.Cruise,
        eGameModeType.Drift,
        eGameModeType.Rally,
        eGameModeType.Hotstint,
        eGameModeType.Hotlap,
        eGameModeType.Practice,
        eGameModeType.TestDrive,
        eGameModeType.AtoB
    ];

    const eGameModeSelectionWeatherType = {
        Clear: "GameModeSelectionWeatherType_CLEAR",
        ScatteredClouds: "GameModeSelectionWeatherType_SCATTERED_CLOUDS",
        BrokenClouds: "GameModeSelectionWeatherType_BROKEN_CLOUDS",
        Overcast: "GameModeSelectionWeatherType_OVERCAST",
        Drizzle: "GameModeSelectionWeatherType_DRIZZLE",
        Rain: "GameModeSelectionWeatherType_RAIN",
        HeavyRain: "GameModeSelectionWeatherType_HEAVY_RAIN",
        Custom: "GameModeSelectionWeatherType_CUSTOM"
    };

    const eGameModeSelectionWeatherBehaviour = {
        Static: "GameModeSelectionWeatherBehaviour_STATIC",
        Dynamic: "GameModeSelectionWeatherBehaviour_DYNAMIC"
    };

    const eClientCommands = {
        Mode: {
            Single: "ClientCommandsMode_SINGLEPLAYER",
            Multi: "ClientCommandsMode_MULTIPLAYER",
            DrivingAcademy: "ClientCommandsMode_DRIVING_ACADEMY"
        },

        Response: {
            OK: "ClientCommandsResponse_OK",
            NoTracks: "ClientCommandsResponse_NO_TRACKS",
            NoAvailableCars: "ClientCommandsResponse_NO_AVAILABLE_CARS",
            NoSeasonDefinition: "ClientCommandsResponse_NO_SEASONDEFINITION",
            NoSettings: "ClientCommandsResponse_NO_SETTINGS",
            EventWrong: "ClientCommandsResponse_EVENT_WRONG",
            SessionWrong: "ClientCommandsResponse_SESSION_WRONG",
            BackendDisconnected: "ClientCommandsResponse_BACKENDDISCONNECTED",
            NoUser: "ClientCommandsResponse_NOUSER",
            MessageInProgress: "ClientCommandsResponse_MESSAGE_IN_PROGRESS",
            ParameterError: "ClientCommandsResponse_PARAMETER_ERROR",
            CriticalError: "ClientCommandsResponse_CRITICAL_ERROR",
            NoCarConfig: "ClientCommandsResponse_NO_CAR_CONFIG"
        },

        GameModeType: eGameModeType
    };

    const eCarSelection = {

        State: {
            All: "CarSelectionOwnerShipState_ALL",
            Owned: "CarSelectionOwnerShipState_OWNED",
            Rental: "CarSelectionOwnerShipState_RENTAL",
            FirstPurchace: "CarSelectionOwnerShipState_FIRST_PURCHASE",
            Dealership: "CarSelectionOwnerShipState_DEALERSHIP",
            Used: "CarSelectionOwnerShipState_USED",
            Locked: "CarSelectionOwnerShipState_LOCKED"
        },

        Response: {
            OK: "CarSelectionClientCommandsResponse_OK",
            CRITICAL_ERROR: "CarSelectionClientCommandsResponse_CRITICAL_ERROR",
            NO_CAR_DESIGN: "CarSelectionClientCommandsResponse_NO_CAR_DESIGN",
            NO_CAR_CONFIG: "CarSelectionClientCommandsResponse_NO_CAR_CONFIG",
            NO_SETTINGS: "CarSelectionClientCommandsResponse_NO_SETTINGS",
            BACKENDDISCONNECTED: "CarSelectionClientCommandsResponse_BACKENDDISCONNECTED",
            NOUSER: "CarSelectionClientCommandsResponse_NOUSER",
            PARAMETER_ERROR: "CarSelectionClientCommandsResponse_PARAMETER_ERROR"
        }

    };

    const eGameModeCameraMode = {
        Drivable: "GameModeCameraModeDrivable",
        Track: "GameModeCameraModeTrack",
        Helicopter: "GameModeCameraModeHelicopter",
        Orbit: "GameModeCameraModeOrbit",
        Free: "GameModeCameraModeFree",
        OnBoard: "GameModeCameraModeOnBoard",
    };

    const eCameraModes = [
        eGameModeCameraMode.Drivable,
        eGameModeCameraMode.Track,
        eGameModeCameraMode.Helicopter,
        eGameModeCameraMode.Orbit,
        eGameModeCameraMode.Free,
        eGameModeCameraMode.OnBoard
    ];

    const eGameModeSelection = {

        GridType: {
            Automatic: "GameModeSelectionGridType_AUTO",
            Custom: "GameModeSelectionGridType_CUSTOM"
        },

        RaceType: {
            Time: "GameModeSelectionDuration_TIME",
            Laps: "GameModeSelectionDuration_LAPS"
        },

        BackFrom: {
            Unknown: "GameModeSelectionGoBackFrom_UNKNOWN",
            Garage: "GameModeSelectionGoBackFrom_GARAGE",
            Dealership: "GameModeSelectionGoBackFrom_DEALERSHIP",
            Paintshop: "GameModeSelectionGoBackFrom_PAINTSHOP",
            Partshop: "GameModeSelectionGoBackFrom_PARTSHOP",
            Rental: "GameModeSelectionGoBackFrom_RENTAL",
            Stats: "GameModeSelectionGoBackFrom_STATS",
            Results: "GameModeSelectionGoBackFrom_RESULTS",
            SpecialEvents: "GameModeSelectionGoBackFrom_SPECIAL_EVENTS",
            DrivingAcademy: "GameModeSelectionGoBackFrom_DRIVING_ACADEMY",
            Singleplayer: "GameModeSelectionGoBackFrom_SINGLE_PLAYER"
        },

        Response: {
            OK: "GameModeSelectionClientCommandsResponse_OK",
            NO_TRACKS: "GameModeSelectionClientCommandsResponse_NO_TRACKS",
            NO_SEASONDEFINITION: "GameModeSelectionClientCommandsResponse_NO_SEASONDEFINITION",
            NO_SETTINGS: "GameModeSelectionClientCommandsResponse_NO_SETTINGS",
            EVENT_WRONG: "GameModeSelectionClientCommandsResponse_EVENT_WRONG",
            SESSION_WRONG: "GameModeSelectionClientCommandsResponse_SESSION_WRONG",
            TYPE_WRONG: "GameModeSelectionClientCommandsResponse_TYPE_WRONG",
            BACKENDDISCONNECTED: "GameModeSelectionClientCommandsResponse_BACKENDDISCONNECTED",
            NOUSER: "GameModeSelectionClientCommandsResponse_NOUSER",
            MESSAGE_IN_PROGRESS: "GameModeSelectionClientCommandsResponse_MESSAGE_IN_PROGRESS",
            PARAMETER_ERROR: "GameModeSelectionClientCommandsResponse_PARAMETER_ERROR",
            CRITICAL_ERROR: "GameModeSelectionClientCommandsResponse_CRITICAL_ERROR"
        }
    };

    const eCarCustomization = {
        AttachmentType: {
            Additive: "AttachmentType_Additive",
            Replacement: "AttachmentType_Replacement"
        },
        Response: {
            OK: "CarCustomizationCommandsResponse_OK",
            NOCARS: "CarCustomizationCommandsResponse_NO_AVAILABLE_CARS",
            NOMECHPRESET: "CarCustomizationCommandsResponse_NO_MECHANICAL_PRESET",
            NOVISUALPRESET: "CarCustomizationCommandsResponse_NO_VISUAL_PRESET",
            READONLY: "CarCustomizationCommandsResponse_IS_READONLY",
            CRITICAL_ERROR: "CarCustomizationCommandsResponse_CRITICAL_ERROR"
        },

        PartCategory: {
            Bodywork: "CarCustomizationCategory_Bodywork",
            Rims: "CarCustomizationCategory_Rims",
            Compounds: "CarCustomizationCategory_Compounds",
            Parts: "CarCustomizationCategory_Parts",
            All: ""
        },
        ChannelUpdateRequest: {
            Multi: "UpdateMultilayerChannels",
            Single: "UpdateSinglelayerChannels",
            fromMaterial: (material) => {
                return eCarCustomization.ChannelUpdateRequest.fromType(material.material_type);
            },
            fromType: (material_type) => {
                return (material_type == eCarCustomization.MaterialTypes.Single) ?
                    eCarCustomization.ChannelUpdateRequest.Single : eCarCustomization.ChannelUpdateRequest.Multi;
            }
        },
        MaterialTypes: {
            Multi: "multilayer",
            Single: "singlelayer"
        },
        RequestMaterialType: {
            Multi: "SelectMultilayerMaterial",
            Single: "SelectSinglelayerMaterial",
            fromType: (material_type) => {
                return (material_type == eCarCustomization.MaterialTypes.Single) ?
                    eCarCustomization.RequestMaterialType.Single : eCarCustomization.RequestMaterialType.Multi;
            }
        },
        MaterialLocation: {
            Interior: "interior",
            Exterior: "exterior",
            fromMaterial: (material) => {
                return material.description.indexOf("EXT") == 0 ?
                    eCarCustomization.MaterialLocation.Exterior : eCarCustomization.MaterialLocation.Interior;
            }
        },
        PartType: {
            Oem: "oem",
            Aftermarket: "aftermarket"
        },
        ItemType: {
            Rim: "CarCustomizationRimItem",
            Part: "CarCustomizationPartItem",
            Design: "CarCustomizationDesignItem"
        }

    };

    const eGameEconomy = {
        Response: {
            OK: "GameEconomyClientCommandsResponse_OK",
            NoAvailableCars: "GameEconomyClientCommandsResponse_NO_AVAILABLE_CARS",
            NoMechanicalPreset: "GameEconomyClientCommandsResponse_NO_MECHANICAL_PRESET",
            NoVisualPreset: "GameEconomyClientCommandsResponse_NO_VISUAL_PRESET",
            NoMoney: "GameEconomyClientCommandsResponse_NO_MONEY",
            DifferentMoney: "GameEconomyClientCommandsResponse_DIFFERENT_MONEY",
            NoAvailableParts: "GameEconomyClientCommandsResponse_NO_AVAILABLE_PARTS",
            BackendDisconnected: "GameEconomyClientCommandsResponse_BACKEND_DISCONNECTED",
            IsReadOnly: "GameEconomyClientCommandsResponse_IS_READONLY",
            CriticalError: "GameEconomyClientCommandsResponse_CRITICAL_ERROR"
        }
    };

    const eVehicleTagFilters = {
        Any: "VehicleTagFilters_NO_FILTER",
        Evo: "VehicleTagFilters_EVO",
        Heritage: "VehicleTagFilters_HERITAGE",
        Luxury: "VehicleTagFilters_LUXURY",
        Racing: "VehicleTagFilters_RACING"
    };

    // export const eGameModeSelectionDuration = {
    //     Time: "GameModeSelectionDuration_TIME",
    //     Laps: "GameModeSelectionDuration_LAPS"
    // }

    const eUINofiticationType = {
        Debug: "UINotificationType_Debug",
        LevelUp: "UINotificationType_LevelUp",
        BestLap: "UINotificationType_BestLap",
        XpReward: "UINotificationType_Xp_Reward",
        CreditsReward: "UINotificationType_Credits_Reward",
        SessionPenalty: "UINotificationType_SessionPenalty",
        ConnectionStatus: "UINotificationType_ConnectionStatus",
        TyreWear: "UINotificationType_TyreWear",
        RentalDone: "UINotificationType_Rental_Done",
        GameplayInfo: "UINotificationType_Gameplay_Info",
        CarSettings: "UINotificationType_CarSettings",
        Car: "UINotificationType_Car",
        Session: "UINotificationType_Session",
        RaceControl: "UINotificationType_RaceControl",
        Multiplayer: "UINotificationType_Multiplayer"
    };

    const eUINotificationTypeSession = {
        BestLap: "SESSION_BEST_LAP",
        SessionOver: "SESSION_OVER",
        PersonalBestLap: "PERSONAL_BEST_LAP",
        LeaderLastLap: "LEADER_ON_LAST_LAP"
    };

    const eUINotificationTypeMultiplayer = {
        PlayerConnected: "PLAYER_CONNECTED",
        PlayerDisconnected: "PLAYER_DISCONNECTED"
    };



    const BindingType = {
        InputDeviceAxis: "InputDeviceAxis",
        KeyboardCommand: "KeyboardCommand",
        InputDeviceCommand: "InputDeviceCommand"
    };

    const POVDirections = {
        0: "Up",
        9000: "Right",
        18000: "Down",
        27000: "Left"
    };

    const UIInputActions = {
        Confirm: "UI.Confirm",
        Cancel: "UI.Cancel",
        Menu: "UI.Menu",
        PageUp: "UI.PageUp",
        PageDown: "UI.PageDown",
        ToggleHUD: "UI.ToggleHUD"
    };

    const eStorageContainers = {
        ServerPasswords: "serverpasswords",
        SimGridOptions: "simgridoptions",
        HUDLayout: "hudlayout",
        Notifications: "notifications"
    };

    const EngineEvents = {
        InSession: {
            FocusedCarChanged: "InSession.FocusedCarChanged",
            PlayerCarFocus: "InSession.PlayerCarFocus",
            HudVisibility: "InSession.HudVisibilityChanged"
        },
        UI: {
            SetupNavigation: "UI.SetupNavigation",
            RegisterModules: "UI.RegisterModules",
            ChangePage: "changePage",
            InputAction: "ui.action",
            ShowTooltip: "UI.ShowTooltip",
            HideTooltip: "UI.HideTooltip",
            UIExInputsAction: "UIExInputsAction"
        },
        Showroom: {
            Changed: "Showroom.Changed"
        },
        PaintShop: {
            RemovedPointlessMaterial: "PaintShop.RemovedPointlessMaterial",
            PartToggled: "PaintShop.PartToggled",
            MaterialDirty: "PaintShop.MaterialDirty",
            CarSaved: "PaintShop.CarSaved",
            MaterialRefreshed: "PaintShop.MaterialRefreshed",
            MaterialToggled: "PaintShop.MaterialToggled",
            MaterialUpdate: "PaintShop.MaterialUpdate",
            MaterialSelected: "PaintShop.MaterialSelected",
            LastEditorRendered: "PaintShop.LastEditorRendered",
            RimInstalled: "PaintShop.RimInstalled",
            RimDesignSelected: "PaintShop.RimDesignSelected",
        },
        GameMode: {
            GridReorder: "GridReorder"
        },
        VehicleSetup: {
            Init: "VehicleSetupInit",
            Refresh: "VehicleSetupRefresh"
        },
        TrackSelection: {
            CurrentTrackInList: "CurrentTrackInList"
        }
    };

    const eAudioEvents = {
        None: "GUI_NONE",
        Confirm: "GUI_CONFIRM",
        Select: "GUI_SELECT",
        Scroll: "GUI_SCROLL",
        Warning: "GUI_WARNING",
        Cancel: "GUI_CANCEL"
    };

    const eModalDialogTypes = {
        Standard: "standard",
        Warning: "warning",
        Error: "error"
    };

    const eEndSessionRowKeys = {
        ConsumedFuel: "CONSUMED_FUEL"
    };

    // Unfortunate duplication of pretty much the same enum for game client reasons

    const eLicenseType = {
        Entry: "LICENSE_ENTRY",
        SportsCar: "LICENSE_SPORTSCAR",
        SuperCar: "LICENSE_SUPERCAR",
        HyperCar: "LICENSE_HYPERCAR",
        Racing1: "LICENSE_RACING_1",
        Racing2: "LICENSE_RACING_2",
        Racing3: "LICENSE_RACING_3",
        None: "LICENSE_NONE"
    };

    const ePenaltyType = {
        Warning: "PenaltyType_Warning",
        Reprimand: "PenaltyType_Reprimand",
        Fine: "PenaltyType_Fine",
        RemoveBestLaptime: "PenaltyType_Remove_Best_Laptime",
        DropOfGridPosition: "PenaltyType_Drop_Of_Grid_Position",
        StartFromPitlane: "PenaltyType_Start_From_Pitlane",
        TimePenaltySeconds: "PenaltyType_Time_Penalty_Seconds",
        PenaltyLaps: "PenaltyType_Penalty_Laps",
        DropInClassification: "PenaltyType_Drop_Of_Place_In_Classification",
        DriveThrough: "PenaltyType_Drive_Through",
        StopAndGo: "PenaltyType_Stop_And_Go",
        Disqualification: "PenaltyType_Disqualification",
    };

    const eCSSClasses = {
        LoadingSummary: 'loading-summary'
    };

    const eUIUtilityCommandType = {
        JiggleMouse: "JiggleMouse",
        ChangeLanguage: "ChangeLanguage",
        OnLoaded: "OnLoaded",
        OnIntro: "OnIntro",
        OnIntroEnds: "OnIntroEnds",
        TriggerCore: "TriggerCore",
        SplashEnd: "SplashEnd",
        OnPauseGameMode: "OnPauseGameMode",
        OnResumeGameMode: "OnResumeGameMode",
        ShowroomSelectInterior: "ShowroomSelectInterior",
        ShowroomSelectExterior: "ShowroomSelectExterior",
        ShowroomSelectWheels: "ShowroomSelectWheels",
        PageChanged: "PageChanged",
        OnRoadmapEnd: "OnRoadmapEnd",
        SendChat: "SendChat"
    };

    const eUINotificationValueType = {
        Integer: "UINotificationValueType_Integer",
        Boolean: "UINotificationValueType_Bool",
        String: "UINotificationValueType_String",
        StringKey: "UINotificationValueType_StringKey",
        Time: "UINotificationValueType_Time",
        Delta: "UINotificationValueType_Delta"
    };

    const eReplayMarkerType = {
        All: "ReplayMarkerTypeAll",
        Laps: "ReplayMarkerTypeLaps",
        Incidents: "ReplayMarkerTypeIncidents"
    };

    const eUINotificationPriorityType = {
        None: "UINotificationPriorityType_Null",
        Low: "UINotificationPriorityType_Low",
        Normal: "UINotificationPriorityType_Normal",
        High: "UINotificationPriorityType_High",
        Maximum: "UINotificationPriorityType_Maximum",
    };

    const eUINotificationPriorityTypeValue = {
        "UINotificationPriorityType_Null": 0,
        "UINotificationPriorityType_Low": 1,
        "UINotificationPriorityType_Normal": 2,
        "UINotificationPriorityType_High": 3,
        "UINotificationPriorityType_Maximum": 4,
    };

    //import components from 'coherent-gameface-components';

    class MenuState {

        #isSaving = false;

        history = [];

        constructor() {
            const storedHistory = localStorage.getItem("history");

            if (storedHistory) {
                this.history = JSON.parse(storedHistory);
            }
        }

        addToHistory() {
            const entry = `${window.location.pathname}|${ModelMenuState.path}`;
            if (this.history.at(-1) != entry) {
                // console.trace("addToHistory", `${window.location.pathname}|${ModelMenuState.path}`);
                this.history.push(entry);
                localStorage.setObject("history", this.history);
            }
        }

        back() {
            if (this.history.length > 0) {
                const target = this.history.at(-2).split("|");//this.history.pop().split("|");
                if (target) {
                    this.history.pop();
                    localStorage.setObject("history", this.history);
                    ksUI$1.goTo(target[0], target[1]);
                } else {
                    console.warn("menuState.back: No more entries in history");
                }
            }
        }

        purgeHistory() {
            this.history = [];
        }

        get isOriginMainMenu() {
            return this.getOrigin()[0] == "/menu.html";
        }

        isValid() {
            return window["ModelMenuState"] !== undefined;
        }

        get() {
            return ModelMenuState;
        }

        save(silent = false) {
            if (this.isValid() && !this.#isSaving) {
                if (!silent) console.log("Saving UIMenuState");
                if (!ModelMenuState.path) ModelMenuState.path = "";
                ksUI$1.triggerUICommand("UIMenuState", ModelMenuState);
            } else if (!this.isValid()) {
                console.log("ModelMenuState not initialized");
            }
        }

        // reset() {
        //     ModelMenuState.path = "main/main"
        // }

        getCurrentLocation() {
            return [location.pathname, ModelMenuState.path];
        }

        getOrigin() {
            return ModelMenuState.origin.split("|");
        }

        overrideOrigin(page, path) {
            if (!page) page = window.location.pathname;
            ModelMenuState.origin = page + "|" + path;
            console.log("overriding origin", ModelMenuState.origin);
            return this;
        }

        storeOrigin() {
            if (ModelMenuState.path == "") {
                ModelMenuState.path = "main/main";
            }
            ModelMenuState.origin = window.location.pathname + "|" + ModelMenuState.path;
            console.log("Storing origin", ModelMenuState.origin);
            return this;
        }

        update(callback) {
            console.log("Fetching UIMenuState");
            ksUI$1.fetchModel("ModelMenuState", !window["ModelMenuState"], () => {
                waitForFrames(() => {
                    engine.trigger("onStateLoaded");
                }, 2);

                if (callback)
                    callback(ModelMenuState);
            });


        }

        getFromStore(entrykey) {
            if (!this.isValid()) return null;
            let store = ModelMenuState.store;
            for (let i = 0; i < store.length; i++) {
                if (store[i].key == entrykey) {
                    return store[i].value;
                }
            }
            return null;
        }

        overrideShowcaseCamera(override_state, silent = true) {
            //console.trace("togglemousehover", mouse_state);
            if (window["ModelMenuState"]) {
                if (ModelMenuState.override_showcase_camera != override_state) {
                    if (!silent) console.log("overrideShowcaseCamera", override_state);
                }
                ModelMenuState.override_showcase_camera = override_state;
                this.save(true);
            }
        }

        ignoreInputActions(input_state, silent = true) {
            // ignore_gameplay_input_actions
            if (window["ModelMenuState"]) {
                if (ModelMenuState.ignore_gameplay_input_actions != input_state) {
                    if (!silent) console.log("ignore_gameplay_input_actions", input_state);
                }
                ModelMenuState.ignore_gameplay_input_actions = input_state;
                this.save(true);
            }

        }

        toggleMouseHover(mouse_state, silent = true) {

            if (window["ModelMenuState"]) {
                if (ModelMenuState.is_widget_hovering != mouse_state) {
                    if (!silent) console.log("toggleMouseHover", mouse_state);
                }
                ModelMenuState.is_widget_hovering = mouse_state;
                this.save(true);
            }
        }

        toggleKeyboardInput(input_state, silent = true) {

            if (window["ModelMenuState"]) {
                if (ModelMenuState.is_chat_active != input_state) {
                    if (!silent) console.log("toggleKeyboardInput", input_state);
                }
                ModelMenuState.is_chat_active = input_state;
                this.save(true);
            }
        }

        addToStore(entrykey, entryvalue) {
            if (!this.isValid()) return false;
            let store = ModelMenuState.store;
            let replace = false;
            for (let i = 0; i < store.length; i++) {
                if (store[i].key == entrykey) {
                    store[i].value = entryvalue;
                    replace = true;
                    break;
                }
            }
            if (!replace) {
                ModelMenuState.store.push({ __Type: "StoreEntry", key: entrykey, value: entryvalue });
            }
            console.log("addToStore", entrykey, entryvalue);
            this.save(true);
            return true;
        }

        delFromStore(entrykey) {
            if (!this.isValid()) return false;
            let store = ModelMenuState.store;
            for (let i = 0; i < store.length; i++) {
                if (store[i].key == entrykey) {
                    store.splice(i, 1);
                }
            }
            this.save();
            return true;
        }


    }

    class ksUI$1 {

        static mousenav = true;
        static mouseX = -1;
        static mouseY = -1;
        static lastFocused;

        static perFrameModelUpdateId;
        static RegisteredModels = [];

        static Models = {
            CarDisplay: [
                "ModelCurrentCar"
            ],
            Enabled: [
                "ModelUIState",
                "ModelUIDriverState",
                "ModelTiming",

                "ModelUIRadarState",
                
            ],
            Disabled: [
                "ModelUISessionState",
                "ModelUIReplayState",
                "ModelUIExInputsAxii",
                "ModelCarsOnTrack",
                "ModelLeaderboard",
                "ModelUIRealtimeLeaderboard",
                "ModelUIPenaltyState",

            ],
            /**
             * @type function
             * @returns {Array}
             */
            getAll: function () {
                return [].concat(this.CarDisplay, this.Enabled);
            },

            enable: (model_name) => {
                ksUI$1.Models.Disabled.filter((value, index, array) => {
                    if (value == model_name) {
                        array.splice(index, 1);
                        ksUI$1.Models.Enabled.push(value);
                        console.log("Enabled", value, index);
                        return true;
                    }
                    return false;
                });

                ksUI$1.fetchAllModels(true);
            },

            disable: (model_name, delete_model = false) => {

                ksUI$1.Models.Enabled.filter((value, index, array) => {
                    if (value == model_name) {
                        array.splice(index, 1);
                        ksUI$1.Models.Disabled.push(value);
                        console.log("Disabled", value, index);
                        if (delete_model) delete window[value];
                        return true;
                    }
                    return false;
                });

                ksUI$1.fetchAllModels(true);
            }
        };

        static lastModelUpdateTime = 0;
        static lastDisplayModelUpdateTime = 0;
        static shouldUpdate = true;
        static shouldUpdateDisplays = true;

        static perFrame = 3;

        static menuState = new MenuState();

        static isDevMode() {
            return isDevMode()
        }

        static isTesterMode() {
            return isTester();
        }

        static isDevOrTester() {
            return isDevMode() || isTester();
        }

        static isFirstLoad() {
            return isFirstLoad();
        }

        static loadUIConfig(fromfile = false) {
            return loadUIConfig(fromfile);
        }

        //expects eGameModeSelection.BackFrom
        static requestGoBack(go_back_from, success_callback, failure_callback) {
            console.log("requestGoBack", go_back_from);
            if (!go_back_from) go_back_from = eGameModeSelection.BackFrom.Unknown;
            this.request("GameModeSelectionClient", "GoBack", (data) => {
                ({
                    [eClientCommands.Response.OK]: () => { if (success_callback) success_callback(data); },
                    [eClientCommands.Response.CriticalError]: () => { if (failure_callback) failure_callback(data); },
                    [eClientCommands.Response.ParameterError]: () => { if (failure_callback) failure_callback(data); }
                }[data.response])?.();

            }, {
                "go_back_from": go_back_from
            });
        }

        static storeUIConfig(config_text) {
            return storeUIConfig(config_text);
            //localStorage.setItem("ksUIConfig", config_text ? config_text : JSON.stringify(window["ksUIConfig"]));
        }

        static waitForFrames(callback = () => { }, count = 3) {
            if (count === 0) return callback();
            count--;
            return requestAnimationFrame(() => {
                return this.waitForFrames(callback, count)
            });
        }


        static perFrameAllModelUpdate(time) {
            const delta = time - ksUI$1.lastModelUpdateTime;
            ksUI$1.shouldUpdate = (delta >= 33.3);


            if (ksUI$1.shouldUpdate) {
                ksUI$1.fetchAllModels();
                ksUI$1.lastModelUpdateTime = time;
            }
            return requestAnimationFrame(ksUI$1.perFrameAllModelUpdate);
        }

        static getGuid() {
            return 'xxxx-xxxx-xxx-xxxx'.replace(/[x]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        static getRandomFromArray(array) {
            const random = Math.floor(Math.random() * array.length);
            return array[random];
        }

        static getRandomInt(max) {
            return Math.floor(Math.random() * max);
        }

        static capitalizeChar(string, char_index = 0) {
            if (char_index >= string.length) {
                char_index = string.length - 1;
            }
            return string.replace(/^./, string[char_index].toUpperCase());
        }

        static reset(obj) {
            Object.keys(obj).forEach(key => {
                delete obj[key];
            });
        }

        static iterateToText(obj, depth = 0) {

            let output = "";

            Object.keys(obj).forEach(key => {

                var prefix = "";
                for (var i = 0; i < depth; i++) {
                    prefix = "\t" + prefix;
                }

                output += prefix + key + " (" + typeof obj[key] + "): " + obj[key] + "\n";

                if (typeof obj[key] === 'object' && obj[key] !== null) {
                    depth++;
                    output += this.iterateToText(obj[key], depth);
                    depth--;
                }
            });

            return output;
        }

        static iterate(obj, depth = 0) {
            console.trace(obj);
            //console.log(this.iterateToText(obj, depth));
        }

        static onResponse(context, prefix, name, callback, handle_once = true) {
            const eventname = prefix + "Response" + name;
            engine.on(eventname, (response) => {
                if (callback)
                    callback(response);
                if (handle_once) engine.off(eventname);
                console.log("response returned", eventname);
            }, this);
            console.log("response bound", eventname);
        }

        static requestAndIterate(prefix, name, payload = {}) {
            this.request(prefix, name, (response) => { this.iterate(response); }, payload);
        }

        static requestNoResponse(prefix, name, ...args) {
            const commandname = prefix + "Request" + name;
            let payload;
            let silent = false;
            if (typeof args[0] == "object") {
                payload = args[0];
                silent = args[1];
            }
            else if (args.length == 2) {
                // if there is a payload
                args[0];
                payload = args[1];
            } else if (args.length == 3) {
                args[0];
                payload = args[1];
                silent = args[2];
            }

            console.log("request made", commandname);
            this.triggerUICommand(commandname, payload, silent);
        }

        static request(prefix, name, ...args) {
            const commandname = prefix + "Request" + name;
            let context, payload, callback;
            if (typeof args[0] == "function") {
                // straight callback
                context = this;
                callback = args[0];
                payload = args[1];
            }
            else if (args.length == 3) {
                // if there is a payload
                context = args[0];
                callback = args[1];
                payload = args[2];
            }

            this.onResponse(context, prefix, name, callback);
            console.log("request made", commandname);
            this.triggerUICommand(commandname, payload);
        }

        static perFrameCarDisplayModelUpdate(time) {

            const delta = time - ksUI$1.lastDisplayModelUpdateTime;
            ksUI$1.shouldUpdateDisplays = (delta >= 33.3);

            if (ksUI$1.shouldUpdateDisplays) {
                ksUI$1.fetchCarDisplayModels();
                ksUI$1.lastDisplayModelUpdateTime = time;
            }

            requestAnimationFrame(ksUI$1.perFrameCarDisplayModelUpdate);
        }

        static stopAllModelUpdates() {
            cancelAnimationFrame(this.perFrameModelUpdateId);
        }

        static preventBack = false;
        static reloading = false;

        static Init(car_display) {
            console.log("ksUI.Init");

            this.preventBack = false;

            if (!car_display) {



                this.fetchAllModels(true); // initialize all models

                this.perFrameModelUpdateId = this.perFrameAllModelUpdate();

                this.jiggleMouse();

                SpatialNavigation$1.init();

                if (ksUI$1.isSpatialNav()) {
                    document.body.classList.add("spatialnav");
                }

                q("body").classList.add(window["buildTags"].length == 0 ? "release-build" : "devmode");
                q("body").classList.toggle("tester-build", ksUI$1.isTesterMode());


                q("body").dataset.bindBackendState = "{{ModelUIState}}";

                engine.on("OnBackendConnectionChanged", (value) => {
                    console.warn("Backend Connection", value ? "UP" : "DOWN");

                    // if (!ksUI.isDevMode() && !value) {
                    //     rootModal().Show({
                    //         buttons: 0x100,
                    //         title: "lblOfflineMode",
                    //         extraCssClass: "backend-error",
                    //         message: "msgContinueOfflineMode",
                    //         confirm: "btnContinue"
                    //     }).onConfirm = () => {

                    //         ksUI.clearReturnPage();

                    //         //                        if(document.body.classList.contains("paintshop")) {
                    //         ksUI.requestGoBack(eGameModeSelection.BackFrom.Unknown, () => {
                    //             //ksUI.goTo("menu.html", "main/main");
                    //         });
                    //         // } else {
                    //         //     ksUI.goTo("menu.html", "main/main");
                    //         // }


                    //     };
                    // }
                });

                if (navigator.userAgent.indexOf("ACEvo") > -1) {
                    // we are in the game, don't use native SpatialNavigation keydown bindings
                    console.log("using Action binding for UI nav");
                    this.bindActions();
                    // SpatialNavigation.pause();
                } else {
                    console.log("using direct keyboard binding for UI nav");
                }

                window.addEventListener("sn:willmove", function (evt) {
                    if (ksUI$1.lastFocused) {
                        // console.log("UI focusing", evt.detail.sectionId);
                        SpatialNavigation$1.focus(evt.detail.sectionId);
                        ksUI$1.lastFocused = null;
                    }

                    ksUI$1.enterSpatialNav();
                });

                window.addEventListener("mousedown", function () {
                    if (!ksUI$1.enteringSpatialNav) {
                        if (!ksUI$1.mousenav) {
                            q("body").classList.remove("spatialnav");
                            localStorage.removeItem("spatialnav");
                            //console.log("removed spatial nav");
                            waitForFrames(() => {
                                ksUI$1.jiggleMouse();
                            });
                            ksUI$1.mousenav = true;
                        }
                    }
                });

                window.addEventListener("wheel", function () {
                    if (!ksUI$1.enteringSpatialNav) {
                        if (!ksUI$1.mousenav) {
                            q("body").classList.remove("spatialnav");
                            localStorage.removeItem("spatialnav");
                            //console.log("removed spatial nav");
                            waitForFrames(() => {
                                ksUI$1.jiggleMouse();
                            });
                            ksUI$1.mousenav = true;
                        }
                    }
                });

                window.addEventListener("mousemove", function (evt) {
                    if (!ksUI$1.enteringSpatialNav) {
                        if ((ksUI$1.mouseX != -1 && ksUI$1.mouseY != -1) && (Math.abs(ksUI$1.mouseX - evt.clientX) > 6 || Math.abs(ksUI$1.mouseY - evt.clientY) > 6)) {
                            q("body").classList.remove("spatialnav");
                            localStorage.removeItem("spatialnav");
                            //console.log("removed spatialnav", ksUI.mouseX - evt.clientX, ksUI.mouseY - evt.clientY);
                            if (!ksUI$1.mousenav) {
                                waitForFrames(() => {
                                    ksUI$1.jiggleMouse();
                                });
                            }
                            ksUI$1.mousenav = true;

                            if (!ksUI$1.isInTextElement()) {
                                ksUI$1.lastFocused = document.activeElement;
                                document.activeElement.blur();
                            }

                        }
                    }

                    ksUI$1.mouseX = evt.clientX;
                    ksUI$1.mouseY = evt.clientY;
                });

            } else {
                this.fetchCarDisplayModels(true);
                this.perFrameModelUpdateId = requestAnimationFrame(this.perFrameCarDisplayModelUpdate);
            }

        }

        static recoveredElementCount = 0;

        static fromPromise = (cb) => (args) => cb(...args);

        static inPlaceRecovery(element) {
            const fakediv = document.createElement("div");
            (ksUI$1.recoveredElementCount / ksUI$1.ksComponentCount).toFixed(2);
            fakediv.innerHTML = element.outerHTML;

            console.warn("Attempting in place recovery of", element.tagName, element.id, ksUI$1.recoveredElementCount, ksUI$1.ksComponentCount); //, ratio);

            fakediv.childNodes.item(0).classList.add("REPLACED");
            element.parentElement.replaceChild(fakediv.childNodes.item(0), element);

            // console.warn(this.recoveredElementCount, ksUI.ksComponentCount, ksUI.recoveredElementCount/ksUI.ksComponentCount);

            this.recoveredElementCount++;
        }

        static ksComponentCount = 0;

        static validateComponents() {
            this.ksComponentCount = 0;
            // console.warn("ksUI.validateComponents");
            let scanned = [];
            if (!customElements || !customElements.whenDefined || !customElements.get || !customElements.define) {
                console.warn("validateComponents cannot proceed - customElements not initialized");
                return;
            }

            qAll("*");

            qAll("*").forEach(elem => {

                const tag = elem.tagName.toLowerCase();

                if (window.reloading) {
                    return false;
                }

                if (tag.indexOf("ks-dev-") > -1 && !ksUI$1.isDevMode()) {
                    return false;
                }
                if (tag.indexOf("ks-") > -1 && scanned.indexOf(tag) == -1) {
                    this.ksComponentCount++;

                    if (!elem.constructor) {
                        console.error(elem.tagName, "missing constructor");
                        return;
                    }
                    if (!customElements.get) {
                        console.error("RELOAD TRIGGERED: customElements non-init", elem.tagName);
                        window.reloading = true;
                        window.location.reload(true);
                    } else if (!customElements.get(elem.tagName.toLowerCase())) {
                        console.warn(elem.tagName, "not defined");
                        return;
                    }
                    if (elem.constructor.name == "HTMLElement" && !ksUI$1.reloading) {
                        console.error("Invalid", elem.tagName, "rendered with wrong class HTMLElement instead of", customElements.get(elem.tagName).name);
                        ksUI$1.inPlaceRecovery(elem);

                        waitForFrames(() => ksUI$1.validateComponents(), 3, ksUI$1.validateDebouncer);
                    }

                    // scanned.push(tag);
                }
            });
        }

        static moduleRegistryCache = [];

        static registerModule(name, class_name) {
            components$1.defineCustomElement(name, class_name);
            //ksUI.moduleRegistryCache.push([name, class_name]);
        }

        static unassignModel(model_name, silent_error = true, silent_success = false) {
            const index = this.RegisteredModels.indexOf(model_name);
            if (index > -1) {
                this.RegisteredModels.splice(index, 1);
                if (!silent_success) console.log("Unregistered", model_name);
            } else {
                if (!silent_error) console.log(model_name, "not registered");
            }
            if (window[model_name]) {
                engine.unregisterModel(window[model_name]);
                //delete window[model_name];
                if (!silent_success) console.log("unassignModel", model_name);
            } else {
                if (!silent_error) console.log(model_name, "not defined");
            }
        }

        static clamp(val, min = 0, max = 1) {
            return Math.min(max, Math.max(min, val));
        }

        static lerp(x, y, a) {
            return x * (1 - a) + y * a;
        }

        static invLerp(x, y, a) {
            return this.clamp((a - x) / (y - x));
        }

        static range(value, inMin, inMax, outMin, outMax) {
            return this.lerp(outMin, outMax, this.invLerp(inMin, inMax, value));
            //return this.scaleValue(value, inMin, inMax, outMin, outMax);
        }

        static bezier(value, s1, s2, t1, t2, slope) {
            //Default to linear interpolation
            slope = slope || 0.5;

            //If the value is out of the source range, floor to min/max target values
            if (value < Math.min(s1, s2)) {
                return Math.min(s1, s2) === s1 ? t1 : t2;
            }

            if (value > Math.max(s1, s2)) {
                return Math.max(s1, s2) === s1 ? t1 : t2;
            }

            //Reverse the value, to make it correspond to the target range (this is a side-effect of the bezier calculation)
            value = s2 - value;

            var C1 = { x: s1, y: t1 }; //Start of bezier curve
            var C3 = { x: s2, y: t2 }; //End of bezier curve
            var C2 = {              //Control point
                x: C3.x,
                y: C1.y + Math.abs(slope) * (C3.y - C1.y)
            };

            //Find out how far the value is on the curve
            var percent = value / (C3.x - C1.x);

            return C1.y * b1(percent) + C2.y * b2(percent) + C3.y * b3(percent);

            function b1(t) { return t * t }
            function b2(t) { return 2 * t * (1 - t) }
            function b3(t) { return (1 - t) * (1 - t) }
        }

        static sameType(target_value, value) {
            if (typeof value == typeof target_value)
                return value;

            let target_type = typeof target_value;

            switch (target_type) {
                case "boolean":
                    return Boolean(value);
                case "number":
                    return Number(value);
                case "string":
                    return String(value);
                default:
                    return value;
            }
        }

        static type_of(variable) {
            return Object.prototype.toString.call(variable).slice(8, -1).toLowerCase();
        }

        static assignModel(model, model_name, init, silent = false) {

            if (!model_name) {
                console.log("assignModel received undefined model name");
                return;
            }

            if (init || !window[model_name]) {
                if (this.RegisteredModels.indexOf(model_name) == -1) {
                    engine.createJSModel(model_name, {});
                    this.RegisteredModels.push(model_name);
                    if (!silent) console.log("Registered", model_name);
                    engine.trigger("onModelRegistered", model_name);
                } else {
                    this.unassignModel(model_name, true, true);
                    engine.createJSModel(model_name, {});
                    this.RegisteredModels.push(model_name);
                    if (!silent)
                        console.log("Reassigned", model_name);
                }

            }

            Object.assign(window[model_name], model);
            engine.updateWholeModel(window[model_name]);
        }

        static audiodebouncer = { id: 0 };

        static Audio(audio_event_type) {
            if (audio_event_type == eAudioEvents.None) return;

            cancelAnimationFrame(ksUI$1.audiodebouncer.id);

            waitForFrames(() => {
                triggerUICommand("UIAudioRequestAudioEvent", { type: audio_event_type });
            }, 1, ksUI$1.audiodebouncer);
        }

        static jiggleMouse() {
            ksUI$1.UIUtilityCommand("JiggleMouse");
        }

        static UIUtilityCommand(command_name, payload) {

            triggerUICommand("UtilityCommand", payload !== undefined ? { type: command_name, param: payload } : { type: command_name }, true);
        }

        static triggerUICommand(command_name, command_data, silent) {
            triggerUICommand(command_name, command_data, silent);
        }

        static setCommand(command_name, command_data, handler_success, handler_rejection, silent) {
            setCommand(command_name, command_data, handler_success, handler_rejection, silent);
        }

        static fetchModel(model_name, init, callback) {
            if (!model_name) {
                console.log("fetchModel expecting model name, received:", model_name);
                return;
            }

            engine.call('get' + model_name).then((model) => {

                this.assignModel(model, model_name, init);
                if (init) {
                    console.log("Initial fetch", model_name);
                }

                if (callback) callback(model);
            });
        }

        static setModel(model_name, callback) {
            engine.call('set' + model_name).then((model) => {
                if (callback) callback(model);
            });
        }

        static fetchCarDisplayModels_internal() {

        }

        static fetchCarDisplayModels(init) {

            if (init) {
                console.log("Fetching Models for Car Displays");
                let funcString = "";
                for (const model of this.Models.CarDisplay) {
                    funcString += `this.fetchModel("${model}");`;
                }
                this.fetchCarDisplayModels_internal = Function(funcString);
            }

            this.fetchCarDisplayModels_internal();

        }


        static pauseModelSync = false;

        static fetchAllModels_internal() {

        }

        static fetchAllModels(init) {

            if (this.pauseModelSync) return;

            if (init) {
                console.trace("Fetching Models init");
                let funcString = "";
                for (const model of this.Models.getAll()) {
                    funcString += `this.fetchModel("${model}");`;
                }
                this.fetchAllModels_internal = Function(funcString);
            }

            this.fetchAllModels_internal();

        }

        static isInTextElement() {
            return ["input", "textarea"].indexOf(document.activeElement.tagName.toLowerCase()) > -1;
        }

        static blurTextElement() {
            if (["input", "textarea"].indexOf(document.activeElement.tagName.toLowerCase()) > -1) {
                document.activeElement.blur();
                return true;
            }
            return false;
        }

        static validateFileName(file_name) {

            if (file_name.length < 1) {
                return false;
            }

            var rg = /^[a-zA-Z0-9_-]+$/; // allowed only

            return rg.test(file_name);
        }

        static spatialNavigationActive = true;

        static toggleSpatialNavigation(is_active, pause = true) {
            pause ?
                is_active ? SpatialNavigation$1.resume() : SpatialNavigation$1.pause()
                :
                is_active ? SpatialNavigation$1.enable() : SpatialNavigation$1.disable();
            this.spatialNavigationActive = is_active;
        }

        static bindActions() {
            let result = false;
            console.log("ksUI.bindActions");
            engine.on("UIExInputsAction", (e) => {
                //console.log("-> UIExInputsAction " + e.action);
                if (!this.spatialNavigationActive) return;

                let change_focus = true;

                switch (e.action) {
                    case "InputAction_UI_Left":
                        if (!this.isInTextElement()) {
                            result = SpatialNavigation$1.move("left");
                            this.dispatchActionEvent("left");
                        } else {
                            change_focus = false;
                        }
                        break;
                    case "InputAction_UI_Right":
                        if (!this.isInTextElement()) {
                            result = SpatialNavigation$1.move("right");
                            this.dispatchActionEvent("right");
                        } else {
                            change_focus = false;
                        }
                        break;
                    case "InputAction_UI_Up":
                        result = SpatialNavigation$1.move("up");
                        this.dispatchActionEvent("up");
                        break;
                    case "InputAction_UI_Down":
                        result = SpatialNavigation$1.move("down");
                        this.dispatchActionEvent("down");
                        break;
                    case "InputAction_UI_Confirm":
                        engine.trigger(UIInputActions.Confirm);
                        result = SpatialNavigation$1.enter();
                        this.dispatchActionEvent("confirm");
                        break;
                    case "InputAction_UI_Cancel":
                        if (!this.blurTextElement()) {
                            engine.trigger(UIInputActions.Cancel);
                            this.dispatchActionEvent("cancel");
                            return true;
                        }
                        break;
                    case "InputAction_UI_Menu":
                        engine.trigger(UIInputActions.Menu);
                        this.dispatchActionEvent("menu");
                        return true;
                    case "InputAction_UI_PageUp":
                        engine.trigger(UIInputActions.PageUp);
                        this.dispatchActionEvent("pageup");
                        return true;
                    case "InputAction_UI_PageDown":
                        engine.trigger(UIInputActions.PageDown);
                        this.dispatchActionEvent("pagedown");
                        return true;
                    case "InputAction_UI_ToggleHud":
                        engine.trigger(UIInputActions.ToggleHUD);
                        this.dispatchActionEvent("togglehud");
                        return true;

                    default:
                        //ksUI.iterate(e);
                        //console.log("->" + e.action, e.action_payload, e.action_number);
                        // we don't handle this kind of action - silently return
                        return;
                }

                if (!result && change_focus) {
                    // console.log("SpatialNavigation refocused");
                    SpatialNavigation$1.focus();
                    ksUI$1.enterSpatialNav();
                }
            });

        }

        static focusDebouncer = { id: 0 };
        static validateDebouncer = { id: 0 };

        static lastFocusedElement;

        static indicatorTrackId = 0;

        static clearFocus() {
            ksUI$1.indicateFocus(null, false);
        }

        static _focusbox;

        static get focusBox() {
            if (!ksUI$1._focusbox) {
                let box = q("#focusbox");
                if (!box) {
                    box = document.createElement("div");
                    box.setAttribute("id", "focusbox");
                    document.body.appendChild(box);
                }
                ksUI$1._focusbox = box;
            }
            return ksUI$1._focusbox;
        }

        /** @param {HTMLElement} element */
        static indicateFocus(element, visible) {

            cancelAnimationFrame(ksUI$1.focusDebouncer.id);
            cancelAnimationFrame(this.indicatorTrackId);

            /** @type HTMLDivElement */
            let box = q("#focusbox");

            if (element && element.hasAttribute("no-extra-indicator")) {
                box?.classList.remove("visible");
                ksUI$1.lastFocusedElement = element;
                return;
            }

            if (!box) {
                box = document.createElement("div");
                box.setAttribute("id", "focusbox");
                document.body.appendChild(box);
            }

            //if (document.body.classList.contains("spatialnav")) visible = true;

            if (!visible) box.classList.remove("visible");

            if (!element) {
                visible = false;
            }

            waitForFrames(() => {
                if (visible) {
                    const rect = element.getBoundingClientRect();
                    // console.warn("ifocus", element.tagName, element.id, element.classList);
                    box.style.topPX = rect.top - 6;
                    box.style.leftPX = rect.left - 6;
                    box.style.bottomPX = window.innerHeight - rect.bottom - 6;
                    box.style.rightPX = window.innerWidth - rect.right - 6;
                    ksUI$1.lastFocusedElement = element;
                    box.classList.add("visible");
                    ksUI$1.indicatorTrackId = requestAnimationFrame(ksUI$1.perFrameIndicatorUpdate);
                } else {
                    box.style.topPX = 0;
                    box.style.leftPX = 0;
                    box.style.bottomPX = 0;
                    box.style.rightPX = 0;

                }
            }, 3, ksUI$1.focusDebouncer);
        }

        static lastIndicatorUpdate = 0;

        static perFrameIndicatorUpdate(time) {

            if (!ksUI$1.lastFocusedElement) return;

            const delta = time - ksUI$1.lastIndicatorUpdate;
            let shouldUpdate = (delta >= 33.3);

            if (shouldUpdate) {
                const element = ksUI$1.lastFocusedElement;
                const rect = element.getBoundingClientRect();
                var offset = Math.round(4 / window["FontScale"]);
                ksUI$1.focusBox.style.topPX = rect.top - offset;
                ksUI$1.focusBox.style.leftPX = rect.left - offset;
                ksUI$1.focusBox.style.bottomPX = window.innerHeight - rect.bottom - offset;
                ksUI$1.focusBox.style.rightPX = window.innerWidth - rect.right - offset;
                ksUI$1.lastIndicatorUpdate = time;
            }

            return requestAnimationFrame(ksUI$1.perFrameIndicatorUpdate);
        }

        static areParentsDisabledOrHidden(elem) {
            while (elem.parentNode) {
                let elemStyle = getComputedStyle(elem);
                if (elemStyle.visibility != "visible"
                    || elemStyle.display == "none"
                    || elemStyle.opacity == 0
                    || elemStyle.content == "'disabled'"
                    || elem.hasAttribute("disabled")
                    || elem.disabled) {
                    return true;
                }
                elem = elem.parentNode;
            }
            return false;
        }


        /** Returns { width, height } of element in pixels including margins */
        static getElementSize(element) {
            const unit = parseFloat(window.getComputedStyle(document.body).fontSize);
            const computedStyle = window.getComputedStyle(element);

            let itemwidth = element.offsetWidth;
            let itemheight = element.offsetHeight;

            let marginTop = computedStyle.marginTop;
            let marginBottom = computedStyle.marginBottom;
            let marginRight = computedStyle.marginTop;
            let marginLeft = computedStyle.marginBottom;

            marginTop = marginTop.indexOf("px") == -1 ? parseFloat(marginTop) * unit : parseFloat(marginTop);
            marginBottom = marginBottom.indexOf("px") == -1 ? parseFloat(marginBottom) * unit : parseFloat(marginBottom);
            marginRight = marginRight.indexOf("px") == -1 ? parseFloat(marginRight) * unit : parseFloat(marginRight);
            marginLeft = marginLeft.indexOf("px") == -1 ? parseFloat(marginLeft) * unit : parseFloat(marginLeft);

            return {
                width: itemwidth + marginLeft + marginRight,
                height: itemheight + marginTop + marginBottom
            };

        }

        static dispatchActionEvent(action_name) {
            window.dispatchEvent(new CustomEvent("ui.action", { detail: action_name }));
        }

        enteringSpatialNav = false;

        static makeTagFromBrackets(value) {
            if (value.indexOf("{") > -1) {
                return value.replace(/\{(.+?)\/(.+?)\}/g, function (matches, content, className) {
                    return `<div class="${className}">${content}</div>`;
                });
            } else {
                return value;
            }
        }

        static enterSpatialNav() {

            if (ksUI$1.mousenav) {
                q("body").classList.add("spatialnav");
                localStorage.setItem("spatialnav", "true");
                this.enteringSpatialNav = true;
                this.waitForFrames(() => {
                    this.jiggleMouse();
                    this.waitForFrames(() => {
                        this.enteringSpatialNav = false;
                    }, 10);
                });

                ksUI$1.mousenav = false;
            }
            //this.enteringSpatialNav = false;
        }

        static groupTrace(label, trace_payload) {
            console.groupCollapsed(label);
            console.trace(trace_payload);
            console.groupEnd();
        }

        static isInLoadingTransition() {
            return document.body.classList.contains(eCSSClasses.LoadingSummary);
        }

        static isSpatialNav() {
            return (localStorage.getItem("spatialnav") != null) || document.body.classList.contains("spatialnav");
        }


        static changePage(target, notransition, storeorigin = false, triggerPageChanged = true) {

            this.menuState.update(() => {

                console.log(">> changePage", location.pathname, target, "storeorigin:", storeorigin, "transition:", !notransition);

                if (storeorigin) this.menuState.storeOrigin();

                ksUI$1.clearFocus();
                engine.trigger('changePage', target, notransition, true);
            });
        }

        static getNonZeroDecimalPosition(num) {
            const str = String(num);
            var unzero = String(str).replace(/\.(0+)?/, "");
            return unzero.length !== str.length ? str.length - unzero.length : -1
        }

        static changeLanguage(language) {
            if (language) {
                console.log("ChangeLanguage requested", language);
                window.Language = language;
                document.documentElement.setAttribute("lang", language);
                localStorage.setItem("language", language);

                triggerUICommand("UtilityCommand", { type: eUIUtilityCommandType.ChangeLanguage, param: language }, true);

                waitForFrames(() => engine.reloadLocalization(), 3);
            }
        }

        static get currentLanguage() {
            return document.documentElement.getAttribute("lang");
        }


        static loadView(target) {
            engine.trigger('OnUICommand', 'LoadView', target);
        }

        static roundToStepPercentString(val, step) {
            return this.roundTo(val * 100, step) + "%";
        }

        static roundTo(val, step) {
            return Math.round(val / step) * step;
        }

        static scaleValue(number, inMin, inMax, outMin, outMax) {
            return this.clamp((number - inMin) * (outMax - outMin) / (inMax - inMin) + outMin, outMin, outMax);
        }

        static getParam(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) == variable) {
                    return decodeURIComponent(pair[1]);
                }
            }

            console.log('Parameter %s not found', variable);
        }

        static scrollToVertical(elem, position, duration = 600, absolute = false) {
            //console.trace("scrollToVertical");
            if (duration < 0) {
                elem.scrollTop = position;
                elem.dispatchEvent(new Event('scroll'));
                return;
            }

            const startTime = performance.now();

            cancelAnimationFrame(ksUI$1.scrollingDebounce);

            const step = () => {
                const progress = ksUI$1.clamp((performance.now() - startTime) / duration, 0, 1);
                let amount = this.easeOutCubic(progress);

                if (absolute) {
                    const scrollto = Math.round((elem.scrollTop - (elem.scrollTop * amount)) + (position * amount));
                    elem.scrollTop = ksUI$1.clamp(scrollto, 0, Math.round(elem.scrollHeight - elem.offsetHeight)); //position * amount;
                } else {
                    elem.scrollTop -= position * amount;
                }

                elem.dispatchEvent(new Event('scroll'));
                if (progress < 0.9999) {
                    ksUI$1.scrollingDebounce = window.requestAnimationFrame(step);
                }
            };

            step();
        }

        static scrollingDebounce;

        static scrollToHorizontal(elem, position, duration = 600, absolute = false) {
            //console.trace("scrollToHorizontal");
            if (duration < 0) {
                elem.scrollLeft = position;
                elem.dispatchEvent(new Event('scroll'));
                return;
            }

            const startTime = performance.now();

            cancelAnimationFrame(ksUI$1.scrollingDebounce);

            const step = () => {
                const progress = ksUI$1.clamp((performance.now() - startTime) / duration, 0, 1);
                let amount = this.easeOutCubic(progress);

                if (absolute) {
                    elem.scrollLeft = (elem.scrollLeft - (elem.scrollLeft * amount)) + (position * amount);
                    //position * amount;
                } else {
                    elem.scrollLeft -= position * amount;
                }
                //console.log("scrollToHorizontal", position, elem.scrollLeft);
                elem.dispatchEvent(new Event('scroll'));
                if (progress < 0.9999) {
                    ksUI$1.scrollingDebounce = window.requestAnimationFrame(step);
                }
            };

            step();
        }

        // Easing function from https://gist.github.com/gre/1650294
        static easeOutCubic(t) {
            return --t * t * t + 1;
        }

        static removeNewLines(str) {
            const newLinesRegExp = new RegExp('^\s+|\s+$', 'g');
            return str.replace(newLinesRegExp, '').trim();
        }

        static requestResource(url) {
            const request = new XMLHttpRequest();
            const promise = new Promise(function (resolve, reject) {
                request.onload = (response) => {

                    //console.log("requestResource", url, request.status, request.responseURL);
                    if (request.status == 200) {
                        //return request.responseText;
                        const tempEl = document.createElement('div');
                        tempEl.innerHTML = request.responseText;
                        resolve({ data: request.responseText, url: url });
                    } else {
                        reject(response);
                    }
                };
                request.onerror = reject;
            });
            request.open('GET', url);
            request.send();
            return promise;
        }

        static cleanDecimals(num, decimals) {
            return Math.round(num * Math.pow(10, decimals)) / Math.pow(10, decimals);
        }

        static RGBToHex = (r, g, b) =>
            ((r << 16) + (g << 8) + b).toString(16).padStart(6, '0');

        static hexToRGB = (hex, asStr = false) => {
            let alpha = false,
                h = hex.slice(hex.startsWith('#') ? 1 : 0);
            if (h.length === 3) h = [...h].map(x => x + x).join('');
            else if (h.length === 8) alpha = true;
            h = parseInt(h, 16);
            return asStr ? (
                'rgb' +
                (alpha ? 'a' : '') +
                '(' +
                (h >>> (alpha ? 24 : 16)) +
                ', ' +
                ((h & (alpha ? 0x00ff0000 : 0x00ff00)) >>> (alpha ? 16 : 8)) +
                ', ' +
                ((h & (alpha ? 0x0000ff00 : 0x0000ff)) >>> (alpha ? 8 : 0)) +
                (alpha ? `, ${h & 0x000000ff}` : '') +
                ')'
            ) : [(h >>> (alpha ? 24 : 16)), ((h & (alpha ? 0x00ff0000 : 0x00ff00)) >>> (alpha ? 16 : 8)), ((h & (alpha ? 0x0000ff00 : 0x0000ff)) >>> (alpha ? 8 : 0))];
        }

        static RGBToHSB = (r, g, b, srgb) => {
            r /= 255;
            g /= 255;
            b /= 255;
            let v = Math.max(r, g, b),
                n = v - Math.min(r, g, b);
            const h =
                n === 0 ? 0 : n && v === r ? (g - b) / n : v === g ? 2 + (b - r) / n : 4 + (r - g) / n;

            if (srgb) {
                v = this.linearToSrgb(v);
            }

            return [60 * (h < 0 ? h + 6 : h), v && (n / v) * 100, v * 100];
        }

        static HSBToRGB = (h, s, b) => {
            s /= 100;
            b /= 100;
            const k = (n) => (n + h / 60) % 6;
            const f = (n) => b * (1 - s * Math.max(0, Math.min(k(n), 4 - k(n), 1)));
            return [255 * f(5), 255 * f(3), 255 * f(1)];
        }

        static hexToHSB = (hex, srgb = false) => {
            let rgb = this.hexToRGB(hex, false);
            return this.RGBToHSB(rgb[0], rgb[1], rgb[2], srgb);
        }

        static HSBToHex = (h, s, b) => {
            let rgb = this.HSBToRGB(h, s, b);
            return this.RGBToHex(Math.round(rgb[0]), Math.round(rgb[1]), Math.round(rgb[2]));
        }

        /** input: h in [0,360] and s,v in [0,1] - output: r,g,b in [0,1] */
        static HSV2RGB = (h, s, v) => {
            if (typeof h == 'object') {
                s = h[1];
                v = h[2];
                h = h[0];
            }
            let f = (n, k = (n + h / 60) % 6) => v - v * s * Math.max(Math.min(k, 4 - k, 1), 0);
            return [f(5), f(3), f(1)];
        }

        /** input: r,g,b in [0,1], out: h in [0,360) and s,v in [0,1] */
        static RGB2HSV = (r, g, b) => {
            if (typeof r == 'object') {
                g = r[1];
                b = r[2];
                r = r[0];
            }

            let v = Math.max(r, g, b), c = v - Math.min(r, g, b);
            let h = c && ((v == r) ? (g - b) / c : ((v == g) ? 2 + (b - r) / c : 4 + (r - g) / c));
            return [60 * (h < 0 ? h + 6 : h), v && c / v, v];
        }

        // in: r,g,b in [0,1], out: h in [0,360) and s,l in [0,1]
        static RGB2HSL = (r, g, b) => {
            if (typeof r == 'object') {
                g = r[1];
                b = r[2];
                r = r[0];
            }
            let v = Math.max(r, g, b), c = v - Math.min(r, g, b), f = (1 - Math.abs(v + v - c - 1));
            let h = c && ((v == r) ? (g - b) / c : ((v == g) ? 2 + (b - r) / c : 4 + (r - g) / c));
            return [60 * (h < 0 ? h + 6 : h), f ? c / f : 0, (v + v - c) / 2];
        }

        // input: h as an angle in [0,360] and s,l in [0,1] - output: r,g,b in [0,1]
        static HSL2RGB = (h, s, l) => {
            if (typeof h == 'object') {
                s = h[1];
                v = h[2];
                h = h[0];
            }
            let a = s * Math.min(l, 1 - l);
            let f = (n, k = (n + h / 30) % 12) => l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return [f(0), f(8), f(4)];
        }

        static returnToOrigin() {
            let origin = this.menuState.getOrigin();
            console.log("Returning to", origin);
            this.goTo(origin[0], origin[1], false);
        }

        static linearHexToSrgb(hex_color) {
            //let hsb = ksUI.hex(hex_color);
            let rgb = ksUI$1.hexToRGB(hex_color);
            //console.log("linearHexToSrgb", hex_color, "linear", rgb[0],rgb[1],rgb[2]);
            let srgb = ksUI$1.linearArrToSrgb(rgb);
            let output = ksUI$1.RGBToHex(Math.round(srgb[0] * 255), Math.round(srgb[1] * 255), Math.round(srgb[2] * 255));
            //console.log("linearHexToSrgb", hex_color, "srgb", Math.round(srgb[0] * 255), Math.round(srgb[1] * 255), Math.round(srgb[2] * 255), "/", output);        
            return output; // ksUI.RGBToHex(Math.round(srgb[0] * 255), Math.round(srgb[1] * 255), Math.round(srgb[2] * 255));
        }

        static srgbHexToLinear(hex_color) {
            let hsb = ksUI$1.hexToHSB(hex_color);
            return ksUI$1.HSBToHex(hsb[0], hsb[1], ksUI$1.srgbToLinear(hsb[2] / 100) * 100);
        }

        static srgbArrToLinear(srgbArr) {
            let sRGB = {
                r: srgbArr[0] / 255,
                g: srgbArr[1] / 255,
                b: srgbArr[2] / 255
            };

            let linear = {
                r: sRGB.r / 12.92,
                g: sRGB.g / 12.92,
                b: sRGB.b / 12.92
            };

            if (sRGB.r > 0.04045)
                linear.r = Math.pow((sRGB.r + 0.055) / 1.055, 2.4);
            if (sRGB.g > 0.04045)
                linear.g = Math.pow((sRGB.g + 0.055) / 1.055, 2.4);
            if (sRGB.b > 0.04045)
                linear.b = Math.pow((sRGB.b + 0.055) / 1.055, 2.4);

            return [Math.round(linear.r * 255), Math.round(linear.g * 255), Math.round(linear.b * 255)]
        }

        static srgbToLinear(x) {

            if (x <= 0)
                return 0;
            else if (x >= 1)
                return 1;
            else if (x < 0.04045)
                return x / 12.92;
            else
                return Math.pow((x + 0.055) / 1.055, 2.4);
        }

        static linearArrToSrgb(arr) {
            let out = [];
            //var log = lin <= 0.00313066844250063 ? lin * 12.92 : 1.055 * Math.pow(lin, 1 / 2.4) - 0.055;
            //return log;
            let linear = {
                r: arr[0] / 255,
                g: arr[1] / 255,
                b: arr[2] / 255
            };

            out[0] = linear.r * 12.92;
            out[1] = linear.g * 12.92;
            out[2] = linear.b * 12.92;

            if (linear.r > 0.0031308) {
                out[0] = Math.pow(linear.r, 0.41666666666666666) * 1.055 - 0.055;
            }

            if (linear.g > 0.0031308) {
                out[1] = Math.pow(linear.g, 0.41666666666666666) * 1.055 - 0.055;
            }

            if (linear.b > 0.0031308) {
                out[2] = Math.pow(linear.b, 0.41666666666666666) * 1.055 - 0.055;
            }

            return out;

        }

        static pad(num, size) {
            var s = num + "";
            while (s.length < size) s = "0" + s;
            return s;
        }

        static formatTimeLong(t) {
            //var negative = (t < 0);
            var h, m, s;//, ms;

            t = Math.abs(t);

            h = Math.floor(t / 3600000);
            s = Math.floor(t / 1000);
            m = Math.floor(s / 60);
            //if (m != 0 || hidemsec)
            //  s = this.pad(s % 60, 2);
            //if (h != 0 || hidemsec)
            //  m = this.pad(m % 60, 2);
            //ms = this.pad(t % 1000, 3);

            var output = [];

            if (h > 0) {
                let suffix = engine.translate(h > 1 ? "labelAbbrHours" : "labelAbbrHour");
                let str = [h, '<span class="suffix">', suffix, '</span>'].join("");
                output.push(str);
            }

            if (m > 0) {
                let suffix = engine.translate(h > 1 ? "labelAbbrMinute" : "labelAbbrMinutes");
                let str = [m, '<span class="suffix">', suffix, '</span>'].join("");
                output.push(str);
            }

            return output.join(" ");

        }

        static minutesToTime(minutes, asNumbers = false) {
            const m = minutes % 60;
            const h = Math.floor(minutes / 60);

            return asNumbers ? [h, m] : `${h}:${this.pad(m, 2)}`;
        }

        static formatTime(t, hidemsec = true, htmloutput = false, msec_count = 3, positiveprefix = "", msec_separator = ".", pad_all = false) {

            let separator = htmloutput ? "<span>:</span>" : ":";

            if (isNaN(t)) return "-";

            var negative = (t < 0);
            var h, m, s, ms;

            t = Math.abs(t);

            h = Math.floor(t / 3600000);
            s = Math.floor(t / 1000);
            m = Math.floor(s / 60);
            if (m != 0 || hidemsec || pad_all)
                s = this.pad(s % 60, 2);
            if (h != 0 || hidemsec || pad_all)
                m = this.pad(m % 60, 2);
            ms = this.pad(t % 1000, 3);

            ms = ms.substring(0, msec_count);

            var output = [];

            if (h) output.push(h);
            if ((m && m != "00") || hidemsec || (pad_all && m == "00")) {
                output.push(m);
            }
            output.push(s);

            if (!hidemsec) {
                output.push(ms);
            } else {
                return (negative ? "-" : positiveprefix) + output.join(separator);
            }

            return (negative ? "-" : positiveprefix) + output.join(separator).replace(/:([^:]*)$/, `${msec_separator}$1`);
        }

        static formatTimeExt(t, format = 1, htmloutput = false, msec_count = 3, positiveprefix = "", separator = ":", whenzero = null) {

            separator = htmloutput ? `<span>${separator}</span>` : separator;

            if (isNaN(t)) return "-";

            if (whenzero !== null && t == 0) {
                return whenzero;
            }

            var negative = (t < 0);
            var h, m, s, ms;

            t = Math.abs(t);

            h = Math.floor(t / 3600000);
            s = Math.floor(t / 1000);
            m = Math.floor(s / 60);
            if (m != 0 || format == 1)
                s = this.pad(s % 60, 2);
            if (h != 0 || format == 1)
                m = this.pad(m % 60, 2);
            ms = this.pad(t % 1000, 3);

            ms = ms.substring(0, msec_count);

            var output = [];

            if (h) output.push(h);

            if (format == 3) {
                m = this.pad(m, 2);
                s = this.pad(s, 2);
                output.push(m);
            } else {
                if ((m && m != "00") || format == 2) {
                    output.push(m);
                    s = this.pad(s, 2);
                }
            }

            output.push(s);

            if (format != 1 && msec_count > 0) {
                output.push(ms);
            } else {
                return (negative ? "-" : positiveprefix) + output.join(separator);
            }

            return (negative ? "-" : positiveprefix) + output.join(separator).replace(/:([^:]*)$/, '.$1');

        }


        static linearToSrgb(x) {

            if (x <= 0)
                return 0;
            else if (x >= 1)
                return 1;
            else if (x < 0.0031308)
                return x * 12.92;
            else
                return Math.pow(x, 0.416) * 1.055 - 0.055;
        }

        static storeObject(key, obj) {
            localStorage.setItem(key, JSON.stringify(obj));
        }

        static retrieveObject(key, delete_on_retrieval = false) {
            let output = JSON.parse(localStorage.getItem(key));
            if (delete_on_retrieval) localStorage.removeItem(key);
            return output;
        }

        static setOriginAsReturnPage() {
            this.setReturnPage(ksUI$1.menuState.getOrigin());
        }

        static setCurrentAsReturnPage() {
            this.setReturnPage(ksUI$1.menuState.getCurrentLocation());
        }

        static clearReturnPage() {
            localStorage.removeItem("returnPage");
        }

        static setReturnPage(origin_array) {
            localStorage.setItem("returnPage", JSON.stringify(origin_array));
        }

        static exitToReturnPageNoLoading(store_origin = true) {

            let returnPage = ["menu.html", "main/main"];
            if (localStorage.getItem("returnPage")) {
                returnPage = JSON.parse(localStorage.getItem("returnPage"));
            }
            console.log("exitToReturnPage", returnPage);
            ksUI$1.goTo(returnPage[0], returnPage[1], false, false, store_origin);
            localStorage.removeItem("returnPage");
        }

        static exitToReturnPage(sending_page) {

            let returnPage = ["menu.html", "main/main"];
            if (localStorage.getItem("returnPage")) {
                returnPage = JSON.parse(localStorage.getItem("returnPage"));
            }
            console.log("exitToReturnPage", returnPage);
            ksUI$1.showLoadingModal();
            //ksUI.goToLoadingPage(returnPage[0], returnPage[1], sending_page);
            localStorage.removeItem("returnPage");
        }

        static get isUIHidden() {
            return document.body.classList.contains("hide-ui");
        }

        static bodyTransitionHandler(ev) {

            if (ev.target == document.body) {
                location.href = "loading.html";
                console.warn(location.href);
            }

            document.body.removeEventListener("transitionend", ksUI$1.bodyTransitionHandler);
        }

        static getNumberOfOpponentsFromSession(session) {
            if (session.grid_type == eGameModeSelection.GridType.Automatic) {
                return session.num_opponents;
            } else {
                return session.opponents.length;
            }
        }

        static getDurationFromLoadingPageInfo(session) {
            if (session.duration_type == eGameModeSelection.RaceType.Time) {
                return `${session.duration / 60} ${session.duration > 60 ? engine.translate('lblMinutesLower') : engine.translate('lblMinuteLower')}`;
            } else {
                return `${session.duration}${session.duration > 1 ? engine.translate('lblLapsLower') : engine.translate('lblLapLower')}`;
            }

        }

        static getDurationFromSession(session) {
            if (session.duration_type == eGameModeSelection.RaceType.Time) {
                return `${session.duration / 60} ${session.duration > 60 ? engine.translate('lblMinutesLower') : engine.translate('lblMinuteLower')}`;
            } else {
                return `${session.duration} ${session.duration > 1 ? engine.translate('lblLapsLower') : engine.translate('lblLapLower')}`;
            }
        }

        static getTimeOfDayFromCarState(carstate) {
            return `${ksUI$1.pad(carstate.time_of_day_hours, 2)}:${ksUI$1.pad(carstate.time_of_day_minutes, 2)}`
        }

        static getTimeOfDayFromSession(session) {
            return `${session.time_of_day.hour}:${ksUI$1.pad(session.time_of_day.minute, 2)}`
        }

        static hideLoadingModal() {
            console.log("Hiding loading modal");
            const modal = q("ks-modaldialog");
            if (modal && modal.showedInUrl == location.pathname) {
                modal.onHide = () => { activePage?.setupNavigation(); };
                modal.clearContent();
                modal.Hide();
            } else if (modal) {
                console.warn("Loading modal hide attempt from", location.pathname, "while expected from", modal.showedInUrl);
            }
        }

        static showLoadingModal(destination) {

            /** @typedef {import('../components/modaldialog/modaldialog').default} ModalDialog */
            /** @type {ModalDialog} */
            const modal = q("ks-modaldialog");

            if (!modal) {
                console.error("No available ks-modaldialog present").
                    return;
            }

            if (document.body.classList.contains("ks-modaldialog-active") && modal.dataset.mode == "loadingScreen") {
                console.warn("Loading screen already visible.");
                return;
            }

            if (!destination)
                destination = localStorage.getItem("loadingDestination");

            const loadingsummary = document.createElement("ks-loadingsummary");



            if (destination) {
                loadingsummary.dataset.destination = destination;
            }

            console.log("showLoadingModal for", destination);

            modal.setContent(loadingsummary);

            modal.Show({
                title: "lblLoading",
                message: "",
                showTitle: false,
                showMessage: false,
                buttons: 0x000,
                opaque: true,
                logo: false,
                showContent: true,
                dataMode: "loadingScreen"
            });

            ksUI$1.clearFocus();
        }

        static goToLoadingPage(page, path, sending_page) {

            if (!sending_page && !window.AP()) {
                return;
            }

            if (!sending_page) {
                sending_page = window.AP();
            }

            // console.log("goToLoadingPage", page, path, sending_page?.tagName, sending_page?.id);

            sending_page.pageModal.Show({
                title: "lblLoading",
                message: "msgLoadingSession",
                buttons: 0x000,
                opaque: true,
                logo: true,
                showTitle: false,
                dataMode: "loadingScreen"
            });

        }

        static processLoadingPageMessage(message) {

        }

        static removeClasses(target, ...args) {
            args.forEach((classname) => {
                target.classList.remove(classname);
            });
        }

        static addClasses(target, ...args) {
            args.forEach((classname) => {
                // console.log("adding class", typeof args, classname);
                target.classList.add(classname);
            });
        }

        static goTo(page, path = "main/main", notransition = false, force_reload = false, store_origin = true, framedelay = 1) {
            console.log("Loading page", page, path, ("transition: "), !notransition);

            engine.trigger("onBeforeLeavePage");

            AP()?.storeLastFocused();

            if (!notransition) {
                document.body.classList.remove("transition");
            }

            this.menuState.toggleMouseHover(false);
            if (store_origin) {
                this.menuState.storeOrigin();
                this.menuState.save();
            }

            if ($$1 && !this.isInLoadingTransition()) {

                const modal = q("ks-modaldialog");
                if (modal && modal.Hide) {
                    q("ks-modaldialog")?.Hide();
                }
            }

            this.waitForFrames(() => {
                if (path) {

                    console.log("goTo", page, window.location.href, " // ", path, this.menuState.get().path, window.location.href.indexOf(page) == -1, (window.location.href.indexOf(page) != -1 && path != this.menuState.get().path));

                    this.changePage(path, notransition, false, (window.location.href.indexOf(page) != -1 && path != this.menuState.get().path));

                    if (window.location.href.indexOf(page) > -1 && !force_reload) {
                        return;
                    }
                }
                if (window.location.href.indexOf(page) > -1) {
                    window.location.reload(true);
                } else {
                    window.location.replace(page);
                }

            }, framedelay);
        }

        static getGameFaceComponents() {
            return components$1;
        }

        static goToMainMenu() {
            this.goTo("menu.html", "main/main");
        }

        static goToServerList() {
            this.goTo("multiplayer.html", "main/serverlist");
        }

        static getVisibleHeightInScroll(element) {
            const container = element.parentElement;
            let scrollTop = container.scrollTop;
            let scrollBot = scrollTop + container.clientHeight;
            let containerRect = container.getBoundingClientRect();
            let eleRect = element.getBoundingClientRect();
            let rect = {};
            rect.top = eleRect.top - containerRect.top,
                rect.right = eleRect.right - containerRect.right,
                rect.bottom = eleRect.bottom - containerRect.bottom,
                rect.left = eleRect.left - containerRect.left;
            let eleTop = rect.top + scrollTop;
            let eleBot = eleTop + element.offsetHeight;
            let visibleTop = eleTop < scrollTop ? scrollTop : eleTop;
            let visibleBot = eleBot > scrollBot ? scrollBot : eleBot;

            return visibleBot - visibleTop;
        }

        static svg = {
            multiplyMatrix: (([[a, b], [c, d]], [x, y]) => [a * x + b * y, c * x + d * y]),
            rotateMatrix: ((x) => {
                const cosx = Math.cos(x);
                const sinx = Math.sin(x);
                return [[cosx, -sinx], [sinx, cosx]];
            }),
            addVector: (([a1, a2], [b1, b2]) => [a1 + b1, a2 + b2]),
            getSvgEllipseArc: (([cx, cy], [rx, ry], [t1, dia], angle) => {
                dia = dia % (2 * Math.PI);
                const rotMatrix = ksUI$1.svg.rotateMatrix(angle);
                const [sX, sY] = (ksUI$1.svg.addVector(ksUI$1.svg.multiplyMatrix(rotMatrix, [rx * Math.cos(t1), ry * Math.sin(t1)]), [cx, cy]));
                const [eX, eY] = (ksUI$1.svg.addVector(ksUI$1.svg.multiplyMatrix(rotMatrix, [rx * Math.cos(t1 + dia), ry * Math.sin(t1 + dia)]), [cx, cy]));
                const fA = ((dia > Math.PI) ? 1 : 0);
                const fS = ((dia > 0) ? 1 : 0);
                return [" M ", sX, " ", sY, " A ", rx, ry, angle / Math.PI * 180, fA, fS, eX, eY];
            }),
            Donut: (cx, cy, radius, data, start_offset = 0) => {

                function arcradius(cx, cy, radius, degrees) {
                    var radians = (degrees - 90) * Math.PI / 180.0;
                    return { x: cx + (radius * Math.cos(radians)), y: cy + (radius * Math.sin(radians)) };
                }

                var total = 0;
                var arr = [];
                var beg = 0 + start_offset;
                var end = 0;

                for (var j = 0; j < data.length; j++) {
                    total += data[j].value;
                }

                console.log("total", total);

                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    var tmp = {};

                    var p = (((item.value) / total) * 100);

                    // if (i === arr.length - 1 && count < 100)
                    //     p = p + (100 - count);

                    console.log("p", p);

                    end = beg + ((360 / 100) * p);
                    tmp.index = i;
                    tmp.value = item.value;
                    tmp.data = item;

                    var b = arcradius(cx, cy, radius, end);
                    var e = arcradius(cx, cy, radius, beg);
                    var la = (end - beg) <= 180 ? 0 : 1;

                    tmp.d = ['M', b.x, b.y, 'A', radius, radius, 0, la, 0, e.x, e.y].join(' ');
                    arr.push(tmp);
                    beg = end;
                }

                return arr;
            }


        }

        static getKeyFromKeyCode(keycode) {
            let key = "";

            const map = {
                8: "keyBackspace",
                13: "keyEnter",
                16: "keyShift",
                17: "keyControl",
                18: "keyAlt",
                27: "keyEscape",
                32: "keySpace",
                33: "keyPageUp",
                34: "keyPageDown",
                37: "keyLeftArrow",
                38: "keyUpArrow",
                39: "keyRightArrow",
                40: "keyDownArrow",

                91: "keyOSKey",
                93: "keyContextMenu",
                95: "keySleep",

                96: "keyNumPad0",
                97: "keyNumPad1",
                98: "keyNumPad2",
                99: "keyNumPad3",
                100: "keyNumPad4",
                101: "keyNumPad5",
                102: "keyNumPad6",
                103: "keyNumPad7",
                104: "keyNumPad8",
                105: "keyNumPad9",

                106: "keyMultiply",
                107: "keyAdd",
                108: "keySeparator",
                109: "keySubtract",
                110: "keyDecimal",
                111: "keyDivide",

                112: "keyF1",
                113: "keyF2",
                114: "keyF3",
                115: "keyF4",
                116: "keyF5",
                117: "keyF6",
                118: "keyF7",
                119: "keyF8",
                120: "keyF9",
                121: "keyF10",
                122: "keyF11",
                123: "keyF12",

                144: "keyNumLock",
                145: "keyScrollLock",

                186: "keySemiColon",
                187: "keyEqual",
                189: "keyMinus",
                188: "keyComma",
                190: "keyPeriod",
                191: "keySlash",
                219: "keyLeftBracket",
                220: "keyBackslash",
                221: "keyRightBracket",
                222: "keyQuote",

            };

            const mappedvalue = map[keycode];

            key = mappedvalue ? engine.translate(mappedvalue) : String.fromCharCode((96 <= keycode && keycode <= 105) ? keycode - 48 : keycode);

            return { text: key, mappedvalue: mappedvalue };
        }

        static getFirstNavigable(target, navigable_class = ".focusable") {

            var result;

            qAllArray(navigable_class, target).every(elem => {

                let elemStyle = window.getComputedStyle(elem);

                if ((elem.offsetWidth <= 0 && elem.offsetHeight <= 0) || elem.classList.contains("disabled") ||
                    elem.hasAttribute('disabled') || elem.hasAttribute('readonly') || elem.closest(".disabled") || elem.closest("[disabled]") || elem.closest("[readonly]")
                    || elemStyle.display == "none" || elemStyle.content == "'disabled'"
                ) {
                    //console.log("invalid",elem.tagName, elem.id, elem.className);    
                    return true;
                }

                result = elem;
                return false;
            });

            //console.log(">> valid", result.tagName, result.id, result.className);
            return result;
        }

        static getRadialWipePath(cx, cy, r, start_angle, end_angle) {

            const RAD = Math.PI / 180;
            const PI_2 = Math.PI / 2;

            var delta = end_angle - start_angle;

            if (delta === 360) {

                return "M " + (cx - r) + " " + cy + " a " + r + " " + r + " 0 1 0 " + r * 2 + " 0 a " + r + " " + r + " 0 1 0 " + -r * 2 + " 0z";
            }

            var largeArc = delta > 180 ? 1 : 0;

            start_angle = start_angle * RAD - PI_2;
            end_angle = end_angle * RAD - PI_2;

            var x1 = cx + r * Math.cos(end_angle);
            var y1 = cy + r * Math.sin(end_angle);

            var x2 = cx + r * Math.cos(start_angle);
            var y2 = cy + r * Math.sin(start_angle);

            return "M " + x1 + " " + y1 + " A " + r + " " + r + " 0 " + largeArc + " 0 " + x2 + " " + y2 + " L " + cx + " " + cy + "z";
        }


        static getColorForPercentage(pct, lookup_table) {

            pct = ksUI$1.clamp(pct, 0, 1);

            if (!lookup_table) {
                lookup_table = [
                    // 12, 184, 238
                    { pct: 0.0, color: { r: 12, g: 184, b: 238 } },
                    { pct: 0.5, color: { r: 0, g: 207, b: 28 } },
                    { pct: 0.75, color: { r: 255, g: 255, b: 0 } },
                    { pct: 1.0, color: { r: 255, g: 0, b: 0 } }];
            }

            for (var i = 1; i < lookup_table.length - 1; i++) {
                if (pct < lookup_table[i].pct) {
                    break;
                }
            }
            var lower = lookup_table[i - 1];
            var upper = lookup_table[i];
            var range = upper.pct - lower.pct;
            var rangePct = (pct - lower.pct) / range;
            var pctLower = 1 - rangePct;
            var pctUpper = rangePct;
            var color = {
                r: Math.floor(lower.color.r * pctLower + upper.color.r * pctUpper),
                g: Math.floor(lower.color.g * pctLower + upper.color.g * pctUpper),
                b: Math.floor(lower.color.b * pctLower + upper.color.b * pctUpper)
            };
            return 'rgb(' + [color.r, color.g, color.b].join(',') + ')';
        }

        static getLogoForBrand(brand) {
            const id = brand.toLowerCase().replace(/[ -]+/g, "_");
            return `/branding/oem/${id}/logo.texture`;
        }

        static getOrdinalNumber(value) {

            if (window.Language == "en") {

                let suffix = "";

                if (value > 3 && value < 21) suffix = "th";
                if (suffix == "")
                    switch (value % 10) {
                        case 1:
                            suffix = "st";
                            break;
                        case 2:
                            suffix = "nd";
                            break;
                        case 3:
                            suffix = "rd";
                            break;
                        default:
                            suffix = "th";
                    }

                return `${value}${suffix}`;
            }

            return value;
        }

        static appendSuffix(value, suffix, wrap_in_tag = false, suffix_css_class = "", is_suffix_localized = false) {
            const string = is_suffix_localized ? engine.translate(suffix) : suffix;
            return String(value) + (wrap_in_tag ? `<div class='${suffix_css_class}'>${string}</div>` : string);
        }

        static loadHtml(url) {
            console.trace("ksUI.loadHtml", url);
            const request = new XMLHttpRequest();
            const promise = new Promise(function (resolve, reject) {
                request.onload = (response) => {
                    if (request.status == 200) {
                        const tempEl = document.createElement("template");
                        tempEl.innerHTML = request.responseText;
                        resolve({ template: tempEl, url: url });
                    } else {
                        reject(response);
                    }
                };
                request.onerror = reject;
            });
            request.open('GET', url);
            request.send();
            return promise;
        }

        static getLocId(value, prefix = "") {
            return [prefix, value.toLowerCase().replace(/[ -]+/g, "_").trim()].join("_");
        }

        static isSet(input_value, comparison_value) {
            return (input_value & comparison_value) > 0;
        }



        static getTrackId(track_item) {
            return [track_item.name.trim().replace("-", "_"), track_item.layout.trim()].join("-").replaceAll(" ", "_").toLowerCase();
        }

        static getTrackTexturePath(track_item) {
            return `/images/tracks/${this.getTrackId(track_item)}.texture`;
        }

        static getTrackMapSvgPath(track_item) {
            return `/images/trackmaps/${this.getTrackId(track_item)}.svg`;
        }



        static getManufacturerId(manufacturer_or_carmodel) {
            const target = manufacturer_or_carmodel.__Type == "CarModel" ? manufacturer_or_carmodel.manufacturer.name : manufacturer_or_carmodel.name;
            return target.toLowerCase().replace(" ", "_").replace("-", "_");
        }

        static getBrandBadgeTexturePath(manufacturer_or_carmodel) {
            return `/branding/oem/${this.getManufacturerId(manufacturer_or_carmodel)}/badge.texture`;
        }

        static getBrandLogoTexturePath(manufacturer_or_carmodel) {
            return `/branding/oem/${this.getManufacturerId(manufacturer_or_carmodel)}/logo.texture`;
        }

        static getManufacturerLocId(manufacturer) {
            return ksUI$1.getLocId(manufacturer.name, 'brand');
        }

        static getManufacturerLocName(manufacturer) {
            return engine.translate(this.getManufacturerLocId(manufacturer));
        }

        static getModelWithoutBrand(car_model) {
            return car_model.display_name.replace(car_model.manufacturer.name, "").trim();
        }

        static getPxFromRem(rem) {
            return parseFloat(rem) * window.FontSize;
        }

        static getTextForZeroValue(numeric_value, text) {
            if (numeric_value == 0) return text;
            return numeric_value;
        }

        static hasSessionFlag(flag) {
            if (!window["ModelUISessionState"]) {
                console.warn("ksUI.hasSessionFlag called with no UISessionState defined");
                return false;
            }

            return ksUI$1.isSet(ModelUISessionState.end_session_flag, flag);
        }

        static concat(divider, ...options) {
            return options.join(divider);
        }

        static checkVisible(elm) {
            var rect = elm.getBoundingClientRect();
            var viewHeight = Math.max(document.documentElement.clientHeight, window.innerHeight);
            var viewWidth = Math.max(document.documentElement.clientWidth, window.innerWidth);

            return !(rect.bottom < 0 || rect.top - viewHeight >= 0) && !(rect.left < -300 || rect.left - viewWidth >= 0);
        }

        static getNextPreviousInArray(value, target_array, previous) {
            if (previous) {
                let i = 0;
                while (value - target_array[i] > 0 && i < target_array.length) {
                    i++;
                }
                return i == 0 ? target_array[i] : target_array[--i];
            } else {
                let i = 0;
                while (value - target_array[i] >= 0 && i < target_array.length - 1) {
                    i++;
                }
                return target_array[i];
            }
        }

        static getClosestInArray(value, target_array) {
            return target_array.reduce((a, b) => {
                return Math.abs(b - value) < Math.abs(a - value) ? b : a;
            });
        }

        static arePguidEqual(pguid1, pguid2) {
            return pguid1 && pguid2 && pguid1.a == pguid2.a && pguid1.b == pguid2.b;
        }

        static stringify(source_object) {
            return JSON.stringify(source_object, (key, value) =>
                typeof value === "bigint" ? value.toString() + "n" : value
            );
        }

    }

    window.BTNEVENTS = "click sn:enter-down";
    window.ksUI = ksUI$1;
    window["$"] = $$1;

    class MessageHandler extends Object {

        messagePrefix;
        templateLoaded = false;
        onNavCancelBound;

        queue = {};

        constructor(namespace) {
            super();
            this.messagePrefix = namespace;
        }



        queuePosition(eventname) {
            if (this.queue[eventname]) {
                return this.queue[eventname];
            } else return 0;
        }

        enqueue(eventname) {
            if (!this.queue[eventname]) {
                this.queue[eventname] = 1;
            } else {
                //console.log(this.messagePrefix, "Queuing", eventname, this.queue[eventname]);
                this.queue[eventname] += 1;
            }
        }

        pop(eventname) {
            if (this.queue[eventname]) {
                this.queue[eventname] -= 1;
                if (this.queue[eventname] == 0) {
                    delete this.queue[eventname];
                    // console.log(this.messagePrefix, "Popped", eventname);
                }

            }
        }

        onResponse(name, callback, handle_once = true) {
            let request_string = this.messagePrefix + "Request" + name;
            let eventname = this.messagePrefix + "Response" + name;
            let handler = engine.on(eventname, (response) => {
                callback(response);
                if (handle_once) handler.clear();
                this.pop(request_string);
            }, this);
            return handler;
        }

        request(name, ...args) {

            let response_handler;

            let request_string = this.messagePrefix + "Request" + name;

            if (this.queuePosition[request_string]) {
                console.log(request_string, "queue", this.queuePosition[request_string]);
            }
            if (typeof args[0] == "function") {
                response_handler = this.onResponse(name, args[0]);
                ksUI$1.triggerUICommand(request_string);
            }
            else {
                response_handler = this.onResponse(name, args[1]);
                ksUI$1.triggerUICommand(request_string, args[0]);
            }
            this.enqueue(request_string);

            return response_handler;
        }

        requestNoResponse(name, ...args) {
            let request_string = this.messagePrefix + "Request" + name;
            if (typeof args[0] == "function") {
                //this.onResponse(name, args[0]);
                ksUI$1.triggerUICommand(request_string);
            }
            else {
                //this.onResponse(name, args[1]);
                ksUI$1.triggerUICommand(request_string, args[0]);
            }
        }

        clearResponseHandler(name) {
            let eventname = this.messagePrefix + "Response" + name;
            console.log("Clearing", eventname);
            engine.off(eventname);
        }

        clearResponseHandlerQueue() {
            const pending_events = Object.keys(this.queue);
            if (pending_events.length == 0) return;

            console.log("clearResponseHandlerQueue", this.messagePrefix, pending_events.length);
            pending_events.forEach(eventname => {
                engine.off(eventname);
            });
        }
    }

    class KsHTMLElement extends HTMLElement {

        #debug;

        static observedAttributes = ["data-bind-if"];

        static getObservedAttributes() {
            return KsHTMLElement.observedAttributes;
        }

        persistModels = false;

        isInFragment = false;
        componentBodyFragment = new DocumentFragment();
        componentBody;

        _onFocusBound;
        _onBlurBound;

        _bindFiltersToThis = false;
        _uniqueid;
        _isnavigable = false;
        _clearnavbeforesetup = false;

        /** 
         * ONLY USE IN PAGES - never in HUD 
         * @type {boolean}
         */
        _exposeAsActivePage = false;

        _navConfig = {
            selector: '.focusable',
            enterTo: 'last-focused',
            defaultElement: '.defaultfocus',
            rememberSource: true

        };
        _bindScrollableEvents = false;

        rootPage;
        template;
        delayedInit = false;

        /** 
        * ONLY USE IN PAGES - never in HUD 
        * @type {boolean}
        */
        shouldRenderControlHints = false;

        messagePrefix = "";

        /** @typedef {import('../modaldialog/modaldialog').default} ModalDialog */
        /** @type {ModalDialog} */
        pageModal;
        hastooltip = false;
        assignedModels = [];
        messageNamespaces = [];
        logicalParent;

        defaultAudioEvent = eAudioEvents.None;

        get documentBody() {
            return document.body;
        };

        lastResponse;

        get isRootPage() {
            return this.hasAttribute("rootpage");
        }

        get disableTooltip() {
            return this.hasAttribute("disable-tooltip");
        }

        set disableTooltip(value) {
            if (value) {
                this.setAttribute("disable-tooltip", value);
            }
            else {
                this.removeAttribute("disable-tooltip");
            }
        }


        disableCameraControl = false;

        _preventRender = false;

        constructor() {
            super();
            this._uniqueid = ksUI$1.getGuid();
        }

        get audioEvent() {
            const audioevent = this.dataset.audio;
            if (!audioevent) {
                return this.defaultAudioEvent;
            }
            return audioevent;
        }

        _lazyLoad = false;

        set lazyLoad(value) {
            this._lazyLoad = value;
        }

        get lazyLoad() {
            return this._lazyLoad;
        }

        moveBodyToFragment() {
            if (!this.componentBody) {
                console.log(this.tagName, "no content");
                if (this.delayedInit) {
                    $.waitForFrames(() => {
                        this.moveBodyToFragment();
                    }, this.delayFramesInit + 1);
                }
                return;
            }
            this.componentBodyFragment.appendChild(this.componentBody);
            this.isInFragment = true;
            this.dataset.fragment = true;
            this.onMoveToBodyFragment();
        }

        onMoveToBodyFragment() {

        }

        restoreBodyFromFragment() {
            if (!this.componentBody) {

                return;
            }
            this.appendChild(this.componentBody);
            $.waitForFrames(() => {
                this.isInFragment = false;
                this.dataset.fragment = false;
                
            }, 1);
            this.onRestoreFromFragment();
        }

        onRestoreFromFragment() {

        }

        hasScrollableContainers() {

            return $.q(".scrollable-horizontal", this) != null
                || $.q(".scrollable-vertical", this) != null;
        }

        getMessageHandler(namespace) {
            return new MessageHandler(namespace);
        }

        activate() {
            this.dataset.active = true;
            this.onActivate();
        }

        deactivate() {
            console.log("Deactivate");
            this.dataset.active = false;
            this.onDeactivate();
        }

        getStyle() {
            return window.getComputedStyle(this);
        }

        onResponse(name, callback, handle_once = true) {
            let eventname = this.messagePrefix + "Response" + name;
            let handler = engine.on(eventname, (response) => {
                callback(response);
                this.lastResponse = response;
                if (handle_once) handler.clear();
            }, this);
            return handler;
        }

        request(name, ...args) {
            let request_string = this.messagePrefix + "Request" + name;
            console.warn(request_string);
            let response_handler;

            if (typeof args[0] == "function") {
                response_handler = this.onResponse(name, args[0]);
                ksUI$1.triggerUICommand(request_string);
            }
            else {
                response_handler = this.onResponse(name, args[1]);
                ksUI$1.triggerUICommand(request_string, args[0]);
            }
            return response_handler;
        }

        requestNoResponse(name, ...args) {
            let request_string = this.messagePrefix + "Request" + name;
            if (typeof args[0] == "function") {
                //this.onResponse(name, args[0]);
                ksUI$1.triggerUICommand(request_string);
            }
            else {
                //this.onResponse(name, args[1]);
                ksUI$1.triggerUICommand(request_string, args[0], args[1]);
            }
        }

        clearResponseHandler(name) {
            let eventname = this.messagePrefix + "Response" + name;
            console.log("Clearing", eventname);
            engine.off(eventname);
        }

        renderControlHints() {

            this.onBeforeRenderControlHints();

            let c = $.qAll("component-slot[data-name=controls] > *", this);

            if (c.length == 0) {
                c = $.qAll("div[slot=controls] > *", this);
            }

            if (c.length > 0) {
                if (this.mainControlhints()) {
                    this.mainControlhints().reset();
                    c.forEach((a) => {

                        this.mainControlhints().addControl(a);
                    });
                }
            }

            $.waitForFrames(() => {
                try {
                    this.onAfterRenderControlHints(this.mainControlhints().controlslot);
                    this.mainControlhints().classList.add("controlhints-rendered");
                } catch (error) {
                    console.error("onAfterRenderControlHints called on element without valid controlslot", this.tagName);
                }
            }, 1);


        }

        initNumberFromAttr(attribute_name) {
            if (this.hasAttribute(attribute_name))
                this[attribute_name] = Number(this.getAttribute(attribute_name));
        }

        onBeforeRenderControlHints() {

        }

        onAfterRenderControlHints(controlhints) {

        }

        mapElementById(id, parent = this) {
            this[id] = $.q("#" + id, parent);
        }

        mapElementByClass(class_name, parent = this, silentfail = false) {
            const selector = "." + class_name;
            var elem = $.q(selector, parent);
            this[class_name] = elem;
            if (!elem && !silentfail) {
                console.warn(parent.tagName, "could not map", selector);
            }
        }

        resetControlHints() {
            if (this.mainControlhints())
                this.mainControlhints().reset();
        }

        /** @type {ControlHints} */
        mainControlhints() {
            return $.q("ks-controlhints");
        }

        rootModal() {
            return $.q("ks-modaldialog");
        }

        onActivate() {
        }

        onDeactivate() {
        }

        attributeChangedCallback(name, oldValue, newValue) {
            if (name == "data-bind-if" && !oldValue) {
                this.dataset._dataBindIf = newValue.replaceAll("{{", "").replaceAll("}}", "");
            }
        }


        onAttributeChange(records) {
        }

        onBindingUpdate(binding_param, value, init = false) {

        }

        _handleMouseOver(ev) {
            if (!this.classList.contains("focusable")) return;
            if (ev.target == ev.currentTarget) {
                this.focus();
            }
        }

        bindFocusHandling() {

            if (this.isPage()) return;

            this.addEventListener("mouseover", this._handleMouseOver.bind(this));

        }

        bindControls() {
        }

        isPage() {
            return this.tagName.toLowerCase().indexOf("-page-") > -1;
        }

        afterTransitionDebounce = { id: 0 };

        restoreLastFocused() {
            if (ksUI$1.isSpatialNav()) {
                const lastselect = localStorage.getItem("lastselected-" + this.tagName);
                if (lastselect && lastselect != "") {
                    if (document.activeElement == document.body) {
                        const elem = $.q("#" + lastselect);
                        if (elem) {
                            if (getComputedStyle(elem).content.indexOf("disabled") == -1)
                                elem.focus();
                            else {
                                $.q(".defaultfocus", this).focus();
                            }
                        } else {
                            console.warn("cannot focus", "lastselected-" + this.tagName, lastselect);
                        }

                    }
                } else {
                    const prevSelected = $.q(".focusable.selected", this);
                    if (prevSelected && prevSelected.offsetParent) {
                        console.warn("focusing on first selected");
                        SpatialNavigation$1.focus(prevSelected);
                        //prevSelected.focus();
                    } else {
                        $.q(".focusable")?.focus();
                    }

                }
            }
        }

        onRenderedOnce() {

        }

        scrollableContainers = [];
        scrollableObservers = [];

        scrollDebounce;

        wheelScrollContainer(e, is_horizontal = false) {
            const is_slider = e.target.closest("ks-slider");

            if ((is_slider || e.target.tagName == "gameface-rangeslider") && !(is_slider.hasAttribute("no-scroll") || is_slider != document.activeElement)) return;

            const cssclass = is_horizontal ? "scrollable-horizontal" : "scrollable-vertical";

            const scrollerparent =
                e.target.classList.contains(cssclass) ?
                    e.target : e.target.closest(`.${cssclass}`);

            const scroller = $.q(".scrollable-content", scrollerparent);
            if (!scroller) return;

            if (is_horizontal) {
                if (e.deltaY > 0 && scroller.scrollLeft == 0) return;
                if (e.deltaY < 0 && scroller.scrollWidth <= scroller.scrollLeft + scroller.offsetWidth) return;
                if (scroller.scrollWidth == scroller.offsetWidth) return;
            } else {
                if (e.deltaY > 0 && scroller.scrollTop == 0) return;
                if (e.deltaY < 0 && scroller.scrollHeight <= scroller.scrollTop + scroller.offsetHeight) return;
                if (scroller.scrollHeight == scroller.offsetHeight) return;
            }

            const hastarget = $.q(".scrollable-target", scroller);

            const peritem = hastarget ? hastarget.classList.contains("per-item-scroll") : scroller.classList.contains("per-item-scroll");
            const quickperitem = hastarget ? hastarget.classList.contains("per-item-scroll-quick") : scroller.classList.contains("per-item-scroll-quick");

            if (scroller.lastdirection == undefined) {
                scroller.lastdirection = e.deltaY > 0;
            }

            let amount = ksUI$1.clamp(e.deltaY, -100, 100);
            let timediff;

            if (scroller.lastscrolled != undefined) {
                timediff = Date.now() - scroller.lastscrolled;
            }

            if (scroller.lastdirection != e.deltaY > 0) {
                scroller.multiplier = 1;
            }

            if (scroller.multiplier == undefined) {
                scroller.multiplier = 1;
            } else if (scroller.multiplier > 30) scroller.multiplier = 30;

            if (timediff <= (peritem ? 550 : 500)) {
                scroller.multiplier += (peritem ? 1 : 2);
                amount = amount * scroller.multiplier;
            } else {
                scroller.multiplier = 1;
            }

            if (peritem) {

                let child = hastarget ? hastarget.children[0] : scroller.children[0];

                if (child.classList.contains("list-scroller")) {
                    child = hastarget ? hastarget.children[1] : scroller.children[1];
                }

                if (!child) return;


                const child_rect = child.getBoundingClientRect();
                const child_style = getComputedStyle(child);

                const child_margin_top = parseFloat(is_horizontal ? child_style.marginLeft : child_style.marginTop);
                const child_margin_bottom = parseFloat(is_horizontal ? child_style.marginRight : child_style.marginBottom);

                let child_margins = 0;

                let movement = e.deltaY > 0 ? -1 : 1;

                if (!isNaN(child_margin_top))
                    child_margins += ksUI$1.getPxFromRem(child_margin_top);

                if (!isNaN(child_margin_bottom))
                    child_margins += ksUI$1.getPxFromRem(child_margin_bottom);

                scroller.classList.add("is-scrolling");

                if (is_horizontal) {
                    ksUI$1.scrollToHorizontal(scroller, ksUI$1.roundTo(scroller.scrollLeft + (movement * (child_rect.width + child_margins)), child_rect.width + child_margins), ksUI$1.clamp(3000 / scroller.multiplier, 1000, 3000), true);
                }
                else {
                    ksUI$1.scrollToVertical(scroller, ksUI$1.roundTo(scroller.scrollTop + (movement * (child_rect.height + child_margins)), child_rect.height + child_margins), ksUI$1.clamp((quickperitem ? 150 : 250) / scroller.multiplier, 150, 1000), true);
                }

                scroller.lastscrolled = Date.now();
                scroller.lastdirection = e.deltaY > 0;

                clearTimeout(this.scrollDebounce);

                this.scrollDebounce = setTimeout(() => {
                    scroller.classList.remove("is-scrolling");
                }, quickperitem ? 750 : 300);

                return;
            }

            scroller.classList.add("is-scrolling");

            if (is_horizontal) {
                ksUI$1.scrollToHorizontal(scroller, amount * 10, 250);
            } else {
                ksUI$1.scrollToVertical(scroller, amount * 10, 250);
            }

            scroller.lastscrolled = Date.now();
            scroller.lastdirection = e.deltaY > 0;

            scrollerparent.classList.add("content-scrolling");

            setTimeout(() => {
                scroller.classList.remove("is-scrolling");
                scrollerparent.classList.remove("content-scrolling");
            }, 125);
        }

        delayUpdateScrollbars() {
            $.waitForFrames(() => {
                this.updateAllScrollBars();
            });
        }

        updateAllScrollBars() {
            this.scrollableContainers.forEach(scrollable => this.updateScrollBar(scrollable));
        }

        updateScrollBar(target) {
            /** @type {HTMLDivElement} */
            const is_horizontal = target.isHorizontal;
            const thumb = $.q(".thumb", target.scrollbar);
            const content = target.content;
            const scrollbar = target.scrollbar;

            const shouldscroll = is_horizontal ?
                Math.round(target.offsetWidth) < Math.round(content.scrollWidth) && Math.abs(target.offsetWidth - content.scrollWidth) > 1
                :
                Math.round(target.offsetHeight) < Math.round(content.scrollHeight) && Math.abs(target.offsetHeight - content.scrollHeight) > 1;

            content.classList.toggle("no-scroll", !shouldscroll);

            if (!shouldscroll) {
                scrollbar.setAttribute("disabled", "disabled");
                if (is_horizontal) {
                    thumb.style.widthPX = 100;
                } else {
                    thumb.style.heightPX = 100;
                }
                return;
            }

            scrollbar.removeAttribute("disabled");

            scrollbar.init = true;

            const ratio = is_horizontal ?
                content.offsetWidth / content.scrollWidth :
                content.offsetHeight / content.scrollHeight;

            let percentagescrolled = ksUI$1.clamp(is_horizontal ?
                (content.scrollLeft) / content.scrollWidth :
                content.scrollTop / content.scrollHeight, 0, 1);

            if (percentagescrolled + ratio > 1) {
                percentagescrolled = 1 - ratio;
            }

            if (is_horizontal) {
                const thumbproportional = target.offsetWidth * ratio;
                const thumbsize = ksUI$1.clamp(thumbproportional, 2 * window["FontSize"], 65535);

                thumb.style.widthPX = thumbsize;

                const max = scrollbar.offsetWidth;
                const move = percentagescrolled * max;
                thumb.style.leftPX = move;

            } else {
                const thumbproportional = scrollbar.offsetHeight * ratio;
                const thumbsize = ksUI$1.clamp(thumbproportional, 2 * window["FontSize"], 65535);

                thumb.style.heightPX = thumbsize;

                const max = scrollbar.offsetHeight - Math.abs(thumbsize - thumbproportional);
                if (content.offsetHeight - thumbsize <= content.offsetHeight + content.scrollTop) {
                    thumb.style.topPX = percentagescrolled * max;
                }
            }

        }

        scrollableContainerUpdated(target) {
            if (this.scrollableContainers.indexOf(target)) {
                console.warn("known scrollable");
            }
        }

        initTabHandler(target_container) {
            this.handlePageUpDown = this.handlePageUpDown.bind(this);
            window.addEventListener(EngineEvents.UI.InputAction, this.handlePageUpDown);
        }

        handlePageUpDown(evt) {

            function processHotkey(is_next) {

                const focused = $.q("ks-btnbasic:focus", this);
                $.q("ks-btnbasic.selected", this);

                SpatialNavigation$1.move(is_next ? "right" : "left");

                if (!focused) {
                    $.q("ks-btnbasic.selected", this).focus();
                    SpatialNavigation$1.move(is_next ? "right" : "left");
                    const currently_focused = $.q("ks-btnbasic:focus", this);
                    if (currently_focused)
                        currently_focused.toggle(true, true);
                } else {
                    $.q("ks-btnbasic:focus", this).toggle(true, true);
                }
            }

            const ph = processHotkey.bind(this);

            switch (evt.detail) {

                case "pageup":
                    ph(true);
                    break;

                case "pagedown":
                    ph(false);
                    break;
            }

        }

        scrollableMutationDebounce = { id: 0 };
        scrollableFocusDebounce = { id: 0 };

        visibilityChecker;
        lastVisibilityCheck = 0;

        lastVisibilityCheckFrameId = 0;

        isOnScreen() {
            return ksUI$1.checkVisible(this);
        }

        checkOnScreenLoop(time) {

            const delta = time - this.lastVisibilityCheck;
            const shouldUpdate = (delta >= 125) && this.lastVisibilityCheck != 0;

            if (shouldUpdate) {
                if (this.isOnScreen()) {
                    if (this.componentBodyFragment.children.length > 0 || this.dataset.fragment === "true") {
                        this.restoreBodyFromFragment();
                    }
                } else {
                    if (this.componentBodyFragment.children.length == 0) {
                        this.moveBodyToFragment();
                    }
                }
                this.lastVisibilityCheck = time;
            }

            if (this.lastVisibilityCheck == 0) {
                this.lastVisibilityCheck = time;
            }

            this.lastVisibilityCheckFrameId = requestAnimationFrame(this.visibilityChecker);
        }

        onTemplateLoaded() {

            this.componentBody = this.children[0];// $.q(".component-body", this);

            this.lazyLoad = this.hasAttribute("lazyload");

            if (this.lazyLoad) {
                this.visibilityChecker = this.checkOnScreenLoop.bind(this);
                this.lastVisibilityCheckFrameId = requestAnimationFrame(this.visibilityChecker);
            }

            if (this.isRootPage) {
                console.log("rootpage", this.constructor.name);
            }

            if (this.isPage() && !this.isRootPage) {
                $.waitForFrames(() => this.restoreLastFocused(), 10);
            }

            if (this.isPage() && this.hasAttribute("opaque")) {

                ksUI$1.menuState.toggleMouseHover(true);
                $.waitForFrames(() =>
                    ksUI$1.menuState.ignoreInputActions(true), 6);



                if (!this.documentBody.classList.contains("opaque")) {
                    this.documentBody.classList.add("opaque");

                }
                if (this.isRootPage) {
                    this.documentBody.classList.add("root-opaque");
                }
            } else if (this.isPage() && !this.hasAttribute("opaque") && !this.isRootPage) {

                $.waitForFrames(() => {
                    console.log("remove opaque", this.tagName);
                    ksUI$1.menuState.ignoreInputActions(false);
                    document.body.classList.remove("opaque");
                    if (this.isRootPage) {
                        document.body.classList.remove("opaque");
                    }
                }, 3);
            } else if (this.isRootPage && !this.hasAttribute("opaque")) {
                document.body.classList.remove("opaque");
            }

            if (this.isPage() && !this.hasAttribute("opaque")) {
                ksUI$1.menuState.ignoreInputActions(false); //, 6);
            }

            if (this.templateLoaded) console.warn(this.tagName, "already loaded!");

            if (this.classList.contains("renderControlHints") || this.shouldRenderControlHints) {
                this.renderControlHints();
            }

            this.pageModal = this.rootModal();

            if (this.disableCameraControl) {
                $.waitForFrames(() => {
                    console.log("disableCameraControl", this.tagName);
                    ksUI$1.menuState?.toggleMouseHover(true);
                }, 1);
            }

            if ((this._bindScrollableEvents || this.hasAttribute("bindscrollable")) && this.tagName != "KS-MODALDIALOG") {
                this.setupScrollbars();
            }

            if (!this.isPage() && this.filters) {
                Object.entries(this.filters).forEach(([key, value]) => {
                    window[key] = this._bindFiltersToThis ? value.bind(this) : value;//.bind(this);
                });
            }

            if (this.dataset.tooltip) {
                this.setupTooltips();
            }

            this.templateLoaded = true;
        }

        showTooltip() {
            if (this.disableTooltip) return;
            const mode_based_tooltip = this.dataset.tooltip.split("/");
            let output = "";
            if (mode_based_tooltip.length > 1) {
                output = isCareer ? mode_based_tooltip[0] : mode_based_tooltip[1];
            } else {
                output = mode_based_tooltip[0];
            }

            const tooltiptext = engine.translate(output);
            engine.trigger(EngineEvents.UI.ShowTooltip, tooltiptext, this.dataset.tooltipCssClass);
        }

        hideTooltip(ev) {
            engine.trigger(EngineEvents.UI.HideTooltip);
        }

        toolTipsSetup = false;

        setupTooltips() {
            engine.translate(this.dataset.tooltip);
            this.addEventListener("mouseover", this.showTooltip.bind(this));
            this.addEventListener("mouseleave", this.hideTooltip.bind(this));
            this.addEventListener("focus", this.showTooltip.bind(this));
            this.addEventListener("focusout", this.hideTooltip.bind(this));
            this.toolTipsSetup = true;
        }

        setupScrollbars() {
            //console.trace("setupScrollbars", this.tagName);
            $.qAll(".scrollable-vertical,.scrollable-horizontal", this).forEach(
                /** @param {HTMLDivElement} scrollable */
                scrollable => {

                    if (scrollable.closest("[custom-element]") != this) return;

                    // if(scrollable.closest("ks-modalselect")) {
                    //     console.warn("in modal select");
                    //     return;
                    // }

                    const is_horizontal = scrollable.classList.contains("scrollable-horizontal");
                    scrollable.parentComponent = this;
                    scrollable.isHorizontal = is_horizontal;

                    scrollable.onwheel = (e) => {
                        this.wheelScrollContainer(e, is_horizontal);
                    };


                    scrollable.scrollToFocused = (target, force = false, instant = false) => {

                        //console.trace(`scrollToFocused ${force} ${ksUI.isSpatialNav()} ${scrollable.preventFocus}`, target);

                        if (!force && !ksUI$1.isSpatialNav()) return;
                        if (scrollable.preventFocus) return;

                        /** @type HTMLElement */
                        const elem = target ? target : document.activeElement;

                        //console.trace(`scrollToFocused ${elem.id}`);

                        if (elem == document.body) {
                            console.log("parent is document body - exiting");
                            return;
                        }

                        if (!elem) {
                            return;
                        }

                        const belem = elem.getBoundingClientRect();

                        const navtarget = elem.closest(".scrollable-content");

                        if (!navtarget) {
                            console.trace("no .scrollable-content");
                            return;
                        }

                        if (!elem.parentElement) {
                            console.trace("no parentElement");
                            return;
                        }

                        const bparent = navtarget.getBoundingClientRect();
                        const offset = scrollable.isHorizontal ? belem.x - bparent.x : belem.y - bparent.y;

                        const selem = ksUI$1.getElementSize(elem);


                        if (scrollable.isHorizontal) {
                            if (offset >= (bparent.width - selem.width) && elem.offsetLeft - elem.offsetWidth > 0) {
                                // right
                                ksUI$1.scrollToHorizontal(scrollable.content, elem.offsetLeft - (navtarget.offsetWidth - (elem.offsetWidth * 2)), instant ? -1 : 1000, true);
                            }

                            if (offset < selem.width) {
                                //  left
                                ksUI$1.scrollToHorizontal(scrollable.content, elem.offsetLeft - ((elem.offsetWidth * 2)), instant ? -1 : 1000, true);
                            }

                        } else {

                            if (offset >= bparent.height - (selem.height)) {
                                // down
                                ksUI$1.scrollToVertical(scrollable.content, elem.offsetTop - elem.offsetHeight, instant ? -1 : 1000, true);
                            }

                            if (offset < selem.height) {
                                //  up
                                ksUI$1.scrollToVertical(scrollable.content, elem.offsetTop - (navtarget.offsetHeight - (elem.offsetHeight * 2)), instant ? -1 : 1000, true);
                            }

                        }


                        scrollable.preventFocus = false;
                    };

                    scrollable.scrollToElement = (target, instant = false) => {
                        scrollable.scrollToFocused(target, true, instant);
                    };


                    function wrapContent(target) {

                        if (!$.q(".scrollable-content", scrollable)) {
                            /** @type {HTMLDivElement} */

                            const contentwrapper = document.createElement("div");
                            contentwrapper.className = "scrollable-content";
                            scrollable.children.forEach(child => {
                                contentwrapper.appendChild(child);
                            });
                            scrollable.appendChild(contentwrapper);
                            scrollable.content = contentwrapper;
                        } else {
                            scrollable.content = $.q(".scrollable-content", scrollable);
                        }

                        scrollable.target = $.q(".scrollable-target", scrollable);

                        scrollable.content.onscroll = (e) => {
                            if (scrollable.parentComponent) {
                                scrollable.parentComponent.updateScrollBar(scrollable);
                            }
                        };

                        $.waitForFrames(() => {

                            const navtarget = scrollable.target ? scrollable.target : scrollable.content;



                            navtarget.querySelectorAll(".focusable,.focus-indicator").forEach(child => {
                                const focusable = child.classList.contains("focusable");
                                const focusindicator = child.classList.contains("focus-indicator");

                                const target = focusindicator ? child.closest(".focus-indicator") : focusable ? child : undefined;

                                // if(!target) {
                                //     console.warn("Scrollable: no focusable or focus-indicator element in content");
                                // }

                                if (focusable || focusindicator) {
                                    if (target.onfocus || target.onfocusin) ; else {
                                        if (focusindicator) {
                                            //console.log("targetting focus indicator", target);
                                            target.onfocusin = scrollable.scrollToFocused.bind(this, target, false);
                                        } else {
                                            target.onfocus = scrollable.scrollToFocused.bind(this, null, false);
                                        }
                                    }
                                }
                            });
                        }, 1);

                        scrollable.content.onfocusin = (e) => {
                            const lastfocused = scrollable.lastFocused;

                            cancelAnimationFrame(activePage.scrollableFocusDebounce.id);

                            if (ksUI$1.isSpatialNav() && !scrollable.isFocused && scrollable.lastFocused && e.target != lastfocused) {
                                e.preventDefault();
                                e.stopPropagation();
                                scrollable.preventFocus = true;

                                (function (x) {
                                    $.waitForFrames(() => {
                                        scrollable.preventFocus = false;
                                        console.warn("focusin scrollable");
                                        lastfocused.focus();
                                    }, 1, x);
                                })(activePage.scrollableFocusDebounce);
                            }

                            scrollable.isFocused = true;
                        };

                        scrollable.content.onfocusout = (e) => {
                            if (window["activePage"])
                                (function (x) {
                                    $.waitForFrames(() => {
                                        scrollable.lastFocused = e.target;
                                        scrollable.isFocused = false;
                                    }, 1, x);
                                })(activePage.scrollableFocusDebounce);
                        };

                        return scrollable.content;
                    }

                    function addScrollBar() {
                        if (!$.q(".scrollbar", scrollable)) {
                            /** @type {HTMLDivElement} */
                            const scrollbar = document.createElement("div");
                            const thumb = document.createElement("div");
                            thumb.className = "thumb";

                            scrollbar.thumb = thumb;

                            scrollbar.appendChild(thumb);

                            scrollbar.className = "scrollbar";
                            scrollable.scrollbar = scrollbar;

                            scrollbar.setAttribute("disabled", "disabled");

                            scrollbar.dataset.mode = is_horizontal ? "horizontal" : "vertical";
                            scrollable.appendChild(scrollbar);

                            scrollbar.onclick = (e) => {
                                if (e.target != scrollbar) {
                                    return;
                                }

                                const rect = e.currentTarget.getBoundingClientRect();

                                if (scrollable.isHorizontal) {
                                    const amount = e.x - rect.left - (scrollbar.thumb.offsetWidth / 2);
                                    const percent = amount / rect.width;
                                    ksUI$1.scrollToHorizontal(scrollable.content, scrollable.content.scrollWidth * percent, 250, true);
                                } else {
                                    const amount = e.y - rect.top - (scrollbar.thumb.offsetHeight / 2);
                                    const percent = amount / rect.height;
                                    ksUI$1.scrollToVertical(scrollable.content, scrollable.content.scrollHeight * percent, 250, true);
                                }

                            };


                            scrollbar.handleThumbMouseUp = (e) => {
                                scrollbar.thumb.down = false;
                                scrollbar.classList.remove("dragging");
                                scrollbar.parentElement.classList.remove("content-scrolling");

                                window.removeEventListener("mouseup", scrollbar.handleThumbMouseUp);
                                window.removeEventListener("mousemove", scrollbar.handleThumbMouseDrag);
                            };

                            scrollbar.handleThumbMouseDrag = (e) => {

                                if (scrollbar.thumb.down) {
                                    const rect = scrollbar.getBoundingClientRect();

                                    ksUI$1.menuState.toggleMouseHover(true);

                                    if (scrollable.isHorizontal) {
                                        const amount = e.x - rect.left - (scrollbar.thumb.offsetWidth / 2);
                                        const percent = amount / rect.width;
                                        ksUI$1.scrollToHorizontal(scrollable.content, scrollable.content.scrollWidth * percent, 250, true);
                                    } else {
                                        const amount = e.y - rect.top - (scrollbar.thumb.offsetHeight / 2);
                                        const percent = amount / rect.height;
                                        ksUI$1.scrollToVertical(scrollable.content, scrollable.content.scrollHeight * percent, 250, true);
                                    }

                                    ksUI$1.Audio(eAudioEvents.Scroll);
                                }
                            };

                            scrollbar.thumb.onmousedown = (e) => {

                                scrollbar.thumb.down = true;
                                scrollbar.classList.add("dragging");
                                scrollbar.parentElement.classList.add("content-scrolling");

                                //console.warn(scrollbar.thumb);

                                window.addEventListener("mouseup", scrollbar.handleThumbMouseUp);
                                window.addEventListener("mousemove", scrollbar.handleThumbMouseDrag);
                            };

                        } else {
                            scrollable.scrollbar = $.q(".scrollbar", scrollable);
                        }

                        return scrollable.scrollbar;
                    }

                    const observer = new MutationObserver(function (mutations_list) {

                        let appendscrollbar = true;

                        mutations_list.forEach(function (mutation) {

                            if (mutation.removedNodes[0] /* && mutation.removedNodes[0].classList && mutation.removedNodes[0].classList.contains("scrollbar")*/) {
                                appendscrollbar = false;
                            }
                            if (mutation.addedNodes[0] /* && mutation.addedNodes[0].classList && mutation.addedNodes[0].classList.contains("scrollbar")*/) {
                                appendscrollbar = true;
                            }

                        });

                        if (this.scrollableMutationDebounce)
                            cancelAnimationFrame(this.scrollableMutationDebounce.id);

                        if (appendscrollbar) {
                            wrapContent();
                            addScrollBar();

                            $.waitForFrames(() => {
                                //console.warn("observer append");
                                AP()?.updateScrollBar(scrollable);

                            }, 2, this.scrollableMutationDebounce);
                        } else {
                            $.waitForFrames(() => {
                                AP()?.updateScrollBar(scrollable);
                            }, 2, this.scrollableMutationDebounce);
                            //console.warn("observer no append");
                        }

                        scrollable.lastFocused = null;
                    });

                    wrapContent();
                    addScrollBar();

                    observer.observe(scrollable, { subtree: true, childList: true });

                    cancelAnimationFrame(this.scrollableMutationDebounce.id);

                    const resizeobs = new ResizeObserver((entries) => {
                        $.waitForFrames(() => {
                            this.updateScrollBar(scrollable);
                        }, 6, this.scrollableMutationDebounce);
                    });

                    resizeobs.observe(scrollable.content);

                    this.scrollableContainers.push(scrollable);
                    this.scrollableObservers.push(observer);

                });
        }

        clearAssignedFilters() {
            if (this.#debug) console.trace("clearAssignedFilters", this.tagName);
            if (this.filters) {
                Object.entries(this.filters).forEach(([key, value]) => {
                    delete window[key];
                });
            }
        }

        clearScrollableEvents() {
            this.scrollableContainers.forEach(scrollable => {
                scrollable.content.onfocusout = null;
            });
        }

        clearScrollableObservers() {
            cancelAnimationFrame(this.scrollableMutationDebounce);
            this.scrollableObservers.forEach(observer => {
                //console.warn("observer disconnected");
                observer.disconnect();
            });
        }

        clearAllScrollable() {
            this.clearScrollableEvents();
            this.clearScrollableObservers();
            this.scrollableContainers = [];
            this.scrollableObservers = [];
        }

        onRemovedFromDOM() {
        }

        enableNav() {
            if (this._isnavigable)
                SpatialNavigation$1.enable('@' + this.tagName);
            else
                console.log("enableNav called for non-navigable element", this._uniqueid, this.tagName);
        }

        errorModal(title, message, return_to_home = true, callback, autoHide = false) {

            this.pageModal.Show({
                buttons: 0x100,
                title: title,
                message: message,
                confirm: "btnReturn",
                autoHide: autoHide
            }).onConfirm = () => {
                if (return_to_home) {
                    ksUI$1.goTo("menu.html", "main/main", false, true);
                } else {
                    if (callback)
                        callback();
                }
            };

        }

        disable() {
            this.setAttribute("disabled", "disabled");
            this.classList.add("disabled");
        }

        enable() {
            this.removeAttribute("disabled");
            this.classList.remove("disabled");
        }

        disableNav() {
            if (this._isnavigable) {
                SpatialNavigation$1.disable('@' + this.tagName);
            } else {
                console.warn("disableNav called for non-navigable element", this._uniqueid, this.tagName);
            }
        }

        refocusNav() {
            if (this._isnavigable) {
                SpatialNavigation$1.makeFocusable();
            } else {
                console.warn("refocusNav called for non-navigable element", this._uniqueid, this.tagName);
            }
        }

        assignModel(model, model_name, init, silent = false) {

            if (!model_name) {
                console.warn("assignModel received undefined model name");
                return;
            }

            let t = {};
            Object.assign(t, model);

            if (init || !window[model_name]) {
                if (this.assignedModels.indexOf(model_name) == -1) {
                    engine.createJSModel(model_name, t);
                    this.assignedModels.push(model_name);
                    if (!silent) console.log("Registered", model_name);
                } else {
                    ksUI$1.reset(window[model_name]);
                    if (!silent) console.log("Reassigned", model_name);
                }

            }

            try {
                Object.assign(window[model_name], t);
            } catch (e) {
                console.error("Error assigning ", model_name, e.message);
            }

            engine.updateWholeModel(window[model_name]);
        }

        unassignModel(model_name, silent_error = true, silent_success = false) {
            const index = this.assignedModels.indexOf(model_name);
            if (index > -1) {
                this.assignedModels.splice(index, 1);
                if (!silent_success) console.log("Unregistered", model_name);
            } else {
                if (!silent_error) console.warn(model_name, "not registered");
            }
            if (window[model_name]) {
                engine.unregisterModel(window[model_name]);
                //delete window[model_name];
                if (!silent_success) console.log("unregisterModel", model_name);
            } else {
                if (!silent_error) console.warn(model_name, "not defined");
            }
        }

        updateAssignedModels() {
            this.assignedModels.forEach((model) => {
                if (window[model]) {
                    engine.updateWholeModel(window[model]);
                }
            });
        }

        clearAssignedModels() {
            //console.trace("clearAssignedModels");
            this.assignedModels.forEach((model) => {
                this.unassignModel(model);
            });
        }

        setupNavigation(clear = false) {

            if (this._isnavigable && this.isConnected) {

                if (this.constructor.name == "ModalSelect" && !this.classList.contains("active")) {
                    return;
                }

                if (clear) {
                    console.log("Clearing navigation sections");
                    SpatialNavigation$1.clear();
                }

                window["engineNavOnCancel"]?.clear();

                if (SpatialNavigation$1.getSections()[this.tagName]) {
                    SpatialNavigation$1.remove(this.tagName);
                }

                SpatialNavigation$1.add(this.tagName, this._navConfig);
                this.refocusNav();

                this.onNavCancelBound = this.onNavCancel.bind(this);
                window.addEventListener("ui.action", this.onNavCancelBound);
            }
        }

        #engineNavOnCancel;

        onNavCancel(e) {
            if (e.detail != "cancel") return;

            if (document.body.classList.contains("hide-ui")) {
                document.body.classList.remove("hide-ui");
                if (document.body.classList.contains("opaque")) {
                    ksUI$1.menuState.toggleMouseHover(true);
                }
                return;
            }

            if (document.activeElement.tagName.toLowerCase() == "input") {
                document.activeElement.blur();
                return;
            }

            if (ksUI$1.preventBack) return;
            const btn = $.q("#btnBack");

            const evt = document.createEvent('CustomEvent');
            evt.initCustomEvent("click", true, false);

            if (btn && btn.isDisabled &&
                !btn.isDisabled() &&
                !ksUI$1.areParentsDisabledOrHidden(btn)) {

                btn.dispatchEvent(evt);

            }

            e.stopPropagation();
            e.stopImmediatePropagation();
            e.preventDefault();
        };



        isDisabled() {
            if (this.disabled || this.hasAttribute("disabled"))

                return false;
        }

        storeCurrentlyFocused() {
            console.log("storeCurrentlyFocused", document.activeElement);
            if (this.isPage() && document.activeElement) {
                console.warn("Stored currently focused");
                localStorage.setItem("lastselected-" + this.tagName, document.activeElement.id);
            } else {
                console.warn("Could not store currently focused");
            }
        }

        storeLastFocused() {
            if (this.isPage()) {
                if (ksUI$1.lastFocusedElement && ksUI$1.isSpatialNav() && ksUI$1.lastFocusedElement.id != "btnBack") {
                    localStorage.setItem("lastselected-" + this.tagName, ksUI$1.lastFocusedElement.id);
                }
            }
        }



        disconnectedCallback() {

            if (!this.templateLoaded) {

                return;
            }

            window["engineNavOnCancel"]?.clear();
            window.removeEventListener(EngineEvents.UI.InputAction, this.onNavCancelBound);
            window.removeEventListener(EngineEvents.UI.InputAction, this.handlePageUpDown);

            if (this.toolTipsSetup) {
                this.removeEventListener("mouseover", this.showTooltip);
                this.removeEventListener("mouseleave", this.hideTooltip);
                this.removeEventListener("focus", this.showTooltip);
                this.removeEventListener("blur", this.hideTooltip);
            }

            this.onRemovedFromDOM();

            if (this.lazyLoad)
                cancelAnimationFrame(this.lastVisibilityCheckFrameId);

            this.storeLastFocused();

            this.clearScrollableObservers();
            //this.clearScrollableEvents();
            if (!this.isPage())
                this.clearAssignedFilters();

            if (!this.persistModels)
                this.clearAssignedModels();


            if (this.isPage() && this.isRootPage && this.hasAttribute("opaque")) {
                console.warn("remove root opaque");
                this.documentBody.classList.remove("root-opaque");
            }

            if (this._isnavigable) {
                SpatialNavigation$1.remove(this.tagName);
            }

            if (this._exposeAsActivePage && window["activePage"] == this) {
                delete window["activePage"];
            }

            if (this.isConnected) {
                this.classList.remove("component-connected");
            }

            if (this.classList.contains("renderControlHints")) {
                this.resetControlHints();
            }

            window.removeEventListener("ui.action", this.onCancel);

            if (this.disableCameraControl) {
                ksUI$1.menuState?.toggleMouseHover(false);
            }

        }

        init() {
            if (this.templateLoaded === undefined) {
                console.warn(this.tagName, "templateLoaded undefined");
            }
            if (this && this.isConnected && this.templateLoaded) {
                this.classList.add("component-connected");
            }
            if (this.isPage()) {
                ksUI$1.menuState.addToHistory();
                localStorage.removeItem("loadingDestination");
            }

        }

        initStorageContainer(storage_key, target_object, default_data) {
            if (STORAGE.has(storage_key)) {
                Object.assign(target_object, STORAGE.get(storage_key));
                console.log("Initializing storage container", storage_key);
            } else {
                console.log("Initializing new storage container", storage_key);
                STORAGE.set(storage_key, default_data ?? {});
                Object.assign(target_object, STORAGE.get(storage_key));
            }
        }

        connectCount = 0;
        delayFramesInit = 1;

        connectedCallback() {

            const tag = this.tagName.toLowerCase();

            if (window.reloading) {
                return;
            }

            if (!window["ksUI"]) {
                window.location.reload(true);
            }

            if (ksUI$1.reloading) return;

            if (this.hasAttribute("data-bind-if")) {
                try {
                    this._preventRender = tag.indexOf("-page-") > -1 && !(new Function("return " + this.dataset._dataBindIf + ";")());
                } catch {
                    console.warn("Unexpected if evaluation string", this.dataset._dataBindIf);
                }
            }

            if (!customElements.get) {
                if (ksUI$1.isDevMode())
                    console.error("CustomElementRegistry failure", this.tagName);

                if (!window.reloading) {
                    window.reloading = true;
                    console.error("reloading due to CustomElementRegistry failure");
                    window.location.reload(true);
                }

                return;

            }

            if (customElements.get(tag)) {
                if (this.constructor.name != customElements.get(tag).name) {
                    console.error("Class mismatch", tag, "is", this.constructor.name, "expected", customElements.get(this.tagName).name, this.id, this.className);
                    ksUI$1.inPlaceRecovery(this);
                    return;
                }
            }

            components$1.loadResource(this)
                .then(
                    (result) => {
                        if (this._preventRender) return;
                        this.template = result.template;

                        components$1.renderOnce(this, () => {

                            this.onRenderedOnce();

                            components$1.waitForFrames(() => {


                                if (this.isConnected) {

                                    if (this._exposeAsActivePage) {
                                        window["activePage"] = this;
                                    }

                                    this.rootPage = this.closest("[rootpage]");
                                    this.setAttribute("custom-element", "");

                                    this.onTemplateLoaded();
                                    // this.bindFocusHandling();
                                    this.bindControls();

                                    this.init();

                                    components$1.waitForFrames(() => {
                                        this.setupNavigation(this._clearnavbeforesetup);
                                    }, 3);

                                }
                            }, this.classList.contains("delayedInit") || this.delayedInit ? this.delayFramesInit : 0);
                        });



                    },

                    (reject) => {
                        console.error("Promise rejected", this.tagName, this.id);
                        window["rejected"] = reject;
                        ksUI$1.iterate(reject);
                        components$1.loadResource(this);
                    })

                .catch(err => {
                    console.error("Error rendering", this.tagName, this.id, err.name, err.toString(), err.stack);
                    if (!window["errorArray"]) {
                        let str = localStorage.getItem("errorArray");

                        if (str) {
                            window["errorArray"] = JSON.parse(str);
                        } else {
                            window["errorArray"] = [];
                        }
                    }

                    window["errorArray"].push(err);
                    localStorage.setItem("errorArray", JSON.stringify(window["errorArray"]));
                    if (!window.reloading) {
                        window.reloading = true;
                        console.error("reloading for", this.tagName, customElements.get(this.tagName).name);
                        window.location.reload(true);
                    }
                });

        }

    }

    var template$1N = "<div class=\"pageheader\">\r\n\r\n    <div class=\"logo\"></div>\r\n    <div class=\"headerlabel\">\r\n        <div class=\"prefix\">/</div>\r\n        <component-slot data-name=\"label\" data-l10n-id=\"headerHome\">Home</component-slot>\r\n    </div>\r\n\r\n</div>";

    class PageHeader extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$1N;
            this.delayedInit = true;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            // const rootpage = this.closest("[rootpage]");

            // if (rootpage) {
            //      console.warn(rootpage.title, rootpage.tagName);
            // }
        }


    }
    ksUI.registerModule('ks-pageheader', PageHeader);

    var template$1M = "<div class=\"slider\">\r\n    <div class=\"label\"><component-slot data-name=\"name\">Name</component-slot></div>\r\n    <div class=\"sliderwrapper\">\r\n        <svg class=\"decrease\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 14.533 22.507\">\r\n            <path d=\"M2.229,16.8l9.563-9.562a1.681,1.681,0,0,1,2.384,0l1.589,1.589a1.681,1.681,0,0,1,0,2.384L8.993,18l6.778,6.778a1.681,1.681,0,0,1,0,2.384l-1.589,1.6a1.681,1.681,0,0,1-2.384,0L2.236,19.2A1.683,1.683,0,0,1,2.229,16.8Z\" transform=\"translate(-1.734 -6.746)\" fill=\"#f2f2f2\"/>\r\n        </svg>\r\n        <div id=\"placeholder\"></div>\r\n        \r\n        <svg class=\"increase\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 14.533 22.507\">\r\n            <path d=\"M.495,10.058,10.057.5a1.681,1.681,0,0,1,2.384,0L14.03,2.085a1.681,1.681,0,0,1,0,2.384L7.259,11.254l6.778,6.778a1.681,1.681,0,0,1,0,2.384l-1.589,1.6a1.681,1.681,0,0,1-2.384,0L.5,12.449a1.683,1.683,0,0,1-.007-2.391Z\" transform=\"translate(14.533 22.507) rotate(180)\" fill=\"#f2f2f2\"/>\r\n        </svg>\r\n    </div>\r\n    <div class=\"info\">\r\n        <div class=\"value\"></div>\r\n        <div class=\"unit\"><component-slot data-name=\"unit\"></component-slot></div>\r\n    </div>\r\n\r\n</div>";

    class KsSlider extends KsHTMLElement {

        static observedAttributes = [... super.observedAttributes, "data-value"];

        /** @type {Rangeslider} */
        slider;

        /** @type HTMLDivElement */
        wrapper;

        btnIncrease;
        btnDecrease;

        #slider_init = false;
        valueText;
        unitText;
        valuesArray = [];
        debug;
        preventEvent = false;
        initialized = false;

        noScroll = false;

        repeaterInterval;
        _repeatDefault = 275;
        repeaterIntervalDuration = this._repeatDefault;

        get twoHandles() {
            return this.slider.hasAttribute("two-handles") || this.slider.twoHandles;
        }

        set twoHandles(value) {
            if (value === true)
                this.slider.setAttribute("two-handles", true);
            else
                this.slider.removeAttribute("two-handles");

            this.slider.twoHandles = value;
        }

        get hasOff() {
            return this.off != undefined;
        }

        set off(value) {
            this.setAttribute("off", value);
        }

        get off() {
            const offattrib = this.getAttribute("off");
            if (offattrib === null) return undefined;
            const offnumber = Number(offattrib);
            return isNaN(offnumber) ? offattrib : offnumber;
        }

        get isDirectControl() {
            return this.hasAttribute("directcontrol");
        }

        set unit(newvalue) {
            q(".unit", this).textContent = newvalue;
        }

        get value() {
            if (this.twoHandles) {
                return this.slider._value;
            }
            return this.hasOff & this.slider.value == this.min ? this.off : this.slider.value;
        }

        set value(newvalue) {

            if (newvalue == this.min && this.hasOff) {
                const result = this.valueFilter(this.off);
                this.valueText.innerHTML = result;
                this.slider._value[0] = this.off;
                this.classList.add("min-value");
                this.dispatchEvent(new CustomEvent('onSliderValueChanged', { detail: { sender: this, value: this.off, index: 0 } }));
                return;
            }

            if (newvalue != this.getAttribute("data-value")) {
                this.setAttribute('data-value', JSON.stringify(newvalue));
            }
            if (this.slider) {

                //console.warn("Slider value", this.id, this.dataset.setting, newvalue, this.valuesArray.indexOf(newvalue))
                if (newvalue != this.slider.getAttribute("data-value") && newvalue != undefined) {

                    this.slider.setAttribute('value', JSON.stringify(newvalue));

                    if (this.hasValuesArray) {
                        if (["boolean", "number"].indexOf(typeof newvalue) > -1 && this.valuesArray.length == 2) {
                            this.slider.setValue(newvalue);
                        } else {
                            if (this.debug) console.warn("set value #2", this.valuesArray, newvalue, this.valuesArray.indexOf(newvalue));
                            this.slider.setValue(this.valuesArray.indexOf(newvalue));
                        }

                    } else {
                        //if(this.debug) {
                        //console.warn(">>> value, newvalue", newvalue, this.id);
                        //}
                        this.slider.setValue(newvalue);
                    }
                } else {
                    if (this.debug)
                        console.warn("SAME VALUE", newvalue, this.slider.getAttribute("data-value"));
                }
            }
        }

        get precision() {
            return this.slider.precision;
        }

        set precision(value) {
            if (this.slider) {
                this.slider.precision = value;
            }
        }

        set valueNoEvent(newvalue) {

            this.preventEvent = true;
            if (newvalue != this.getAttribute("data-value")) {
                this.setAttribute('data-value', newvalue);
            }


            if (this.debug)
                console.trace("SET FROM VALUESARRAY", this.hasValuesArray, this.valuesArray);

            if (this.slider) {
                if (newvalue != this.slider.getAttribute("data-value")) {
                    this.slider.setAttribute('value', newvalue);
                    if (this.hasValuesArray) {
                        if (this.debug)
                            console.trace("SET FROM VALUESARRAY", this.valuesArray.indexOf(newvalue), this.hasValuesArray, this.slider._values);

                        this.slider.setValue(this.valuesArray.indexOf(newvalue));
                        this.valueText.innerHTML = engine.translate(this.valueFilter(this.valuesArray[this.valuesArray.indexOf(newvalue)]));
                    } else {

                        this.slider.setValue(newvalue);
                    }

                }
            }
            this.preventEvent = false;
        }

        get min() {
            return this.slider.min;
        }

        set min(newvalue) {

            if (this.slider.min == newvalue) return;

            this.slider.setAttribute('min', newvalue);
            this.slider.min = newvalue;

            if (this.twoHandles) {
                if (newvalue > this.value[0]) {
                    this.value = [this.min, this.value[1]];
                }
            }
        }

        get max() {
            return this.slider.max;
        }

        set max(newvalue) {

            //console.log("resizing slider", newvalue, this.max, this.value);

            if (this.slider.max == newvalue) return;

            this.slider.setAttribute('max', newvalue);
            this.slider.max = newvalue;

            if (this.twoHandles) {
                if (newvalue < this.value[1]) {
                    this.value = [this.value[0], newvalue];
                }

            } else {
                if (newvalue < this.value) {
                    //console.log("resizing slider");
                    this.value = newvalue;
                } else {
                    this.value = this.slider.value;
                }
            }
        }

        _step = 0;

        get step() {
            return Number(this.slider.step);
        }

        set step(newvalue) {

            this.slider.setAttribute('step', newvalue);
        }

        _fromcenter = false;

        get fromcenter() {
            return this._fromcenter;
        }

        set fromcenter(value) {
            this._fromcenter = value;
        }

        get values() {
            if (this.slider)
                return this.slider.values;
            else
                return JSON.parse(this.getAttribute("values"));
        }

        set values(newvalue) {

            if ((this.values != newvalue)) {
                this.valuesArray = JSON.parse(newvalue);
                this.min = 0;
                this.max = this.valuesArray.length - 1;
            }

            if (this.slider) {
                this.slider.setAttribute("values", newvalue);
                this.slider.values = this.valuesArray;
            }

            if (this.debug)
                console.warn("SET VALUES", this.values, newvalue, this.firstinit);


            this.setAttribute("values", newvalue);
        }

        get index() {
            if (this.hasValuesArray && this.slider && this.slider.values) {
                return this.slider.values.indexOf(this.slider.value);
            }
            const output = this.slider.index || 0;
            return output;
        }

        set index(new_index) {
            if (this.slider && this.hasValuesArray)
                this.slider.index = new_index;
        }

        get hasValuesArray() {
            return this.valuesArray.length > 0;
        }

        get slider_init() {
            return this.#slider_init || !this.hasAttribute("data-bind-ksvalue")
        }

        set slider_init(value) {
            this.#slider_init = value;
        }

        selected = false;
        engineActionHandler;

        toggleSelected(toggle) {
            ksUI$1.toggleSpatialNavigation(!toggle);
            this.classList.toggle("selected", toggle);
            this.selected = toggle;

            if (toggle) {
                if (this.engineActionHandler) {
                    this.engineActionHandler.clear();
                }

                this.engineActionHandler = engine.on("UIExInputsAction", (e) => {

                    if (!this.classList.contains("selected")) {
                        this.engineActionHandler.clear();
                    }

                    switch (e.action) {
                        case "InputAction_UI_Left":
                            this.decrease();
                            break;
                        case "InputAction_UI_Right":
                            this.increase();
                            break;
                        case "InputAction_UI_Up":
                            if (this.twoHandles) {
                                this.increase(null, true);
                            } else {
                                this.toggleSelected(false);
                            }
                            //result = SpatialNavigation.move("up");
                            break;
                        case "InputAction_UI_Down":
                            if (this.twoHandles) {
                                this.decrease(null, true);
                            } else {
                                this.toggleSelected(false);
                            }
                            //result = SpatialNavigation.move("down");
                            break;
                        case "InputAction_UI_Confirm":
                            this.toggleSelected(false);
                            break;
                        case "InputAction_UI_Cancel":
                            this.toggleSelected(false);
                            break;
                    }

                });
            } else if (this.engineActionHandler) {
                this.engineActionHandler.clear();
            }

        }

        increase(evt, min_handle) {

            this.focus();

            if (document.body.classList.contains("ui-locked")) return;

            if (evt) {
                evt.stopPropagation();
            }

            if (this.hasValuesArray) {

                if (this.index < this.valuesArray.length - 1) {
                    this.value = this.valuesArray[this.index + 1];
                }

            } else if (this.step) {
                if (this.twoHandles) {
                    if (min_handle) {
                        if (this.value[0] < this.max && this.value[0] < this.value[1] + this.step) {
                            this.value = [this.value[0] + this.step, this.value[1]];
                        }

                    }
                    else {
                        if (this.value[1] < this.max) {
                            this.value = [this.value[0], this.value[1] + this.step];
                        }
                    }

                } else {
                    if (this.value < this.max) {
                        if (this.value == this.off) {
                            this.value = Number(this.min) + 1;
                            return;
                        }
                        this.value += this.step;
                    }
                }

            }

        }

        decrease(evt, min_handle) {
            if (document.body.classList.contains("ui-locked")) return;

            this.focus();

            if (evt) {
                evt.stopPropagation();
            }

            if (this.hasValuesArray) {
                if (this.index > 0) {
                    this.value = this.valuesArray[this.index - 1];
                }
            } else if (this.step) {
                if (this.twoHandles) {
                    if (min_handle) {
                        if (this.value[0] > this.min) {
                            this.value = [this.value[0] - this.step, this.value[1]];
                        }

                    }
                    else {
                        if (this.value[1] > this.min) {
                            this.value = [this.value[0], this.value[1] - this.step];
                        }
                    }

                } else {
                    if (this.value > this.min) {
                        this.value -= this.step;
                    }
                }
            }
        }

        valueFilter(value_to_filter) {
            return value_to_filter;
        }

        bindValue(newvalue) {
            if (!this.slider) return;



            function set_values(e) {

                this.preventEvent = true;

                if (isNaN(newvalue)) {

                    if (this.debug)
                        console.log("slider bindValue NaN", newvalue);
                    if (this.hasValuesArray) {
                        this.slider.setValue(this.valuesArray.indexOf(newvalue));

                        this.valuesArray[this.valuesArray.indexOf(newvalue)];

                        this.valueText.innerHTML = engine.translate(this.valueFilter(this.valuesArray[this.valuesArray.indexOf(newvalue)]));
                    }
                    // this.slider.setAttribute("values", newvalue);
                    this.preventEvent = false;
                } else {
                    if (this.debug)
                        console.log("slider bindValue", newvalue);


                    if (this.getAttribute("values")) {
                        if (this.debug)
                            console.log("slider bindValue array", Number(newvalue));

                        let index = this.valuesArray.indexOf(newvalue);
                        let valuefromindex;

                        if (index != -1) {
                            this.slider.setValue(index);

                        } else {
                            index = 0;
                        }

                        valuefromindex = this.valuesArray[index];

                        if (isNaN(Number(valuefromindex))) {
                            this.valueText.innerHTML = engine.translate(valuefromindex);
                        } else {
                            this.valueText.innerHTML = valuefromindex;
                        }

                        this.index = index;



                    } else {
                        this.slider.setAttribute("value", newvalue);
                        this.valueText.textContent = this.valueFilter(this.slider.value.toFixed(this.precision));
                        this.slider.setValue(newvalue);
                    }

                    this.slider_init = true;
                    this.preventEvent = false;


                }


            }

            this.slider.onAfterSetup = set_values.bind(this);
            this.slider.setup();

        }

        constructor() {
            super();
            this.template = template$1M;
            this.onSliderUpdate = this.onSliderUpdate.bind(this);
            this.onResize = this.onResize.bind(this);
            this.delayedInit = false;
        }

        getNumericValue(attribute) {
            let output = null;
            let attrvalue = this.getAttribute(attribute);

            if (attrvalue != null && !isNaN(attrvalue)) {
                output = Number(attrvalue);
            }

            if (output != null) {
                if (this.debug) console.log("getNumericValue", this.dataset["videosetting"], output);
                this[attribute] = output;
            }
        }

        onBindingUpdate(binding_param, value, init) {


            if (binding_param == "ksvalue") {

                if (init) {
                    if (this.debug) {
                        console.warn("ksvalue init", value, typeof value);
                    }
                    return;
                }

                if (this.debug) {
                    console.warn("ksvalue", value, typeof value);
                }
                this.attributeChangedCallback("data-value", undefined, value);
            }
        }


        init() {
            super.init();

            this.debug = this.hasAttribute("debug");

            if (this.debug)
                this.slider.setAttribute("debug", "true");

            let attrvalue = this.getAttribute("value");
            this.getNumericValue("min");
            this.getNumericValue("max");
            this.getNumericValue("step");

            this.precision = parseInt(this.getAttribute("precision")) || 0;

            if (this.debug) console.log(">>> >", attrvalue, this.min, this.max, this.step, this.value);

            if (this.hasAttribute("values")) {
                this.valuesArray = JSON.parse(this.getAttribute('values'));

                this.values = this.getAttribute("values");
                this.min = 0;
                this.max = this.valuesArray.length - 1;
            }

            this.getNumericValue("value");

            if (this.hasAttribute("pols-number")) {
                this.slider.setAttribute("pols-number", this.getAttribute("pols-number"));
            }

            if (this.hasAttribute("grid")) {
                this.slider.setAttribute("grid", "");
            }

            if (this.hasAttribute("fromcenter") || this.fromcenter) {
                this.slider.setAttribute("fromcenter", "");
            }

            if (this.off != undefined) {
                this.min = this.min - 1;
            }

            if (this.hasAttribute("two-handles")) {
                this.slider.setAttribute("two-handles", true);
            }

            this.firstinit = true;

        }

        onInitialized() {

        }

        onTemplateLoaded() {
            if (!this.isConnected) return;

            //let sliderstr = `<gameface-rangeslider orientation="horizontal" thumb custom-handle="#btnGenerateGrid"></gameface-rangeslider>`;

            //this.setAttribute("debug", "true")

            const sliderElement = document.createElement('gameface-rangeslider');
            sliderElement.setAttribute('orientation', 'horizontal');

            this.noScroll = this.hasAttribute("no-scroll");

            if (this.hasAttribute("two-handles")) {
                sliderElement.setAttribute("two-handles", true);
                sliderElement.twoHandles = true;
                if (this.debug) console.warn("Has TWO HANDLES");
            }

            q(".sliderwrapper", this).replaceChild(sliderElement, q("#placeholder", this));

            this.slider = q("gameface-rangeslider", this);
            this.wrapper = q(".sliderwrapper", this);
            this.valueText = q(".value", this);
            this.unitText = q(".unit", this);

            this.btnDecrease = q("svg.decrease", this);
            this.btnIncrease = q("svg.increase", this);

            this.slider.onInitialized = () => {
                let targetvalue = this.slider.value;

                if (this.hasValuesArray && isNaN(this.value)) {
                    this.valueText.innerHTML = engine.translate(this.valueFilter(this.value));
                    this.valueText.setAttribute("data-l10n-id", this.valueFilter(this.value));

                    //this.valueText.setAttribute("data-l10n-id", this.valueFilter(value));
                }

                this.valueText.textContent =

                    this.valueFilter(this.hasOff && this.value == this.min ? this.off :
                        this.twoHandles ? `${this.value[0]} - ${this.value[1]}` :

                            this.value);

                this.valueFilter(targetvalue);
                this.initialized = true;
            };

            if (this.classList.contains("toggle")) ;

            this.onclick = () => {
                this.focus();
                this.toggleSelected(true);
            };

            if (this.isDirectControl) {
                this.dataset["sn-left"] = "";
                this.dataset["sn-right"] = "";
            }

            if (this.dataset.tooltip) {
                this.setupTooltips();
            }


            this.templateLoaded = true;
        }

        disconnectedCallback() {

        }

        fromcallback = false;
        attributeChangedCallback(name, oldValue, newValue) {

            if (this.twoHandles) return;

            if (this.fromsliderupdate) return;
            this.fromcallback = true;

            if (name == "data-value" && oldValue !== newValue) {

                if (this.hasValuesArray) {
                    if (this.debug)
                        console.warn("newvalue", typeof newValue, newValue);
                    this.slider.setValue(
                        typeof newValue === "boolean" ?
                            newValue : this.valuesArray.indexOf(newValue)
                    );

                    this.classList.toggle("min-value", this.index == 0);
                    this.classList.toggle("max-value", this.index == this.valuesArray.length - 1);

                }

                else {



                    if (this.debug)
                        console.warn("nonarray newvalue", typeof newValue, newValue);

                    this.value = newValue;

                    this.classList.toggle("min-value", this.value == this.min);
                    this.classList.toggle("max-value", this.value == this.max);

                    if (this.hasOff) {

                        this.classList.toggle("min-value", this.value == this.off);
                        this.valueText.textContent = this.valueFilter(this.value);
                        return;
                    }

                    if (oldValue !== null && this.isConnected && this.slider) {
                        if (this.slider_init) {
                            this.slider.setValue(newValue);
                        }
                    }
                }

            }
            this.fromcallback = false;
        }

        fromsliderupdate = false;
        onSliderUpdate(e) {
            this.fromsliderupdate = true;



            if (!this.preventEvent && this.initialized) {
                if (this.classList.contains("selected")) {
                    this.focus();
                }
                this.dispatchEvent(new CustomEvent('onSliderValueChanged', { detail: { sender: this, value: this.twoHandles ? e.detail.value : e.detail.value[0], index: e.detail.index } }));
                ksUI$1.Audio(eAudioEvents.Scroll);
            }

            if (!this.hasValuesArray) {
                this.value = Number(e.detail.value[0]);
                this.index = Number(e.detail.index);
            }

            if (this.hasValuesArray && this.value != "") {

                if (this.debug) ksUI$1.iterate(e.detail);
                const value = this.valuesArray[this.index];

                this.classList.toggle("min-value", this.index == 0);
                this.classList.toggle("max-value", this.index == this.valuesArray.length - 1);

                //console.trace(value, this.index);

                if (isNaN(Number(value))) {

                    this.valueText.innerHTML = engine.translate(this.valueFilter(value));
                    this.valueText.setAttribute("data-l10n-id", this.valueFilter(value));
                } else {
                    this.valueText.innerHTML = value;
                }

                //this.slider.value = this.index;
            } else {
                const value = e.detail.value[0];
                this.valueText.textContent = this.valueFilter(this.hasOff && value == this.min ? this.off :
                    this.twoHandles ? `${e.detail.value[0]} - ${e.detail.value[1]}` : e.detail.value[0]);
                this.classList.toggle("min-value", this.value == this.min);
                this.classList.toggle("max-value", this.value == this.max);

                if (this.hasOff) {
                    this.classList.toggle("min-value", this.value == this.off);
                }

            }



            this.fromsliderupdate = false;
        }

        onResize() {

            waitForFrames(() => {
                //console.log("Resizing delayed", this.tagName, this.id, window.innerWidth, window.innerHeight);
                if (this.slider && this.slider.isConnected) {
                    let b = this.slider.hasValuesArray ? this.values.indexOf(this.value) : this.value;
                    this.slider.onAfterSetup = (sender) => {

                        sender.setValue(b);
                    };

                    this.slider.setup();
                }
            }, 6);
        }

        bindControls() {
            if (!this.isConnected) return;
            this.slider.addEventListener("sliderupdate", this.onSliderUpdate);
            window.addEventListener("resize", this.onResize);


            this.addEventListener("wheel", (event) => {

                if (this.noScroll || document.activeElement != this) return;

                this.focus();
                this.toggleSelected(true);

                if (typeof this.value == "boolean") {
                    this.value = event.deltaY > 0 ? 1 : 0;
                } else if (typeof this.value == "number") {
                    if (event.deltaY > 0) {

                        this.increase();
                    } else {
                        this.decrease();
                    }
                    //this.value += event.deltaY * Number(this.step);
                } else if (typeof this.value == "string" && this.hasValuesArray) {
                    const targetvalue = ksUI$1.clamp(this.index + event.deltaY, 0, this.valuesArray.length - 1);
                    this.slider.setValue(targetvalue);
                }
            });

            this.addEventListener("mouseleave", (event) => {
                this.toggleSelected(false);
            });


            this.addEventListener("mouseout", (event) => {
                if (event.target == this) {
                    this.toggleSelected(false);
                }
            });

            this.addEventListener("sn:enter-down", (event) => {
                this.toggleSelected(true);
            });

            if (this.isDirectControl) {
                this.engineActionHandler = engine.on("UIExInputsAction", (e) => {

                    switch (e.action) {
                        case "InputAction_UI_Left":
                            this.decrease();
                            break;
                        case "InputAction_UI_Right":
                            this.increase();
                            break;
                    }

                });
            }

            //this.increase = this.increase.bind(this);
            //this.decrease = this.decrease.bind(this);

            //this.btnIncrease.addEventListener("click", this.increase);
            //this.btnDecrease.addEventListener("click", this.decrease);


            this.btnIncrease.addEventListener("mousedown", () => {
                this.increase();
                this.repeaterInterval = setTimeout(() => this.timedIncrease(), this.repeaterIntervalDuration);

            });

            this.btnDecrease.addEventListener("mousedown", () => {
                this.decrease();
                this.repeaterInterval = setTimeout(() => this.timedDecrease(), this.repeaterIntervalDuration);

            });

            this.btnIncrease.addEventListener("mouseup", () => {
                clearTimeout(this.repeaterInterval);
                this.repeaterIntervalDuration = this._repeatDefault;
            });

            this.btnIncrease.addEventListener("mouseout", () => {
                clearTimeout(this.repeaterInterval);
                this.repeaterIntervalDuration = this._repeatDefault;
            });

            this.btnDecrease.addEventListener("mouseup", () => {
                clearTimeout(this.repeaterInterval);
                this.repeaterIntervalDuration = this._repeatDefault;
            });

            this.btnDecrease.addEventListener("mouseout", () => {
                clearTimeout(this.repeaterInterval);
                this.repeaterIntervalDuration = this._repeatDefault;
            });

        }

        timedIncrease() {
            this.increase();
            this.repeaterInterval = setTimeout(() => {
                this.timedIncrease();
                if (this.repeaterIntervalDuration > 25)
                    this.repeaterIntervalDuration -= 50;

            }, this.repeaterIntervalDuration);
        }

        timedDecrease() {
            this.decrease();
            this.repeaterInterval = setTimeout(() => {
                this.timedDecrease();
                if (this.repeaterIntervalDuration > 25)
                    this.repeaterIntervalDuration -= 50;

            }, this.repeaterIntervalDuration);
        }

        onRemovedFromDOM() {
            if (this.slider)
                this.slider.removeEventListener("sliderupdate", this.onSliderUpdate);

            if (this.engineActionHandler) {
                this.engineActionHandler.clear();
            }

        }


    }
    ksUI$1.registerModule('ks-slider', KsSlider);

    var template$1L = "<div class=\"btnbody\">\r\n    <component-slot data-name=\"name\"></component-slot>\r\n    <component-slot data-name=\"icon\"></component-slot>\r\n</div>";

    class Btnbasic extends KsHTMLElement {

        #path;
        #goto;
        #storeorigin;
        #notransition;
        controlsbound = false;
        onPressedBound;

        #persistHandler = false;

        /** If true then it will use ksUI.menuState.back() when pressed */
        _useMenuStateBack = false;
        forceToggleMode = false;
        toggleState = false;
        toggleGroup = "";
        toggleGroupMulti = "";



        delayedRedirect = false;

        defaultAudioEvent = eAudioEvents.Select;

        get toggleOnFocus() {
            return this.hasAttribute("toggle-on-focus");
        }

        /** If true then it will use ksUI.menuState.back() when pressed */
        get useMenuStateBack() {
            return this.hasAttribute("usemenustateback") || this._useMenuStateBack;
        }

        /** If true then it will use ksUI.menuState.back() when pressed */
        set useMenuStateBack(value) {
            if (value) {
                this.setAttribute("usemenustateback", "");
            } else {
                this.removeAttribute("usemenustateback");
            }
            this._useMenuStateBack = value;
        }

        get allowNone() {
            return this.hasAttribute("allownonetoggled") || this.forceToggleMode;
        }

        get isToggle() {
            return this.hasAttribute("toggle") || this.forceToggleMode;
        }

        set text(value) {
            q(".btnbody > *", this).innerHTML = value;
        }

        get text() {
            return q(".btnbody > *", this).innerHTML;
        }

        set l10nId(value) {
            q(".btnbody > *", this).dataset.l10nId = value;
        }

        get l10nId() {
            return q(".btnbody > *", this).dataset.l10nId;
        }

        labelText;

        constructor() {
            super();
            this.delayedInit = true;
            this.template = template$1L;

        }

        isSelected() {
            return this.classList.contains("selected");
        }

        press() {
            this.onPressedBound();
        }


        toggle(is_on, trigger_event = false) {

            if (!this.isToggle) return;
            if (this.toggleGroup) {
                let btns = qAll("[toggle-group=" + this.toggleGroup + "]");
                btns.forEach((i) => {
                    if (i != this && is_on) {
                        i.classList.remove("selected");
                    }
                });
            }
            this.classList.toggle("selected", is_on);
            if (trigger_event) {

                this.onToggled(this, { target: this, currentTarget: this }, is_on);
            }
            this.toggleState = is_on;
        }

        onTemplateLoaded() {
            //console.warn(this.tagName, this.id, this.onPressed);

            this.componentBody = q(".btnbody", this);

            this.lazyLoad = this.hasAttribute("lazyload");

            if (this.lazyLoad) {
                this.visibilityChecker = this.checkOnScreenLoop.bind(this);
                requestAnimationFrame(this.visibilityChecker);
            }

            if (this.toggleOnFocus) {
                this.onfocus = () => {
                    this.press();
                };
            }

            this.onPressedBound = (e) => {

                // console.warn(window.getComputedStyle(this).content);

                /* #TODO-IM Revisit this!
                if(window.getComputedStyle(this).content.indexOf('disabled') > -1) {
                    console.trace("Attempt to press disabled button", this);
                    return;
                }
                    */

                if (this.classList.contains("cancel")) {
                    this.defaultAudioEvent = eAudioEvents.Cancel;
                }

                if (this.classList.contains("apply")) {
                    this.defaultAudioEvent = eAudioEvents.Confirm;
                }

                if (this.useMenuStateBack) {
                    ksUI$1.menuState.back();
                    return;
                }

                ksUI$1.Audio(this.audioEvent);

                //window["lastbtnevent"] = e;
                let twostate = false;
                const oldstate = this.isSelected();

                if (this.getPath() || this.getGoTo()) {
                    // console.log(">>", e.type, this.tagName, "redirect via html attribute", this.getPath(), this.getGoTo(), this.redirect);
                    const proceed = this.onBeforeRedirect();
                    if (proceed === false) return;

                    if (!this.#persistHandler) {
                        this.removeEventListener("click", this.onPressedBound);
                        this.removeEventListener("sn:enter-down", this.onPressedBound);
                    }

                    return this.redirect();

                } else {
                    this.onPressed(this, e);
                    if (this.isToggle) {
                        let otherbtn;

                        if (this.toggleGroup) {

                            let btns = qAll("[toggle-group=" + this.toggleGroup + "]");
                            twostate = btns.length == 2 && !this.hasAttribute("distinct-values") && (e && e.type != "click");

                            btns.forEach((i) => {
                                if (twostate) {
                                    if (i != this) {
                                        otherbtn = i;
                                    }
                                } else {
                                    if (this.allowNone) {
                                        if (i != this) {
                                            i.classList.remove("selected");
                                            i.toggle(false, true);
                                        }
                                    } else {
                                        i.classList.remove("selected");
                                    }
                                }
                            });
                        }

                        if (this.toggleGroupMulti) {

                            //let btns = $.qAll(`[toggle-group-multi=${this.toggleGroupMulti}]`);
                            //twostate = btns.length == 2 && !this.hasAttribute("distinct-values");
                            let selectedBtns = qAll(`[toggle-group-multi=${this.toggleGroupMulti}].selected`);

                            if (selectedBtns.length == 1 && this.isSelected()) return;

                        }

                        let sender = this;

                        if (twostate && this.isSelected()) {
                            sender = otherbtn;
                            sender.toggle(true);
                            if (e.type == "sn:enter-down")
                                sender.focus();
                        } else if (twostate && !this.isSelected()) {
                            sender.toggle(true);
                        }

                        sender.toggleState = twostate ? sender.isSelected() : sender.classList.toggle("selected");

                        const newstate = this.isSelected();

                        if (twostate || (oldstate != newstate))
                            this.onToggled(sender, e, sender.toggleState);
                    }
                }


            };

            this.#persistHandler = this.hasAttribute("persist-handler");

            this.#path = this.replacePath(this.getAttribute("path"));
            this.#goto = this.getAttribute("goto");
            this.#notransition = this.hasAttribute("notransition");
            this.#storeorigin = this.hasAttribute("storeorigin");
            // this.isToggle = this.hasAttribute("toggle") || this.forceToggleMode;
            //this.toggleState = 
            this.toggleGroup = this.getAttribute("toggle-group") || this.toggleGroup;
            this.toggleGroupMulti = this.getAttribute("toggle-group-multi") || this.toggleGroupMulti;
            this.delayedRedirect = this.hasAttribute("delayedRedirect");

            if (this.isToggle && this.toggleGroup) {
                this.setAttribute("toggle-group", this.toggleGroup);
            }

            if (this.isToggle && this.toggleGroupMulti) {
                this.setAttribute("toggle-group-multi", this.toggleGroupMulti);
            }


            if (this.labelText) {
                this.setLabelText(this.labelText);
            }

            if (this.hasAttribute("l10nId")) {
                this.l10nId = this.getAttribute("l10nId");
            }

            if (this.hasAttribute("text")) {
                this.text = this.getAttribute("text");
            }

            if (this.dataset.tooltip) {
                this.setupTooltips();
            }

            if (this.id == "btnBack") {
                const slot = q(".btnbody > component-slot[data-name=name]", this);
                if (slot) {
                    //slot.innerHTML = engine.translate("btnBack");
                    slot.setAttribute("data-l10n-id", "btnBack");
                }
            }


            this.templateLoaded = true;
        }

        replacePath(path) {
            if (path) {
                path = path.replace("{activeMenu}", ksUI$1.menuState.get().activeMenu);
                path = path.replace("{activeSubMenu}", ksUI$1.menuState.get().activeSubMenu);
            }
            return path;
        }

        getPath() {
            return this.replacePath(this.getAttribute("path"));
        }

        getGoTo() {
            return this.getAttribute("goto");
        }

        getNoTransition() {
            return this.hasAttribute("notransition");
        }

        bindControls() {

            if (this.isConnected) {

                this.addEventListener("click", this.onPressedBound);
                this.addEventListener("sn:enter-down", this.onPressedBound);

                if (this.#goto) {
                    this.redirect = () => {
                        //if (this.#storeorigin) {
                        //ksUI.menuState.storeOrigin().save();
                        //}
                        waitForFrames(() => {
                            ksUI$1.goTo(this.getGoTo(), this.getPath(), this.getNoTransition(), this.hasAttribute("reload"), true, 0);
                        }, this.delayedRedirect ? 1 : 0);
                        return;
                    };
                } else if (this.#path) {
                    this.redirect = () => {
                        if (this.#storeorigin) {
                            ksUI$1.menuState.storeOrigin().save();
                        }
                        waitForFrames(() => {
                            ksUI$1.changePage(this.getPath(), this.getNoTransition());
                        }, this.delayedRedirect ? 1 : 0);
                    };
                }

            }
        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();
            if (!this.classList.contains("persistbinding")) ;
        }

        onBeforeRedirect() {

        }

        redirect() {

        }

        /** legacy */
        setLabelId(text_id) {
            //this.l10nId = text_id;
            this.setLabelText(engine.translate(text_id));
        }

        /** legacy */
        setLabelText(text) {
            const label = q(".btnbody", this);
            label.innerHTML = '<div slot="name">' + text + '</div>';
        }

        onPressed(sender, e) {

        }

        onToggled(sender, e, state) {

        }
    }
    ksUI$1.registerModule('ks-btnbasic', Btnbasic);

    var template$1K = "<div class=\"btnpanel-body btnbody\">\r\n    <div class=\"extra\">\r\n        <component-slot data-name=\"extra\"></component-slot>\r\n    </div>\r\n    <div class=\"title\">\r\n        <component-slot data-name=\"title\"></component-slot>\r\n    </div>\r\n    <div class=\"subtitle\">\r\n        <component-slot data-name=\"subtitle\"></component-slot>\r\n    </div>\r\n    <div class=\"imagemask\">\r\n        <div class=\"image\"></div>\r\n    </div>\r\n</div>";

    /**
     * Removes all key-value entries from the list cache.
     *
     * @private
     * @name clear
     * @memberOf ListCache
     */
    function listCacheClear() {
      this.__data__ = [];
      this.size = 0;
    }

    /**
     * Performs a
     * [`SameValueZero`](http://ecma-international.org/ecma-262/7.0/#sec-samevaluezero)
     * comparison between two values to determine if they are equivalent.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to compare.
     * @param {*} other The other value to compare.
     * @returns {boolean} Returns `true` if the values are equivalent, else `false`.
     * @example
     *
     * var object = { 'a': 1 };
     * var other = { 'a': 1 };
     *
     * _.eq(object, object);
     * // => true
     *
     * _.eq(object, other);
     * // => false
     *
     * _.eq('a', 'a');
     * // => true
     *
     * _.eq('a', Object('a'));
     * // => false
     *
     * _.eq(NaN, NaN);
     * // => true
     */
    function eq(value, other) {
      return value === other || (value !== value && other !== other);
    }

    /**
     * Gets the index at which the `key` is found in `array` of key-value pairs.
     *
     * @private
     * @param {Array} array The array to inspect.
     * @param {*} key The key to search for.
     * @returns {number} Returns the index of the matched value, else `-1`.
     */
    function assocIndexOf(array, key) {
      var length = array.length;
      while (length--) {
        if (eq(array[length][0], key)) {
          return length;
        }
      }
      return -1;
    }

    /** Used for built-in method references. */
    var arrayProto = Array.prototype;

    /** Built-in value references. */
    var splice = arrayProto.splice;

    /**
     * Removes `key` and its value from the list cache.
     *
     * @private
     * @name delete
     * @memberOf ListCache
     * @param {string} key The key of the value to remove.
     * @returns {boolean} Returns `true` if the entry was removed, else `false`.
     */
    function listCacheDelete(key) {
      var data = this.__data__,
          index = assocIndexOf(data, key);

      if (index < 0) {
        return false;
      }
      var lastIndex = data.length - 1;
      if (index == lastIndex) {
        data.pop();
      } else {
        splice.call(data, index, 1);
      }
      --this.size;
      return true;
    }

    /**
     * Gets the list cache value for `key`.
     *
     * @private
     * @name get
     * @memberOf ListCache
     * @param {string} key The key of the value to get.
     * @returns {*} Returns the entry value.
     */
    function listCacheGet(key) {
      var data = this.__data__,
          index = assocIndexOf(data, key);

      return index < 0 ? undefined : data[index][1];
    }

    /**
     * Checks if a list cache value for `key` exists.
     *
     * @private
     * @name has
     * @memberOf ListCache
     * @param {string} key The key of the entry to check.
     * @returns {boolean} Returns `true` if an entry for `key` exists, else `false`.
     */
    function listCacheHas(key) {
      return assocIndexOf(this.__data__, key) > -1;
    }

    /**
     * Sets the list cache `key` to `value`.
     *
     * @private
     * @name set
     * @memberOf ListCache
     * @param {string} key The key of the value to set.
     * @param {*} value The value to set.
     * @returns {Object} Returns the list cache instance.
     */
    function listCacheSet(key, value) {
      var data = this.__data__,
          index = assocIndexOf(data, key);

      if (index < 0) {
        ++this.size;
        data.push([key, value]);
      } else {
        data[index][1] = value;
      }
      return this;
    }

    /**
     * Creates an list cache object.
     *
     * @private
     * @constructor
     * @param {Array} [entries] The key-value pairs to cache.
     */
    function ListCache(entries) {
      var index = -1,
          length = entries == null ? 0 : entries.length;

      this.clear();
      while (++index < length) {
        var entry = entries[index];
        this.set(entry[0], entry[1]);
      }
    }

    // Add methods to `ListCache`.
    ListCache.prototype.clear = listCacheClear;
    ListCache.prototype['delete'] = listCacheDelete;
    ListCache.prototype.get = listCacheGet;
    ListCache.prototype.has = listCacheHas;
    ListCache.prototype.set = listCacheSet;

    /**
     * Removes all key-value entries from the stack.
     *
     * @private
     * @name clear
     * @memberOf Stack
     */
    function stackClear() {
      this.__data__ = new ListCache;
      this.size = 0;
    }

    /**
     * Removes `key` and its value from the stack.
     *
     * @private
     * @name delete
     * @memberOf Stack
     * @param {string} key The key of the value to remove.
     * @returns {boolean} Returns `true` if the entry was removed, else `false`.
     */
    function stackDelete(key) {
      var data = this.__data__,
          result = data['delete'](key);

      this.size = data.size;
      return result;
    }

    /**
     * Gets the stack value for `key`.
     *
     * @private
     * @name get
     * @memberOf Stack
     * @param {string} key The key of the value to get.
     * @returns {*} Returns the entry value.
     */
    function stackGet(key) {
      return this.__data__.get(key);
    }

    /**
     * Checks if a stack value for `key` exists.
     *
     * @private
     * @name has
     * @memberOf Stack
     * @param {string} key The key of the entry to check.
     * @returns {boolean} Returns `true` if an entry for `key` exists, else `false`.
     */
    function stackHas(key) {
      return this.__data__.has(key);
    }

    /** Detect free variable `global` from Node.js. */
    var freeGlobal = typeof global == 'object' && global && global.Object === Object && global;

    var freeGlobal$1 = freeGlobal;

    /** Detect free variable `self`. */
    var freeSelf = typeof self == 'object' && self && self.Object === Object && self;

    /** Used as a reference to the global object. */
    var root = freeGlobal$1 || freeSelf || Function('return this')();

    var root$1 = root;

    /** Built-in value references. */
    var Symbol = root$1.Symbol;

    var Symbol$1 = Symbol;

    /** Used for built-in method references. */
    var objectProto$e = Object.prototype;

    /** Used to check objects for own properties. */
    var hasOwnProperty$b = objectProto$e.hasOwnProperty;

    /**
     * Used to resolve the
     * [`toStringTag`](http://ecma-international.org/ecma-262/7.0/#sec-object.prototype.tostring)
     * of values.
     */
    var nativeObjectToString$1 = objectProto$e.toString;

    /** Built-in value references. */
    var symToStringTag$1 = Symbol$1 ? Symbol$1.toStringTag : undefined;

    /**
     * A specialized version of `baseGetTag` which ignores `Symbol.toStringTag` values.
     *
     * @private
     * @param {*} value The value to query.
     * @returns {string} Returns the raw `toStringTag`.
     */
    function getRawTag(value) {
      var isOwn = hasOwnProperty$b.call(value, symToStringTag$1),
          tag = value[symToStringTag$1];

      try {
        value[symToStringTag$1] = undefined;
        var unmasked = true;
      } catch (e) {}

      var result = nativeObjectToString$1.call(value);
      if (unmasked) {
        if (isOwn) {
          value[symToStringTag$1] = tag;
        } else {
          delete value[symToStringTag$1];
        }
      }
      return result;
    }

    /** Used for built-in method references. */
    var objectProto$d = Object.prototype;

    /**
     * Used to resolve the
     * [`toStringTag`](http://ecma-international.org/ecma-262/7.0/#sec-object.prototype.tostring)
     * of values.
     */
    var nativeObjectToString = objectProto$d.toString;

    /**
     * Converts `value` to a string using `Object.prototype.toString`.
     *
     * @private
     * @param {*} value The value to convert.
     * @returns {string} Returns the converted string.
     */
    function objectToString(value) {
      return nativeObjectToString.call(value);
    }

    /** `Object#toString` result references. */
    var nullTag = '[object Null]',
        undefinedTag = '[object Undefined]';

    /** Built-in value references. */
    var symToStringTag = Symbol$1 ? Symbol$1.toStringTag : undefined;

    /**
     * The base implementation of `getTag` without fallbacks for buggy environments.
     *
     * @private
     * @param {*} value The value to query.
     * @returns {string} Returns the `toStringTag`.
     */
    function baseGetTag(value) {
      if (value == null) {
        return value === undefined ? undefinedTag : nullTag;
      }
      return (symToStringTag && symToStringTag in Object(value))
        ? getRawTag(value)
        : objectToString(value);
    }

    /**
     * Checks if `value` is the
     * [language type](http://www.ecma-international.org/ecma-262/7.0/#sec-ecmascript-language-types)
     * of `Object`. (e.g. arrays, functions, objects, regexes, `new Number(0)`, and `new String('')`)
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is an object, else `false`.
     * @example
     *
     * _.isObject({});
     * // => true
     *
     * _.isObject([1, 2, 3]);
     * // => true
     *
     * _.isObject(_.noop);
     * // => true
     *
     * _.isObject(null);
     * // => false
     */
    function isObject(value) {
      var type = typeof value;
      return value != null && (type == 'object' || type == 'function');
    }

    /** `Object#toString` result references. */
    var asyncTag = '[object AsyncFunction]',
        funcTag$2 = '[object Function]',
        genTag$1 = '[object GeneratorFunction]',
        proxyTag = '[object Proxy]';

    /**
     * Checks if `value` is classified as a `Function` object.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a function, else `false`.
     * @example
     *
     * _.isFunction(_);
     * // => true
     *
     * _.isFunction(/abc/);
     * // => false
     */
    function isFunction(value) {
      if (!isObject(value)) {
        return false;
      }
      // The use of `Object#toString` avoids issues with the `typeof` operator
      // in Safari 9 which returns 'object' for typed arrays and other constructors.
      var tag = baseGetTag(value);
      return tag == funcTag$2 || tag == genTag$1 || tag == asyncTag || tag == proxyTag;
    }

    /** Used to detect overreaching core-js shims. */
    var coreJsData = root$1['__core-js_shared__'];

    var coreJsData$1 = coreJsData;

    /** Used to detect methods masquerading as native. */
    var maskSrcKey = (function() {
      var uid = /[^.]+$/.exec(coreJsData$1 && coreJsData$1.keys && coreJsData$1.keys.IE_PROTO || '');
      return uid ? ('Symbol(src)_1.' + uid) : '';
    }());

    /**
     * Checks if `func` has its source masked.
     *
     * @private
     * @param {Function} func The function to check.
     * @returns {boolean} Returns `true` if `func` is masked, else `false`.
     */
    function isMasked(func) {
      return !!maskSrcKey && (maskSrcKey in func);
    }

    /** Used for built-in method references. */
    var funcProto$1 = Function.prototype;

    /** Used to resolve the decompiled source of functions. */
    var funcToString$1 = funcProto$1.toString;

    /**
     * Converts `func` to its source code.
     *
     * @private
     * @param {Function} func The function to convert.
     * @returns {string} Returns the source code.
     */
    function toSource(func) {
      if (func != null) {
        try {
          return funcToString$1.call(func);
        } catch (e) {}
        try {
          return (func + '');
        } catch (e) {}
      }
      return '';
    }

    /**
     * Used to match `RegExp`
     * [syntax characters](http://ecma-international.org/ecma-262/7.0/#sec-patterns).
     */
    var reRegExpChar = /[\\^$.*+?()[\]{}|]/g;

    /** Used to detect host constructors (Safari). */
    var reIsHostCtor = /^\[object .+?Constructor\]$/;

    /** Used for built-in method references. */
    var funcProto = Function.prototype,
        objectProto$c = Object.prototype;

    /** Used to resolve the decompiled source of functions. */
    var funcToString = funcProto.toString;

    /** Used to check objects for own properties. */
    var hasOwnProperty$a = objectProto$c.hasOwnProperty;

    /** Used to detect if a method is native. */
    var reIsNative = RegExp('^' +
      funcToString.call(hasOwnProperty$a).replace(reRegExpChar, '\\$&')
      .replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g, '$1.*?') + '$'
    );

    /**
     * The base implementation of `_.isNative` without bad shim checks.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a native function,
     *  else `false`.
     */
    function baseIsNative(value) {
      if (!isObject(value) || isMasked(value)) {
        return false;
      }
      var pattern = isFunction(value) ? reIsNative : reIsHostCtor;
      return pattern.test(toSource(value));
    }

    /**
     * Gets the value at `key` of `object`.
     *
     * @private
     * @param {Object} [object] The object to query.
     * @param {string} key The key of the property to get.
     * @returns {*} Returns the property value.
     */
    function getValue(object, key) {
      return object == null ? undefined : object[key];
    }

    /**
     * Gets the native function at `key` of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {string} key The key of the method to get.
     * @returns {*} Returns the function if it's native, else `undefined`.
     */
    function getNative(object, key) {
      var value = getValue(object, key);
      return baseIsNative(value) ? value : undefined;
    }

    /* Built-in method references that are verified to be native. */
    var Map$1 = getNative(root$1, 'Map');

    var Map$2 = Map$1;

    /* Built-in method references that are verified to be native. */
    var nativeCreate = getNative(Object, 'create');

    var nativeCreate$1 = nativeCreate;

    /**
     * Removes all key-value entries from the hash.
     *
     * @private
     * @name clear
     * @memberOf Hash
     */
    function hashClear() {
      this.__data__ = nativeCreate$1 ? nativeCreate$1(null) : {};
      this.size = 0;
    }

    /**
     * Removes `key` and its value from the hash.
     *
     * @private
     * @name delete
     * @memberOf Hash
     * @param {Object} hash The hash to modify.
     * @param {string} key The key of the value to remove.
     * @returns {boolean} Returns `true` if the entry was removed, else `false`.
     */
    function hashDelete(key) {
      var result = this.has(key) && delete this.__data__[key];
      this.size -= result ? 1 : 0;
      return result;
    }

    /** Used to stand-in for `undefined` hash values. */
    var HASH_UNDEFINED$2 = '__lodash_hash_undefined__';

    /** Used for built-in method references. */
    var objectProto$b = Object.prototype;

    /** Used to check objects for own properties. */
    var hasOwnProperty$9 = objectProto$b.hasOwnProperty;

    /**
     * Gets the hash value for `key`.
     *
     * @private
     * @name get
     * @memberOf Hash
     * @param {string} key The key of the value to get.
     * @returns {*} Returns the entry value.
     */
    function hashGet(key) {
      var data = this.__data__;
      if (nativeCreate$1) {
        var result = data[key];
        return result === HASH_UNDEFINED$2 ? undefined : result;
      }
      return hasOwnProperty$9.call(data, key) ? data[key] : undefined;
    }

    /** Used for built-in method references. */
    var objectProto$a = Object.prototype;

    /** Used to check objects for own properties. */
    var hasOwnProperty$8 = objectProto$a.hasOwnProperty;

    /**
     * Checks if a hash value for `key` exists.
     *
     * @private
     * @name has
     * @memberOf Hash
     * @param {string} key The key of the entry to check.
     * @returns {boolean} Returns `true` if an entry for `key` exists, else `false`.
     */
    function hashHas(key) {
      var data = this.__data__;
      return nativeCreate$1 ? (data[key] !== undefined) : hasOwnProperty$8.call(data, key);
    }

    /** Used to stand-in for `undefined` hash values. */
    var HASH_UNDEFINED$1 = '__lodash_hash_undefined__';

    /**
     * Sets the hash `key` to `value`.
     *
     * @private
     * @name set
     * @memberOf Hash
     * @param {string} key The key of the value to set.
     * @param {*} value The value to set.
     * @returns {Object} Returns the hash instance.
     */
    function hashSet(key, value) {
      var data = this.__data__;
      this.size += this.has(key) ? 0 : 1;
      data[key] = (nativeCreate$1 && value === undefined) ? HASH_UNDEFINED$1 : value;
      return this;
    }

    /**
     * Creates a hash object.
     *
     * @private
     * @constructor
     * @param {Array} [entries] The key-value pairs to cache.
     */
    function Hash(entries) {
      var index = -1,
          length = entries == null ? 0 : entries.length;

      this.clear();
      while (++index < length) {
        var entry = entries[index];
        this.set(entry[0], entry[1]);
      }
    }

    // Add methods to `Hash`.
    Hash.prototype.clear = hashClear;
    Hash.prototype['delete'] = hashDelete;
    Hash.prototype.get = hashGet;
    Hash.prototype.has = hashHas;
    Hash.prototype.set = hashSet;

    /**
     * Removes all key-value entries from the map.
     *
     * @private
     * @name clear
     * @memberOf MapCache
     */
    function mapCacheClear() {
      this.size = 0;
      this.__data__ = {
        'hash': new Hash,
        'map': new (Map$2 || ListCache),
        'string': new Hash
      };
    }

    /**
     * Checks if `value` is suitable for use as unique object key.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is suitable, else `false`.
     */
    function isKeyable(value) {
      var type = typeof value;
      return (type == 'string' || type == 'number' || type == 'symbol' || type == 'boolean')
        ? (value !== '__proto__')
        : (value === null);
    }

    /**
     * Gets the data for `map`.
     *
     * @private
     * @param {Object} map The map to query.
     * @param {string} key The reference key.
     * @returns {*} Returns the map data.
     */
    function getMapData(map, key) {
      var data = map.__data__;
      return isKeyable(key)
        ? data[typeof key == 'string' ? 'string' : 'hash']
        : data.map;
    }

    /**
     * Removes `key` and its value from the map.
     *
     * @private
     * @name delete
     * @memberOf MapCache
     * @param {string} key The key of the value to remove.
     * @returns {boolean} Returns `true` if the entry was removed, else `false`.
     */
    function mapCacheDelete(key) {
      var result = getMapData(this, key)['delete'](key);
      this.size -= result ? 1 : 0;
      return result;
    }

    /**
     * Gets the map value for `key`.
     *
     * @private
     * @name get
     * @memberOf MapCache
     * @param {string} key The key of the value to get.
     * @returns {*} Returns the entry value.
     */
    function mapCacheGet(key) {
      return getMapData(this, key).get(key);
    }

    /**
     * Checks if a map value for `key` exists.
     *
     * @private
     * @name has
     * @memberOf MapCache
     * @param {string} key The key of the entry to check.
     * @returns {boolean} Returns `true` if an entry for `key` exists, else `false`.
     */
    function mapCacheHas(key) {
      return getMapData(this, key).has(key);
    }

    /**
     * Sets the map `key` to `value`.
     *
     * @private
     * @name set
     * @memberOf MapCache
     * @param {string} key The key of the value to set.
     * @param {*} value The value to set.
     * @returns {Object} Returns the map cache instance.
     */
    function mapCacheSet(key, value) {
      var data = getMapData(this, key),
          size = data.size;

      data.set(key, value);
      this.size += data.size == size ? 0 : 1;
      return this;
    }

    /**
     * Creates a map cache object to store key-value pairs.
     *
     * @private
     * @constructor
     * @param {Array} [entries] The key-value pairs to cache.
     */
    function MapCache(entries) {
      var index = -1,
          length = entries == null ? 0 : entries.length;

      this.clear();
      while (++index < length) {
        var entry = entries[index];
        this.set(entry[0], entry[1]);
      }
    }

    // Add methods to `MapCache`.
    MapCache.prototype.clear = mapCacheClear;
    MapCache.prototype['delete'] = mapCacheDelete;
    MapCache.prototype.get = mapCacheGet;
    MapCache.prototype.has = mapCacheHas;
    MapCache.prototype.set = mapCacheSet;

    /** Used as the size to enable large array optimizations. */
    var LARGE_ARRAY_SIZE = 200;

    /**
     * Sets the stack `key` to `value`.
     *
     * @private
     * @name set
     * @memberOf Stack
     * @param {string} key The key of the value to set.
     * @param {*} value The value to set.
     * @returns {Object} Returns the stack cache instance.
     */
    function stackSet(key, value) {
      var data = this.__data__;
      if (data instanceof ListCache) {
        var pairs = data.__data__;
        if (!Map$2 || (pairs.length < LARGE_ARRAY_SIZE - 1)) {
          pairs.push([key, value]);
          this.size = ++data.size;
          return this;
        }
        data = this.__data__ = new MapCache(pairs);
      }
      data.set(key, value);
      this.size = data.size;
      return this;
    }

    /**
     * Creates a stack cache object to store key-value pairs.
     *
     * @private
     * @constructor
     * @param {Array} [entries] The key-value pairs to cache.
     */
    function Stack(entries) {
      var data = this.__data__ = new ListCache(entries);
      this.size = data.size;
    }

    // Add methods to `Stack`.
    Stack.prototype.clear = stackClear;
    Stack.prototype['delete'] = stackDelete;
    Stack.prototype.get = stackGet;
    Stack.prototype.has = stackHas;
    Stack.prototype.set = stackSet;

    /** Used to stand-in for `undefined` hash values. */
    var HASH_UNDEFINED = '__lodash_hash_undefined__';

    /**
     * Adds `value` to the array cache.
     *
     * @private
     * @name add
     * @memberOf SetCache
     * @alias push
     * @param {*} value The value to cache.
     * @returns {Object} Returns the cache instance.
     */
    function setCacheAdd(value) {
      this.__data__.set(value, HASH_UNDEFINED);
      return this;
    }

    /**
     * Checks if `value` is in the array cache.
     *
     * @private
     * @name has
     * @memberOf SetCache
     * @param {*} value The value to search for.
     * @returns {number} Returns `true` if `value` is found, else `false`.
     */
    function setCacheHas(value) {
      return this.__data__.has(value);
    }

    /**
     *
     * Creates an array cache object to store unique values.
     *
     * @private
     * @constructor
     * @param {Array} [values] The values to cache.
     */
    function SetCache(values) {
      var index = -1,
          length = values == null ? 0 : values.length;

      this.__data__ = new MapCache;
      while (++index < length) {
        this.add(values[index]);
      }
    }

    // Add methods to `SetCache`.
    SetCache.prototype.add = SetCache.prototype.push = setCacheAdd;
    SetCache.prototype.has = setCacheHas;

    /**
     * A specialized version of `_.some` for arrays without support for iteratee
     * shorthands.
     *
     * @private
     * @param {Array} [array] The array to iterate over.
     * @param {Function} predicate The function invoked per iteration.
     * @returns {boolean} Returns `true` if any element passes the predicate check,
     *  else `false`.
     */
    function arraySome(array, predicate) {
      var index = -1,
          length = array == null ? 0 : array.length;

      while (++index < length) {
        if (predicate(array[index], index, array)) {
          return true;
        }
      }
      return false;
    }

    /**
     * Checks if a `cache` value for `key` exists.
     *
     * @private
     * @param {Object} cache The cache to query.
     * @param {string} key The key of the entry to check.
     * @returns {boolean} Returns `true` if an entry for `key` exists, else `false`.
     */
    function cacheHas(cache, key) {
      return cache.has(key);
    }

    /** Used to compose bitmasks for value comparisons. */
    var COMPARE_PARTIAL_FLAG$3 = 1,
        COMPARE_UNORDERED_FLAG$1 = 2;

    /**
     * A specialized version of `baseIsEqualDeep` for arrays with support for
     * partial deep comparisons.
     *
     * @private
     * @param {Array} array The array to compare.
     * @param {Array} other The other array to compare.
     * @param {number} bitmask The bitmask flags. See `baseIsEqual` for more details.
     * @param {Function} customizer The function to customize comparisons.
     * @param {Function} equalFunc The function to determine equivalents of values.
     * @param {Object} stack Tracks traversed `array` and `other` objects.
     * @returns {boolean} Returns `true` if the arrays are equivalent, else `false`.
     */
    function equalArrays(array, other, bitmask, customizer, equalFunc, stack) {
      var isPartial = bitmask & COMPARE_PARTIAL_FLAG$3,
          arrLength = array.length,
          othLength = other.length;

      if (arrLength != othLength && !(isPartial && othLength > arrLength)) {
        return false;
      }
      // Check that cyclic values are equal.
      var arrStacked = stack.get(array);
      var othStacked = stack.get(other);
      if (arrStacked && othStacked) {
        return arrStacked == other && othStacked == array;
      }
      var index = -1,
          result = true,
          seen = (bitmask & COMPARE_UNORDERED_FLAG$1) ? new SetCache : undefined;

      stack.set(array, other);
      stack.set(other, array);

      // Ignore non-index properties.
      while (++index < arrLength) {
        var arrValue = array[index],
            othValue = other[index];

        if (customizer) {
          var compared = isPartial
            ? customizer(othValue, arrValue, index, other, array, stack)
            : customizer(arrValue, othValue, index, array, other, stack);
        }
        if (compared !== undefined) {
          if (compared) {
            continue;
          }
          result = false;
          break;
        }
        // Recursively compare arrays (susceptible to call stack limits).
        if (seen) {
          if (!arraySome(other, function(othValue, othIndex) {
                if (!cacheHas(seen, othIndex) &&
                    (arrValue === othValue || equalFunc(arrValue, othValue, bitmask, customizer, stack))) {
                  return seen.push(othIndex);
                }
              })) {
            result = false;
            break;
          }
        } else if (!(
              arrValue === othValue ||
                equalFunc(arrValue, othValue, bitmask, customizer, stack)
            )) {
          result = false;
          break;
        }
      }
      stack['delete'](array);
      stack['delete'](other);
      return result;
    }

    /** Built-in value references. */
    var Uint8Array = root$1.Uint8Array;

    var Uint8Array$1 = Uint8Array;

    /**
     * Converts `map` to its key-value pairs.
     *
     * @private
     * @param {Object} map The map to convert.
     * @returns {Array} Returns the key-value pairs.
     */
    function mapToArray(map) {
      var index = -1,
          result = Array(map.size);

      map.forEach(function(value, key) {
        result[++index] = [key, value];
      });
      return result;
    }

    /**
     * Converts `set` to an array of its values.
     *
     * @private
     * @param {Object} set The set to convert.
     * @returns {Array} Returns the values.
     */
    function setToArray(set) {
      var index = -1,
          result = Array(set.size);

      set.forEach(function(value) {
        result[++index] = value;
      });
      return result;
    }

    /** Used to compose bitmasks for value comparisons. */
    var COMPARE_PARTIAL_FLAG$2 = 1,
        COMPARE_UNORDERED_FLAG = 2;

    /** `Object#toString` result references. */
    var boolTag$3 = '[object Boolean]',
        dateTag$3 = '[object Date]',
        errorTag$2 = '[object Error]',
        mapTag$5 = '[object Map]',
        numberTag$3 = '[object Number]',
        regexpTag$3 = '[object RegExp]',
        setTag$5 = '[object Set]',
        stringTag$3 = '[object String]',
        symbolTag$2 = '[object Symbol]';

    var arrayBufferTag$3 = '[object ArrayBuffer]',
        dataViewTag$4 = '[object DataView]';

    /** Used to convert symbols to primitives and strings. */
    var symbolProto$1 = Symbol$1 ? Symbol$1.prototype : undefined,
        symbolValueOf$1 = symbolProto$1 ? symbolProto$1.valueOf : undefined;

    /**
     * A specialized version of `baseIsEqualDeep` for comparing objects of
     * the same `toStringTag`.
     *
     * **Note:** This function only supports comparing values with tags of
     * `Boolean`, `Date`, `Error`, `Number`, `RegExp`, or `String`.
     *
     * @private
     * @param {Object} object The object to compare.
     * @param {Object} other The other object to compare.
     * @param {string} tag The `toStringTag` of the objects to compare.
     * @param {number} bitmask The bitmask flags. See `baseIsEqual` for more details.
     * @param {Function} customizer The function to customize comparisons.
     * @param {Function} equalFunc The function to determine equivalents of values.
     * @param {Object} stack Tracks traversed `object` and `other` objects.
     * @returns {boolean} Returns `true` if the objects are equivalent, else `false`.
     */
    function equalByTag(object, other, tag, bitmask, customizer, equalFunc, stack) {
      switch (tag) {
        case dataViewTag$4:
          if ((object.byteLength != other.byteLength) ||
              (object.byteOffset != other.byteOffset)) {
            return false;
          }
          object = object.buffer;
          other = other.buffer;

        case arrayBufferTag$3:
          if ((object.byteLength != other.byteLength) ||
              !equalFunc(new Uint8Array$1(object), new Uint8Array$1(other))) {
            return false;
          }
          return true;

        case boolTag$3:
        case dateTag$3:
        case numberTag$3:
          // Coerce booleans to `1` or `0` and dates to milliseconds.
          // Invalid dates are coerced to `NaN`.
          return eq(+object, +other);

        case errorTag$2:
          return object.name == other.name && object.message == other.message;

        case regexpTag$3:
        case stringTag$3:
          // Coerce regexes to strings and treat strings, primitives and objects,
          // as equal. See http://www.ecma-international.org/ecma-262/7.0/#sec-regexp.prototype.tostring
          // for more details.
          return object == (other + '');

        case mapTag$5:
          var convert = mapToArray;

        case setTag$5:
          var isPartial = bitmask & COMPARE_PARTIAL_FLAG$2;
          convert || (convert = setToArray);

          if (object.size != other.size && !isPartial) {
            return false;
          }
          // Assume cyclic values are equal.
          var stacked = stack.get(object);
          if (stacked) {
            return stacked == other;
          }
          bitmask |= COMPARE_UNORDERED_FLAG;

          // Recursively compare objects (susceptible to call stack limits).
          stack.set(object, other);
          var result = equalArrays(convert(object), convert(other), bitmask, customizer, equalFunc, stack);
          stack['delete'](object);
          return result;

        case symbolTag$2:
          if (symbolValueOf$1) {
            return symbolValueOf$1.call(object) == symbolValueOf$1.call(other);
          }
      }
      return false;
    }

    /**
     * Appends the elements of `values` to `array`.
     *
     * @private
     * @param {Array} array The array to modify.
     * @param {Array} values The values to append.
     * @returns {Array} Returns `array`.
     */
    function arrayPush(array, values) {
      var index = -1,
          length = values.length,
          offset = array.length;

      while (++index < length) {
        array[offset + index] = values[index];
      }
      return array;
    }

    /**
     * Checks if `value` is classified as an `Array` object.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is an array, else `false`.
     * @example
     *
     * _.isArray([1, 2, 3]);
     * // => true
     *
     * _.isArray(document.body.children);
     * // => false
     *
     * _.isArray('abc');
     * // => false
     *
     * _.isArray(_.noop);
     * // => false
     */
    var isArray = Array.isArray;

    var isArray$1 = isArray;

    /**
     * The base implementation of `getAllKeys` and `getAllKeysIn` which uses
     * `keysFunc` and `symbolsFunc` to get the enumerable property names and
     * symbols of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @param {Function} keysFunc The function to get the keys of `object`.
     * @param {Function} symbolsFunc The function to get the symbols of `object`.
     * @returns {Array} Returns the array of property names and symbols.
     */
    function baseGetAllKeys(object, keysFunc, symbolsFunc) {
      var result = keysFunc(object);
      return isArray$1(object) ? result : arrayPush(result, symbolsFunc(object));
    }

    /**
     * A specialized version of `_.filter` for arrays without support for
     * iteratee shorthands.
     *
     * @private
     * @param {Array} [array] The array to iterate over.
     * @param {Function} predicate The function invoked per iteration.
     * @returns {Array} Returns the new filtered array.
     */
    function arrayFilter(array, predicate) {
      var index = -1,
          length = array == null ? 0 : array.length,
          resIndex = 0,
          result = [];

      while (++index < length) {
        var value = array[index];
        if (predicate(value, index, array)) {
          result[resIndex++] = value;
        }
      }
      return result;
    }

    /**
     * This method returns a new empty array.
     *
     * @static
     * @memberOf _
     * @since 4.13.0
     * @category Util
     * @returns {Array} Returns the new empty array.
     * @example
     *
     * var arrays = _.times(2, _.stubArray);
     *
     * console.log(arrays);
     * // => [[], []]
     *
     * console.log(arrays[0] === arrays[1]);
     * // => false
     */
    function stubArray() {
      return [];
    }

    /** Used for built-in method references. */
    var objectProto$9 = Object.prototype;

    /** Built-in value references. */
    var propertyIsEnumerable$1 = objectProto$9.propertyIsEnumerable;

    /* Built-in method references for those with the same name as other `lodash` methods. */
    var nativeGetSymbols$1 = Object.getOwnPropertySymbols;

    /**
     * Creates an array of the own enumerable symbols of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of symbols.
     */
    var getSymbols = !nativeGetSymbols$1 ? stubArray : function(object) {
      if (object == null) {
        return [];
      }
      object = Object(object);
      return arrayFilter(nativeGetSymbols$1(object), function(symbol) {
        return propertyIsEnumerable$1.call(object, symbol);
      });
    };

    var getSymbols$1 = getSymbols;

    /**
     * The base implementation of `_.times` without support for iteratee shorthands
     * or max array length checks.
     *
     * @private
     * @param {number} n The number of times to invoke `iteratee`.
     * @param {Function} iteratee The function invoked per iteration.
     * @returns {Array} Returns the array of results.
     */
    function baseTimes(n, iteratee) {
      var index = -1,
          result = Array(n);

      while (++index < n) {
        result[index] = iteratee(index);
      }
      return result;
    }

    /**
     * Checks if `value` is object-like. A value is object-like if it's not `null`
     * and has a `typeof` result of "object".
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is object-like, else `false`.
     * @example
     *
     * _.isObjectLike({});
     * // => true
     *
     * _.isObjectLike([1, 2, 3]);
     * // => true
     *
     * _.isObjectLike(_.noop);
     * // => false
     *
     * _.isObjectLike(null);
     * // => false
     */
    function isObjectLike(value) {
      return value != null && typeof value == 'object';
    }

    /** `Object#toString` result references. */
    var argsTag$3 = '[object Arguments]';

    /**
     * The base implementation of `_.isArguments`.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is an `arguments` object,
     */
    function baseIsArguments(value) {
      return isObjectLike(value) && baseGetTag(value) == argsTag$3;
    }

    /** Used for built-in method references. */
    var objectProto$8 = Object.prototype;

    /** Used to check objects for own properties. */
    var hasOwnProperty$7 = objectProto$8.hasOwnProperty;

    /** Built-in value references. */
    var propertyIsEnumerable = objectProto$8.propertyIsEnumerable;

    /**
     * Checks if `value` is likely an `arguments` object.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is an `arguments` object,
     *  else `false`.
     * @example
     *
     * _.isArguments(function() { return arguments; }());
     * // => true
     *
     * _.isArguments([1, 2, 3]);
     * // => false
     */
    var isArguments = baseIsArguments(function() { return arguments; }()) ? baseIsArguments : function(value) {
      return isObjectLike(value) && hasOwnProperty$7.call(value, 'callee') &&
        !propertyIsEnumerable.call(value, 'callee');
    };

    var isArguments$1 = isArguments;

    /**
     * This method returns `false`.
     *
     * @static
     * @memberOf _
     * @since 4.13.0
     * @category Util
     * @returns {boolean} Returns `false`.
     * @example
     *
     * _.times(2, _.stubFalse);
     * // => [false, false]
     */
    function stubFalse() {
      return false;
    }

    /** Detect free variable `exports`. */
    var freeExports$2 = typeof exports == 'object' && exports && !exports.nodeType && exports;

    /** Detect free variable `module`. */
    var freeModule$2 = freeExports$2 && typeof module == 'object' && module && !module.nodeType && module;

    /** Detect the popular CommonJS extension `module.exports`. */
    var moduleExports$2 = freeModule$2 && freeModule$2.exports === freeExports$2;

    /** Built-in value references. */
    var Buffer$1 = moduleExports$2 ? root$1.Buffer : undefined;

    /* Built-in method references for those with the same name as other `lodash` methods. */
    var nativeIsBuffer = Buffer$1 ? Buffer$1.isBuffer : undefined;

    /**
     * Checks if `value` is a buffer.
     *
     * @static
     * @memberOf _
     * @since 4.3.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a buffer, else `false`.
     * @example
     *
     * _.isBuffer(new Buffer(2));
     * // => true
     *
     * _.isBuffer(new Uint8Array(2));
     * // => false
     */
    var isBuffer = nativeIsBuffer || stubFalse;

    var isBuffer$1 = isBuffer;

    /** Used as references for various `Number` constants. */
    var MAX_SAFE_INTEGER$1 = 9007199254740991;

    /** Used to detect unsigned integer values. */
    var reIsUint = /^(?:0|[1-9]\d*)$/;

    /**
     * Checks if `value` is a valid array-like index.
     *
     * @private
     * @param {*} value The value to check.
     * @param {number} [length=MAX_SAFE_INTEGER] The upper bounds of a valid index.
     * @returns {boolean} Returns `true` if `value` is a valid index, else `false`.
     */
    function isIndex(value, length) {
      var type = typeof value;
      length = length == null ? MAX_SAFE_INTEGER$1 : length;

      return !!length &&
        (type == 'number' ||
          (type != 'symbol' && reIsUint.test(value))) &&
            (value > -1 && value % 1 == 0 && value < length);
    }

    /** Used as references for various `Number` constants. */
    var MAX_SAFE_INTEGER = 9007199254740991;

    /**
     * Checks if `value` is a valid array-like length.
     *
     * **Note:** This method is loosely based on
     * [`ToLength`](http://ecma-international.org/ecma-262/7.0/#sec-tolength).
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a valid length, else `false`.
     * @example
     *
     * _.isLength(3);
     * // => true
     *
     * _.isLength(Number.MIN_VALUE);
     * // => false
     *
     * _.isLength(Infinity);
     * // => false
     *
     * _.isLength('3');
     * // => false
     */
    function isLength(value) {
      return typeof value == 'number' &&
        value > -1 && value % 1 == 0 && value <= MAX_SAFE_INTEGER;
    }

    /** `Object#toString` result references. */
    var argsTag$2 = '[object Arguments]',
        arrayTag$2 = '[object Array]',
        boolTag$2 = '[object Boolean]',
        dateTag$2 = '[object Date]',
        errorTag$1 = '[object Error]',
        funcTag$1 = '[object Function]',
        mapTag$4 = '[object Map]',
        numberTag$2 = '[object Number]',
        objectTag$3 = '[object Object]',
        regexpTag$2 = '[object RegExp]',
        setTag$4 = '[object Set]',
        stringTag$2 = '[object String]',
        weakMapTag$2 = '[object WeakMap]';

    var arrayBufferTag$2 = '[object ArrayBuffer]',
        dataViewTag$3 = '[object DataView]',
        float32Tag$2 = '[object Float32Array]',
        float64Tag$2 = '[object Float64Array]',
        int8Tag$2 = '[object Int8Array]',
        int16Tag$2 = '[object Int16Array]',
        int32Tag$2 = '[object Int32Array]',
        uint8Tag$2 = '[object Uint8Array]',
        uint8ClampedTag$2 = '[object Uint8ClampedArray]',
        uint16Tag$2 = '[object Uint16Array]',
        uint32Tag$2 = '[object Uint32Array]';

    /** Used to identify `toStringTag` values of typed arrays. */
    var typedArrayTags = {};
    typedArrayTags[float32Tag$2] = typedArrayTags[float64Tag$2] =
    typedArrayTags[int8Tag$2] = typedArrayTags[int16Tag$2] =
    typedArrayTags[int32Tag$2] = typedArrayTags[uint8Tag$2] =
    typedArrayTags[uint8ClampedTag$2] = typedArrayTags[uint16Tag$2] =
    typedArrayTags[uint32Tag$2] = true;
    typedArrayTags[argsTag$2] = typedArrayTags[arrayTag$2] =
    typedArrayTags[arrayBufferTag$2] = typedArrayTags[boolTag$2] =
    typedArrayTags[dataViewTag$3] = typedArrayTags[dateTag$2] =
    typedArrayTags[errorTag$1] = typedArrayTags[funcTag$1] =
    typedArrayTags[mapTag$4] = typedArrayTags[numberTag$2] =
    typedArrayTags[objectTag$3] = typedArrayTags[regexpTag$2] =
    typedArrayTags[setTag$4] = typedArrayTags[stringTag$2] =
    typedArrayTags[weakMapTag$2] = false;

    /**
     * The base implementation of `_.isTypedArray` without Node.js optimizations.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a typed array, else `false`.
     */
    function baseIsTypedArray(value) {
      return isObjectLike(value) &&
        isLength(value.length) && !!typedArrayTags[baseGetTag(value)];
    }

    /**
     * The base implementation of `_.unary` without support for storing metadata.
     *
     * @private
     * @param {Function} func The function to cap arguments for.
     * @returns {Function} Returns the new capped function.
     */
    function baseUnary(func) {
      return function(value) {
        return func(value);
      };
    }

    /** Detect free variable `exports`. */
    var freeExports$1 = typeof exports == 'object' && exports && !exports.nodeType && exports;

    /** Detect free variable `module`. */
    var freeModule$1 = freeExports$1 && typeof module == 'object' && module && !module.nodeType && module;

    /** Detect the popular CommonJS extension `module.exports`. */
    var moduleExports$1 = freeModule$1 && freeModule$1.exports === freeExports$1;

    /** Detect free variable `process` from Node.js. */
    var freeProcess = moduleExports$1 && freeGlobal$1.process;

    /** Used to access faster Node.js helpers. */
    var nodeUtil = (function() {
      try {
        // Use `util.types` for Node.js 10+.
        var types = freeModule$1 && freeModule$1.require && freeModule$1.require('util').types;

        if (types) {
          return types;
        }

        // Legacy `process.binding('util')` for Node.js < 10.
        return freeProcess && freeProcess.binding && freeProcess.binding('util');
      } catch (e) {}
    }());

    var nodeUtil$1 = nodeUtil;

    /* Node.js helper references. */
    var nodeIsTypedArray = nodeUtil$1 && nodeUtil$1.isTypedArray;

    /**
     * Checks if `value` is classified as a typed array.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a typed array, else `false`.
     * @example
     *
     * _.isTypedArray(new Uint8Array);
     * // => true
     *
     * _.isTypedArray([]);
     * // => false
     */
    var isTypedArray = nodeIsTypedArray ? baseUnary(nodeIsTypedArray) : baseIsTypedArray;

    var isTypedArray$1 = isTypedArray;

    /** Used for built-in method references. */
    var objectProto$7 = Object.prototype;

    /** Used to check objects for own properties. */
    var hasOwnProperty$6 = objectProto$7.hasOwnProperty;

    /**
     * Creates an array of the enumerable property names of the array-like `value`.
     *
     * @private
     * @param {*} value The value to query.
     * @param {boolean} inherited Specify returning inherited property names.
     * @returns {Array} Returns the array of property names.
     */
    function arrayLikeKeys(value, inherited) {
      var isArr = isArray$1(value),
          isArg = !isArr && isArguments$1(value),
          isBuff = !isArr && !isArg && isBuffer$1(value),
          isType = !isArr && !isArg && !isBuff && isTypedArray$1(value),
          skipIndexes = isArr || isArg || isBuff || isType,
          result = skipIndexes ? baseTimes(value.length, String) : [],
          length = result.length;

      for (var key in value) {
        if ((inherited || hasOwnProperty$6.call(value, key)) &&
            !(skipIndexes && (
               // Safari 9 has enumerable `arguments.length` in strict mode.
               key == 'length' ||
               // Node.js 0.10 has enumerable non-index properties on buffers.
               (isBuff && (key == 'offset' || key == 'parent')) ||
               // PhantomJS 2 has enumerable non-index properties on typed arrays.
               (isType && (key == 'buffer' || key == 'byteLength' || key == 'byteOffset')) ||
               // Skip index properties.
               isIndex(key, length)
            ))) {
          result.push(key);
        }
      }
      return result;
    }

    /** Used for built-in method references. */
    var objectProto$6 = Object.prototype;

    /**
     * Checks if `value` is likely a prototype object.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a prototype, else `false`.
     */
    function isPrototype(value) {
      var Ctor = value && value.constructor,
          proto = (typeof Ctor == 'function' && Ctor.prototype) || objectProto$6;

      return value === proto;
    }

    /**
     * Creates a unary function that invokes `func` with its argument transformed.
     *
     * @private
     * @param {Function} func The function to wrap.
     * @param {Function} transform The argument transform.
     * @returns {Function} Returns the new function.
     */
    function overArg(func, transform) {
      return function(arg) {
        return func(transform(arg));
      };
    }

    /* Built-in method references for those with the same name as other `lodash` methods. */
    var nativeKeys = overArg(Object.keys, Object);

    var nativeKeys$1 = nativeKeys;

    /** Used for built-in method references. */
    var objectProto$5 = Object.prototype;

    /** Used to check objects for own properties. */
    var hasOwnProperty$5 = objectProto$5.hasOwnProperty;

    /**
     * The base implementation of `_.keys` which doesn't treat sparse arrays as dense.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names.
     */
    function baseKeys(object) {
      if (!isPrototype(object)) {
        return nativeKeys$1(object);
      }
      var result = [];
      for (var key in Object(object)) {
        if (hasOwnProperty$5.call(object, key) && key != 'constructor') {
          result.push(key);
        }
      }
      return result;
    }

    /**
     * Checks if `value` is array-like. A value is considered array-like if it's
     * not a function and has a `value.length` that's an integer greater than or
     * equal to `0` and less than or equal to `Number.MAX_SAFE_INTEGER`.
     *
     * @static
     * @memberOf _
     * @since 4.0.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is array-like, else `false`.
     * @example
     *
     * _.isArrayLike([1, 2, 3]);
     * // => true
     *
     * _.isArrayLike(document.body.children);
     * // => true
     *
     * _.isArrayLike('abc');
     * // => true
     *
     * _.isArrayLike(_.noop);
     * // => false
     */
    function isArrayLike(value) {
      return value != null && isLength(value.length) && !isFunction(value);
    }

    /**
     * Creates an array of the own enumerable property names of `object`.
     *
     * **Note:** Non-object values are coerced to objects. See the
     * [ES spec](http://ecma-international.org/ecma-262/7.0/#sec-object.keys)
     * for more details.
     *
     * @static
     * @since 0.1.0
     * @memberOf _
     * @category Object
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.keys(new Foo);
     * // => ['a', 'b'] (iteration order is not guaranteed)
     *
     * _.keys('hi');
     * // => ['0', '1']
     */
    function keys(object) {
      return isArrayLike(object) ? arrayLikeKeys(object) : baseKeys(object);
    }

    /**
     * Creates an array of own enumerable property names and symbols of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names and symbols.
     */
    function getAllKeys(object) {
      return baseGetAllKeys(object, keys, getSymbols$1);
    }

    /** Used to compose bitmasks for value comparisons. */
    var COMPARE_PARTIAL_FLAG$1 = 1;

    /** Used for built-in method references. */
    var objectProto$4 = Object.prototype;

    /** Used to check objects for own properties. */
    var hasOwnProperty$4 = objectProto$4.hasOwnProperty;

    /**
     * A specialized version of `baseIsEqualDeep` for objects with support for
     * partial deep comparisons.
     *
     * @private
     * @param {Object} object The object to compare.
     * @param {Object} other The other object to compare.
     * @param {number} bitmask The bitmask flags. See `baseIsEqual` for more details.
     * @param {Function} customizer The function to customize comparisons.
     * @param {Function} equalFunc The function to determine equivalents of values.
     * @param {Object} stack Tracks traversed `object` and `other` objects.
     * @returns {boolean} Returns `true` if the objects are equivalent, else `false`.
     */
    function equalObjects(object, other, bitmask, customizer, equalFunc, stack) {
      var isPartial = bitmask & COMPARE_PARTIAL_FLAG$1,
          objProps = getAllKeys(object),
          objLength = objProps.length,
          othProps = getAllKeys(other),
          othLength = othProps.length;

      if (objLength != othLength && !isPartial) {
        return false;
      }
      var index = objLength;
      while (index--) {
        var key = objProps[index];
        if (!(isPartial ? key in other : hasOwnProperty$4.call(other, key))) {
          return false;
        }
      }
      // Check that cyclic values are equal.
      var objStacked = stack.get(object);
      var othStacked = stack.get(other);
      if (objStacked && othStacked) {
        return objStacked == other && othStacked == object;
      }
      var result = true;
      stack.set(object, other);
      stack.set(other, object);

      var skipCtor = isPartial;
      while (++index < objLength) {
        key = objProps[index];
        var objValue = object[key],
            othValue = other[key];

        if (customizer) {
          var compared = isPartial
            ? customizer(othValue, objValue, key, other, object, stack)
            : customizer(objValue, othValue, key, object, other, stack);
        }
        // Recursively compare objects (susceptible to call stack limits).
        if (!(compared === undefined
              ? (objValue === othValue || equalFunc(objValue, othValue, bitmask, customizer, stack))
              : compared
            )) {
          result = false;
          break;
        }
        skipCtor || (skipCtor = key == 'constructor');
      }
      if (result && !skipCtor) {
        var objCtor = object.constructor,
            othCtor = other.constructor;

        // Non `Object` object instances with different constructors are not equal.
        if (objCtor != othCtor &&
            ('constructor' in object && 'constructor' in other) &&
            !(typeof objCtor == 'function' && objCtor instanceof objCtor &&
              typeof othCtor == 'function' && othCtor instanceof othCtor)) {
          result = false;
        }
      }
      stack['delete'](object);
      stack['delete'](other);
      return result;
    }

    /* Built-in method references that are verified to be native. */
    var DataView = getNative(root$1, 'DataView');

    var DataView$1 = DataView;

    /* Built-in method references that are verified to be native. */
    var Promise$1 = getNative(root$1, 'Promise');

    var Promise$2 = Promise$1;

    /* Built-in method references that are verified to be native. */
    var Set$1 = getNative(root$1, 'Set');

    var Set$2 = Set$1;

    /* Built-in method references that are verified to be native. */
    var WeakMap = getNative(root$1, 'WeakMap');

    var WeakMap$1 = WeakMap;

    /** `Object#toString` result references. */
    var mapTag$3 = '[object Map]',
        objectTag$2 = '[object Object]',
        promiseTag = '[object Promise]',
        setTag$3 = '[object Set]',
        weakMapTag$1 = '[object WeakMap]';

    var dataViewTag$2 = '[object DataView]';

    /** Used to detect maps, sets, and weakmaps. */
    var dataViewCtorString = toSource(DataView$1),
        mapCtorString = toSource(Map$2),
        promiseCtorString = toSource(Promise$2),
        setCtorString = toSource(Set$2),
        weakMapCtorString = toSource(WeakMap$1);

    /**
     * Gets the `toStringTag` of `value`.
     *
     * @private
     * @param {*} value The value to query.
     * @returns {string} Returns the `toStringTag`.
     */
    var getTag = baseGetTag;

    // Fallback for data views, maps, sets, and weak maps in IE 11 and promises in Node.js < 6.
    if ((DataView$1 && getTag(new DataView$1(new ArrayBuffer(1))) != dataViewTag$2) ||
        (Map$2 && getTag(new Map$2) != mapTag$3) ||
        (Promise$2 && getTag(Promise$2.resolve()) != promiseTag) ||
        (Set$2 && getTag(new Set$2) != setTag$3) ||
        (WeakMap$1 && getTag(new WeakMap$1) != weakMapTag$1)) {
      getTag = function(value) {
        var result = baseGetTag(value),
            Ctor = result == objectTag$2 ? value.constructor : undefined,
            ctorString = Ctor ? toSource(Ctor) : '';

        if (ctorString) {
          switch (ctorString) {
            case dataViewCtorString: return dataViewTag$2;
            case mapCtorString: return mapTag$3;
            case promiseCtorString: return promiseTag;
            case setCtorString: return setTag$3;
            case weakMapCtorString: return weakMapTag$1;
          }
        }
        return result;
      };
    }

    var getTag$1 = getTag;

    /** Used to compose bitmasks for value comparisons. */
    var COMPARE_PARTIAL_FLAG = 1;

    /** `Object#toString` result references. */
    var argsTag$1 = '[object Arguments]',
        arrayTag$1 = '[object Array]',
        objectTag$1 = '[object Object]';

    /** Used for built-in method references. */
    var objectProto$3 = Object.prototype;

    /** Used to check objects for own properties. */
    var hasOwnProperty$3 = objectProto$3.hasOwnProperty;

    /**
     * A specialized version of `baseIsEqual` for arrays and objects which performs
     * deep comparisons and tracks traversed objects enabling objects with circular
     * references to be compared.
     *
     * @private
     * @param {Object} object The object to compare.
     * @param {Object} other The other object to compare.
     * @param {number} bitmask The bitmask flags. See `baseIsEqual` for more details.
     * @param {Function} customizer The function to customize comparisons.
     * @param {Function} equalFunc The function to determine equivalents of values.
     * @param {Object} [stack] Tracks traversed `object` and `other` objects.
     * @returns {boolean} Returns `true` if the objects are equivalent, else `false`.
     */
    function baseIsEqualDeep(object, other, bitmask, customizer, equalFunc, stack) {
      var objIsArr = isArray$1(object),
          othIsArr = isArray$1(other),
          objTag = objIsArr ? arrayTag$1 : getTag$1(object),
          othTag = othIsArr ? arrayTag$1 : getTag$1(other);

      objTag = objTag == argsTag$1 ? objectTag$1 : objTag;
      othTag = othTag == argsTag$1 ? objectTag$1 : othTag;

      var objIsObj = objTag == objectTag$1,
          othIsObj = othTag == objectTag$1,
          isSameTag = objTag == othTag;

      if (isSameTag && isBuffer$1(object)) {
        if (!isBuffer$1(other)) {
          return false;
        }
        objIsArr = true;
        objIsObj = false;
      }
      if (isSameTag && !objIsObj) {
        stack || (stack = new Stack);
        return (objIsArr || isTypedArray$1(object))
          ? equalArrays(object, other, bitmask, customizer, equalFunc, stack)
          : equalByTag(object, other, objTag, bitmask, customizer, equalFunc, stack);
      }
      if (!(bitmask & COMPARE_PARTIAL_FLAG)) {
        var objIsWrapped = objIsObj && hasOwnProperty$3.call(object, '__wrapped__'),
            othIsWrapped = othIsObj && hasOwnProperty$3.call(other, '__wrapped__');

        if (objIsWrapped || othIsWrapped) {
          var objUnwrapped = objIsWrapped ? object.value() : object,
              othUnwrapped = othIsWrapped ? other.value() : other;

          stack || (stack = new Stack);
          return equalFunc(objUnwrapped, othUnwrapped, bitmask, customizer, stack);
        }
      }
      if (!isSameTag) {
        return false;
      }
      stack || (stack = new Stack);
      return equalObjects(object, other, bitmask, customizer, equalFunc, stack);
    }

    /**
     * The base implementation of `_.isEqual` which supports partial comparisons
     * and tracks traversed objects.
     *
     * @private
     * @param {*} value The value to compare.
     * @param {*} other The other value to compare.
     * @param {boolean} bitmask The bitmask flags.
     *  1 - Unordered comparison
     *  2 - Partial comparison
     * @param {Function} [customizer] The function to customize comparisons.
     * @param {Object} [stack] Tracks traversed `value` and `other` objects.
     * @returns {boolean} Returns `true` if the values are equivalent, else `false`.
     */
    function baseIsEqual(value, other, bitmask, customizer, stack) {
      if (value === other) {
        return true;
      }
      if (value == null || other == null || (!isObjectLike(value) && !isObjectLike(other))) {
        return value !== value && other !== other;
      }
      return baseIsEqualDeep(value, other, bitmask, customizer, baseIsEqual, stack);
    }

    /**
     * Performs a deep comparison between two values to determine if they are
     * equivalent.
     *
     * **Note:** This method supports comparing arrays, array buffers, booleans,
     * date objects, error objects, maps, numbers, `Object` objects, regexes,
     * sets, strings, symbols, and typed arrays. `Object` objects are compared
     * by their own, not inherited, enumerable properties. Functions and DOM
     * nodes are compared by strict equality, i.e. `===`.
     *
     * @static
     * @memberOf _
     * @since 0.1.0
     * @category Lang
     * @param {*} value The value to compare.
     * @param {*} other The other value to compare.
     * @returns {boolean} Returns `true` if the values are equivalent, else `false`.
     * @example
     *
     * var object = { 'a': 1 };
     * var other = { 'a': 1 };
     *
     * _.isEqual(object, other);
     * // => true
     *
     * object === other;
     * // => false
     */
    function isEqual(value, other) {
      return baseIsEqual(value, other);
    }

    const ThumbGenView = {
        Current: 0,
        Side: 1,
        Top: 2,
        ThreeQuarter: 3
    };

    class BtnPanel extends Btnbasic {

        /** @type HTMLDivElement */
        image;

        /** @type HTMLDivElement */
        title;

        /** @type HTMLDivElement */
        subtitle;

        message;


        imageWaitHandler = { id: 0 };

        constructor() {
            super();
            this.template = template$1K;
        }

        bindingValue = {};


        onBindingUpdate(binding_param, value, init) {

            if (binding_param == "ksmessage" && !isEqual(this.bindingValue, value) && init) {

                if (value.__Type == "CarModel" || value.__Type == "GameModeSpecialEvent") {
                    this.mapElementByClass("image");
                    this.dataset.state = value.ownership_state;

                    if (this.image) {
                        this.image.removeAttribute("style");
                    }
                }

                if (value.__Type == "GameModeSpecialEvent") {
                    this.removeAttribute("data-tooltip");
                }

                if (value.__Type == "CarManufacturer") {
                    this.subtitle = q("div[slot=subtitle]", this);
                    this.mapElementByClass("image");

                    if (this.image) {
                        this.image.removeAttribute("style");
                    }
                }

            }

            if (binding_param == "ksmessage" && !isEqual(this.bindingValue, value) && !init) {

                this.dataset.mode = value.__Type;

                if (value.__Type == "CarManufacturer") {
                    const id = value.name.toLowerCase().replace(/[ -]+/g, "_");

                    this.dataset.brand = id;

                    if (this.subtitle) {
                        this.subtitle.innerHTML = value.all == true ? value.name : ksUI$1.getManufacturerLocName(value);
                    }

                    if (id == "all") {
                        this.image.style.backgroundImage = "none";
                        return;
                    }
                    if (!this.image) {
                        this.mapElementByClass("image");
                    }
                    if (this.image) {
                        waitForFrames(() => {

                            this.image.style.backgroundImage = `url('/branding/oem/${id}/badge.texture')`;

                        }, 2);
                    }
                }

                if (value.__Type == "TrackItem") {
                    const id = ksUI$1.getTrackId(value);


                    if (!this.image) {
                        this.mapElementByClass("image");
                    }


                    const map = q(".map", this);

                    if (window["CurrentTrack"]) {
                        const currentid = ksUI$1.getTrackId(CurrentTrack);

                        const multilayoutcurrent = value.layouts && CurrentTrack.name == value.name && value.layouts.length > 1;
                        const assigned_current = this.classList.toggle("current-track", id == currentid || multilayoutcurrent === true);

                        if (assigned_current) engine.trigger(EngineEvents.TrackSelection.CurrentTrackInList, this);


                        if (multilayoutcurrent) {
                            if (map) {
                                map.style.backgroundImage = `url('/images/trackmaps/${ksUI$1.getTrackId(CurrentTrack)}.svg')`;
                            }
                            if (this.image) {
                                this.image.style.backgroundImage = `url('/images/tracks/${ksUI$1.getTrackId(CurrentTrack)}.texture')`;
                            }

                        } else {
                            if (map) {
                                map.style.backgroundImage = `url('/images/trackmaps/${id}.svg')`;
                            }
                            if (this.image) {
                                this.image.style.backgroundImage = `url('/images/tracks/${id}.texture')`;
                            }

                        }
                        //if(assigned_current) {
                        //  console.warn(currentid, multilayoutcurrent);
                        //}
                    }


                }

                if (value.__Type == "CarModel") {
                    this.renderCarItem(value);
                }

                if (value.__Type == "GameModeSpecialEvent") {

                    if (!this.disableTooltip) {
                        const identifier = `tooltip${value.name.replace(" ", "_")}`;
                        this.dataset.tooltip = identifier;
                        if (value.status == "SpecialEventStatus_DISABLED") {
                            engine.translate(identifier);
                        }
                    }

                    this.mapElementByClass("image", this, true);

                    if (this.image) {

                        if (this.hasAttribute("driving-academy")) {
                            this.image.style.backgroundImage = `url('/images/specialevents/${value.name.replace(" ", "_").toLowerCase()}.texture')`;
                            //console.log(`/images/specialevents/${value.name.replace(" ", "_").toLowerCase()}.texture`);
                        } else {
                            this.image.style.backgroundImage = `url('/images/tracks/${ksUI$1.getTrackId(value.track_item)}.texture')`;
                        }
                    }
                }

                Object.assign(this.bindingValue, value);
                //this.bindingValue = value;

            }
        }

        renderCarItem(value) {

            cancelAnimationFrame(this.imageWaitHandler.id);

            this.dataset.modelName = value.display_name;
            this.dataset.carguid = value.car_guid;
            this.dataset.state = value.ownership_state;

            this.mapElementByClass("image", this, true);
            this.title = q("div[slot=title]", this);

            const old_pi = q(".performance_indicator", this);

            const pi = old_pi ? old_pi : document.createElement("div");
            pi.classList.add("performance_indicator");
            pi.textContent = value.performance_indicator.toFixed(1);

            this.classList.toggle("license-requirement", !value.is_enabled);

            if (ModelUIDriverState)
                this.classList.toggle("money-requirement", value.price_final > ModelUIDriverState.money);

            if (!this.title) {
                this.title = q("div.title", this);
            }

            if (this.title) {
                this.title.appendChild(pi);
            }

            if (this.image) {
                this.classList.remove("show-image");
                const id = value.manufacturer.name.toLowerCase().replace(" ", "_").replace("-", "_");

                this.image.setAttribute("style", `background-image: none !important;`);

                waitForFrames(() => {
                    this.image.setAttribute("style", `background-image: url('/thumbnail/${value.car_guid.replace(/[{}]/g, "")}/${ThumbGenView.Side}');`);
                    this.classList.add("show-image");
                }, 12, this.imageWaitHandler);

                const badge = q(".badge", this);

                if (!badge) {
                    const brandbgr = document.createElement("div");
                    brandbgr.classList.add("badge");
                    brandbgr.style.backgroundImage = `url('/branding/oem/${id}/badge.texture')`;
                    q(".btnpanel-body", this).appendChild(brandbgr);
                } else {
                    badge.style.backgroundImage = `url('/branding/oem/${id}/badge.texture')`;
                }
            }

            if (window["CurrentCar"] && window["CurrentCar"].model) {
                this.classList.toggle("current-car", value.car_guid == CurrentCar.model.car_guid);
                this.classList.toggle("current-model", value.name == CurrentCar.model.name);
                // this.dataset.state = CurrentCar.state;
            }

            const model_name = q(".model_name", this),
                config_name = q(".config-name", this),
                trim_name = q(".trim-name", this);

            if (model_name)
                model_name.textContent = value.display_name;

            if (config_name)
                config_name.textContent = value.translated.mech;

            if (trim_name)
                trim_name.textContent = value.translated.visual;

            if (value.__uimetadata && value.__uimetadata.prices) {
                value.__uimetadata.prices.sort();

                const pricecontainer = q(".price .value", this);

                if (pricecontainer)

                    if (value.__uimetadata.prices.length > 1) {
                        pricecontainer.innerHTML =
                            `${value.__uimetadata.prices.at(0)} - ${value.__uimetadata.prices.at(-1)}`;
                    } else {
                        pricecontainer.innerHTML = value.__uimetadata.prices.at(0);
                    }
            }
        }

        onMessageBindingRemoved() {
            cancelAnimationFrame(this.imageWaitHandler.id);
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.title = q("div[slot=title]", this);
            this.subtitle = q("div[slot=subtitle]", this);

            if (this.message && this.message.__Type == "CarModel") {

                

                this.mapElementByClass("image");
                this.dataset.state = this.message.ownership_state;
                this.dataset.mode = this.message.__Type;

                const owned_marker = document.createElement("div");
                owned_marker.classList.add("owned-marker");

                const model_name = document.createElement("div");
                model_name.classList.add("model_name");

                const config_name = document.createElement("div");
                config_name.classList.add("config-name");

                const trim_name = document.createElement("div");
                trim_name.classList.add("trim-name");

                this.appendChild(owned_marker);
                q(".title", this).appendChild(model_name);
                q(".subtitle", this).appendChild(config_name);
                q(".subtitle", this).appendChild(trim_name);

                this.renderCarItem(this.message);

            }

        }

    }
    ksUI$1.registerModule('ks-btnpanel', BtnPanel);

    var template$1J = "<div class=\"controlhints\">\r\n    <component-slot data-name=\"controls\">\r\n\r\n    </component-slot>\r\n    \r\n    <div class=\"ghost\"></div>\r\n    <div class=\"tooltips\"></div>\r\n        <div class=\"permanent\">\r\n        <ks-btnbasic id=\"btnHideUI\" class=\"focusable\" data-tooltip=\"lblHideUI\" data-tooltip-css-class=\"inline\">\r\n            <div slot=\"icon\"></div>\r\n        </ks-btnbasic>\r\n        <ks-versionindicator></ks-versionindicator>\r\n    </div>\r\n\r\n</div>";

    var template$1I = "<div class=\"component-body\">\r\n    <div class=\"label\">\r\n        <div class=\"online\" data-l10n-id=\"labelOnline\"></div>\r\n        <div class=\"offline\" data-l10n-id=\"labelOffline\"></div>\r\n    </div>\r\n    <div class=\"status\"></div>\r\n</div>";

    class BackendIndicator extends KsHTMLElement {

        constructor() {
            super();
            this.delayedInit = true;
            this.template = template$1I;
        }

       

        onTemplateLoaded() {
            super.onTemplateLoaded();
            
        }

    }
    ksUI$1.registerModule('ks-backendindicator', BackendIndicator);

    var template$1H = "<div class=\"component-body\">\r\n    <div class=\"label\">\r\n        <div class=\"version\" data-bind-value=\"version({{ModelUIState.game_version}})\"></div>        \r\n    </div>    \r\n</div>";

    class VersionIndicator extends KsHTMLElement {

        constructor() {
            super();
            this.delayedInit = true;
            this.template = template$1H;
        }

       

        onTemplateLoaded() {
            super.onTemplateLoaded();
            
        }

        bindControls() {
            window["version"] = (x) => {
                if(x === undefined) {
                    return "";
                }
                return "v " + x;
            };
        }

    }
    ksUI$1.registerModule('ks-versionindicator', VersionIndicator);

    class ControlHints extends HTMLElement {

        controlslot;
        ghost;
        tooltips;

        /** @type {Btnbasic} */
        btnHideUI;

        constructor() {
            super();
            this.template = template$1J;
        }

        addControl(control) {
            this.controlslot.appendChild(control);
        }

        reset() {
            //if (this.controlslot.innerHTML.length > 0) {

            //     this.ghost.innerHTML = this.controlslot.innerHTML.replace("focusable", "");

            //}
            this.classList.remove("controlhints-rendered");

            if (this.controlslot)
                this.controlslot.innerHTML = "";

        }

        _debounceTooltip;

        bindEvents() {
            engine.on(EngineEvents.UI.ShowTooltip, (tooltip, extraCSSClass) => {
                clearTimeout(this._debounceTooltip);
                this.classList.add("showtips");
                this.tooltips.innerHTML = tooltip;
                this.tooltips.classList.add(extraCSSClass);
            });

            engine.on(EngineEvents.UI.HideTooltip, () => {
                clearTimeout(this._debounceTooltip);
                this._debounceTooltip = setTimeout(() => {
                    this.classList.remove("showtips");
                    this.tooltips.textContent = "";
                    this.tooltips.className = "tooltips";
                }, 250);
            });

            this.btnHideUI.onPressed = (sender, e) => {
                document.body.classList.add("hide-ui");

                rootModal().Show({
                    dataMode: "popup",
                    showTitle: false,
                    message: "msgUIHidden",
                    buttons: 0x000,
                    toggleMouseHover: false,
                    forceAllowMouseHover: true,
                    hideAfter: 1000
                });

                
            };
        }

        connectedCallback() {
            components$1.loadResource(this)
                .then((result) => {
                    this.template = result.template;
                    components$1.renderOnce(this);
                    this.controlslot = $.q("div[slot=controls]", this);
                    this.ghost = $.q(".ghost", this);
                    this.tooltips = $.q(".tooltips");
                    this.btnHideUI = $.q("#btnHideUI");
                    this.bindEvents();
                })
                .catch(err => console.error(err));
        }
    }
    ksUI.registerModule('ks-controlhints', ControlHints);

    var template$1G = "<div class=\"gamemode-body component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back rounded focusable\"></ks-btnbasic>\r\n            <ks-btnbasic class=\"apply focusable\" id=\"apply\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnApply\">Apply</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"cancel focusable\" id=\"cancel\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCancel\">Cancel</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\">\r\n            <div data-l10n-id=\"headerSinglePlayer\">Single Player</div>\r\n            <div>/</div>\r\n            <div data-l10n-id=\"headerGameMode\">Game Mode</div>\r\n        </div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body align-items-center\">\r\n        <div id=\"panelSelectors\" class=\"is-flex tab-selectors\">\r\n            <div class=\"controltip\"></div>\r\n            <ks-btnbasic id=\"btnPractice\" data-tooltip=\"tooltipPractice\" data-sn-left=\"#btnRaceWeekend\" class=\"focusable\" data-mode=\"practice\" toggle-group=\"presets\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"GameModeType_PRACTICE\"></div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnQuickRace\" data-tooltip=\"tooltipQuickRace\" class=\"focusable\" data-mode=\"quickrace\" toggle-group=\"presets\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"GameModeType_INSTANT_RACE\"></div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnRaceWeekend\" data-tooltip=\"tooltipRaceWeekend\" data-sn-right=\"#btnPractice\" class=\"focusable\" data-mode=\"raceweekend\" toggle-group=\"presets\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"GameModeType_RACE_WEEKEND\"></div>\r\n            </ks-btnbasic>\r\n            <div class=\"controltip\"></div>\r\n        </div>\r\n\r\n        <div id=\"panelSettings\" class=\"scrollable-element scrollable-vertical is-flex-column\">\r\n\r\n            <ks-slider data-tooltip=\"tooltipPracticeDuration\" class=\"oneline focusable practice\" min=\"0\" max=\"90\" step=\"1\" value=\"0\" data-session=\"practice\" data-setting=\"duration\">\r\n                <div slot=\"name\" data-l10n-id=\"lblPracticeDuration\"></div>\r\n                <div slot=\"unit\" data-l10n-id=\"lblMinutesLower\"></div>\r\n            </ks-slider>\r\n\r\n            <ks-slider class=\"oneline focusable practice\" data-tooltip=\"tooltipPracticeStartTime\" min=\"0\" max=\"1435\" step=\"5\" value=\"0\" data-session=\"practice\" data-setting=\"starttime\">\r\n                <div slot=\"name\" data-l10n-id=\"lblPracticeStartTime\"></div>\r\n            </ks-slider>\r\n\r\n            <ks-slider data-tooltip=\"tooltipTimeMultiplier\" class=\"oneline focusable practice margin-b1\" values=\"[1,2,4,6,12,24,48]\" data-session=\"practice\" data-setting=\"time_multiplier\">\r\n                <div slot=\"name\" data-l10n-id=\"lblPracticeTimeMultiplier\"></div>\r\n                <div slot=\"unit\">X</div>\r\n            </ks-slider>\r\n\r\n            <ks-slider class=\"oneline focusable qualifying\" data-tooltip=\"tooltipQualifyingDuration\" min=\"5\" max=\"90\" step=\"5\" value=\"0\" data-session=\"qualifying\" data-setting=\"duration\">\r\n                <div slot=\"name\" data-l10n-id=\"lblQualifyingDuration\"></div>\r\n                <div slot=\"unit\" data-l10n-id=\"lblMinutesLower\"></div>\r\n            </ks-slider>\r\n\r\n            <ks-slider class=\"oneline focusable qualifying\" data-tooltip=\"tooltipQualifyingStartTime\" min=\"0\" max=\"1435\" step=\"5\" value=\"0\" data-session=\"qualifying\" data-setting=\"starttime\">\r\n                <div slot=\"name\" data-l10n-id=\"lblQualifyingStartTime\"></div>\r\n            </ks-slider>\r\n\r\n            <ks-slider data-tooltip=\"tooltipTimeMultiplier\" class=\"oneline focusable qualifying margin-b1\" values=\"[1,2,4,6,12,24,48]\" data-session=\"qualifying\" data-setting=\"time_multiplier\">\r\n                <div slot=\"name\" data-l10n-id=\"lblQualiTimeMultiplier\"></div>\r\n                <div slot=\"unit\">X</div>\r\n            </ks-slider>\r\n\r\n            <ks-slider class=\"oneline focusable warmup\" data-tooltip=\"tooltipWarmupDuration\" min=\"0\" max=\"90\" step=\"5\" value=\"0\" data-session=\"warmup\" data-setting=\"duration\">\r\n                <div slot=\"name\" data-l10n-id=\"lblWarmupDuration\"></div>\r\n                <div slot=\"unit\" data-l10n-id=\"lblMinutesLower\"></div>\r\n            </ks-slider>\r\n\r\n            <ks-slider class=\"oneline focusable warmup\" data-tooltip=\"tooltipWarmupStartTime\" min=\"0\" max=\"1435\" step=\"5\" value=\"0\" data-session=\"warmup\" data-setting=\"starttime\">\r\n                <div slot=\"name\" data-l10n-id=\"lblWarmupStartTime\"></div>\r\n                <div slot=\"unit\"></div>\r\n            </ks-slider>\r\n\r\n            <ks-slider data-tooltip=\"tooltipTimeMultiplier\" class=\"oneline focusable warmup margin-b1\" values=\"[1,2,4,6,12,24,48]\" data-session=\"warmup\" data-setting=\"time_multiplier\">\r\n                <div slot=\"name\" data-l10n-id=\"lblWarmupTimeMultiplier\"></div>\r\n                <div slot=\"unit\">X</div>\r\n            </ks-slider>\r\n\r\n            <div id=\"panelRaceType\" class=\"togglegroup is-flex flex-1 align-items-center race focus-indicator\">\r\n                <div class=\"label\" data-l10n-id=\"lblRaceType\"></div>\r\n                <div class=\"togglebuttons is-flex justify-content-center\">\r\n                    <ks-btnbasic data-tooltip=\"tooltipRaceTypeLaps\" class=\"focusable\" data-racetype=\"laps\" toggle-group=\"racetype\" toggle>\r\n                        <div slot=\"name\" data-l10n-id=\"labelLaps\"></div>\r\n                    </ks-btnbasic>\r\n\r\n                    <ks-btnbasic data-tooltip=\"tooltipRaceTypeTime\" class=\"focusable\" data-racetype=\"time\" toggle-group=\"racetype\" toggle>\r\n                        <div slot=\"name\" data-l10n-id=\"labelTime\"></div>\r\n                    </ks-btnbasic>\r\n                </div>\r\n            </div>\r\n\r\n            <ks-slider class=\"oneline focusable time\" data-tooltip=\"tooltipRaceDurationInTime\" min=\"5\" max=\"180\" step=\"5\" value=\"0\" data-session=\"race\" data-setting=\"duration\">\r\n                <div slot=\"name\" data-l10n-id=\"lblRaceDuration\"></div>\r\n                <div slot=\"unit\" data-l10n-id=\"lblMinutesLower\"></div>\r\n            </ks-slider>\r\n\r\n            <ks-slider data-tooltip=\"tooltipRaceDurationInLaps\" class=\"oneline focusable laps\" min=\"1\" max=\"100\" step=\"1\" value=\"0\" data-session=\"race\" data-setting=\"duration\">\r\n                <div slot=\"name\" data-l10n-id=\"lblRaceDuration\"></div>\r\n                <div slot=\"unit\" data-l10n-id=\"lblLapsLower\"></div>\r\n            </ks-slider>\r\n\r\n            <ks-slider class=\"oneline focusable race\" data-tooltip=\"tooltipRaceStartTime\" min=\"0\" max=\"1435\" step=\"5\" value=\"0\" data-session=\"race\" data-setting=\"starttime\">\r\n                <div slot=\"name\" data-l10n-id=\"lblRaceStartTime\"></div>\r\n                <div slot=\"unit\"></div>\r\n            </ks-slider>\r\n\r\n            <ks-slider data-tooltip=\"tooltipTimeMultiplier\" class=\"oneline focusable race margin-b1\" values=\"[1,2,4,6,12,24,48]\" data-session=\"race\" data-setting=\"time_multiplier\">\r\n                <div slot=\"name\" data-l10n-id=\"lblRaceTimeMultiplier\"></div>\r\n                <div slot=\"unit\">X</div>\r\n            </ks-slider>\r\n\r\n            <ks-slider data-tooltip=\"tooltipRaceStartingPosition\" class=\"oneline focusable race\" min=\"0\" max=\"100\" step=\"1\" value=\"1\" data-session=\"race\" data-setting=\"starting_position\">\r\n                <div slot=\"name\" data-l10n-id=\"lblRaceStartingPosition\"></div>\r\n            </ks-slider>\r\n\r\n            <div id=\"panelGridType\" class=\"togglegroup is-flex flex-1 align-items-center race focus-indicator needtrack\">\r\n                <div class=\"label\" data-l10n-id=\"lblGridType\"></div>\r\n                <div class=\"togglebuttons is-flex justify-content-center\">\r\n                    <ks-btnbasic data-tooltip=\"tooltipGridTypeAutomatic\" data-gridtype=\"autogrid\" class=\"focusable\" toggle-group=\"gridtype\" toggle>\r\n                        <div slot=\"name\" data-l10n-id=\"lblAutomatic\"></div>\r\n                    </ks-btnbasic>\r\n\r\n                    <ks-btnbasic data-tooltip=\"tooltipGridTypeCustom\" data-gridtype=\"customgrid\" class=\"focusable\" toggle-group=\"gridtype\" toggle>\r\n                        <div slot=\"name\" data-l10n-id=\"lblCustom\"></div>\r\n                    </ks-btnbasic>\r\n\r\n                </div>\r\n            </div>\r\n\r\n            <ks-btnbasic id=\"btnEditGrid\" data-tooltip=\"tooltipEditGrid\" class=\"focusable margin-t1 customgrid needtrack\">\r\n                <div slot=\"name\" data-l10n-id=\"lblEditGrid\"></div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-slider data-tooltip=\"tooltipNumberOfOpponents\" class=\"oneline focusable autogrid needtrack\" min=\"1\" max=\"32\" step=\"1\" value=\"0\" data-setting=\"num_opponents\">\r\n                <div slot=\"name\" data-l10n-id=\"lblNumberOfOpponents\"></div>\r\n            </ks-slider>\r\n\r\n            <ks-slider two-handles id=\"sliderOpponentSkill\" data-tooltip=\"tooltipOpponentSkill\" class=\"oneline focusable autogrid needtrack\" min=\"80\" max=\"100\" step=\"1\" value=\"0\" data-setting=\"min_max_strength\">\r\n                <div slot=\"name\" data-l10n-id=\"lblOpponentSkill\"></div>\r\n                <div slot=\"unit\">%</div>\r\n            </ks-slider>\r\n\r\n            <ks-slider id=\"sliderOpponentBehaviour\" data-tooltip=\"tooltipOpponentBehaviour\" class=\"oneline focusable autogrid\" values='[\"Safe\",\"Normal\",\"Competitive\"]' value=\"Normal\" data-setting=\"aggressivness\">\r\n                <div slot=\"name\" data-l10n-id=\"lblOpponentBehaviour\"></div>\r\n\r\n            </ks-slider>\r\n\r\n            <div id=\"panelSingleMake\" class=\"togglegroup is-flex flex-1 align-items-center focus-indicator autogrid needtrack\">\r\n                <div class=\"label\" data-l10n-id=\"lblSingleMake\"></div>\r\n                <div class=\"togglebuttons is-flex justify-content-center\">\r\n                    <ks-btnbasic data-tooltip=\"tooltipSingleMake\" class=\"focusable\" data-mode=\"false\" toggle-group=\"singlemake\" toggle>\r\n                        <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                    </ks-btnbasic>\r\n\r\n                    <ks-btnbasic data-tooltip=\"tooltipSingleMake\" class=\"focusable\" data-mode=\"true\" toggle-group=\"singlemake\" toggle>\r\n                        <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                    </ks-btnbasic>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"notrack is-flex\" data-l10n-id=\"lblPleaseSelectTrack\">\r\n\r\n            </div>\r\n\r\n\r\n        </div>\r\n    </div>\r\n\r\n</div>";

    var template$1F = "<div class=\"component-body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back rounded focusable\"></ks-btnbasic>\r\n            <ks-btnbasic class=\"apply focusable\" id=\"btnApply\" l10nid=\"btnApply\" disabled=\"disabled\">\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"cancel focusable\" id=\"btnCancel\" l10nid=\"btnCancel\" disabled=\"disabled\">\r\n            </ks-btnbasic>\r\n\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\" data-l10n-id=\"headerGridEditor\">Grid Customization</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body align-items-center\">\r\n        <div id=\"panelOptions\" class=\"is-flex-row\">\r\n            <div id=\"panelSettings\" class=\"is-flex-column justify-content-start\">\r\n\r\n                <ks-slider id=\"sliderOpponentNumber\" min=\"1\" max=\"32\" class=\"focusable oneline\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblNumberOfOpponents\"></div>\r\n                    <div slot=\"unit\"> </div>\r\n                </ks-slider>\r\n\r\n                <ks-slider two-handles id=\"sliderOpponentSkill\" class=\"oneline focusable\" min=\"80\" max=\"100\" step=\"1\" data-setting=\"skill\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblOpponentSkill\"></div>\r\n                    <div slot=\"unit\">%</div>\r\n                </ks-slider>\r\n\r\n                <ks-slider id=\"sliderOpponentBehaviour\" class=\"oneline focusable\" values='[\"Safe\",\"Normal\",\"Competitive\"]' value=\"Normal\" data-setting=\"aggressiveness\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblOpponentBehaviour\"></div>\r\n\r\n                </ks-slider>\r\n\r\n\r\n            </div>\r\n\r\n            <div id=\"panelWeights\" class=\"is-flex-column justify-content-start\">\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                    <div class=\"label\" data-l10n-id=\"lblSingleMake\"></div>\r\n                    <div class=\"single-make togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"false\" data-setting=\"single_make\" toggle-group=\"single_make\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"single_make\" data-mode=\"true\" toggle-group=\"single_make\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"togglegroup vehicle-type is-flex align-items-center\">\r\n                    <div class=\"label\" data-l10n-id=\"lblVehicleType\"></div>\r\n                    <div class=\"vehicle-category togglebuttons is-flex flex-wrap\">\r\n                        <ks-btnbasic toggle toggle-group-multi=\"type1\" class=\"focusable\" data-setting=\"Road\">\r\n                            <div slot=\"name\" data-l10n-id=\"lblVehicleRoad\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic toggle toggle-group-multi=\"type1\" class=\"focusable\" data-mode=\"false\" data-setting=\"Race\">\r\n                            <div slot=\"name\" data-l10n-id=\"lblVehicleRacing\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic toggle toggle-group-multi=\"type1\" class=\"focusable\" data-mode=\"false\" data-setting=\"Track\">\r\n                            <div slot=\"name\" data-l10n-id=\"lblVehicleTrack\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic toggle toggle-group-multi=\"type2\" class=\"focusable\" data-mode=\"false\" data-setting=\"Modern\">\r\n                            <div slot=\"name\" data-l10n-id=\"lblVehicleModern\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic toggle toggle-group-multi=\"type2\" class=\"focusable\" data-mode=\"false\" data-setting=\"Vintage\">\r\n                            <div slot=\"name\" data-l10n-id=\"lblVehicleHeritage\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic toggle toggle-group-multi=\"type2\" class=\"focusable\" data-mode=\"false\" data-setting=\"YoungTimer\">\r\n                            <div slot=\"name\" data-l10n-id=\"lblVehicleYoungtimer\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic toggle toggle-group-multi=\"type3\" class=\"focusable\" data-mode=\"false\" data-setting=\"ICE\">\r\n                            <div slot=\"name\" data-l10n-id=\"lblVehicleInternalCombustion\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic toggle toggle-group-multi=\"type3\" class=\"focusable\" data-mode=\"false\" data-setting=\"EV\">\r\n                            <div slot=\"name\" data-l10n-id=\"lblVehicleElectricVehicle\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic toggle toggle-group-multi=\"type3\" class=\"focusable\" data-mode=\"false\" data-setting=\"Hybrid\">\r\n                            <div slot=\"name\" data-l10n-id=\"lblVehicleHybrid\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <ks-slider two-handles id=\"sliderOpponentPI\" class=\"oneline focusable\" step=\"1\" value=\"0\" data-setting=\"performance\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblPerformanceRange\">\r\n                    </div>\r\n                </ks-slider>\r\n\r\n                <div id=\"currentCarPI\">\r\n                    \r\n                    <div class=\"label\" data-l10n-id=\"lblCurrentVehicle\">CURRENT VEHICLE</div>\r\n                    <div class=\"value\">\r\n                        <div class=\"marker\"></div>\r\n                        <div class=\"number\" data-bind-value=\"{{CurrentCar}}.model.performance_indicator.toFixed(1)\"></div>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n        </div>\r\n\r\n        <ks-btnbasic id=\"btnGenerateGrid\" class=\"focusable\">\r\n            <div slot=\"name\" data-l10n-id=\"lblGenerateGrid\"></div>\r\n            <div slot=\"icon\">\r\n            </div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic id=\"btnResetOptions\" class=\"focusable\">\r\n            <div slot=\"name\" data-l10n-id=\"lblResetFilters\"></div>\r\n            <!-- <div slot=\"icon\">\r\n            </div> -->\r\n        </ks-btnbasic>\r\n\r\n        <div id=\"listWrapper\" class=\"is-flex-column scrollable-horizontal\">\r\n            <div id=\"listOpponents\" class=\"is-flex-column flex-wrap scrollable-target per-item-scroll\">\r\n            </div>\r\n        </div>\r\n        <div id=\"panelNotifications\"></div>\r\n\r\n\r\n\r\n    </div>\r\n\r\n</div>";

    class BaseManager {

        Client;
        ParentElement;

        assignedModels = [];
        handlers = [];

        set newHandler(value) {
            this.handlers[this.handlers.length] = value;
        }

        clearHandlers() {
            this.handlers.forEach(elem => {
                elem.clear();
            });
            this.handlers = [];
        }

        _dataFilters = {
        }

        _dataFilterId = this.constructor.name + ".dataFilters";

        dataFilters = new Proxy(this._dataFilters, {
            get: (target, prop) => {
                return Reflect.get(target, prop);
            },
            set: (target, prop, value) => {
                console.trace(`set dataFilters ${prop} ${value}`);
                let result = Reflect.set(target, prop, value);
                localStorage.setItem(this._dataFilterId, JSON.stringify(this._dataFilters));
                this.updateDataFilters();
                return result;
            }
        });

        constructor(mode, parent_element) {
            this.ParentElement = parent_element;
            if (localStorage.getItem(this._dataFilterId)) {
                Object.assign(this._dataFilters, JSON.parse(localStorage.getItem(this._dataFilterId)));
                this.updateDataFilters();
            }
        }

        assignModel(model_object, model_name) {

            if (this.assignedModels.indexOf(model_name) == -1) {
                this.assignedModels.push(model_name);
            }

            ksUI$1.assignModel(model_object, model_name);
        }

        cleanAssignedModels() {
            this.assignedModels.forEach(model_name => {
                ksUI$1.unassignModel(model_name);
            });
            this.assignedModels = [];
        }

        updateDataFilters() {
        }

        resetFilters() {
            //console.warn("Clearing", this._dataFilterId);
            localStorage.removeItem(this._dataFilterId);
        }
    }

    class CarSelectionManager extends BaseManager {

        Client = new MessageHandler("CarSelectionClient");

        /** @type CarSelectionCurrentCar */
        Car;
        initialCar = {};

        allBrands = { __Type: "CarManufacturer", name: engine.translate("lblAll").trim(), all: true };
        constructor(mode = eClientCommands.Mode.Single, parent_element = window) {
            super(mode, parent_element);
            if (!this.dataFilters.activeBrand) {
                if (window['CurrentCar']) {
                    this.dataFilters.activeBrand = CurrentCar.model.manufacturer;
                } else {
                    this.dataFilters.activeBrand = this.allBrands;
                }
                this.dataFilters.activeModel = "";
                this.dataFilters.activeMech = "";
                this.dataFilters.carSelectionMode = mode;
                this.dataFilters.trackSelectionMode = eClientCommands.Mode.Single;
                this.dataFilters.ownershipState = eCarSelection.State.Owned;
            }
        }

        get ownedCarCount() {
            return ModelUIState.garage_cars_count;
        }

        get Models() {
            if (window["Models"])
                return window["Models"];
            else
                return null;
        }

        getCarNotesPath(car_model) {
            return [this.getModelMechID(car_model, "/"), ksUI.currentLanguage, "txt"].join(".");
        }

        getCurrentModelMechID(separator = "_") {
            return this.getModelMechID(CurrentCar.model, separator);
        }

        getModelMechID(car_model, separator = "_") {
            return [car_model.name, car_model.configuration.name].join(separator);
        }

        resetFilters() {
            super.resetFilters();
            console.log("CarSelectionManager.resetFilters");
            if (window['CurrentCar'] && window['CurrentCar'].model) {
                this.dataFilters.activeBrand = CurrentCar.model.manufacturer;
            } else {
                this.dataFilters.activeBrand = this.allBrands;
            }
            this.dataFilters.activeModel = "";
            this.dataFilters.activeMech = "";
        }

        updateDataFilters() {

            this.assignModel(this._dataFilters, "CarSelectionDataFilters");
        }

        getLocId(item_description, with_modelname_prefix) {
            return (with_modelname_prefix ? with_modelname_prefix + "_" : "")
                + item_description.toLowerCase().replace(/[\W_]+/g, "_");
        }

        addTranslation(model) {
            model.translated = {
                visual: engine.translate(this.getLocId(model.preset.display_name, model.name)),
                mech: engine.translate(this.getLocId(model.configuration.display_name, model.name))
            };
        }


        getCurrent(callback) {

            //console.trace(">>> VEHICLES.getCurrent STARTED");

            return new Promise((resolve, reject) => {

                this.handlers[this.handlers.length] = this.Client.request("CurrentCar", {
                    mode: this.dataFilters.carSelectionMode
                }, (data) => {
                    ({
                        [eClientCommands.Response.OK]: () => {


                            this.Car = data;

                            this.addTranslation(data.model);

                            //data.model.ownershipState = data.state;

                            this.assignModel(data, "CurrentCar");

                            this.dataFilters.activeModel = CurrentCar.model.name;
                            this.dataFilters.ownershipState = CurrentCar.state;

                            this.updateDataFilters();

                            this.getConfigurations(CurrentCar.model.name);
                            this.onGetCurrentCar();
                            if (!this.initialCar.model) {
                                Object.assign(this.initialCar, CurrentCar);
                            }
                            resolve(data);
                            //console.trace(">>> VEHICLES.getCurrent DONE");
                        },
                        [eClientCommands.Response.CriticalError]: () => {
                            console.error("Received", data.response);
                            reject(data);
                            //this.errorModal("lblError", "msgErrorLoadingCurrentCar", true);
                        }
                    }[data.response])?.();

                    $.waitForFrames(() => {
                        if (callback) {
                            callback(data);
                        }                }, 1);
                });

            });
        }

        onGetCurrentCar() { }
        onGetCurrentConfiguration() { }
        onGetCurrentColorPresets() { }

        getConfigurations(model_name, callback) {
            if (!model_name) {
                console.warn("CarSelectionManager.getConfigurations called without model_name");
                return;
            }
            this.Client.request("CarConfigurations", {
                mode: this.dataFilters.carSelectionMode,
                model: model_name
            }, (data) => {
                //console.log(data);
                ({
                    [eClientCommands.Response.OK]: () => {
                        this.assignModel(data, "CurrentCarConfigurations");
                        //this.getColorPresets(model_name, CurrentCar.configuration);
                        this.onGetCurrentConfiguration();
                    },
                    [eClientCommands.Response.NoCarConfig]: () => {
                        console.warn(model_name, "has no configurations");
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Received", data.response);
                    }
                }[data.response])();

                $.waitForFrames(() => {
                    if (callback) {
                        callback(data.response);
                    }            }, 1);
            });
        }

        getColorPresets(model_name, configuration, callback) {
            this.Client.request("CarColorPresets", {
                mode: this.dataFilters.carSelectionMode,
                model: model_name,
                configuration: configuration
            }, (data) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        this.assignModel(data, "CurrentCarColorPresets");
                        this.onGetCurrentColorPresets();
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Received", data.response);
                    }
                }[data.response])();

                $.waitForFrames(() => {
                    if (callback) {
                        callback(data.response);
                    }            }, 1);
            });
        }

        getManufacturers(ownership_state = this.dataFilters.ownershipState, callback) {


            console.log(this.constructor.name, "getManufacturers", this.dataFilters.carSelectionMode, this.dataFilters.ownershipState);
            if (typeof ownership_state == "function") {
                callback = ownership_state;
                ownership_state = this.dataFilters.ownershipState;
            }

            this.handlers[this.handlers.length] = this.Client.request("Manufacturers", {
                mode: this.dataFilters.carSelectionMode,
                state: ownership_state
            }, (data) => {

                console.log("CarSelectionClientRequestManufacturers", data, data.response, ownership_state);

                if (data.response == eClientCommands.Response.OK) {

                    this.assignModel(data, "Manufacturers");
                } else {
                    console.error("getManufacturers Received", data.response);
                }

                $.waitForFrames(() => {
                    if (callback) {
                        callback(data);
                    }                this.onGetManufacturers(data);
                }, 1);

            });
        }

        getModels(brand = "", callback) {
            console.log("Requesting car models", this.dataFilters.carSelectionMode, this.dataFilters.ownershipState, this._dataFilters);

            return new Promise((resolve, reject) => {
                this.newHandler = this.Client.request("Models", {
                    mode: this.dataFilters.carSelectionMode,
                    state: this.dataFilters.ownershipState
                }, (data) => {
                    ({
                        [eClientCommands.Response.OK]: () => {

                            console.log("Received car models, length:", data.car_model.length);

                            let filteredModels = [];
                            let knownModels = [];

                            for (let model of data.car_model) {
                                if (model.manufacturer.name == this.dataFilters.activeBrand.name || this.dataFilters.activeBrand.all) {

                                    if (this.dataFilters.ownershipState == eCarSelection.State.Dealership ||
                                        this.dataFilters.ownershipState == eCarSelection.State.FirstPurchace ||
                                        this.dataFilters.ownershipState == eCarSelection.State.Rental ||
                                        this.dataFilters.ownershipState == eCarSelection.State.All
                                    ) {

                                        this.addTranslation(model);
                                        if (knownModels.indexOf(model.name) == -1) {
                                            knownModels.push(model.name);
                                            model.__uimetadata = {};
                                            model.__uimetadata.prices = [model.price];
                                            model.__uimetadata.count = 1;
                                            model.__uimetadata.presets = [model];
                                            model.__uimetadata.mechs = new Set([model.configuration.name]);
                                            filteredModels.push(model);
                                            console.log("added", model.name);
                                        } else {
                                            const existing_model = filteredModels.find(elem => elem.name == model.name);
                                            if (existing_model) {
                                                existing_model.__uimetadata.count++;
                                                existing_model.__uimetadata.presets.push(model);
                                                existing_model.__uimetadata.mechs.add(model.configuration.name);
                                                if (existing_model.__uimetadata.prices.indexOf(model.price) == -1) {
                                                    existing_model.__uimetadata.prices.push(model.price);
                                                }
                                            }
                                        }

                                    } else {

                                        if (knownModels.indexOf(model.name) == -1) {
                                            knownModels.push(model.name);
                                        }
                                        this.addTranslation(model);
                                        filteredModels.push(model);
                                    }

                                }
                            }

                            this.assignModel({ items: [], unique: [] }, "Models");

                            $.waitForFrames(() => {
                                this.assignModel({ items: filteredModels, unique: knownModels }, "Models");
                            }, 1);

                            resolve(data);
                        },
                        [eClientCommands.Response.BackendDisconnected]: () => {
                            console.error("Received", data.response);
                            reject(data);
                            //this.errorModal("lblError", "msgErrorLoadingCurrentCar", true);                   
                        },
                        [eClientCommands.Response.CriticalError]: () => {
                            console.error("Received", data.response);
                            reject(data);
                            //this.errorModal("lblError", "msgErrorLoadingCurrentCar", true);
                        }
                    }[data.response])?.();

                    $.waitForFrames(() => {
                        this.onGetModels(data);
                        if (callback) {
                            callback(data);
                        }                }, 2);


                });

            });
        }

        getAllModels(mode = eClientCommands.Mode.Single) {

            console.log("getAllModels", mode);

            return new Promise((resolve, reject) => {
                const result = [];

                this.dataFilters.carSelectionMode = mode;
                this.dataFilters.ownershipState = eCarSelection.State.Owned;

                this.getModels("", null, true).then((owned_data) => {

                    console.warn(owned_data);

                    if (owned_data.car_model)
                        result.push(...owned_data.car_model);

                    this.dataFilters.ownershipState = eCarSelection.State.All;



                    this.getModels("", null, true).then((all_data) => {

                        console.warn(all_data);

                        if (all_data.car_model)
                            result.push(...all_data.car_model);
                        resolve(result);
                    });

                });
            });

        }

        getAllModelsLite(selection_mode = this.dataFilters.carSelectionMode) {
            return new Promise((resolve, reject) => {

                const full_list = [];

                this.getModelsLite(selection_mode, eCarSelection.State.Owned).then(data => {
                    full_list.push(...data.car_model);

                    this.getModelsLite(selection_mode, eCarSelection.State.All).then(data => {
                        full_list.push(...data.car_model);

                        resolve(full_list);
                    });
                });
            });
        }

        getModelsLite(selection_mode = this.dataFilters.carSelectionMode, ownership_state = this.dataFilters.ownershipState) {
            console.log("Requesting car models (l)", selection_mode, ownership_state, this._dataFilters);

            return new Promise((resolve, reject) => {
                this.newHandler = this.Client.request("Models", {
                    mode: selection_mode,
                    state: ownership_state
                }, (data) => {
                    ({
                        [eClientCommands.Response.OK]: () => {
                            data.car_model.forEach(model => {
                                this.addTranslation(model);
                            });
                            resolve(data);
                        },
                        [eClientCommands.Response.BackendDisconnected]: () => {
                            console.error("Received", data.response);
                            reject(data);
                        },
                        [eClientCommands.Response.CriticalError]: () => {
                            console.error("Received", data.response);
                            reject(data);
                        }
                    }[data.response])?.();
                });

            });
        }

        getAltManufacturers(available_callback, callback) {
            let altstate = this.dataFilters.ownershipState == eCarSelection.State.Owned ? eCarSelection.State.Rental : eCarSelection.State.Owned;

            this.newHandler = this.Client.request("Manufacturers", {
                mode: this.dataFilters.carSelectionMode,
                state: altstate
            }, (data) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        //this.assignModel(data.manufacturers, "AltManufacturers");
                        //console.log("CarSelectionClient received AltManufacturers");

                        for (let mfg of data.manufacturers) {
                            if (mfg.name == this.dataFilters.activeBrand.name || this.dataFilters.activeBrand.all) {
                                console.log("Selected manufacturer also has models for alt ownership");

                                if (available_callback) {
                                    available_callback();
                                }
                                this.onAltOwnershipAvailable();

                                //
                                break;
                            }
                        }

                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Received", data.response);
                    }
                }[data.response])();

                $.waitForFrames(() => {
                    if (callback) {
                        callback(data.response);
                    }            }, 1);


            });

        }

        onAltOwnershipAvailable() { }

        onGetModels(data) { }

        onGetManufacturers(data) { }

        setCurrentByGuid(car_guid, selection_mode = this.dataFilters.carSelectionMode, callback) {

            this.dataFilters.activeBrand = this.allBrands;

            this.getAllModels(selection_mode).then(car_list => {
                console.warn(car_list);
                const found = car_list.find(car => { return car.car_guid == car_guid });
                if (found) {
                    this.setCurrent(found, callback);
                } else {
                    console.error("Could not find car with guid", car_guid);
                }
            });

        }

        previouslyViewedCar;
        previouslySelectedModel;

        setCurrent(car_model, callback, get_current_callback, soft = false) {
            if (window["CurrentCar"]) {
                if (soft) {
                    this.previouslyViewedCar = { ...CurrentCar };
                    this.previouslySelectedModel = { ...CurrentCar };
                    this.previouslyViewedModel = { ...CurrentCar };
                    return;
                }

                if ((!this.previouslySelectedModel || this.previouslySelectedModel.model.car_guid != car_model.car_guid) && CurrentCar.state == eCarSelection.State.Owned) {
                    this.previouslyViewedCar = { ...CurrentCar };
                    this.previouslySelectedModel = { ...CurrentCar };
                    this.previouslyViewedModel = { ...CurrentCar };
                }

            }
            this.Client.request("SetCurrentCar", {
                mode: this.dataFilters.carSelectionMode,
                model: car_model
            }, (data) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        this.getCurrent(get_current_callback);
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Could not set car_model to", car_model.name, car_model.car_guid);
                    }
                }[data.response])?.();

                $.waitForFrames(() => this.onSetCurrent(data.response), 1);

                $.waitForFrames(() => {
                    if (callback) {
                        callback(data.response);
                    }            }, 1);
            });
        }

        onSetCurrent(response_code) {
        }

        previouslyViewedModel;
        previouslyViewedVersion;

        preview(car_model, callback, is_preset) {


            if ((!this.previouslyViewedModel || this.previouslyViewedModel.model.name != car_model.name) && !is_preset) {
                this.previouslyViewedModel = { ...CurrentCar };
            }

            if (!this.previouslyViewedVersion || (this.previouslyViewedModel && this.previouslyViewedModel.model.car_guid != car_model.car_guid)) {
                this.previouslyViewedVersion = { ...CurrentCar };
                if (!is_preset) this.previouslyViewedCar = { ...CurrentCar };
            }

            this.Client.request("SetPreviewCar", {
                mode: this.dataFilters.carSelectionMode,
                model: car_model
            }, (data) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        console.log("Previewing car", car_model.name, car_model.car_guid);
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Could not preview", car_model.name, car_model.car_guid);
                    }
                }[data.response])?.();

                if (callback) {
                    callback(data);
                }
            });
        }


    }

    /** Built-in value references. */
    var objectCreate = Object.create;

    /**
     * The base implementation of `_.create` without support for assigning
     * properties to the created object.
     *
     * @private
     * @param {Object} proto The object to inherit from.
     * @returns {Object} Returns the new object.
     */
    var baseCreate = (function() {
      function object() {}
      return function(proto) {
        if (!isObject(proto)) {
          return {};
        }
        if (objectCreate) {
          return objectCreate(proto);
        }
        object.prototype = proto;
        var result = new object;
        object.prototype = undefined;
        return result;
      };
    }());

    var baseCreate$1 = baseCreate;

    /**
     * Copies the values of `source` to `array`.
     *
     * @private
     * @param {Array} source The array to copy values from.
     * @param {Array} [array=[]] The array to copy values to.
     * @returns {Array} Returns `array`.
     */
    function copyArray(source, array) {
      var index = -1,
          length = source.length;

      array || (array = Array(length));
      while (++index < length) {
        array[index] = source[index];
      }
      return array;
    }

    var defineProperty = (function() {
      try {
        var func = getNative(Object, 'defineProperty');
        func({}, '', {});
        return func;
      } catch (e) {}
    }());

    var defineProperty$1 = defineProperty;

    /**
     * A specialized version of `_.forEach` for arrays without support for
     * iteratee shorthands.
     *
     * @private
     * @param {Array} [array] The array to iterate over.
     * @param {Function} iteratee The function invoked per iteration.
     * @returns {Array} Returns `array`.
     */
    function arrayEach(array, iteratee) {
      var index = -1,
          length = array == null ? 0 : array.length;

      while (++index < length) {
        if (iteratee(array[index], index, array) === false) {
          break;
        }
      }
      return array;
    }

    /**
     * The base implementation of `assignValue` and `assignMergeValue` without
     * value checks.
     *
     * @private
     * @param {Object} object The object to modify.
     * @param {string} key The key of the property to assign.
     * @param {*} value The value to assign.
     */
    function baseAssignValue(object, key, value) {
      if (key == '__proto__' && defineProperty$1) {
        defineProperty$1(object, key, {
          'configurable': true,
          'enumerable': true,
          'value': value,
          'writable': true
        });
      } else {
        object[key] = value;
      }
    }

    /** Used for built-in method references. */
    var objectProto$2 = Object.prototype;

    /** Used to check objects for own properties. */
    var hasOwnProperty$2 = objectProto$2.hasOwnProperty;

    /**
     * Assigns `value` to `key` of `object` if the existing value is not equivalent
     * using [`SameValueZero`](http://ecma-international.org/ecma-262/7.0/#sec-samevaluezero)
     * for equality comparisons.
     *
     * @private
     * @param {Object} object The object to modify.
     * @param {string} key The key of the property to assign.
     * @param {*} value The value to assign.
     */
    function assignValue(object, key, value) {
      var objValue = object[key];
      if (!(hasOwnProperty$2.call(object, key) && eq(objValue, value)) ||
          (value === undefined && !(key in object))) {
        baseAssignValue(object, key, value);
      }
    }

    /**
     * Copies properties of `source` to `object`.
     *
     * @private
     * @param {Object} source The object to copy properties from.
     * @param {Array} props The property identifiers to copy.
     * @param {Object} [object={}] The object to copy properties to.
     * @param {Function} [customizer] The function to customize copied values.
     * @returns {Object} Returns `object`.
     */
    function copyObject(source, props, object, customizer) {
      var isNew = !object;
      object || (object = {});

      var index = -1,
          length = props.length;

      while (++index < length) {
        var key = props[index];

        var newValue = customizer
          ? customizer(object[key], source[key], key, object, source)
          : undefined;

        if (newValue === undefined) {
          newValue = source[key];
        }
        if (isNew) {
          baseAssignValue(object, key, newValue);
        } else {
          assignValue(object, key, newValue);
        }
      }
      return object;
    }

    /**
     * This function is like
     * [`Object.keys`](http://ecma-international.org/ecma-262/7.0/#sec-object.keys)
     * except that it includes inherited enumerable properties.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names.
     */
    function nativeKeysIn(object) {
      var result = [];
      if (object != null) {
        for (var key in Object(object)) {
          result.push(key);
        }
      }
      return result;
    }

    /** Used for built-in method references. */
    var objectProto$1 = Object.prototype;

    /** Used to check objects for own properties. */
    var hasOwnProperty$1 = objectProto$1.hasOwnProperty;

    /**
     * The base implementation of `_.keysIn` which doesn't treat sparse arrays as dense.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names.
     */
    function baseKeysIn(object) {
      if (!isObject(object)) {
        return nativeKeysIn(object);
      }
      var isProto = isPrototype(object),
          result = [];

      for (var key in object) {
        if (!(key == 'constructor' && (isProto || !hasOwnProperty$1.call(object, key)))) {
          result.push(key);
        }
      }
      return result;
    }

    /**
     * Creates an array of the own and inherited enumerable property names of `object`.
     *
     * **Note:** Non-object values are coerced to objects.
     *
     * @static
     * @memberOf _
     * @since 3.0.0
     * @category Object
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names.
     * @example
     *
     * function Foo() {
     *   this.a = 1;
     *   this.b = 2;
     * }
     *
     * Foo.prototype.c = 3;
     *
     * _.keysIn(new Foo);
     * // => ['a', 'b', 'c'] (iteration order is not guaranteed)
     */
    function keysIn(object) {
      return isArrayLike(object) ? arrayLikeKeys(object, true) : baseKeysIn(object);
    }

    /** Built-in value references. */
    var getPrototype = overArg(Object.getPrototypeOf, Object);

    var getPrototype$1 = getPrototype;

    /**
     * The base implementation of `_.assign` without support for multiple sources
     * or `customizer` functions.
     *
     * @private
     * @param {Object} object The destination object.
     * @param {Object} source The source object.
     * @returns {Object} Returns `object`.
     */
    function baseAssign(object, source) {
      return object && copyObject(source, keys(source), object);
    }

    /**
     * The base implementation of `_.assignIn` without support for multiple sources
     * or `customizer` functions.
     *
     * @private
     * @param {Object} object The destination object.
     * @param {Object} source The source object.
     * @returns {Object} Returns `object`.
     */
    function baseAssignIn(object, source) {
      return object && copyObject(source, keysIn(source), object);
    }

    /** Detect free variable `exports`. */
    var freeExports = typeof exports == 'object' && exports && !exports.nodeType && exports;

    /** Detect free variable `module`. */
    var freeModule = freeExports && typeof module == 'object' && module && !module.nodeType && module;

    /** Detect the popular CommonJS extension `module.exports`. */
    var moduleExports = freeModule && freeModule.exports === freeExports;

    /** Built-in value references. */
    var Buffer = moduleExports ? root$1.Buffer : undefined,
        allocUnsafe = Buffer ? Buffer.allocUnsafe : undefined;

    /**
     * Creates a clone of  `buffer`.
     *
     * @private
     * @param {Buffer} buffer The buffer to clone.
     * @param {boolean} [isDeep] Specify a deep clone.
     * @returns {Buffer} Returns the cloned buffer.
     */
    function cloneBuffer(buffer, isDeep) {
      if (isDeep) {
        return buffer.slice();
      }
      var length = buffer.length,
          result = allocUnsafe ? allocUnsafe(length) : new buffer.constructor(length);

      buffer.copy(result);
      return result;
    }

    /**
     * Copies own symbols of `source` to `object`.
     *
     * @private
     * @param {Object} source The object to copy symbols from.
     * @param {Object} [object={}] The object to copy symbols to.
     * @returns {Object} Returns `object`.
     */
    function copySymbols(source, object) {
      return copyObject(source, getSymbols$1(source), object);
    }

    /* Built-in method references for those with the same name as other `lodash` methods. */
    var nativeGetSymbols = Object.getOwnPropertySymbols;

    /**
     * Creates an array of the own and inherited enumerable symbols of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of symbols.
     */
    var getSymbolsIn = !nativeGetSymbols ? stubArray : function(object) {
      var result = [];
      while (object) {
        arrayPush(result, getSymbols$1(object));
        object = getPrototype$1(object);
      }
      return result;
    };

    var getSymbolsIn$1 = getSymbolsIn;

    /**
     * Copies own and inherited symbols of `source` to `object`.
     *
     * @private
     * @param {Object} source The object to copy symbols from.
     * @param {Object} [object={}] The object to copy symbols to.
     * @returns {Object} Returns `object`.
     */
    function copySymbolsIn(source, object) {
      return copyObject(source, getSymbolsIn$1(source), object);
    }

    /**
     * Creates an array of own and inherited enumerable property names and
     * symbols of `object`.
     *
     * @private
     * @param {Object} object The object to query.
     * @returns {Array} Returns the array of property names and symbols.
     */
    function getAllKeysIn(object) {
      return baseGetAllKeys(object, keysIn, getSymbolsIn$1);
    }

    /** Used for built-in method references. */
    var objectProto = Object.prototype;

    /** Used to check objects for own properties. */
    var hasOwnProperty = objectProto.hasOwnProperty;

    /**
     * Initializes an array clone.
     *
     * @private
     * @param {Array} array The array to clone.
     * @returns {Array} Returns the initialized clone.
     */
    function initCloneArray(array) {
      var length = array.length,
          result = new array.constructor(length);

      // Add properties assigned by `RegExp#exec`.
      if (length && typeof array[0] == 'string' && hasOwnProperty.call(array, 'index')) {
        result.index = array.index;
        result.input = array.input;
      }
      return result;
    }

    /**
     * Creates a clone of `arrayBuffer`.
     *
     * @private
     * @param {ArrayBuffer} arrayBuffer The array buffer to clone.
     * @returns {ArrayBuffer} Returns the cloned array buffer.
     */
    function cloneArrayBuffer(arrayBuffer) {
      var result = new arrayBuffer.constructor(arrayBuffer.byteLength);
      new Uint8Array$1(result).set(new Uint8Array$1(arrayBuffer));
      return result;
    }

    /**
     * Creates a clone of `dataView`.
     *
     * @private
     * @param {Object} dataView The data view to clone.
     * @param {boolean} [isDeep] Specify a deep clone.
     * @returns {Object} Returns the cloned data view.
     */
    function cloneDataView(dataView, isDeep) {
      var buffer = isDeep ? cloneArrayBuffer(dataView.buffer) : dataView.buffer;
      return new dataView.constructor(buffer, dataView.byteOffset, dataView.byteLength);
    }

    /** Used to match `RegExp` flags from their coerced string values. */
    var reFlags = /\w*$/;

    /**
     * Creates a clone of `regexp`.
     *
     * @private
     * @param {Object} regexp The regexp to clone.
     * @returns {Object} Returns the cloned regexp.
     */
    function cloneRegExp(regexp) {
      var result = new regexp.constructor(regexp.source, reFlags.exec(regexp));
      result.lastIndex = regexp.lastIndex;
      return result;
    }

    /** Used to convert symbols to primitives and strings. */
    var symbolProto = Symbol$1 ? Symbol$1.prototype : undefined,
        symbolValueOf = symbolProto ? symbolProto.valueOf : undefined;

    /**
     * Creates a clone of the `symbol` object.
     *
     * @private
     * @param {Object} symbol The symbol object to clone.
     * @returns {Object} Returns the cloned symbol object.
     */
    function cloneSymbol(symbol) {
      return symbolValueOf ? Object(symbolValueOf.call(symbol)) : {};
    }

    /**
     * Creates a clone of `typedArray`.
     *
     * @private
     * @param {Object} typedArray The typed array to clone.
     * @param {boolean} [isDeep] Specify a deep clone.
     * @returns {Object} Returns the cloned typed array.
     */
    function cloneTypedArray(typedArray, isDeep) {
      var buffer = isDeep ? cloneArrayBuffer(typedArray.buffer) : typedArray.buffer;
      return new typedArray.constructor(buffer, typedArray.byteOffset, typedArray.length);
    }

    /** `Object#toString` result references. */
    var boolTag$1 = '[object Boolean]',
        dateTag$1 = '[object Date]',
        mapTag$2 = '[object Map]',
        numberTag$1 = '[object Number]',
        regexpTag$1 = '[object RegExp]',
        setTag$2 = '[object Set]',
        stringTag$1 = '[object String]',
        symbolTag$1 = '[object Symbol]';

    var arrayBufferTag$1 = '[object ArrayBuffer]',
        dataViewTag$1 = '[object DataView]',
        float32Tag$1 = '[object Float32Array]',
        float64Tag$1 = '[object Float64Array]',
        int8Tag$1 = '[object Int8Array]',
        int16Tag$1 = '[object Int16Array]',
        int32Tag$1 = '[object Int32Array]',
        uint8Tag$1 = '[object Uint8Array]',
        uint8ClampedTag$1 = '[object Uint8ClampedArray]',
        uint16Tag$1 = '[object Uint16Array]',
        uint32Tag$1 = '[object Uint32Array]';

    /**
     * Initializes an object clone based on its `toStringTag`.
     *
     * **Note:** This function only supports cloning values with tags of
     * `Boolean`, `Date`, `Error`, `Map`, `Number`, `RegExp`, `Set`, or `String`.
     *
     * @private
     * @param {Object} object The object to clone.
     * @param {string} tag The `toStringTag` of the object to clone.
     * @param {boolean} [isDeep] Specify a deep clone.
     * @returns {Object} Returns the initialized clone.
     */
    function initCloneByTag(object, tag, isDeep) {
      var Ctor = object.constructor;
      switch (tag) {
        case arrayBufferTag$1:
          return cloneArrayBuffer(object);

        case boolTag$1:
        case dateTag$1:
          return new Ctor(+object);

        case dataViewTag$1:
          return cloneDataView(object, isDeep);

        case float32Tag$1: case float64Tag$1:
        case int8Tag$1: case int16Tag$1: case int32Tag$1:
        case uint8Tag$1: case uint8ClampedTag$1: case uint16Tag$1: case uint32Tag$1:
          return cloneTypedArray(object, isDeep);

        case mapTag$2:
          return new Ctor;

        case numberTag$1:
        case stringTag$1:
          return new Ctor(object);

        case regexpTag$1:
          return cloneRegExp(object);

        case setTag$2:
          return new Ctor;

        case symbolTag$1:
          return cloneSymbol(object);
      }
    }

    /**
     * Initializes an object clone.
     *
     * @private
     * @param {Object} object The object to clone.
     * @returns {Object} Returns the initialized clone.
     */
    function initCloneObject(object) {
      return (typeof object.constructor == 'function' && !isPrototype(object))
        ? baseCreate$1(getPrototype$1(object))
        : {};
    }

    /** `Object#toString` result references. */
    var mapTag$1 = '[object Map]';

    /**
     * The base implementation of `_.isMap` without Node.js optimizations.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a map, else `false`.
     */
    function baseIsMap(value) {
      return isObjectLike(value) && getTag$1(value) == mapTag$1;
    }

    /* Node.js helper references. */
    var nodeIsMap = nodeUtil$1 && nodeUtil$1.isMap;

    /**
     * Checks if `value` is classified as a `Map` object.
     *
     * @static
     * @memberOf _
     * @since 4.3.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a map, else `false`.
     * @example
     *
     * _.isMap(new Map);
     * // => true
     *
     * _.isMap(new WeakMap);
     * // => false
     */
    var isMap = nodeIsMap ? baseUnary(nodeIsMap) : baseIsMap;

    var isMap$1 = isMap;

    /** `Object#toString` result references. */
    var setTag$1 = '[object Set]';

    /**
     * The base implementation of `_.isSet` without Node.js optimizations.
     *
     * @private
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a set, else `false`.
     */
    function baseIsSet(value) {
      return isObjectLike(value) && getTag$1(value) == setTag$1;
    }

    /* Node.js helper references. */
    var nodeIsSet = nodeUtil$1 && nodeUtil$1.isSet;

    /**
     * Checks if `value` is classified as a `Set` object.
     *
     * @static
     * @memberOf _
     * @since 4.3.0
     * @category Lang
     * @param {*} value The value to check.
     * @returns {boolean} Returns `true` if `value` is a set, else `false`.
     * @example
     *
     * _.isSet(new Set);
     * // => true
     *
     * _.isSet(new WeakSet);
     * // => false
     */
    var isSet = nodeIsSet ? baseUnary(nodeIsSet) : baseIsSet;

    var isSet$1 = isSet;

    /** Used to compose bitmasks for cloning. */
    var CLONE_DEEP_FLAG$1 = 1,
        CLONE_FLAT_FLAG = 2,
        CLONE_SYMBOLS_FLAG$1 = 4;

    /** `Object#toString` result references. */
    var argsTag = '[object Arguments]',
        arrayTag = '[object Array]',
        boolTag = '[object Boolean]',
        dateTag = '[object Date]',
        errorTag = '[object Error]',
        funcTag = '[object Function]',
        genTag = '[object GeneratorFunction]',
        mapTag = '[object Map]',
        numberTag = '[object Number]',
        objectTag = '[object Object]',
        regexpTag = '[object RegExp]',
        setTag = '[object Set]',
        stringTag = '[object String]',
        symbolTag = '[object Symbol]',
        weakMapTag = '[object WeakMap]';

    var arrayBufferTag = '[object ArrayBuffer]',
        dataViewTag = '[object DataView]',
        float32Tag = '[object Float32Array]',
        float64Tag = '[object Float64Array]',
        int8Tag = '[object Int8Array]',
        int16Tag = '[object Int16Array]',
        int32Tag = '[object Int32Array]',
        uint8Tag = '[object Uint8Array]',
        uint8ClampedTag = '[object Uint8ClampedArray]',
        uint16Tag = '[object Uint16Array]',
        uint32Tag = '[object Uint32Array]';

    /** Used to identify `toStringTag` values supported by `_.clone`. */
    var cloneableTags = {};
    cloneableTags[argsTag] = cloneableTags[arrayTag] =
    cloneableTags[arrayBufferTag] = cloneableTags[dataViewTag] =
    cloneableTags[boolTag] = cloneableTags[dateTag] =
    cloneableTags[float32Tag] = cloneableTags[float64Tag] =
    cloneableTags[int8Tag] = cloneableTags[int16Tag] =
    cloneableTags[int32Tag] = cloneableTags[mapTag] =
    cloneableTags[numberTag] = cloneableTags[objectTag] =
    cloneableTags[regexpTag] = cloneableTags[setTag] =
    cloneableTags[stringTag] = cloneableTags[symbolTag] =
    cloneableTags[uint8Tag] = cloneableTags[uint8ClampedTag] =
    cloneableTags[uint16Tag] = cloneableTags[uint32Tag] = true;
    cloneableTags[errorTag] = cloneableTags[funcTag] =
    cloneableTags[weakMapTag] = false;

    /**
     * The base implementation of `_.clone` and `_.cloneDeep` which tracks
     * traversed objects.
     *
     * @private
     * @param {*} value The value to clone.
     * @param {boolean} bitmask The bitmask flags.
     *  1 - Deep clone
     *  2 - Flatten inherited properties
     *  4 - Clone symbols
     * @param {Function} [customizer] The function to customize cloning.
     * @param {string} [key] The key of `value`.
     * @param {Object} [object] The parent object of `value`.
     * @param {Object} [stack] Tracks traversed objects and their clone counterparts.
     * @returns {*} Returns the cloned value.
     */
    function baseClone(value, bitmask, customizer, key, object, stack) {
      var result,
          isDeep = bitmask & CLONE_DEEP_FLAG$1,
          isFlat = bitmask & CLONE_FLAT_FLAG,
          isFull = bitmask & CLONE_SYMBOLS_FLAG$1;

      if (customizer) {
        result = object ? customizer(value, key, object, stack) : customizer(value);
      }
      if (result !== undefined) {
        return result;
      }
      if (!isObject(value)) {
        return value;
      }
      var isArr = isArray$1(value);
      if (isArr) {
        result = initCloneArray(value);
        if (!isDeep) {
          return copyArray(value, result);
        }
      } else {
        var tag = getTag$1(value),
            isFunc = tag == funcTag || tag == genTag;

        if (isBuffer$1(value)) {
          return cloneBuffer(value, isDeep);
        }
        if (tag == objectTag || tag == argsTag || (isFunc && !object)) {
          result = (isFlat || isFunc) ? {} : initCloneObject(value);
          if (!isDeep) {
            return isFlat
              ? copySymbolsIn(value, baseAssignIn(result, value))
              : copySymbols(value, baseAssign(result, value));
          }
        } else {
          if (!cloneableTags[tag]) {
            return object ? value : {};
          }
          result = initCloneByTag(value, tag, isDeep);
        }
      }
      // Check for circular references and return its corresponding clone.
      stack || (stack = new Stack);
      var stacked = stack.get(value);
      if (stacked) {
        return stacked;
      }
      stack.set(value, result);

      if (isSet$1(value)) {
        value.forEach(function(subValue) {
          result.add(baseClone(subValue, bitmask, customizer, subValue, value, stack));
        });
      } else if (isMap$1(value)) {
        value.forEach(function(subValue, key) {
          result.set(key, baseClone(subValue, bitmask, customizer, key, value, stack));
        });
      }

      var keysFunc = isFull
        ? (isFlat ? getAllKeysIn : getAllKeys)
        : (isFlat ? keysIn : keys);

      var props = isArr ? undefined : keysFunc(value);
      arrayEach(props || value, function(subValue, key) {
        if (props) {
          key = subValue;
          subValue = value[key];
        }
        // Recursively populate clone (susceptible to call stack limits).
        assignValue(result, key, baseClone(subValue, bitmask, customizer, key, value, stack));
      });
      return result;
    }

    /** Used to compose bitmasks for cloning. */
    var CLONE_DEEP_FLAG = 1,
        CLONE_SYMBOLS_FLAG = 4;

    /**
     * This method is like `_.clone` except that it recursively clones `value`.
     *
     * @static
     * @memberOf _
     * @since 1.0.0
     * @category Lang
     * @param {*} value The value to recursively clone.
     * @returns {*} Returns the deep cloned value.
     * @see _.clone
     * @example
     *
     * var objects = [{ 'a': 1 }, { 'b': 2 }];
     *
     * var deep = _.cloneDeep(objects);
     * console.log(deep[0] === objects[0]);
     * // => false
     */
    function cloneDeep(value) {
      return baseClone(value, CLONE_DEEP_FLAG | CLONE_SYMBOLS_FLAG);
    }

    ({
        "__Type": "GameModeSelectionClientResponseGameModeParameters",
        "response": "ClientCommandsResponse_OK",
        /** @type {eClientCommands["Mode"]} */
        "mode": eClientCommands.Mode.Single,
        /** @type {eGameModeType} */
        "type": eGameModeType.None,
        /** @type {GameModeSelectionSession[]} */
        "sessions": [],
        /** @type eGame */
        "weather_type": eGameModeSelectionWeatherType.Custom,
        "weather_data": []
    });

    class GameModeSelectionManager extends BaseManager {

        Client = new MessageHandler("GameModeSelectionClient");
        SeasonInfoClient = new MessageHandler("SeasonInfo");

        /** @type {GameModeParameters} */
        Current = {};

        ///** @type {GameModeParameters} */
        Stored = {};


        /** @type {CarModel[]} */
        AvailableModels;

        /** @type {OpponentsContentData[]} */
        AvailableOpponents;

        get sessionZero() {
            return this.Current?.sessions[0];
        }

        constructor(parent_element) {
            super(null, parent_element);
        }

        updateDataFilters() {
            this.ParentElement.assignModel(this._dataFilters, "GameModeSelectionDataFilters");
        }

        getSeasonInfoParameters() {
            console.log("Requesting season info parameters");
            return new Promise((resolve, reject) => {
                this.SeasonInfoClient.request("SeasonInfo", (data) => {
                    console.trace("Received season info parameters", data);
                    this.assignModel(data, "SeasonInfo");
                    resolve(data);
                });
            });
        }

        getSessionInfoParameters() {
            console.log("Requesting session info parameters");
            return new Promise((resolve, reject) => {
                this.SeasonInfoClient.request("SessionInfo", (data) => {
                    console.trace("Received session info parameters", data);
                    this.assignModel(data, "SessionInfo");
                    resolve(data);
                });
            });
        }

        getGameModeParameters() {
            console.log("Requesting game mode parameters");
            return new Promise((resolve, reject) => {
                this.Client.request("GameModeParameters", {
                    mode: eClientCommands.Mode.Single
                }, (data) => {
                    console.trace("Received game mode parameters", data);
                    if (data.response == eClientCommands.Response.OK) {
                        //ksUI.iterate(data);
                        this.Stored = cloneDeep(data);

                        this.Current = data;
                        this.assignModel(data, "CurrentGameMode");


                        resolve(data);
                    } else {
                        reject(data);
                    }
                });
            });
        }

        getSession(session_name) {
            if (!session_name) {
                console.warn("No session name provided");
                return;
            }

            return this.Current.sessions.find(elem => elem.name.toLowerCase() == session_name.toLowerCase());
        }

        start() {
            return new Promise((resolve, reject) => {
                this.Client.request("Start",
                    {
                        mode: eClientCommands.Mode.Single
                    },
                    (data) => {
                        if (data.response == eClientCommands.Response.OK) {
                            localStorage.setItem("loadingDestination", "Session");
                            resolve(data);
                        } else {
                            reject(data);
                        }
                    });
            });
        }


        testDrive(car_model, callback) {
            console.log("GameModeSelection - requesting test drive", car_model.name);


            this.Client.request("TestDrive", {
                model: car_model
            }, (data) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        console.log("Test driving", car_model.name);
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Could not test drive", car_model.name, car_model.car_guid);
                    }
                }[data.response])?.();

                $.waitForFrames(() => {
                    if (callback) {
                        callback(data.response);
                    }            }, 1);
            });
        }

        refreshDataModel() {
            if (window["CurrentGameMode"])
                engine.updateWholeModel(CurrentGameMode);
        }

        /** 
         * @param {AiDriverData} opponent_skills
         * @param {GameModeSelectionOpponentChoice} opponent_choices 
         * */
        generateGrid(number_of_opponents, is_single_make, class_filter, aggressiveness, min_strength, max_strength, min_pi, max_pi) {

            const settings = {
                num_opponents: number_of_opponents,
                single_make: is_single_make,
                class_filter: class_filter,
                aggressivness_category: aggressiveness,
                min_strength: min_strength,
                max_strength: max_strength,
                min_pi: min_pi,
                max_pi: max_pi,
            };

            console.log("generateGrid", settings);

            return new Promise((resolve, reject) => {
                this.Client.request("Opponents", settings, (data) => {
                    if (data.response == eClientCommands.Response.OK) {
                        this.AvailableModels = data.all_ai_models;
                        this.AvailableOpponents = data.all_opponents;
                        resolve(data);
                    } else {
                        reject(data);
                    }
                });
            });
        }

        resetGridOptions() {
               console.log("resetGridOptions");

            return new Promise((resolve, reject) => {
                this.Client.request("ClearGridOptions", {}, (data) => {
                    console.log("Clear grid request ");
                    if (data.response == eClientCommands.Response.OK) {
                        console.log("Clear grid complete");
                        resolve();
                    } else {
                        console.log("Clear grid error");
                        reject();
                    }
                });
            });
        }

        reset() {
            console.warn("Reset gamemode options");

            this.Current = cloneDeep(this.Stored);
            this.assignModel(this.Current, "CurrentGameMode");
        }

        save(game_mode = this.Current.mode, sessions = this.Current.sessions, game_type) {

            console.trace("Save gamemode", game_mode, sessions, game_type);

            if ([eGameModeType.InstantRace, eGameModeType.RaceWeekend].indexOf(game_type) > -1 && sessions[0].grid_type == eGameModeSelection.GridType.Automatic) {
                if (sessions[0].num_opponents == 0) {
                    console.warn("Resetting num_opponents to 1");
                    sessions[0].num_opponents = 1;
                }
            }

            return new Promise((resolve, reject) => {
                this.Client.request("SetGameModeParameters", {
                    mode: game_mode,
                    sessions: sessions
                }, (data) => {
                    if (data.response == eClientCommands.Response.OK) {
                        //ksUI.iterate(data);
                        resolve(data);
                        this.Current.sessions = data.sessions;
                    } else {
                        reject(data);
                    }
                });

            });
        }


        loadAcademy() {
            return new Promise((resolve, reject) => {
                this.Client.request("DrivingAcademy", {
                    mode: eClientCommands.Mode.Single
                }, (data) => {
                    if (data.response == eClientCommands.Response.OK) {
                        resolve(data);
                    } else {
                        reject(data);
                    }
                });
            });
        }


    }

    var template$1E = "<div class=\"component-body focus-indicator\">\r\n    <div id=\"labelPositionLarge\">1</div>\r\n    <div class=\"divider\"></div>\r\n    <div id=\"labelPosition\">1</div>\r\n    \r\n    <div class=\"opponent-name is-flex align-items-end\">\r\n        <div id=\"labelDisplayName\"></div>\r\n        <div id=\"labelSkill\" data-l10n-id=\"labelSkill\"></div>\r\n        <div id=\"labelAISkill\">0</div>\r\n    </div>\r\n    \r\n    <div id=\"labelDisplayModelName\"></div>\r\n\r\n    <div id=\"bgr\"></div>\r\n    <div id=\"brand\"></div>\r\n    <div id=\"thumbnail\"></div>\r\n\r\n    <div id=\"pi\"></div>\r\n    \r\n    <ks-btnbasic id=\"btnUp\" class=\"focusable\"></ks-btnbasic>\r\n    <ks-btnbasic id=\"btnDown\" class=\"focusable\"></ks-btnbasic>\r\n    <ks-btnbasic id=\"btnDelete\" class=\"focusable\"></ks-btnbasic>\r\n</div>";

    class GridEditorItem extends KsHTMLElement {

        /** @type HTMLDivElement */
        labelPosition;

        /** @type HTMLDivElement */
        labelPositionLarge;

        /** @type HTMLDivElement */
        labelDisplayName;

        /** @type HTMLDivElement */
        labelAISkill;

        /** @type HTMLDivElement */
        labelDisplayModelName;

        /** @type HTMLDivElement */
        thumbnail;

        /** @type HTMLDivElement */
        brand;

        /** @type HTMLDivElement */
        pi;

        /** @type Btnbasic */
        btnUp;

        /** @type Btnbasic */
        btnDown;

        /** @type Btnbasic */
        btnDelete;

        /** @type CarModel */
        Model;

        /** @type OpponentsContentData */
        Opponent;

        refocusTarget;

        _position = 1;

        set Position(value) {
            this._position = value;
            this.labelPosition.innerHTML = value;
            this.labelPositionLarge.innerHTML = value;
        }

        get Position() {
            return this._position;
        }

        displayName = "";

        constructor() {
            super();
            this.template = template$1E;
        }

        bindControls() {

            this.btnUp.onPressed = (sender, e) => { this.moveUp(sender); };
            this.btnDown.onPressed = (sender, e) => { this.moveDown(sender); };
            this.btnDelete.onPressed = () => { this.delete(); };

            engine.on(EngineEvents.GameMode.GridReorder, () => {
                let position = 1;
                if (this.parentElement)
                    this.parentElement.childNodes.forEach(element => {
                        element.Position = position;
                        position++;
                    });

                if (this.refocusTarget) {
                    this.refocusTarget.focus();
                    this.refocusTarget = null;
                }

                ksUI$1.jiggleMouse();
            });

        }

        init() {
            super.init();
        }

        save() {
        }

        reordered() {
            //if(document.activeElement == this
        }

        highlight(direction) {
            this.classList.add("highlight");
            this.classList.add(direction);
            setTimeout(() => {
                this.classList.remove("highlight");
                this.classList.remove(direction);
            }, 1000);
        }

        moveUp(sender) {
            var upperSibling = this.previousElementSibling;
            if (!upperSibling) return;
            this.refocusTarget = (document.activeElement == sender) ? sender : null;
            upperSibling.insertAdjacentElement("beforebegin", this);
            engine.trigger(EngineEvents.GameMode.GridReorder);
            this.highlight("up");
        }

        moveDown(sender) {
            var lowerSibling = this.nextElementSibling;
            if (!lowerSibling) return;
            this.refocusTarget = (document.activeElement == sender) ? sender : null;
            lowerSibling.insertAdjacentElement("afterend", this);
            engine.trigger(EngineEvents.GameMode.GridReorder);
            this.highlight("down");
        }

        delete() {
            if (this.parentElement.childElementCount > 1) {
                this.parentElement.removeChild(this);
                engine.trigger(EngineEvents.GameMode.GridReorder);
            } else {
                ksUI$1.Audio(eAudioEvents.Cancel);
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("brand");
            this.mapElementById("thumbnail");
            this.mapElementById("labelDisplayName");
            this.mapElementById("labelAISkill");
            this.mapElementById("labelDisplayModelName");
            this.mapElementById("labelPosition");
            this.mapElementById("labelPositionLarge");
            this.mapElementById("btnUp");
            this.mapElementById("btnDown");
            this.mapElementById("btnDelete");
            this.mapElementById("pi");

            this.classList.add("focus-indicator");

            if (this.previousSibling) {
                this.Position = this.previousSibling.Position + 1;
            }

            if (!this.Opponent || !this.Model) {
                return;
            }

            this.labelDisplayName.innerHTML = [this.Opponent.first_name, this.Opponent.last_name].join(" ");
            this.labelAISkill.innerHTML = `${(this.Opponent.overall_strength * 100).toFixed(0)}%`;
            this.labelDisplayModelName.innerHTML = this.Model.display_name;

            this.pi.innerHTML = this.Model.performance_indicator.toFixed(1);


            const id = this.Model.manufacturer.name.toLowerCase().replace(" ", "_").replace("-", "_");
            this.thumbnail.style.backgroundImage = `url('/thumbnail_bypreset/${this.Model.name}/${this.Model.configuration.name}/${this.Model.preset.name}')`;
            this.brand.style.backgroundImage = `url('/branding/oem/${id}/logo.texture')`;
            //$.q("#bgr", this).style.backgroundImage = `url('/branding/oem/${id}/badge.texture')`;

        }


    }
    ksUI$1.registerModule('ks-griditem', GridEditorItem);

    class GridEditorPage extends KsHTMLElement {

        /** @typedef {import('../../.managers/GameModeSelectionManager').GameModeSelectionSession} GameModeSelectionSession */

        gridClassTypes = {
            Road: false,
            Race: false,
            Track: false,
            Modern: false,
            Vintage: false,
            YoungTimer: false,
            ICE: false,
            EV: false,
            Hybrid: false
        }

        get gridClassFilter() {
            return Object.values(this.gridClassTypes);
        }

        set gridClassFilter(array) {
            const keys = Object.keys(activePage.gridClassTypes);

            array.forEach((value, index) => {
                this.gridClassTypes[keys[index]] = value;
            });
        }

        isDirty = false;

        /** @type Btnbasic */
        btnGenerateGrid;

        /** @type Btnbasic */
        btnResetOptions;

        /** @type Btnbasic */
        btnBack;

        /** @type Btnbasic */
        btnApply;

        /** @type Btnbasic */
        btnCancel;

        /** @type HTMLDivElement */
        listOpponents;

        /** @type HTMLDivElement */
        listWrapper;

        /** @type HTMLDivElement */
        panelOptions;

        /** @type HTMLDivElement */
        panelNotifications;

        /** @type HTMLDivElement */
        currentCarPI;

        /** @type KsSlider */
        sliderOpponentNumber;

        /** @type KsSlider */
        sliderOpponentSkill;

        /** @type KsSlider */
        sliderOpponentBehaviour;

        /** @type KsSlider */
        sliderOpponentPI;

        /** @type { CarModel[] } */
        currentModelGrid = [];

        /** @type { CarModel[] } */
        currentOpponentGrid = [];

        /** @type { CarModel[] } */
        backupModelGrid = [];

        /** @type { CarModel[] } */
        backupOpponentGrid = [];


        /** @type { GridEditorItem[] } */
        items = [];

        saveDebounce = { id: 0 };

        get singleMake() {
            return q("ks-btnbasic[data-setting=single_make][data-mode=true]", this).classList.contains("selected");
        }


        get numberOfOpponents() {
            return this.sliderOpponentNumber.value;
        }

        set numberOfOpponents(value) {
            this.sliderOpponentNumber.value = value;
        }

        get minSkill() {
            return this.sliderOpponentSkill.value[0];
        }

        get maxSkill() {
            return this.sliderOpponentSkill.value[1];
        }

        get minPI() {
            return this.sliderOpponentPI.value[0];
        }

        get maxPI() {
            return this.sliderOpponentPI.value[1];
        }

        get aggressiveness() {
            return q("ks-slider[data-setting=aggressiveness]", this).value;
        }


        constructor() {
            super();
            this.template = template$1F;
            this._exposeAsActivePage = true;
            this._isnavigable = true;
            this._bindScrollableEvents = true;
        }

        highlightGenBtn() {
            this.btnGenerateGrid.classList.add("highlight");
            setTimeout(() => {
                this.btnGenerateGrid.classList.remove("highlight");
            }, 1000);
            //$.waitForFrames(() => {

            //});
        }


        bindControls() {

            qevAll("ks-slider", "onSliderValueChanged", (ev) => {
                this.highlightGenBtn();
            });

            qAll("ks-btnbasic", this.panelOptions).forEach(btn => {
                btn.onToggled = (sender, e, state) => {

                    if (sender.dataset.setting == "single_make") {
                        this.classList.toggle("single-make", this.singleMake);
                    }

                    this.highlightGenBtn();
                };
            });

            qAll(".vehicle-category ks-btnbasic").forEach(btn => {
                btn.onToggled = (sender, e, state) => {
                    this.gridClassTypes[sender.dataset.setting] = state;

                    this.highlightGenBtn();
                };
            });

            this.btnGenerateGrid.onPressed = (sender, e) => {
                this.dataset.stage = "loading";
                this.classList.remove("error");
                GAMEMODESELECTION.generateGrid(
                    this.numberOfOpponents,
                    this.singleMake,
                    this.gridClassFilter,
                    this.aggressiveness,
                    this.minSkill,
                    this.maxSkill,
                    this.minPI,
                    this.maxPI
                ).then(data => {
                    // console.log(this.numberOfOpponents, this.singleMake, JSON.stringify(this.opponentSkill), JSON.stringify(this.weights));
                    this.populateGrid(data.models, data.opponents);
                    this.currentModelGrid = [];
                    this.currentOpponentGrid = [];
                    Object.assign(this.currentModelGrid, data.models);
                    Object.assign(this.currentOpponentGrid, data.opponents);
                    console.trace("Current opponent grid", data.models, data.opponents, this.currentModelGrid, this.currentOpponentGrid);
                    this.dataset.stage = "done";
                }).catch(data => {
                    if (data.response == eClientCommands.Response.NoAvailableCars) {
                        console.warn("No available cars for the criteria provided");

                        this.dataset.stage = "error";
                        this.classList.add("error");
                        this.panelNotifications.innerHTML = engine.translate("lblCustomGridNoAvailableCars");

                    }
                });
                this.markDirty();
            };

            const resetOptionsModal = function () {

                this.pageModal.Show({
                    type: eModalDialogTypes.Warning,
                    buttons: 0x101,
                    title: "lblAreYouSure",
                    message: "msgResetOptions"
                });

                this.pageModal.onConfirm = () => {
                    GAMEMODESELECTION.resetGridOptions().then(() => {
                        this.loadInitialData(false).then(() => { activePage.btnGenerateGrid.press(); });
                    });

                };

            };


            this.btnResetOptions.onPressed = (sender, e) => {
                resetOptionsModal.bind(this)();
            };

        }

        init() {
            super.init();

        }

        markDirty() {
            this.isDirty = true;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.removeAttribute("disabled");
            });
        }

        clearDirty() {
            this.isDirty = false;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.setAttribute("disabled", true);
            });
        }

        reset() {
            console.log("Grid reverted");
            this.currentModelGrid.length = 0;
            Object.assign(this.currentModelGrid, this.backupModelGrid);
            this.populateGrid(this.backupModelGrid, this.backupOpponentGrid);
            this.sliderOpponentNumber.value = this.currentModelGrid.length;
            this.classList.remove("error");
            this.clearDirty();
        }

        save() {
            console.log("Grid saved");

            GAMEMODESELECTION.Current.sessions[0].models.length = 0;
            GAMEMODESELECTION.Current.sessions[0].opponents.length = 0;
            GAMEMODESELECTION.Current.sessions[0].min_strength = this.minSkill;
            GAMEMODESELECTION.Current.sessions[0].max_strength = this.maxSkill;
            GAMEMODESELECTION.Current.sessions[0].min_pi = this.minPI;
            GAMEMODESELECTION.Current.sessions[0].max_pi = this.maxPI;
            GAMEMODESELECTION.Current.sessions[0].class_filter = this.gridClassFilter;
            GAMEMODESELECTION.Current.sessions[0].aggressivness = this.aggressiveness;
            GAMEMODESELECTION.Current.sessions[0].single_make = this.singleMake;
            GAMEMODESELECTION.Current.sessions[0].grid_type = eGameModeSelection.GridType.Custom;


            Object.assign(GAMEMODESELECTION.Current.sessions[0].models, this.currentModelGrid);
            Object.assign(GAMEMODESELECTION.Current.sessions[0].opponents, this.currentOpponentGrid);

            this.backupModelGrid.length = 0;
            this.backupOpponentGrid.length = 0;

            Object.assign(this.backupModelGrid, this.currentModelGrid);
            Object.assign(this.backupOpponentGrid, this.currentOpponentGrid);

            console.log(GAMEMODESELECTION.Current.sessions[0].opponents);

            GAMEMODESELECTION.save();
            this.clearDirty();
        }

        /** 
         * @param {CarModel[]} source_models 
         * @param {OpponentsContentData[]} source_opponents 
         * 
        */
        populateGrid(source_models, source_opponents) {
            if (!GAMEMODESELECTION.Current) {
                console.error("populateGrid before getGameModeParameters");
                return;
            }

            this.items.length = 0;
            this.listOpponents.innerHTML = "";

            let index = 0;

            this.classList.toggle("single-opponent", source_models.length == 1);


            this.btnGenerateGrid.disable();
            q("#listWrapper", this).scrollLeft = 0;
            source_models.forEach(
                /** @type CarModel */
                car_model => {
                    /** @type GridEditorItem */
                    const item = document.createElement("ks-griditem");
                    //item.classList.add("focusable");
                    //item.setAttribute("lazyload", true);
                    //item.lazyLoad = true;
                    item.Model = car_model;
                    item.Opponent = source_opponents[index];
                    //console.log("adding item with", car_model, source_opponents[index]);
                    //item.innerHTML = opponent.display_name;
                    let delay = 0;

                    if (index < 10) {
                        delay = index;
                    } else {
                        delay = 10;
                    }

                    this.listOpponents.classList.add("populating");
                    this.listWrapper.classList.add("loading");

                    waitForFrames(
                        () => {
                            this.listOpponents.appendChild(item);
                            this.items.push(item);
                            if (this.items.length == source_models.length) {
                                waitForFrames(() => {
                                    this.btnGenerateGrid.enable();
                                    this.listOpponents.classList.remove("populating");

                                }, 1);
                            }
                        },
                        delay);

                    index++;

                });



            waitForFrames(() => {
                this.updateAllScrollBars();
                this.listWrapper.classList.remove("loading");
                this.setupNavigation();
            }, 30);

            if (source_models.length == 0) {
                this.btnGenerateGrid.enable();
            }

        }


        onAfterRenderControlHints(controlhints) {
            this.mapElementById("btnBack", controlhints);
            this.mapElementById("btnApply", controlhints);
            this.mapElementById("btnCancel", controlhints);

            this.btnApply.onPressed = (sender, e) => {
                this.save();
            };

            function back() {
                ksUI$1.changePage("singleplayer/gamemode");
            }

            const sender = this;

            const changePage = function () {
                if (sender.isDirty) {

                    sender.pageModal.Show({
                        type: eModalDialogTypes.Warning,
                        title: "lblChangesDetected",
                        message: "msgChangesWarning",
                        confirm: "btnApply"
                    });

                    sender.pageModal.onDiscard = () => {
                        sender.reset();
                        waitForFrames(() => {
                            back();
                        }, 6);

                    };

                    sender.pageModal.onConfirm = () => {
                        sender.save();
                        back();

                    };
                } else {
                    back();

                }
            };

            this.btnBack.onPressed = () => {
                changePage();
            };


            this.btnApply.onPressed = () => this.save();
            this.btnCancel.onPressed = () => this.reset();


        }

        loadInitialData(populate = true) {
            return new Promise((resolve, reject) => {
                GAMEMODESELECTION.getGameModeParameters().then(


                    data => {

                        /** @type {GameModeSelectionSession} */
                        const sessionzero = data.sessions[0];



                        Object.assign(this.currentModelGrid, sessionzero.models);
                        Object.assign(this.backupModelGrid, sessionzero.models);

                        Object.assign(this.currentOpponentGrid, sessionzero.opponents);
                        Object.assign(this.backupOpponentGrid, sessionzero.opponents);


                        if (sessionzero.models.length > sessionzero.track_item.max_drivers) {
                            this.numberOfOpponents = sessionzero.track_item.max_drivers;
                            waitForFrames(() => {
                                this.btnGenerateGrid.press();
                            }, 3);

                            waitForFrames(() => {
                                this.updateAllScrollBars();
                            }, 60);

                            return;
                        }

                        this.sliderOpponentNumber.value = Math.max(1, this.currentModelGrid.length);

                        this.sliderOpponentNumber.max = sessionzero.track_item.max_drivers - 1;

                        this.sliderOpponentSkill.value = [sessionzero.min_strength, sessionzero.max_strength];


                        this.sliderOpponentBehaviour.value = "Normal";
                        this.sliderOpponentBehaviour.value = sessionzero.aggressivness;

                        this.sliderOpponentPI.min = Math.floor(sessionzero.min_evo_pi);
                        this.sliderOpponentPI.max = Math.ceil(sessionzero.max_evo_pi);

                        this.sliderOpponentPI.value = [Math.floor(sessionzero.min_pi), Math.ceil(sessionzero.max_pi)];

                        this.gridClassFilter = sessionzero.class_filter;

                        qAll(".vehicle-category ks-btnbasic").forEach(btn => {
                            btn.toggle(this.gridClassTypes[btn.dataset.setting]);
                        });

                        if (populate) this.populateGrid(data.sessions[0].models, data.sessions[0].opponents);

                        qAll(".single-make ks-btnbasic", this).forEach(
                            /** @param {Btnbasic} elem */
                            elem => {
                                let elem_bool = elem.dataset.mode === 'true';
                                let toggle_on = elem_bool == data.sessions[0].single_make;
                                elem.classList.toggle("selected", toggle_on);
                            });

                        this.classList.toggle("single-make", this.singleMake);
                        this.currentCarPI.style.left = `${ksUI$1.range(CurrentCar.model.performance_indicator, Math.floor(sessionzero.min_evo_pi), Math.ceil(sessionzero.max_evo_pi), 20.5, 47)}rem`;

                        resolve();
                    });
            });

        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("btnGenerateGrid");
            this.mapElementById("btnResetOptions");
            this.mapElementById("listWrapper");
            this.mapElementById("listOpponents");
            this.mapElementById("sliderOpponentNumber");
            this.mapElementById("sliderOpponentSkill");
            this.mapElementById("sliderOpponentBehaviour");
            this.mapElementById("sliderOpponentPI");
            this.mapElementById("panelNotifications");
            this.mapElementById("currentCarPI");

            this.sliderOpponentBehaviour.valueFilter = (value_to_filter) => {
                return engine.translate(`lblBehaviour${value_to_filter}`);
            };


            engine.on(EngineEvents.GameMode.GridReorder, () => {
                this.currentModelGrid = [];
                this.currentOpponentGrid = [];
                qAll("ks-griditem", this).forEach(item => {
                    this.currentModelGrid.push(item.Model);
                    this.currentOpponentGrid.push(item.Opponent);
                });
                this.sliderOpponentNumber.value = this.currentModelGrid.length;
                waitForFrames(() => {
                    this.listWrapper.scrollToFocused(document.activeElement.closest("ks-griditem"));
                    //console.log(document.activeElement.closest(".focus-indicator"));
                }, 3);

                this.classList.toggle("single-opponent", this.currentModelGrid.length == 1);

                this.markDirty();
            });


            this.loadInitialData();


        }

    }
    ksUI$1.registerModule('ks-page-grideditor', GridEditorPage);

    const mapGameModes = {
        [eGameModeType.Practice]: "practice",
        [eGameModeType.InstantRace]: "quickrace",
        [eGameModeType.RaceWeekend]: "raceweekend"
    };

    const mapRaceType = {
        [eGameModeSelection.RaceType.Laps]: "laps",
        [eGameModeSelection.RaceType.Time]: "time"
    };

    const mapGridType = {
        [eGameModeSelection.GridType.Automatic]: "autogrid",
        [eGameModeSelection.GridType.Custom]: "customgrid"
    };

    const revMap = (type, obj) => {
        for (const key in obj) {
            if (type == obj[key])
                return key;
        }
    };

    class GameModePage extends KsHTMLElement {

        /** @type {Btnbasic} */
        btnEditGrid;

        isDirty = false;

        /** @type HTMLDivElement */
        panelSelectors;
        /** @type HTMLDivElement */
        panelSettings;
        /** @type HTMLDivElement */
        panelRaceType;
        /** @type HTMLDivElement */
        panelGridType;
        /** @type HTMLDivElement */
        panelSingleMake;

        initialGameMode;
        previousGameMode;

        activeGameMode;
        activeRaceType;
        activeGridType;

        /** @typedef {import('../singleplayer/singleplayer').default} SinglePlayerPage */
        /** @type { SinglePlayerPage } */
        rootPage;

        constructor() {
            super();
            this.template = template$1G;
            this._exposeAsActivePage = true;
            this._isnavigable = true;
            this.delayedInit = true;
            this._bindScrollableEvents = true;
        }

        bindControls() {

            this.btnEditGrid.onPressed = () => {
                if (this.isDirty) {
                    this.clearDirty();
                    GAMEMODESELECTION.Current.sessions[0].grid_type = eGameModeSelection.GridType.Custom;
                    GAMEMODESELECTION.save().then(data => {
                        ksUI$1.changePage("singleplayer/grideditor");
                    });

                    // this.pageModal.Show({
                    //     type: eModalDialogTypes.Warning,
                    //     title: "lblChangesDetected",
                    //     message: "msgChangesWarning",
                    //     confirm: "btnApply"
                    // });

                    // this.pageModal.onCancel = () => {
                    //     $.q("ks-btnbasic[data-mode=" + mapGameModes[this.activeGameMode] + "]", this.panelSelectors)?.toggle(true, true);
                    // };

                    // this.pageModal.onDiscard = () => {
                    //     this.reset(false, () => {
                    //         this.clearDirty();
                    //         GAMEMODESELECTION.Current.sessions[0].grid_type = eGameModeSelection.GridType.Custom;
                    //         GAMEMODESELECTION.save();
                    //         $.waitForFrames(() => ksUI.changePage("singleplayer/grideditor"), 2);
                    //     });
                    // }

                    // this.pageModal.onConfirm = () => {
                    //     this.save().then(() => {
                    //         ksUI.changePage("singleplayer/grideditor");
                    //     });
                    // };
                } else {
                    ksUI$1.changePage("singleplayer/grideditor");
                }
            };

            qAll("ks-slider[data-setting=starttime]", this.panelSettings).forEach(
                /** @param {KsSlider} elem */
                elem => {
                    elem.valueFilter = (value_to_filter) => {
                        return ksUI$1.minutesToTime(value_to_filter);
                    };

                });

            qAll("ks-btnbasic", this.panelSelectors).forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        if (state) {

                            const gamemode = sender.dataset.mode;
                            const gamemodetype = revMap(gamemode, mapGameModes);

                            if (this.isDirty && !this.#resetting) {

                                this.pageModal.Show({
                                    type: eModalDialogTypes.Warning,
                                    title: "lblChangesDetected",
                                    message: "msgChangesWarning",
                                    confirm: "btnApply"
                                });

                                this.pageModal.onCancel = () => {
                                    q("ks-btnbasic[data-mode=" + mapGameModes[this.activeGameMode] + "]", this.panelSelectors)?.toggle(true, true);
                                };

                                this.pageModal.onDiscard = () => {
                                    this.reset(false);
                                    this.clearDirty();
                                    q("ks-btnbasic[data-mode=" + gamemode + "]", this.panelSelectors)?.toggle(true, true);
                                };

                                this.pageModal.onConfirm = () => {
                                    this.save().then(() => {
                                        q("ks-btnbasic[data-mode=" + gamemode + "]", this.panelSelectors)?.toggle(true, true);
                                    });
                                };

                                return;
                            }

                            this.rootPage.GameModeSelectionClient.request("SetGameType",
                                {
                                    mode: eClientCommands.Mode.Single,
                                    type: gamemodetype
                                },
                                (data) => {

                                    this.#resetting = true;
                                    console.log("Response from SetGameType");

                                    if (data.response == eClientCommands.Response.OK) {
                                        console.log("Changed to", gamemode, gamemodetype);

                                        GAMEMODESELECTION.getGameModeParameters().then(() => {
                                            if (this.activeGameMode == GAMEMODESELECTION.Current.type) {
                                                console.warn("GameMode type returned is the same");
                                                const gamemode_button = q("ks-btnbasic[data-mode=" + mapGameModes[GAMEMODESELECTION.Current.type] + "]", this.panelSelectors);
                                                //if (gamemode_button) {
                                                gamemode_button.toggle(true);
                                                //} else {
                                                //}

                                                ///$.q("ks-btnbasic[data-mode=" + mapGameModes[GAMEMODE.Current.type] + "]", this.panelSelectors).toggle(true);
                                            }
                                            this.panelSettings.dataset.mode = mapGameModes[GAMEMODESELECTION.Current.type];
                                            this.gameModeChanged(GAMEMODESELECTION.Current.type);
                                            waitForFrames(() => {
                                                this.updateAllScrollBars();
                                            });
                                            this.#resetting = false;

                                        });
                                    } else {
                                        console.error("Unable to change gamemode to", gamemode);
                                        this.#resetting = false;
                                    }

                                });
                        }
                    };
                });

            qAll("ks-btnbasic", this.panelRaceType).forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        if (state) {
                            this.panelSettings.dataset.racetype = sender.dataset.racetype;
                            this.activeRaceType = sender.dataset.racetype;
                            this.settingsPanelChange();

                            GAMEMODESELECTION.getSession("race").duration_type = revMap(sender.dataset.racetype, mapRaceType);

                            let duration_value = q("ks-slider[data-setting=duration]." + sender.dataset.racetype).value;

                            if (this.activeRaceType == "time") {
                                duration_value = duration_value * 60;
                            }

                            if (duration_value != undefined && !isNaN(duration_value) && !this.#resetting) {
                                GAMEMODESELECTION.getSession("race").duration = duration_value;
                            }

                            this.markDirty();

                        }
                    };
                });

            qAll("ks-btnbasic", this.panelGridType).forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        if (state) {
                            this.panelSettings.dataset.gridtype = sender.dataset.gridtype;
                            this.activeGridType = sender.dataset.gridtype;
                            this.settingsPanelChange();

                            //this.rootPage.getSession("race").grid_type = revMap(sender.dataset.gridtype, mapGridType);
                            GAMEMODESELECTION.Current.sessions[0].grid_type = revMap(sender.dataset.gridtype, mapGridType);

                            const starting_position = this.getSlider("race", "starting_position");

                            if(this.activeGameMode == eGameModeType.InstantRace)
                                starting_position.max = (this.activeGridType == "customgrid") ? GAMEMODESELECTION.sessionZero.models.length + 1 : GAMEMODESELECTION.sessionZero.num_opponents + 1;

                            

                            this.markDirty();
                            waitForFrames(() => {
                                this.updateAllScrollBars();
                            }, 3);

                        }
                    };
                });

            qAll("ks-btnbasic", this.panelSingleMake).forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        if (state) {
                            GAMEMODESELECTION.Current.sessions[0].single_make = sender.dataset.mode === "true";
                            this.settingsPanelChange();

                            this.markDirty();
                        }
                    };
                });

            qevAll("ks-slider", "onSliderValueChanged", (ev) => {
                const detail = ev.detail;
                const sender = detail.sender;
                const value = detail.value;
                const slidersession = sender.dataset.session;
                const slidersetting = sender.dataset.setting;
                const sliderproperty = sender.dataset.property;


                console.trace("Value changed", slidersession, slidersetting, sliderproperty, value);
                //const num_opponents = this.getSlider("autogrid", "num_opponents").value;
                const starting_position = this.getSlider("race", "starting_position");

                const num_opponents = this.activeGridType == "customgrid" ? GAMEMODESELECTION.sessionZero.models.length : this.getSlider("autogrid", "num_opponents").value;

                starting_position.preventEvent = true;
                if (starting_position.value > num_opponents) {

                    starting_position.max = num_opponents + 1;
                    starting_position.value = num_opponents + 1;
                } else {
                    starting_position.max = num_opponents + 1;
                }
                starting_position.preventEvent = false;

                function setSessionValues(session_name, is_laps = false) {
                    const session = session_name ? GAMEMODESELECTION.getSession(session_name) : GAMEMODESELECTION.Current.sessions[0];

                    let special_settings = {
                        "duration": () => {
                            session.duration = is_laps ? value : value * 60;
                        },

                        "starttime": () => {
                            const time = ksUI$1.minutesToTime(value, true);
                            session.time_of_day.hour = time[0];
                            session.time_of_day.minute = time[1];
                        },

                        "average_skill": () => {
                            session.average_skill = value / 100;
                        },

                        "min_max_strength": () => {
                            session.min_strength = value[0];
                            session.max_strength = value[1];
                        },

                        "time_multiplier": () => {
                            session.time_of_day.time_multiplier = value;
                        }
                    };

                    let settingFunction = special_settings[slidersetting];

                    if (settingFunction) {
                        settingFunction();
                    } else {
                        session[slidersetting] = value;
                    }
                }

                ({

                    [eGameModeType.Practice]: () => {
                        setSessionValues(slidersession);
                    },

                    [eGameModeType.InstantRace]: () => {
                        setSessionValues(slidersession, this.activeRaceType == "laps");
                    },

                    [eGameModeType.RaceWeekend]: () => {
                        setSessionValues(slidersession, slidersession == "race" ? this.activeRaceType == "laps" : false);
                    }

                }[this.activeGameMode])();

                //cancelAnimationFrame(this.saveDebounce.id);


                waitForFrames(() => {

                    this.markDirty();
                }, 6, this.saveDebounce);

            }, this.panelSettings);

        }

        saveDebounce = { id: 0 };

        /** @returns {KsSlider} */
        getSlider(session, setting, property) {

            return property ? q("ks-slider." + session + "[data-setting=" + setting + "][data-property=" + property + "]") : q("ks-slider." + session + "[data-setting=" + setting + "]");
        }




        gameModeChanged(gamemodetype) {

            if (!this.initialGameMode) this.initialGameMode = gamemodetype;
            this.activeGameMode = gamemodetype;

            this.classList.remove("notrack");


            this.settingsPanelChange(true);

            const sessionZero = GAMEMODESELECTION.Current.sessions[0];

            const setPractice = (minimum_time = 0) => {
                const session = GAMEMODESELECTION.Current.sessions[0];


                if (minimum_time > 0 && session.duration < minimum_time) {
                    session.duration = minimum_time * 60;
                }

                this.getSlider("practice", "duration").min = minimum_time;
                this.getSlider("practice", "duration").valueNoEvent = session.duration / 60;
                this.getSlider("practice", "starttime").valueNoEvent = (session.time_of_day.hour * 60) + session.time_of_day.minute;
                this.getSlider("practice", "time_multiplier").valueNoEvent = session.time_of_day.time_multiplier;
            };

            const setQualifying = () => {
                const session = GAMEMODESELECTION.Current.sessions[1];
                this.getSlider("qualifying", "duration").valueNoEvent = session.duration / 60;
                this.getSlider("qualifying", "starttime").valueNoEvent = (session.time_of_day.hour * 60) + session.time_of_day.minute;
                this.getSlider("qualifying", "time_multiplier").valueNoEvent = session.time_of_day.time_multiplier;
            };

            const setWarmup = () => {
                const session = GAMEMODESELECTION.Current.sessions[2];
                this.getSlider("warmup", "duration").valueNoEvent = session.duration / 60;
                this.getSlider("warmup", "starttime").valueNoEvent = (session.time_of_day.hour * 60) + session.time_of_day.minute;
            };

            const setRace = (is_quick_race) => {
                const session = GAMEMODESELECTION.Current.sessions[is_quick_race ? 0 : 3];

                q("ks-btnbasic[data-gridtype=" + mapGridType[sessionZero.grid_type] + "]", this.panelGridType).toggle(true, true);

                q("ks-btnbasic[data-mode=" + sessionZero.single_make + "]", this.panelSingleMake).toggle(true, true);

                q("ks-btnbasic[data-racetype=" + mapRaceType[session.duration_type] + "]", this.panelRaceType).toggle(true, true);

                this.getSlider(mapRaceType[session.duration_type], "duration").valueNoEvent = mapRaceType[session.duration_type] == "laps" ? session.duration : session.duration / 60;
                this.getSlider("race", "starttime").valueNoEvent = (session.time_of_day.hour * 60) + session.time_of_day.minute;

                //if (session.grid_type == eGameModeSelection.GridType.Automatic) {
                this.getSlider("autogrid", "num_opponents").max = sessionZero.track_item.max_drivers - 1;
                this.getSlider("autogrid", "num_opponents").valueNoEvent = sessionZero.num_opponents;
                this.getSlider("autogrid", "min_max_strength").valueNoEvent = [sessionZero.min_strength, sessionZero.max_strength];
                this.getSlider("autogrid", "aggressivness").valueNoEvent = sessionZero.aggressivness;
                //}

                if (this.getSlider("race", "starting_position")) {

                    if (is_quick_race) {
                        const num_opponents = sessionZero.grid_type == eGameModeSelection.GridType.Custom ? sessionZero.models.length + 1 : sessionZero.num_opponents + 1;
                        this.getSlider("race", "starting_position").max = num_opponents;
                        this.getSlider("race", "starting_position").valueNoEvent = session.starting_position;
                    }
                    this.getSlider("race", "time_multiplier").valueNoEvent = session.time_of_day.time_multiplier;
                }


                this.classList.toggle("notrack", sessionZero.track_item.max_drivers < 1);
            };


            //try {
            ({

                [eGameModeType.Practice]: () => {
                    setPractice(1);
                },

                [eGameModeType.InstantRace]: () => {
                    setRace(true);
                },

                [eGameModeType.RaceWeekend]: () => {
                    setPractice();
                    setQualifying();
                    setWarmup();
                    setRace(false);
                }

            }[gamemodetype])();

            // } catch(error) {
            //     console.error("Gamemode not supported");
            //     setPractice(1);
            // }



        }

        settingsPanelChange(transition = false) {
            qAll("ks-slider", this.panelSettings).forEach(elem => elem.slider.setup());

            if (transition) {
                this.panelSettings.classList.remove("transition");
                waitForFrames(() => this.panelSettings.classList.add("transition"));
            }
        }

        init() {
            super.init();
            this.#resetting = true;
            waitForFrames(() => {
                const gamemode_button = q("ks-btnbasic[data-mode=" + mapGameModes[GAMEMODESELECTION.Current.type] + "]", this.panelSelectors);
                if (gamemode_button) {
                    gamemode_button.toggle(true, true);
                    waitForFrames(() => this.#resetting = false, 1);
                } else {
                    console.error("Unsupported gamemode");
                    this.errorModal("lblError", "msgErrorUnsupportedGameMode", true);
                }

            }, 1);

        }

        markDirty() {
            //console.trace("markdirty");
            if (this.#resetting) return;
            this.isDirty = true;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.removeAttribute("disabled");
            });
        }

        clearDirty() {
            this.isDirty = false;
            [this.btnApply, this.btnCancel].map(btn => {
                if (btn)
                    btn.setAttribute("disabled", true);
            });
        }

        onAfterRenderControlHints(controlhints) {
            this.btnBack = q(".back", controlhints);
            this.btnApply = q(".apply", controlhints);
            this.btnCancel = q(".cancel", controlhints);

            const changePage = function (target) {

                if (this.isDirty) {

                    this.pageModal.Show({
                        type: eModalDialogTypes.Warning,
                        title: "lblChangesDetected",
                        message: "msgChangesWarning",
                        confirm: "btnApply"
                    });

                    this.pageModal.onDiscard = () => {
                        this.reset(false, () => {
                            waitForFrames(() => ksUI$1.changePage(target, false, false), 1);

                        });

                    };

                    this.pageModal.onConfirm = () => {
                        this.save().then(() => {
                            ksUI$1.changePage(target, false, false);
                        });
                    };
                } else {
                    ksUI$1.changePage(target, false, false);
                }
            };

            this.btnBack.onPressed = () => {
                changePage.bind(this)("singleplayer/main");
            };


            this.btnApply.onPressed = () => this.save();
            this.btnCancel.onPressed = () => this.reset(false);
        }

        #resetting = false;

        reset(retoggle = true, callback) {
            this.#resetting = true;
            GAMEMODESELECTION.reset();

            this.activeGameMode = this.initialGameMode;

            waitForFrames(() => {

                if (retoggle)
                    q("ks-btnbasic[data-mode=" + mapGameModes[this.initialGameMode] + "]", this.panelSelectors)?.toggle(true, true);
                //this.gameModeChanged(this.initialGameMode);
                this.init();

                this.#resetting = false;

                if (callback)
                    callback();
            }, 1);

            this.clearDirty();
        }

        save(clear_dirty = true) {
            ksUI$1.groupTrace("Current Session saved", GAMEMODESELECTION.Current.sessions);
            return new Promise((resolve, reject) => {

                //            cancelAnimationFrame(this.saveDebounce.id);


                GAMEMODESELECTION.save(eClientCommands.Mode.Single, GAMEMODESELECTION.Current.sessions, this.activeGameMode).then(() => {
                    if (clear_dirty) this.clearDirty();
                    resolve();
                });
            });
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("panelSelectors");
            this.mapElementById("panelSettings");
            this.mapElementById("panelRaceType");
            this.mapElementById("panelGridType");
            this.mapElementById("panelSingleMake");

            this.mapElementById("btnEditGrid");


            q("#sliderOpponentBehaviour", this).valueFilter = (value_to_filter) => {
                return engine.translate(`lblBehaviour${value_to_filter}`);
            };

            this.getSlider("race", "starting_position").valueFilter = (value_to_filter) => {
                if (value_to_filter == 0) return engine.translate("lblRandomUpper");
                else return value_to_filter;
            };

            this.initTabHandler(this.panelSelectors);
        }


    }
    ksUI$1.registerModule('ks-page-gamemode', GameModePage);

    var template$1D = "<div class=\"component-body\">\r\n    <div id=\"panelStats\" class=\"is-flex-row\">\r\n        <div id=\"panelWallet\" data-bind-value=\"{{ModelUIDriverState.money}}\"></div>\r\n        <div id=\"panelLicense\" data-bind-l10n-id=\"{{ModelUIDriverState.license_type}}\"></div>\r\n    </div>\r\n    <div id=\"panelCurrentLevel\">\r\n        <div data-bind-value=\"{{ModelUIDriverState.current_level}}\"></div>\r\n    </div>\r\n    <div id=\"panelProgressBar\">\r\n        <div class=\"bar\" data-bind-thing=\"playerprogress_XP({{ModelUIDriverState}})\"></div>\r\n        <div class=\"indicator\" data-bind-style-left=\"playerprogress_XP({{ModelUIDriverState}})\"></div>\r\n    </div>\r\n    <div id=\"panelName\" data-bind-value=\"{{ModelUIDriverState.driver_name}} + ' ' + {{ModelUIDriverState.driver_surname}}\">\r\n    </div>\r\n    <div id=\"openmode\" sdata-l10n-id=\"lblSandboxMode\"></div>\r\n</div>";

    class PlayerProgress extends KsHTMLElement {

        progressbar;
        progressindicator;
        previousPercentage = 0;
        previousXP = 0;
        previousRank = 0;

        constructor() {
            super();
            this.template = template$1D;
            this.delayedInit = true;
            this.clearAssignedFilters();
        }

        filters = {
            playerprogress_XP: (obj) => {
                const percentage = Math.min((obj.xp_points - ModelUIDriverState.xp_threshold_current_level) / (obj.xp_threshold_next_level - obj.xp_threshold_current_level), 1);
                const valid = obj.current_level != 0;

                this.classList.toggle("error", !valid);

                if (!valid) {
                    this.style.setProperty("--progress", `0%`);
                    return "0%";
                }

                this.style.setProperty("--progress", `${percentage * 100}%`);

                if (this.previousPercentage > 0 && percentage != this.previousPercentage) {
                    this.increaseXP(this.previousXP, obj.xp_points);
                }

                if (this.previousRank > 0 && obj.current_level != this.previousRank) {
                    this.increaseLevel(this.previousRank, obj.current_level);
                }


                this.previousPercentage = percentage;
                this.previousXP = obj.xp_points;
                this.previousRank = obj.current_level;

                //return `${percentage * 100}%`;
            }
        }

        increaseXP(oldxp, newxp) {
            //console.warn("Gone from", oldxp, newxp);
            this.classList.add("increase-xp");
            waitForFrames(() => {
                this.classList.remove("increase-xp");
            }, 60);
        }

        increaseLevel(previouslevel, newlevel) {
            this.classList.add("new-rank");
            // $.waitForFrames(() => {

            // }, 60);

        }

        onAnimationEnd(e) {

            if (e.target == this.progressbar) {
                this.classList.remove("increase-xp");
            }

            if (e.animationName == "levelGlow") {
                this.classList.remove("new-rank");
            }

        }

        onRemovedFromDOM() {
            this.removeEventListener("animationend", this.onAnimationEnd);
        }

        bindControls() {

        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.progressbar = q(".bar", this);

            this.addEventListener("animationend", this.onAnimationEnd);


        }



    }
    ksUI$1.registerModule('ks-playerprogress', PlayerProgress);

    var template$1C = "<div class=\"component-body\">\r\n\r\n    <ks-page-splash id=\"splash\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} == 'splash'\">\r\n    </ks-page-splash>\r\n\r\n    <ks-page-roadmap id=\"roadmap\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} == 'roadmap'\">       \r\n    </ks-page-roadmap>\r\n\r\n    <ks-page-firststart id=\"firststart\" data-bind-if=\"{{ModelMenuState.activeMenu}} == 'firststart'\" rootpage>\r\n\r\n    </ks-page-firststart>\r\n\r\n</div>";

    var template$1B = "<div class=\"component-body\">\r\n\r\n    <div class=\"logo-segmented\">\r\n\r\n        <svg id=\"logo-watermark\" class=\"animated\" viewBox=\"0 0 596.99 490.148\">\r\n            <g class=\"logo_watermark animated\">\r\n                <path id=\"Path_610\" data-name=\"Path 610\" class=\"cls-2\" d=\"M1.63,387.488V491.744L186.4,306.988V411.1l96.712-96.722V106.02Z\" transform=\"translate(-1.63 -1.596)\"/>\r\n                <path id=\"Path_611\" data-name=\"Path 611\" class=\"cls-2\" d=\"M496.433,0,318.69,178.058V282.315L496.433,104.266V0ZM415.412,289.18V222.972L318.69,319.693v66.2H422.956L600.167,208.68V104.414L415.412,289.17Z\" transform=\"translate(-6.404)\"/>\r\n            </g>\r\n        </svg>\r\n\r\n        <svg id=\"logo-lettering\" class=\"animated\" viewBox=\"0 0 596.99 490.148\">\r\n            <g transform=\"translate(0 147.485)\">\r\n                <path class=\"logo_evo animated\" d=\"M377.606,250.261l26.111-.079-92.043,95.451-20.812.059L198.237,250.7l26.111-.079L301.2,327.974Zm206.2.867A19.319,19.319,0,0,1,594.638,261.8a21.865,21.865,0,0,1,1.694,8.638l.158,53.6a22.263,22.263,0,0,1-1.645,8.943,19.9,19.9,0,0,1-4.4,6.491,18.606,18.606,0,0,1-6.373,4.048,20.689,20.689,0,0,1-7.357,1.4l-135.075.4a20.649,20.649,0,0,1-7.466-1.349,18.689,18.689,0,0,1-6.294-4.009,19.84,19.84,0,0,1-4.432-6.461,22.152,22.152,0,0,1-1.694-8.924l-.158-53.6a22.389,22.389,0,0,1,1.645-8.835,19.756,19.756,0,0,1,4.393-6.589,18.77,18.77,0,0,1,6.274-4.048,20.382,20.382,0,0,1,7.456-1.4l135.075-.4a19.585,19.585,0,0,1,7.367,1.448ZM573.216,321.64a9.048,9.048,0,0,0,2.236-6.382l-.108-35.931a10.25,10.25,0,0,0-1.881-6.373,6.391,6.391,0,0,0-5.407-2.443l-118.193.355c-2.62,0-4.481.837-5.585,2.472a11.093,11.093,0,0,0-1.645,6.382l.108,35.931a9.854,9.854,0,0,0,1.98,6.373,6.053,6.053,0,0,0,4.915,2.443l118.381-.355a6.85,6.85,0,0,0,5.191-2.472ZM28.768,272l146.747-.354V250.833l-155.247.384a20.382,20.382,0,0,0-7.456,1.4,18.726,18.726,0,0,0-6.264,4.048,19.774,19.774,0,0,0-4.4,6.589A22.423,22.423,0,0,0,.5,272.088l.158,53.6a21.953,21.953,0,0,0,1.694,8.924,19.932,19.932,0,0,0,4.432,6.461,18.787,18.787,0,0,0,6.294,4.009,20.4,20.4,0,0,0,7.466,1.349l154.961-.384v-20.8L28.532,325.6a6.071,6.071,0,0,1-4.915-2.433,9.929,9.929,0,0,1-1.98-6.373l-.02-7.574h153.9V288.074H21.558l-.02-7.21a11.225,11.225,0,0,1,1.645-6.382c1.1-1.635,2.975-2.462,5.594-2.462Z\"/>\r\n                <g class=\"logo_assettocorsa animated\">\r\n                    <path id=\"Path_613\" data-name=\"Path 613\" class=\"cls-4\" d=\"M134.939,149.97c-15.739-.079-26.712,10.746-26.771,25.727a.79.79,0,0,0,0,.217c0,7.111,3.28,13.622,9.406,19.551,4.767,4.7,7.131,7.259,7.131,11.721v.118c-.108,5.151-3.644,8.411-9.308,8.49h-.473a20.792,20.792,0,0,1-9.968-2.443l-1.5-.886v17.266a39.761,39.761,0,0,0,11.425,1.5h.217c15.139,0,26.613-10.155,26.672-26.761a.78.78,0,0,1,0-.2c0-6.57-3.122-13.612-9.544-19.374-6.028-5.447-7.092-7.781-7.121-10.884v-.03c.227-5.338,3.565-8.49,9.032-8.569a14.718,14.718,0,0,1,7.673,1.891l1.448.8,3.191-15.927c-2.265-1.172-6.018-2.187-11.514-2.2Z\" transform=\"translate(-2.05 -149.743)\"/>\r\n                    <path id=\"Path_614\" data-name=\"Path 614\" class=\"cls-4\" d=\"M546.759,149.97c-15.739-.079-26.712,10.746-26.771,25.727a.783.783,0,0,0,0,.217c-.01,7.111,3.28,13.622,9.406,19.551,4.767,4.7,7.141,7.259,7.141,11.721v.118c-.118,5.151-3.644,8.411-9.307,8.49h-.483a20.723,20.723,0,0,1-9.958-2.443l-1.5-.886v17.266a39.813,39.813,0,0,0,11.425,1.5h.217c15.139,0,26.6-10.155,26.663-26.761v-.2c0-6.57-3.133-13.612-9.554-19.374-6.018-5.447-7.092-7.781-7.111-10.884v-.03c.226-5.338,3.556-8.49,9.022-8.569a14.693,14.693,0,0,1,7.673,1.891l1.448.8h0l3.191-15.927c-2.265-1.172-6.008-2.187-11.514-2.2Z\" transform=\"translate(-8.251 -149.743)\"/>\r\n                    <path id=\"Path_615\" data-name=\"Path 615\" class=\"cls-4\" d=\"M397.516,213.588h0l-1.99.808a22.422,22.422,0,0,1-7.4,1.152c-3.388-.039-5.328-1.3-6.776-3.743-1.438-2.462-2.137-6.294-2.127-11.012v-.453c.1-12.085,3.91-22.358,9-28.7,2.906-3.743,7.092-5.92,10.549-5.9a14.268,14.268,0,0,1,6.057,1.024l1.4.64,3.211-16.025a25.224,25.224,0,0,0-8.707-1.409,33.151,33.151,0,0,0-23.954,10.135c-9.426,9.357-15.365,24.476-15.523,43.406a2.472,2.472,0,0,0,0,.384c0,4.659.719,11.356,4.048,17.059,3.29,5.693,9.416,10.263,19.4,10.263h.118a34.194,34.194,0,0,0,9.387-1.044l3.319-16.586Z\" transform=\"translate(-5.931 -149.743)\"/>\r\n                    <path id=\"Path_616\" data-name=\"Path 616\" class=\"cls-4\" d=\"M201.682,150.67l-3.132,15.316h13.405l-12.883,64.563h17.089l12.883-64.563h13.4l3.122-15.316Z\" transform=\"translate(-3.482 -149.754)\"/>\r\n                    <path id=\"Path_617\" data-name=\"Path 617\" class=\"cls-4\" d=\"M250.542,150.67l-3.132,15.316h13.405l-12.883,64.563h17.089L277.9,165.986h13.385l3.122-15.316Z\" transform=\"translate(-4.217 -149.754)\"/>\r\n                    <path id=\"Path_618\" data-name=\"Path 618\" class=\"cls-4\" d=\"M342.984,175.555v-.493c0-4.708-.522-10.894-3.29-16.074-2.738-5.21-8.008-9.288-16.626-9.249a25.256,25.256,0,0,0-17.946,7.476c-11.159,10.913-16.685,31.7-16.862,47.671v.414c0,4.413.611,10.785,3.438,16.242,2.778,5.427,8.076,9.909,16.7,9.909h.128a24.685,24.685,0,0,0,18.074-7.722c10.7-10.677,16.212-31.459,16.39-48.115m-32.178,40.521c-2.325-.059-3.29-1.074-4.117-2.925a17.968,17.968,0,0,1-.946-6.511v-.394c.02-11.14,4.442-32.749,11.061-39.23a5.9,5.9,0,0,1,4.206-2c2.009.059,2.817.877,3.585,2.551a17.679,17.679,0,0,1,.906,6.422v.424c.02,8.027-3.812,33.065-10.943,39.772a5.332,5.332,0,0,1-3.762,1.9Z\" transform=\"translate(-4.832 -149.74)\"/>\r\n                    <path id=\"Path_619\" data-name=\"Path 619\" class=\"cls-4\" d=\"M460.863,175.555v-.493c0-4.708-.522-10.894-3.29-16.074-2.738-5.21-8.017-9.288-16.626-9.249a25.28,25.28,0,0,0-17.955,7.476c-11.169,10.913-16.675,31.7-16.852,47.671-.01.138,0,.286,0,.414,0,4.413.6,10.785,3.428,16.242,2.778,5.427,8.077,9.909,16.7,9.909h.118a24.686,24.686,0,0,0,18.074-7.722c10.7-10.677,16.212-31.459,16.4-48.115m-21.974-10.549c2,.059,2.807.877,3.575,2.551a17.684,17.684,0,0,1,.906,6.422v.424c.029,8.027-3.812,33.065-10.943,39.772a5.315,5.315,0,0,1-3.763,1.9c-2.315-.059-3.28-1.074-4.117-2.925a17.746,17.746,0,0,1-.936-6.511v-.394c.02-11.14,4.442-32.749,11.051-39.23a5.9,5.9,0,0,1,4.216-2Z\" transform=\"translate(-6.607 -149.74)\"/>\r\n                    <path id=\"Path_620\" data-name=\"Path 620\" class=\"cls-4\" d=\"M514.821,169.665v-.187a18.9,18.9,0,0,0-5.319-13.484c-4.422-4.432-11.189-5.663-17.975-5.663a97.291,97.291,0,0,0-15.572,1.389l-.926.158-.187.926L459.3,230.544h16.754l6-30.908h1.28c2.1.059,3.034.522,3.9,1.921.857,1.448,1.389,4.245,1.369,8.618v20.369H505.09s.138-13.809,0-22.339c-.1-7.239-1.438-12.1-4.767-14.833,8.264-3.871,14.39-12.8,14.489-23.7Zm-17.394,1.714c-.079,7.673-4.688,14.469-10.8,14.43h-1.655l4.167-21.383a20.391,20.391,0,0,1,2.63-.158c4.354.039,5.516,3.142,5.644,6.973,0,.128.02.128,0,.138Z\" transform=\"translate(-7.408 -149.749)\"/>\r\n                    <path id=\"Path_621\" data-name=\"Path 621\" class=\"cls-4\" d=\"M585.815,150.67,552.76,230.539h16.932l6.914-17.857h11.987l-.394,17.857h16.616V150.66h-18.99Zm4.284,23.767c-.177,3.467-.364,6.816-.443,9.268l-.453,15.739h-8.057l5.654-15.336c.916-2.354,2.1-5.939,3.289-9.662Z\" transform=\"translate(-8.815 -149.754)\"/>\r\n                    <path id=\"Path_622\" data-name=\"Path 622\" class=\"cls-4\" d=\"M192.178,165.986l3.191-15.316H160.3l-16,79.869h36.423l3.191-15.434H164.462l3.861-18.675h16.941l.227-1.093,2.847-13.76H171.071l3.349-15.592Z\" transform=\"translate(-2.665 -149.754)\"/>\r\n                    <path id=\"Path_623\" data-name=\"Path 623\" class=\"cls-4\" d=\"M91.479,149.97c-15.739-.079-26.7,10.746-26.761,25.727a.791.791,0,0,0,0,.217c-.01,7.111,3.28,13.622,9.4,19.551,4.767,4.7,7.131,7.259,7.131,11.721v.118c-.118,5.151-3.644,8.411-9.3,8.49h-.492a20.791,20.791,0,0,1-9.968-2.443l-1.5-.886v17.266a39.761,39.761,0,0,0,11.425,1.5h.217c15.139,0,26.613-10.155,26.672-26.761a.781.781,0,0,1,0-.2c0-6.57-3.122-13.612-9.544-19.374-6.028-5.447-7.092-7.781-7.121-10.884v-.03c.227-5.338,3.575-8.49,9.042-8.569a14.744,14.744,0,0,1,7.673,1.891l1.448.8,3.191-15.927c-2.265-1.172-6.018-2.187-11.514-2.2Z\" transform=\"translate(-1.396 -149.743)\"/>\r\n                    <path id=\"Path_624\" data-name=\"Path 624\" class=\"cls-4\" d=\"M32.215,150.545.5,230.966l16.941-.286,6.6-17.965,11.987-.2-.089,17.867,16.616-.276-1.34-79.869-18.99.315Zm4.954,23.875c-.177,3.467-.355,6.816-.433,9.268l-.463,15.739H28.226l5.654-15.336C34.8,181.739,35.978,178.144,37.169,174.42Z\" transform=\"translate(-0.5 -149.747)\"/>\r\n                </g>\r\n            </g>\r\n        </svg>\r\n\r\n    </div>\r\n\r\n    <div class=\"disclaimer\">\r\n        <div class=\"text welcome\" data-l10n-id=\"lblSplashWelcome\"></div>\r\n        <div class=\"text rights\" data-l10n-id=\"lblSplashRights_01\"></div> \r\n        <div class=\"text fmod\" data-l10n-id=\"lblSplashRights_02\"></div> \r\n        <div class=\"text manufacturers\" data-l10n-id=\"lblSplashRights_03\"></div> \r\n        <div class=\"text rights\" data-l10n-id=\"lblSplashRights_04\"></div> \r\n    </div>\r\n\r\n    <div class=\"fmod-logo\">        \r\n    </div>\r\n\r\n</div>";

    class SplashPage extends KsHTMLElement {

        locked = true;

        step = 0;
        steps = ["logo", "disclaimer", "end"];
        timer;
        animframe;

        constructor() {
            super();
            this.template = template$1B;
            this.delayedInit = true;
            this._isnavigable = false;
            this._exposeAsActivePage = true;
        }

        unlock() {
            console.log("Splash unlocked");
            this.locked = false;
        }

        proceed() {
            console.log("Splash proceeding");
            if (this.locked) return;
            this.clearBindings();

            this.step++;
            if (this.steps[this.step]) {
                this.setCurrentStep();
                this.onProceed(this.getCurrentStep());
                this.armProceed();

                if (this.steps[this.step] == "disclaimer") {
                    this.animframe = requestAnimationFrame((t) => this.exitDisclaimer(t));                
                }
            }
        }

        disclaimerStart;

        exitDisclaimer(timestamp) {
            if (this.disclaimerStart === undefined) {
                this.disclaimerStart = timestamp;
            }

            const elapsed = timestamp - this.disclaimerStart;

            if (elapsed < 8000) {
                this.animframe = requestAnimationFrame((t) => this.exitDisclaimer(t));
            } else {
                waitForFrames(() => this.proceed(), 3);
            }
        }

        proceedAction() {
            console.trace("splash proceedAction received");
            if (!document.body.classList.contains("ui-locked")) {
                AP().clearTimers();
                AP().clearBindings();
                AP().proceed();
            }
        }

        onProceed(step) { // eslint-disable-line no-unused-vars

        }

        bindControls() {
            this.armProceed();
        }

        clearTimers() {
            //console.log("clearing splash timers");
            cancelAnimationFrame(this.animframe);
            clearTimeout(this.timer);
        }

        armProceed() {
            window.addEventListener("keydown", this.proceedAction);
            window.addEventListener("mousedown", this.proceedAction);
            window.addEventListener("ui.action", this.proceedAction);
            //engine.on("UIExInputsAction", this.proceedAction, this);
        }

        clearBindings() {
            //console.log("clearing splash bindings");
            window.removeEventListener("keydown", this.proceedAction);
            window.removeEventListener("mousedown", this.proceedAction);
            window.removeEventListener("ui.action", this.proceedAction);
            //engine.off("UIExInputsAction", this.proceedAction, this);
        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();
            this.documentBody.classList.remove("splash");
            this.clearTimers();
            this.clearBindings();

            //console.log("cleared splash");
        }

        getCurrentStep() {
            return this.steps[this.step];
        }

        setCurrentStep() {
            console.log("Splash setting step to", this.steps[this.step]);
            this.dataset.mode = this.steps[this.step];
            if (this.dataset.mode == "end") {
                ksUI$1.UIUtilityCommand(eUIUtilityCommandType.SplashEnd);
                console.warn("Splash end");
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            console.log("Splash page");    
            
            this.setCurrentStep();
            this.documentBody.classList.add("splash");

            // if(ksUI.isDevMode()) {
            //     this.steps = ["logo", "end"];
            // }

            setTimeout(() => {
                this.unlock();

                this.timer = setTimeout(() => {
                    this.proceed();
                }, 5000);

            }, 1000);



        }
    }

    ksUI$1.registerModule('ks-page-splash', SplashPage);

    var template$1A = "<div class=\"component-body\">\r\n\r\n    <div id=\"acelogo\"></div>\r\n    \r\n    <ks-playerprogress></ks-playerprogress>\r\n    \r\n    <ks-page-tutorial id=\"tutorial\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} == 'tutorial'\">\r\n    </ks-page-tutorial>\r\n\r\n    <ks-page-playerinfo firststart opaque id=\"playerinfo\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} == 'playerinfo'\">\r\n    </ks-page-playerinfo>\r\n\r\n    <ks-page-playermodeselection firststart opaque id=\"playermodeselection\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} == 'playermodeselection'\">\r\n</ks-page-playermodeselection>\r\n\r\n    <ks-page-carselection dealership firstpurchace title=\"headerFirstCar\" returnpath=\"firststart/playerinfo\" class=\"submode carselection renderControlHints delayedInit firstcar\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'carselection'\">\r\n    </ks-page-carselection>\r\n\r\n    <ks-page-brandselection dealership firstpurchace class=\"submode brandselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'brandselection'\">\r\n    </ks-page-brandselection>\r\n\r\n    <ks-page-modelselection dealership firstpurchace class=\"submode modelselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'modelselection'\">\r\n    </ks-page-modelselection>\r\n\r\n    <ks-page-vehiclepresetselection dealership firstpurchace class=\"submode presetselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'presetselection'\">\r\n    </ks-page-vehiclepresetselection>\r\n\r\n    <ks-page-paintshop dealership title=\"headerCustomizeVehicle\" class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'customize'\" data-mode=\"main\"></ks-page-paintshop>\r\n\r\n</div>";

    var template$1z = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"focusable delayedInit\" page=\"intro.html\" path=\"firststart/playermodeselection\">\r\n\r\n            </ks-btnbasic>\r\n            <ks-btnbasic id=\"btnSkipIntro\" class=\"skip focusable\" id=\"skip\" page=\"intro.html\" path=\"firststart/brandselection\">\r\n                <div slot=\"name\" data-l10n-id=\"btnSkipTutorial\">Skip All</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n\r\n        <div class=\"group center\">\r\n        </div>\r\n\r\n        <div class=\"group end\">\r\n\r\n        </div>\r\n    </component-slot>\r\n\r\n\r\n\r\n    <div class=\"pages\">\r\n        <div class=\"page active\">\r\n            <div class=\"row flex-1\">\r\n                <div class=\"column-50\">\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep1\"></div>\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep2\"></div>\r\n                </div>\r\n                <div class=\"tutorial1-image\">\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <div class=\"page\">\r\n            <div class=\"row flex-1\">\r\n                <div class=\"column-50\">\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep3\"></div>\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep4\"></div>\r\n                </div>\r\n                <div class=\"tutorial2\">\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep5\"></div>\r\n                    <div class=\"tutorial-arrows\"></div>\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep6\"></div>\r\n                    <div class=\"tutorial-arrows\"></div>\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep7\"></div>\r\n                    <div class=\"tutorial-fork\"></div>\r\n                    <div class=\"cars-info\">\r\n                        <div class=\"text\" data-l10n-id=\"lblTutorialStep8\"></div>\r\n                        <div class=\"spacer\"></div>\r\n                        <div class=\"text\" data-l10n-id=\"lblTutorialStep9\"></div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <div class=\"page\">\r\n            <div class=\"row flex-1\">\r\n                <div class=\"column-50\">\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep10\"></div>\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep11\"></div>\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep12\"></div>\r\n                </div>\r\n                <div class=\"tutorial3\">\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep7\"></div>\r\n                    <div class=\"tutorial-arrows\"></div>\r\n                    <div class=\"tutorial-arrows\"></div>\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep13\"></div>\r\n                    <div class=\"tutorial-arrows\"></div>\r\n                    <div class=\"tutorial-arrows\"></div>\r\n                    <div class=\"text green\" data-l10n-id=\"lblTutorialStep14\"></div>\r\n                </div>\r\n\r\n            </div>\r\n        </div>\r\n\r\n\r\n        <div class=\"page\">\r\n            <div class=\"title\">LET'S START YOUR JOURNEY</div>\r\n            <div class=\"row flex-1\">\r\n                <div class=\"column-50\">\r\n                    <div class=\"text\" data-l10n-id=\"lblTutorialStep15\"></div>\r\n                </div>\r\n                <div class=\"column-50 page6 artwork is-flex align-items-center justify-content-center\">\r\n                    <i class=\"icon svg-icon-logo\"></i>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"controls\">\r\n\r\n        <ks-btnbasic id=\"btnPrevious\" class=\"focusable\">\r\n            <div slot=\"name\" data-l10n-id=\"btnPrevious\">Previous</div>\r\n        </ks-btnbasic>\r\n\r\n        <div class=\"count\">\r\n            <span id=\"currentPage\">1</span>/<span id=\"totalPage\">0</span>\r\n        </div>\r\n\r\n        <ks-btnbasic id=\"btnNext\" class=\"focusable defaultfocus\">\r\n            <div slot=\"name\" data-l10n-id=\"btnNext\">Next</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic id=\"btnLast\" class=\"focusable\">\r\n            <div slot=\"name\" data-l10n-id=\"btnContinue\">Last</div>\r\n        </ks-btnbasic>\r\n\r\n    </div>\r\n\r\n</div>";

    class FirstTutorialPage extends KsHTMLElement {


        /** @type MessageHandler */
        GameEconomyClient;

        btnPrevious;
        btnNext;
        btnLast;

        currentPage;
        totalPage;

        pages;

        _pageCount = 0;
        _pageCurrent = 1;

        /** @type {Btnbasic} */
        btnQuit;
        /** @type {Btnbasic} */
        btnBack;
        /** @type {Btnbasic} */
        btnSkipIntro;

        constructor() {
            super();
            this.template = template$1z;
            this.delayedInit = true;
            this._isnavigable = true;
            this.shouldRenderControlHints = true;
            this._exposeAsActivePage = true;

        }

        handleQuit() {

            this._lastfocused = document.activeElement;

            //this.storeCurrentlyFocused();

            this.pageModal.onConfirm = () => {
                q("body").classList.remove("loaded");
                ksUI$1.requestNoResponse("GameMode", "QuitGame");
            };

            this.pageModal.onHide = () => {

                waitForFrames(() => {
                    this._lastfocused?.focus();
                    //this.restoreLastFocused();
                });
            };

            this.pageModal.Show({
                type: eModalDialogTypes.Warning,
                title: "lblExitGame",
                message: "msgAreYouSureExitGame",
                buttons: 0x101
            });
        }

        onAfterRenderControlHints(controlhints) {
            this.mapElementById("btnQuit", controlhints);
            this.mapElementById("btnBack", controlhints);
            this.mapElementById("btnSkipIntro", controlhints);

            if (this.btnQuit) {
                this.btnQuit.onPressed = (sender, e) => {
                    this.handleQuit();
                };
            }

            if (localStorage.getItem("mode_selection") == "main") {
                this.btnBack.onBeforeRedirect = () => {

                    this.btnSkipIntro.disable();

                    this.GameEconomyClient.request("PlayerMode", { is_sandbox: true }, (data) => {
                        if (data.new_is_sandbox) {
                            ksUI$1.goTo("menu.html", "main/playermodeselection", true);
                        }
                    });
                    return false;
                };
            }

            this.btnSkipIntro.onBeforeRedirect = () => {
                ksUI$1.preventBack = true;
                this.btnBack.disable();
            };
        }

        next() {
            let p = this.getCurrentPage();

            if (p + 1 >= this.pages.length) {
                return;
            } else {
                this.pages[p].classList.remove("active");
                this.pages[p + 1].classList.add("active");
            }
            this.updateCounter();
        }

        previous() {
            let p = this.getCurrentPage();

            if (p <= 0) {
                return;
            } else {
                this.pages[p].classList.remove("active");
                this.pages[p - 1].classList.add("active");
            }
            this.updateCounter();
        }

        exit() {
            engine.trigger("OnFirstTutorialFinished");
        }

        bindControls() {
            this.btnNext.onPressed = () => this.next();
            this.btnPrevious.onPressed = () => this.previous();
            this.btnLast.onPressed = () => this.exit();
        }

        onRemovedFromDOM() {
            this.documentBody.classList.remove("tutorial");
        }

        updateCounter() {
            this._pageCount = this.pages.length;
            this._pageCurrent = this.getCurrentPage() + 1;

            this.currentPage.innerHTML = this._pageCurrent;
            this.totalPage.innerHTML = this.pages.length;



            const lastpage = this.classList.toggle("last-page", this._pageCurrent == this._pageCount);
            const firstpage = this.classList.toggle("first-page", this._pageCurrent == 1);

            if (lastpage) {
                waitForFrames(() => this.btnLast.focus(), 3);
            }

            if (firstpage) this.btnNext.focus();

            if (this._pageCurrent == this._pageCount) {
                this.btnLast.focus();
            }
        }

        getCurrentPage() {
            let i = 0;
            for (let page of this.pages) {
                if (page.classList.contains("active")) {
                    break;
                }
                i++;
            }
            return i;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            console.log("Tutorial page");

            this.GameEconomyClient = new MessageHandler("GameEconomyClient");

            this.documentBody.classList.add("tutorial");

            this.mapElementById("btnNext");
            this.mapElementById("btnPrevious");
            this.mapElementById("btnLast");

            this.mapElementById("currentPage");
            this.mapElementById("totalPage");


            this.pages = qAllArray(".pages .page", this);

            this.updateCounter();

            if (this.rootPage.constructor.name != "FirstStartPage") {
                console.error("Error rendering FirstStartPage");
                ksUI$1.goTo("intro.html", "firststart/tutorial", false, true);
            }

        }
    }

    ksUI$1.registerModule('ks-page-tutorial', FirstTutorialPage);

    var template$1y = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n\r\n            <ks-btnbasic id=\"btnBack\" class=\"back focusable\" path=\"firststart/tutorial\">\r\n                <div slot=\"name\" data-l10n-id=\"btnBack\">Back</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnContinue\" class=\"focusable\" disabled=\"disabled\">\r\n                <div slot=\"name\" data-l10n-id=\"btnContinue\">Continue</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnApply\" class=\"focusable\" disabled=\"disabled\">\r\n                <div slot=\"name\" data-l10n-id=\"btnApply\">Apply</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnCancel\" class=\"focusable\" disabled=\"disabled\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCancel\">Cancel</div>\r\n            </ks-btnbasic>\r\n\r\n\r\n        </div>\r\n\r\n        <div class=\"group center\">\r\n\r\n        </div>\r\n\r\n        <div class=\"group end\">\r\n\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal nologo\">\r\n        <div slot=\"label\" data-l10n-id=\"headerNewDriver\">New Driver</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body\">\r\n\r\n        <div class=\"info\">\r\n\r\n            <div class=\"row\">\r\n                <div class=\"label\" data-l10n-id=\"labelName\">Driver Name</div>\r\n                <ks-textinput class=\"focusable\" id=\"txtName\" data-group=\"info\" minlength=\"2\" maxlength=\"16\" data-bind-ksvalue=\"{{PersonalData.first_name}}\" tabnav nextfocus required>\r\n                    <div slot=\"placeholder\" data-l10n-id=\"lwrRequired\">required</div>\r\n                </ks-textinput>\r\n            </div>\r\n            <div class=\"row\">\r\n                <div class=\"label\" data-l10n-id=\"labelSurname\">Driver Surname</div>\r\n                <ks-textinput class=\"focusable\" id=\"txtSurname\" data-group=\"info\" minlength=\"2\" maxlength=\"16\" data-bind-ksvalue=\"{{PersonalData.last_name}}\" tabnav nextfocus required>\r\n                    <div slot=\"placeholder\" data-l10n-id=\"lwrRequired\">required</div>\r\n                </ks-textinput>\r\n            </div>\r\n            <div class=\"row\">\r\n                <div class=\"label\" data-l10n-id=\"labelNickname\">Driver Nickname</div>\r\n                <ks-textinput class=\"focusable\" id=\"txtNickname\" maxlength=\"16\" data-group=\"info\" data-bind-ksvalue=\"{{PersonalData.nickname}}\" tabnav nextfocus>\r\n                    <div slot=\"placeholder\"></div>\r\n                </ks-textinput>\r\n            </div>\r\n            <div class=\"row\">\r\n                <div class=\"label\" data-l10n-id=\"labelInitials\">Initials</div>\r\n                <ks-textinput class=\"focusable short\" id=\"txtInitials\" minlength=\"3\" maxlength=\"3\" pattern=\"^[a-zA-Z]{3}$\" data-bind-ksvalue=\"{{PersonalData.shortcut_name}}\" data-group=\"info\" tabnav nextfocus>\r\n                    <div slot=\"placeholder\" data-l10n-id=\"lwrThreeLetters\">3 letters</div>\r\n                </ks-textinput>\r\n            </div>\r\n            <div class=\"row\">\r\n                <div class=\"label\" data-l10n-id=\"labelAge\">Age</div>\r\n                <ks-textinput id=\"txtAge\" class=\"focusable short\" pattern=\"^[0-9]{1,3}$\" minlength=\"1\" maxlength=\"3\" data-bind-ksvalue=\"APF()?.notifzero({{PersonalData.age}})\" data-group=\"info\" tabnav nextfocus>\r\n                    <div slot=\"placeholder\" data-l10n-id=\"lwrNumeric\">numeric</div>\r\n                </ks-textinput>\r\n\r\n            </div>\r\n            <div class=\"row\">\r\n                <div class=\"label\" data-l10n-id=\"labelNationality\">Nationality</div>\r\n                <ks-modalselect static=\"true\" id=\"modalNationality\" extracssclass=\"nationality-selector\" data-bind-ksvalue=\"{{PersonalData.nationality_alpha_3}}\" data-bind-inputvalue=\"{{PersonalData.nationality_alpha_3}}\" class=\"focusable\" data-group=\"info\" tabnav nextfocus>\r\n                    <div slot=\"current\">Select Country</div>\r\n                    <div slot=\"options\">\r\n                        <div class=\"title\" data-l10n-id=\"labelCountry\">Nationality</div>\r\n                        <ks-textinput id=\"txtSearchCountry\" class=\"focusable short\" minlength=\"0\" maxlength=\"32\">\r\n                            <div slot=\"placeholder\" data-l10n-id=\"lblSearch\">search</div>\r\n                        </ks-textinput>\r\n                        <div class=\"list scrollable-vertical\">\r\n                            <div class=\"scrollable-content per-item-scroll\">\r\n                                <ks-nationalitylist id=\"listNationality\"></ks-nationalitylist>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </ks-modalselect>\r\n            </div>\r\n            <!-- <div class=\"row\">\r\n                <div class=\"label\">Gender</div>\r\n                <ks-textinput class=\"focusable\">\r\n                    <div slot=\"placeholder\">3 letters</div>\r\n                </ks-textinput>\r\n            </div> -->\r\n\r\n        </div>\r\n        <div class=\"avatar\">\r\n            <ks-btnbasic id=\"btnCustomAvatar\" class=\"focusable\" disabled=\"disabled\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCustomizeAvatar\"></div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </div>\r\n\r\n</div>";

    var template$1x = "<div class=\"component-body\">\r\n\r\n    <component-slot class=\"current\" data-name=\"current\">\r\n        Current\r\n    </component-slot>\r\n\r\n    <div class=\"modal ks-modal-select\">\r\n\r\n        <component-slot data-name=\"options\">\r\n            <div class=\"option focusable selected\" data-value=\"0\">Option 0</div>\r\n            <div class=\"option focusable\" data-value=\"1\">Option 1</div>\r\n        </component-slot>\r\n\r\n    </div>\r\n\r\n</div>";

    class ModalSelect extends KsHTMLElement {

        modalContents;
        renderParent;
        renderTarget;

        remainOpen = false;

        value = "";
        displayValue = "";

        get extraCssClass() {
            return this.getAttribute("extraCssClass") || "";
        }

        constructor() {
            super();
            this._isnavigable = true;
            this.template = template$1x;
            this.onChangeBound = this.onChange;
            this.delayedInit = true;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.modalContents = q(".modal", this);
            this.renderParent = this.parentElement;
        }

        isStatic() {
            return this.hasAttribute("static");
        }

        isActive() {
            return this.classList.contains("active");
        }

        Show() {


            q("body").classList.add("modalselect-active");
            this.classList.add("active");
            ksUI$1.preventBack = true;
            this.onShow();
            if (this.isStatic()) {
                this.onPopulated();
            } else {
                this.bindOptions();
            }
            if (this.pageModal) {
                this.pageModal.setContent(this.modalContents);

                this.pageModal.onShow = () => {
                    this.pageModal.setupNavigation();
                };

                this.pageModal.Show({
                    buttons: 0x001,
                    showContent: true,
                    showTitle: false,
                    showMessage: false,
                    cancel: "btnClose",
                    extraCssClass: this.extraCssClass
                }).onCancel = () => {
                    this.Hide();
                };
            }

            console.log("Showing modal dialog", this.id);
            //console.warn("showmodal");
            ksUI$1.clearFocus();
        }

        Hide() {
            q("body").classList.remove("modalselect-active");
            this.classList.remove("active");
            ksUI$1.preventBack = false;

            if (this.pageModal) {
                this.appendChild(this.modalContents);
                this.pageModal.Hide();
            }
            if (ksUI$1.isSpatialNav()) {
                waitForFrames(() => {
                    this.focus();
                }, 1);
            }

            this.onHide();
        }

        onClick(event) {
            if (!this.isActive()) {
                this.Show();
            } else {
                this.Hide();
            }
        }

        bindOptions() {
            let sender = this;
            let target = this;
            if (this.pageModal) {
                target = this.pageModal;
            }

            qevAllOnce(".option", "click sn:enter-down", function fn(ev) {
                console.trace("clicked");
                if (ev.preventDefault) {
                    ev.preventDefault();
                    ev.stopPropagation();
                }
                let oldvalue = q("[slot=current]", sender).dataset.value;
                let newvalue = ev.target.dataset.value;

                let displayvalue = ev.target.innerHTML;

                if (oldvalue != newvalue) {
                    sender.onChanged(ev, newvalue, oldvalue, displayvalue);
                }
                sender.onSelected(ev, newvalue, displayvalue);

                sender.value = newvalue;
                sender.displayValue = displayvalue;

                if (!sender.remainOpen)
                    sender.Hide();
            }, target);
        }

        setCurrentText(text) {
            //console.log("setcurrent", text);
            q("[slot=current]", this).innerHTML = text;
        }

        onPopulated() {
            ksUI$1.waitForFrames(() => {
                this.bindOptions();
                // this._isnavigable = true;
                this.setupNavigation();
                // this.enableNav();
                // SpatialNavigation.focus(this);
            }, 1);
        }

        onSelected(event, value, displayvalue) { }

        onChanged(event, new_value, old_value, displayvalue) {

        }

        onShow() { }

        onHide() { }

        bindControls() {
            ["click", "sn:enter-down"].map(event_name => {
                if (this)
                    this.addEventListener(event_name, (e) => {
                        this.onClick(e);
                    });
            });

            if (this.pageModal) {
                this.pageModal.onCancel = () => this.Hide();
            }

            if (q(".list")) {
                q(".list").addEventListener("wheel", (e) => {
                    e.currentTarget.scrollTop -= e.deltaY * 200;
                });
            }


        }


    }

    ksUI$1.registerModule('ks-modalselect', ModalSelect);

    var template$1w = "<div class=\"inputbody\">\r\n    <input id=\"textinput-normal\" type=\"text\" tabindex=\"-1\">\r\n    <input id=\"textinput-password\" type=\"password\" tabindex=\"-1\">\r\n    <div class=\"togglepass\"></div>\r\n    <div class=\"placeholder\">\r\n        <component-slot data-name=\"placeholder\"></component-slot>\r\n    </div>\r\n</div>\r\n";

    class KsHTMLInputElement extends KsHTMLElement {

        constructor() {
            super();
            this.delayedInit = true;
        }

        getNextOfSelector(selector) {
            let index = 0;
            let alltags = qAllArray(selector);
            for (let element of alltags) {
                if (element == this) {
                    break;
                }
                index++;
            }
            if (index++ < alltags.length) {
                return alltags[index];
            }
        }

        getPreviousOfSelector(selector) {
            let index = 0;
            let alltags = qAllArray(selector);
            for (let element of alltags) {
                if (element == this) {
                    break;
                }
                index++;
            }
            if (index-- >= 0) {
                return alltags[index];
            }
        }

        getPreviousOfSameTag() {
            return this.getPreviousOfSelector(this.tagName);
        }

        getNextOfSameTag() {
            return this.getNextOfSelector(this.tagName);
        }


    }

    class TextInput extends KsHTMLInputElement {

        controlsbound = false;
        onPressBound;

        /** @type HTMLInputElement */
        textinput;

        placeholder;
        nextFocus;
        tabout = false;
        tabnav

        set value(text_value) {
            this.textinput.value = text_value;
            this.placeholder.classList.toggle("hidden", String(text_value).length > 0);
        }

        get value() {
            return this.textinput.value;
        }

        constructor() {
            super();
            this.template = template$1w;

            this.onEnterBound = (e) => {
                const isvalid = this.validate();
                //console.log("enterbound", isvalid);
                if (document.activeElement == this.textinput) {
                    /// nothing
                    console.log("focused");
                } else {
                    if (this.nextFocus && !this.tabout && isvalid) {
                        this.activateNext();
                    } else if (!isvalid) {
                        this.textinput.focus();
                        this.classList.add("textinput-focused");
                    }
                }
            };

            this.onPressedBound = (e) => {
                if (document.activeElement == this.textinput) {
                    return;
                } else {
                    this.textinput.focus();
                    this.classList.add("textinput-focused");
                }
                this.onPressed(this, e);
            };

            
            this.onPressedBoundKey = (e) => {
                if (document.activeElement == this.textinput) {
                      this.textinput.blur();
                    return;
                } else {
                    this.textinput.focus();
                    this.classList.add("textinput-focused");
                }
                this.onPressed(this, e);
            };
        }



        isValid() {
            return validate();
        }

        activate() {
            this.onPressedBound();
        }

        onBindingUpdate(binding_param, value) {
            //console.warn("!>>", 'onBindingUpdate', binding_param, value);
            if (binding_param == "ksvalue") {
                this.value = value;
            }
        }

        onTemplateLoaded() {
            const targetinput = this.hasAttribute("password") ? "#textinput-password" : "#textinput-normal";

            this.tabnav = this.hasAttribute("tabnav");
            this.nextFocus = this.hasAttribute("nextfocus");

            this.textinput = q(targetinput, this);
            this.placeholder = q(".placeholder", this);

            //this.textinput.value = this.

            this.templateLoaded = true;

            if (this.hasAttribute("maxlength")) {
                this.textinput.maxLength = this.getAttribute("maxlength");
            }

            if (this.hasAttribute("minlength")) {
                this.textinput.minLength = this.getAttribute("minlength");
            }

        }

        onInput(value, valid) {

        }

        onChange(value, valid) {

        }

        activateNext(back) {
            let nextElement = back ? this.getPreviousOfSelector("[data-group=info]") : this.getNextOfSelector("[data-group=info]");
            if (!nextElement) return;

            nextElement.focus();
            this.documentBody.classList.add("spatialnav");
            waitForFrames(() => {
                nextElement.activate();
                ksUI$1.jiggleMouse();
            });
        }

        getPath() {
            // console.log(this.tagName,this.getAttribute("path"));
            return this.getAttribute("path");
        }

        getGoTo() {
            return this.getAttribute("goto");
        }

        onNavCancel(e) {
            //console.log(e.currentTarget.tagName);
            if (e.detail != "cancel") return;

            console.log("ks-textinput onNavCancel");



            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
        }

        bindControls() {


            if (this.isConnected) {



                this.addEventListener("sn:enter-down", this.onPressedBoundKey);
                this.addEventListener("click", this.onPressedBound);
                
                

                this.addEventListener("keydown", (e) => {

                    // console.warn(this.tagName, "keydown", e.keyCode);

                    if (e.keyCode == 9) {
                        this.tabout = true;

                        if (this.nextFocus) {
                            this.activateNext(e.shiftKey);
                        }
                        this.tabout = false;
                    }
                });

                // engine.on("UI.Cancel", () => { 
                //     if (document.activeElement == this.textinput) {
                //         console.log("deactivate", this.tagName, this.id);
                //         this.textinput.blur();
                //         this.classList.remove("textinput-focused");
                //         ksUI.preventBack = false;    
                //     }

                // }, this);

                this.textinput.onfocus = (e) => {
                    // console.warn(this.tagName, 'focus');
                    this.placeholder.classList.add("hidden");
                    ksUI$1.preventBack = true;
                    //this.addEventListener("ui.action", this.onNavCancel);
                };

                this.textinput.onblur = (e) => {
                    // console.warn(this.tagName, 'blur');
                    if (this.textinput.value.length == 0) {
                        this.placeholder.classList.remove("hidden");
                    }
                    this.classList.remove("textinput-focused");
                    this.focus();
                    const isvalid = this.validate();
                    this.classList.toggle("invalid", !isvalid);

                    ksUI$1.preventBack = false;
                    //this.removeEventListener("ui.action", this.onNavCancel);
                };



                this.textinput.oninput = (e) => {
                    this.onInput(this.textinput.value, this.validate());
                };

                this.textinput.onchange = (e) => {
                    this.onChange(this.textinput.value, this.validate());
                };

            }
        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();

            //window.removeEventListener("ui.action", this.onNavCancel);
        }


        onPressed(sender, e) {

        }

        isRequired() {
            return this.hasAttribute("required");
        }

        validate() {
            var output = true;
            if (this.hasAttribute("pattern")) {
                const pattern = this.getAttribute("pattern");
                const regex = new RegExp(pattern, "g");
                output = regex.test(this.textinput.value);
            }

            if (this.isRequired()) {
                output = this.textinput.value.length > 0;
            } else if (this.textinput.value.length == 0) {

                output = true;
            }

            return output;
        }

    }
    ksUI$1.registerModule('ks-textinput', TextInput);

    class NationalityList extends HTMLElement {

        connectCount = 0;


        constructor() {
            super();
        }

        connectedCallback() {

            if (this.connectCount == 0) {
                components$1.loadResource(this)
                    .then((result) => {

                        components$1.waitForFrames(() => {
                            if (this.isConnected) {
                                this.template = result.template;
                                components$1.renderOnce(this);
                            }
                        }, 1);

                    });
                this.connectCount++;
            }
        }

        template = `
    <div class="options scrollable-target">
        <div class="option centered focusable" data-l10n-id="nationality_None" data-value="">None</div>
        <div class="option centered focusable" data-l10n-id="nationality_AFG" data-value="AFG">Afghanistan</div>
        <div class="option centered focusable" data-l10n-id="nationality_ALA" data-value="ALA">land Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_ALB" data-value="ALB">Albania</div>
        <div class="option centered focusable" data-l10n-id="nationality_DZA" data-value="DZA">Algeria</div>
        <div class="option centered focusable" data-l10n-id="nationality_ASM" data-value="ASM">American Samoa</div>
        <div class="option centered focusable" data-l10n-id="nationality_AND" data-value="AND">Andorra</div>
        <div class="option centered focusable" data-l10n-id="nationality_AGO" data-value="AGO">Angola</div>
        <div class="option centered focusable" data-l10n-id="nationality_AIA" data-value="AIA">Anguilla</div>
        <div class="option centered focusable" data-l10n-id="nationality_ATA" data-value="ATA">Antarctica</div>
        <div class="option centered focusable" data-l10n-id="nationality_ATG" data-value="ATG">Antigua &amp; Barbuda</div>
        <div class="option centered focusable" data-l10n-id="nationality_ARG" data-value="ARG">Argentina</div>
        <div class="option centered focusable" data-l10n-id="nationality_ARM" data-value="ARM">Armenia</div>
        <div class="option centered focusable" data-l10n-id="nationality_ABW" data-value="ABW">Aruba</div>
        <div class="option centered focusable" data-l10n-id="nationality_AUS" data-value="AUS">Australia</div>
        <div class="option centered focusable" data-l10n-id="nationality_AUT" data-value="AUT">Austria</div>
        <div class="option centered focusable" data-l10n-id="nationality_AZE" data-value="AZE">Azerbaijan</div>
        <div class="option centered focusable" data-l10n-id="nationality_BHS" data-value="BHS">Bahamas</div>
        <div class="option centered focusable" data-l10n-id="nationality_BHR" data-value="BHR">Bahrain</div>
        <div class="option centered focusable" data-l10n-id="nationality_BGD" data-value="BGD">Bangladesh</div>
        <div class="option centered focusable" data-l10n-id="nationality_BRB" data-value="BRB">Barbados</div>
        <div class="option centered focusable" data-l10n-id="nationality_BLR" data-value="BLR">Belarus</div>
        <div class="option centered focusable" data-l10n-id="nationality_BEL" data-value="BEL">Belgium</div>
        <div class="option centered focusable" data-l10n-id="nationality_BLZ" data-value="BLZ">Belize</div>
        <div class="option centered focusable" data-l10n-id="nationality_BEN" data-value="BEN">Benin</div>
        <div class="option centered focusable" data-l10n-id="nationality_BMU" data-value="BMU">Bermuda</div>
        <div class="option centered focusable" data-l10n-id="nationality_BTN" data-value="BTN">Bhutan</div>
        <div class="option centered focusable" data-l10n-id="nationality_BOL" data-value="BOL">Bolivia</div>
        <div class="option centered focusable" data-l10n-id="nationality_BES" data-value="BES">Caribbean Netherlands</div>
        <div class="option centered focusable" data-l10n-id="nationality_BIH" data-value="BIH">Bosnia & Herzegovina</div>
        <div class="option centered focusable" data-l10n-id="nationality_BWA" data-value="BWA">Botswana</div>
        <div class="option centered focusable" data-l10n-id="nationality_BVT" data-value="BVT">Bouvet Island</div>
        <div class="option centered focusable" data-l10n-id="nationality_BRA" data-value="BRA">Brazil</div>
        <div class="option centered focusable" data-l10n-id="nationality_IOT" data-value="IOT">British Indian Ocean Territory</div>
        <div class="option centered focusable" data-l10n-id="nationality_BRN" data-value="BRN">Brunei</div>
        <div class="option centered focusable" data-l10n-id="nationality_BGR" data-value="BGR">Bulgaria</div>
        <div class="option centered focusable" data-l10n-id="nationality_BFA" data-value="BFA">Burkina Faso</div>
        <div class="option centered focusable" data-l10n-id="nationality_BDI" data-value="BDI">Burundi</div>
        <div class="option centered focusable" data-l10n-id="nationality_KHM" data-value="KHM">Cambodia</div>
        <div class="option centered focusable" data-l10n-id="nationality_CMR" data-value="CMR">Cameroon</div>
        <div class="option centered focusable" data-l10n-id="nationality_CAN" data-value="CAN">Canada</div>
        <div class="option centered focusable" data-l10n-id="nationality_CPV" data-value="CPV">Cape Verde</div>
        <div class="option centered focusable" data-l10n-id="nationality_CYM" data-value="CYM">Cayman Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_CAF" data-value="CAF">Central African Republic</div>
        <div class="option centered focusable" data-l10n-id="nationality_TCD" data-value="TCD">Chad</div>
        <div class="option centered focusable" data-l10n-id="nationality_CHL" data-value="CHL">Chile</div>
        <div class="option centered focusable" data-l10n-id="nationality_CHN" data-value="CHN">China</div>
        <div class="option centered focusable" data-l10n-id="nationality_CXR" data-value="CXR">Christmas Island</div>
        <div class="option centered focusable" data-l10n-id="nationality_CCK" data-value="CCK">Cocos (Keeling) Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_COL" data-value="COL">Colombia</div>
        <div class="option centered focusable" data-l10n-id="nationality_COM" data-value="COM">Comoros</div>
        <div class="option centered focusable" data-l10n-id="nationality_COG" data-value="COG">Congo - Brazzaville</div>
        <div class="option centered focusable" data-l10n-id="nationality_COD" data-value="COD">Congo - Kinshasa</div>
        <div class="option centered focusable" data-l10n-id="nationality_COK" data-value="COK">Cook Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_CRI" data-value="CRI">Costa Rica</div>
        <div class="option centered focusable" data-l10n-id="nationality_CIV" data-value="CIV">Cte dIvoire</div>
        <div class="option centered focusable" data-l10n-id="nationality_HRV" data-value="HRV">Croatia</div>
        <div class="option centered focusable" data-l10n-id="nationality_CUB" data-value="CUB">Cuba</div>
        <div class="option centered focusable" data-l10n-id="nationality_CUW" data-value="CUW">Curaao</div>
        <div class="option centered focusable" data-l10n-id="nationality_CYP" data-value="CYP">Cyprus</div>
        <div class="option centered focusable" data-l10n-id="nationality_CZE" data-value="CZE">Czechia</div>
        <div class="option centered focusable" data-l10n-id="nationality_DNK" data-value="DNK">Denmark</div>
        <div class="option centered focusable" data-l10n-id="nationality_DJI" data-value="DJI">Djibouti</div>
        <div class="option centered focusable" data-l10n-id="nationality_DMA" data-value="DMA">Dominica</div>
        <div class="option centered focusable" data-l10n-id="nationality_DOM" data-value="DOM">Dominican Republic</div>
        <div class="option centered focusable" data-l10n-id="nationality_ECU" data-value="ECU">Ecuador</div>
        <div class="option centered focusable" data-l10n-id="nationality_EGY" data-value="EGY">Egypt</div>
        <div class="option centered focusable" data-l10n-id="nationality_SLV" data-value="SLV">El Salvador</div>
        <div class="option centered focusable" data-l10n-id="nationality_GNQ" data-value="GNQ">Equatorial Guinea</div>
        <div class="option centered focusable" data-l10n-id="nationality_ERI" data-value="ERI">Eritrea</div>
        <div class="option centered focusable" data-l10n-id="nationality_EST" data-value="EST">Estonia</div>
        <div class="option centered focusable" data-l10n-id="nationality_ETH" data-value="ETH">Ethiopia</div>
        <div class="option centered focusable" data-l10n-id="nationality_FLK" data-value="FLK">Falkland Islands (Islas Malvinas)</div>
        <div class="option centered focusable" data-l10n-id="nationality_FRO" data-value="FRO">Faroe Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_FJI" data-value="FJI">Fiji</div>
        <div class="option centered focusable" data-l10n-id="nationality_FIN" data-value="FIN">Finland</div>
        <div class="option centered focusable" data-l10n-id="nationality_FRA" data-value="FRA">France</div>
        <div class="option centered focusable" data-l10n-id="nationality_GUF" data-value="GUF">French Guiana</div>
        <div class="option centered focusable" data-l10n-id="nationality_PYF" data-value="PYF">French Polynesia</div>
        <div class="option centered focusable" data-l10n-id="nationality_ATF" data-value="ATF">French Southern Territories</div>
        <div class="option centered focusable" data-l10n-id="nationality_GAB" data-value="GAB">Gabon</div>
        <div class="option centered focusable" data-l10n-id="nationality_GMB" data-value="GMB">Gambia</div>
        <div class="option centered focusable" data-l10n-id="nationality_GEO" data-value="GEO">Georgia</div>
        <div class="option centered focusable" data-l10n-id="nationality_DEU" data-value="DEU">Germany</div>
        <div class="option centered focusable" data-l10n-id="nationality_GHA" data-value="GHA">Ghana</div>
        <div class="option centered focusable" data-l10n-id="nationality_GIB" data-value="GIB">Gibraltar</div>
        <div class="option centered focusable" data-l10n-id="nationality_GRC" data-value="GRC">Greece</div>
        <div class="option centered focusable" data-l10n-id="nationality_GRL" data-value="GRL">Greenland</div>
        <div class="option centered focusable" data-l10n-id="nationality_GRD" data-value="GRD">Grenada</div>
        <div class="option centered focusable" data-l10n-id="nationality_GLP" data-value="GLP">Guadeloupe</div>
        <div class="option centered focusable" data-l10n-id="nationality_GUM" data-value="GUM">Guam</div>
        <div class="option centered focusable" data-l10n-id="nationality_GTM" data-value="GTM">Guatemala</div>
        <div class="option centered focusable" data-l10n-id="nationality_GGY" data-value="GGY">Guernsey</div>
        <div class="option centered focusable" data-l10n-id="nationality_GIN" data-value="GIN">Guinea</div>
        <div class="option centered focusable" data-l10n-id="nationality_GNB" data-value="GNB">Guinea-Bissau</div>
        <div class="option centered focusable" data-l10n-id="nationality_GUY" data-value="GUY">Guyana</div>
        <div class="option centered focusable" data-l10n-id="nationality_HTI" data-value="HTI">Haiti</div>
        <div class="option centered focusable" data-l10n-id="nationality_HMD" data-value="HMD">Heard & McDonald Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_VAT" data-value="VAT">Vatican City</div>
        <div class="option centered focusable" data-l10n-id="nationality_HND" data-value="HND">Honduras</div>
        <div class="option centered focusable" data-l10n-id="nationality_HKG" data-value="HKG">Hong Kong SAR</div>
        <div class="option centered focusable" data-l10n-id="nationality_HUN" data-value="HUN">Hungary</div>
        <div class="option centered focusable" data-l10n-id="nationality_ISL" data-value="ISL">Iceland</div>
        <div class="option centered focusable" data-l10n-id="nationality_IND" data-value="IND">India</div>
        <div class="option centered focusable" data-l10n-id="nationality_IDN" data-value="IDN">Indonesia</div>
        <div class="option centered focusable" data-l10n-id="nationality_IRN" data-value="IRN">Iran</div>
        <div class="option centered focusable" data-l10n-id="nationality_IRQ" data-value="IRQ">Iraq</div>
        <div class="option centered focusable" data-l10n-id="nationality_IRL" data-value="IRL">Ireland</div>
        <div class="option centered focusable" data-l10n-id="nationality_IMN" data-value="IMN">Isle of Man</div>
        <div class="option centered focusable" data-l10n-id="nationality_ISR" data-value="ISR">Israel</div>
        <div class="option centered focusable" data-l10n-id="nationality_ITA" data-value="ITA">Italy</div>
        <div class="option centered focusable" data-l10n-id="nationality_JAM" data-value="JAM">Jamaica</div>
        <div class="option centered focusable" data-l10n-id="nationality_JPN" data-value="JPN">Japan</div>
        <div class="option centered focusable" data-l10n-id="nationality_JEY" data-value="JEY">Jersey</div>
        <div class="option centered focusable" data-l10n-id="nationality_JOR" data-value="JOR">Jordan</div>
        <div class="option centered focusable" data-l10n-id="nationality_KAZ" data-value="KAZ">Kazakhstan</div>
        <div class="option centered focusable" data-l10n-id="nationality_KEN" data-value="KEN">Kenya</div>
        <div class="option centered focusable" data-l10n-id="nationality_KIR" data-value="KIR">Kiribati</div>
        <div class="option centered focusable" data-l10n-id="nationality_PRK" data-value="PRK">North Korea</div>
        <div class="option centered focusable" data-l10n-id="nationality_KOR" data-value="KOR">South Korea</div>
        <div class="option centered focusable" data-l10n-id="nationality_XKX" data-value="XKX">Kosovo</div>
        <div class="option centered focusable" data-l10n-id="nationality_KWT" data-value="KWT">Kuwait</div>
        <div class="option centered focusable" data-l10n-id="nationality_KGZ" data-value="KGZ">Kyrgyzstan</div>
        <div class="option centered focusable" data-l10n-id="nationality_LAO" data-value="LAO">Laos</div>
        <div class="option centered focusable" data-l10n-id="nationality_LVA" data-value="LVA">Latvia</div>
        <div class="option centered focusable" data-l10n-id="nationality_LBN" data-value="LBN">Lebanon</div>
        <div class="option centered focusable" data-l10n-id="nationality_LSO" data-value="LSO">Lesotho</div>
        <div class="option centered focusable" data-l10n-id="nationality_LBR" data-value="LBR">Liberia</div>
        <div class="option centered focusable" data-l10n-id="nationality_LBY" data-value="LBY">Libya</div>
        <div class="option centered focusable" data-l10n-id="nationality_LIE" data-value="LIE">Liechtenstein</div>
        <div class="option centered focusable" data-l10n-id="nationality_LTU" data-value="LTU">Lithuania</div>
        <div class="option centered focusable" data-l10n-id="nationality_LUX" data-value="LUX">Luxembourg</div>
        <div class="option centered focusable" data-l10n-id="nationality_MAC" data-value="MAC">Macao SAR</div>
        <div class="option centered focusable" data-l10n-id="nationality_MKD" data-value="MKD">North Macedonia</div>
        <div class="option centered focusable" data-l10n-id="nationality_MDG" data-value="MDG">Madagascar</div>
        <div class="option centered focusable" data-l10n-id="nationality_MWI" data-value="MWI">Malawi</div>
        <div class="option centered focusable" data-l10n-id="nationality_MYS" data-value="MYS">Malaysia</div>
        <div class="option centered focusable" data-l10n-id="nationality_MDV" data-value="MDV">Maldives</div>
        <div class="option centered focusable" data-l10n-id="nationality_MLI" data-value="MLI">Mali</div>
        <div class="option centered focusable" data-l10n-id="nationality_MLT" data-value="MLT">Malta</div>
        <div class="option centered focusable" data-l10n-id="nationality_MHL" data-value="MHL">Marshall Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_MTQ" data-value="MTQ">Martinique</div>
        <div class="option centered focusable" data-l10n-id="nationality_MRT" data-value="MRT">Mauritania</div>
        <div class="option centered focusable" data-l10n-id="nationality_MUS" data-value="MUS">Mauritius</div>
        <div class="option centered focusable" data-l10n-id="nationality_MYT" data-value="MYT">Mayotte</div>
        <div class="option centered focusable" data-l10n-id="nationality_MEX" data-value="MEX">Mexico</div>
        <div class="option centered focusable" data-l10n-id="nationality_FSM" data-value="FSM">Micronesia</div>
        <div class="option centered focusable" data-l10n-id="nationality_MDA" data-value="MDA">Moldova</div>
        <div class="option centered focusable" data-l10n-id="nationality_MCO" data-value="MCO">Monaco</div>
        <div class="option centered focusable" data-l10n-id="nationality_MNG" data-value="MNG">Mongolia</div>
        <div class="option centered focusable" data-l10n-id="nationality_MNE" data-value="MNE">Montenegro</div>
        <div class="option centered focusable" data-l10n-id="nationality_MSR" data-value="MSR">Montserrat</div>
        <div class="option centered focusable" data-l10n-id="nationality_MAR" data-value="MAR">Morocco</div>
        <div class="option centered focusable" data-l10n-id="nationality_MOZ" data-value="MOZ">Mozambique</div>
        <div class="option centered focusable" data-l10n-id="nationality_MMR" data-value="MMR">Myanmar (Burma)</div>
        <div class="option centered focusable" data-l10n-id="nationality_NAM" data-value="NAM">Namibia</div>
        <div class="option centered focusable" data-l10n-id="nationality_NRU" data-value="NRU">Nauru</div>
        <div class="option centered focusable" data-l10n-id="nationality_NPL" data-value="NPL">Nepal</div>
        <div class="option centered focusable" data-l10n-id="nationality_NLD" data-value="NLD">Netherlands</div>
        <div class="option centered focusable" data-l10n-id="nationality_ANT" data-value="ANT">Curaao</div>
        <div class="option centered focusable" data-l10n-id="nationality_NCL" data-value="NCL">New Caledonia</div>
        <div class="option centered focusable" data-l10n-id="nationality_NZL" data-value="NZL">New Zealand</div>
        <div class="option centered focusable" data-l10n-id="nationality_NIC" data-value="NIC">Nicaragua</div>
        <div class="option centered focusable" data-l10n-id="nationality_NER" data-value="NER">Niger</div>
        <div class="option centered focusable" data-l10n-id="nationality_NGA" data-value="NGA">Nigeria</div>
        <div class="option centered focusable" data-l10n-id="nationality_NIU" data-value="NIU">Niue</div>
        <div class="option centered focusable" data-l10n-id="nationality_NFK" data-value="NFK">Norfolk Island</div>
        <div class="option centered focusable" data-l10n-id="nationality_MNP" data-value="MNP">Northern Mariana Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_NOR" data-value="NOR">Norway</div>
        <div class="option centered focusable" data-l10n-id="nationality_OMN" data-value="OMN">Oman</div>
        <div class="option centered focusable" data-l10n-id="nationality_PAK" data-value="PAK">Pakistan</div>
        <div class="option centered focusable" data-l10n-id="nationality_PLW" data-value="PLW">Palau</div>
        <div class="option centered focusable" data-l10n-id="nationality_PSE" data-value="PSE">Palestine</div>
        <div class="option centered focusable" data-l10n-id="nationality_PAN" data-value="PAN">Panama</div>
        <div class="option centered focusable" data-l10n-id="nationality_PNG" data-value="PNG">Papua New Guinea</div>
        <div class="option centered focusable" data-l10n-id="nationality_PRY" data-value="PRY">Paraguay</div>
        <div class="option centered focusable" data-l10n-id="nationality_PER" data-value="PER">Peru</div>
        <div class="option centered focusable" data-l10n-id="nationality_PHL" data-value="PHL">Philippines</div>
        <div class="option centered focusable" data-l10n-id="nationality_PCN" data-value="PCN">Pitcairn Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_POL" data-value="POL">Poland</div>
        <div class="option centered focusable" data-l10n-id="nationality_PRT" data-value="PRT">Portugal</div>
        <div class="option centered focusable" data-l10n-id="nationality_PRI" data-value="PRI">Puerto Rico</div>
        <div class="option centered focusable" data-l10n-id="nationality_QAT" data-value="QAT">Qatar</div>
        <div class="option centered focusable" data-l10n-id="nationality_REU" data-value="REU">Runion</div>
        <div class="option centered focusable" data-l10n-id="nationality_ROM" data-value="ROM">Romania</div>
        <div class="option centered focusable" data-l10n-id="nationality_RUS" data-value="RUS">Russia</div>
        <div class="option centered focusable" data-l10n-id="nationality_RWA" data-value="RWA">Rwanda</div>
        <div class="option centered focusable" data-l10n-id="nationality_BLM" data-value="BLM">St. Barthlemy</div>
        <div class="option centered focusable" data-l10n-id="nationality_SHN" data-value="SHN">St. Helena</div>
        <div class="option centered focusable" data-l10n-id="nationality_KNA" data-value="KNA">St. Kitts & Nevis</div>
        <div class="option centered focusable" data-l10n-id="nationality_LCA" data-value="LCA">St. Lucia</div>
        <div class="option centered focusable" data-l10n-id="nationality_MAF" data-value="MAF">St. Martin</div>
        <div class="option centered focusable" data-l10n-id="nationality_SPM" data-value="SPM">St. Pierre & Miquelon</div>
        <div class="option centered focusable" data-l10n-id="nationality_VCT" data-value="VCT">St. Vincent & Grenadines</div>
        <div class="option centered focusable" data-l10n-id="nationality_WSM" data-value="WSM">Samoa</div>
        <div class="option centered focusable" data-l10n-id="nationality_SMR" data-value="SMR">San Marino</div>
        <div class="option centered focusable" data-l10n-id="nationality_STP" data-value="STP">So Tom & Prncipe</div>
        <div class="option centered focusable" data-l10n-id="nationality_SAU" data-value="SAU">Saudi Arabia</div>
        <div class="option centered focusable" data-l10n-id="nationality_SEN" data-value="SEN">Senegal</div>
        <div class="option centered focusable" data-l10n-id="nationality_SRB" data-value="SRB">Serbia</div>
        <div class="option centered focusable" data-l10n-id="nationality_SYC" data-value="SYC">Seychelles</div>
        <div class="option centered focusable" data-l10n-id="nationality_SLE" data-value="SLE">Sierra Leone</div>
        <div class="option centered focusable" data-l10n-id="nationality_SGP" data-value="SGP">Singapore</div>
        <div class="option centered focusable" data-l10n-id="nationality_SXM" data-value="SXM">Sint Maarten</div>
        <div class="option centered focusable" data-l10n-id="nationality_SVK" data-value="SVK">Slovakia</div>
        <div class="option centered focusable" data-l10n-id="nationality_SVN" data-value="SVN">Slovenia</div>
        <div class="option centered focusable" data-l10n-id="nationality_SLB" data-value="SLB">Solomon Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_SOM" data-value="SOM">Somalia</div>
        <div class="option centered focusable" data-l10n-id="nationality_ZAF" data-value="ZAF">South Africa</div>
        <div class="option centered focusable" data-l10n-id="nationality_SGS" data-value="SGS">South Georgia & South Sandwich Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_SSD" data-value="SSD">South Sudan</div>
        <div class="option centered focusable" data-l10n-id="nationality_ESP" data-value="ESP">Spain</div>
        <div class="option centered focusable" data-l10n-id="nationality_LKA" data-value="LKA">Sri Lanka</div>
        <div class="option centered focusable" data-l10n-id="nationality_SDN" data-value="SDN">Sudan</div>
        <div class="option centered focusable" data-l10n-id="nationality_SUR" data-value="SUR">Suriname</div>
        <div class="option centered focusable" data-l10n-id="nationality_SJM" data-value="SJM">Svalbard & Jan Mayen</div>
        <div class="option centered focusable" data-l10n-id="nationality_SWZ" data-value="SWZ">Eswatini</div>
        <div class="option centered focusable" data-l10n-id="nationality_SWE" data-value="SWE">Sweden</div>
        <div class="option centered focusable" data-l10n-id="nationality_CHE" data-value="CHE">Switzerland</div>
        <div class="option centered focusable" data-l10n-id="nationality_SYR" data-value="SYR">Syria</div>
        <div class="option centered focusable" data-l10n-id="nationality_TWN" data-value="TWN">Taiwan, China</div>
        <div class="option centered focusable" data-l10n-id="nationality_TJK" data-value="TJK">Tajikistan</div>
        <div class="option centered focusable" data-l10n-id="nationality_TZA" data-value="TZA">Tanzania</div>
        <div class="option centered focusable" data-l10n-id="nationality_THA" data-value="THA">Thailand</div>
        <div class="option centered focusable" data-l10n-id="nationality_TLS" data-value="TLS">Timor-Leste</div>
        <div class="option centered focusable" data-l10n-id="nationality_TGO" data-value="TGO">Togo</div>
        <div class="option centered focusable" data-l10n-id="nationality_TKL" data-value="TKL">Tokelau</div>
        <div class="option centered focusable" data-l10n-id="nationality_TON" data-value="TON">Tonga</div>
        <div class="option centered focusable" data-l10n-id="nationality_TTO" data-value="TTO">Trinidad & Tobago</div>
        <div class="option centered focusable" data-l10n-id="nationality_TUN" data-value="TUN">Tunisia</div>
        <div class="option centered focusable" data-l10n-id="nationality_TUR" data-value="TUR">Turkey</div>
        <div class="option centered focusable" data-l10n-id="nationality_TKM" data-value="TKM">Turkmenistan</div>
        <div class="option centered focusable" data-l10n-id="nationality_TCA" data-value="TCA">Turks & Caicos Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_TUV" data-value="TUV">Tuvalu</div>
        <div class="option centered focusable" data-l10n-id="nationality_UGA" data-value="UGA">Uganda</div>
        <div class="option centered focusable" data-l10n-id="nationality_UKR" data-value="UKR">Ukraine</div>
        <div class="option centered focusable" data-l10n-id="nationality_ARE" data-value="ARE">United Arab Emirates</div>
        <div class="option centered focusable" data-l10n-id="nationality_GBR" data-value="GBR">United Kingdom</div>
        <div class="option centered focusable" data-l10n-id="nationality_USA" data-value="USA">United States</div>
        <div class="option centered focusable" data-l10n-id="nationality_UMI" data-value="UMI">U.S. Outlying Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_URY" data-value="URY">Uruguay</div>
        <div class="option centered focusable" data-l10n-id="nationality_UZB" data-value="UZB">Uzbekistan</div>
        <div class="option centered focusable" data-l10n-id="nationality_VUT" data-value="VUT">Vanuatu</div>
        <div class="option centered focusable" data-l10n-id="nationality_VEN" data-value="VEN">Venezuela</div>
        <div class="option centered focusable" data-l10n-id="nationality_VNM" data-value="VNM">Vietnam</div>
        <div class="option centered focusable" data-l10n-id="nationality_VGB" data-value="VGB">British Virgin Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_VIR" data-value="VIR">U.S. Virgin Islands</div>
        <div class="option centered focusable" data-l10n-id="nationality_WLF" data-value="WLF">Wallis & Futuna</div>
        <div class="option centered focusable" data-l10n-id="nationality_ESH" data-value="ESH">Western Sahara</div>
        <div class="option centered focusable" data-l10n-id="nationality_YEM" data-value="YEM">Yemen</div>
        <div class="option centered focusable" data-l10n-id="nationality_ZMB" data-value="ZMB">Zambia</div>
        <div class="option centered focusable" data-l10n-id="nationality_ZWE" data-value="ZWE">Zimbabwe</div>
    </div>
    `;

    }

    ksUI.registerModule('ks-nationalitylist', NationalityList);

    class PlayerInfoPage extends KsHTMLElement {

        /** @type MessageHandler */
        GameEconomyClient;

        btnContinue;
        btnBack;
        btnApply;
        btnCancel;
        modalNationality;
        isDirty = false;

        /** @type {TextInput} */
        txtName;
        /** @type {TextInput} */
        txtSurname;
        /** @type {TextInput} */
        txtNickname;
        /** @type {TextInput} */
        txtInitials;
        /** @type {TextInput} */
        txtAge;

        /** @type {TextInput} */
        txtSearchCountry;

        /** @type {NationalityList} */
        listNationality;


        get isFirstStart() {
            return this.hasAttribute("firststart");
        }

        filters = {
            notifzero: (value) => {
                return Number(value) > 0 ? value : "";
            }
        }

        PersonalData;

        constructor() {
            super();
            this.template = template$1y;
            this.delayedInit = true;
            this._isnavigable = true;
            this.shouldRenderControlHints = true;
            this._exposeAsActivePage = true;

        }

        exit() {
            engine.trigger("OnPlayerInfoFinished");
        }

        validate() {
            return this.txtName.validate() && this.txtSurname.validate() && this.txtInitials.validate() && this.txtAge.validate();
        }


        markDirty() {
            this.isDirty = true;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.removeAttribute("disabled");
            });
        }

        clearDirty() {
            this.isDirty = false;
            [this.btnApply, this.btnCancel].map(btn => {
                if (btn)
                    btn.setAttribute("disabled", true);
            });
        }

        allowContinue() {
            if (this.validate()) {
                this.btnContinue.removeAttribute('disabled');
            } else {
                this.btnContinue.setAttribute('disabled', "");
            }
            //this.btnContinue.toggleAttribute("disabled", !this.validate());        
        }

        onAfterRenderControlHints(controlhints) {

            this.mapElementById("btnContinue", controlhints);
            this.mapElementById("btnBack", controlhints);
            this.mapElementById("btnApply", controlhints);
            this.mapElementById("btnCancel", controlhints);

            this.btnContinue.onPressed = () => {
                this.updatePersonalData().then((data) => {
                    this.exit();
                });
            };

            this.btnApply.onPressed = () => {
                this.updatePersonalData();
                this.clearDirty();
            };

            this.btnCancel.onPressed = () => {
                this.loadPersonalData();
                this.clearDirty();
            };

            const changePage = function () {

                function process() {
                    ksUI$1.goTo("menu.html", "main/main");
                }

                if (this.isDirty) {

                    this.pageModal.Show({
                        type: eModalDialogTypes.Warning,
                        title: "lblChangesDetected",
                        message: "msgChangesWarning",
                        confirm: "btnApply"
                    });

                    this.pageModal.onDiscard = () => {

                        waitForFrames(() => {
                            process();
                        }, 1);
                    };

                    this.pageModal.onConfirm = () => {
                        this.updatePersonalData().then(() => {
                            ksUI$1.goTo("menu.html", "main/main");
                        });
                    };
                } else {
                    process();
                }
            }.bind(this);

            if (!this.isFirstStart) {
                this.btnBack.onBeforeRedirect = () => {
                    changePage();
                    return false;
                };
            }


        }

        bindControls() {

            this.modalNationality.onSelected = (event, value, displayvalue) => {
                this.modalNationality.setCurrentText(displayvalue);
                this.PersonalData.nationality_alpha_3 = value;
                this.markDirty();
            };

            this.modalNationality.onHide = () => {
                console.log("modal hidden");
                waitForFrames(() =>
                    this.modalNationality.focus(), 1);
            };

            this.modalNationality.onShow = () => {

                // if (!$.q(".scrollable-container", this.modalNationality)) {
                //     Scrollbar.create({ selector: 'ks-modalselect .list', contentSelector: '.options' });
                //     $.q(".list").addEventListener("wheel", (e) => {
                //         if (Scrollbar.components.entries().next().value) {
                //             let scrl = Scrollbar.components.entries().next().value[0];
                //             let position = ksUI.clamp(scrl.scrollPosition - (e.deltaY / 30), 0, 1);
                //             //console.log(e.deltaY, position);
                //             scrl.scrollTo(position);
                //         }
                //     });
                // }

            };

            this.modalNationality.onBindingUpdate = (param, value) => {
                if (param == "ksvalue") {
                    let country = q("div.option[data-value=\"" + value + "\"]", this.modalNationality);
                    if (country) {
                        this.modalNationality.setCurrentText(country.innerHTML);
                    }
                }
            };

            this.txtName.onChange = (value, isvalid) => {
                if (isvalid) {
                    this.PersonalData.first_name = value;
                }
                this.markDirty();
                this.allowContinue();
            };

            this.txtSurname.onChange = (value, isvalid) => {
                if (isvalid) {
                    this.PersonalData.last_name = value;
                }
                this.markDirty();
                this.allowContinue();
            };

            this.txtNickname.onChange = (value, isvalid) => {
                if (isvalid) {
                    this.PersonalData.nickname = value;
                }
                this.markDirty();
                this.allowContinue();
            };

            this.txtInitials.onChange = (value, isvalid) => {
                if (isvalid) {
                    this.PersonalData.shortcut_name = value;
                }
                this.markDirty();
                this.allowContinue();
            };

            this.txtAge.onChange = (value, isvalid) => {
                if (isvalid) {
                    this.PersonalData.age = Number(value);
                }
                this.markDirty();
                this.allowContinue();
            };

            this.txtSearchCountry.onInput = (value, valid) => {
                if (!this.nationalityOptions)
                    this.nationalityOptions = qAll(".option", this.NationalityList);

                const options = this.nationalityOptions;

                options.forEach(option => {
                    option.classList.toggle("hidden", option.textContent.toLocaleLowerCase().indexOf(value.toLocaleLowerCase()) == -1);
                    waitForFrames(() => {
                        rootModal().updateAllScrollBars();
                    });
                });

            };
        }



        onRemovedFromDOM() {
            this.documentBody.classList.remove("playerinfo");
        }

        loadPersonalData() {
            this.GameEconomyClient.request("DriverPersonalData",
                (data) => {
                    this.PersonalData = data.personal_data;
                    this.assignModel(this.PersonalData, "PersonalData", true);

                    waitForFrames(() => this.allowContinue(), 1);
                });

        }

        updatePersonalData() {
            return new Promise((resolve, reject) => {
                this.GameEconomyClient.request("UpdateDriverPersonalData", {
                    driver_id: "",
                    personal_data: this.PersonalData
                }, (data) => {
                    if (data.response == eBackendResponse.OK) {
                        resolve(data);
                    } else {
                        reject(data);
                    }
                });
            });
        }


        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.GameEconomyClient = new MessageHandler("GameEconomyClient");

            console.log("Player info page");
            this.documentBody.classList.add("playerinfo");
            this.mapElementById("modalNationality");

            this.mapElementById("txtName");
            this.mapElementById("txtSurname");
            this.mapElementById("txtNickname");
            this.mapElementById("txtInitials");
            this.mapElementById("txtAge");
            this.mapElementById("txtSearchCountry");
            this.mapElementById("listNationality");

            if (!this.isFirstStart) {
                q("ks-pageheader div[slot='label']", this).setAttribute("data-l10n-id", "headerDriverCenter");
            }

            this.loadPersonalData();



        }
    }

    ksUI$1.registerModule('ks-page-playerinfo', PlayerInfoPage);

    var template$1v = "<div class=\"component-body paintshop-body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back rounded focusable\">\r\n                <div slot=\"name\">\r\n                    <div data-l10n-id=\"btnBack\">Back</div>\r\n                </div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"apply focusable\" id=\"apply\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnApply\">Apply</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"cancel focusable\" id=\"cancel\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCancel\">Cancel</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"focusable\" id=\"btnAutoSwitchCamera\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"lblAutoSwitchCamera\">Auto-Switch View</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n\r\n        <div class=\"group end\">\r\n            <ks-btnbasic id=\"btnSceneControls\" class=\"focusable btnSceneControls\" data-tooltip=\"lblSceneControls\" data-tooltip-css-class=\"inline\" toggle>\r\n                <div slot=\"icon\"></div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnCarControls\" class=\"focusable\" data-tooltip=\"lblCarControls\" data-tooltip-css-class=\"inline\" toggle>\r\n                <div slot=\"icon\"></div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <div class=\"submode main\">\r\n\r\n        <ks-pageheader class=\"minimal showlogo\">\r\n            <div id=\"labelHeader\" slot=\"label\" data-l10n-id=\"headerCustomizeVehicle\">Paint Shop</div>\r\n        </ks-pageheader>\r\n\r\n        <div class=\"busy-indicator\"></div>\r\n\r\n        <div class=\"submode-body centered-content hidedev\">\r\n\r\n            <div id=\"carNumber\">\r\n                <div class=\"label\" data-l10n-id=\"lblCarNumber\"></div>\r\n                <ks-textinput id=\"txtCarNumber\" maxlength=\"2\" class=\"focusable\"></ks-textinput>\r\n            </div>\r\n\r\n            <div id=\"modelName\">\r\n                <ks-btnpanel class=\"brand focusable\" path=\"{activeMenu}/brandselection\" data-bind-ksmessage=\"{{CurrentCar.model.manufacturer}}\">\r\n                </ks-btnpanel>\r\n                <div class=\"name\" data-bind-value=\"{{CurrentCar.model.display_name}}\"></div>\r\n                <div id=\"modelVariant\" class=\"is-flex\">\r\n                    <div class=\"configuration is-flex-column\">\r\n\r\n                        <div class=\"value\" data-bind-value=\"{{CurrentCar.model.translated.mech}}\"></div>\r\n                        <div class=\"label\" data-l10n-id=\"lblConfiguration\"></div>\r\n                    </div>\r\n                    <div class=\"trim is-flex-column\">\r\n\r\n                        <div class=\"value\" data-bind-value=\"{{CurrentCar.model.translated.visual}}\"></div>\r\n                        <div class=\"label\" data-l10n-id=\"lblTrim\"></div>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n\r\n            <div id=\"panelPaintShopControls\" class=\"row controls is-flex-column\">\r\n                <div id=\"panelMain\" class=\"mainpanel collapsed\">\r\n                    <div class=\"loading-indicator\">...</div>\r\n                    <div class=\"mainpanel-content\">\r\n\r\n                        <div class=\"parts collapsed\">\r\n\r\n                            <div class=\"list\">\r\n                            </div>\r\n                        </div>\r\n\r\n                        <!-- <div class=\"designs collapsed\">\r\n                            <div class=\"list-label\">DESIGNS</div>\r\n                            <div class=\"list\">\r\n                            </div>\r\n                        </div> -->\r\n\r\n                        <div class=\"compounds collapsed\">\r\n                            <div class=\"list-label\">TYRES</div>\r\n                            <div class=\"list\">\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div class=\"materials collapsed\">\r\n                            <div class=\"list-label\" data-l10n-id=\"lblAppearance\">APPEARANCE</div>\r\n                            <div class=\"list\">\r\n                            </div>\r\n                        </div>\r\n\r\n                    </div>\r\n                </div>\r\n\r\n                <div id=\"categoryselector\" class=\"categoryselector\">\r\n\r\n                    <div class=\"categoryselector-wrapper\">\r\n                        <ks-radiobuttongroup id=\"partcategory\" class=\"notitle horizontal transparent\">\r\n\r\n                            <div slot=\"group\">\r\n\r\n                                <div class=\"category button active focusable\" data-part=\"CarCustomizationCategory_Bodywork\" data-location=\"exterior\" id=\"bodywork\">\r\n                                    <span class=\"label\" data-l10n-id=\"lblExterior\">Exterior</span>\r\n                                </div>\r\n\r\n                                <div class=\"pagination exterior is-flex-row\" data-location=\"exterior\">\r\n                                </div>\r\n\r\n                                <div class=\"category button active focusable\" data-part=\"CarCustomizationCategory_Bodywork\" data-location=\"interior\" id=\"bodywork\">\r\n                                    <span class=\"label\" data-l10n-id=\"lblInterior\">Interior</span>\r\n                                </div>\r\n\r\n                                <div class=\"pagination interior is-flex-row\" data-location=\"interior\">\r\n                                </div>\r\n\r\n                                <div class=\"category button active focusable\" data-part=\"CarCustomizationCategory_Rims\" id=\"rims\">\r\n                                    <span class=\"label\" data-l10n-id=\"lblWheels\">Wheels</span>\r\n                                </div>\r\n\r\n                                <!-- <div class=\"category button active focusable\"\r\n                                    data-part=\"CarCustomizationCategory_Compounds\"\r\n                                    id=\"tyres\">\r\n                                    <span class=\"label\">Tyres</span>\r\n                                </div> -->\r\n\r\n                                <div class=\"category button active focusable\" data-part=\"CarCustomizationCategory_Parts\" id=\"parts\">\r\n                                    <span class=\"label\" data-l10n-id=\"lblParts\">Parts</span>\r\n                                </div>\r\n\r\n                            </div>\r\n                        </ks-radiobuttongroup>\r\n\r\n                        <div class=\"label-categoryselector\">\r\n\r\n                        </div>\r\n\r\n                    </div>\r\n                </div>\r\n\r\n\r\n            </div>\r\n\r\n            <div id=\"panelCarControls\" class=\"row car-controls is-flex-column\">\r\n                <ks-showroomcarcontrol data-mode=\"electrics\" id=\"controlCar\"></ks-showroomcarcontrol>\r\n            </div>\r\n\r\n            <div id=\"panelSceneControls\" class=\"row scene-controls is-flex-column\">\r\n                <ks-showroomscenecontrol id=\"controlScene\"></ks-showroomscenecontrol>\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n\r\n</div>";

    var template$1u = "<div class=\"modaldialog-body component-body\">\r\n\r\n    <div class=\"logo\"></div>\r\n\r\n\r\n    <div class=\"modalTitle\">\r\n        <component-slot class=\"thing\" data-name=\"header\">Title Missing</component-slot>\r\n    </div>\r\n\r\n    <div class=\"modalMessage\">\r\n        <component-slot data-name=\"message\">Message Missing</component-slot>\r\n    </div>\r\n    \r\n    <div class=\"message-variables\"></div>\r\n\r\n    <div class=\"modalContent\">\r\n        <component-slot data-name=\"content\"></component-slot>\r\n    </div>\r\n\r\n    <div class=\"modalControls\">\r\n        <component-slot data-name=\"controls\">\r\n            <ks-btnbasic class=\"focusable rounded confirm\" data-audio=\"GUI_CONFIRM\">\r\n                <div slot=\"name\" data-l10n-id=\"btnConfirm\"></div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"focusable rounded discard\">\r\n                <div slot=\"name\" data-l10n-id=\"btnDiscard\"></div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"focusable rounded cancel defaultfocus default-element\" data-audio=\"GUI_CANCEL\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCancel\"></div>\r\n            </ks-btnbasic>\r\n        </component-slot>\r\n    </div>\r\n\r\n</div>";

    class ModalDialog extends KsHTMLElement {

        buttonMask = {
            confirm: 0x100,
            cancel: 0x001,
            discard: 0x010
        }

        _navConfig = {
            selector: '.focusable',
            enterTo: 'default-element',
            restrict: 'self-only',
            defaultElement: 'ks-modaldialog .defaultfocus'
        };

        /**
         * @typedef ModalDialogOptions
         * @property {string} title
         * @property {string} message
         * @property {string} confirm
         * @property {string} cancel
         * @property {string} discard
         * @property {string} extraCssClass
         * @property {object} msgVariables
         * @property {string} confirm
         * @property {number} buttons bitmask 0x111 confirm, discard, cancel
         * @property {boolean} showTitle
         * @property {boolean} showMessage
         * @property {boolean} showContent
         * @property {boolean} horizontalControls,
         * @property {boolean} opaque,
         * @property {boolean} logo,
         * @property {string} dataMode,
         * @property {boolean} autoHide
         * @property {boolean} useKeyEvent
         */

        activeOptions = {};

        options = {
            title: "",
            titleText: "",
            message: "",
            confirm: "",
            cancel: "",
            discard: "",
            extraCssClass: "",
            msgVariables: {},
            buttons: 0x111,
            showTitle: true,
            showMessage: true,
            showContent: false,
            horizontalControls: false,
            opaque: false,
            logo: false,
            dataMode: "",
            autoHide: true,
            useKeyEvent: false,
            type: eModalDialogTypes.Standard,
            forceAllowMouseHover: false,
            toggleMouseHover: true,
            hideAfter: 0
        }

        useKeyEvent = false;

        btnConfirm;
        btnCancel;
        btnDiscard;

        extraCssClass = [];

        header;
        headerSlot;

        message;
        messageVariables;
        messageSlot;

        content;
        contentSlot;

        initialWidgetHovering = false;

        showedInUrl;

        get isVisible() {
            return this.classList.contains("visible");
        }

        constructor() {
            super();
            this._isnavigable = true;
            this.template = template$1u;
            this.delayedInit = true;
            this._bindScrollableEvents = true;
        }

        setContent(element) {
            this.content.innerHTML = "";
            // console.log(">> setContent", element, element?.tagName);
            this.content.appendChild(element);
        }

        clearContent() {
            this.content.innerHTML = "";
        }

        getOptions() {
            return this.options;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.btnConfirm = q(".confirm", this);
            this.btnCancel = q(".cancel", this);
            this.btnDiscard = q(".discard", this);

            this.title = q(".modalTitle", this);
            this.message = q(".modalMessage", this);
            this.messageVariables = q(".message-variables", this);



            this.content = q(".modalContent", this);
        }

        /** 
         * @param {ModalDialogOptions} opt 
        */
        Show(opt) {

            this.showedInUrl = location.pathname;

            ksUI$1.preventBack = true;

            if (!this.templateLoaded) {
                console.warn("Cannot show modal at this time - delayed retry");
                waitForFrames(() => this.Show(opt), 3);
                return;
            }

            let _opt = { ... this.options, ...opt };

            this.activeOptions = _opt;

            this.useKeyEvent = _opt.useKeyEvent;

            //console.warn("Modal useKeyEvent", this.useKeyEvent, _opt.useKeyEvent);

            this.dataset.mode = _opt.dataMode;
            if (this.dataset.mode) {
                document.body.dataset.modalDialogMode = this.dataset.mode;
            }
            this.classList.add("visible");
            this.classList.toggle("opaque", _opt.opaque);
            this.classList.toggle("show-logo", _opt.logo);
            this.classList.toggle("show-title", _opt.showTitle);
            this.classList.toggle("show-message", _opt.showMessage);
            this.classList.toggle("show-content", _opt.showContent);
            this.extraCssClass = _opt.extraCssClass.split(" ");
            ksUI$1.addClasses(this, ... this.extraCssClass);

            this.setButtons(_opt.buttons);
            this.classList.toggle("show-message-variables", Object.keys(_opt.msgVariables).length > 0);

            if (_opt.titleText !== "") {
                this.title.innerHTML = _opt.titleText;
            }

            if (_opt.title !== "")
                this.title.setAttribute("data-l10n-id", _opt.title);

            if (_opt.message !== "") {
                this.message.setAttribute("data-l10n-id", _opt.message);

                // remember this for using template literals as strings:
                //  $.fillTemplate(this.message.innerHTML, _opt.msgVariables)

                this.messageVariables.innerHTML = "";
                if (!IsObjectEmpty(_opt.msgVariables)) {

                    Object.keys(_opt.msgVariables).forEach(variable => {
                        this.messageVariables.innerHTML += `<div class="${variable}">${_opt.msgVariables[variable]}</div>`;
                    });

                }
            }

            if (_opt.confirm !== "")
                this.btnConfirm.setLabelId(_opt.confirm);
            else 
                this.btnConfirm.setLabelId("btnConfirm");

            if (_opt.cancel !== "")
                this.btnCancel.setLabelId(_opt.cancel);
            else 
                this.btnCancel.setLabelId("btnCancel");

            if (_opt.discard !== "")
                this.btnDiscard.setLabelId(_opt.discard);
            else 
                this.btnDiscard.setLabelId("btnDiscard");

            q("body").classList.add("ks-modaldialog-active");
            waitForFrames(() => {
                this.classList.add("transition");
            }, 1);

            if (_opt.autoHide) {
                this.classList.add("autohide");
            }

            if(_opt.hideAfter > 0) {
                setTimeout(() => {
                    this.Hide();
                }, _opt.hideAfter);
            }

            // SpatialNavigation.add(this.tagName, this._navConfig);
            // SpatialNavigation.focus(this.tagName);
            //this.refocusNav();

            ksUI$1.jiggleMouse();

            if (this.useKeyEvent) {
                this.#internal_onEscapeKeyEvent = this.onEscapeKeyEvent.bind(this);
                window.addEventListener("keydown", this.#internal_onEscapeKeyEvent);
            } else {
                window.removeEventListener("keydown", this.#internal_onEscapeKeyEvent);
            }

            if (_opt.type == eModalDialogTypes.Warning || _opt.type == eModalDialogTypes.Error) {
                ksUI$1.Audio(eAudioEvents.Warning);
            }

            this.onShow();
            this.initialWidgetHovering = ksUI$1.menuState.get().is_widget_hovering;

            if(_opt.toggleMouseHover)
                ksUI$1.menuState.toggleMouseHover(true);

            if(_opt.forceAllowMouseHover)
                ksUI$1.menuState.toggleMouseHover(false);

            this.setupScrollbars();

            if (ksUI$1.isSpatialNav()) {
                ksUI$1.clearFocus();
                waitForFrames(() => {
                    q(".focusable:last-child", this).focus();
                }, 3);
            }

            return this;
        }

        setMessage(new_message) {
            this.message.setAttribute("data-l10n-id", new_message);
        }

        setButtons(button_mask) {
            this.classList.toggle("show-controls", 0x111 & button_mask);
            this.classList.toggle("show-confirm", 0x100 & button_mask);
            this.classList.toggle("show-discard", 0x010 & button_mask);
            this.classList.toggle("show-cancel", 0x001 & button_mask);

        }

        Hide() {

            console.trace("Hiding ks-modaldialog");

            window.removeEventListener("keydown", this.#internal_onEscapeKeyEvent);

            this.classList.remove("visible");

            ksUI$1.removeClasses(this, this.extraCssClass);
            this.extraCssClass = "";

            if (this.title) {
                this.title.removeAttribute("data-l10n-id");
                this.title.textContent = "";
            }

            if (this.message) {
                this.message.removeAttribute("data-l10n-id");
                this.message.textContent = "";
                this.messageVariables.innerHTML = "";
            }

            q("body").classList.remove("ks-modaldialog-active");
            waitForFrames(() => {
                this.classList.remove("transition");
            }, 1);

            if(this.activeOptions.toggleMouseHover)
                ksUI$1.menuState.toggleMouseHover(this.initialWidgetHovering);

            delete document.body.dataset.modalDialogMode;

            this.onHide();

            ksUI$1.preventBack = false;
            this.useKeyEvent = false;


            ksUI$1.lastFocusedElement = null;
            ksUI$1.clearFocus();

            ksUI$1.jiggleMouse();

            this.onCancel = () => { };
            this.onConfirm = () => { };
            this.onDiscard = () => { };

            return this;
        }

        #internal_onEscapeKeyEvent;

        onEscapeKeyEvent(e) {

            if (this.dataset.mode == "loadingScreen") {
                return;
            }

            if (e.keyCode === 27) {
                e.stopPropagation();
                e.stopImmediatePropagation();
                e.preventDefault();

                if(ksUI$1.isUIHidden) {
                    document.body.classList.remove("hide-ui");
                }


                console.log("Cancelled in modal via key event 1", this.constructor.name);
                waitForFrames(() => {
                    rootModal().onCancel();
                    ksUI$1.Audio(eAudioEvents.Cancel);

                    if (rootModal().classList.contains("autohide"))
                        rootModal().Hide();
                });

            }
        }

        onNavCancel(e) {

            if (this.dataset.mode == "loadingScreen") {
                return;
            }

            if (!rootModal().classList.contains("visible")) return;
            if (e.detail != "cancel") return;

            e.stopPropagation();
            e.stopImmediatePropagation();
            e.preventDefault();

            if (!rootModal().useKeyEvent) {
                console.log("Cancelled in modal", this.constructor.name, rootModal().isVisible);
                if(ksUI$1.isUIHidden) {
                    document.body.classList.remove("hide-ui");
                }

                if (rootModal().activeOptions.buttons == 0x100) {

                    rootModal().onConfirm();
                } else {
                    ksUI$1.Audio(eAudioEvents.Cancel);
                    rootModal().onCancel();

                    if (rootModal().classList.contains("autohide"))
                        rootModal().Hide();

                }

            }

        }

        onShow() {

        }

        onHide() {

        }

        onConfirm() {

        }

        onDiscard() {

        }

        onCancel() {

        }

        bindControls() {

            this.btnConfirm.onPressed = (sender, e) => {
                this.onConfirm();
                ksUI$1.Audio(eAudioEvents.Confirm);

                if (this.classList.contains("autohide"))
                    this.Hide();
            };

            this.btnDiscard.onPressed = (sender, e) => {
                this.onDiscard();
                if (this.classList.contains("autohide"))
                    this.Hide();
            };

            this.btnCancel.onPressed = (sender, e) => {
                this.onCancel();
                ksUI$1.Audio(eAudioEvents.Cancel);

                if (this.classList.contains("autohide"))
                    this.Hide();
            };
        }


    }

    ksUI$1.registerModule('ks-modaldialog', ModalDialog);

    var template$1t = "<div class=\"component-body\">\r\n    <div class=\"title\">\r\n        <component-slot data-name=\"name\">TITLE</component-slot>\r\n    </div>\r\n    <div class=\"numericfield-controls\">\r\n        <div class=\"arrow up\">+</div>\r\n        <div class=\"value\">\r\n            <div class=\"track\">\r\n                <div class=\"bar\">\r\n\r\n                </div>\r\n            </div>\r\n            <div class=\"text\">0.00</div>\r\n        </div>\r\n        <div class=\"arrow down\">-</div>\r\n    </div>\r\n</div>";

    class NumericField extends KsHTMLElement {

        static observedAttributes = [ ... super.observedAttributes, "value"];

        fireevent = true;
        manualupdate = false;
        value = 0;
        step = 0.01;
        min = 0;
        max = 1;
        decimals = 2;
        captureMouse = false;
        isTextOnly = false;

        mousecoord = {
            x: 0,
            y: 0,
            deltaX: 0,
            deltaY: 0,
            percentX: 0,
            percentY: 0
        }

        arrowUp;
        arrowDown;
        textValue;
        percentBar;
        indicatorBox;

        clicktimerid = 0;
        starttimerid = 0;
        debouncetimer = 0;

        constructor() {
            super();
            this.template = template$1t;
            this.delayedInit = true;
        }

        normalizeValue() {
            this.value = this.fixDecimals(this.value);
        }

        increase() {
            this.normalizeValue();
            let oldValue = this.value;

            if (this.value < this.max) {
                this.value += this.step;
            } else {
                this.value = this.max;
                clearInterval(this.clicktimerid);
                clearTimeout(this.starttimerid);
                this.captureMouse = false;
            }

            let newValue = this.value;

            this.updateIndicators();

            if (this.fireevent) {
                this.onUpdate(newValue, oldValue);
            }
        }

        decrease() {

            this.normalizeValue();

            let oldValue = this.value;

            if (this.value > this.min) {
                this.value -= this.step;
            } else {
                this.value = this.min;
                clearInterval(this.clicktimerid);
                clearTimeout(this.starttimerid);
                this.captureMouse = false;
            }

            let newValue = this.value;

            this.updateIndicators();

            if (this.fireevent) {
                this.onUpdate(newValue, oldValue);
            }

        }

        setValue(val, fire_event = false) {
            let oldValue = this.value;

            val = ksUI$1.clamp(val, this.min, this.max);

            this.value = val;
            let newValue = val;

            this.manualupdate = true;
            this.setAttribute("value", this.value);
            this.manualupdate = false;

            this.updateIndicators();

            if (fire_event) {
                this.onUpdate(newValue, oldValue);
            }

        }

        bindControls() {
            this.arrowUp.addEventListener("mousedown",
                () => {
                    this.increase();
                    clearInterval(this.clicktimerid);
                    clearInterval(this.starttimerid);
                    this.starttimerid = setTimeout(
                        () => this.clicktimerid = setInterval(() => this.increase(), 50), 250);
                });

            this.arrowUp.addEventListener("mouseup", () => this.onMouseUp());
            this.arrowUp.addEventListener("mouseleave", () => this.onMouseUp());

            this.arrowDown.addEventListener("mousedown",
                () => {
                    this.decrease();
                    clearInterval(this.clicktimerid);
                    clearInterval(this.starttimerid);
                    this.starttimerid = setTimeout(
                        () => this.clicktimerid = setInterval(() => this.decrease(), 50), 250);

                });

            this.arrowDown.addEventListener("mouseup", () => this.onMouseUp());
            this.arrowDown.addEventListener("mouseleave", () => this.onMouseUp());

            if (!this.isTextOnly) {
                this.indicatorBox.addEventListener("mousedown", () => {
                    this.captureMouse = true;
                    this.setValue(
                        this.fixDecimals(this.mousecoord.percentX * (Math.abs(this.min) + Math.abs(this.max))), true
                    );
                });

                this.indicatorBox.addEventListener("mouseup", () => this.onMouseUp());
                this.indicatorBox.addEventListener("mousemove", (e) => this.onMouseMove(e));
                this.indicatorBox.addEventListener("mouseleave", (e) => this.onMouseLeave(e));
            }
        }

        fixDecimals(val) {
            return Math.round(val * Math.pow(10, this.decimals)) / Math.pow(10, this.decimals)
        }

        updateIndicators() {
            if (!this.textValue) return;
            this.textValue.innerHTML = this.fixDecimals(this.value).toFixed(this.decimals);
            let range = Math.abs(this.min) + Math.abs(this.max);
            let percentage = ((this.value + Math.abs(this.min)) / range) * 100;
            this.percentBar.style.width = percentage + "%";
        }

        initNumberFromAttr(attribute_name) {
            if (this.hasAttribute(attribute_name))
                this[attribute_name] = Number(this.getAttribute(attribute_name));
        }

        attributeChangedCallback(name, oldValue, newValue) {
            if (this.manualupdate) return;
            if (name == "value") {
                this.value = Number(newValue);
                this.updateIndicators();
            }
        }

        onMouseMove(e) {
            var rect = e.currentTarget.getBoundingClientRect();
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            if (x <= 0 || x >= rect.width) return;
            if (y <= 0 || y >= rect.height) return;

            this.mousecoord.deltaX = x - this.mousecoord.x;
            this.mousecoord.deltaY = y - this.mousecoord.y;
            this.mousecoord.x = x;
            this.mousecoord.y = y;
            if (this.mousecoord.deltaX > 0) { x = x + 5; }        if (this.mousecoord.deltaX < 0) { x = x - 5; }        this.mousecoord.percentX = (rect.width - (rect.width - x)) / rect.width;

            if (this.captureMouse) {
                this.setValue(
                    this.fixDecimals(ksUI$1.clamp(this.mousecoord.percentX * (Math.abs(this.min) + Math.abs(this.max)), this.min, this.max)), true
                );
            }
            clearInterval(this.clicktimerid);
            clearTimeout(this.starttimerid);
        }

        onMouseLeave(e) {
            clearTimeout(this.starttimerid);
            clearInterval(this.clicktimerid);
            this.captureMouse = false;
        }

        onMouseUp(e) {
            clearTimeout(this.starttimerid);
            clearInterval(this.clicktimerid);
            this.captureMouse = false;
        }

        onUpdate(new_value, old_value) {
            if (new_value != old_value) {

                this.dispatchEvent(new CustomEvent('onValueChanged', { detail: { value: new_value, old: old_value } }));
                /*
                            clearTimeout(this.debouncetimer);
                
                            this.debouncetimer = setTimeout(
                                () => this.dispatchEvent(new CustomEvent('onValueChanged', { detail: { value: new_value, old: old_value } })),
                                50);*/
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.valueLabel = q(".value", this);

            this.initNumberFromAttr("min");
            this.initNumberFromAttr("max");
            this.initNumberFromAttr("value");
            this.initNumberFromAttr("step");
            this.initNumberFromAttr("decimals");

            this.arrowUp = q(".arrow.up", this);
            this.arrowDown = q(".arrow.down", this);
            this.textValue = q(".value .text", this);
            this.percentBar = q(".value .bar", this);
            this.indicatorBox = q(".value", this);

            this.isTextOnly = this.classList.contains("text-only");

            this.updateIndicators();
        }
    }


    ksUI$1.registerModule('ks-numericfield', NumericField);

    var template$1s = "<div class=\"component-body\">\r\n\r\n    <div class=\"title\">\r\n        <component-slot data-name=\"name\">TITLE</component-slot>\r\n    </div>\r\n\r\n\r\n    <component-slot data-name=\"group\">\r\n    </component-slot>\r\n\r\n\r\n</div>";

    class RadioButtonGroup extends KsHTMLElement {

        static observedAttributes = [ ... super.observedAttributes, "value"];

        fireevent = true;
        value = -1;
        selectedItem;
        options = [];

        textValue;
        indicatorBox;

        debouncetimer = 0;

        constructor() {
            super();
            this.template = template$1s;
            this.delayedInit = true;
        }

        increase() {

        }

        decrease() {
        }

        clearSelection() {
            this.selectedItem.classList.remove("selected");
            this.selectedItem = null;
            this.value = -1;
        }

        setSelected(index, item = null, fire_event = true) {

            if (this.options[index]) {
                this.options.forEach((aitem, item_index) => {
                    if (item_index != index) {
                        aitem.classList.remove("selected");
                    } else {
                        aitem.classList.add("selected");
                        item = aitem;
                    }
                });

                if (item) {
                    this.selectedItem = item;
                }

                if (fire_event) {
                    this.onUpdate(index, this.value);
                }

                this.value = index;
            }
        }

        bindControls() {
            this.options.forEach((item, item_index) => {
                item.addEventListener("click", (ev) => {
                    if (ev.currentTarget.classList.contains("active")) {
                        this.setSelected(item_index, item);
                    }
                });
                item.addEventListener("sn:enter-down", (ev) => {
                    if (ev.currentTarget.classList.contains("active")) {
                        this.setSelected(item_index, item);
                    }
                });
            });
        }

        updateIndicators() {
            // this.setSelected(this.value);
        }

        initNumberFromAttr(attribute_name) {
            if (this.hasAttribute(attribute_name))
                this[attribute_name] = Number(this.getAttribute(attribute_name));
        }

        attributeChangedCallback(name, oldValue, newValue) {
            if (name == "value") {
                this.value = Number(newValue);
                if (this.setSelected)
                    this.setSelected(this.value, null, false);
                // this.updateIndicators();
            }
        }

        activeOptionCount() {
            let count = qAll(".button.active", this).length;
            return count;
        }

        validateSelected() {
            let selected = q(".button.selected", this);
            let result = true;

            if (selected && !selected.classList.contains("active")) {
                selected.classList.remove("selected");
                result = false;
            }

            result = selected !== null && result;

            return result;
        }

        onUpdate(new_value, old_value) {
            //if (new_value != old_value) {
            clearTimeout(this.debouncetimer);
            this.debouncetimer = setTimeout(
                () => this.dispatchEvent(new CustomEvent('onValueChanged', { detail: { value: new_value, old: old_value, item: this.selectedItem } })),
                25);
            //}
        }

        reApply() {
            this.selectFirstActiveOption();
            this.setSelected(this.value);
        }


        refresh(select_first_if_selection_inactive = false) {
            var found = false;
            this.options.every((item, item_index) => {
                if (!item.classList.contains("active") && item.classList.contains("selected")) {
                    item.classList.remove("selected");
                    found = true;
                }
            });

            if (!this.validateSelected()) ;

            if (select_first_if_selection_inactive && found) {
                this.selectFirstActiveOption();
            }

            return this;
        }

        selectFirstActiveOption() {
            if (!this.validateSelected()) {
                this.options.every((item, item_index) => {
                    if (item.classList.contains("active")) {
                        console.log(this.tagName, this.id, item_index);
                        this.setSelected(item_index);
                        return false;
                    }
                    return true;
                });
            } else {
                console.log(this.tagName, this.id, "already valid", this.value);
            }
            return this;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.updateIndicators();
        }

        onRenderedOnce() {
            super.onRenderedOnce();
            //console.log("radiobutton renderedonce", this.innerHTML);
            this.options = qAllArray("div[slot=group] .button", this);
        }
    }


    ksUI$1.registerModule('ks-radiobuttongroup', RadioButtonGroup);

    var template$1r = "<div class=\"popupselect-body component-body\">\r\n\r\n    \r\n    <div class=\"indicator focusable\">\r\n        <div class=\"title\"><component-slot data-name=\"name\">TITLE</component-slot></div>\r\n        <div class=\"value\">1</div>\r\n    </div>\r\n\r\n    <component-slot data-name=\"open\">\r\n    </component-slot>\r\n\r\n    <component-slot data-name=\"items\">\r\n        <div class=\"group\">\r\n            <div class=\"item\">1</div>\r\n            <div class=\"item\">2</div>\r\n            <div class=\"item\">3</div>\r\n            <div class=\"item\">4</div>\r\n            <div class=\"item\">5</div>\r\n        </div>\r\n        <div class=\"group\">\r\n            <div class=\"item\">1</div>\r\n            <div class=\"item\">2</div>\r\n            <div class=\"item\">3</div>\r\n        </div>\r\n    </component-slot>\r\n\r\n</div>";

    class PopUpSelect extends KsHTMLElement {

        static observedAttributes = [ ... super.observedAttributes, "value"];

        hoverEvents = "mouseenter focus";

        remainopen = false;
        fireevent = true;
        value = 0;
        storedvalue;

        textValue;
        indicatorBox;
        openLabelBox;

        debouncetimer = 0;
        items;

        constructor() {
            super();
            this.template = template$1r;
            this.delayedInit = true;
            this._bindScrollableEvents = true;
        }

        get selectedItem() {
            return q(".item.selected", this);
        }

        setSelectedIndex(index) {
            const allitems = this.getItems();
            allitems.forEach(i => i.classList.remove("selected"));
            allitems[index].classList.add("selected");
            this.updateIndicator();
        }

        increase() {

        }

        decrease() {

        }

        isShowing() {
            return this.classList.contains("show");
        }

        show() {
            let fire_event = (!this.classList.contains("show") && this.fireevent);
            this.classList.add("show");
            
            if (this.selectedItem) {
                this.selectedItem.focus();
                this.storedvalue = this.selectedItem.value;
            } else if (this.openLabelBox) {
                this.openLabelBox.focus();
            }
            if (fire_event)
                this.dispatchEvent(new CustomEvent('onVisibilityChange', { detail: { visible: true } }));

            this.onShow();
            return this;
        }

        onShow = () => {

        };

        hide() {
            let fire_event = this.classList.contains("show") && this.fireevent;
            this.classList.remove("show");

            if (this.openLabelBox) {
                this.indicatorBox.focus();
            }

            if (fire_event)
                this.dispatchEvent(new CustomEvent('onVisibilityChange', { detail: { visible: false } }));
            return this;
        }

        setValue(val, fire_event = true) {

        }

        bindItems() {
            //$.qrevAll("div[slot=items] .item", "mouseenter", this.onItemHovered, this);
            //$.qrevAll("div[slot=items] .item", "click", this.onItemClicked, this);

            qevAll("div[slot=items] .item", this.hoverEvents, (ev) => { if (this.fireevent) this.onItemHovered(ev); }, this);
            qevAll("div[slot=items] .item", "click sn:enter-down", this.onItemClicked, this);

            qev("div[slot=items]", "mouseleave", this.onItemsLeave, this);

            return this;
        }

        updateIndicator() {
            let selected_item = q(".item.selected", this);

            if (selected_item && this.textValue) {
                this.textValue.innerHTML = selected_item.innerHTML;
            }

            return this;
        }

        onItemClicked(event) {
            let p = event.currentTarget.closest("ks-popupselect");
            // console.log(event.currentTarget.parentNode.parentNode.parentNode.parentNode.tagName);
            p.getItems().forEach(element => {
                if (event.currentTarget != element || p.remainopen) {
                    element.classList.remove("selected");
                }
            });

            if (!p.remainopen) {
                waitForFrames(() => p.hide(), 1);
            } else {
                if (event.currentTarget.classList.contains("selected") && !p.remainopen) {
                    waitForFrames(() => p.hide(), 1);
                }
            }

            event.currentTarget.classList.add("selected");
            p.dispatchEvent(new CustomEvent('onItemClicked', { detail: { item: event.currentTarget, value: event.currentTarget.value, old: p.storedvalue } }));
            p.storedvalue = event.currentTarget.value;
        }

        onItemHovered(event) {

        }

        onItemsLeave(event) {

        }

        bindControls() {
            this.indicatorBox.addEventListener("click", (e) => {
                if (this.remainopen) return;
                this.isShowing() ? this.hide() : this.show();
            });

            this.indicatorBox.addEventListener("sn:enter-down", (e) => {
                if (this.remainopen) return;
                this.isShowing() ? this.hide() : this.show();
            });

            if (this.openLabelBox) {
                this.openLabelBox.addEventListener("click", (e) => {
                    if (this.remainopen) return;
                    this.isShowing() ? this.hide() : this.show();
                });
                this.openLabelBox.addEventListener("sn:enter-down", (e) => {
                    if (this.remainopen) return;
                    this.isShowing() ? this.hide() : this.show();
                });

            }

            q("div[slot=items] .group", this).addEventListener("wheel", (e) => {
                e.currentTarget.scrollTop -= e.deltaY * 100;
            });
        }


        getItems() {
            this.items = qAllArray("div[slot=items] .item", this);
            return this.items;
        }

        initNumberFromAttr(attribute_name) {
            if (this.hasAttribute(attribute_name))
                this[attribute_name] = Number(this.getAttribute(attribute_name));
        }

        attributeChangedCallback(name, oldValue, newValue) {

            if (name == "value") {
                this.value = Number(newValue);
                if (this.items[this.value]) {
                    this.items.forEach(element => {
                        element.classList.remove("selected");
                    });
                    this.items[this.value].classList.add("selected");
                }
                this.updateIndicator();
            }
        }


        onUpdate(new_value, old_value) {
            if (new_value != old_value) {
                clearTimeout(this.debouncetimer);
                this.debouncetimer = setTimeout(
                    () => this.dispatchEvent(new CustomEvent('onValueChanged', { detail: { value: new_value, old: old_value } })),
                    100);
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.remainopen = this.classList.contains("remain-open");

            this.textValue = q(".indicator .value", this);
            this.indicatorBox = q(".indicator", this);
            this.openLabelBox = q("div[slot=open]", this);
            this.items = qAllArray("div[slot=items] .item", this);

            this.updateIndicator();
        }
    }


    ksUI$1.registerModule('ks-popupselect', PopUpSelect);

    var template$1q = "<div class=\"component-body\">\r\n\r\n\r\n\r\n    <div class=\"current-color\">\r\n        <div class=\"indicator\"><div></div></div>\r\n    </div>\r\n\r\n    <div class=\"color-fields\">\r\n        <div class=\"group rgb\">\r\n            <ks-numericfield id=\"rgb_r\" min=\"0\" max=\"255\" step=\"1\" decimals=\"0\">\r\n                <div slot=\"name\">R</div>\r\n            </ks-numericfield>\r\n            <ks-numericfield id=\"rgb_g\" min=\"0\" max=\"255\" step=\"1\" decimals=\"0\">\r\n                <div slot=\"name\">G</div>\r\n            </ks-numericfield>\r\n            <ks-numericfield id=\"rgb_b\" min=\"0\" max=\"255\" step=\"1\" decimals=\"0\">\r\n                <div slot=\"name\">B</div>\r\n            </ks-numericfield>\r\n        </div>\r\n<!-- \r\n        <div class=\"group hsb\">\r\n            <ks-numericfield min=\"0\" max=\"100\" step=\"1\" decimals=\"0\">\r\n                <div slot=\"name\">H</div>\r\n            </ks-numericfield>\r\n            <ks-numericfield min=\"0\" max=\"100\" step=\"1\" decimals=\"0\">\r\n                <div slot=\"name\">S</div>\r\n            </ks-numericfield>\r\n            <ks-numericfield min=\"0\" max=\"100\" step=\"1\" decimals=\"0\">\r\n                <div slot=\"name\">B</div>\r\n            </ks-numericfield>\r\n        </div> -->\r\n    </div>\r\n\r\n    <div class=\"swatches\">\r\n        <div class=\"working-color\">\r\n            <div class=\"indicator\"><div></div></div>\r\n            <div class=\"grd white\"></div>\r\n            <div class=\"grd black\"></div>\r\n        </div>\r\n        <div class=\"hue\">\r\n            <div class=\"indicator\"><div></div></div>\r\n        </div>\r\n    </div>\r\n\r\n</div>";

    class ColorPicker extends KsHTMLElement {

        static observedAttributes = [ ... super.observedAttributes, "value"];

        srgbindicator = true;
        fireevent = true;
        value = "#000000";
        displayvalue = "#000000";
        lastvaluereturned = null;
        options = [];

        captureSB = false;
        captureH = false;

        textValue;

        debouncetimer = 0;

        boxWorkingColor;
        boxSwatches;
        indicatorCurrentColor;
        indicatorWorkingColor;
        indicatorHue;

        numericRgbR;
        numericRgbG;
        numericRgbB;

        locked = false;

        H = 0;
        S = 0;
        B = 0;

        refresh() {
            this.setHueIndicator(this.H);
            this.setSBIndicator(this.S, this.B);
        }

        setFromRGB(value) {
            const hsb = ksUI$1.RGB2HSV(value.map(i => i / 255));
            this.setHueIndicator(hsb[0]);
            this.setSBIndicator(hsb[1], hsb[2]);
        }

        set RGB(rgb_array) {
            const hsb = ksUI$1.RGB2HSV(rgb_array);
            // console.log(rgb_array, "/", rgb_array.map(i => i * 255));
            this.H = hsb[0];
            this.S = hsb[1];
            this.B = hsb[2];
            this.refresh();
        }

        get RGB() {
            return ksUI$1.HSV2RGB(this.HSB);
        }

        get HSB() {
            return [this.H, this.S, this.B];
        }

        set HSB(hsb_array) {
            this.H = hsb_array[0];
            this.S = hsb_array[1];
            this.B = hsb_array[2];
            this.refresh();
        }

        get HueCSSValue() {
            const f = [this.H, 1, 1];
            const rgb = ksUI$1.HSV2RGB(f);

            return "rgba(" + rgb.map(v => v * 255).join(",") + ",1)";
        }

        get CSSValue() {
            const rgb = ksUI$1.HSV2RGB(this.HSB);
            return "rgba(" + rgb.map(v => v * 255).join(",") + ",1)";
        }

        constructor() {
            super();
            this.template = template$1q;
            this.delayedInit = true;
        }

        bindControls() {

            if(this.innerHTML == "") return;
            
            this.addEventListener("mousemove", (ev) => {

                if (this.locked) return;

                if (this.captureSB) {
                    //this.getColorFromSB(ev);
                    this.getSB(ev);
                }
                if (this.captureH) {
                    //this.getColorFromH(ev);
                    this.H = this.getH(ev);
                }

                this.indicatorCurrentColor.style.backgroundColor = this.CSSValue;
            });

            this.addEventListener("mouseleave", (ev) => {
                this.captureSB = false;
                this.captureH = false;
            });

            this.addEventListener("mouseup", (ev) => {
                this.captureSB = false;
                this.captureH = false;
            });

            this.boxWorkingColor.addEventListener("mousedown", (ev) => {
                if (this.locked) return;
                this.captureSB = true;
                this.captureH = false;
                this.getSB(ev);
            });

            this.boxWorkingColor.addEventListener("mouseup", (ev) => {
                this.captureSB = false;
            });

            this.boxHue.addEventListener("mousedown", (ev) => {
                if (this.locked) return;
                this.captureH = true;
                this.captureSB = false;
                this.getH(ev);

            });

            this.boxHue.addEventListener("mouseup", (ev) => {
                this.captureH = false;
            });

        }

        getIndicators() {
            this.boxHue.getBoundingClientRect();
            this.boxWorkingColor.getBoundingClientRect();

            this.indicatorHue.getBoundingClientRect();
            this.indicatorWorkingColor.getBoundingClientRect();


            // console.log(this.indicatorHue.style.leftPX, this.indicatorWorkingColor.style.topPX);
        }

        getH(ev) {
            const rect = this.boxHue.getBoundingClientRect();


            let x = ev.x - rect.left;
            if (x < 0) x = 0;
            if (x > rect.width) x = rect.width;

            let hue = ksUI$1.scaleValue(x, 0, rect.width, 0, 359);

            this.H = hue;


            this.setHueIndicator(hue);
            this.onUpdate(this.RGB, this.HSB);

            return hue;
            //this.onUpdate(this.value, oldvalue);
        }

        setHueIndicator(hue) {
            if (!this.boxHue) return;
            const rect = this.boxHue.getBoundingClientRect();
            const indH = this.indicatorHue.getBoundingClientRect();

            const x = ksUI$1.scaleValue(hue, 0, 360, 0, rect.width);
            this.indicatorHue.style.leftPX = x - (indH.width / 2);

            this.boxWorkingColor.style.backgroundColor = this.HueCSSValue;
            this.indicatorCurrentColor.style.backgroundColor = this.CSSValue;
        }

        setSBIndicator(saturation, brightness) {
            if (!this.boxWorkingColor) return;
            const rect = this.boxWorkingColor.getBoundingClientRect();
            const indSB = this.indicatorWorkingColor.getBoundingClientRect();

            const x = ksUI$1.scaleValue(saturation, 0, 1, 0, rect.width);
            const y = ksUI$1.scaleValue(brightness, 0, 1, 0, rect.height);

            // console.warn("> ", x, y);

            this.indicatorWorkingColor.style.leftPX = x - (indSB.width / 2);

            this.indicatorWorkingColor.style.bottomPX = y - (indSB.height / 2);
            this.indicatorCurrentColor.style.backgroundColor = this.CSSValue;
        }


        getSB(ev) {
            let rect = this.boxWorkingColor.getBoundingClientRect();

            let x = ksUI$1.clamp(ev.x - rect.left, 0.001, rect.width);
            let y = ksUI$1.clamp(rect.height - (ev.y - rect.top), 0.001, rect.height);

            

            let saturation = ksUI$1.scaleValue(x, 0, rect.width, 0, 1);
            let brightness = ksUI$1.scaleValue(y, 0, rect.height, 0, 1);

            this.S = saturation;
            this.B = brightness;

            // console.warn(x, y, saturation, brightness);

            this.setSBIndicator(saturation, brightness);

            this.onUpdate(this.RGB, this.HSB);
            return { S: saturation, B: brightness };

        }

        initNumberFromAttr(attribute_name) {
            if (this.hasAttribute(attribute_name))
                this[attribute_name] = Number(this.getAttribute(attribute_name));
        }

        attributeChangedCallback(name, oldValue, newValue) {
            if (name == "value") {

                this.value = newValue;

                if (!this.srgbindicator) {
                    this.displayvalue = this.value;
                } else {
                    //let hsb = ksUI.hexToHSB(this.value);
                    let rgb = ksUI$1.hexToRGB(this.value);

                    let linear = ksUI$1.linearArrToSrgb(rgb);
                    this.displayvalue = "#" + ksUI$1.RGBToHex(Math.round(linear[0] * 255), Math.round(linear[1] * 255), Math.round(linear[2] * 255));

                    //this.displayvalue = "#" + ksUI.HSBToHex(hsb[0], hsb[1], ksUI.linearToSrgb(hsb[2] / 100) * 100);

                }

                //console.log("ATTRIBUTE", this.id, name, newValue);

                this.lastvaluereturned = newValue;

                //$.waitForFrames(() => {
                // this.updateIndicators();
                //});
            }
        }

        activeOptionCount() {
            let count = qAll(".button.active", this).length;
            return count;
        }

        validateSelected() {

        }

        onUpdate(rgb_value, hsb_value) {

            this.dispatchEvent(new CustomEvent('onValueChanged',
                {
                    detail: {
                        rgb: rgb_value,
                        hsb: hsb_value
                    }
                }));
        }


        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.srgbindicator = this.classList.contains("srgb");

            this.indicatorCurrentColor = q(".current-color .indicator", this);
            this.numericRgbR = q("#rgb_r", this);
            this.numericRgbG = q("#rgb_g", this);
            this.numericRgbB = q("#rgb_b", this);

            this.indicatorWorkingColor = q(".working-color .indicator", this);
            this.boxWorkingColor = q(".working-color", this);

            this.indicatorHue = q(".hue .indicator", this);
            this.boxHue = q(".hue", this);

            this.boxSwatches = q(".swatches", this);

            this.refresh();
        }
    }


    ksUI$1.registerModule('ks-colorpicker', ColorPicker);

    class ListWrapper {
        list = [];
        byname = {};
    }

    class CarCustomizationManager extends BaseManager {

        debug = false;

        Client = new MessageHandler("CarCustomization");

        FinalCar;

        /** @type ListWrapper */
        AllMaterials;

        /** @type ListWrapper */
        Rims;

        /** @type ListWrapper */
        Parts;

        PartTypes = [];

        /** @type Set */
        PartKits;

        /** @type ListWrapper */
        Designs;

        ChannelPresets;

        constructor(parent_element) {
            super(null, parent_element);
            this.resetFilters();
            this.updateDataFilters();
            this.resetData();
        }

        initialize(car_key = "") {
            return new Promise((resolve, reject) => {
                this.beforeInitialize();

                console.log("CarCustomizationManager initializing", car_key);

                this.resetData();

                this.loadFinalCar(car_key).then(final_car_data => {
                    this.processFinalCar(final_car_data);
                    resolve(final_car_data);
                    this.onInitialize(final_car_data);
                }).catch(final_car_data => {
                    reject(final_car_data);
                }).finally(final_car_data => {
                    this.afterInitialize(final_car_data);
                });
            });

        }

        beforeInitialize = () => { };

        onInitialize = () => { };

        afterInitialize = () => { };

        resetData() {
            this.FinalCar = {};
            this.AllMaterials = new ListWrapper();
            this.Rims = new ListWrapper();
            this.Parts = new ListWrapper();
            this.PartKits = new Set();

            this._dataFilters.Location = eCarCustomization.MaterialLocation.Exterior;
            this._dataFilters.PartCategory = eCarCustomization.PartCategory.Bodywork;
        }

        updateDataFilters() {
            this.assignModel(this._dataFilters, "CarCustomizationFilters");
        }

        evaluateMaterial(material) {
            let result = true;

            function checkRules(rules) {
                let rules_result = false;
                if (rules.is_channel_customizable) {
                    Object.keys(rules).forEach(key => {
                        const value = rules[key];
                        if (typeof value == "boolean" && key != "is_channel_customizable") {

                            rules_result = rules_result || value;
                            console.log(key, value, rules_result);
                        }
                    });
                }
                return rules_result;
            }

            if (material.material_type == eCarCustomization.MaterialTypes.Multi) {
                const not_enough_oemcolors = material.channels.oem_colors.length <= 1;

                let result = false;
                result = result || checkRules(material.channels.primary_channel_rules);
                result = result || checkRules(material.channels.secondary_channel_rules);
                result = result || checkRules(material.channels.tertiary_channel_rules);

                result = result && not_enough_oemcolors;
            }
            return result;
        }

        getMaterials(part_category, part_location = eCarCustomization.MaterialLocation.Exterior) {

            const output = [];
            this.AllMaterials.list.forEach(material => {

                if (material.is_pointless) return true;
                if (material.material_category == part_category) {

                    let existing_material_of_same_description = output.find(m => material.description === m.description);

                    if (existing_material_of_same_description) {
                        existing_material_of_same_description.update_as_group = true;
                        material.update_as_group = true;
                    }

                    if (material.material_category == eCarCustomization.PartCategory.Bodywork &&
                        material.material_location == part_location) {
                        output.push(material);
                    } else if (material.material_category != eCarCustomization.PartCategory.Bodywork) {
                        output.push(material);
                    }
                }
            });

            return output.sort((a, b) => {
                if (a.material_index < b.material_index) {
                    return -1
                } else if (a.material_index < b.material_index) {
                    return 1;
                }
                return 0;
            });//.reverse();

        }

        get MaterialCounts() {
            let output = {
                bodywork_exterior: 0,
                bodywork_interior: 0,
                rims: 0
            };

            this.AllMaterials.list.forEach(material => {
                if (material.material_category == eCarCustomization.PartCategory.Bodywork) {
                    material.material_location == eCarCustomization.MaterialLocation.Exterior ?
                        output.bodywork_exterior++ : output.bodywork_interior++;
                }
                if (material.material_category == eCarCustomization.PartCategory.Rims) {
                    output.rims++;
                }
            });

            return output;
        }

        get FilteredMaterials() {
            return this.getMaterials(this.PartCategory, this.Location);
        }

        /** @param {string} material_description */
        getMaterialL10nid(material_description) {
            return material_description.replaceAll(" ", "_");
        }

        get installedRim() {
            return this.Rims.list.find(rim => rim.is_installed);
        }

        get installedRimDesign() {
            return this.installedRim.designs.find(design => design.is_installed);
        }

        get installedRimDesignKey() {
            return installedRimDesign.item.key;
        }

        get PartCategory() {
            return this.dataFilters.PartCategory;
        }

        set PartCategory(category) {
            this.dataFilters.PartCategory = category;
        }

        get Location() {
            return this.dataFilters.Location;
        }

        set Location(material_location) {
            this.dataFilters.Location = material_location;
        }

        get ActiveMech() {
            return this.FinalCar.mechanical_presets.find(mech =>
                mech.item.key == this.FinalCar.selection.selected_mechanical_path
            );
        }

        get ActiveVisual() {
            return this.ActiveMech.visual_presets.find(visual =>
                visual.item.key == this.FinalCar.selection.selected_visual_path
            );
        }

        get IsVisualCustomizable() {
            return this.ActiveVisual.is_channel_customizable;
        }

        setCarNumber(new_car_number) {
                return new Promise((resolve, reject) => {
                this.newHandler = this.Client.request("UpdateCarNumber",
                    { new_car_number: new_car_number },
                    (data) => {
                        if (data.response == eCarCustomization.Response.OK) {
                            console.log("setCarNumber", data.car_number);
                            resolve(data);
                        } else {
                            reject(data);
                        }
                    });
            });
        }

        getCompounds(rim_path = this.installedRim.part_path) {
            return new Promise((resolve, reject) => {
                this.newHandler = this.Client.request("ListTyreCompounds",
                    { compatible_rim_path: rim_path },
                    (data) => {
                        if (data.response == eCarCustomization.Response.OK) {
                            resolve(data);
                        } else {
                            reject(data);
                        }
                    });
            });
        }

        getFromPartList(list_wrapper, part_path) {
            return list_wrapper.list.find(part =>
                part.part_path == part_path
            );
        }

        setUniqueInstalled(list_wrapper, installed_part) {
            list_wrapper.forEach(item =>
                item.is_installed = item == installed_part
            );
        }

        selectDesign(key, category, part_path = "") {
            return new Promise((resolve, reject) => {
                console.log("selectDesign", "key:", key, "category:", category, "part_part:", part_path);
                this.newHandler = this.Client.request("SelectDesign",
                    {
                        key: key,
                        category: category,
                        part_path: part_path
                    },
                    (data) => {
                        if (data.response == eCarCustomization.Response.OK) {
                            resolve(data);
                        } else {
                            reject(data);
                        }
                    });
            });
        }

        selectVisual(preset) {
            this.selectDesign(preset, eCarCustomization.PartCategory.Bodywork, "").then(data => {
                console.log("Selected visual preset", preset);
            });
        }

        selectMech(preset) {
            return new Promise((resolve, reject) => {
                this.newHandler = this.Client.request("SelectMechanicalPreset",
                    {
                        key: preset
                    },
                    (data) => {
                        if (data.response == eCarCustomization.Response.OK) {
                            console.log("Selected mech preset", preset);
                            resolve(data);
                        } else {
                            reject(data);
                        }
                    });
            });
        }

        loadFinalCar(name = "", is_original = false) {

            //if(name != "") is_original = true;

            return new Promise((resolve, reject) => {

                this.newHandler = this.Client.request("LoadFinalCar",
                    {
                        key: name,
                        is_original: is_original
                    },
                    (data) => {
                        if (data.response == eCarCustomization.Response.OK) {
                            console.log("LoadFinalCar", name == "" ? "CURRENTLY VISIBLE" : name, "- is_original:", is_original);
                            console.trace(data);
                            resolve(data);
                        } else {
                            console.error("loadFinalCar failed", name, is_original);
                            reject(data);
                        }
                    });


            });
        }

        saveFinalCar(name) {
            return new Promise((resolve, reject) => {

                this.newHandler = this.Client.request("UpdateCurrentFinalCar",
                    { car_final_state_name: name }, (data) => {
                        ({
                            [eCarCustomization.Response.OK]: () => {
                                console.trace(data);
                                resolve(data);
                                engine.trigger(EngineEvents.PaintShop.CarSaved);
                            },
                            [eCarCustomization.Response.CRITICAL_ERROR]: () => {
                                reject(data);
                            }
                        }[data.response])();
                    });

            });
        }

        getChannelPresets() {
            return new Promise((resolve, reject) => {
                this.newHandler = this.Client.request("ChannelPresetList", (data) => {
                    if (data.response == eCarCustomization.Response.OK) {
                        data.channel_presets.unshift({ key: "Custom", description: "Custom" });
                        resolve(data);
                    } else {
                        console.warn("Failed to get channel presets");
                        reject(data);
                    }
                });
            });
        }

        reset(car_key = "", is_original = false) {
            return new Promise((resolve, reject) => {
                //this.loadFinalCar(car_key, is_original).then(() => {
                this.initialize(car_key).then(() => {
                    if (this.AllMaterials.list.length > 0) {
                        this.updateMaterial(this.AllMaterials.list[0]);
                        resolve();
                    } else {
                        resolve();
                    }
                }).catch(() => reject());
                //}).catch(() => reject());

            });
        }

        async refreshMaterials(part_or_rim_or_category, replace_existing = true) {
            return new Promise((resolve, reject) => {

                /** default to Bodywork if no part_or_rim defined */

                const is_category = typeof part_or_rim_or_category == "string";

                const category =
                    is_category ? part_or_rim_or_category :
                        part_or_rim_or_category ?
                            part_or_rim_or_category.__Type ==
                                "CarCustomizationRimItem" ? eCarCustomization.PartCategory.Rims : eCarCustomization.PartCategory.Parts
                            : eCarCustomization.PartCategory.Bodywork;

                if (this.debug)
                    console.warn("refreshMaterials", category);

                //if (this.debug) return;
                const part_path = part_or_rim_or_category && !is_category ? part_or_rim_or_category.key : "";

                const part_market = part_or_rim_or_category && !is_category ? part_or_rim_or_category.part_market : "";

                const grabMaterials = async (list, category, part_path, part_market) => {
                    [eCarCustomization.MaterialTypes.Multi, eCarCustomization.MaterialTypes.Single].forEach(material_type => {
                        (material_type == eCarCustomization.MaterialTypes.Multi ? list.multilayers : list.singlelayers)
                            .forEach(material => {
                                if (this.debug)
                                    console.warn(material.material_index, material_type, category, part_path, material.description);

                                this.getMaterial(material.material_index, material_type, category, part_path)
                                    .then(
                                        ksUI$1.fromPromise(
                                            (material_data, material_index, category, part_path) => {
                                                const newmaterial = {
                                                    ...material,
                                                    l10nid: this.getMaterialL10nid(material.display == "" ? this.FinalCar.car_model_name + "_" + material.description : material.display),
                                                    material_category: category,
                                                    material_location: eCarCustomization.MaterialLocation.fromMaterial(material),
                                                    material_type: material_type,
                                                    part_path: part_path,
                                                    part_market: part_market,
                                                    channels: material_data
                                                };

                                                engine.translate(newmaterial.l10nid);
                                                //this.AllMaterials.byname[newmaterial.l10nid] = newmaterial;
                                                if (replace_existing) {
                                                    console.log("Adding material", material.description);
                                                    this.AllMaterials.list.push(newmaterial);
                                                } else {
                                                    let existing_material = this.AllMaterials.list.find(material_to_change =>
                                                        material_to_change.material_category == category &&
                                                        material_to_change.material_index == newmaterial.material_index &&
                                                        material_to_change.material_type == newmaterial.material_type
                                                    );

                                                    existing_material = { ...newmaterial };
                                                    engine.trigger(EngineEvents.PaintShop.MaterialRefreshed, existing_material);
                                                }
                                            }
                                        )
                                    ).catch(reason => {
                                        console.error("Failed to get material", reason, material.material_index);

                                    });
                            });
                    });

                };


                if (this.debug) console.log("Refreshing materials", category, part_path, part_market);


                if (replace_existing) {
                    for (let i = 0; i < this.AllMaterials.list.length; i++) {
                        const material = this.AllMaterials.list[i];
                        if (category == eCarCustomization.PartCategory.Rims) {
                            if (material.material_category == category) {
                                console.log("Deleting material", material.description);
                                this.AllMaterials.list.splice(i, 1);
                                i--;
                            }
                        } else if (category == eCarCustomization.PartCategory.Parts && material.part_path == part_path) {
                            console.log("Deleting material", material.description);
                            this.AllMaterials.list.splice(i, 1);
                            i--;
                        }
                    }
                }


                // 

                if (this.debug) {
                    console.warn(">>", category, part_path);
                    //return;
                }

                if (part_path || category != eCarCustomization.PartCategory.Parts)
                    this.getMaterialList(category, part_path).then(result => {

                        grabMaterials(result.data.material_list, category, part_path, part_market);
                    }).catch(reason => {
                        console.error("Failed to grab material list");
                    });

                    if(this.debug) {
                        console.log("Refreshed materials", category, part_path, part_market);
                    }
                resolve();
            });
        }

        processFinalCar(final_car_data) {

            this.resetData();

            this.FinalCar = final_car_data;

            const grabMaterials = (list, category, part_path, part_market) => {
                [eCarCustomization.MaterialTypes.Multi, eCarCustomization.MaterialTypes.Single].forEach(material_type => {
                    (material_type == eCarCustomization.MaterialTypes.Multi ? list.multilayers : list.singlelayers)
                        .forEach(material => {

                            this.getMaterial(material.material_index, material_type, category, part_path).then(
                                ksUI$1.fromPromise(
                                    (material_data, material_index, category, part_path) => {
                                        const newmaterial = {
                                            ...material,
                                            l10nid: this.getMaterialL10nid(material.display == "" ? final_car_data.car_model_name + "_" + material.description : material.display),
                                            material_category: category,
                                            material_location: eCarCustomization.MaterialLocation.fromMaterial(material),
                                            material_type: material_type,
                                            part_path: part_path,
                                            part_market: part_market,
                                            channels: material_data
                                        };

                                        engine.translate(newmaterial.l10nid);

                                        this.AllMaterials.list.push(newmaterial);

                                        //this.AllMaterials.byname[newmaterial.l10nid] = newmaterial;
                                    }
                                )
                            );
                        });
                });

            };

            const assignPart = (part, part_market) => {

                let new_part = {
                    ...part,
                    description: part.kits[0] ? part.kits[0] : part.item.description,
                    key: part.item.key,
                    part_path: part.item.key,
                    part_market: part_market
                };

                const part_type = this.PartTypes.find(item =>
                    item.name == new_part.part_type
                );

                if (part_type) {
                    part_type.count++;
                }
                else {
                    this.PartTypes.push({ name: new_part.part_type, count: 1 });
                }

                if (part.kits[0]) {
                    if (!this.PartKits.has(part.kits[0])) {
                        this.PartKits.add(part.kits[0]);
                        //new_part.part_path = new_part.part_path.replace("lf.compatiblepart", "lr.compatiblepart");
                        this.Parts.list.push(new_part);
                        this.Parts.byname[new_part.description.replaceAll(" ", "_")] = new_part;
                    }
                } else {
                    this.Parts.list.push(new_part);
                    this.Parts.byname[new_part.description.replaceAll(" ", "_")] = new_part;
                }
            };

            const assignRim = (rim, part_market) => {
                const new_rim = {
                    ...rim,
                    key: rim.item.key,
                    description: rim.item.description,
                    part_path: rim.item.key,
                    part_market: part_market,
                    is_installed: rim.item.key == final_car_data.selection.selected_compatible_rim_path
                };
                new_rim.designs.forEach(rim_design => {

                });
                this.Rims.list.push(new_rim);
                this.Rims.byname[new_rim.item.description] = new_rim;
            };

            grabMaterials(final_car_data.bodywork_material_list,
                eCarCustomization.PartCategory.Bodywork, "");

            grabMaterials(final_car_data.rim_material_list,
                eCarCustomization.PartCategory.Rims, "");

            final_car_data.oem_parts.forEach(part => {

                assignPart(part, eCarCustomization.PartType.Oem);

                final_car_data.part_material_list.forEach(part_material => {
                    if (part_material.key == part.item.key) {
                        grabMaterials(part_material,
                            eCarCustomization.PartCategory.Parts, part.item.key, eCarCustomization.PartType.Oem);
                    }
                });
            });

            final_car_data.aftermarket_parts.forEach(part => {

                assignPart(part, eCarCustomization.PartType.Aftermarket);

                final_car_data.part_material_list.forEach(part_material => {
                    if (part_material.key == part.item.key) {
                        grabMaterials(part_material,
                            eCarCustomization.PartCategory.Parts, part.item.key, eCarCustomization.PartType.Oem);
                    }
                });
            });

            final_car_data.oem_rims.forEach(rim => {
                assignRim(rim, eCarCustomization.PartType.Oem);
            });

            final_car_data.aftermarket_rims.forEach(rim => {
                assignRim(rim, eCarCustomization.PartType.Aftermarket);
            });

            final_car_data.mechanical_presets.forEach(mech_preset => {
                const mechid = this.getLocId(mech_preset.item.description, true);
                engine.translate(mechid);

                mech_preset.visual_presets.forEach(visual_preset => {
                    const visualid = this.getLocId(visual_preset.item.description, true);
                    engine.translate(visualid);
                });
            });

            this.getChannelPresets()
                .then(data => this.ChannelPresets = data)
                .catch(data => this.ChannelPresets = undefined);

        }

        getIncompatibleParts(part) {

            let incompatible_items = [];

            if (part.__Type == eCarCustomization.ItemType.Part) {
                incompatible_items = [...incompatible_items, ... this.Parts.list.filter(item =>
                    part.not_allowed_part_paths.indexOf(item.original_part_path) > -1
                )];

                incompatible_items = [...incompatible_items, ... this.Rims.list.filter(item =>
                    part.not_compatible_rim_paths.indexOf(item.part_path) > -1
                )];
            }

            if (part.__Type == eCarCustomization.ItemType.Rim) {
                incompatible_items = [...incompatible_items, ... this.Parts.list.filter(item =>
                    item.not_compatible_rim_paths.indexOf(part.part_path) > -1
                )];
            }

            return incompatible_items;
        }

        getIncompatibleRims(part) {
            return this.Rims.list.filter(item =>
                part.not_compatible_rim_paths.indexOf(item.part_path) > -1
            );
        }

        getTranslation(item_description, with_modelname_prefix) {
            return engine.translate(this.getLocId(item_description, with_modelname_prefix));
        }

        getLocId(item_description, with_modelname_prefix) {
            return (with_modelname_prefix ? this.FinalCar.car_model_name + "_" : "")
                + item_description.toLowerCase().replace(/[\W_]+/g, "_");
        }

        pendingRim = ""

        installRim(target, rim_design) {
            return new Promise((resolve, reject) => {

                let part_path = target;

                if (typeof target == "object") {
                    part_path = target.part_path;
                }

                this.pendingRim = part_path;

                const part_ref = this.getFromPartList(this.Rims, part_path);

                // console.log(part_path);
                console.log("Installing rim", part_path);

                if (part_ref) {

                    this.newHandler = this.Client.request("SelectRim", { key: part_path }, (data) => {
                        if (data.response == eCarCustomization.Response.OK) {
                            console.log("Installed rim", part_path);
                            if (this.pendingRim != part_path) {
                                reject();
                                return;
                            }
                            this.setUniqueInstalled(this.Rims.list, part_ref);

                            if (rim_design) {
                                this.setRimDesign(rim_design);
                                
                            } else {
                                const found = part_ref.designs.find(design => 
                                    design.item.key == data.selection.selected_rim_design_path
                                );
                                
                                console.warn("FOUND", found);
                                
                                if (found) {
                                    this.setUniqueInstalled(part_ref.designs, found);
                                } else if(part_ref.designs[0]) {
                                    this.setUniqueInstalled(part_ref.designs, part_ref.designs[0]);
                                }
                            }

                            engine.trigger(EngineEvents.PaintShop.RimInstalled);

                            resolve();
                            this.pendingRim = "";
                        } else {
                            console.error("Could not toggle", part_path);
                            reject();
                            this.pendingRim = "";
                        }
                    });
                } else {
                    console.log("did not find part");
                    reject();
                    this.pendingRim = "";
                }

            });
        }

        pendingRimDesign = "";

        setRimDesign(rim_design) {
            return new Promise((resolve, reject) => {
                let design_path = rim_design;

                if (typeof rim_design == "object") {
                    design_path = rim_design.item.key;
                }

                this.pendingRimDesign = design_path;

                console.log("Selecting rim design", design_path);

                this.selectDesign(design_path, eCarCustomization.PartCategory.Rims, "")
                    .then(data => {
                        console.log("Selected rim design", design_path);
                        if (this.pendingRimDesign != design_path) {
                            reject();
                            return;
                        }
                        this.setUniqueInstalled(this.installedRim.designs, rim_design);
                        engine.trigger(EngineEvents.PaintShop.RimDesignSelected);
                        resolve();
                        this.pendingRimDesign = "";
                    }).catch(data => {
                        reject(data);
                        this.pendingRimDesign = "";
                    });
            });
        }

        installPart(target, part_design) {


            this.togglePart(target, true).then(data => {
                if (part_design) {
                    this.setPartDesign(target, part_design);
                }
            });
        }

        removePart(target) {
            this.togglePart(target, false);
        }

        setPartDesign(part, part_design) {
            return new Promise((resolve, reject) => {
                let part_path = part;
                let design_path = part_design;

                if (typeof part_design == "object") {
                    design_path = part_design.item.key;
                }

                if (typeof part == "object") {
                    part_path = part.part_path;
                }

                const part_ref = this.getFromPartList(this.Parts, part_path);
                const design_ref = part_ref.designs.find(design => design.item.key == design_path);

                this.selectDesign(design_path, eCarCustomization.PartCategory.Parts, part_path)
                    .then(data => {
                        this.setUniqueInstalled(part_ref.designs, design_ref);
                        console.log("Selected part design", design_path, "for part", part_path);
                        resolve(data);
                    }).catch(data => {
                        reject(data);
                    });
            })
        }

        pendingPart = "";

        togglePart(target, installed) {

            let part_path = target;

            if (typeof target == "object") {
                part_path = target.part_path;
            }

            const part_ref = this.getFromPartList(this.Parts, part_path);

            return new Promise((resolve, reject) => {

                this.pendingPart = part_path;

                const toggler = () => {
                    this.newHandler = this.Client.request("TogglePart", { key: part_path }, (data) => {
                        if (data.response == eCarCustomization.Response.OK) {
                            if (this.pendingPart != part_path) {
                                reject();
                                return;
                            }
                            part_ref.is_installed = !part_ref.is_installed;
                            resolve(data);
                            this.pendingPart = "";
                            part_ref.is_installed = installed;
                            engine.trigger(EngineEvents.PaintShop.PartToggled, part_ref, installed);
                        } else {
                            console.error("Could not toggle", part_path);
                            reject(data);
                            this.pendingPart = "";
                        }
                    });
                };

                if (part_ref) {

                    if (typeof installed == 'boolean') {
                        if ((!part_ref.is_installed && installed) ||
                            (part_ref.is_installed && !installed)) {
                            toggler();
                        } else {
                            resolve("Same state");
                        }
                    } else {
                        toggler();
                    }
                } else {
                    reject("Not found");
                }

            });
        }

        get CurrentParts() {
            return this.Parts.list.filter(part => part.is_installed);
        }

        toggleMaterial(material, state) {
            return new Promise((resolve, reject) => {

                const options = {
                    is_multilayer: material.material_type == eCarCustomization.MaterialTypes.Multi,
                    material_index: material.material_index,
                    category: material.material_category,
                    part_path: material.part_path,
                    value: state
                };

                if (this.debug)
                    ksUI$1.iterate(options);


                this.newHandler = this.Client.request("ToggleMaterial", options, (data) => {
                    if (data.response == eCarCustomization.Response.OK) {
                        resolve(data);
                        material.channels.is_enabled = state;

                        this.refreshMaterials(material.material_category, false);
                        engine.trigger(EngineEvents.PaintShop.MaterialToggled, material, state);
                    } else {
                        reject(data);
                    }
                });
            });
        }

        updateMaterial(material) {

            engine.trigger(EngineEvents.PaintShop.MaterialUpdate, true);

            return new Promise((resolve, reject) => {

                let updateRequest = eCarCustomization.ChannelUpdateRequest.fromMaterial(material);

                let options = {
                    material_index: material.material_index,
                    category: material.material_category,
                    part_path: material.part_path
                };

                options =
                    ((updateRequest == eCarCustomization.ChannelUpdateRequest.Multi) ?
                        {
                            ...options,
                            primary_channel: material.channels.primary_channel_state,
                            secondary_channel: material.channels.secondary_channel_state,
                            tertiary_channel: material.channels.tertiary_channel_state,
                        } :
                        {
                            ...options,
                            channel: material.channels.channel_state
                        });

                let finaloptions = {};
                Object.assign(finaloptions, options);

                if (this.debug) console.log(updateRequest, material.material_index, material.material_category, material.part_path);
                if (this.debug) console.log(JSON.stringify(finaloptions));



                this.newHandler = this.Client.request(
                    updateRequest,
                    finaloptions,
                    (data) => {
                        if (data.response == eCarCustomization.Response.OK) {
                            //ksUI.iterate(data);
                            engine.trigger(EngineEvents.PaintShop.MaterialUpdate, false);
                            resolve(data);
                        } else {
                            engine.trigger(EngineEvents.PaintShop.MaterialUpdate, false);
                            reject(data);
                        }
                    });
            });
        }

        getMaterialList(category = eCarCustomization.PartCategory.Bodywork, part_path = "") {

            // console.log("getMaterialList", category, part_path);

            return new Promise((resolve, reject) => {
                this.newHandler = this.Client.request("MaterialList",
                    {
                        category: category,
                        part_path: part_path
                    },
                    (data) => {
                        if (data.response == eCarCustomization.Response.OK) {
                            resolve({ data: data, category: category, part_path: part_path });
                        } else {
                            console.error("CarCustomizationManager", "getMaterialList error");
                            reject([data, category, part_path]);
                        }
                    });
            });
        }

        getMaterial(material_index, material_type, category, part_path) {
            if (this.debug) console.warn("getMaterial", eCarCustomization.RequestMaterialType.fromType(material_type), material_index, category, part_path);
            return new Promise((resolve, reject) => {
                this.newHandler = this.Client.request(eCarCustomization.RequestMaterialType.fromType(material_type),
                    { material_index: material_index, category: category, part_path: part_path },
                    (data) => {
                        {
                            resolve([data, material_index, category, part_path]);
                        }
                    });
            });
        }


    }

    var template$1p = "<div class=\"materialeditor-body component-body\">\r\n\r\n    <div class=\"label focusable\">\r\n        <div class=\"indicator\"></div>\r\n        <div class=\"expansion\">...</div>\r\n        <div class=\"dirty\"></div>\r\n        <div class=\"name\"></div>\r\n    </div>\r\n\r\n    <div class=\"material-controls\">\r\n\r\n        <ks-radiobuttongroup id=\"materialenable\" class=\"focusable toggle notitle fullheight\">\r\n            <div slot=\"name\" data-l10n-id=\"lblEnabledUpper\">ENABLED</div>\r\n            <div slot=\"group\">\r\n                <div class=\"mode button active\" id=\"mode_oem\" data-l10n-id=\"lblOnUpper\">ON</div>\r\n                <div class=\"mode button active\" id=\"mode_custom\" data-l10n-id=\"lblOffUpper\">OFF</div>\r\n            </div>\r\n        </ks-radiobuttongroup>\r\n\r\n        <ks-radiobuttongroup id=\"channels\" class=\"focusable fullheight\">\r\n            <div slot=\"name\" data-l10n-id=\"lblSegmentUpper\">SEGMENT</div>\r\n            <div slot=\"group\">\r\n                <div class=\"channel button\" id=\"primary_channel\">1</div>\r\n                <div class=\"channel button\" id=\"secondary_channel\">2</div>\r\n                <div class=\"channel button\" id=\"tertiary_channel\">3</div>\r\n            </div>\r\n        </ks-radiobuttongroup>\r\n\r\n        <ks-btnbasic>\r\n            <div slot=\"name\" data-l10n-id=\"lblCustom\">CUSTOM</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-radiobuttongroup id=\"channelmode\" class=\"focusable toggle fullheight\">\r\n            <div slot=\"name\" data-l10n-id=\"lblMode\">MODE</div>\r\n            <div slot=\"group\">\r\n                <div class=\"mode button active\" id=\"mode_oem\" data-l10n-id=\"lblOEM\">OEM</div>\r\n                <div class=\"mode button active\" id=\"mode_custom\" data-l10n-id=\"lblCustom\">CUSTOM</div>\r\n            </div>\r\n        </ks-radiobuttongroup>\r\n\r\n        <ks-popupselect id=\"oemcolors\" class=\"inline multi-row remain-open\">\r\n            <div slot=\"name\" data-l10n-id=\"lblColor\"></div>\r\n            <div slot=\"open\" class=\"focusable\">\r\n                <div class=\"title\" data-l10n-id=\"lblManufacturerColors\">MANUFACTURER COLORS</div>\r\n            </div>\r\n            <div slot=\"items\">\r\n                <div class=\"group scrollable-vertical\">\r\n                    <div class=\"scrollable-content\">\r\n                        <div class=\"item\">\r\n                            <div class=\"color-tile\"></div>\r\n                            <div class=\"description\"></div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n                <div class=\"color-name\" data-l10n-id=\"lblColorName\">Color Name</div>\r\n            </div>\r\n        </ks-popupselect>\r\n\r\n        <ks-colorpicker id=\"maincolor\" class=\"needs-prerender srgb\">\r\n        </ks-colorpicker>\r\n\r\n        <ks-colorpicker id=\"emissivecolor\" class=\"needs-prerender srgb\">\r\n        </ks-colorpicker>\r\n\r\n        <ks-popupselect id=\"channelpresets\" class=\"inline\">\r\n            <div slot=\"name\" data-l10n-id=\"lblFinish\">FINISH</div>\r\n            <div slot=\"open\">\r\n                <div class=\"title\" data-l10n-id=\"lblPaintFinish\">PAINT FINISH</div>\r\n            </div>\r\n            <div slot=\"items\">\r\n                <div class=\"group\">\r\n                    <div class=\"item\">\r\n                        <div class=\"description\"></div>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n        </ks-popupselect>\r\n\r\n        <div class=\"channel-controls\" id=\"channelcontrols\" sdata-bind-ksvalue=\"APF()?.shouldShowChannelControls({{CurrentChannelState}},'channels')\">\r\n\r\n            <ks-numericfield id=\"normalized_roughness\" sdata-bind-class-toggle=\"visible:{{CurrentChannelRules.allow_roughness_picker}}\" sdata-bind-inputvalue=\"{{CurrentChannelState.normalized_roughness}}\">\r\n                <div slot=\"name\" data-l10n-id=\"lblRoughness\">ROUGHNESS</div>\r\n            </ks-numericfield>\r\n            <ks-numericfield class=\"\" id=\"normalized_clear_coat\" sdata-bind-class-toggle=\"visible:{{CurrentChannelRules.allow_clear_coat_picker}}\" sdata-bind-inputvalue=\"{{CurrentChannelState.normalized_clear_coat}}\">\r\n                <div slot=\"name\" data-l10n-id=\"lblClearCoat\">CLEAR COAT</div>\r\n            </ks-numericfield>\r\n            <ks-numericfield class=\"\" id=\"normalized_clear_coat_roughness\" sdata-bind-class-toggle=\"visible:{{CurrentChannelRules.allow_clear_coat_roughness_picker}}\" sdata-bind-inputvalue=\"{{CurrentChannelState.normalized_clear_coat_roughness}}\">\r\n                <div slot=\"name\" data-l10n-id=\"lblClearCoatRoughness\">CLEAR COAT ROUGHNESS</div>\r\n            </ks-numericfield>\r\n            <ks-numericfield class=\"\" id=\"normalized_metalness\" sdata-bind-class-toggle=\"visible:{{CurrentChannelRules.allow_metalness_picker}}\" sdata-bind-inputvalue=\"{{CurrentChannelState.normalized_metalness}}\">\r\n                <div slot=\"name\" data-l10n-id=\"lblMetalness\">METALNESS</div>\r\n            </ks-numericfield>\r\n\r\n            <ks-numericfield class=\"\" id=\"normalized_normal_intensity\" sdata-bind-class-toggle=\"visible:{{CurrentChannelRules.allow_normal_intensity_picker}}\" sdata-bind-inputvalue=\"{{CurrentChannelState.normalized_normal_intensity}}\">\r\n                <div slot=\"name\" data-l10n-id=\"lblFlakes\">FLAKES</div>\r\n            </ks-numericfield>\r\n\r\n            <ks-numericfield class=\"\" id=\"normalized_opacity\" sdata-bind-class-toggle=\"visible:{{CurrentChannelRules.allow_opacity_picker}}\" sdata-bind-inputvalue=\"{{CurrentChannelState.normalized_opacity}}\">\r\n                <div slot=\"name\" data-l10n-id=\"lblOpacity\">OPACITY</div>\r\n            </ks-numericfield>\r\n        </div>\r\n    </div>\r\n</div>";

    class MaterialEditor extends KsHTMLElement {

        IsLimited = false;

        /** @typedef {import('../paintshop').default} PaintShopPage */

        /** @type PaintShopPage */
        PaintShop;

        /** @type CarMaterial */
        Material;

        controlFragment = new DocumentFragment();
        componentBodyFragment = new DocumentFragment();

        ///** @type CarPart */
        //Part;

        panelMain;
        panelControls;
        panelChannelControls;

        activeChannelRules;
        activeChannelState;

        activeFinalCarKey = "";
        activeMechPresetKey = "";
        activeVisualPresetKey = "";
        activeCategory;
        activePartPath = "";
        activeMaterialIndex = 0;
        activeChannelStateName = "";
        activeChannelIndex = -1;
        activeCarOriginal = true;

        updating = false;
        isDirty = false;

        stickySingleOption = false;

        /** @type RadioButtonGroup */
        btnGroupMode;
        /** @type RadioButtonGroup */
        btnGroupEnableMaterial;
        /** @type RadioButtonGroup */
        btnGroupPartCategory;
        /** @type RadioButtonGroup */
        btnGroupChannels;

        labelCategory;
        labelMaterial;

        /** @type PopUpSelect */
        popupOemColors;
        /** @type PopUpSelect */
        popupChannelPresets;
        /** @type ColorPicker */
        mainColorPicker;
        /** @type ColorPicker */
        emissiveColorPicker;

        rowControls;

        constructor() {
            super();
            this.template = template$1p;
            this._isnavigable = true;
            this.delayedInit = false;
        }

        update() {
            this.updating = true;
            return new Promise((resolve, reject) => {
                CUSTOMIZATION
                    .updateMaterial(this.Material)
                    .then((data) => {
                        this.updating = false;
                        this.markDirty();
                        resolve(data);
                    }).catch(data => {
                        reject(data);
                    });
            });
        }

        toggle(state) {
    //        console.trace("Toggle", state, this.Material);
            CUSTOMIZATION
                .toggleMaterial(this.Material, state)
                .then(() => {
                    this.classList.toggle("is-enabled", state);
                    this.markDirty();
                    waitForFrames(() => {
                        this.labelMaterial.focus();
                    }, 1);
                });
        }


        toggleMainPanelClass(classname, state) {
            this.panelMain.classList.toggle(classname, state);
        }

        showOnlyOption() {

            if (this.classList.contains("show-oemcolors")) {
                this.popupOemColors.fireevent = false;
                this.popupOemColors.show();
                this.popupOemColors.fireevent = true;
                if (this.OptionsLength > 1) {
                    this.popupOemColors.classList.add("hide-title");
                }
            }

            // this.refreshPickers();
        }

        toggleSelected() {
            const selected = this.classList.contains("selected");
            const mainpanel = this.closest(".mainpanel");
            const paintshop = this.closest("ks-page-paintshop");


            const materialeditors = qAll("ks-materialeditor", this.parentElement);
            materialeditors.forEach(elem => {
                if (elem != this) {
                    elem.classList.remove("selected");
                    if (!this.isOnlyToggle) {
                        if (!selected) elem.componentBodyFragment.appendChild(elem.componentBody);
                        else elem.appendChild(elem.componentBody);
                    }
                }
            });
            materialeditors.forEach(elem => {
                if (elem != this) {

                    if (!this.isOnlyToggle) {
                        elem.classList.toggle("collapsed", !selected);
                    }
                }
            });

            if (!selected && !this.isOnlyToggle) {
                activePage.setupNavigation();
            }

            if (this.isOnlyToggle) {
                this.Material.channels.is_enabled = !this.Material.channels.is_enabled;
                this.toggle(this.Material.channels.is_enabled);

                return;
            }

            this.showOnlyOption();

            if (!this.stickySingleOption) {
                const result = this.classList.toggle("selected", !selected);

                if (mainpanel && !this.isOnlyToggle) {

                    activePage.panelMain.classList.add("no-pointer-events");

                    this.ontransitionend = (ev) => {
                        if (ev.target == this) {

                            waitForFrames(() => {
                                activePage.panelMain.classList.remove("no-pointer-events");
                            }, 3);

                            this.ontransitionend = null;
                        }
                    };

                    mainpanel.dataset.mode = result ? "expanded-material" : "";


                }

                if (paintshop) {
                    paintshop.classList.toggle("show-materialeditor", result);

                    waitForFrames(() => {
                        paintshop.classList.toggle("show-largematerialeditor", (this.getBoundingClientRect().width / paintshop.getBoundingClientRect().width >= 0.8) && result);
                    }, 3);
                }

            }

            if (!selected) {
                this.componentBody.appendChild(this.panelControls);
                engine.trigger(EngineEvents.PaintShop.MaterialSelected, this.Material);
            } else {
                this.controlFragment.appendChild(this.panelControls);
            }


            this.labelMaterial.focus();
        }

        refreshPickers(frames_delay = 3) {
            // console.warn("refreshPickers", this.Material.description);
            waitForFrames(() => {
                this.mainColorPicker.refresh();
                this.emissiveColorPicker.refresh();
            }, frames_delay);
        }

        bindControls() {

            engine.on(EngineEvents.PaintShop.CarSaved, () => {
                this.clearDirty();
            });

            engine.on(EngineEvents.PaintShop.MaterialRefreshed, (material) => {
                const existing_material = this.Material;

                if (
                    existing_material &&
                    existing_material.material_index == material.material_index &&
                    existing_material.material_category == material.material_category &&
                    existing_material.material_type == material.material_type
                ) {
                    //console.log("my material was refreshed", this.Material.description, this.Material.channels.is_enabled, material.channels.is_enabled);
                    Object.assign(this.Material, material);
                    //this.Material = material;
                    this.processMaterial();
                }
            });

            engine.on(EngineEvents.PaintShop.MaterialToggled, (material, state) => {
                if (material != this.Material
                    && state
                    && material.channels.slot == this.Material.channels.slot) {
                    //console.log("my material was toggled", this.Material.description);
                    this.btnGroupEnableMaterial.setSelected(1, null, false);
                    this.Material.channels.is_enabled = false;
                    this.classList.remove("is-enabled");
                }
            });


            ["click", "sn:enter-down"].forEach(event_name => {
                this.labelMaterial.addEventListener(event_name, () => {
                    this.toggleSelected();
                    if (this.classList.contains("selected")) {
                        this.refreshPickers();
                    }
                });
            });

            this.onmouseover = () => {
                ksUI$1.menuState.toggleMouseHover(true);
            };

            this.onmouseleave = () => {
                ksUI$1.menuState.toggleMouseHover(false);
            };


            // this.panelControls.onmouseover = () => {
            //     ksUI.menuState.toggleMouseHover(true);
            // };

            // this.panelControls.onmouseleave = () => {
            //     ksUI.menuState.toggleMouseHover(false);
            // };

            qevAll("#channelcontrols ks-numericfield",
                "onValueChanged", (ev) => {
                    this.activeChannelState.channel_preset_path = "";
                    this.activeChannelState[ev.target.id] = ev.detail.value;
                    this.update().then(() => {
                        this.popupChannelPresets.setSelectedIndex(0);
                    });
                }, this);

            this.btnGroupChannels.addEventListener("onValueChanged", (ev) => {
                this.selectChannel(ev.detail.value);
                this.refreshPickers(1);
            });

            this.mainColorPicker.addEventListener("onValueChanged", (ev) => {
                const rgb = ev.detail.rgb;

                this.activeChannelState.srgb_color.x = rgb[0];
                this.activeChannelState.srgb_color.y = rgb[1];
                this.activeChannelState.srgb_color.z = rgb[2];

                this.update().then(data => {
                    const retcolor = data[this.activeChannelStateName].srgb_color;
                    const hsb = ksUI$1.RGB2HSV([retcolor.x, retcolor.y, retcolor.z]);
                    hsb[0] = ev.detail.hsb[0];
                    this.mainColorPicker.HSB = hsb;
                });
            });

            this.emissiveColorPicker.addEventListener("onValueChanged", (ev) => {
                const rgb = ev.detail.rgb;

                this.activeChannelState.emissive_srgb_color.x = rgb[0];
                this.activeChannelState.emissive_srgb_color.y = rgb[1];
                this.activeChannelState.emissive_srgb_color.z = rgb[2];

                this.update().then(data => {
                    const retcolor = data[this.activeChannelStateName].emissive_srgb_color;
                    const hsb = ksUI$1.RGB2HSV([retcolor.x, retcolor.y, retcolor.z]);
                    hsb[0] = ev.detail.hsb[0];
                    //console.warn("returned", hsb);
                    this.emissiveColorPicker.HSB = hsb;
                });


            });

            this.btnGroupEnableMaterial.onUpdate = (new_value, old_value) => {
                this.toggle(new_value == 0);
            };

            this.btnGroupMode.onUpdate = (new_value, old_value) => {

                if (new_value == 1) {
                    this.activeChannelState.storedOemPath = this.activeChannelState.oem_color_path;
                    this.activeChannelState.oem_color_path = "";
                } else {
                    if (!this.activeChannelState.storedOemPath) {
                        this.activeChannelState.storedOemPath = this.Material.channels.oem_colors[0].item.key;
                    }
                    console.log("storedpath");
                    this.activeChannelState.oem_color_path = this.activeChannelState.storedOemPath;

                    qAll(".item", this.popupOemColors).forEach(elem => {
                        elem.classList.toggle("selected", elem.value == this.activeChannelState.storedOemPath);
                    });

                    this.popupOemColors.show();

                }

                this.selectChannel();
                this.update();
                this.refreshPickers();
                return;
            };

        }

        getCurrentActiveChannelState() {
            return this.getCurrentMaterialType() == this.MaterialTypes.Multi ?
                CurrentMaterial[this.activeChannelStateName + "_state"] :
                CurrentMaterial["channel_state"];
        }

        setMainPanelModal(state, mode) {
            this.dataset.modal = state ? "modal" : "";
            this.dataset.mode = state ? mode : "";
        }

        closeOtherPopups(pop_up) {
            [this.popupOemColors, this.popupChannelPresets].every((p) => {
                if (pop_up == null) {
                    p.hide();
                    return true;
                }
                if (p != pop_up) {
                    p.hide();
                    return true;
                }
            });
        }

        markDirty() {
            //console.trace("markdirty");
            this.classList.add("is-dirty");
            this.isDirty = true;
            this.Material.is_dirty = true;
            engine.trigger(EngineEvents.PaintShop.MaterialDirty);
        }

        clearDirty() {
            this.isDirty = false;
            this.classList.remove("is-dirty");
        }

        _numOfOptions = 0;

        get OptionsLength() {
            return this._numOfOptions;
        }

        addOption(option_name, condition) {
            this.classList.toggle(option_name, condition === true);
            if (condition === true) {
                this._numOfOptions++;
            }
            return condition === true;
        }

        isOnlyToggle = false;

        processMaterial() {
            const material = this.Material;
            const channels = this.Material.channels;

            this._numOfOptions = 0;

            { /** set label */
                let materialLabel = engine.translate(material.l10nid);

                if (materialLabel == material.l10nid) {
                    materialLabel = material.description;
                }

                q(".name", this.labelMaterial).innerHTML = materialLabel;
            }

            if (!this.material_processed && !this.classList.contains("is-dirty"))
                this.classList.toggle("is-dirty", material.is_dirty === true);

            /** allow material toggle on/off */
            this.addOption("show-toggle", material.is_optional && !material.is_locked);

            this.btnGroupEnableMaterial.setSelected(this.classList.toggle("is-enabled", this.Material.channels.is_enabled) ? 0 : 1, null, false);

            { /** allow channel selector */
                let num_channels = 0;

                if (!channels.channel_rules) {
                    if (channels.primary_channel_rules.is_channel_customizable) {
                        this.btnGroupChannels.options[0].classList.add("active");
                        num_channels++;
                    }
                    if (channels.secondary_channel_rules.is_channel_customizable) {
                        this.btnGroupChannels.options[1].classList.add("active");
                        num_channels++;
                    }
                    if (channels.tertiary_channel_rules.is_channel_customizable) {
                        this.btnGroupChannels.options[2].classList.add("active");
                        num_channels++;
                    }
                } else {
                    if (channels.channel_rules.is_channel_customizable) num_channels++;
                }

                this.addOption("show-channels", num_channels > 1);
                this.classList.toggle("has-channels", num_channels > 0);

                if (num_channels == 0) {
                    this.btnGroupChannels.innerHTML = "";
                }

            }

            this.selectChannel();

            this.isOnlyToggle = this.classList.toggle("only-toggle", this.OptionsLength == 1 && (this.classList.contains("show-toggle") && !this.classList.contains("has-channels")));


            this.classList.add(this.OptionsLength == 1 ? "single-option" : "multi-option");
            this.classList.toggle("expandable", !this.isOnlyToggle);
        }

        elementVisibility = {
            showMainPicker: false,
            showEmissivePicker: false,
            showChannelPresets: false,
            showChannelControls: false
        }

        processChannel() {

            // console.log("Processing channel");

            if (!this.activeChannelState || !this.activeChannelRules) {
                this.classList.add("no-customizable-channels");
                return;
            }

            const channelstate = this.activeChannelState;
            const channelrules = this.activeChannelRules;

            const allowchannelcontrols =
                channelrules.allow_clear_coat_picker ||
                channelrules.allow_clear_coat_roughness_picker ||
                channelrules.allow_metalness_picker ||
                channelrules.allow_normal_intensity_picker ||
                channelrules.allow_roughness_picker ||
                channelrules.allow_opacity_picker;

            this.addOption("show-channelmode", this.Material.channels.oem_colors.length > 0 && channelrules.show_picker_option && !this.IsLimited);
            const showingoem = this.addOption("show-oemcolors", channelstate.oem_color_path != "" || (channelstate.oem_color_path == "" && !channelrules.show_picker_option));

            if (showingoem)
                this.popupOemColors.show();


            const showEmissivePicker = this.addOption("show-emissivecolor", channelstate.oem_color_path == "" && channelrules.allow_emissive_color);
            const showMainPicker = this.addOption("show-maincolor", channelstate.oem_color_path == "" && channelrules.allow_color_picker);

            const showChannelPresets = this.addOption("show-channelpresets", allowchannelcontrols && showMainPicker && this.Material.material_type == eCarCustomization.MaterialTypes.Multi);

            const showChannelControls = this.addOption("show-channelcontrols", showMainPicker && allowchannelcontrols);

            this.elementVisibility.showEmissivePicker = showEmissivePicker;
            this.elementVisibility.showMainPicker = showMainPicker;
            this.elementVisibility.showChannelPresets = showChannelPresets;
            this.elementVisibility.showChannelControls = showChannelControls;

            this.classList.toggle("show-roughness", showMainPicker && channelrules.allow_roughness_picker === true);
            this.classList.toggle("show-clearcoat", showMainPicker && channelrules.allow_clear_coat_picker === true);
            this.classList.toggle("show-clearcoat_roughness", showMainPicker && channelrules.allow_clear_coat_roughness_picker === true);
            this.classList.toggle("show-metalness", showMainPicker && channelrules.allow_metalness_picker === true);
            this.classList.toggle("show-normal_intensity", showMainPicker && channelrules.allow_normal_intensity_picker === true);
            this.classList.toggle("show-opacity", showMainPicker && channelrules.allow_opacity_picker === true);

            this.btnGroupMode.setSelected(channelstate.oem_color_path != "" ? 0 : 1, null, false);

            if (this.classList.toggle("has-oem-colors",
                this.Material.channels.oem_colors.length > 0)) {
                this.populateOemColors();
            }

            if (showMainPicker) {
                const color = channelstate.srgb_color;
                this.mainColorPicker.RGB = [color.x, color.y, color.z];
            }

            if (showEmissivePicker) {
                const color = channelstate.emissive_srgb_color;
                this.emissiveColorPicker.RGB = [color.x, color.y, color.z];
            }

            if (showChannelPresets) {
                this.populateChannelPresets();
            }

            if (showChannelControls) {
                this.populateChannelControls();
            }

            if (this.OptionsLength == 1 && this.Material.channels.oem_colors.length == 1) ;
        }

        populateChannelControls() {
            qAll("ks-numericfield", this.panelChannelControls)
                .forEach(field => {
                    if (this.activeChannelState[field.id] != undefined) {
                        field.setAttribute("value", this.activeChannelState[field.id]);
                    }
                });
        }

        populateChannelPresets() {
            const group = q(".group", this.popupChannelPresets);
            const presets = CUSTOMIZATION.ChannelPresets.channel_presets;
            group.innerHTML = "";

            var dfrag = new DocumentFragment();

            let foundselected = false;

            presets.forEach(preset => {
                const tile = document.createElement("div");
                tile.classList.add("item");
                tile.classList.add("focusable");
                tile.classList.add(preset.key.replaceAll(" ", "_").toLowerCase());
                const is_selected = tile.classList.toggle("selected", preset.key == this.activeChannelState.channel_preset_path);
                tile.value = preset.key;

                tile.innerHTML = `<div class="description" data-l10n-id="finish_${preset.description}"></div>`;

                if (!foundselected && is_selected) {
                    foundselected = true;
                }

                dfrag.appendChild(tile);
            });

            group.appendChild(dfrag);

            if (!foundselected) {
                q(".item.custom", group).classList.add("selected");
            }

            this.popupChannelPresets.addEventListener("onVisibilityChange", (ev) => {
                ///if(!ev.detail.visible) return;
                //this.closeOtherPopups(this.popupChannelPresets);
                this.setMainPanelModal(ev.detail.visible, "channelpresets");
            });

            this.popupChannelPresets.addEventListener("onItemClicked", (ev) => {
                if (this.updating) return;
                // console.log(ev.detail.value);
                this.activeChannelState.channel_preset_path = ev.detail.value;
                this.activeChannelState.oem_color_path = "";

                this.update()
                    .then((data) => {
                        const returned = data[this.activeChannelStateName];
                        this.activeChannelState.normalized_clear_coat = returned.normalized_clear_coat;
                        this.activeChannelState.normalized_clear_coat_roughness = returned.normalized_clear_coat_roughness;
                        this.activeChannelState.normalized_metalness = returned.normalized_metalness;
                        this.activeChannelState.normalized_normal_intensity = returned.normalized_normal_intensity;
                        this.activeChannelState.normalized_roughness = returned.normalized_roughness;
                        this.populateChannelControls();
                    });

                this.popupChannelPresets.updateIndicator();
                if (this.popupChannelPresets.remainopen && this.OptionsLength == 1) ;
            });

            this.popupChannelPresets
                .bindItems()
                .updateIndicator();
        }

        populateOemColors() {
            //console.log("Populated OEM colors");
            /** @type HTMLDivElement */
            this.popupOemColors.remainopen = true;
            this.popupOemColors.fireevent = false;
            const group = q(".group .scrollable-content", this.popupOemColors);
            const oem_colors = this.Material.channels.oem_colors;
            group.innerHTML = "";

            var dfrag = new DocumentFragment();


            oem_colors.forEach((color, index) => {


                const l10nid = color.item.description.toLowerCase().replace(/[\W_]+/g, "_");

                const tile = document.createElement("div");
                tile.classList.add("item");
                tile.classList.add("focusable");
                tile.classList.toggle("selected", color.item.key == this.activeChannelState.oem_color_path);
                // if(this.activeChannelState.oem_color_path == "" && index == 0){
                //     tile.classList.add("selected");
                // }
                tile.value = color.item.key;
                tile.innerHTML = `
                    <div class="color-tile" style="background-color: #` + ksUI$1.linearHexToSrgb(color.color_code) + `"></div>
                    <div class="description">` + engine.translate(l10nid) + `</div>`;

                dfrag.appendChild(tile);
            });

            if (oem_colors.length == 1) {
                this.popupOemColors.classList.add("single-item");
            } else if (oem_colors.length > 20) {
                this.popupOemColors.classList.add("multiple-items");
            }



            group.appendChild(dfrag);

            this.popupOemColors.hoverEvents = "focus";

            this.popupOemColors.addEventListener("onItemClicked", (ev) => {
                if (this.updating) return;

                this.activeChannelState.oem_color_path = ev.detail.value;
                this.update();
                this.popupOemColors.updateIndicator();

                q(".color-name", this.popupOemColors).innerHTML = q(".description", this.popupOemColors.selectedItem).innerHTML;

                //console.log(ev.detail.value, ev.detail.old);
                if (ev.detail.value == ev.detail.old) {
                    this.toggleSelected();
                }
                if (this.popupOemColors.remainopen) ;
            });

            this.popupOemColors.onItemHovered = (ev) => {
                //if (!this.popupOemColors.fireevent) return;
                if (this.updating) return;
                //console.warn("itemhovered", this.popupOemColors.fireevent);
                this.activeChannelState.oem_color_path = ev.currentTarget.value;
                q(".color-name", this.popupOemColors).innerHTML = q(".description", ev.currentTarget).innerHTML;
                this.update();
            };

            this.popupOemColors.fireevent = true;

            this.popupOemColors.addEventListener("mouseleave", (ev) => {
                if (this.popupOemColors.isShowing()) {
                    q(".color-name", this.popupOemColors).innerHTML = q(".description", this.popupOemColors.selectedItem).innerHTML;
                    //this.activeChannelState.oem_color_path = this.popupOemColors.selectedItem.value;
                    //this.update();
                }
            });

            this.popupOemColors.onShow = () => {
                q(".color-name", this.popupOemColors).innerHTML = q(".description", this.popupOemColors.selectedItem).innerHTML;
            };

            this.popupOemColors.addEventListener("onVisibilityChange", (ev) => {

                this.closeOtherPopups(this.popupOemColors);
                //this.setMainPanelModal(ev.detail.visible, "oemcolors");

                if (this.OptionsLength == 1) {
                    this.popupOemColors.remainopen = true;
                }

                if (ev.detail.visible) {
                    q(".color-name", this.popupOemColors).innerHTML = q(".description", this.popupOemColors.selectedItem).innerHTML;
                } else {
                    this.activeChannelState.oem_color_path = this.popupOemColors.selectedItem?.value;
                    this.update();
                }

            });

            //this.popupOemColors.hoverEvents = "focus";



            this.popupOemColors
                .bindItems()
                .updateIndicator();


            //console.log("// Populated OEM colors");
        }

        selectChannel(index = this.activeChannelIndex) {
            //console.log("Selecting channel", index);
            this.popupOemColors.fireevent = false;

            const is_multilayer = this.Material.material_type == eCarCustomization.MaterialTypes.Multi;

            const channel_names = ["primary_channel", "secondary_channel", "tertiary_channel"];

            if (index === -1 && is_multilayer) {
                index = channel_names.findIndex(channel =>
                    this.Material.channels[channel + "_rules"].is_channel_customizable);
            }

            if (!is_multilayer) {
                index = 0;
            }

            if (index !== -1) {
                const channel = channel_names[index];

                if (is_multilayer) {
                    this.activeChannelState = this.Material.channels[channel + "_state"];
                    this.activeChannelStateName = channel + "_state";
                    this.activeChannelRules = this.Material.channels[channel + "_rules"];
                } else {
                    this.activeChannelState = this.Material.channels.channel_state;
                    this.activeChannelStateName = "channel_state";
                    this.activeChannelRules = this.Material.channels.channel_rules;
                }

                this.btnGroupChannels.setSelected(index, null, false);

                console.log(this.Material.material_index, this.Material.description, "selectChannel", channel, index);
            } else {
                this.activeChannelStateName = null;
                this.activeChannelIndex = -1;
                this.activeChannelState = null;
                this.activeChannelRules = null;

            }

            this.activeChannelIndex = index;

            this.processChannel();
            this.popupOemColors.fireevent = true;

            engine.trigger(EngineEvents.UI.SetupNavigation);
        }

        onMaterialChanged() {

            this.Material;
            this.Material.channels;


            {
                rules.allow_color_picker;
            }
        }

        setControlVisibility() {

        }

        material_processed = false;

        onTemplateLoaded() {
            super.onTemplateLoaded();


            this.popupOemColors = q("#oemcolors", this);
            this.popupChannelPresets = q("#channelpresets", this);
            this.mainColorPicker = q("#maincolor", this);
            this.emissiveColorPicker = q("#emissivecolor", this);
            this.btnGroupMode = q("#channelmode", this);
            this.btnGroupEnableMaterial = q("#materialenable", this);
            this.btnGroupEnablePart = q("#partenable", this);
            this.btnGroupChannels = q("#channels", this);

            this.labelMaterial = q(".label", this);

            this.panelMain = q(".mainpanel", this);
            this.panelControls = q(".material-controls", this);
            this.panelChannelControls = q(".channel-controls", this);


            waitForFrames(() => {
                if (this.Material) {
                    this.processMaterial();
                    this.material_processed = true;
                    this.classList.add("rendered");
                    this.classList.remove("prerender");
                } else {
                    //this.classList.add("disabled");
                    this.setAttribute("disabled", true);
                }
                this.onEditorRendered();
                waitForFrames(() => {
                    this.controlFragment.appendChild(this.panelControls);
                });
            }, 1);


        }

        async onEditorRendered() {

        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();
        }

    }
    engine.whenReady.then(() => {
        ksUI$1.registerModule('ks-materialeditor', MaterialEditor);
    });

    class ShowroomManager extends BaseManager {

        /** @type CarElectronicsValues */
        Electronics = {};

        /** @type CarInstrumentationValues */
        Instrumentation = {};

        /** @type FakeCarPhysicsState */
        PhysicsState = {}

        CarStateData = {};

        Client = new MessageHandler("Showroom");

        constructor(parent_element) {
            super(null, parent_element);
            this.resetFilters();
            this.updateDataFilters();
        }

        initialize() {
            return new Promise((resolve, reject) => {

                this.getCarState().then(data => {

                    console.trace("SHOWROOM initialize");

                    console.trace(data);
                    Object.assign(this.CarStateData, data);
                    Object.assign(this.Instrumentation, data.state.instrumentation_values);
                    Object.assign(this.Electronics, data.state.electronics_values);
                    Object.assign(this.PhysicsState, data.state.physics_state);
                    console.log("Showroom controls initialized");

                    resolve(data);
                });

            });
        }

        setCameraMode(camera_mode) {
            return new Promise((resolve, reject) => {
                this.Client.request("SelectShowroomCameraMode", { camera_mode: camera_mode },
                    (data) => {
                        resolve(data);
                    });
            });
        }

        setWeather(weather_index) {
            return new Promise((resolve, reject) => {
                this.Client.request("SelectWeather", { index: weather_index },
                    (data) => {
                        resolve(data);
                    });
            });
        }


        setPosition(position_index) {

            return new Promise((resolve, reject) => {
                this.Client.request("SelectSpawnPoint", { index: position_index },
                    (data) => {
                        resolve(data);
                    });
            });
        }

        setHDRI(hdri_index) {
            return new Promise((resolve, reject) => {
                this.Client.request("SelectHdri", { index: hdri_index },
                    (data) => {
                        resolve(data);
                    });
            });
        }

        setTimeOfDay(time_in_minutes) {
            return new Promise((resolve, reject) => {
                this.Client.request("SelectDateTime", { date_time: time_in_minutes },
                    (data) => {
                        // console.trace("SelectDateTime", data);
                        resolve(data);
                    });
            });
        }

        getShowroom(showroom_index = -1) {
            return new Promise((resolve, reject) => {
                this.Client.request("Select", { index: showroom_index },
                    (data) => {
                        resolve(data);
                        if (showroom_index >= 0) {
                            engine.trigger(EngineEvents.Showroom.Changed);
                        }
                        if (this.onGetShowroom(data)) {
                            this.onGetShowroom(data);
                        }
                    });
            });
        }

        resetShowroom() {
            return new Promise((resolve, reject) => {
                this.Client.request("ResetShowroom",
                    (data) => {
                        resolve(data);
                        if (this.onResetShowroom) {
                            this.onResetShowroom(data);
                        }

                    });
            });
        }

        onResetShowroom(data) {

        }

        saveShowroom() {
            return new Promise((resolve, reject) => {
                this.Client.request("SaveCurrent",
                    (data) => {
                        resolve(data);
                    });
            });
        }

        onGetShowroom(data) {

        }

        getShowroomList() {
            return new Promise((resolve, reject) => {
                this.Client.request("List",
                    (data) => {
                        resolve(data);
                    });
            });
        }

        getCarState() {
            return new Promise((resolve, reject) => {
                this.Client.request("CarStateData",
                    (data) => {
                        resolve(data);
                    });
            });
        }

        /** @param {FakeCarPhysicsState} physics_state */
        updatePhysicsState(physics_state = this.PhysicsState) {
            return new Promise((resolve, reject) => {
                this.Client
                    .request("UpdateCarState",
                        { state: physics_state },
                        data => {
                            resolve(data);
                            console.trace("updatePhysicsState", physics_state);
                        });
            });
        }

        /** @param {CarElectronicsValues} electronics_values */
        updateElectronics(electronics_values = this.Electronics) {
            return new Promise((resolve, reject) => {
                this.Client
                    .request("UpdateCarElectronics",
                        { values: electronics_values },
                        data => {
                            resolve(data);
                            console.trace("ShowroomRequestUpdateCarElectronics", electronics_values, data);

                        });
            });
        }

        /** @param {CarInstrumentationValues} instrumentation_values  */
        updateCarInstrumentation(instrumentation_values = this.Instrumentation) {
            //instrumentation_values.display_indexes = ModelCurrentCar.low_frequency.instrumentation.display_indexes;
            //instrumentation_values.selected_display_index = ModelCurrentCar.low_frequency.instrumentation.selected_display_index;

            instrumentation_values.__Type = "CarInstrumentationValues";

            return new Promise((resolve) => {
                this.Client
                    .request("UpdateCarInstrumentation",
                        { values: instrumentation_values },
                        data => {
                            resolve(data);
                            console.trace("updateCarInstrumentation", instrumentation_values);
                        });
            });
        }

        /** @param {eCarAnimationType} animation_type  */
        updateCarAnimation(animation_type, target, is_optional = false) {
            return new Promise((resolve) => {
                this.Client
                    .request(is_optional ? "UpdateCarOptionalAnimation" : "UpdateCarAnimation",
                        is_optional ?
                            { optional_animation_name: animation_type, target: target } :
                            { animation_type: animation_type, target: target },
                        data => {
                            resolve(data);
                        });
            });
        }

        toggleView() {
            this.Client.requestNoResponse("ToggleInteriorExterior");
            console.trace("ToggleInteriorExterior");
        }


        showExterior() {
            this.Client.requestNoResponse("SelectExterior");
            console.trace("SelectExterior");
        }

        showInterior() {
            this.Client.requestNoResponse("SelectInterior");
            console.trace("SelectInterior");
        }

        showWheels() {
            this.Client.requestNoResponse("SelectWheels");
            console.trace("SelectWheels");
        }

        resetCarState() {

            this.Client
                .requestNoResponse("ResetCarState");

        }


    }

    var template$1o = "<div class=\"is-flex-column flex-1\">\r\n    <ks-btnbasic id=\"btnClose\" class=\"focusable\">\r\n        <div slot=\"name\">X</div>\r\n    </ks-btnbasic>\r\n\r\n    <ks-btnbasic id=\"btnSwitchView\" class=\"focusable\">\r\n        <div slot=\"name\" data-l10n-id=\"lblSwitchView\"></div>\r\n    </ks-btnbasic>\r\n\r\n    <div id=\"panelMain\" class=\"indicators is-flex-row flex-1\">\r\n        <ks-btnbasic id=\"btnIgnition\" class=\"focusable\" toggle>\r\n            <div slot=\"name\" data-l10n-id=\"lblIgnitionUpper\">Ignition</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic id=\"btnStart\" class=\"focusable\" toggle>\r\n            <div slot=\"name\" data-l10n-id=\"lblStartUpper\">Start</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic id=\"btnReset\" class=\"focusable\">\r\n            <div slot=\"name\" data-l10n-id=\"lblResetUpper\">Reset</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-slider data-setting=\"steering_angle\" class=\"oneline\" min=\"-270\" max=\"270\" step=\"1\" value=\"0\" fromcenter>\r\n            <div slot=\"name\" data-l10n-id=\"lblSteeringAngle\">Steering Angle</div>\r\n        </ks-slider>\r\n    </div>\r\n\r\n    <div id=\"panelSelector\" class=\"is-flex-row\">\r\n        <ks-btnbasic id=\"btnElectrics\" class=\"focusable selected\" data-mode=\"electrics\" toggle-group=\"mode\" toggle>\r\n            <div slot=\"name\" data-l10n-id=\"lblElectricsUpper\">Electrics</div>\r\n        </ks-btnbasic>\r\n        <ks-btnbasic id=\"btnAnimations\" class=\"focusable\" data-mode=\"animations\" toggle-group=\"mode\" toggle>\r\n            <div slot=\"name\" data-l10n-id=\"lblAnimationsUpper\">Animations</div>\r\n        </ks-btnbasic>\r\n\r\n    </div>\r\n\r\n    <div id=\"panelElectrics\" class=\"panel electrics is-flex-column\">\r\n\r\n        <ks-slider data-setting=\"main_light_stage\" class=\"main-light oneline\" max=\"5\" step=\"1\">\r\n            <div slot=\"name\" data-l10n-id=\"lblMainLightStage\">Main Light Stage</div>\r\n        </ks-slider>\r\n\r\n        <div class=\"direction-lights d-lights is-flex-row align-items-center\">\r\n            <div class=\"row-label\" data-l10n-id=\"lblDirectionLights\">Direction Lights</div>\r\n            <ks-btnbasic data-mode=\"instrumentation\" data-setting=\"direction_light_left\" class=\"focusable\" toggle toggle-group=\"direction\" allownonetoggled distinct-values>\r\n                <div slot=\"name\" data-l10n-id=\"lblDirectionLightLeftInitial\">L</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic data-mode=\"instrumentation\" data-setting=\"direction_light_right\" class=\"focusable\" toggle toggle-group=\"direction\" allownonetoggled distinct-values>\r\n                <div slot=\"name\" data-l10n-id=\"lblDirectionLightRightInitial\">R</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n\r\n        <div class=\"d-lights flex-wrap is-flex-row align-items-center\">\r\n            <ks-btnbasic data-mode=\"instrumentation\" data-setting=\"are_headlights_visible\" class=\"focusable\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"lblHeadlights\">HEADLIGHTS</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic data-mode=\"instrumentation\" data-setting=\"warning_lights\" class=\"focusable\" toggle toggle-group=\"direction\" allownonetoggled distinct-values>\r\n                <div slot=\"name\" data-l10n-id=\"lblWarnLights\">WARN</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic data-setting=\"flashing_lights\" class=\"focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"lblFlashLights\">FLASH</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic data-mode=\"instrumentation\" data-setting=\"rain_lights\" class=\"focusable\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"lblRainLights\">RAIN</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n\r\n        <div class=\"d-lights flex-wrap is-flex-row align-items-center\">\r\n            <ks-btnbasic data-mode=\"physics_state\" data-setting=\"is_braking\" class=\"focusable\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"lblBraking\">REVERSE</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic data-mode=\"physics_state\" data-setting=\"is_reverse_gear\" class=\"focusable\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"lblReverse\">REVERSE</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic data-mode=\"electronics\" data-setting=\"is_pitlimiter_on\" class=\"focusable\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"lblPitLimiter\">PIT LIMITER</div>\r\n            </ks-btnbasic>\r\n\r\n        </div>\r\n\r\n\r\n        <ks-slider data-setting=\"special_light_stage\" class=\"oneline\" max=\"5\" step=\"1\">\r\n            <div slot=\"name\" data-l10n-id=\"lblSpecialLightStage\">Special Light Stage</div>\r\n        </ks-slider>\r\n\r\n        <ks-slider data-setting=\"cockpit_light_stage\" class=\"oneline\" max=\"5\" step=\"1\">\r\n            <div slot=\"name\" data-l10n-id=\"lblCockpitLightStage\">Cockpit Light Stage</div>\r\n        </ks-slider>\r\n\r\n        <ks-slider data-setting=\"wiper_level\" class=\"oneline wipers\" max=\"5\" step=\"1\">\r\n            <div slot=\"name\" data-l10n-id=\"lblWiperStage\">Wiper Stage</div>\r\n        </ks-slider>\r\n\r\n    </div>\r\n\r\n    <div id=\"panelAnimations\" class=\"panel animations is-flex-row\">\r\n    </div>\r\n</div>";

    class ShowroomCarControl extends KsHTMLElement {

        eventHandler;
        loading = false;

        /** @type Btnbasic */
        btnClose;

        /** @type Btnbasic */
        btnSwitchView;

        /** @type Btnbasic */
        btnStart;

        /** @type Btnbasic */
        btnIgnition;

        /** @type Btnbasic */
        btnReset;

        /** @type HTMLDivElement */
        panelAnimations;

        /** @type HTMLDivElement */
        panelElectrics;

        /** @type HTMLDivElement */
        panelSelector;


        constructor() {
            super();
            this.template = template$1o;
            this.delayedInit = true;
        }

        onClose() {

        }

        initialize(reset = false) {
            return new Promise(resolve => {
                SHOWROOM.initialize().then(data => {
                    //console.log("ignition:", SHOWROOM.PhysicsState.is_ignition_on);
                    this.btnStart.toggle(SHOWROOM.PhysicsState.is_engine_running, false);
                    this.btnIgnition.toggle(SHOWROOM.Electronics.is_ignition_on, false);

                    this.loading = true;
                    this.populateOptions();
                    this.populateAnimations(reset);

                    this.loading = false;
                    activePage.setupNavigation(true);
                    resolve();
                });
            });
        }

        handleMessage(data) {
            SHOWROOM.CarStateData = data;
            SHOWROOM.Instrumentation = data.state.instrumentation_values;
            SHOWROOM.Electronics = data.state.electronics_values;
            SHOWROOM.PhysicsState = data.state.physics_state;

            this.btnStart.toggle(SHOWROOM.PhysicsState.is_engine_running, false);
            this.btnIgnition.toggle(SHOWROOM.Electronics.is_ignition_on, false);

            this.loading = true;
            this.populateOptions();
            //this.populateAnimations();
            this.loading = false;
        }

        bindControls() {

            this.eventHandler = engine.on("ShowroomResponseCarStateData", (message) => this.handleMessage(message));

            this.onmouseover = () => {
                ksUI.menuState.toggleMouseHover(true);
            };

            this.onmouseleave = () => {
                ksUI.menuState.toggleMouseHover(false);
            };

            this.btnClose.onPressed = () => {
                this.onClose();
            };

            this.btnSwitchView.onPressed = () => {
                SHOWROOM.toggleView();
            };

            this.btnIgnition.onToggled = (sender, e, state) => {
                SHOWROOM.Electronics.is_ignition_on = state;
                SHOWROOM.updateElectronics();
            };

            this.btnStart.onToggled = (sender, e, state) => {
                SHOWROOM.PhysicsState.is_engine_running = state;
                SHOWROOM.updatePhysicsState();
            };

            this.btnReset.onPressed = (sender, e) => {

                q("ks-slider[data-setting=steering_angle]").value = 0;

                SHOWROOM.resetCarState();
                this.initialize();
            };

            qAll("ks-btnbasic", this.panelSelector).forEach(btn => {
                btn.onToggled = (sender) => {
                    this.dataset.mode = sender.dataset.mode;
                    //this.show();
                };
            });



            qAll("ks-btnbasic", this.panelElectrics).forEach(btn => {

                if (btn.isToggle) {
                    btn.onToggled = (sender, e, state) => {

                        const setting = btn.dataset.setting;

                        if (btn.dataset.mode == "instrumentation") {
                            qAll("[data-mode=instrumentation]", this.panelElectrics)
                                .forEach(togglebtn => {
                                    SHOWROOM.Instrumentation[togglebtn.dataset.setting] = togglebtn.isSelected();
                                });
                            SHOWROOM.updateCarInstrumentation();
                        }

                        if (btn.dataset.mode == "physics_state") {
                            SHOWROOM.PhysicsState[setting] = state;
                            SHOWROOM.updatePhysicsState();
                        }

                        if (btn.dataset.mode == "electronics") {
                            console.trace("ELECTRONICS", setting, state);
                            SHOWROOM.Electronics[setting] = state;
                            SHOWROOM.updateElectronics();
                        }

                    };

                } else {
                    btn.onPressed = () => {

                        console.log(btn.dataset.setting, true);

                        if (!btn.dataset.mode) {
                            SHOWROOM.Instrumentation[btn.dataset.setting] = true;
                            SHOWROOM.updateCarInstrumentation();
                            SHOWROOM.Instrumentation[btn.dataset.setting] = false;
                        }

                        if (btn.dataset.mode == "physics_state") {
                            SHOWROOM.PhysicsState[btn.dataset.setting] = true;
                            SHOWROOM.updatePhysicsState();
                            SHOWROOM.PhysicsState[btn.dataset.setting] = false;
                        }

                        if (btn.dataset.mode == "electronics") {
                            SHOWROOM.Electronics[btn.dataset.setting] = true;
                            SHOWROOM.updateElectronics();
                            SHOWROOM.Instrumentation[btn.dataset.setting] = false;
                        }

                    };
                }
            });

            qevAll("ks-slider", "onSliderValueChanged", (ev) => {

                const detail = ev.detail;
                const sender = detail.sender;
                const setting = sender.dataset.setting;
                const value = detail.value;

                SHOWROOM.Instrumentation[setting] = value;

                if (!this.loading) {
                    SHOWROOM.updateCarInstrumentation();
                }
            }, this.panelElectrics);


            qev("ks-slider[data-setting=steering_angle]", "onSliderValueChanged", (ev) => {
                const detail = ev.detail;
                const sender = detail.sender;
                const setting = sender.dataset.setting;
                const value = detail.value;

                SHOWROOM.PhysicsState[setting] = value;

                if (!this.loading) {
                    SHOWROOM.updatePhysicsState();
                }
            }, this);

        }

        showroomChangedHandler;

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("btnClose");
            this.mapElementById("btnStart");
            this.mapElementById("btnIgnition");
            this.mapElementById("btnReset");
            this.mapElementById("panelAnimations");
            this.mapElementById("panelElectrics");
            this.mapElementById("panelSelector");
            this.mapElementById("btnSwitchView");

            this.showroomChangedHandler = engine.on(EngineEvents.Showroom.Changed, () => {
                this.initialize(true);
            });
        }

        onRemovedFromDOM() {
            console.warn("REMOVED SHOWROOMCONTROLS");
            this.showroomChangedHandler.clear();
            this.eventHandler.clear();
        }

        show() {
            waitForFrames(() => {
                this.initialize().then(() => {

                    waitForFrames(() => {
                        qAll("ks-slider", this).forEach(slider => {
                            slider.slider.setup();
                        });



                        this.classList.toggle("has-pitlimiter", SHOWROOM.CarStateData.state.has_pit_limiter);
                    }, 1);



                });
            }, 3);

        }

        populateOptions() {

            const max_limits = SHOWROOM.CarStateData.state.instrumentation_values_max_limit;
            SHOWROOM.CarStateData.state.instrumentation_values_min_limit;

            this.classList.toggle("has-direction-lights", max_limits.direction_light_left > 0 || max_limits.direction_light_right > 0);
            this.classList.toggle("has-main-light", max_limits.main_light_stage > 0);
            this.classList.toggle("has-wipers", max_limits.wiper_level > 0);

            q("ks-slider[data-setting=steering_angle]").valueNoEvent = SHOWROOM.PhysicsState.steering_angle;

            qAll("ks-slider", this.panelElectrics).forEach(slider => {
                const setting = slider.dataset.setting;
                slider.min = SHOWROOM.CarStateData.state.instrumentation_values_min_limit[setting];
                slider.max = SHOWROOM.CarStateData.state.instrumentation_values_max_limit[setting];
                slider.valueNoEvent = SHOWROOM.Instrumentation[setting];

                slider.classList.toggle("hidden", SHOWROOM.CarStateData.state.instrumentation_values_max_limit[setting] == -1);

            });

            qAll("ks-btnbasic", this.panelElectrics).forEach(

                (btn) => {
                    btn.classList.toggle("hidden", SHOWROOM.CarStateData.state.instrumentation_values_max_limit[btn.dataset.setting] == false);


                    if (btn.dataset.mode == "instrumentation") {
                        btn.toggle(SHOWROOM.Instrumentation[btn.dataset.setting], false);
                    }

                    if (btn.dataset.mode == "physics_state") {
                        btn.toggle(SHOWROOM.PhysicsState[btn.dataset.setting], false);
                    }

                    if (btn.dataset.mode == "electronics") {
                        btn.toggle(SHOWROOM.Electronics[btn.dataset.setting], false);
                    }
                });

        }

        populateAnimations(reset = false) {

            this.panelAnimations.innerHTML = "";

            const allanims = SHOWROOM.CarStateData.state.animations.concat(SHOWROOM.CarStateData.state.optional_animations);

            allanims.forEach(animation => {

                const isoptional = animation.__Type == "ShowroomOptionalAnimation";

                const animation_key = isoptional ? animation.animation_name : animation.animation_type;
                const localization_string = "Animation_" + animation_key.replaceAll(" ", "_");


                if (animation.play_type != "SequentialLut") {
                    /** @type Btnbasic */
                    const btn = document.createElement("ks-btnbasic");
                    btn.forceToggleMode = animation.play_type == "SequentialSimple";
                    btn.dataset.animation = animation_key;
                    btn.labelText = engine.translate(isoptional ? VEHICLES.Car.model.name + "_" + localization_string : localization_string);
                    btn.classList.add(animation.animation_type);
                    btn.classList.add("focusable");

                    if (btn.forceToggleMode) {

                        if (!reset) btn.toggle(animation.target != 0);

                        if (animation.play_type == "PulseFull") {
                            btn.disable();
                        }

                        btn.onToggled = (sender, e, state) => {
                            SHOWROOM.updateCarAnimation(btn.dataset.animation, state ? 1 : 0, isoptional);
                        };
                    } else {
                        btn.onPressed = (sender, e) => {
                            SHOWROOM.updateCarAnimation(btn.dataset.animation, Date.now(), isoptional);
                        };

                    }

                    this.panelAnimations.appendChild(btn);
                } else {
                    /** @type KsSlider */
                    const slider = document.createElement("ks-slider");
                    slider.classList.add("oneline");
                    slider.classList.add("focusable");
                    slider.dataset.animation = animation_key;
                    slider.setAttribute("max", animation.lut_size - 1);
                    slider.setAttribute("step", 1);
                    slider.setAttribute("value", animation.target);
                    slider.innerHTML = `<div slot="name">${engine.translate(isoptional ? VEHICLES.Car.model.name + "_" + localization_string : localization_string)}</div>`;

                    slider.addEventListener("onSliderValueChanged", (ev) => {

                        const detail = ev.detail;
                        const sender = detail.sender;
                        sender.dataset.setting;
                        const value = detail.value;

                        SHOWROOM.updateCarAnimation(animation_key, value, isoptional);
                    });

                    this.panelAnimations.appendChild(slider);
                }

            });
        }


    }
    ksUI.registerModule('ks-showroomcarcontrol', ShowroomCarControl);

    var template$1n = "<div class=\"component-body is-flex-row justify-content-center\">\r\n\r\n    <div id=\"panelCamera\" class=\"is-flex-column flex-1 option\">\r\n\r\n        <div class=\"label\" data-l10n-id=\"lblViewSettingsCamera\">CAMERA</div>\r\n         <div class=\"togglebuttons is-flex-column\">\r\n            <ks-btnbasic class=\"focusable\" data-mode=\"ShowroomCameraMode_Showcase\" data-setting=\"camera_mode\" toggle-group=\"showroom_camera\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"ShowroomCameraMode_Showcase\"></div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"focusable\" data-setting=\"camera_mode\" data-mode=\"ShowroomCameraMode_Free\" toggle-group=\"showroom_camera\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"ShowroomCameraMode_Free\"></div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"is-flex-column flex-1 option\">\r\n        <div class=\"label\" data-l10n-id=\"lblShowroom\">SHOWROOM</div>\r\n        <ks-modalselect id=\"modalShowrooms\" class=\"showrooms focusable\" extracssclass=\"showroom-selector\">\r\n\r\n            <div slot=\"current\" class=\"flex\" data-bind-ksvalue=\"{{CurrentShowroom.selected_showroom_name}}\" data-bind-l10n-id=\"'showroom_' + {{CurrentShowroom.selected_showroom_name}}\" data-bind-value=\"{{CurrentShowroom.selected_showroom_name}}\">Garage</div>\r\n\r\n            <div slot=\"options\">\r\n                <div class=\"title\" data-l10n-id=\"lblAvailableShowrooms\">=Available Showrooms</div>\r\n                <div class=\"list scrollable-vertical\">\r\n                    <div class=\"option focusable\" data-bind-class-toggle=\"selected:{{CurrentShowroom.selected_showroom_name}} == {{iter.display_name}}\" data-bind-for=\"index, iter: {{Showrooms.showrooms}}\" data-bind-style-background-image-url=\"'/images/showrooms/' + {{iter}}.display_name.toLowerCase().replace(' ', '-') + '.texture'\" data-bind-ksvalue=\"{{iter.index}}\">\r\n                        <div class=\"overlay\" data-bind-l10n-id=\"'showroom_' + {{iter.display_name}}\"></div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n        </ks-modalselect>\r\n    </div>\r\n\r\n    <div id=\"panelHDRI\" class=\"is-flex-column flex-1 option\">\r\n        <div class=\"label\">HDRI</div>\r\n\r\n        <ks-modalselect id=\"modalHDRI\" class=\"weather focusable\" extracssclass=\"weather-selector\" data-bind-disablevalue=\"{{CurrentShowroom.hide_hdri_selector}}\">\r\n\r\n            <div slot=\"current\" data-bind-ksvalue=\"{{CurrentShowroom.selected_hdri_index}}\" data-bind-l10n-id=\"{{CurrentShowroom.hdri_name_list}}[CurrentShowroom.selected_hdri_index]\">\r\n            </div>\r\n\r\n            <div slot=\"options\">\r\n                <div class=\"title\" data-l10n-id=\"lblAvailableHDRIPresets\">Available HDRI Presets</div>\r\n                <div class=\"list scrollable-vertical\">\r\n                    <div class=\"option focusable\" data-bind-class-toggle=\"selected:{{CurrentShowroom.selected_hdri_index}} == {{index}}\" data-bind-for=\"index, iter: {{CurrentShowroom.hdri_name_list}}\" data-bind-ksvalue=\"{{index}}\" data-bind-l10n-id=\"{{iter}}\"></div>\r\n                </div>\r\n            </div>\r\n\r\n        </ks-modalselect>\r\n    </div>\r\n\r\n    <div id=\"panelWeather\" class=\"is-flex-column flex-1 option\">\r\n        <div class=\"label\" data-l10n-id=\"panelWeatherSettings\">WEATHER</div>\r\n\r\n        <ks-modalselect id=\"modalWeather\" class=\"weather focusable\" extracssclass=\"weather-selector\" data-bind-disablevalue=\"{{CurrentShowroom.hide_weather_selector}}\">\r\n\r\n            <div slot=\"current\" data-bind-ksvalue=\"{{CurrentShowroom.selected_weather_index}}\" data-bind-l10n-id=\"{{CurrentShowroom.weather_name_list}}[CurrentShowroom.selected_weather_index]\">\r\n            </div>\r\n\r\n            <div slot=\"options\">\r\n                <div class=\"title\" data-l10n-id=\"lblAvailableWeatherPresets\">Available Weather Presets</div>\r\n                <div class=\"list scrollable-vertical\">\r\n                    <div class=\"option focusable\" data-bind-class-toggle=\"selected:{{CurrentShowroom.selected_weather_index}} == {{index}}\" data-bind-for=\"index, iter: {{CurrentShowroom.weather_name_list}}\" data-bind-ksvalue=\"{{index}}\" data-bind-l10n-id=\"{{iter}}\"></div>\r\n                </div>\r\n            </div>\r\n\r\n        </ks-modalselect>\r\n    </div>\r\n\r\n    <div id=\"panelTimeOfDay\" class=\"is-flex-column flex-1 align-items-center justify-content-center option\">\r\n        <div class=\"label\" data-l10n-id=\"labelTimeOfDay\">TIME OF DAY</div>\r\n        <div class=\"is-flex\">\r\n            <ks-slider id=\"sliderTime\" min=\"0\" max=\"1435\" step=\"1\" data-bind-ksvalue=\"{{CurrentShowroom.date_time}}\" data-bind-disablevalue=\"{{CurrentShowroom.hide_time_of_day_selector}}\" class=\"oneline focusable\"></ks-slider>\r\n        </div>\r\n    </div>\r\n\r\n    <div id=\"panelSpawn\" class=\"is-flex-column flex-1 align-items-center justify-content-center option\">\r\n        <div class=\"label\" data-l10n-id=\"labelPosition\">POSITION</div>\r\n        <div class=\"is-flex\">\r\n            <ks-slider id=\"sliderSpawn\" min=\"0\" step=\"1\" data-bind-disablevalue=\"{{CurrentShowroom.spawn_size}} < 1\" class=\"oneline focusable\"></ks-slider>\r\n        </div>\r\n    </div>\r\n\r\n    <div id=\"panelControls\" class=\"buttons is-flex-column justify-content-end align-items-end\">\r\n        <ks-btnbasic id=\"btnReset\" class=\"focusable cancel\">\r\n            <div slot=\"name\" data-l10n-id=\"btnReset\">Reset</div>\r\n        </ks-btnbasic>\r\n        <ks-btnbasic id=\"btnSave\" class=\"focusable apply\">\r\n            <div slot=\"name\" data-l10n-id=\"btnSave\">Save</div>\r\n        </ks-btnbasic>\r\n    </div>\r\n</div>";

    class ShowroomSceneControl extends KsHTMLElement {

        /** @type {ModalSelect} */
        modalShowrooms;

        /** @type {ModalSelect} */
        modalWeather;

        /** @type {ModalSelect} */
        modalHDRI;

        /** @type {ModalSelect} */
        modalCamera;

        /** @type {KsSlider} */
        sliderTime;

        /** @type {KsSlider} */
        sliderSpawn;

        /** @type {Btnbasic} */
        btnSave;

        /** @type {Btnbasic} */
        btnReset;    

        constructor() {
            super();
            this.template = template$1n;
            this.delayedInit = true;
        }

        show() {
            this.classList.add("hide-sliders");
            
            waitForFrames(() => {
                engine.updateWholeModel(CurrentShowroom);
                
                qAll("ks-slider", this).forEach(slider => {
                    slider.slider.setup();

                });

                waitForFrames(() => {
                    this.sliderSpawn.preventEvent = true;
                    this.sliderSpawn.value = CurrentShowroom.spawn_index;
                    this.sliderSpawn.preventEvent = false;
                    this.classList.remove("hide-sliders");
                }, 1);
            }, 6);

            this.modalShowrooms.focus();
        }

        onRemovedFromDOM() {
            SHOWROOM.onGetShowroom = null;
        }

        bindControls() {       
           qAll(".togglebuttons ks-btnbasic").forEach(elem => {
                elem.onToggled = (sender, e, state) => {
                    if (state) {
                        const mode = sender.dataset.mode;                    
                        SHOWROOM.setCameraMode(mode);                    
                    }
                };
            });

            this.sliderTime.valueFilter = (value_to_filter) => {
                return ksUI$1.minutesToTime(value_to_filter);
            };

            this.sliderSpawn.addEventListener("onSliderValueChanged", (ev) => {
                SHOWROOM.setPosition(ev.detail.value);
                CurrentShowroom.spawn_index = ev.detail.value;
                engine.updateWholeModel(CurrentShowroom);

            });

            this.sliderSpawn.valueFilter = (value_to_filter) => {
                return value_to_filter;
            };

            this.sliderTime.addEventListener("onSliderValueChanged", (ev) => {
                const detail = ev.detail;
                detail.sender;
                const value = detail.value;

                SHOWROOM.setTimeOfDay(value);
                CurrentShowroom.date_time = value;
                engine.updateWholeModel(CurrentShowroom);
            });

            this.modalShowrooms.onShow = () => {

                SHOWROOM.getShowroomList().then(data => {
                    this.assignModel(data, "Showrooms");
                    this.modalShowrooms.onPopulated();
                });
            };
         
            this.modalShowrooms.onHide = () => {
                waitForFrames(() => {
                    ksUI$1.menuState.toggleMouseHover(false);
                }, 6);
            };

            this.modalShowrooms.onChanged = (ev, new_value, old_value) => {
                console.log("Setting showroom to", new_value);
                ksUI$1.menuState.toggleMouseHover(false);
                SHOWROOM.getShowroom(Number(new_value)).then(showroomdata => {
                    this.assignModel(showroomdata, "CurrentShowroom");
                    this.pageModal.initialWidgetHovering = false;
                    //ksUI.menuState.toggleMouseHover(false);
                });
            };

            this.modalWeather.onShow = () => {
                ksUI$1.menuState.toggleMouseHover(true);
                this.modalWeather.onPopulated();
            };

            this.modalWeather.onHide = () => {
                waitForFrames(() => {
                    ksUI$1.menuState.toggleMouseHover(false);
                });
            };

            this.modalWeather.onChanged = (ev, new_value, old_value) => {
                console.log("Setting weather to", new_value);
                SHOWROOM.setWeather(Number(new_value)).then(data => {

                    SHOWROOM.getShowroom().then(showroomdata => {
                        this.assignModel(showroomdata, "CurrentShowroom");
                    });
                });
            };

            this.modalHDRI.onShow = () => {
                ksUI$1.menuState.toggleMouseHover(true);
                this.modalHDRI.onPopulated();
            };

            this.modalHDRI.onHide = () => {
                waitForFrames(() => {
                    ksUI$1.menuState.toggleMouseHover(false);
                });
            };

            this.modalHDRI.onChanged = (ev, new_value, old_value) => {
                console.log("Setting HDRI to", new_value);
                SHOWROOM.setHDRI(Number(new_value)).then(data => {

                    SHOWROOM.getShowroom().then(showroomdata => {
                        this.assignModel(showroomdata, "CurrentShowroom");
                    });
                });
            };

            this.onmouseover = () => {
                ksUI$1.menuState.toggleMouseHover(true);
            };

            this.onmouseleave = () => {
                if (!document.body.classList.contains("modalselect-active")) {
                    ksUI$1.menuState.toggleMouseHover(false);
                }
            };

            this.btnSave.onPressed = () => {
                this.pageModal.onConfirm = () => {
                    SHOWROOM.saveShowroom();
                };

                this.pageModal.onHide = () => {
                    ksUI$1.menuState.toggleMouseHover(false);
                };

                this.pageModal.Show({
                    type: eModalDialogTypes.Warning,
                    title: "lblSaveScene",
                    message: "msgAreYouSureSaveScene",
                    buttons: 0x101
                });
            };

            this.btnReset.onPressed = () => {
                this.pageModal.onConfirm = () => {
                    SHOWROOM.resetShowroom();
                };

                this.pageModal.onHide = () => {
                    ksUI$1.menuState.toggleMouseHover(false);
                };

                this.pageModal.Show({
                    type: eModalDialogTypes.Warning,
                    title: "lblResetScene",
                    message: "msgAreYouSureResetScene",
                    buttons: 0x101
                });

            };
        }

        setShowroomValues() {

        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("modalShowrooms");
            this.mapElementById("modalWeather");    
            this.mapElementById("modalHDRI");
            this.mapElementById("sliderTime");
            this.mapElementById("sliderSpawn");
            this.mapElementById("btnSave");
            this.mapElementById("btnReset");

            SHOWROOM.onResetShowroom = () => {
                ksUI$1.menuState.toggleMouseHover(false);
                SHOWROOM.getShowroom();
            };

            SHOWROOM.onGetShowroom = (showroom) => {
                this.assignModel(showroom, "CurrentShowroom");           
                this.sliderTime.min = showroom.date_time_limits.x;
                this.sliderTime.max = showroom.date_time_limits.y;
                this.sliderSpawn.max = showroom.spawn_size - 1;

                this.sliderTime.slider.setup();
                this.sliderSpawn.slider.setup();

                waitForFrames(() => {
                    engine.updateWholeModel(CurrentShowroom);

                });

                this.classList.toggle("hide-weather", showroom.hide_weather_selector);
                this.classList.toggle("hide-timeofday", showroom.hide_time_of_day_selector || showroom.date_time_limits.x == showroom.date_time_limits.y);
                this.classList.toggle("hide-hdri", showroom.hide_hdri_selector || showroom.hdri_name_list.length == 0);
                this.classList.toggle("hide-spawn", showroom.spawn_size < 2);
            };

            ksUI$1.menuState.toggleMouseHover(false);



            SHOWROOM.getShowroom();
            
            qAll(".togglebuttons ks-btnbasic").forEach(elem => {           
                if (elem.dataset.mode === CurrentShowroom.camera_mode) {
                    elem.toggle(true); 
                } else {
                    elem.toggle(false); 
                }
            });

        }


    }
    ksUI$1.registerModule('ks-showroomscenecontrol', ShowroomSceneControl);

    class PaintShopPage extends KsHTMLElement {

        activeFinalCarKey = "";
        activeMechPresetKey = "";
        activeVisualPresetKey = "";
        activeCategory = eCarCustomization.PartCategory.Bodywork;
        activeMaterialLocation = eCarCustomization.MaterialLocation.Exterior;
        activePartPath = "";
        activeMaterialIndex = 0;
        activeChannel = "";
        activeChannelIndex = 0;
        activeCarOriginal = true;

        updating = false;
        isDirty = false;

        /** @type Btnbasic */
        btnBack;
        /** @type Btnbasic */
        btnCancel;
        /** @type Btnbasic */
        btnApply;
        /** @type Btnbasic */
        btnSceneOptions;
        /** @type Btnbasic */
        btnCarControls;
        /** @type Btnbasic */
        btnAutoSwitchCamera;

        /** @type TextInput */
        txtCarNumber;


        /** @type {ShowroomCarControl} */
        controlCar;

        /** @type {ShowroomSceneControl}} */
        controlScene;

        returnPath;
        labelHeader;

        /**
         * @type btnBasic
         */
        btnGroupMode;
        btnGroupEnableMaterial;

        /** @type HTMLDivElement */
        panelMain;

        /** @type HTMLDivElement */
        panelMaterials;
        /** @type HTMLDivElement */
        panelMaterialsList;

        /** @type HTMLDivElement */
        panelParts;
        /** @type HTMLDivElement */
        panelPartsList;

        /** @type HTMLDivElement */
        panelDesigns;
        /** @type HTMLDivElement */
        panelDesignsList;

        /** @type HTMLDivElement */
        panelCompounds;
        /** @type HTMLDivElement */
        panelCompoundsList;

        /** @type RadioButtonGroup */
        btnGroupPartCategory;

        /** @type HTMLDivElement */
        labelCategory;

        rowControls;

        partSelectors = [];

        filters = {
            convertToSrgb(hex_color) {
                let output = ksUI$1.linearHexToSrgb(hex_color);
                //console.log("convertToSrgb", hex_color, output);
                return "#" + output;
            },
            stripYear(name) {
                return name.replace(/ *\([^)]*\)*/g, "");
            },
            updateName(name) {
                return name;
            },
            isDefined(obj, val) {
                // console.log(">>> isDefined", obj !== undefined, val);
                return obj !== undefined;
            },
            isEmpty(val) {
                return val == "";
            },
            CategoryDisabled(obj, category) {
                let materials = obj.multilayers.length + obj.singlelayers.length;
                console.log("CategoryDisabled", materials);
                return materials == 0;
            },
            isActiveChannelPresetIndex(state, item_index) {
                let found = 0;
                ChannelPresets.channel_presets.every((elem, index) => {
                    if (elem.key == CurrentChannelState.channel_preset_path) {
                        found = index;
                        return false;
                    }
                    return true;
                });
                return found == item_index;
            },
            getChannelPresetIndex(state) {
                let found = 0;
                ChannelPresets.channel_presets.forEach((elem, index) => {
                    if (elem.key == state.channel_preset_path) {
                        found = index;
                    }
                });
                return found;
            },
            showChannels(material) {
                if (material == undefined) return "hidden";
                if (material.channel_state != undefined) return "hidden";

                let num_channels = 0;
                if (material.primary_channel_rules.is_channel_customizable) num_channels++;
                if (material.secondary_channel_rules.is_channel_customizable) num_channels++;
                if (material.tertiary_channel_rules.is_channel_customizable) num_channels++;

                return num_channels > 1 ? "visible" : "hidden";
            },
            boolToInt(obj, prop) {
                return obj[prop] ? 0 : 1;
            },
            allowToggleMaterial(material) {
                return material.is_optional && !material.is_locked ? "visible" : "hidden";
            },
            channelMode(obj) {
                return obj.oem_color_path == "" ? 1 : 0;
            },
            hiddenIfUndefined(obj, val) {
                // console.log(">>> hiddenIfUndefined", obj === undefined, val);
                return (obj !== undefined) ? "visible" : "hidden";
            },
            shouldShowColorPicker(state, rules, emissive = false) {
                // console.log("shouldShowColorPicker", state.oem_color_path, "color:", rules.allow_color_picker, emissive)

                let result = emissive ?
                    state.oem_color_path == "" && rules.allow_emissive_color :
                    state.oem_color_path == "" && rules.allow_color_picker;

                return result ? "visible" : "hidden";
            },
            shouldShowOemColors(array, val) {
                let result = (array.length > 1);
                if (window["CurrentChannelState"]) {
                    result = CurrentChannelState.oem_color_path != "";
                }
                return result ? "visible" : "hidden";
            },
            shouldShowChannelControls(obj) {

                let result = (obj !== undefined);

                if (result) {
                    result = CurrentChannelState.oem_color_path == "" && CurrentChannelRules.show_picker_option;
                    result = result &&
                        (
                            CurrentChannelRules.allow_clear_coat_picker ||
                            CurrentChannelRules.allow_clear_coat_roughness_picker ||
                            CurrentChannelRules.allow_metalness_picker ||
                            CurrentChannelRules.allow_normal_intensity_picker ||
                            CurrentChannelRules.allow_roughness_picker ||
                            CurrentChannelRules.allow_opacity_picker
                        );

                } else {
                    return "hidden";
                }

                return result ? "visible" : "hidden";
            },
            shouldShowChannelPresets(rules, state) {
                return (
                    rules.allow_clear_coat_picker ||
                    rules.allow_clear_coat_roughness_picker ||
                    rules.allow_metalness_picker ||
                    rules.allow_normal_intensity_picker ||
                    rules.allow_roughness_picker
                ) && rules.show_picker_option && state.oem_color_path == "" ? "visible" : "hidden";
            },
            visibleByArrayLength(array, when_empty) {
                let result = when_empty ? array.length == 0 : array.length > 0;
                return result ? "visible" : "hidden";
            },

            hiddenIfArrayEmpty(array, val) {
                return (array.length > 0) ? "visible" : "hidden";
            },
            returnSelectedClass(index, type) {
                console.log("returnSelectedClass", activePage.activeMaterialIndex == index, index, type, activePage.getCurrentMaterialType());
                if (activePage.getCurrentMaterialType() != type) return "";
                return activePage.activeMaterialIndex == index ? "selected" : "";
            },
            isActiveMaterialIndex(index, type) {

                if (activePage.getCurrentMaterialType() != type) return false;
                return activePage.activeMaterialIndex == index;
            },
            isActiveOemColor(key) {
                if (window["CurrentChannelState"]) {
                    return CurrentChannelState.oem_color_path == key;
                } else {
                    console.log("isActiveOemColor: CurrentChannelState undefined / ", CurrentMaterial);
                    return false;
                }
            },
            shouldShowChannelMode(material, rules) {
                return material.oem_colors.length > 0 && rules.show_picker_option ? "visible" : "hidden";
            },
            visibleByRule(ruleset, rule) {
                if (ruleset === undefined) {
                    return "hidden";
                }
                return ruleset[rule] ? "visible" : "hidden";
            }
        };

        constructor() {
            super();
            this.template = template$1v;
            this._isnavigable = true;
            this.delayedInit = true;
            this._exposeAsActivePage = true;
            //this._bindScrollableEvents = true;
            this.messagePrefix = "CarCustomization";

        }

        isGarage() {
            return this.hasAttribute("garage");
        }

        isDealership() {
            return this.hasAttribute("dealership");
        }

        isFirstPurchace() {
            return this.hasAttribute("firstpurchace");
        }

        isUsedVehicles() {
            return this.hasAttribute("usedvehicles");
        }

        get SelectedMaterialEditor() {
            return q("ks-materialeditor.selected", this);
        }

        /** @type MaterialEditor[] */
        get MaterialEditors() {
            return qAll("ks-materialeditor", this);
        }

        loadFinalCar(car_key, is_original) {

            console.log("Loading", car_key, is_original);
            this.activeMaterialIndex = 0;

            this.activeMechPresetKey = "";
            this.activeVisualPresetKey = "";

            if (window["FinalCar"]) {
                FinalCar.mechanical_presets = {};
                engine.updateWholeModel(FinalCar);
            }

            if (window["CurrentVisualPreset"]) {
                CurrentMechPreset.visual_presets = [];
                engine.updateWholeModel(CurrentMechPreset);
            }

            if (window["MechanicalPresets"]) {
                MechanicalPresets.mechanical_presets = [];
                engine.updateWholeModel(MechanicalPresets);
            }

            qAll(".mainpanel [data-value=visible]", this).forEach(elem => elem.removeAttribute("data-value"));
            waitForFrames(() => {
                this.request("LoadFinalCar", { key: car_key, is_original: is_original }, (mechanical_presets) => {
                    ({
                        [eCarCustomization.Response.OK]: () => {
                            this.activeFinalCarKey = car_key;
                            this.activeCarOriginal = is_original;

                            waitForFrames(() => {

                                this.assignModel(mechanical_presets, "MechanicalPresets", true);

                                const key = mechanical_presets.selection.selected_mechanical_path;
                                var preset = mechanical_presets.mechanical_presets.find(item => item.item.key == key);

                                this.assignModel(preset, "CurrentMechPreset");

                                //this.assignModel(this.MaterialListCache, "MaterialListCache");


                                waitForFrames(() => {
                                    VEHICLES.getCurrent().then(() => {
                                        CUSTOMIZATION.initialize(car_key);
                                        waitForFrames(() => {
                                            this.controlCar.initialize();
                                        }, 6);
                                    });

                                }, 3);
                            }, 1);


                        },
                        [eCarCustomization.Response.CRITICAL_ERROR]: () => {

                        }
                    }[mechanical_presets.response])();
                }, 3);

            });
        }

        bindMechPresets() {
            //engine.updateWholeModel(MechanicalPresets);
            qAll(".mechpresets ks-btnbasic").forEach((btn) => {
                btn.onPressed = (sender, e) => {
                    qAll(".mechpresets ks-btnbasic").forEach(btn => { btn.classList.remove("selected"); });
                    sender.classList.add("selected");
                    this.activeMechPresetKey = sender.dataset.value;
                    this.loadMechPreset(sender.dataset.value);
                };
            });
        }

        loadMechPreset(preset_key) {
            qAll(".mainpanel [data-value=visible]", this).forEach(elem => elem.removeAttribute("data-value"));

            waitForFrames(() => {
                console.log("SelectMechanicalPreset", preset_key);
                this.request("SelectMechanicalPreset", { key: preset_key }, (data) => {
                    ({
                        [eCarCustomization.Response.OK]: () => {
                            this.activeMechPresetKey = preset_key;
                            // this.activeVisualPresetKey = data.visual_presets[0].item.key;
                            this.markDirty();
                            waitForFrames(() => {
                                this.assignModel(data, "CurrentMechPreset", true);


                                waitForFrames(() => {
                                    this.bindVisualPresets();
                                    VEHICLES.getCurrent().then(data => {
                                        CUSTOMIZATION.initialize(data.model.name);
                                        this.controlCar.initialize();
                                    });
                                    // $.waitForFrames(() =>
                                    //     CUSTOMIZATION.selectDesign(data.visual_presets[0].item.key, eCarCustomization.PartCategory.Bodywork)
                                    // );

                                }, 1);
                            }, 3);


                        },
                        [eCarCustomization.Response.CRITICAL_ERROR]: () => {

                        }
                    }[data.response])();

                });
            }, 3);
        }

        bindVisualPresets() {
            qAll(".visualpresets ks-btnbasic").forEach((btn) => {
                btn.onPressed = (sender, e) => {

                    console.log("SelectDesign", sender.dataset.value);
                    qAll(".visualpresets ks-btnbasic").forEach(btn => { btn.classList.remove("selected"); });
                    sender.classList.add("selected");
                    CUSTOMIZATION
                        .selectDesign(sender.dataset.value, eCarCustomization.PartCategory.Bodywork)
                        .then((data) => {
                            VEHICLES.getCurrent().then(data => {
                                CUSTOMIZATION.initialize(data.model.name);
                                this.controlCar.initialize();

                            });
                            //CUSTOMIZATION.initialize(this.activeFinalCarKey);

                            this.markDirty();
                        });
                };
            });
        }

        setLock(state) {
            this.updating = state;
            //this.mainColorPicker.locked = state;
            //this.emissiveColorPicker.locked = state;
            this.classList.toggle("busy", state);
        }


        toggleLocking(state) {
            if (state) {
                this.setLock(true);
            } else {
                waitForFrames(() => {
                    this.setLock(false);
                }, 3);
            }
        }

        toggleMainPanelClass(classname, state) {
            this.panelMain.classList.toggle(classname, state);
        }

        get MaterialsCount() {
            return this.MaterialEditors.length;
        }

        allmaterialsrendered = false;

        bindControls() {

            // this.panelPartsList.addEventListener("transitionend", (e) => {
            //     console.log(e);
            //     if(e.propertyName == "height") {
            //         if(this.scrollableContainers.length == 0) {
            //             this.setupScrollbars();
            //         } else {
            //             this.updateAllScrollBars();
            //         }
            //     }
            // });

            engine.on(EngineEvents.UI.SetupNavigation, () => this.setupNavigation());

            engine.on(EngineEvents.PaintShop.LastEditorRendered, () => {
                this.allmaterialsrendered = true;

                this.btnGroupPartCategory.enable();
                //console.warn("Received");
                waitForFrames(() => {
                    this.panelMain.classList.remove("loading");
                    this.panelMain.classList.remove("collapsed");

                }, 6);
            });

            engine.on(EngineEvents.PaintShop.MaterialUpdate, (state) => {
                this.setLock(state);
            });

            engine.on(EngineEvents.PaintShop.RemovedPointlessMaterial, () => {
                this.evaluateAvailableCategories();
                this.btnGroupPartCategory.selectFirstActiveOption();
            });

            engine.on(EngineEvents.PaintShop.PartToggled, (part, state) => {
                console.log("Part toggled", part.description, state);
                this.partSelectors.forEach(item => {
                    let allow = true;

                    if (item.part != part
                        && state
                        && item.part.attachment_bone == part.attachment_bone && part.attachment_bone != ""
                        && part.attachment_type == eCarCustomization.AttachmentType.Replacement) {
                        allow = false;
                    }

                    // console.log("found in list", item.part.original_part_path, part.not_allowed_part_paths, part.not_allowed_part_paths.indexOf(item.part.key) > -1);

                    if (item.part != part
                        && state
                        && part.not_allowed_part_paths.indexOf(item.part.original_part_path) > -1) {
                        allow = false;
                    }

                    if (!allow) {
                        item.part.is_installed = false;
                        item.classList.remove("installed");
                    }

                });

                if (!activePage.btnAutoSwitchCamera.toggleState) {
                    return;
                }

                if (part.part_type.indexOf("Interior") == -1) {
                    SHOWROOM.showExterior();
                } else {
                    SHOWROOM.showInterior();
                }
            });

            engine.on(EngineEvents.PaintShop.MaterialDirty, () => {
                this.markDirty();
            });

            this.mainControlhints().onmouseover = () => {
                ksUI$1.menuState.toggleMouseHover(true);
            };

            this.mainControlhints().onmouseleave = () => {
                ksUI$1.menuState.toggleMouseHover(false);
            };

            this.panelPartsList.onmouseover = () => {
                ksUI$1.menuState.toggleMouseHover(true);
            };

            this.panelPartsList.onmouseleave = () => {
                ksUI$1.menuState.toggleMouseHover(false);
            };

            engine.on(EngineEvents.PaintShop.MaterialSelected,
                /** @param {CarMaterial} material */
                (material) => {

                    this.setupNavigation();
                    if (!activePage.btnAutoSwitchCamera.toggleState) {
                        return;
                    }
                    switch (material.material_category) {
                        case eCarCustomization.PartCategory.Bodywork:
                            if (material.material_location == eCarCustomization.MaterialLocation.Exterior) {
                                SHOWROOM.showExterior();
                            } else {
                                SHOWROOM.showInterior();
                            }
                            break;
                        case eCarCustomization.PartCategory.Rims:
                            SHOWROOM.showWheels();
                            break;
                    }
                    console.warn(material.material_category);
                });

            engine.on(EngineEvents.PaintShop.MaterialToggled, (material, state) => {

                if (!activePage.btnAutoSwitchCamera.toggleState) {
                    return;
                }

                switch (material.material_category) {
                    case eCarCustomization.PartCategory.Bodywork:
                        if (material.material_location == eCarCustomization.MaterialLocation.Exterior) {
                            SHOWROOM.showExterior();
                        } else {
                            SHOWROOM.showInterior();
                        }
                        break;
                    case eCarCustomization.PartCategory.Rims:
                        SHOWROOM.showWheels();
                        break;
                }

            });

            engine.on(EngineEvents.PaintShop.RimInstalled, () => {
                if (!activePage.btnAutoSwitchCamera.toggleState) {
                    return;
                }

                SHOWROOM.showWheels();
            });

            engine.on(EngineEvents.PaintShop.RimDesignSelected, () => {
                if (!activePage.btnAutoSwitchCamera.toggleState) {
                    return;
                }

                SHOWROOM.showWheels();
            });

            this.btnGroupPartCategory.addEventListener("onValueChanged", (ev) => {
                if (!ev.detail.item) {
                    this.labelCategory.innerHTML = "";
                    return;
                }

                const itemdataset = ev.detail.item.dataset;

                console.log("selected part", itemdataset.part, itemdataset.location);

                CUSTOMIZATION.PartCategory = itemdataset.part;
                CUSTOMIZATION.Location = itemdataset.location;

                this.labelCategory.innerHTML = q(".label", ev.detail.item).innerHTML;

                if (ev.detail.value != ev.detail.old) {

                    this.btnGroupPartCategory.disable();

                    this.panelMain.ontransitionend = (ev) => {
                        if (ev.target == this.panelMain) {
                            //this.panelMain.classList.remove("collapsed");
                            this.panelMain.ontransitionend = null;
                        }
                    };

                    this.btnGroupPartCategory.classList.remove("has-pagination");
                    this.panelMain.classList.add("loading");


                    waitForFrames(() => {
                        this.populateItems(itemdataset.part, itemdataset.location);
                    }, 3);

                } else {

                    let was_collapsed = this.panelMain.dataset.mode == "expanded-material";

                    this.MaterialEditors.forEach(editor => {
                        editor.classList.remove("selected");
                        editor.classList.remove("collapsed");

                        //if(editor.controlFragment.childElementCount > 0) {
                        editor.appendChild(editor.componentBody);
                        //}
                    });

                    if (!was_collapsed && !this.panelMain.classList.contains("collapsed")) {

                        this.panelMain.classList.add("collapsed");
                    } else if (this.panelMain.classList.contains("collapsed")) {

                        this.panelMain.classList.remove("collapsed");
                    }

                }

                this.panelMain.dataset.mode = "";
                this.panelMaterials.dataset.category = itemdataset.location;

                this.btnGroupPartCategory.dataset.part = itemdataset.part;
                this.btnGroupPartCategory.dataset.category = itemdataset.location;

                this.activeCategory = itemdataset.part;
                this.activeMaterialLocation = itemdataset.location;

            });

            this.controlCar.onClose = () => {
                this.classList.remove("show-carcontrol");
            };

            this.controlScene.onClose = () => {
                this.classList.remove("show-scenecontrol");
            };

            this.txtCarNumber.onInput = (value, valid) => {
                let cleaned = value.replace(/[^\d.-]/g, '').substr(0, 2);
                //if (cleaned == "") cleaned = "0";
                this.txtCarNumber.value = cleaned;
            };

            this.txtCarNumber.onChange = (value, valid) => {
                let cleaned = value.replace(/[^\d.-]/g, '').substr(0, 2);
                if (cleaned == "") cleaned = "0";
                this.txtCarNumber.value = Number(cleaned);
                CUSTOMIZATION.setCarNumber(Number(cleaned));
                this.markDirty();
            };

        }

        setMainPanelModal(state, extra_class) {
            this.panelMain.classList.toggle("modal-mode", state);
            if (extra_class) {
                this.panelMain.classList.toggle(extra_class, state);
            }
        }

        async populateItems(category, location) {
            // console.warn("populating items", category, location);
            this.updating = true;
            //this.panelMain.classList.add("collapsed");
            this.panelMain.classList.add("loading");

            this.classList.remove("show-materialeditor");
            this.classList.remove("show-largematerialeditor");

            if (category == eCarCustomization.PartCategory.Bodywork) {
                const materials = CUSTOMIZATION.getMaterials(category, location);
                await this.populatePartsSimple([]);
                //await this.populateDesigns([]);
                await this.populateMaterials(materials);
            }

            if (category == eCarCustomization.PartCategory.Rims) {
                const rims = CUSTOMIZATION.Rims.list;
                //const designs = CUSTOMIZATION.installedRim.designs;
                const materials = CUSTOMIZATION.getMaterials(category, location);

                await this.populatePartsSimple(rims);
                //await this.populateDesigns(designs, category);
                await this.populateMaterials(materials);

                this.panelMain.classList.remove("loading");
                this.btnGroupPartCategory.enable();

            }

            if (category == eCarCustomization.PartCategory.Parts) {
                const parts = CUSTOMIZATION.Parts.list;

                //await this.populatePartsSimple(parts);

                await this.populatePartsSimple(parts).then(() => {
                    //this.populateDesigns([], category);
                    this.populateMaterialsOfInstalledParts();
                    this.panelMain.classList.remove("loading");
                    this.btnGroupPartCategory.enable();
                });

            }
            //$.waitForFrames(() => {
            this.panelMain.classList.remove("collapsed");

            //}, 6);
            // this.panelMain.classList.remove("loading");
            this.updating = false;
            this.setupNavigation();

        }


        populateParts(parts_array) {

            return new Promise((resolve) => {
                this.panelParts.classList.add("collapsed");
                this.panelPartsList.innerHTML = "";

                if (parts_array.length == 0) {
                    resolve();
                    return;
                }

                this.panelPartsList.classList.toggle("scrollable-vertical", parts_array.length > 10);

                const dfrag = new DocumentFragment();

                parts_array.forEach(part => {
                    /** @type MaterialEditor */
                    const editor = document.createElement("ks-materialeditor");
                    editor.Part = part;
                    dfrag.appendChild(editor);
                });

                this.panelPartsList.appendChild(dfrag);

                if (parts_array.length > 0)
                    this.panelParts.classList.remove("collapsed");

                resolve();
                this.bindParts();
            });
        }

        scrollbarsSetup = false;

        populatePartsSimple(parts_array) {
            this.partSelectors = [];
            return new Promise((resolve) => {
                this.panelParts.classList.add("collapsed");
                this.panelPartsList.innerHTML = "";

                if (parts_array.length == 0) {
                    resolve();
                    return;
                }

                this.panelPartsList.classList.toggle("scrollable-vertical", parts_array.length > 10);

                const dfrag = new DocumentFragment();

                const targetarray = parts_array.length > 15 ? parts_array.slice().reverse() : parts_array;

                function set_part_type_text(part) {
                    if (part.part_type.indexOf("CarPartType_Exterior") == 0) {
                        part.part_type_text = "Exterior";
                    }

                    if (part.part_type.indexOf("CarPartType_Interior") == 0) {
                        part.part_type_text = "Interior";
                    }

                    if (part.part_type.indexOf("CarPartType_Mechanics") == 0) {
                        part.part_type_text = "Mechanical";
                    }
                }

                if (targetarray[0].__Type == eCarCustomization.ItemType.Part) {

                    set_part_type_text(targetarray[0]);

                    targetarray.sort((a, b) => {

                        set_part_type_text(a);
                        set_part_type_text(b);

                        if (a.part_type.indexOf("CarPartType_Mechanics") == 0) {
                            return 1;
                        }
                        if (b.part_type.indexOf("CarPartType_Mechanics") == 0) {
                            return -1;
                        }


                        if (a.part_type.indexOf("CarPartType_Exterior") == 0 && b.part_type.indexOf("CarPartType_Exterior") == -1) {
                            return -1;
                        }
                        if (b.part_type.indexOf("CarPartType_Exterior") == 0 && a.part_type.indexOf("CarPartType_Exterior") == -1) {
                            return 1;
                        }
                        //if (b.part_type.indexOf("CarPartType_Mechanics") == 0) return 1;
                        //if (b.part_type.indexOf("CarPartType_Exterior") == 0) return -1;
                        //if (b.part_type.indexOf("CarPartType_Mechanics") == 0) return 1;
                        //return -1;
                    });
                }

                let prevtype = "";

                targetarray.forEach(part => {

                    if (this.isDealership() && !isSandBox && part.part_market != eCarCustomization.PartType.Oem) return;
                    //console.log(part.description);
                    const itemwrapper = document.createElement("div");
                    itemwrapper.classList.add("item-wrapper");

                    const item = document.createElement("div");

                    item.classList.add("item");
                    item.classList.add("focusable");
                    item.classList.add(part.part_market);
                    item.classList.add(part.__Type == eCarCustomization.ItemType.Rim ? "rim" : "part");

                    item.classList.toggle("installed", part.is_installed);
                    itemwrapper.classList.toggle("installed", part.is_installed);

                    item.part = part;

                    const indicator = document.createElement("div");
                    indicator.classList.add("indicator");
                    item.appendChild(indicator);



                    if (part.part_market == "aftermarket") {
                        const am_marker = document.createElement("div");
                        am_marker.classList.add("am-marker");
                        am_marker.textContent = engine.translate("lblAfterMarketShort");
                        item.appendChild(am_marker);
                    }

                    if (part.__Type == eCarCustomization.ItemType.Part) {
                        //const type_marker = document.createElement("div");
                        //type_marker.classList.add("type-marker");
                        //type_marker.textContent = part.part_type_text; //engine.translate("lblAfterMarketShort");
                        //item.appendChild(type_marker);

                        if (prevtype != part.part_type_text) {

                            const separator = document.createElement("div");
                            separator.classList.add("part-separator");
                            separator.textContent = engine.translate("lblPart" + part.part_type_text);
                            dfrag.appendChild(separator);

                            prevtype = part.part_type_text;
                        }
                    }

                    const label = document.createElement("div");
                    const l10nid = CUSTOMIZATION.getTranslation(part.description);
                    label.innerHTML = l10nid;
                    label.classList.add("label");
                    item.appendChild(label);

                    item.classList.toggle("forced", part.is_forced === true);

                    if (part.designs.length > 1) {
                        this.populateDesigns(part).then(designlist => {
                            itemwrapper.appendChild(designlist);

                            this.bindDesigns(part.__Type);
                        });
                    }

                    const incompatible_parts = CUSTOMIZATION.getIncompatibleParts(part);

                    if (incompatible_parts.length > 0) {

                        let should_disable = false;

                        const explanation = document.createElement("div");
                        explanation.classList.add("explanation");

                        incompatible_parts.forEach(incompatible_part => {
                            if (incompatible_part.is_installed && incompatible_part.__Type != part.__Type) {
                                console.log("Incompatible part installed:", incompatible_part.description, incompatible_part.__Type, incompatible_part.part_market);
                                should_disable = true;
                                const reason = document.createElement("div");
                                reason.classList.add("reason");
                                reason.classList.add(incompatible_part.__Type);
                                reason.innerHTML = CUSTOMIZATION.getTranslation(incompatible_part.description);
                                explanation.appendChild(reason);
                            }
                        });


                        if (should_disable) {
                            item.setAttribute("disabled", true);
                            itemwrapper.appendChild(explanation);
                        }
                    }


                    this.partSelectors.push(item);
                    itemwrapper.appendChild(item);

                    dfrag.appendChild(itemwrapper);
                });

                this.panelPartsList.appendChild(dfrag);

                if (parts_array.length > 0)
                    this.panelParts.classList.remove("collapsed");

                resolve();
                this.bindParts();


                this.clearAllScrollable();

                if (parts_array.length > 15) {
                    this.setupScrollbars();
                }

            });


        }

        getMaterialsOfPart(part) {
            const materials = CUSTOMIZATION.getMaterials(eCarCustomization.PartCategory.Parts);

            materials.filter(material => {
                part.part_path == material.part_path;
            });

            return
        }

        async populateMaterialsOfInstalledParts() {



            const installed_parts = CUSTOMIZATION.Parts.list.filter(part => part.is_installed);


            await installed_parts.forEachAsync(part => {
                CUSTOMIZATION.refreshMaterials(part);
            });

            const materials = CUSTOMIZATION.getMaterials(eCarCustomization.PartCategory.Parts);


            const installed_materials = materials.filter(material => {
                const found = installed_parts.find(part => part.part_path == material.part_path);
                return found != undefined;
            });

            this.populateMaterials(installed_materials);
        }

        populateDesigns(part) {
            return new Promise(resolve => {

                const container = document.createElement("div");
                container.classList.add("designs");

                part.designs.forEach(design => {

                    const item = document.createElement("div");

                    item.classList.add("item");
                    item.classList.add("focusable");
                    item.classList.add("design");

                    item.classList.toggle("installed", design.is_installed);
                    item.part = part;
                    item.design = design;

                    //console.log(part.item.key, design.item.key);

                    const indicator = document.createElement("div");
                    indicator.classList.add("indicator");

                    item.appendChild(indicator);

                    const label = document.createElement("div");
                    label.innerHTML = CUSTOMIZATION.getTranslation(design.item.description);
                    label.classList.add("label");

                    item.appendChild(label);

                    container.appendChild(item);
                });
                resolve(container);
            });

        }

        materialPage = {
            [eCarCustomization.MaterialLocation.Exterior]: 0,
            [eCarCustomization.MaterialLocation.Interior]: 0
        };

        get activeMaterialPage() {
            const page = this.materialPage[this.activeMaterialLocation] || 0;


            return page;
        }

        set activeMaterialPage(page) {
            this.materialPage[this.activeMaterialLocation] = page;
        }

        materialsPerPage = 16;

        get activeMaterialPager() {
            if (!this.activeMaterialLocation) return undefined;
            return q(`.pagination.${this.activeMaterialLocation}`, this.btnGroupPartCategory);
        }

        populatePager(material_count) {
            if (this.activeMaterialLocation == "") return;
            const targetpager = q(`.pagination.${this.activeMaterialLocation}`, this.btnGroupPartCategory);
            targetpager.innerHTML = "";

            const number_of_pages = Math.ceil(material_count / this.materialsPerPage);
            //console.warn("Pages", number_of_pages, targetpager);

            if (number_of_pages > 1) {
                this.btnGroupPartCategory.classList.add("has-pagination");

            } else {
                this.btnGroupPartCategory.classList.remove("has-pagination");
            }

            for (let i = 0; i < number_of_pages; i++) {
                const btn = document.createElement("div");
                btn.classList.add("focusable");
                btn.classList.toggle("selected", i == this.activeMaterialPage);
                btn.dataset.page = i;
                btn.innerHTML = i + 1;
                targetpager.appendChild(btn);
            }

            qevAll(".pagination > div", BTNEVENTS, (ev) => {

                if (this.activeMaterialPage == Number(ev.target.dataset.page)) {
                    return;
                }

                this.btnGroupPartCategory.disable();

                this.panelMain.classList.add("loading");





                q(`.pagination.${this.activeMaterialLocation} .selected`, this.btnGroupPartCategory).classList.remove("selected");

                ev.target.classList.add("selected");

                this.MaterialEditors.forEach(editor => {
                    editor.classList.remove("selected");
                    editor.classList.remove("collapsed");
                });


                this.panelMain.dataset.mode = "";

                this.activeMaterialPage = Number(ev.target.dataset.page);
                this.populateMaterials(this._lastMaterialArray, true);
                //this.panelMain.classList.add("collapsed");

                waitForFrames(() => {
                    //this.panelMain.classList.remove("collapsed");
                }, 3);

            }, this.btnGroupPartCategory);

            // $("#categoryselector .pagination")
            //        for()
        }

        _lastMaterialArray;
        _dfrag;


        populateMaterials(materials_array, skip_pager = false) {



            this._lastMaterialArray = materials_array;

            materials_array = materials_array.filter(material => { return !material.is_hidden });

            return new Promise((resolve) => {
                this.panelMaterials.classList.add("collapsed");
                this.panelMaterialsList.innerHTML = "";

                this.panelMaterials.classList.toggle("no-materials", materials_array.length == 0);

                if (materials_array.length == 0) {
                    this.panelMaterials.classList.add("collapsed");
                    resolve();
                    return;
                }

                this._dfrag = new DocumentFragment();

                //let materialcount = 0;

                const materialpage = this.activeMaterialPage;

                if (!skip_pager) {
                    this.populatePager(materials_array.length);
                }



                const start_from = materialpage * this.materialsPerPage;
                const end_at = Math.min(start_from + this.materialsPerPage, materials_array.length);

                // console.warn("starting from", materialpage * this.materialsPerPage, this.activeMaterialPage, this.materialsPerPage, end_at);

                // console.warn("Populating", materials_array.length);
                let index = 0;

                const added_materials = [];

                for (let i = start_from; i < end_at; i++) {
                    const material = materials_array[i];

                    if (added_materials.findIndex(existing_material =>
                        existing_material.description == material.description
                    ) > -1) {
                        continue;
                    }


                    /** @type MaterialEditor */
                    const editor = document.createElement("ks-materialeditor");
                    editor.classList.add("prerender");
                    editor.ParentPage = this;
                    editor.IsLimited = this.isDealership() && !isSandBox;
                    editor.Material = material;
                    editor.onEditorRendered = () => {
                        if (i == end_at - 1) {
                            // console.warn("Last Editor");
                            engine.trigger(EngineEvents.PaintShop.LastEditorRendered);
                        }
                    };

                    waitForFrames(() => {
                        this.panelMaterialsList.appendChild(editor);
                        //console.warn("added", material.description);
                        //this._dfrag.appendChild(editor);
                    }, index);


                    added_materials.push(material);

                    index++;


                }


                //his.panelMaterialsList.appendChild(this._dfrag);


                // console.warn(this.MaterialEditors.length);
                if (materials_array.length > 0)
                    waitForFrames(() => {
                        this.panelMaterials.classList.remove("collapsed");
                    }, 3);

                resolve();
            });
        }

        updatePartStatus(item_type) {
            qAll(".item", this.panelPartsList).forEach(i => {
                if (i.part) {
                    const installed = i.part.is_installed;
                    i.classList.toggle("installed", installed);
                    i.closest(".item-wrapper").classList.toggle("installed", installed);
                    this.updateDesignStatus();
                }
            });

            if (item_type == eCarCustomization.ItemType.Part) {
                this.populateMaterialsOfInstalledParts();
            }
        }

        updateDesignStatus() {
            qAll(".item-wrapper .designs .item", this.panelPartsList).forEach(i => {
                i.classList.toggle("installed", i.design.is_installed);
            });
        }

        bindDesigns(category) {
            qevAll(".item-wrapper .designs .item", "click sn:enter-down", (ev) => {

                if (ev.currentTarget.hasAttribute("disabled")) {
                    return;
                }

                const part = ev.currentTarget.part;
                const design = ev.currentTarget.design;

                if (category == eCarCustomization.ItemType.Rim) {
                    if (ev.currentTarget.classList.contains("installed")) return;

                    CUSTOMIZATION
                        .setRimDesign(design)
                        .then(() => {
                            CUSTOMIZATION
                                .refreshMaterials(CUSTOMIZATION.installedRim)
                                .then(result => {
                                    this.populateMaterials(CUSTOMIZATION.getMaterials(eCarCustomization.PartCategory.Rims));
                                    this.updateDesignStatus();
                                    this.markDirty();

                                });
                            //this.MaterialEditors.forEach(editor => editor.update());
                        }).catch(() => { console.warn("Rejected mismatched rim design response"); });
                }

                if (category == eCarCustomization.ItemType.Part) {
                    CUSTOMIZATION.setPartDesign(part, design).then(() => {
                        this.populateMaterialsOfInstalledParts();
                        this.updateDesignStatus();
                        this.markDirty();

                    });
                }

            }, this.panelMain);
        }

        bindParts() {

            qevAll(".item", "click sn:enter-down", (ev) => {

                if (ev.currentTarget.hasAttribute("disabled")) {
                    return;
                }

                const part = ev.currentTarget.part;
                //console.log(part.description, part.__Type);

                if (part.is_forced === true) {
                    return;
                }

                if (part.__Type == eCarCustomization.ItemType.Rim) {
                    if (ev.currentTarget.classList.contains("installed")) return;

                    part.designs.find(i => i.is_installed);

                    CUSTOMIZATION.installRim(part).then(() => {
                        CUSTOMIZATION
                            .refreshMaterials(CUSTOMIZATION.installedRim)
                            .then(result => {
                                this.populateMaterials(CUSTOMIZATION.getMaterials(eCarCustomization.PartCategory.Rims));
                                this.updateDesignStatus();
                                this.markDirty();
                            });
                        //CUSTOMIZATION.refreshMaterials(eCarCustomization.PartCategory.Rims, "");
                    }).catch(() => { console.warn("Rejected mismatched rim response"); });

                    //this.populateDesigns(part.designs);

                }

                if (part.__Type == eCarCustomization.ItemType.Part) {

                    CUSTOMIZATION
                        .togglePart(part, !part.is_installed)
                        .then(() => {
                            //console.log(part.is_installed);
                        }).catch(() => {
                            console.warn("Rejected mismatched part response");
                        });

                }

                this.updatePartStatus(part.__Type);
                this.markDirty();

            }, this.panelPartsList);

            qevAll(".item", "mouseenter focus", (ev) => {
                ev.currentTarget.part;




            }, this.panelPartsList);

        }


        onAfterRenderControlHints(controlhints) {

            this.btnBack = q(".back", controlhints);
            this.btnApply = q(".apply", controlhints);
            this.btnCancel = q(".cancel", controlhints);
            this.btnSceneOptions = q("#btnSceneControls", controlhints);
            this.btnCarControls = q("#btnCarControls", controlhints);
            this.btnAutoSwitchCamera = q("#btnAutoSwitchCamera", controlhints);

            let sender = this;

            function back() {

                CUSTOMIZATION.saveFinalCar(sender.activeFinalCarKey).then(result => {

                    if (sender.isDealership() || isSandBox & sender.hasAttribute("singleplayer")) {
                        SHOWROOM.showExterior();
                        ksUI$1.exitToReturnPageNoLoading(false);
                    } else {
                        ksUI$1.requestGoBack(eGameModeSelection.BackFrom.Paintshop);
                    }
                }).catch(error => {
                    console.log(error);
                    console.error("Cannot save final car", sender.activeFinalCarKey);
                });

            }

            const changePage = function (page, path) {
                if (sender.isDirty) {

                    sender.pageModal.Show({
                        title: "lblChangesDetected",
                        message: "msgChangesWarning",
                        confirm: "btnApply"
                    });

                    sender.pageModal.onDiscard = () => {
                        sender.reset();
                        back();

                    };

                    sender.pageModal.onConfirm = () => {
                        sender.save();
                        back();

                    };
                } else {
                    back();

                }
            };

            this.btnBack.onPressed = () => {

                ksUI$1.menuState.overrideShowcaseCamera(false);

                console.trace("Paintshop back pressed");
                //            if (!this.classList.contains("show-carcontrol")) {
                changePage();
                // } else {
                //     this.classList.remove("show-carcontrol");
                // }
            };

            // if (!this.isDealership()) {
            // $.q("div", this.btnBack).setAttribute("data-l10n-id", "btnExit");
            // }

            this.btnApply.onPressed = () => this.save();
            this.btnCancel.onPressed = () => this.reset();

            this.btnCarControls.onPressed = () => {
                const showing = this.classList.toggle("show-carcontrol");
                if (showing) {
                    this.setupNavigation();
                    this.controlCar.show();
                }
                //this.dataset.mode = this.dataset.mode == "carcontrol" ? "" : "carcontrol";
            };

            this.btnSceneOptions.onPressed = () => {
                const showing = this.classList.toggle("show-scenecontrol");
                if (showing) {
                    this.setupNavigation();
                    this.controlScene.show();
                }
                //this.dataset.mode = this.dataset.mode == "sceneoptions" ? "" : "sceneoptions";
            };

            if (this.isGarage()) ;

            if (this.documentBody.classList.contains("intro-page")) {
                this.btnAutoSwitchCamera.toggle(true, false);
            }
        }

        reset() {
            let targetkey = CurrentCar.state == eCarSelection.State.Dealership ? CurrentCar.model.name : CurrentCar.model.car_guid;
            console.log("Resetting", targetkey);
            CUSTOMIZATION.reset(targetkey, CurrentCar.state == eCarSelection.State.Dealership).then(() => this.clearDirty());
        }

        save() {

            let targetkey = CurrentCar.state == eCarSelection.State.Dealership ? CurrentCar.model.car_guid : this.activeFinalCarKey;
            console.log("Saving", targetkey);
            CUSTOMIZATION.saveFinalCar(targetkey).then(() => {
                this.clearDirty();
            });
        }

        markDirty() {
            this.isDirty = true;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.removeAttribute("disabled");
            });
        }

        clearDirty() {
            this.isDirty = false;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.setAttribute("disabled", true);
            });
        }

        evaluateAvailableCategories() {
            qAllArray(".category", this.btnGroupPartCategory).forEach(item => {
                const part = item.dataset.part;
                const location = item.dataset.location;
                const hasmaterials = CUSTOMIZATION.getMaterials(part, location).length > 0;

                const hasparts =
                    this.isDealership() && !isSandBox ?
                        CUSTOMIZATION.Parts.list.length > 0 && CUSTOMIZATION.Parts.list.find(i => i.part_market == "oem")
                        :
                        CUSTOMIZATION.Parts.list.length > 0;

                const hasrims = CUSTOMIZATION.Rims.list.length > 0;

                let shouldshow = true;

                if (part == eCarCustomization.PartCategory.Bodywork) {
                    shouldshow = hasmaterials;
                }

                if (part == eCarCustomization.PartCategory.Rims) {
                    shouldshow = hasrims || hasmaterials;
                }

                if (part == eCarCustomization.PartCategory.Parts) {
                    shouldshow = hasparts || hasmaterials;
                }

                item.classList.toggle("hidden", !shouldshow);
            });
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            console.trace("Init paintshop");

            this.documentBody.classList.add("paintshop");

            this.btnGroupPartCategory = q("#partcategory", this);

            this.labelCategory = q(".label-categoryselector", this);
            this.rowControls = q(".row.controls", this);

            this.panelMain = q(".mainpanel", this);

            this.panelMaterials = q(".materials", this.panelMain);
            this.panelParts = q(".parts", this.panelMain);
            this.panelDesigns = q(".designs", this.panelMain);
            this.panelCompounds = q(".compounds", this.panelMain);

            this.panelMaterialsList = q(".list", this.panelMaterials);
            this.panelPartsList = q(".list", this.panelParts);
            this.panelDesignsList = q(".list", this.panelDesigns);
            this.panelCompoundsList = q(".list", this.panelCompounds);

            ksUI$1.menuState.toggleMouseHover(false);

            this.mapElementById("labelHeader");
            this.mapElementById("controlCar");
            this.mapElementById("controlScene");

            this.mapElementById("txtCarNumber");

            let title = this.getAttribute("title");

            this.returnPath = this.getAttribute("returnPath");

            if (title) {
                this.labelHeader.dataset.l10nId = title;
            }

            CUSTOMIZATION.beforeInitialize = () => {
                this.classList.remove("show-materialeditor");
                this.classList.remove("show-largematerialeditor");
            };

            CUSTOMIZATION.onInitialize = (final_car_data) => {

                for (const x in this.materialPage) {
                    this.materialPage[x] = 0;
                }

                this.btnGroupPartCategory.classList.remove("has-pagination");



                console.log("CarCustomizationManager initialized");
                this.assignModel(final_car_data, "FinalCar");



                [
                    this.labelCategory,
                    this.panelMaterialsList,
                    this.panelPartsList,
                    this.panelCompoundsList
                ].forEach(
                    elem => {
                        elem.innerHTML = "";
                        elem.parentElement.classList.add("collapsed");
                    }
                );

                const currentmechpreset = FinalCar.mechanical_presets.find(preset => preset.item.key == FinalCar.selection.selected_mechanical_path);

                this.assignModel(currentmechpreset, "CurrentMechPreset");

                waitForFrames(() => {
                    this.bindMechPresets();
                    this.bindVisualPresets();
                    this.txtCarNumber.value = final_car_data.car_number;
                }, 3);

                waitForFrames(() => {
                    this.evaluateAvailableCategories();
                }, 1);


                this.btnGroupPartCategory.classList.toggle("hidden", !CUSTOMIZATION.ActiveVisual.is_customizable);

                this.btnGroupPartCategory.clearSelection();
            };

            VEHICLES.getCurrent()
                .then((data) => {
                    CUSTOMIZATION.initialize(data.state == eCarSelection.State.Dealership ? data.model.name : "");
                });

            ksUI$1.menuState.overrideShowcaseCamera(true);

        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();
            console.log("Removed PaintShop");
            this.clearAssignedModels();
            CUSTOMIZATION.clearHandlers();
            this.documentBody.classList.remove("paintshop");
            ksUI$1.menuState.overrideShowcaseCamera(false, false);
            delete window["pageData"];
        }

    }
    engine.on("MenuStateInit", () => {
        ksUI$1.registerModule('ks-page-paintshop', PaintShopPage);
    });

    var template$1m = "<div class=\"component-body\">\r\n\r\n    <div class=\"panel openMode\"></div>\r\n    <div class=\"panel openMode on\"></div>\r\n    <div class=\"panel careerMode\"></div>\r\n    <div class=\"panel careerMode on\"></div>\r\n\r\n    <div id=\"overlay\"></div>\r\n\r\n    <ks-btnpanel id=\"btnCareerMode\" data-mode=\"career\" class=\"focusable half translatefromleft\" persist-handler>\r\n        <div slot=\"title\" data-l10n-id=\"lblCareerMode\"></div>\r\n        <div slot=\"subtitle\" data-l10n-id=\"lblCareerModeDescription\">This is the career mode with credits and licenses and XP and levels and all that stuff!</div>\r\n    </ks-btnpanel>\r\n\r\n    <ks-btnpanel id=\"btnSandboxMode\" data-mode=\"sandbox\" class=\"focusable half translatefromleft\" persist-handler>\r\n        <div slot=\"title\" data-l10n-id=\"lblSandboxMode\"></div>\r\n        <div slot=\"subtitle\" data-l10n-id=\"lblSandboxModeDescription\"></div>\r\n    </ks-btnpanel>\r\n\r\n        <div id=\"hitboxCareer\" class=\"hitbox\" data-mode=\"career\"></div>\r\n    <div id=\"hitboxSandbox\" class=\"hitbox\" data-mode=\"sandbox\"></div>\r\n\r\n</div>";

    class PlayerModeSelectionPage extends KsHTMLElement {

        /** @type MessageHandler */
        GameEconomyClient;

        /** @type {Btnbasic} */
        btnBack;

        /** @type {Btnbasic} */
        btnCareerMode;

        /** @type {Btnbasic} */
        btnSandboxMode;


        hitboxCareer;
        hitboxSandbox;

        get isFirstStart() {
            return this.hasAttribute("firststart");
        }

        filters = {
        }

        PersonalData;

        constructor() {

            super();
            this.template = template$1m;
            this.delayedInit = true;
            this._isnavigable = true;
            this.shouldRenderControlHints = true;
            this._exposeAsActivePage = true;

        }

        bindControls() {
            this.btnCareerMode.onPressed = (sender, e) => {
                this.GameEconomyClient.request("PlayerMode", { is_sandbox: false }, (data) => {

                    localStorage.setItem("force-playermodeselection", "false");

                    if (data.is_new_career) {
                        console.log("New career");
                        localStorage.setItem("mode_selection", "main");
                        ksUI$1.goTo("intro.html", "firststart/tutorial");
                    } else {
                        ksUI$1.goTo("menu.html", "main/main");
                    }

                });
            };

            this.btnSandboxMode.onPressed = (sender, e) => {
                this.GameEconomyClient.request("PlayerMode", { is_sandbox: true }, (data) => {

                    localStorage.setItem("force-playermodeselection", "false");

                    if (data.new_is_sandbox) {
                        ksUI$1.goTo("menu.html", "main/main");
                    }
                });
            };

            qevAll("ks-btnpanel", "mouseenter focus", (e) => {
                this.dataset.mode = e.target.dataset.mode;
            }, this);

            qevAll("ks-btnpanel", "mouseleave", (e) => {
                delete this.dataset.mode;
            }, this);

            qevAll(".hitbox", "mouseenter", (e) => {
                this.dataset.mode = e.target.dataset.mode;
            }, this);

            qevAll(".hitbox", "mouseleave", (e) => {
                delete this.dataset.mode;
            }, this);

            qevAll(".hitbox", "click", (e) => {
                q(`ks-btnpanel[data-mode='${e.target.dataset.mode}']`).onPressed();
            }, this);

        }

        onRemovedFromDOM() {
            delete this.dataset.mode;
            this.documentBody.classList.remove("playermodeselection");
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            console.log("Player Mode Selection");

            this.GameEconomyClient = new MessageHandler("GameEconomyClient");

            this.mapElementById("btnCareerMode");
            this.mapElementById("btnSandboxMode");


            this.documentBody.classList.add("playermodeselection");

        }
    }

    ksUI$1.registerModule('ks-page-playermodeselection', PlayerModeSelectionPage);

    class FirstStartPage extends KsHTMLElement {

        /** @type CarSelectionManager */
        CarSelection;

        tutorial;

        constructor() {
            super();
            this.template = template$1A;
            this._isnavigable = true;
            this.delayedInit = true;
            this.shouldRenderControlHints = false;
        }

        bindControls() {
            engine.on("OnFirstTutorialFinished", () => {
                ksUI$1.changePage("firststart/brandselection");
            });

            engine.on("OnPlayerInfoFinished", () => {
                ksUI$1.menuState.storeOrigin().save();
                //ksUI.changePage("firststart/playermodeselection");

                if (localStorage.getItem("playermodeset") !== "true") {

                    ksUI$1.request("GameEconomyClient", "PlayerMode",
                        (response) => {
                            localStorage.setItem("playermodeset", "true");
                            console.log("Set to open mode");

                            ksUI$1.goTo("menu.html", "main/main");
                        },
                        {
                            is_sandbox: true
                        }
                    );
                }
            });

            engine.on("OnModeSelected", () => {
            });

            engine.on("OnCarPurchased", () => {
                ksUI$1.goTo("menu.html", "main/main");
            });
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.CarSelection = new CarSelectionManager(eClientCommands.Mode.Single, this);

            console.log("First Start page");
            ksUI$1.menuState.toggleMouseHover(true);

            this.mapElementById("tutorial");

            this.documentBody.classList.add("firststart");


            this.assignModel(this.CarSelection.Car, "CurrentCar");
            this.CarSelection.getCurrent().catch(error => {
                console.warn("Error getting current car", error.response);
            });

            this.CarSelection.dataFilters.ownershipState = eCarSelection.State.FirstPurchace;
            this.CarSelection.updateDataFilters();

        }

        onRemovedFromDOM() {
            console.log("First Start - removed");
            this.documentBody.classList.remove("firststart");
            ksUI$1.menuState.toggleMouseHover(false);
        }

    }

    ksUI$1.registerModule('ks-page-firststart', FirstStartPage);

    class IntroPage extends KsHTMLElement {

        locked = false;

        /** @type SplashPage */
        splash;
        firstRun = true;
        start;

        debounce;

        constructor() {
            super();
            this.template = template$1C;
            this._isnavigable = true;
            this.delayedInit = false;
            this._exposeAsActivePage = true;
            this.shouldRenderControlHints = true;
        }


        bindControls() {

        }

        startSplash() {
            this.mapElementById("splash");


            if (this.splash) {
                console.log("Starting splash sequence");
                document.body.classList.remove("pre-splash");
                this.splash.onProceed = (step) => {

                    if (step == "end") {


                        // if (!this.firstRun) {
                        //     $.q("body").classList.remove("transition");
                        // }
                        engine.on("OnBackendConnectionChanged", this.OnBackendConnectionChanged);

                        if (!isBackendConnected && !ksUIConfig.ignorebackend) {
                            this.OnBackendConnectionChanged(false);
                            return;
                        }

                        q(".component-body", this.splash).addEventListener("transitionend", (e) => {
                            console.log("transitionend");
                            if (e.target != q(".component-body", this.splash)) {
                                return;
                            }

                            console.log("Splash transition finished");

                            ksUI$1.UIUtilityCommand(eUIUtilityCommandType.OnIntroEnds);

                            //this.exitSplash();

                            // if (this.firstRun) {
                            //     console.log("Moving to tutorial");
                            //     ksUI.changePage("firststart/tutorial", true);
                            // } else {
                            //     console.log("Sending OnIntroEnds");
                            //     ksUI.UIUtilityCommand(eUIUtilityCommandType.OnIntroEnds);
                            //     //$.waitForFrames(() => ksUI.goTo("menu.html"), 1);
                            // }
                        });
                    }
                };
            } else {
                console.error("No splash page");
            }
        }

        exitSplash() {
            if (this.firstRun) {
                console.log("Exiting to first start");
                waitForFrames(() => ksUI$1.changePage("firststart/tutorial", true), 1);
            } else {
                console.log("Exiting from splash");
                ksUI$1.UIUtilityCommand(eUIUtilityCommandType.OnIntroEnds);
            }
        }

        OnBackendConnectionChanged(state) {
            if (ksUIConfig.ignorebackend) return;
            // if (!state) {
            //     rootModal().Show({
            //         buttons: 0x100,
            //         title: "lblOfflineMode",
            //         extraCssClass: "backend-error",
            //         message: "msgContinueOfflineMode",
            //         confirm: "btnContinue"
            //     }).onConfirm = () => {
            //         ksUI.goTo("menu.html", "main/main");
            //     };
            // }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            console.log("Intro page");

            ksUI$1.UIUtilityCommand(eUIUtilityCommandType.OnIntro);

            ksUI$1.menuState.toggleMouseHover(true);

            this.mapElementById("tutorial");

            this.dataset.mode = "splash";
        }

        retryAttempts = 0;

        accountInfoHandler;

        launchErrorPopup() {
            window.rootModal().Show({
                buttons: 0x100,
                title: "lblError",
                extraCssClass: "backend-error",
                message: "msgUnableToGetAProperResponse",
                confirm: "mainMenuQuit"
            }).onConfirm = () => {
                ksUI$1.requestNoResponse("GameMode", "QuitGame");
            };
        }

        onRemovedFromDOM() {
            console.log("Intro page - removed");
            ksUI$1.menuState.toggleMouseHover(false);
            if (this.accountInfoHandler) {
                this.accountInfoHandler.clear();
            }
        }

    }
    engine.on("MenuStateInit", () => {
        ksUI$1.registerModule('ks-page-intro', IntroPage);
    });

    var template$1l = "<div class=\"body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnQuit\" data-tooltip=\"tooltipQuit\" class=\"focusable delayedInit\">\r\n                <div slot=\"name\" data-l10n-id=\"mainMenuQuit\"></div>\r\n            </ks-btnbasic>\r\n\r\n            <!-- <ks-btnbasic class=\"focusable\" id=\"btnModeSelection\" path=\"main/playermodeselection\" persist-handler>\r\n                <div slot=\"name\" data-l10n-id=\"lblModeSelector\">MODE SELECTION</div>\r\n            </ks-btnbasic> -->\r\n\r\n        </div>\r\n\r\n        <div class=\"group end\">        \r\n            <ks-btnbasic id=\"btnSceneControls\" class=\"focusable btnSceneControls\" data-tooltip=\"lblSceneControls\" data-tooltip-css-class=\"inline\" toggle>\r\n                <div slot=\"icon\"></div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnCarControls\" class=\"focusable\" data-tooltip=\"lblCarControls\" data-tooltip-css-class=\"inline\" toggle>\r\n                <div slot=\"icon\"></div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"full\">\r\n    </ks-pageheader>\r\n\r\n    <!-- <ks-playerprogress></ks-playerprogress> -->\r\n\r\n    <ks-showroomscenecontrol id=\"controlScene\"></ks-showroomscenecontrol>\r\n\r\n    <ks-showroomcarcontrol id=\"controlCar\" data-mode=\"electrics\"></ks-showroomcarcontrol>\r\n\r\n    <div class=\"wrapper\">\r\n\r\n        <div id=\"wrapperMenu\">\r\n            <div id=\"panelMenu\">\r\n                <div class=\"controltip\">\r\n\r\n                </div>\r\n                <ks-btnbasic id=\"btnDrive\" data-tooltip=\"tooltipDrive\" class=\"focusable defaultfocus\" data-mode=\"drive\" data-sn-left=\"#btnSettings\" data-sn-down=\"#btnSinglePlayer\" toggle-group=\"options\" toggle allownonetoggled>\r\n                    <div slot=\"name\" data-l10n-id=\"mainMenuDrive\"></div>\r\n                </ks-btnbasic>\r\n\r\n                <!-- <ks-btnbasic\r\n                    id=\"btnDriveAlt\"\r\n                    class=\"focusable defaultfocus\"\r\n                    data-mode=\"drive\"\r\n                    data-sn-left=\"#btnSettings\"\r\n                    data-sn-down=\"#btnSpecialEvents\"\r\n                    toggle-group=\"options\" toggle allownonetoggled>\r\n                    <div slot=\"name\" data-l10n-id=\"mainMenuDrive\"></div>\r\n                </ks-btnbasic> -->\r\n\r\n                <ks-btnbasic id=\"btnVehicles\" data-tooltip=\"tooltipVehicles\" class=\"focusable\" data-mode=\"vehicles\" toggle-group=\"options\" toggle allownonetoggled>\r\n                    <div slot=\"name\" data-l10n-id=\"mainMenuVehiclesHub\"></div>\r\n                </ks-btnbasic>\r\n                <ks-btnbasic id=\"btnAcademy\" data-tooltip=\"tooltipAcademy\" class=\"focusable\" data-mode=\"academy\" toggle-group=\"options\" toggle allownonetoggled>\r\n                    <div slot=\"name\" data-l10n-id=\"mainMenuDrigingAcademy\"></div>\r\n                </ks-btnbasic>\r\n                <ks-btnbasic id=\"btnDriver\" data-tooltip=\"tooltipDriver\" class=\"focusable\" data-mode=\"driver\" toggle-group=\"options\" toggle allownonetoggled>\r\n                    <div slot=\"name\" data-l10n-id=\"mainMenuDriverCenter\"></div>\r\n                </ks-btnbasic>\r\n                <ks-btnbasic id=\"btnGallery\" data-tooltip=\"tooltipGallery\" class=\"focusable\" data-mode=\"gallery\" goto=\"gallery.html\" path=\"gallery/replays\" toggle-group=\"options\" toggle allownonetoggled>\r\n                    <div slot=\"name\" data-l10n-id=\"mainMenuGallery\"></div>\r\n                </ks-btnbasic>\r\n                <ks-btnbasic id=\"btnSettings\" data-tooltip=\"tooltipSettings\" class=\"focusable\" data-mode=\"settings\" data-sn-right=\"#btnDrive\" data-sn-down=\"#btnSettingsControls\" toggle-group=\"options\" toggle allownonetoggled>\r\n                    <div slot=\"name\" data-l10n-id=\"mainMenuSettings\"></div>\r\n                </ks-btnbasic>\r\n                <div class=\"controltip\">\r\n\r\n                </div>\r\n            </div>\r\n\r\n            <div id=\"panelSubmenus\">\r\n                <div class=\"drive\">\r\n                    <ks-btnpanel id=\"btnSinglePlayer\" data-tooltip=\"tooltipSinglePlayer\" class=\"focusable half translatefromleft\" goto=\"singleplayer.html\" path=\"main/main\">\r\n                        <div slot=\"title\" data-l10n-id=\"lblSinglePlayer\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnMultiplayer\" data-tooltip=\"tooltipMultiplayer\" class=\"focusable half translatefromright\" goto=\"multiplayer.html\" path=\"multiplayer/hub\">\r\n                        <div slot=\"title\" data-l10n-id=\"lblMultiPlayer\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnOpenWorld\" data-tooltip=\"tooltipFreeRoam\" class=\"focusable translatefrombottom\">\r\n                        <div slot=\"title\" data-l10n-id=\"lblOpenWorld\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnSpecialEvents\" data-sn-up=\"#btnDriveAlt\" class=\"focusable half translatefrombottom\" goto=\"multiplayer.html\" path=\"multiplayer/specialevents\">\r\n                        <div slot=\"title\" data-l10n-id=\"panelSpecialEvents\"></div>\r\n                    </ks-btnpanel>\r\n\r\n                </div>\r\n\r\n                <div class=\"vehicles\">\r\n                    <ks-btnpanel id=\"btnGarage\" data-tooltip=\"tooltipGarage/tooltipMyCars\" class=\"focusable half translatefromleft\" goto=\"vehicles.html\" path=\"garage/brandselection\">\r\n                        <div slot=\"title\" data-bind-if=\"!{{ModelUIState}}.is_sandbox\" data-l10n-id=\"panelYourGarage\"></div>\r\n                        <div slot=\"title\" data-bind-if=\"{{ModelUIState}}.is_sandbox\" data-l10n-id=\"lblMyCars\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnDealership\" data-tooltip=\"tooltipDealership/tooltipCarHub\" class=\"focusable half translatefromright\" goto=\"vehicles.html\" path=\"dealership/brandselection\">\r\n                     \r\n                        <div slot=\"title\" data-bind-if=\"!{{ModelUIState}}.is_sandbox\" data-l10n-id=\"panelDealership\"></div>\r\n                        <div slot=\"title\" data-bind-if=\"{{ModelUIState}}.is_sandbox\" data-l10n-id=\"lblCarHub\"></div>\r\n\r\n                        <div slot=\"title\" data-l10n-id=\"\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnPaintshop\" data-tooltip=\"tooltipPaintshop\" class=\"focusable translatefrombottom\">\r\n                        <div slot=\"title\" data-l10n-id=\"mainMenuCustomizeVehicle\"></div>\r\n                    </ks-btnpanel>\r\n\r\n                </div>\r\n\r\n                <div class=\"academy\">\r\n                    <ks-btnpanel id=\"btnLicenses\" data-tooltip=\"tooltipLicenses\" class=\"focusable\" goto=\"drivingacademy.html\" path=\"main/main\">\r\n                        <div slot=\"title\" data-l10n-id=\"lblDrivingLicenses\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnTutorials\" data-tooltip=\"tooltipTutorials\" class=\"focusable\" disabled=\"disabled\">\r\n                        <div slot=\"title\" data-l10n-id=\"mainMenuTutorials\"></div>\r\n                    </ks-btnpanel>\r\n                </div>\r\n\r\n                <div class=\"driver\">\r\n                    <ks-btnpanel id=\"btnProfile\" data-tooltip=\"tooltipProfile\" class=\"focusable\" goto=\"drivercenter.html\" path=\"drivercenter/main\">\r\n                        <div slot=\"title\" data-l10n-id=\"labelProfileUpper\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnStatistics\" class=\"focusable\" disabled=\"disabled\">\r\n                        <div slot=\"title\" data-l10n-id=\"labelStatisticsUpper\"></div>\r\n                    </ks-btnpanel>\r\n                </div>\r\n\r\n                <div class=\"settings\">\r\n                    <ks-btnpanel id=\"btnSettingsControls\" data-tooltip=\"tooltipSettingsControls\" class=\"focusable\" goto=\"settings.html\" path=\"settings/controls\" storeorigin>\r\n                        <div slot=\"title\" data-l10n-id=\"settingsControls\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnSettingsVideo\" data-tooltip=\"tooltipSettingsVideo\" class=\"focusable half\" goto=\"settings.html\" path=\"settings/video\">\r\n                        <div slot=\"title\" data-l10n-id=\"settingsVideo\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnSettingsAudio\" data-tooltip=\"tooltipSettingsAudio\" class=\"focusable half\" goto=\"settings.html\" path=\"settings/audio\">\r\n                        <div slot=\"title\" data-l10n-id=\"settingsAudio\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnSettingsGeneral\" data-tooltip=\"tooltipSettingsGeneral\" class=\"focusable half\" goto=\"settings.html\" path=\"settings/gameplay-hud\">\r\n                        <div slot=\"title\" data-l10n-id=\"settingsGameplay\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnSettingsCredits\" data-tooltip=\"tooltipSettingsCredits\" class=\"focusable quarter\" goto=\"settings.html\" path=\"settings/credits\">\r\n                        <div slot=\"title\" data-l10n-id=\"settingsCredits\"></div>\r\n                    </ks-btnpanel>\r\n                    <ks-btnpanel id=\"btnSettingsEULA\" data-tooltip=\"tooltipSettingsEULA\" class=\"focusable quarter\" disabled=\"disabled\">\r\n                        <div slot=\"title\" data-l10n-id=\"settingsEULA\"></div>\r\n                    </ks-btnpanel>\r\n                </div>\r\n\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n\r\n\r\n</div>";

    class MainPage extends KsHTMLElement {


        /** @type {HTMLDivElement} */
        panelMenu;

        /** @type {HTMLDivElement} */
        panelSubmenus;

        /** @type {Btnbasic} */
        btnDrive;

        /** @type {Btnbasic} */
        btnOpenWorld;

        /** @type {Btnbasic} */
        btnPaintshop;

        /** @type {Btnbasic} */
        btnQuit;

        /** @type {Btnbasic} */
        btnSceneControls;

        /** @type {Btnbasic} */
        btnCarControls;

        /** @type {Btnbasic} */
        btnDealership;

        /** @type {Btnbasic} */
        btnSpecialEvents;

        /** @type {ShowroomSceneControl} */
        controlScene;

        /** @type {ShowroomCarControl} */
        controlCar;

        /** @type {HTMLDivElement} */
        wrapperMenu;

        constructor() {
            super();
            this.template = template$1l;
            this.delayedInit = true;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this.shouldRenderControlHints = true;
        }

        _lastfocused;

        handleQuit() {

            this._lastfocused = document.activeElement;

            //this.storeCurrentlyFocused();

            this.pageModal.onConfirm = () => {
                q("body").classList.remove("loaded");
                ksUI$1.requestNoResponse("GameMode", "QuitGame");
            };

            this.pageModal.onHide = () => {

                waitForFrames(() => {
                    this._lastfocused?.focus();
                    //this.restoreLastFocused();
                });
            };

            this.pageModal.Show({
                type: eModalDialogTypes.Warning,
                title: "lblExitGame",
                message: "msgAreYouSureExitGame",
                buttons: 0x101
            });


        }

        onAfterRenderControlHints(controlhints) {
            this.mapElementById("btnQuit", controlhints);
            this.mapElementById("btnSceneControls", controlhints);
            this.mapElementById("btnCarControls", controlhints);

            this.btnQuit.onPressed = (sender, e) => {
                this.handleQuit();
            };

            this.btnSceneControls.onPressed = () => {
                const showing = this.classList.toggle("show-scenecontrol");
                if (showing) {
                    this.setupNavigation();
                    this.controlScene.show();
                }
                //this.dataset.mode = this.dataset.mode == "carcontrol" ? "" : "carcontrol";
            };

            this.btnCarControls.onPressed = () => {
                const showing = this.classList.toggle("show-carcontrol");
                if (showing) {
                    this.setupNavigation();
                    this.controlCar.show();
                }
                //this.dataset.mode = this.dataset.mode == "carcontrol" ? "" : "carcontrol";
            };


        }

        bindControls() {
            this.panelMenu;

            this.handleInputAction = this.handleInputAction.bind(this);
            this.handleWindowClick = this.handleWindowClick.bind(this);

            window.addEventListener(EngineEvents.UI.InputAction, this.handleInputAction);

            window.addEventListener("click", this.handleWindowClick);

            qAll("ks-btnbasic", this.panelMenu).forEach(
                /** @param {Btnbasic} btn*/
                btn => {
                    btn.onToggled = (sender, e, state) => {

                        window['lastevent'] = e;
                        if (btn == e.currentTarget) {

                            this.panelSubmenus.dataset.mode = state ? btn.dataset.mode : "";

                            localStorage.setItem("lastMainMode", this.panelSubmenus.dataset.mode);

                            if (this.panelSubmenus.dataset.mode == "") {
                                this.panelSubmenus.removeAttribute("data-mode");
                            }

                        }
                    };
                });

            this.btnPaintshop.onPressed = (sender, e) => {
                ksUI$1.requestNoResponse("CarCustomization", "GoToGarage");
            };

            this.btnOpenWorld.onPressed = (sender, e) => {
                ksUI$1.requestNoResponse("GameModeSelectionClient", "OpenWorld");
            };

            this.btnDealership.onBeforeRedirect = () => {
                localStorage.setItem("backTo", ksUI$1.menuState.getCurrentLocation().join("|"));
            };

        }

        handleInputAction(evt) {

            function processHotkey(is_next) {
                const focused = q("ks-btnbasic:focus", this.panelMenu);
                const selected = q("ks-btnbasic.selected", this.panelMenu);

                if (!focused && !selected) {
                    this.btnDrive.toggle(true, true);
                    return;
                }

                SpatialNavigation$1.move(is_next ? "right" : "left");

                if (!focused) {
                    selected.focus();
                    SpatialNavigation$1.move(is_next ? "right" : "left");
                    q("ks-btnbasic:focus", this.panelMenu).toggle(true, true);
                } else {
                    q("ks-btnbasic:focus", this).toggle(true, true);
                }
                waitForFrames(() => {
                    //console.log(`div.${$.q("ks-btnbasic.selected", this).dataset.mode} > ks-btnpanel`);
                    const initialselection = q(`div.${q("ks-btnbasic.selected", this).dataset.mode} > ks-btnpanel`);
                    if (initialselection && window.getComputedStyle(initialselection).content.indexOf('disabled') == -1)
                        initialselection.focus();
                }, 1);
            }

            const ph = processHotkey.bind(this);

            switch (evt.detail) {

                case "cancel":
                    if (ksUI$1.isUIHidden) {
                        return;
                    }
                    if (this.panelSubmenus.dataset.mode) {
                        q("ks-btnbasic.selected", this.panelMenu)?.focus();
                        q("ks-btnbasic.selected", this.panelMenu)?.toggle(false, true);

                        ksUI$1.indicateFocus(null, false);
                        return;
                    }
                    if (!this.pageModal.isVisible) {
                        waitForFrames(() => {
                            this.handleQuit();
                        });
                    }
                    break;

                case "pageup":
                    ph(true);
                    break;

                case "pagedown":
                    ph(false);
                    break;
            }

        }

        handleWindowClick(e) {
            if (e.target != this.wrapperMenu && !e.target.closest("#wrapperMenu")) {
                this.clearActiveMenu();
            }
        }

        clearActiveMenu() {
            q("ks-btnbasic.selected", this.panelMenu)?.toggle(false, true);
        }

        onRemovedFromDOM() {
            window.removeEventListener("click", this.handleWindowClick);
            window.removeEventListener(EngineEvents.UI.InputAction, this.handleInputAction);
            document.body.classList.remove(this.tagName.toLowerCase());
        }

        onTemplateLoaded() {

            super.onTemplateLoaded();

            VEHICLES.dataFilters.ownershipState = "CarSelectionOwnerShipState_OWNED";
            VEHICLES.getModels().then(data => this.classList.toggle("no-owned-cars", data.car_model.length == 0));

            if (localStorage.getItem("playermodeset") !== "true") {

                ksUI$1.request("GameEconomyClient", "PlayerMode",
                    (response) => {
                        localStorage.setItem("playermodeset", "true");
                        console.log("Set to open mode");
                    },
                    {
                        is_sandbox: true
                    }
                );
            }

            ksUI$1.menuState.purgeHistory();
            console.log("MainPage template loaded");

            ksUI$1.menuState.toggleMouseHover(false);

            this.mapElementById("panelMenu");
            this.mapElementById("panelSubmenus");
            this.mapElementById("btnOpenWorld");
            this.mapElementById("btnPaintshop");
            this.mapElementById("btnDrive");
            this.mapElementById("wrapperMenu");
            this.mapElementById("controlScene");
            this.mapElementById("controlCar");
            this.mapElementById("btnDealership");

            document.body.classList.add(this.tagName.toLowerCase());

            localStorage.removeItem("backTo");

            const lastmode = localStorage.getItem("lastMainMode");

            if (lastmode) {
                q(`ks-btnbasic[data-mode=${lastmode}]`).toggle(true, true);
                this.panelSubmenus.dataset.mode = lastmode;
            }

            VEHICLES.getCurrent().then(() => VEHICLES.resetFilters());
            SHOWROOM.showExterior();

        }

    }
    engine.whenReady.then(() => {
        ksUI$1.registerModule('ks-page-main', MainPage);
    });

    var template$1k = "<div class=\"component-body\" data-mode=\"home\">\r\n\r\n    <div id=\"acelogo\"></div>\r\n\r\n    <!-- <ks-playerprogress></ks-playerprogress> -->\r\n\r\n    <ks-page-singleplayer-hub opaque class=\"submode carselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'main'\">\r\n    </ks-page-singleplayer-hub>\r\n\r\n    <ks-page-gamemode opaque class=\"submode gamemode renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'gamemode'\">\r\n    </ks-page-gamemode>\r\n\r\n    <ks-page-grideditor opaque class=\"submode grideditor renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'grideditor'\">\r\n    </ks-page-grideditor>\r\n\r\n    <ks-page-garagerental garagerental opaque class=\"submode garagerental renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'garagerental'\">\r\n    </ks-page-garagerental>\r\n\r\n    <ks-page-carselection garage singleplayer class=\"submode carselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'carselection'\">\r\n        <div slot=\"header\">\r\n            <ks-pageheader class=\"minimal nologo\">\r\n                <div slot=\"label\">\r\n                    <div data-l10n-id=\"headerSinglePlayer\">headerSinglePlayer</div>\r\n                    <div>/</div>\r\n                    <div data-l10n-id=\"headerCarSelection\">Vehicle Selection</div>\r\n                </div>\r\n            </ks-pageheader>\r\n        </div>\r\n    </ks-page-carselection>\r\n\r\n    <ks-page-trackselection opaque class=\"submode trackselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'trackselection'\">\r\n    </ks-page-trackselection>\r\n\r\n    <ks-page-weather opaque class=\"submode weather renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'weather'\">\r\n    </ks-page-weather>\r\n\r\n    <ks-page-assists opaque class=\"submode assists renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'assists'\">\r\n    </ks-page-assists>\r\n\r\n    <ks-page-brandselection opaque garage singleplayer class=\"submode brandselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'brandselection'\">\r\n        <div slot=\"header\">\r\n            <ks-pageheader class=\"minimal nologo\">\r\n                <div slot=\"label\">\r\n                    <div data-l10n-id=\"headerSinglePlayer\">headerSinglePlayer</div>\r\n                    <div>/</div>\r\n                    <div data-l10n-id=\"headerCarSelection\">Vehicle Selection</div>\r\n                    <div>/</div>\r\n                    <div data-l10n-id=\"headerBrandSelection\">Brands</div>\r\n                </div>\r\n            </ks-pageheader>\r\n        </div>\r\n    </ks-page-brandselection>\r\n \r\n    <ks-page-paintshop dealership singleplayer title=\"headerCustomizeVehicle\" class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState}}.activeSubMenu === 'customize'\" data-mode=\"main\"></ks-page-paintshop>\r\n\r\n    <ks-page-modelselection opaque garage singleplayer class=\"submode modelselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'modelselection'\">\r\n        <div slot=\"header\">\r\n            <ks-pageheader class=\"minimal nologo\">\r\n                <div slot=\"label\">\r\n                    <div data-l10n-id=\"headerSinglePlayer\">headerSinglePlayer</div>\r\n                    <div>/</div>\r\n                    <div data-l10n-id=\"headerCarSelection\">Vehicle Selection</div>\r\n                    <div>/</div>\r\n                    <div data-l10n-id=\"headerModelSelection\">Models</div>\r\n                </div>\r\n            </ks-pageheader>\r\n        </div>\r\n    </ks-page-modelselection>\r\n\r\n    <ks-page-vehiclepresetselection garage singleplayer class=\"submode presetselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'presetselection'\">\r\n        <div slot=\"header\">\r\n            <ks-pageheader class=\"minimal nologo\">\r\n                <div slot=\"label\">\r\n                    <div data-l10n-id=\"headerSinglePlayer\">headerSinglePlayer</div>\r\n                    <div>/</div>\r\n                    <div data-l10n-id=\"headerCarSelection\">Vehicle Selection</div>\r\n                    <div>/</div>\r\n                    <div data-l10n-id=\"headerVariantSelection\">Variants</div>\r\n                </div>\r\n            </ks-pageheader>\r\n        </div>\r\n    </ks-page-vehiclepresetselection>\r\n\r\n</div>";

    var template$1j = "<div class=\"component-body trackselection-body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back rounded focusable\" path=\"singleplayer/main\"></ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\">\r\n            <div data-l10n-id=\"headerSinglePlayer\">Single Player</div>\r\n            <div>/</div>\r\n            <div data-l10n-id=\"headerTrackSelection\">Track Selection</div>\r\n        </div>\r\n    </ks-pageheader>\r\n\r\n    <ks-modalselect id=\"modalLayouts\" class=\"\" extracssclass=\"track-layout-selector\">\r\n\r\n        <div slot=\"current\" value=\"none\"></div>\r\n\r\n        <div slot=\"options\">\r\n            <div class=\"title\" data-bind-value=\"{{TrackLayouts}}.name\"></div>\r\n            <div class=\"list scrollable-vertical\">\r\n                <div class=\"scrollable-content\">\r\n\r\n                    <ks-btnpanel class=\"option track focusable tracek-selection\" data-bind-for=\"index,item:{{TrackLayouts.items}}\" data-bind-ksvalue=\"{{item.layout}}\" data-bind-ksmessage=\"{{item}}\" data-bind-inputvalue=\"{{item.name}}\" data-bind-disablevalue=\"!{{item.is_enabled}}\" delayedredirect>\r\n                        <div slot=\"extra\" class=\"map\"></div>\r\n                        <div slot=\"subtitle\">\r\n                            <div class=\"name\" data-bind-if=\"isNaN({{item.layout}})\" data-bind-value=\"{{item.layout}}\"></div>\r\n\r\n                            <div class=\"pitboxes\">\r\n                                <div data-l10n-id=\"lblNumberOfPitboxes\"></div> <span data-bind-value=\"{{item.max_drivers}}\"></span>\r\n                            </div>\r\n                            <div class=\"track-length\" data-bind-if=\"{{item}}.track_length > 0\">\r\n                                <span data-bind-htmlvalue=\"ksUI.appendSuffix({{item}}.track_length, 'M', true, 'suffix')\">\r\n                            </span></div>\r\n                        </div>\r\n                    </ks-btnpanel>\r\n\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n    </ks-modalselect>\r\n\r\n    <div class=\"submode-body centered-content\">\r\n        <div class=\"controls is-flex-column\">\r\n            <div id=\"panelContinents\" class=\"is-flex\">\r\n                <ks-btnbasic class=\"focusable\" data-value=\"All\" data-sn-up=\"NONE\" toggle-group=\"continents\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"lblAll\"></div>\r\n                </ks-btnbasic>\r\n                <ks-btnbasic class=\"focusable\" data-sn-up=\"NONE\" data-bind-for=\"item:{{Continents.items}}\" data-bind-ksvalue=\"{{item}}\" toggle-group=\"continents\" toggle>\r\n                    <div slot=\"name\" data-bind-l10n-id=\"APF()?.getLocId({{item}})\"></div>\r\n                </ks-btnbasic>\r\n            </div>\r\n            <!-- <div id=\"panelNations\">Nations</div> -->\r\n        </div>\r\n        <div class=\"row tracks is-flex-column flex-wrap justify-content-center align-items-center scrollable-vertical\">\r\n            <div class=\"scrollable-content per-item-scroll\">\r\n                <ks-btnpanel lazyload class=\"track focusable\" path=\"singleplayer/main\" data-bind-class-toggle=\"multi-layout:{{item}}.layouts.length > 1\" data-bind-for=\"index,item:{{Tracks.items}}\" data-bind-ksvalue=\"{{item.layout}}\" data-bind-ksmessage=\"{{item}}\" data-bind-inputvalue=\"{{item.name}}\" data-bind-disablevalue=\"!{{item.is_enabled}}\" delayedredirect>\r\n                    <div slot=\"title\">\r\n                        <div class=\"label\" data-l10n-id=\"lblAvailableLayouts\"></div>\r\n                        <div class=\"value\" data-bind-value=\"{{item}}.layouts.length\"></div>\r\n                    </div>\r\n                    <div slot=\"extra\" class=\"map\"></div>\r\n                    <div slot=\"subtitle\">\r\n                        <div class=\"layout\" data-bind-value=\"APF()?.evaluateProperty({{item}}, 'layout')\"></div>\r\n                        <div class=\"name\" data-bind-value=\"{{item.name}}\"></div>\r\n                        <div class=\"pitboxes\">\r\n                            <div data-l10n-id=\"lblNumberOfPitboxes\"></div> <span data-bind-value=\"APF()?.evaluateProperty({{item}}, 'max_drivers')\"></span>\r\n                        </div>\r\n                        <div class=\"track-length\">\r\n                            <span data-bind-htmlvalue=\"ksUI.appendSuffix(APF()?.evaluateProperty({{item}}, 'track_length'), 'M', true, 'suffix')\">\r\n                        </span></div>\r\n                    </div>\r\n            </ks-btnpanel></div>\r\n            \r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n";

    const LSCONTINENTALL = "trackselection_continent_all";

    class TrackSelectionPage extends KsHTMLElement {

        /** @typedef {import('../singleplayer/singleplayer').default} SinglePlayerPage */
        /** @type { SinglePlayerPage } */
        rootPage;

        /** @type {ModalSelect} */
        modalLayouts;

        allTracks = [];
        uniqueTracks = [];
        tracksFiltered = [];

        activeContinent = "All";
        continents = [];
        countries = [];


        focusOnSelectedHandler;


        constructor() {
            super();
            this.template = template$1j;
            this.delayedInit = true;
            this._isnavigable = true;
            this._bindScrollableEvents = true;
            this._exposeAsActivePage = true;
        }

        filters = {
            getLocId(continent) {
                const locId = `lblContinent${continent.replace(" ", "")}`;
                return locId;
            },
            locContinent(continent) {
                return engine.translate(this.getLocId(continent));
            },
            evaluateProperty(item, propertyname) {
                if (item.name == CurrentTrack.name && item.layouts.length > 1) {
                    return CurrentTrack[propertyname];
                }
                return item[propertyname];
            }
        }

        bindControls() {

        }

        bindTracks() {

            qAll(".track", this).forEach((elem) => {

                if (!elem.messages) return;

                const btn_track_item = elem.messages["TrackItem"];

                function setCurrentTrack(track_item) {
                    console.log("Selected", track_item.name, track_item.layout, track_item.max_drivers);
                    const maxopponents = track_item.max_drivers - 1;

                    CurrentGameMode.sessions[0].num_opponents = ksUI$1.clamp(CurrentGameMode.sessions[0].num_opponents, 0, maxopponents);

                    if (CurrentGameMode.sessions[0].models.length > maxopponents) {
                        console.warn("Reducing grid to", maxopponents);
                        CurrentGameMode.sessions[0].models = CurrentGameMode.sessions[0].models.slice(0, maxopponents);
                        CurrentGameMode.sessions[0].opponents = CurrentGameMode.sessions[0].opponents.slice(0, maxopponents);
                    }

                    GAMEMODESELECTION.save(eClientCommands.Mode.Single, CurrentGameMode.sessions);
                    this.rootPage.GameModeSelectionClient.requestNoResponse("SetTrack", {
                        mode: eClientCommands.Mode.Single,
                        track_item: track_item
                    });
                }

                const set_track_bound = setCurrentTrack.bind(this);

                elem.onBeforeRedirect = () => {

                    this.modalLayouts.remainOpen = true;

                    if (btn_track_item.layouts.length > 1) {
                        this.assignModel({ name: btn_track_item.name, items: btn_track_item.layouts }, "TrackLayouts");

                        this.modalLayouts.onHide = () => {
                            elem.focus();
                        };

                        this.modalLayouts.onShow = () => {

                        };

                        this.modalLayouts.onSelected = (event, value, displayvalue) => {
                            const track_layout_item = event.currentTarget.messages["TrackItem"];

                            set_track_bound(track_layout_item);
                            ksUI$1.changePage("singleplayer/main");

                            waitForFrames(() => {
                                this.modalLayouts.Hide();
                            });

                        };

                        waitForFrames(() => {
                            this.modalLayouts.Show({
                                showTitle: false,
                                showMessage: false,
                                showContent: true,
                                buttons: 0x001
                            });

                            this.modalLayouts.bindOptions();
                        });


                        return false;
                    }

                    set_track_bound(btn_track_item);


                };
            });

            this.setupNavigation();
        }

        bindContinents() {
            const btnContinents = qAllArray("#panelContinents ks-btnbasic");
            btnContinents.forEach((/** @type {Btnbasic} */ btn) => {
                if (btn.nextSibling)
                    btn.dataset.snRight = `[data-value="${btn.nextElementSibling.dataset.value}"]`;
                if (btn.previousSibling)
                    btn.dataset.snLeft = `[data-value="${btn.previousElementSibling.dataset.value}"]`;
                btn.onToggled = (sender, e, state) => {
                    if (this.activeContinent != btn.dataset.value) {
                        this.activeContinent = btn.dataset.value;
                        if (this.activeContinent === "All") {
                            localStorage.setItem(LSCONTINENTALL, this.activeContinent);
                        } else {
                            localStorage.removeItem(LSCONTINENTALL);
                        }
                        this.filterTracks();
                    }
                };
            });

            btnContinents[0].dataset.snLeft = `[data-value="${this.continents.at(-1)}"]`;
            btnContinents.at(-1).dataset.snRight = '[data-value=All]';

            const active_continent_button = q(`#panelContinents ks-btnbasic[data-value="${this.activeContinent}"]`);
            if (active_continent_button) active_continent_button.classList.add("selected");
        }

        filterTracks() {
            this.classList.add("loading");
            this.tracksFiltered = this.uniqueTracks.filter(() => { return true; });


            if (this.activeContinent != "All") {
                this.tracksFiltered = this.tracksFiltered.filter(track => {
                    return track.continent == this.activeContinent;
                });
            }

            this.assignModel({ items: [] }, "Tracks", true);

            waitForFrames(() => {
                this.assignModel({ items: this.tracksFiltered }, "Tracks", true);
            }, 2);

            waitForFrames(() => {
                this.bindTracks();
            });
            waitForFrames(() => this.classList.remove("loading"), 3);
        }

        getTracks() {

            this.rootPage.GameModeSelectionClient.request("TrackList", {
                mode: eClientCommands.Mode.Single
            }, (data) => {
                ({
                    [eClientCommands.Response.OK]: () => {

                        this.allTracks = data.track_item;

                        if (this.continents.length == 0) {
                            this.allTracks.forEach(track => {
                                if (this.continents.indexOf(track.continent) == -1) {
                                    this.continents.push(track.continent);
                                }
                                const known_track = this.uniqueTracks.find(unique => unique.name == track.name);
                                if (!known_track) {
                                    const track_copy = { ...track };
                                    track.layouts = [];
                                    track.layouts.push(track_copy);
                                    this.uniqueTracks.push(track);
                                } else {
                                    const track_copy = { ...track };
                                    known_track.layouts.push(track_copy);
                                }
                            });
                        }

                        if (this.countries.length == 0) {
                            this.allTracks.forEach(track => {

                                const key = { nation: track.nation, continent: track.continent };

                                if (!this.countries.find(item => item.nation == key.nation)) {
                                    this.countries.push(key);
                                }
                            });
                        }

                        this.activeContinent = localStorage.getItem(LSCONTINENTALL) === null ? CurrentTrack.continent : "All";

                        this.continents.sort((a, b) => {
                            this.filters.locContinent(a);
                            this.filters.locContinent(b);
                            if (a < b) return -1;
                            if (a > b) return 1;
                            return 0;
                        });

                        this.filterTracks();
                        this.assignModel({ items: this.continents }, "Continents");



                        waitForFrames(() => {
                            this.bindContinents();
                            this.initTabHandler();

                            // $.q("#panelContinents ks-btnbasic").dataset.snLeft=
                        });

                    },
                    [eClientCommands.Response.NoTracks]: () => {
                        console.warn("No available tracks");
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Error populating tracks");
                    }
                }[data.response])();
            });

        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.mapElementById("modalLayouts");

            this.getTracks();

            this.focusOnSelectedHandler = engine.on(EngineEvents.TrackSelection.CurrentTrackInList, (target) => {
                console.trace("CurrentTrackInList!");
                waitForFrames(() => {
                    this.scrollableContainers[1].scrollToElement(target);
                });
            });

        }

        onRemovedFromDOM() {
            if (this.focusOnSelectedHandler)
                this.focusOnSelectedHandler.clear();
        }

    }
    ksUI$1.registerModule('ks-page-trackselection', TrackSelectionPage);

    var template$1i = "<div class=\"component-body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back rounded focusable\" path=\"{activeMenu}/carselection\"></ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnOwned\" class=\"sandbox-element rounded focusable\" toggle toggle-group=\"carstate\">\r\n                <div slot=\"name\" data-l10n-id=\"btnOwnedVehicles\"></div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic id=\"btnAll\" class=\"sandbox-element rounded focusable\" toggle toggle-group=\"carstate\">\r\n                <div slot=\"name\" data-l10n-id=\"btnAllVehicles\"></div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <component-slot data-name=\"header\">\r\n        <ks-pageheader class=\"minimal nologo\">\r\n            <div slot=\"label\" data-l10n-id=\"headerBrandSelection\">Brand Selection</div>\r\n        </ks-pageheader>\r\n    </component-slot>\r\n\r\n    <div class=\"submode-body\">\r\n\r\n        <div class=\"row filters\">\r\n            <!-- <ks-radiobuttongroup\r\n                id=\"btnGroupOwnership\"\r\n                data-bind-inputvalue=\"APF()?.getCurrentState({{CarSelectionDataFilters}})\"\r\n                class=\"horizontal notitle\">\r\n\r\n                <div slot=\"group\">\r\n                    <div class=\"button active focusable\" data-l10n-id=\"panelOwnVehicles\"></div>\r\n                    <div class=\"button active focusable\" data-l10n-id=\"panelRentalVehicles\"></div>\r\n                </div>\r\n            </ks-radiobuttongroup> -->\r\n        </div>\r\n        <div class=\"first-selection\">\r\n            <div class=\"label\" data-l10n-id=\"lblFirstStartYourFirstCar\"></div>\r\n            <div class=\"text\" data-l10n-id=\"lblFirstStartPurchase\"></div>\r\n        </div>\r\n\r\n        <div id=\"listBrands\" class=\"row items brands\">\r\n\r\n            <ks-btnpanel id=\"btnAllBrands\" class=\"item brand all-brands focusable\" path=\"{activeMenu}/modelselection\" data-brand=\"all\" data-value=\"All\">\r\n                <div slot=\"subtitle\" data-l10n-id=\"lblAll\"></div>\r\n            </ks-btnpanel>\r\n\r\n            <ks-btnpanel data-bind-for=\"index,item:{{Manufacturers.manufacturers}}\" data-bind-ksvalue=\"{{item.name}}\" data-bind-ksmessage=\"{{item}}\" class=\"item brand brand-item focusable\" path=\"{activeMenu}/modelselection\">\r\n                <div slot=\"subtitle\">Brand</div>\r\n            </ks-btnpanel>\r\n\r\n        </div>\r\n\r\n    </div>\r\n\r\n</div>";

    class BaseCarSelectionPage extends KsHTMLElement {

        constructor() {
            super();
        }

        get rememberOwnershipFilter() {
            return this.hasAttribute("rememberownership");
        }

        isGarage() {
            return this.hasAttribute("garage");
        }

        isDealership() {
            return this.hasAttribute("dealership");
        }

        isFirstPurchace() {
            return this.hasAttribute("firstpurchace");
        }

        isUsedVehicles() {
            return this.hasAttribute("usedvehicles");
        }

        isSinglePlayer() {
            return this.hasAttribute("singleplayer");
        }

        isMultiPlayer() {
            return this.hasAttribute("multiplayer");
        }

        isRental() {
            return this.hasAttribute("rental");
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            const doc_dataset = document.body.dataset;

            if (isCareer && !this.isMultiPlayer()) {
                VEHICLES.dataFilters.ownershipState = eCarSelection.State.Owned;
            }

            if (this.isMultiPlayer()) {
                VEHICLES.dataFilters.carSelectionMode = eClientCommands.Mode.Multi;
            }

            if (this.isDealership()) {
                VEHICLES.dataFilters.ownershipState = eCarSelection.State.Dealership;
                this.documentBody.classList.add("dealership");
                doc_dataset.showroomMode = "dealership";
            }

            if (this.isGarage()) {
                this.documentBody.classList.remove("dealership");
                doc_dataset.showroomMode = "garage";
            }

            if (this.isSinglePlayer()) {
                VEHICLES.dataFilters.carSelectionMode = eClientCommands.Mode.Single;
                this.documentBody.classList.add("singleplayer");
            }

            if (this.isFirstPurchace()) {
                VEHICLES.dataFilters.ownershipState = eCarSelection.State.FirstPurchace;
            }

            if (this.isUsedVehicles()) {
                VEHICLES.dataFilters.ownershipState = eCarSelection.State.Used;
            }

            if (this.isRental()) {
                VEHICLES.dataFilters.ownershipState = eCarSelection.State.Rental;
                this.documentBody.classList.add("rental");
                doc_dataset.showroomMode = "rental";
            }

        }

        onRemovedFromDOM() {
            //if (this.isSinglePlayer()) {
                //this.documentBody.classList.remove("singleplayer");
            //}

            delete document.body.dataset.showroomMode;
        }


    }

    class BrandSelectionPage extends BaseCarSelectionPage {

        btnGroupOwnership;
        listBrands;
        btnAllBrands;
        btnBack;

        /** @type {Btnbasic} */
        btnOwned;
        /** @type {Btnbasic} */
        btnAll;


        filters = {
            getCurrentState: (data) => {
                return VEHICLES.dataFilters.ownershipState == "CarSelectionOwnerShipState_OWNED" ? 0 : 1;
            }
        }

        constructor() {
            super();
            this.template = template$1i;
            this._exposeAsActivePage = true;
            this.delayedInit = true;
            this._isnavigable = true;
        }

        bindBrands() {
            qAllArray("ks-btnpanel", this.listBrands).forEach(item => {
                //console.warn("binding brand");
                item.onBeforeRedirect = () => {
                    ksUI$1.menuState.addToStore("caller", "brandselection");
                    let brand = item.dataset.value;

                    if (brand == "All") {
                        VEHICLES.dataFilters.activeBrand = VEHICLES.allBrands;
                    } else {

                        for (let mfg of Manufacturers.manufacturers) {
                            if (mfg.name == brand) {
                                VEHICLES.dataFilters.activeBrand = mfg;
                                break;
                            }
                        }
                    }

                    console.log("Selecting brand", brand);
                    return true;
                };
            });

            localStorage.removeItem("textfilter_modelselection");

            this.setupNavigation();
        }

        bindControls() {

            // this.btnGroupOwnership.onUpdate = (new_value, old_value) => {
            //     console.log("btnGroupOwnership.onUpdate");
            //     VEHICLES.dataFilters.ownershipState = new_value == 0 ? eCarSelection.State.Owned : eCarSelection.State.Rental;            
            //     this.getManufacturers();
            // };
        }

        getManufacturers() {
            VEHICLES.getManufacturers();
        }

        onAfterRenderControlHints(controlhints) {
            ///console.log(">>>", this.rootPage.viewingBrands);
            this.mapElementById("btnBack", controlhints);
            this.mapElementById("btnAll", controlhints);
            this.mapElementById("btnOwned", controlhints);

            if (this.isSinglePlayer() || this.isMultiPlayer()) {
                if (VEHICLES.dataFilters.ownershipState == eCarSelection.State.Owned) {
                    this.btnOwned.toggle(true);
                }

                if (VEHICLES.dataFilters.ownershipState == eCarSelection.State.Dealership || VEHICLES.dataFilters.ownershipState == eCarSelection.State.All) {
                    this.btnAll.toggle(true);
                }

                this.btnAll.onToggled = (sender, e, state) => {
                    if (state) {
                        VEHICLES.dataFilters.ownershipState = eCarSelection.State.All;
                        VEHICLES.updateDataFilters();
                        VEHICLES.getManufacturers();
                    }
                };


                this.btnOwned.onToggled = (sender, e, state) => {
                    if (state) {
                        VEHICLES.dataFilters.ownershipState = eCarSelection.State.Owned;
                        VEHICLES.updateDataFilters();
                        VEHICLES.getManufacturers();
                    }
                };
            }

            //if (this.isDealership()) {
            if (this.isFirstPurchace()) {

                ksUI$1.preventBack = false;

                this.btnBack.onBeforeRedirect = () => {
                    ksUI$1.changePage("firststart/tutorial");
                    return false;
                };

            } else {
                const backTo = localStorage.getItem("backTo");

                if (backTo) {
                    console.log("Setting brandselection return:", backTo);
                    this.btnBack.redirect = () => {
                        const split = backTo.split("|");
                        ksUI$1.goTo(split[0], split[1]);
                    };
                } else {

                    if (!this.rootPage.enteredCarSelection) {
                        console.log("Setting brandselection return: Dealership");
                        this.btnBack.setAttribute("path", ksUI$1.menuState.getOrigin()[1]);
                    }
                }

                this.btnBack.onBeforeRedirect = () => {


                    if (ksUI$1.menuState.getFromStore("caller") != "carselection") {
                        if (!document.body.classList.contains("singleplayer") && !document.body.classList.contains("multiplayer"))
                            ksUI$1.requestGoBack(this.isUsedVehicles() ? eGameModeSelection.BackFrom.Unknown : eGameModeSelection.BackFrom.Dealership);

                        VEHICLES.resetFilters();
                        if (ksUI$1.menuState.isOriginMainMenu) {
                            ksUI$1.goTo("menu.html", "main/main");
                        }
                    } else {
                        ksUI$1.menuState.delFromStore("caller");
                        ksUI$1.changePage(`${ModelMenuState.activeMenu}/carselection`);
                        return false;
                    }
                };
            }

            //}

            if (this.isRental()) {
                this.btnBack.onBeforeRedirect = () => {
                    if (ksUI$1.menuState.getFromStore("caller") != "carselection") {
                        ksUI$1.requestGoBack(eGameModeSelection.BackFrom.Rental);
                        VEHICLES.resetFilters();
                        ksUI$1.goTo("singleplayer.html", "singleplayer/garagerental");
                        return false;
                    } else {
                        ksUI$1.menuState.delFromStore("caller");
                        ksUI$1.changePage(`${ModelMenuState.activeMenu}/carselection`);
                        return false;
                    }

                };
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("listBrands", this);
            this.mapElementById("btnGroupOwnership", this);

            const purchase_replacement = q(".purchase");


            if (this.isFirstPurchace()) {
                if (purchase_replacement) {
                    purchase_replacement.textContent = ModelUIDriverState.money + " ";
                }
            }

            if (this.isGarage() && !this.isSinglePlayer()) {
                VEHICLES.dataFilters.ownershipState = eCarSelection.State.Owned;
            }

            VEHICLES.onGetManufacturers = (data) => {
                console.log(data.response);
                if (data.response == eClientCommands.Response.OK) {
                    waitForFrames(() => {
                        this.bindBrands();
                    }, 1);
                    if (data.manufacturers.length == 0 && VEHICLES.dataFilters.ownershipState == eCarSelection.State.Owned) {
                        this.btnOwned.disable();
                        this.btnAll.press();
                    }
                } else {
                    console.warn("No manufacturers received");
                }
                this.listBrands.classList.add("populated");
            };
            this.getManufacturers();
            VEHICLES.updateDataFilters();

            this.documentBody.classList.add("brandselection");
        }

        onRemovedFromDOM() {
            VEHICLES.clearHandlers();
            this.documentBody.classList.remove("brandselection");
        }

    }
    ksUI$1.registerModule('ks-page-brandselection', BrandSelectionPage);

    var template$1h = "<div class=\"modelselection-body component-body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" data-sn-right=\"#btnOwned\" class=\"back rounded focusable\" path=\"{activeMenu}/carselection\"></ks-btnbasic>\r\n            <ks-btnbasic id=\"btnOwned\" data-sn-right=\"#btnAll\" class=\"sandbox-element rounded focusable\" toggle toggle-group=\"carstate\">\r\n                <div slot=\"name\" data-l10n-id=\"btnOwnedVehicles\"></div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic id=\"btnAll\" class=\"sandbox-element rounded focusable\" toggle toggle-group=\"carstate\">\r\n                <div slot=\"name\" data-l10n-id=\"btnAllVehicles\"></div>\r\n            </ks-btnbasic>\r\n        </div>\r\n\r\n\r\n\r\n\r\n    </component-slot>\r\n\r\n    <component-slot data-name=\"header\">\r\n        <ks-pageheader class=\"minimal nologo\">\r\n            <div slot=\"label\" data-l10n-id=\"headerModelSelection\">Model Selection</div>\r\n        </ks-pageheader>\r\n    </component-slot>\r\n\r\n    <div class=\"modelselection-submode-body submode-body\">\r\n\r\n        <div class=\"row filters\">\r\n            <ks-btnpanel id=\"btnBrand\" class=\"brand focusable\" data-bind-ksmessage=\"{{CarSelectionDataFilters.activeBrand}}\" path=\"{activeMenu}/brandselection\">\r\n                <div slot=\"subtitle\">BRAND</div>\r\n            </ks-btnpanel>\r\n\r\n            <ks-textinput id=\"inputFilter\" maxlength=\"16\" class=\"focusable\">\r\n                <div slot=\"placeholder\" data-l10n-id=\"lblSearchVehicles\"></div>\r\n            </ks-textinput>\r\n\r\n            <!-- <ks-radiobuttongroup\r\n                id=\"btnGroupOwnership\"\r\n                data-bind-inputvalue=\"APF()?.getCurrentState({{CarSelectionDataFilters}})\"\r\n                class=\"horizontal notitle\" disabled=\"disabled\">\r\n                <div slot=\"group\">\r\n                    <div class=\"button active focusable\" data-l10n-id=\"panelOwnVehicles\"></div>\r\n                    <div class=\"button active focusable\" data-l10n-id=\"panelRentalVehicles\"></div>\r\n                </div>\r\n            </ks-radiobuttongroup> -->\r\n\r\n        </div>\r\n\r\n        <div id=\"listModels\" class=\"row items models scrollable-vertical\">\r\n            <div class=\"content scrollable-content per-item-scroll\">\r\n                <ks-btnpanel lazyload data-fragment=\"true\" class=\"item focusable delayedInit\" path=\"{activeMenu}/carselection\" data-bind-class-toggle=\"multiple:{{item}}.__uimetadata.mechs.size > 1\" data-bind-ksmessage=\"{{item}}\" data-bind-for=\"index,item:{{Models.items}}\" data-bind-ksvalue=\"{{index}}\">\r\n                    <div slot=\"title\">\r\n                        <div class=\"model_name\" data-bind-value=\"{{item.display_name}}\"></div>\r\n\r\n                        <div class=\"versions\">\r\n                            <span data-bind-value=\"{{item.__uimetadata.mechs.size}}\"></span> <span data-l10n-id=\"lblVariantsAvailable\"></span>\r\n                        </div>\r\n                    </div>\r\n                    <div slot=\"subtitle\" class=\"is-flex-row flex-1\">\r\n\r\n                        <div class=\"config-name\"><span class=\"value\" data-bind-value=\"{{item.translated.mech}}\"></span></div>\r\n                        <div class=\"trim-name\"><span class=\"value\" data-bind-value=\"{{item.translated.visual}}\"></span></div>\r\n                        <div class=\"license\"><span class=\"value\" data-bind-l10n-id=\"{{item.required_license}}\"></span></div>\r\n                        <div class=\"price is-flex-row segmented prefix-value justify-content-end flex-1\">\r\n                            <div class=\"row-wrapper is-flex-row\">\r\n                                <span class=\"value\"></span>\r\n                                <span class=\"suffix\">v$</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <div slot=\"extra\">\r\n                        <div class=\"odometer\"><span data-bind-value=\"{{item}}.total_km.toFixed(1)\"></span> km</div>\r\n                    </div>\r\n                </ks-btnpanel>\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n\r\n</div>";

    class ModelSelectionPage extends BaseCarSelectionPage {


        /** @type {VirtualList} */
        vList;

        /** @type {TextInput} */
        inputFilter;

        btnGroupOwnership;
        btnBrand;

        btnBack;
        /** @type {Btnbasic} */
        btnOwned;
        /** @type {Btnbasic} */
        btnAll;
        
        listModels;

        firstload = true;

        /** @typedef {import('../vehicles/vehicles').default} VehiclePage */
        /** @type { VehiclePage } */
        rootPage;

        filters = {
            getCurrentState: (data) => {
                return VEHICLES.dataFilters.ownershipState == eCarSelection.State.Owned ? 0 : 1;
            },
            pi: (x) => {
                return `${(x).toFixed(2)}`;
            }
        }

        constructor() {
            super();
            this.template = template$1h;
            this._exposeAsActivePage = true;
            this.delayedInit = true;
            this._isnavigable = true;
            this._bindScrollableEvents = true;
        }

        bindModel(ev) {
            let car_model = ev.currentTarget.messages.CarModel;
            car_model.car_guid;

            VEHICLES.dataFilters.activeModel = car_model.name;

            console.warn("Selected CarModel", car_model.name);

            // console.log("Setting car guid to", car_guid, car_model.name, VEHICLES.dataFilters.carSelectionMode);

            if (activePage.isDealership()) {
                VEHICLES.preview(car_model, (data) => {
                    if (data.response == eClientCommands.Response.OK) {

                        // console.log(car_model.__uimetadata, car_model.__uimetadata.count);

                        if (car_model.__uimetadata && car_model.__uimetadata.count > 1) {
                            // console.warn("Model has variants");
                            VEHICLES.dataFilters.activeModel = car_model.name;
                            ksUI$1.menuState.addToStore("caller", "modelselection");
                            ev.currentTarget.setAttribute("path", "{activeMenu}/presetselection");
                            console.trace(ev.currentTarget.getAttribute("path"));

                        }

                        if (!window["CurrentCar"]) {
                            let currentcar = { model: car_model };
                            engine.createJSModel("CurrentCar", currentcar);
                        } else {
                            window["CurrentCar"].model = car_model;
                        }


                        engine.updateWholeModel(CurrentCar);
                    }
                });


            } else {
                VEHICLES.setCurrent(car_model);
            }

            // VEHICLES.dataFilters.activeBrand = car_model.manufacturer;
        }

        bindModels() {

            if (!this.firstload) {
                SpatialNavigation.clear();
            }

            this.firstload = false;

            qevAll("ks-btnpanel", "click sn:enter-down", (e) => {
                //ksUI.menuState.delFromStore("caller");
            });

            //$.qevAll("ks-btnpanel", "click sn:enter-down", this.bindModel, this.listModels);

            qAll("ks-btnpanel", this.listModels).forEach(
                /** @param {Btnbasic} btn*/
                btn => {
                    if (!btn.messages.CarModel.is_enabled) ;

                    btn.onBeforeRedirect = () => {
                        let car_model = btn.messages.CarModel;
                        car_model.car_guid;

                        VEHICLES.dataFilters.activeModel = car_model.name;

                        console.warn("Selected CarModel", car_model, car_model.name, car_model.car_guid);

                        // console.log("Setting car guid to", car_guid, car_model.name, VEHICLES.dataFilters.carSelectionMode);

                        if (car_model.ownership_state != eCarSelection.State.Owned) {
                            console.warn(car_model, car_model.ownership_state);
                            VEHICLES.preview(car_model, (data) => {
                                if (data.response == eClientCommands.Response.OK) {

                                    console.log(car_model.__uimetadata, car_model.__uimetadata.count);

                                    if (car_model.__uimetadata && car_model.__uimetadata.count > 1) {
                                        // console.warn("Model has variants");
                                        VEHICLES.dataFilters.activeModel = car_model.name;
                                        console.trace("setting caller");
                                        ksUI$1.menuState.addToStore("caller", "modelselection");

                                        btn.setAttribute("path", "{activeMenu}/presetselection");
                                        //console.trace(ev.currentTarget.getAttribute("path"));

                                    } else {
                                        ksUI$1.menuState.delFromStore("caller");
                                    }

                                    if (!window["CurrentCar"]) {
                                        let currentcar = { model: car_model };
                                        engine.createJSModel("CurrentCar", currentcar);
                                    } else {
                                        window["CurrentCar"].model = car_model;
                                    }


                                    engine.updateWholeModel(CurrentCar);
                                }
                            });

                        } else {
                            VEHICLES.setCurrent(car_model);
                        }

                        // VEHICLES.dataFilters.activeBrand = car_model.manufacturer;
                    };
                });

        }

        searchDebounce = { id: 0 };

        bindControls() {

            qevAll("ks-btnpanel", "sn:enter-down", this.bindModel, this.listModels);

            // this.btnGroupOwnership.onUpdate = (new_value, old_value) => {
            //     VEHICLES.dataFilters.ownershipState = new_value == 0 ? eCarSelection.State.Owned : eCarSelection.State.Rental;
            //     VEHICLES.getModels();
            // };



            this.inputFilter.onInput = (value, valid) => {

                qAll(".items ks-btnpanel", this).forEach(elem => {
                    elem.classList.toggle("filtered", elem.dataset.modelName.toLowerCase().indexOf(value.toLowerCase().trim()) == -1);
                    elem.classList.toggle("visible", elem.dataset.modelName.toLowerCase().indexOf(value.toLowerCase().trim()) > -1);
                    cancelAnimationFrame(this.searchDebounce.id);
                    waitForFrames(() => {
                        this.updateAllScrollBars();
                    }, 6, this.searchDebounce);
                    q(".content", this.listModels).classList.toggle("justify-content-center", qAll(".item.visible").length < 4);
                    //localStorage.setItem("textfilter_modelselection", value);
                });

            };

        }

        onAfterRenderControlHints(controlhints) {

            this.mapElementById("btnBack", controlhints);
            this.mapElementById("btnAll", controlhints);
            this.mapElementById("btnOwned", controlhints);

            if (ksUI$1.menuState.getFromStore("caller") == "brandselection" || ksUI$1.menuState.getFromStore("caller") == "modelselection") {
                q("ks-btnbasic.back", controlhints).setAttribute("path", "{activeMenu}/brandselection");
            }

            if (ksUI$1.menuState.getFromStore("caller") == "fromgamemode") {
                q("ks-btnbasic.back", controlhints).setAttribute("path", "{activeMenu}/main");
            }

            // this.btnBack.onBeforeRedirect = () => {
            //     if (this.isMultiPlayer() && localStorage.getItem("carselection_visited") != "true") {
            //         ksUI.returnToOrigin();
            //         return false;
            //     }
            // }

            if (this.isSinglePlayer() || this.isMultiPlayer()) {
                if (VEHICLES.dataFilters.ownershipState == eCarSelection.State.Owned) {
                    this.btnOwned.toggle(true);
                }

                if (VEHICLES.dataFilters.ownershipState == eCarSelection.State.Dealership || VEHICLES.dataFilters.ownershipState == eCarSelection.State.All) {
                    this.btnAll.toggle(true);
                }

                this.btnAll.onToggled = (sender, e, state) => {
                    if (state) {
                        VEHICLES.dataFilters.ownershipState = eCarSelection.State.All;
                        //VEHICLES.dataFilters.activeBrand = VEHICLES.allBrands;
                        VEHICLES.updateDataFilters();
                        this.listModels.classList.add("loading");
                        this.listModels.classList.remove("populated");
                        waitForFrames(() => { VEHICLES.getModels(); }, 1);
                    }
                };

                this.btnOwned.onToggled = (sender, e, state) => {
                    if (state) {
                        this.listModels.classList.add("loading");
                        this.listModels.classList.remove("populated");
                        VEHICLES.dataFilters.ownershipState = eCarSelection.State.Owned;
                        //VEHICLES.dataFilters.activeBrand = VEHICLES.allBrands;
                        VEHICLES.updateDataFilters();
                        waitForFrames(() => VEHICLES.getModels(VEHICLES.dataFilters.activeBrand, (data) => {

                            if(Models.items.length == 0) {
                                VEHICLES.dataFilters.activeBrand = VEHICLES.allBrands;
                                VEHICLES.updateDataFilters();
                                VEHICLES.getModels();
                            }
                        }), 1);
                    }
                };
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            if (window["CurrentCar"]) {
                document.body.dataset.carstate = CurrentCar.state;
            }

            ksUI$1.menuState.toggleMouseHover(true);
            this.mapElementById("listModels");
            this.mapElementById("btnGroupOwnership");
            this.mapElementById("btnBrand");
            this.mapElementById("inputFilter");

            VEHICLES.onGetModels = (data) => {

                if (!this.isConnected) return;

                this.setupNavigation();

                        waitForFrames(() => {
                    if (this.inputFilter.textinput.value != '') {
                        this.inputFilter.onInput(this.inputFilter.textinput.value);
                    }

                    this.bindModels();
                    this.listModels.classList.add("populated");
                    this.listModels.classList.remove("loading");

                    this.scrollableContainers[0].scrollToElement(q("ks-btnpanel.current-car"));

                    if (this.isMultiPlayer()) {
                        if (data.car_model.length == 0 && VEHICLES.dataFilters.ownershipState == eCarSelection.State.Owned) {
                            this.btnAll.press();
                            this.btnOwned.disable();
                        }
                    }

                }, 1);


                //$.waitForFrames(() => {
                // const filterstr = localStorage.getItem("textfilter_modelselection");
                // if (filterstr) {
                //     this.inputFilter.textinput.value = filterstr;
                //     this.inputFilter.onInput(filterstr, true);
                // }

                q(".content", this.listModels).classList.toggle("justify-content-center", Models.items.length < 4);
                //});
                if (ksUI$1.isSpatialNav())
                    waitForFrames(() => {
                        let target = q(".current-car", this);
                        if (!target) target = q(".current-model", this);
                        target?.focus();
                        this.setupNavigation();
                    }, 16);


            };

            VEHICLES.onAltOwnershipAvailable = () => {
                // this.btnGroupOwnership.removeAttribute("disabled");
            };

            //VEHICLES.dataFilters.ownershipState = CurrentCar.state;

            VEHICLES.getModels(VEHICLES.dataFilters.activeBrand.name);
            //VEHICLES.getAltManufacturers();

            //this.getModels();
            //this.getAltManufacturers();

            this.btnBrand.classList.toggle("all-brands", VEHICLES.dataFilters.activeBrand?.all === true);
            VEHICLES.updateDataFilters();


            //this.vList = engine.createVirtualList();
            //this.vList.startIndex = 0;
            //this.vList.pageSize = 21;


            this.documentBody.classList.add("modelselection");
        }

        onRemovedFromDOM() {
            //Scrollbar.components.clear();
            delete document.body.dataset.carstate;
            this.documentBody.classList.remove("modelselection");
            VEHICLES.clearHandlers();
        }

    }
    ksUI$1.registerModule('ks-page-modelselection', ModelSelectionPage);

    var template$1g = "<div class=\"component-body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back rounded focusable\" path=\"{activeMenu}/carselection\"></ks-btnbasic>\r\n            <ks-btnbasic id=\"btnConfirm\" class=\"rounded focusable\" path=\"{activeMenu}/carselection\">\r\n                <div slot=\"name\" data-l10n-id=\"btnConfirm\">Confirm</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"focusable\" id=\"btnConfigure\" path=\"{activeMenu}/customize\">\r\n                <div slot=\"name\" data-l10n-id=\"btnConfigure\">Configure</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic id=\"btnConnect\" class=\"rounded focusable highlight\">\r\n                <div slot=\"name\" data-l10n-id=\"btnConnectToServer\">Confirm</div>\r\n            </ks-btnbasic>\r\n\r\n        </div>\r\n    </component-slot>\r\n\r\n    <component-slot data-name=\"header\">\r\n        <ks-pageheader class=\"minimal nologo\">\r\n            <div slot=\"label\" data-l10n-id=\"headerVariantSelection\">Variant Selection</div>\r\n        </ks-pageheader>\r\n    </component-slot>\r\n\r\n    <div class=\"submode-body\">\r\n        <div id=\"modelName\" class=\"variant-info-panel\">\r\n            <ks-btnpanel class=\"brand focusable\" path=\"{activeMenu}/brandselection\" data-bind-ksmessage=\"{{CurrentCar.model.manufacturer}}\">\r\n            </ks-btnpanel>\r\n            <div class=\"name\" data-bind-value=\"{{CurrentCar.model.display_name}}\"></div>\r\n            <div id=\"modelVariant\" class=\"is-flex\">\r\n                <div class=\"configuration is-flex-column\">\r\n\r\n                    <div class=\"value\" data-bind-value=\"{{CurrentCar.model.translated.mech}}\"></div>\r\n                    <div class=\"label\" data-l10n-id=\"lblConfiguration\"></div>\r\n                </div>\r\n                <div class=\"trim is-flex-column\">\r\n\r\n                    <div class=\"value\" data-bind-value=\"{{CurrentCar.model.translated.visual}}\"></div>\r\n                    <div class=\"label\" data-l10n-id=\"lblTrim\"></div>\r\n                </div>\r\n            </div>\r\n\r\n        </div>\r\n        <div id=\"listModels\" class=\"row items models just\">\r\n            <div class=\"content scrollable-horizontal\" data-bind-class-toggle=\"justify-content-center:{{ModelPresets.items.length}} < 7\">\r\n                <div class=\"scrollable-content per-item-scroll\">\r\n                    <ks-btnpanel class=\"item focusable\" data-bind-for=\"index,item:{{ModelPresets.items}}\" data-bind-class-toggle=\"selected:APF()?.isSelected({{item}});altmech:APF()?.altCssClassPerMech({{item}})\" data-bind-ksmessage=\"{{item}}\" data-bind-ksvalue=\"{{index}}\" toggle-group=\"presets\" distinct-values toggle>\r\n                        <div slot=\"title\">\r\n                            <div class=\"config-name\"><span class=\"value\" data-bind-value=\"{{item.translated.mech}}\"></span></div>\r\n                            <div class=\"trim-name\"><span class=\"value\" data-bind-value=\"{{item.translated.visual}}\"></span></div>\r\n\r\n                        </div>\r\n                        <div slot=\"subtitle\" class=\"is-flex-row align-items-end\">\r\n\r\n                            <div class=\"price is-flex-row segmented prefix-value justify-content-end flex-1\">\r\n                                <div class=\"row-wrapper is-flex-row flex-1 justify-content-end\">\r\n                                    <span class=\"value\" data-bind-value=\"{{item.price}}\"></span>\r\n                                    <span class=\"suffix\">v$</span>\r\n                                </div>\r\n                            </div>\r\n\r\n                        </div>\r\n                    </ks-btnpanel>\r\n                </div>\r\n\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n\r\n</div>";

    const PITLIMITDELTALOW = -0.05;
    const PITLIMITDELTAHIGH = 0.01;
    const PITLIMITSPEEDKM = 60;

    const InSessionFlags$1 = {
        None: 0,
        LastLap: 1,
        CanSkip: 2,
        ExpandLeaderboard: 4,
        PlayerWinner: 8,
        SessionEnd: 16,
        NextSessionAvailable: 32,
        RestartAvailable: 64,
        Multiplayer: 128,
        WaitForFinish: 256,
        WaitForPitBox: 512,
        WaitForAiControl: 1024,
        LeaderOnLastLap: 2048
    };

    const StateFlags = {
        LockUI: 0,
        IsReconnecting: 1
    };

    const DataModels$1 = {
        CurrentCar: "ModelCurrentCar",
        UIState: "ModelUIState",
        DriverState: "ModelUIDriverState",
        Timing: "ModelTiming",
        Leaderboard: "ModelLeaderboard",
        SessionState: "ModelUISessionState",
        RadarState: "ModelUIRadarState",
        PenaltyState: "ModelUIPenaltyState",
        RealtimeLeaderboard: "ModelUIRealtimeLeaderboard",
        ReplayState: "ModelUIReplayState",
        InputAxii: "ModelUIExInputsAxii",
        CarsOnTrack: "ModelCarsOnTrack"
    };

    const SimGridOptions = {
        lastcarguid: null
    };


    globalThis.InSessionFlags = InSessionFlags$1;
    globalThis.StateFlags = StateFlags;
    globalThis.DataModels = DataModels$1;
    globalThis.PITLIMITDELTALOW = PITLIMITDELTALOW;
    globalThis.PITLIMITDELTAHIGH = PITLIMITDELTAHIGH;
    globalThis.PITLIMITSPEEDKM = PITLIMITSPEEDKM;

    window["checkPlayerModeSelection"] = (activesubmenu, checkagainst) => {

        if (localStorage.getItem("force-playermodeselection") === 'true') {
            console.warn("Forcing player mode selection");
            return checkagainst == 'playermodeselection';
        }

        console.log(" > > > ", activesubmenu, checkagainst);

        return activesubmenu == checkagainst;

    };

    //** when used for HTML databinding a reference of the model has to be
    // passed in order for this to evaluate */
    window["IsFlagSet"] = (flag, model) => {
        if (model) {
            return ksUI.isSet(model.end_session_flag, flag);
        } else {
            if (!window["ModelUISessionState"]) return false;
            return ksUI.isSet(ModelUISessionState.end_session_flag, flag);
        }
    };



    // setInterval(() => console.log(
    //         "is_backend_connected:",
    //         ModelUIState.is_backend_connected,
    //         "player_mode:",
    //         ModelUIState.player_mode,
    //         "ui_bitset:",
    //         ModelUIState.ui_bitset), 1000)

    class VehiclePresetSelectionPage extends BaseCarSelectionPage {

        get isSimGrid() {
            return this.hasAttribute("simgrid");
        }

        /** @type MessageHandler */
        CarSelectionClient;

        /** @type {Btnbasic} */
        btnBack;

        btnConfirm;
        btnConnect;
        btnConfigure;
        btnGroupOwnership;
        btnBrand;

        listModels;

        firstload = true;

        /** @typedef {import('../vehicles/vehicles').def/ault} VehiclePage */
        /** @type { VehiclePage } */
        rootPage;
        currentMech = "";
        currentVisual = "";

        lastLoopedMech = "";
        altCssClass = false;

        counter = 0;
        altcounter = 0;
        knownGuids = [];

        filters = {
            getCurrentState: (data) => {
                return VEHICLES.dataFilters.ownershipState == eCarSelection.State.Owned ? 0 : 1;
            },

            isSelected(car_model) {
                if (car_model.car_guid != "") {
                    return car_model.car_guid == CurrentCar.model.car_guid;
                } else {
                    return car_model.configuration.name == CurrentCar.model.configuration.name &&
                        car_model.preset.name == CurrentCar.model.preset.name;
                }
            },

            altCssClassPerMech: (car_model) => {

                const config_name = car_model.configuration.name;

                if (activePage.lastLoopedMech != config_name) {
                    if (activePage.lastLoopedMech != "") {
                        activePage.altCssClass = !this.altCssClass;
                    }

                    activePage.lastLoopedMech = config_name;
                }

                activePage.counter++;
                return activePage.altCssClass;
            }

        }

        constructor() {
            super();
            this.delayedInit = true;
            this.template = template$1g;

            this._exposeAsActivePage = true;
            this._isnavigable = true;
            this._bindScrollableEvents = true;

        }

        bindModel(ev) {
            if (ev.target != ev.currentTarget) return;
            let car_model = ev.currentTarget.messages.CarModel;
            let car_guid = car_model.car_guid;

            

            // const currentmech = activePage.currentMech;
            // const currentvisual = activePage.currentVisual;

            console.warn(car_model.configuration.name, activePage.currentVisual);

            if ((CurrentCar.model.ownership_state == eCarSelection.State.All ||
                CurrentCar.model.ownership_state == eCarSelection.State.Dealership ||
                CurrentCar.model.ownership_state == eCarSelection.State.Rental) && !activePage.isSimGrid) {
                if (car_model.preset.name != activePage.currentMech &&
                    car_model.configuration.name != activePage.currentVisual) {

                        console.log("Previewing", car_guid, car_model.name, car_model.configuration.name, car_model.preset.name);

                    VEHICLES.preview(car_model, (data) => {
                        activePage.currentMech = car_model.configuration.name;
                        activePage.currentVisual = car_model.preset.name;
                        VEHICLES.getCurrent();

                        // if (data.response == eClientCommands.Response.OK) {
                        //     VEHICLES.getCurrent().then(car => {
                        //         /* if (car.model.preset.name == currentvisual &&
                        //              car.model.configuration.name == currentmech) {
                        //              ksUI.changePage(ksUI.menuState.get().activeMenu + "/carselection");
                        //          }*/
                        //     });
                        // }
                    }, true);
                }
            } else {
                console.log("Setting", car_guid, car_model.name, car_model.configuration.name, car_model.preset.name);
                VEHICLES.setCurrent(car_model);
            }

        }

        bindModels() {

            qevAll("ks-btnpanel", "click sn:enter-down", this.bindModel, this.listModels);


            // $.qevAll("ks-btnpanel", "focus", (e) => {
            //     /** @type HTMLElement */
            //     // console.log("focused on button panel");
            //     const elem = e.target;

            //     const belem = elem.getBoundingClientRect();
            //     const bparent = elem.parentElement.getBoundingClientRect();
            //     const offset = belem.x - bparent.x;

            //     const selem = ksUI.getElementSize(elem);

            //     if (offset >= bparent.width - (selem.width)) {
            //         //elem.parentElement.scrollLeft += selem.width * 3;
            //     }

            //     if (offset < selem.width) {
            //         //elem.parentElement.scrollLeft -= selem.width * 3;
            //     }

            // }, this.listModels);


            this.setupNavigation();
        }

        bindControls() {

            // $.qev(".content", "scroll", (ev) => {
            //     console.log("IS SCROLLED!");
            // }, this.listModels);

            qevAll("ks-btnpanel", "click", (e) => {
                //ksUI.menuState.delFromStore("caller");
            });


            // this.btnGroupOwnership.onUpdate = (new_value, old_value) => {
            //     VEHICLES.dataFilters.ownershipState = new_value == 0 ? eCarSelection.State.Owned : eCarSelection.State.Rental;
            //     VEHICLES.getModels();
            // };

            this.listModels.onmouseover = (e) => {
                ksUI$1.menuState.toggleMouseHover(true);
            };

            this.listModels.onmouseleave = (e) => {
                ksUI$1.menuState.toggleMouseHover(false);
            };

            // $.qevAll(".items", "focus", (e) => {
            //     const itemoffset = e.target.offsetTop;
            //     const scrollheight = $.q(".scrollable-content", this).offsetHeight;
            //     const scrolled = $.q(".scrollable-content", this).scrollTop;
            //     //const scrl = Scrollbar.components.entries().next().value[0];

            //     if (itemoffset + scrolled > scrollheight) {
            //         scrl.scrollTo(scrl.scrollPosition + 0.5);
            //     } else if (itemoffset - scrolled < scrollheight) {
            //         scrl.scrollTo(scrl.scrollPosition - 0.5);
            //     }

            // }, this);


        }

        onAfterRenderControlHints(controlhints) {
            this.mapElementById("btnConfirm", controlhints);
            this.mapElementById("btnConfigure", controlhints);
            this.mapElementById("btnBack", controlhints);
            this.mapElementById("btnConnect", controlhints);

            if (this.isSimGrid) {

                this.btnConnect.onPressed = () => {
                    VEHICLES.getCurrent(() => {
                        console.log("Connecting to simgrid server", CurrentCar.model.car_guid);
                        this.StoredData.lastcarguid = CurrentCar.model.car_guid;
                        STORAGE.set(eStorageContainers.SimGridOptions, this.StoredData);
                        STORAGE.save(eStorageContainers.SimGridOptions);

                        this.ServerClient.request("ConnectToSimgrid", {
                            car_pguid: CurrentCar.model.car_pguid

                        }, (data) => {
                            (
                                {
                                    [eJoinErrorMessage.OK]: () => {
                                        console.log("Connection accepted, proceeding to server");
                                    },
                                    [eJoinErrorMessage.WrongCar]: () => {
                                        this.errorModal("lblError", "msgWrongCarSelected", false, null, true);
                                        console.warn("Connection rejected, wrong car selected");
                                    },
                                    [eJoinErrorMessage.ServerFull]: () => {
                                        this.errorModal("lblError", "msgServerFull", false, null, true);
                                        console.warn("Connection rejected, server full");
                                    },
                                    [eJoinErrorMessage.WrongPassword]: () => {
                                        this.errorModal("lblError", "msgInvalidPassword", false, null, true);
                                        console.warn("Connection rejected, wrong password");
                                    },
                                    [eJoinErrorMessage.ServerClosed]: () => {
                                        this.errorModal("lblError", "msgServerClosed", false, null, true);
                                        console.warn("Connection rejected, server closed");
                                    },
                                    [eJoinErrorMessage.RequirementsNotMet]: () => {
                                        this.errorModal("lblError", "msgRequirementsNotMet", false, null, true);
                                        console.warn("Connection rejected, requirements not met");
                                    },
                                    [eJoinErrorMessage.ClientOutdated]: () => {
                                        this.errorModal("lblError", "msgClientOutdated", false, null, true);
                                        console.warn("Connection rejected, client outdated");
                                    },
                                    [eJoinErrorMessage.ServerOutdated]: () => {
                                        this.errorModal("lblError", "msgServerOutdated", false, null, true);
                                        console.warn("Connection rejected, server outdated");
                                    },
                                    [eJoinErrorMessage.ClientRejected]: () => {
                                        this.errorModal("lblError", "msgClientRejected", false, null, true);
                                        console.warn("Connection rejected, client rejected");
                                    }

                                }[data.response])();
                        });
                    });
                };

                if (ModelPresets.items.length == 1) ;
            }



            this.btnConfirm.onBeforeRedirect = () => {
                const car_model = CurrentCar.model;
                VEHICLES.setCurrent(car_model, null, null, true);
            };

            this.btnBack.onBeforeRedirect = () => {
                // ksUI.requestGoBack(eGameModeSelection.BackFrom.Dealership);

                const previouscar = VEHICLES.previouslyViewedCar;
                const previousmodel = VEHICLES.previouslyViewedModel;

                if (previouscar) {

                    VEHICLES.updateDataFilters();
                    const prev_brand = CurrentCar.model.manufacturer;
                    const prev_state = CurrentCar.state;

                    console.log("Back", VEHICLES.dataFilters.ownershipState);

                    if (previouscar.state == eCarSelection.State.Owned) {

                        VEHICLES.setCurrent(previouscar.model, () => {
                            console.log("Restored owned car", previouscar.model.car_guid);
                            VEHICLES.dataFilters.activeBrand = prev_brand;
                            VEHICLES.dataFilters.ownershipState = prev_state;
                        });
                    } else {
                        if (previousmodel) {
                            if (previousmodel.state == eCarSelection.State.Owned) {
                                VEHICLES.setCurrent(previousmodel.model, () => {
                                    console.log("Restored owned car", previousmodel.model.car_guid);
                                    VEHICLES.dataFilters.activeBrand = prev_brand;
                                    VEHICLES.dataFilters.ownershipState = prev_state;
                                });
                            } else {
                                VEHICLES.preview(previousmodel.model, () => {
                                    console.log("Restored preview car", previousmodel.model.car_guid);
                                });
                            }
                        }
                    }
                }
            };

            if (ksUI$1.menuState.getFromStore("caller") == "brandselection") {
                q("ks-btnbasic.back", controlhints).setAttribute("path", "{activeMenu}/brandselection");
            }

            if (ksUI$1.menuState.getFromStore("caller") == "modelselection") {
                q("ks-btnbasic.back", controlhints).setAttribute("path", "{activeMenu}/modelselection");
            }

            if (this.isGarage()) {
                q("div", this.btnConfigure).setAttribute("data-l10n-id", "btnCustomize");
                this.btnConfigure.removeAttribute("path");
                this.btnConfigure.onPressed = () => {
                    ksUI$1.setCurrentAsReturnPage();
                    ksUI$1.showLoadingModal();
                    ksUI$1.requestNoResponse("CarCustomization", "GoToGarage");
                };
            } else {

                this.btnConfigure.onBeforeRedirect = () => {
                    ksUI$1.menuState.overrideShowcaseCamera(true, false);
                    ksUI$1.setCurrentAsReturnPage();
                };
            }


        }

        getVisuals(model_name, mechs = [], pi_limits = []) {

            console.log("getVariantsOfModel", model_name, mechs.join(","));

            let presets = { items: [] };
            let selected;

            VEHICLES.getAllModelsLite().then(models => {

                models.forEach(model => {
                    if (model.name == model_name) {
                        if (mechs && mechs.length > 0) {
                            const performance_indicator = Number(model.performance_indicator.toFixed(1));
                            if (mechs.indexOf(model.configuration.name) > -1 && (performance_indicator >= pi_limits[0] && performance_indicator <= pi_limits[1])) {
                                presets.items.push(model);
                                if (model.car_guid == this.StoredData.lastcarguid) {
                                    selected = model;
                                }
                            }
                        } else {
                            presets.items.push(model);
                            if (model.car_guid == this.StoredData.lastcarguid) {
                                selected = model;
                            }
                        }

                    }
                });

                VEHICLES.setCurrent(selected ?? presets.items[0]);

                VEHICLES.assignModel(presets, "ModelPresets");
                waitForFrames(() => {
                    this.listModels.classList.add("populated");
                    this.bindModels();

                }, 1);

                waitForFrames(() => {
                    this.scrollableContainers[0].scrollToElement(q("ks-btnpanel.selected"));
                }, 4);
            });

        }

        getModelVariants(mech) {
            console.log("getModelVariants", mech);
            let presets = { items: [] };

            Models.items.forEach(elem => {

                if (elem.name == VEHICLES.dataFilters.activeModel) {
                    if (mech && elem.configuration.name == mech) {
                        if (elem.__uimetadata) {
                            presets.items = elem.__uimetadata.presets.filter(variant => { return variant.configuration.name == mech });
                            return false;
                        } else {
                            presets.items.push(elem);
                        }

                    } else {
                        if (elem.__uimetadata) {
                            presets.items = elem.__uimetadata.presets;
                            return false;
                        } else {
                            presets.items.push(elem);
                        }
                    }
                }

            });

            console.trace(presets);
            VEHICLES.assignModel(presets, "ModelPresets");
            waitForFrames(() => {
                this.listModels.classList.add("populated");
            }, 1);
        }

        /**  @type {SimGridOptions} */
        _storedData = {};

        get StoredData() {
            return this._storedData;
        }

        set StoredData(new_data) {
            this._storedData = new_data;
        }

        ServerClient;

        onTemplateLoaded() {
            super.onTemplateLoaded();

            ksUI$1.menuState.overrideShowcaseCamera(true);

            this.CarSelectionClient = new MessageHandler("CarSelectionClient");

            waitForFrames(() => {
                ksUI$1.menuState.toggleMouseHover(false);
            }, 1);


            this.mapElementById("listModels", this);
            this.mapElementById("btnGroupOwnership", this);
            this.mapElementById("btnBrand", this);

            if (this.isSimGrid) {

                this.initStorageContainer(eStorageContainers.SimGridOptions, this.StoredData, SimGridOptions);
                this.ServerClient = new MessageHandler("MultiplayerServerList");
                this.documentBody.classList.add("simgrid");

                q("ks-pageheader").classList.remove("nologo");
                q("ks-pageheader").classList.remove("minimal");

                q("ks-pageheader div[slot=label]").dataset.l10nId = "headerLiverySelection";

                //VEHICLES.getCurrent();
                const path = ksUI$1.menuState.get().path.split("/");
                const target_model = path[1];
                const target_mechs = path[2].split(",");
                const pi_limits = path[3]?.split(",") ?? [0, 1000];

                console.warn(pi_limits);

                pi_limits[0] = Number(Number(pi_limits[0]).toFixed(1));
                pi_limits[1] = Number(Number(pi_limits[1]).toFixed(1));

                this.getVisuals(target_model, target_mechs, pi_limits);

            } else {


                console.warn("->>", VEHICLES.dataFilters.ownershipState);

                VEHICLES.dataFilters.ownershipState = CurrentCar.model.ownership_state;

                VEHICLES.getModels("", (data) => {
                    this.getModelVariants();
                    waitForFrames(() => this.bindModels(), 1);
                });

                ksUI$1.clearReturnPage();
                // } else {
                //     this.getModelVariants();
                //     $.waitForFrames(() => this.bindModels(), 1);
                // }

                VEHICLES.getCurrent();
            }

            this.documentBody.classList.add("vehiclepresetselection");
        }

        onRemovedFromDOM() {
            //Scrollbar.components.clear();
            this.altCssClass = false;
            this.documentBody.classList.remove("vehiclepresetselection");
            ksUI$1.menuState.toggleMouseHover(true);
            VEHICLES.clearHandlers();
            ksUI$1.unassignModel("ModelPresets", false, false);
            ksUI$1.menuState.overrideShowcaseCamera(false);

        }

    }
    ksUI$1.registerModule('ks-page-vehiclepresetselection', VehiclePresetSelectionPage);

    var template$1f = "<div class=\"component-body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back rounded focusable\" path=\"singleplayer/main\" usemenustateback></ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\">\r\n            <div data-l10n-id=\"headerSinglePlayer\">Single Player</div>\r\n            <div>/</div>\r\n            <div data-l10n-id=\"headerAssistsSettings\">Assists Settings</div>\r\n        </div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body centered-content align-items-center\">\r\n\r\n        <div class=\"is-flex\">\r\n            <div id=\"panelPresets\" class=\"is-flex-column align-items-center justify-content-center\">\r\n                <ks-btnbasic class=\"focusable\" data-mode=\"AssistPresetListType_BEGINNER\" toggle-group=\"presets\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"AssistPresetListType_BEGINNER\"></div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic class=\"focusable\" data-mode=\"AssistPresetListType_ROOKIE\" toggle-group=\"presets\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"AssistPresetListType_ROOKIE\"></div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic class=\"focusable\" data-mode=\"AssistPresetListType_EXPERT\" toggle-group=\"presets\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"AssistPresetListType_EXPERT\"></div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic class=\"focusable\" data-mode=\"AssistPresetListType_PRO\" toggle-group=\"presets\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"AssistPresetListType_PRO\"></div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic id=\"btnCustomPreset\" class=\"focusable\" data-mode=\"AssistPresetListType_CUSTOM\" toggle-group=\"presets\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"lblCustom\"></div>\r\n                </ks-btnbasic>\r\n            </div>\r\n            <div id=\"panelSettings\" class=\"is-flex-column justify-content-center\">\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                    <div class=\"label\" data-l10n-id=\"lblAssistAutomaticIgnition\"></div>\r\n                    <div class=\"togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"RacingSetting_ON\" data-setting=\"manual_ignition\" toggle-group=\"automatic_ignition\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"manual_ignition\" data-mode=\"RacingSetting_OFF\" toggle-group=\"automatic_ignition\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                    <div class=\"label\" data-l10n-id=\"lblAssistAutoGear\"></div>\r\n                    <div class=\"togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"RacingSetting_OFF\" data-setting=\"automatic_gearbox\" toggle-group=\"automatic_gearbox\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"automatic_gearbox\" data-mode=\"RacingSetting_ON\" toggle-group=\"automatic_gearbox\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                    <div class=\"label\" data-l10n-id=\"lblAssistAutoPitlimiter\"></div>\r\n                    <div class=\"togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"RacingSetting_OFF\" data-setting=\"automatic_pit_limiter\" toggle-group=\"automatic_pit_limiter\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"automatic_pit_limiter\" data-mode=\"RacingSetting_ON\" toggle-group=\"automatic_pit_limiter\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                    <div class=\"label\" data-l10n-id=\"lblAssistAutoClutch\"></div>\r\n                    <div class=\"togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"RacingSetting_OFF\" data-setting=\"automatic_clutch\" toggle-group=\"automatic_clutch\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"automatic_clutch\" data-mode=\"RacingSetting_ON\" toggle-group=\"automatic_clutch\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                    <div class=\"label\" data-l10n-id=\"lblAssistAutoClutchStart\"></div>\r\n                    <div class=\"togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"RacingSetting_OFF\" data-setting=\"automatic_clutch_on_start\" toggle-group=\"automatic_clutch_on_start\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"automatic_clutch_on_start\" data-mode=\"RacingSetting_ON\" toggle-group=\"automatic_clutch_on_start\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                    <div class=\"label\" data-l10n-id=\"lblAssistStandingStart\"></div>\r\n                    <div class=\"togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"RacingSetting_OFF\" data-setting=\"standing_start_assist\" toggle-group=\"standing_start_assist\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"standing_start_assist\" data-mode=\"RacingSetting_ON\" toggle-group=\"standing_start_assist\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                    <div class=\"label\" data-l10n-id=\"lblAssistAutoBlip\"></div>\r\n                    <div class=\"togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"RacingSetting_OFF\" data-setting=\"automatic_blip\" toggle-group=\"automatic_blip\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"automatic_blip\" data-mode=\"RacingSetting_ON\" toggle-group=\"automatic_blip\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                    <div class=\"label\" data-l10n-id=\"lblAssistAutoHeadlights\"></div>\r\n                    <div class=\"togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"RacingSetting_OFF\" data-setting=\"automatic_lights\" toggle-group=\"automatic_lights\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"automatic_lights\" data-mode=\"RacingSetting_ON\" toggle-group=\"automatic_lights\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                    <div class=\"label\" data-l10n-id=\"lblAssistAutoWipers\"></div>\r\n                    <div class=\"togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"RacingSetting_OFF\" data-setting=\"automatic_wipers\" toggle-group=\"automatic_wipers\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"automatic_wipers\" data-mode=\"RacingSetting_ON\" toggle-group=\"automatic_wipers\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                    <div class=\"label\" data-l10n-id=\"lblAssistIdealLine\"></div>\r\n                    <div class=\"togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"RacingSetting_OFF\" data-setting=\"ideal_line\" toggle-group=\"ideal_line\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"ideal_line\" data-mode=\"RacingSetting_ON\" toggle-group=\"ideal_line\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"togglegroup is-flex align-items-center focus-indicator stability-control\">\r\n                    <div class=\"label\" data-l10n-id=\"lblAssistStabilityControl\"></div>\r\n                    <div class=\"togglebuttons is-flex\">\r\n                        <ks-btnbasic class=\"focusable\" data-mode=\"RacingSetting_OFF\" data-setting=\"stabilty_control_mode\" toggle-group=\"stabilty_control_mode\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOffUpper\"></div>\r\n                        </ks-btnbasic>\r\n                        <ks-btnbasic class=\"focusable\" data-setting=\"stabilty_control_mode\" data-mode=\"RacingSetting_ON\" toggle-group=\"stabilty_control_mode\" toggle>\r\n                            <div slot=\"name\" data-l10n-id=\"lblOnUpper\"></div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n                <ks-slider class=\"focusable oneline percentile focus-indicator\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"stability_control\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblAssistStabilityControl\"></div>\r\n                    <div slot=\"unit\">%</div>\r\n                </ks-slider>\r\n\r\n\r\n\r\n\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n\r\n</div>";

    class AssistSettingsPage extends KsHTMLElement {

        /** @type HTMLDivElement */
        panelSettings;
        /** @type HTMLDivElement */
        panelPresets;
        /** @type Btnbasic */
        btnCustomPreset;

        /** @typedef {import('../../singleplayer/singleplayer').default} SinglePlayerPage */
        /** @type { SinglePlayerPage } */
        rootPage;


        constructor() {
            super();
            this.template = template$1f;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this.delayedInit = true;
        }

        bindControls() {
            qAll("ks-btnbasic", this.panelPresets).forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        this.rootPage.getCurrentAssists(sender.dataset.mode);
                        this.setFromCurrentPreset();
                        this.save();
                    };
                });

            qAll(".togglegroup ks-btnbasic", this.panelSettings).forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {

                        if (window["CurrentAssistPreset"]) {
                            this.btnCustomPreset.toggle(true);
                            CurrentAssistPreset.type = "AssistPresetListType_CUSTOM";
                            if (state) {
                                CurrentAssistPreset[sender.dataset.setting] = sender.dataset.mode;
                            }
                            this.save();
                        }
                    };
                });

            qevAll("ks-slider", "onSliderValueChanged", (ev) => {

                this.btnCustomPreset.toggle(true);
                CurrentAssistPreset.type = "AssistPresetListType_CUSTOM";

                const detail = ev.detail;
                const sender = detail.sender;
                const setting = sender.dataset.setting;
                const value = detail.value;

                if (sender.classList.contains("percentile")) {
                    CurrentAssistPreset[setting] = value / 100;
                } else {
                    CurrentAssistPreset[setting] = value;
                }

                cancelAnimationFrame(this.saveDebounce.id);

                waitForFrames(() => {
                    this.save();
                }, 6, this.saveDebounce);

            }, this.panelSettings);

        }

        init() {
            super.init();

            waitForFrames(() => {
                q("ks-btnbasic[data-mode=" + Assists.current_preset + "]", this.panelPresets).toggle(true);

                this.setFromCurrentPreset();

            }, 1);
        }

        setFromCurrentPreset() {
            qAll(".togglegroup ks-btnbasic", this.panelSettings).forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    if (window["CurrentAssistPreset"]) {
                        let elem_bool = elem.dataset.mode === eRacingSetting.On;
                        let toggle_on = elem_bool == (CurrentAssistPreset[elem.dataset.setting] == eRacingSetting.On);
                        elem.classList.toggle("selected", toggle_on);
                    }
                });

            qAll("ks-slider", this.panelSettings).forEach(
                /** @param {KsSlider} elem */
                elem => {
                    elem.valueNoEvent = CurrentAssistPreset[elem.dataset.setting] * ((elem.classList.contains("percentile") ? 100 : 1));
                    //console.log(">>", CurrentAssistPreset[elem.dataset.setting], elem.classList.contains("percentile"));
                });
        }

        saveDebounce = { id: 0 };
        save(callback) {
            cancelAnimationFrame(this.saveDebounce.id);
            this.rootPage.RacingSettingsClient.request("AssistSavePreset", {
                preset: CurrentAssistPreset
            }, (data) => {
                console.log("Saved", CurrentAssistPreset.type, data.response);
                // Assists.current_preset = CurrentAssistPreset.type;
                // this.rootPage.currentAssistPresetListType = CurrentAssistPreset.type;
                // this.rootPage.assignModel(CurrentAssistPreset, "CurrentAssistPreset");
                this.rootPage.getCurrentAssists(CurrentAssistPreset.type, true);
                activePage.setFromCurrentPreset();
                if (callback) {
                    callback();
                }
            });
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("panelSettings");
            this.mapElementById("panelPresets");
            this.mapElementById("btnCustomPreset");

            console.log("showing", Assists.current_preset);
        }


    }
    ksUI$1.registerModule('ks-page-assists', AssistSettingsPage);

    var template$1e = "<div class=\"component-body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back rounded focusable\" path=\"singleplayer/main\"></ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\">\r\n            <div data-l10n-id=\"headerSinglePlayer\">Single Player</div>\r\n            <div>/</div>\r\n            <div data-l10n-id=\"headerWeatherSettings\">Weather Settings</div>\r\n        </div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body centered-content align-items-center\">\r\n\r\n        <div class=\"is-flex flex-1\">\r\n            <div id=\"panelPresets\" class=\"is-flex-column align-items-center justify-content-center\">\r\n                <ks-btnbasic class=\"focusable\" data-mode=\"GameModeSelectionWeatherType_CLEAR\" toggle-group=\"presets\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"GameModeSelectionWeatherType_CLEAR\"></div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic class=\"focusable\" data-mode=\"GameModeSelectionWeatherType_SCATTERED_CLOUDS\" toggle-group=\"presets\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"GameModeSelectionWeatherType_SCATTERED_CLOUDS\"></div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic class=\"focusable\" data-mode=\"GameModeSelectionWeatherType_BROKEN_CLOUDS\" toggle-group=\"presets\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"GameModeSelectionWeatherType_BROKEN_CLOUDS\"></div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic class=\"focusable\" data-mode=\"GameModeSelectionWeatherType_OVERCAST\" toggle-group=\"presets\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"GameModeSelectionWeatherType_OVERCAST\"></div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic class=\"focusable\" data-mode=\"GameModeSelectionWeatherType_DRIZZLE\" toggle-group=\"presets\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"GameModeSelectionWeatherType_DRIZZLE\"></div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic class=\"focusable\" data-mode=\"GameModeSelectionWeatherType_RAIN\" toggle-group=\"presets\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"GameModeSelectionWeatherType_RAIN\"></div>\r\n            </ks-btnbasic>\r\n\r\n                <ks-btnbasic class=\"focusable\" data-mode=\"GameModeSelectionWeatherType_HEAVY_RAIN\" toggle-group=\"presets\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"GameModeSelectionWeatherType_HEAVY_RAIN\"></div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic class=\"focusable custom\" data-mode=\"GameModeSelectionWeatherType_CUSTOM\" toggle-group=\"presets\" toggle disabled=\"disabled\">\r\n                    <div slot=\"name\" data-l10n-id=\"GameModeSelectionWeatherType_CUSTOM\"></div>\r\n                </ks-btnbasic>\r\n            </div>\r\n\r\n            <div id=\"settings\" class=\"is-flex-column justify-content-center\">\r\n                <div id=\"panelSettings\" class=\"is-flex-column justify-content-center\">\r\n                    <div class=\"header-label\" data-l10n-id=\"lblWeatherHeader\">WEATHER CONDITIONS</div> \r\n                    <hr>\r\n                    <div id=\"panelWeatherBehaviour\" class=\"togglegroup is-flex align-items-center focus-indicator\">\r\n                        <div class=\"label\" data-l10n-id=\"lblWeatherMode\"></div>\r\n                        <div class=\"togglebuttons is-flex justify-content-center\">\r\n                            <ks-btnbasic class=\"focusable\" data-mode=\"GameModeSelectionWeatherBehaviour_DYNAMIC\" toggle-group=\"weathermode\" toggle>\r\n                                <div slot=\"name\" data-l10n-id=\"lblDynamic\"></div>\r\n                            </ks-btnbasic>\r\n    \r\n                            <ks-btnbasic class=\"focusable\" data-mode=\"GameModeSelectionWeatherBehaviour_STATIC\" toggle-group=\"weathermode\" toggle>\r\n                                <div slot=\"name\" data-l10n-id=\"lblStatic\"></div>\r\n                            </ks-btnbasic>\r\n                        </div>\r\n                    </div>\r\n    \r\n                    <!-- <ks-slider\r\n                        class=\"focusable oneline\"\r\n                        min=\"0\"\r\n                        max=\"45\"\r\n                        step=\"1\"\r\n                        data-setting=\"ambientTemp\"\r\n                        data-bind-inputvalue=\"{{CurrentWeatherData.weather_data.ambientTemp}}\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblAmbientTemperature\"></div>\r\n                        <div slot=\"unit\">&deg;C</div>\r\n                    </ks-slider> -->\r\n    \r\n                    <ks-slider disabled=\"disabled\" class=\"focusable oneline percentile\" min=\"0\" max=\"100\" step=\"1\" value=\"0\" data-setting=\"sky_coverage\" data-bind-inputvalue=\"{{CurrentWeatherData.weather_data.sky_coverage}} * 100\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblCloudCoverage\"></div>\r\n                        <div slot=\"unit\">%</div>\r\n                    </ks-slider>\r\n    \r\n                    <!-- <ks-slider\r\n                        class=\"focusable oneline percentile\"\r\n                        min=\"0\"\r\n                        max=\"100\"\r\n                        step=\"1\"\r\n                        value=\"0\"\r\n                        data-bind-inputvalue=\"{{CurrentWeatherData.weather_data.cloudWetness}} * 100\"\r\n                        data-setting=\"cloudWetness\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblCloudWetness\"></div>\r\n                        <div slot=\"unit\">%</div>\r\n                    </ks-slider> -->\r\n    \r\n                    <ks-slider disabled=\"disabled\" class=\"focusable oneline percentile\" min=\"0\" max=\"100\" step=\"1\" value=\"0\" data-bind-inputvalue=\"{{CurrentWeatherData.weather_data.precipitation}} * 100\" data-setting=\"precipitation\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblPrecipitation\"></div>\r\n                        <div slot=\"unit\">%</div>\r\n                    </ks-slider>\r\n    \r\n                    <ks-slider disabled=\"disabled\" class=\"focusable oneline percentile\" min=\"0\" max=\"100\" step=\"1\" value=\"0\" data-bind-inputvalue=\"{{CurrentWeatherData.weather_data.fog}} * 100\" data-setting=\"fog\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblFogDensity\"></div>\r\n                        <div slot=\"unit\">%</div>\r\n                    </ks-slider>\r\n    \r\n                    <ks-slider disabled=\"disabled\" class=\"focusable oneline\" min=\"0\" max=\"360\" step=\"1\" value=\"0\" data-setting=\"wind_direction_deg\" data-bind-inputvalue=\"{{CurrentWeatherData.weather_data.wind_direction_deg}}\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblWindDirection\"></div>\r\n                        <div slot=\"unit\">&deg;</div>\r\n                    </ks-slider>\r\n    \r\n                    <ks-slider disabled=\"disabled\" class=\"focusable oneline\" min=\"0\" max=\"15\" step=\"1\" value=\"0\" data-setting=\"wind_speed_m_s\" data-bind-inputvalue=\"{{CurrentWeatherData.weather_data.wind_speed_m_s}}\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblWindSpeed\"></div>\r\n                        <div slot=\"unit\">m/s</div>\r\n                    </ks-slider>\r\n                    \r\n                </div>\r\n    \r\n                <div id=\"trackSettings\" class=\"is-flex-column justify-content-center\">\r\n                    <div class=\"header-label\" data-l10n-id=\"lblTrackConditionsHeader\">TRACK CONDITIONS</div>        \r\n                    <hr>    \r\n                    <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{CurrentWeatherData.initial_grip}}\" values='[\"InitialGrip_GREEN\",\"InitialGrip_FAST\",\"InitialGrip_OPTIMUM\"]' data-settings=\"initial_grip\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblTrackConditionsInitialGrip\">INITIAL GRIP</div>\r\n                        <div slot=\"unit\"></div>\r\n                    </ks-slider>\r\n                </div>\r\n\r\n            </div>\r\n            \r\n\r\n        </div>\r\n    </div>\r\n</div>";

    class WeatherSettingsPage extends KsHTMLElement {

        /** @type HTMLDivElement */
        panelSettings;
        /** @type HTMLDivElement */
        panelPresets;
        /** @type HTMLDivElement */
        panelWeatherBehaviour;

        loading = true;

        /** @typedef {import('../../singleplayer/singleplayer').default} SinglePlayerPage */
        /** @type { SinglePlayerPage } */
        rootPage;

        preventSliderTrigger = false;
        weather_behaviour;
        initial_grip;

        constructor() {
            super();
            this.template = template$1e;
            this._exposeAsActivePage = true;
            this._isnavigable = true;
            this.delayedInit = true;
        }

        bindControls() {
            qAll("ks-btnbasic", this.panelPresets).forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        if (this.loading) { return; } 

                            if (state && sender.dataset.mode == eGameModeSelectionWeatherType.Custom) {
                                this.preventSliderTrigger = false;
                                qAll("ks-slider", this.panelSettings).forEach(elem => {
        
                                });
                                this.panelSettings.removeAttribute("disabled");
                            }
        
                            if (state) {
                                this.preventSliderTrigger = true;                            
                                this.rootPage.getCurrentWeatherData(sender.dataset.mode);                                                      
                                CurrentWeatherData.behaviour = this.weather_behaviour;
                                CurrentWeatherData.initial_grip = this.initial_grip;
                                this.save();
                            }
                    };
                });

            qAll("ks-btnbasic", this.panelWeatherBehaviour).forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {                     
                        if (this.loading) { return; } 

                            if (state) {                            
                                CurrentWeatherData.behaviour = sender.dataset.mode;                                                      
                                this.save();
                            }                    
                    };
                });

            qevAll("ks-slider", "onSliderValueChanged", (ev) => {
                if (this.preventSliderTrigger) return;
               
                const detail = ev.detail;
                const sender = detail.sender;
                const setting = sender.dataset.setting;
                const value = detail.value;
              
                if (sender.classList.contains("percentile")) {
                    CurrentWeatherData.weather_data[setting] = value / 100;
                } else {
                    CurrentWeatherData.weather_data[setting] = value;
                }
                
                cancelAnimationFrame(this.saveDebounce.id);

                waitForFrames(() => {
                    this.save();
                }, 6, this.saveDebounce);
                
            }, this.panelSettings);

            qevAll("ks-slider", "onSliderValueChanged", (ev) => {
                if (this.preventSliderTrigger) return;
                let detail = ev.detail;            
                detail.sender;
                let detaildata = detail.sender.dataset;           

                const path = detaildata.bindKsvalue.replace(/[{}]/g, "").split(".");           
                const sourcevalue = Function(`return window["${path.join('"]["')}"]`)();
                const value = ksUI$1.sameType(sourcevalue, typeof sourcevalue == "boolean" ? detail.index : detail.value);
                const type = typeof value;
                Function(`window["${path.join('"]["')}"]=${type == "string" ? '"' + detail.value + '"' : type == "boolean" ? detail.sender.index == 1 : value}`)();
                
                this.initial_grip = value;
                cancelAnimationFrame(this.saveDebounce.id);
                waitForFrames(() => {
                    this.save();
                }, 6, this.saveDebounce);

            }, this.trackSettings);
        }

        saveDebounce = { id: 0 };
        save(callback) {
            cancelAnimationFrame(this.saveDebounce.id);       
            this.rootPage.GameModeSelectionClient.request("SetWeather", {
                weather_data: CurrentWeatherData
            }, (data) => {
                console.log("Saved", CurrentWeatherData.initial_grip, data.response);           
                waitForFrames(() => {
                    //GAMEMODE.getGameModeParameters();
                    this.rootPage.getCurrentGameMode();
                    this.preventSliderTrigger = false;
                }, 3);
                if (callback) {
                    callback();
                }
            });
        }

        init() {
            super.init();

            waitForFrames(() => {
                q("ks-btnbasic[data-mode=" + CurrentWeatherData.behaviour + "]", this.panelWeatherBehaviour).press();
                q("ks-btnbasic[data-mode=" + CurrentWeatherData.type + "]", this.panelPresets).press();
            }, 1);

        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("panelSettings");
            this.mapElementById("panelPresets");
            this.mapElementById("panelWeatherBehaviour");
            
            this.weather_behaviour = CurrentWeatherData.behaviour;
            this.initial_grip = CurrentWeatherData.initial_grip;

            ksUI$1.waitForFrames(() => {
                this.loading = false;            
            }, 4);

        }

    }
    ksUI$1.registerModule('ks-page-weather', WeatherSettingsPage);

    var template$1d = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" goto=\"menu.html\" path=\"main/main\" class=\"back rounded focusable\"></ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\" data-l10n-id=\"headerSinglePlayer\">Single Player</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body\">\r\n        <div class=\"row large centered-content top-row\">\r\n\r\n            <ks-btnpanel id=\"btnGameMode\" class=\"full focusable split50\" data-bind-ksvalue=\"{{CurrentGameMode}}.type\" path=\"singleplayer/gamemode\">\r\n\r\n                <div slot=\"subtitle\" class=\"is-flex-row flex-1 align-items-center\">\r\n\r\n                    <div class=\"is-flex-column flex-1-50 align-items-center justify-content-center\">\r\n                        <div class=\"title\" data-l10n-id=\"panelSelectGameMode\"></div>\r\n                        <div class=\"label\" data-bind-l10n-id=\"{{CurrentGameMode}}.type\">\r\n                            DRIFT\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"details is-flex-row\">\r\n                        <div class=\"label\" data-l10n-id=\"lblSessions\">sessions</div>\r\n                        <div class=\"is-flex-column sessions\">\r\n                            <div class=\"is-flex-row session-item flex-1\" data-bind-for=\"session:{{CurrentGameMode.sessions}}\" data-bind-if=\"{{session.duration}} > 0\">\r\n                                <div class=\"label\" data-bind-l10n-id=\"'lblSessionName_' + {{session.name}}\"></div>\r\n                                <div class=\"timeofday is-flex-row flex-1 justify-content-end align-items-center\">\r\n                                    <div data-bind-value=\"{{session.time_of_day.hour}}\"></div>\r\n                                    <div>:</div>\r\n                                    <div data-bind-value=\"ksUI.pad({{session.time_of_day.minute}},2)\"></div>\r\n                                </div>\r\n                                <div class=\"value is-flex-row\" data-bind-if=\"{{session.duration_type}} == 'GameModeSelectionDuration_TIME'\">\r\n                                    <div data-bind-value=\"{{session.duration}}/60\"></div>\r\n                                    <div class=\"unit\" data-l10n-id=\"labelAbbrMinutes\"></div>\r\n                                </div>\r\n                                <div class=\"value is-flex-row\" data-bind-if=\"{{session.duration_type}} == 'GameModeSelectionDuration_LAPS'\">\r\n                                    <div data-bind-value=\"{{session.duration}}\"></div>\r\n                                    <div class=\"unit\" data-l10n-id=\"labelLaps\"></div>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div class=\"is-flex-column no-opponents align-items-center\" data-bind-if=\"({{CurrentGameMode}}.sessions[0].grid_type == 'GameModeSelectionGridType_CUSTOM' && {{CurrentGameMode.sessions[0].models.length}} == 0) || {{CurrentGameMode}}.sessions[0].num_opponents == 0\">\r\n                            <div class=\"label\" data-l10n-id=\"lblNoOpponents\">opponents</div>\r\n                        </div>\r\n\r\n\r\n                        <div class=\"is-flex-column opponents align-items-center\" data-bind-if=\"{{CurrentGameMode}}.sessions[0].grid_type == 'GameModeSelectionGridType_CUSTOM' && {{CurrentGameMode.sessions[0].models.length}} > 0\">\r\n                            <div class=\"label\" data-l10n-id=\"lblOpponentsUpper\">opponents</div>\r\n                            <div class=\"value\" data-bind-value=\"Math.min({{CurrentGameMode.sessions[0].opponents.length}},{{CurrentTrack}}.max_drivers-1)\"></div>\r\n                        </div>\r\n\r\n                        <div class=\"is-flex-column opponents align-items-center\" data-bind-if=\"{{CurrentGameMode}}.sessions[0].grid_type == 'GameModeSelectionGridType_AUTO' && {{CurrentGameMode}}.sessions[0].num_opponents > 0\">\r\n                            <div class=\"label\" data-l10n-id=\"lblOpponentsUpper\">opponents</div>\r\n                            <div class=\"value\" data-bind-value=\"Math.min({{CurrentGameMode.sessions[0].num_opponents}}, {{CurrentTrack}}.max_drivers-1)\"></div>\r\n                        </div>\r\n\r\n                        <div class=\"is-flex-column opponents skill align-items-center\" data-bind-if=\"{{CurrentGameMode.sessions[0].num_opponents}} > 0\">\r\n                            <div class=\"label\" data-l10n-id=\"lblSkillUpper\"></div>\r\n                            <div class=\"value is-flex-row\">\r\n                                <div data-bind-value=\"[{{CurrentGameMode}}.sessions[0].min_strength,{{CurrentGameMode}}.sessions[0].max_strength].join('-')\"></div>%\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"is-flex-column opponents align-items-center\" data-bind-if=\"{{CurrentGameMode.sessions[0].num_opponents}} > 0\">\r\n                            <div class=\"label\" data-l10n-id=\"lblBehaviourUpper\"></div>\r\n                            <div class=\"value is-flex-row\">\r\n                                <div data-bind-l10n-id=\"['lblBehaviour',{{CurrentGameMode}}.sessions[0].aggressivness].join('')\"></div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </ks-btnpanel>\r\n\r\n            <ks-btnpanel id=\"btnTrack\" class=\"half focusable\" path=\"singleplayer/trackselection\" data-bind-ksmessage=\"{{CurrentTrack}}\">\r\n                <div slot=\"extra\" class=\"map\"></div>\r\n                <div slot=\"subtitle\">\r\n                    <div class=\"name is-flex-row\">\r\n                        <div class=\"track_name\" data-bind-value=\"{{CurrentTrack.name}}\">Name</div>\r\n                        <div class=\"track_layout\" data-bind-if=\"isNaN({{CurrentTrack.layout}})\" data-bind-value=\"{{CurrentTrack.layout}}\"></div>\r\n                    </div>\r\n                    <div class=\"track_length is-flex-row align-items-center\" data-bind-if=\"{{CurrentTrack}}.track_length > 0\">\r\n                        <div class=\"label\" data-l10n-id=\"lblTrackLength\"></div>\r\n                        <div class=\"value is-flex-row justify-content-start align-items-center\" data-bind-htmlvalue=\"ksUI.appendSuffix({{CurrentTrack}}.track_length, 'M', true, 'suffix')\"></div>\r\n                    </div>\r\n\r\n                    <div class=\"track_pitboxes is-flex-row align-items-center\" data-bind-if=\"{{CurrentTrack}}.max_drivers > 0\">\r\n                        <div class=\"label\" data-l10n-id=\"lblNumberOfPitboxes\"></div>\r\n                        <div class=\"value is-flex-row justify-content-start\" data-bind-value=\"{{CurrentTrack}}.max_drivers\"></div>\r\n                    </div>\r\n                </div>\r\n            </ks-btnpanel>\r\n\r\n            <ks-btnpanel id=\"btnCar\" class=\"half focusable brand\" path=\"singleplayer/brandselection\" data-bind-ksmessage=\"{{CurrentCar.model}}\" storeorigin=\"true\">\r\n                <div slot=\"extra\">\r\n                    <div class=\"price\">\r\n                        <div class=\"label\" data-l10n-id=\"lblRentalSingular\">RENTAL</div>\r\n                        <div class=\"row-wrapper is-flex-row\">\r\n                            <span class=\"value\" data-bind-value=\"{{CurrentCar}}.model.price\"></span>\r\n                            <span class=\"suffix\">v$</span>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"odometer\"><span data-bind-value=\"{{CurrentCar}}.model.total_km.toFixed(1)\"></span> km</div>\r\n                </div>\r\n                <div slot=\"title\">\r\n                </div>\r\n                <div slot=\"subtitle\">\r\n                    <div class=\"label\" data-bind-value=\"{{CurrentCar.model.display_name}}\"></div>\r\n                    <div class=\"details is-flex-column\">\r\n                        <div class=\"is-flex-row\">\r\n                            <div class=\"\" data-l10n-id=\"lblConfiguration\"></div>\r\n                            <div data-bind-value=\"{{CurrentCar.model.translated.mech}}\"></div>\r\n                        </div>\r\n                        <div class=\"is-flex-row\">\r\n                            <div data-l10n-id=\"lblTrim\"></div>\r\n                            <div data-bind-value=\"{{CurrentCar.model.translated.visual}}\"></div>\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n                </div>\r\n            </ks-btnpanel>\r\n\r\n        </div>\r\n\r\n        <div class=\"row centered-content bottom-row\">\r\n            <ks-btnpanel id=\"btnWeather\" class=\"split50 half focusable\" path=\"singleplayer/weather\" data-bind-ksvalue=\"{{CurrentGameMode}}.weather_type\">\r\n\r\n                <div slot=\"subtitle\" class=\"is-flex-row flex-1 align-items-center\">\r\n\r\n                    <div class=\"main-label is-flex-column flex-1-50 align-items-center justify-content-center\">\r\n                        <div class=\"title\" data-l10n-id=\"panelWeatherAndTrackSettings\"></div>\r\n                        <div class=\"label\" data-bind-l10n-id=\"{{CurrentGameMode}}.weather_type\">\r\n                            CLEAR\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"details is-flex-column\">\r\n\r\n                        <div class=\"label\" data-l10n-id=\"panelWeatherSettings\"></div>\r\n                        <div class=\"value\" data-bind-l10n-id=\"APF()?.weatherBehaviour({{CurrentWeatherData.behaviour}})\"></div>\r\n                    </div>\r\n\r\n                </div>\r\n            </ks-btnpanel>\r\n\r\n            <ks-btnpanel id=\"btnAssists\" class=\"half focusable split50\" path=\"singleplayer/assists\">\r\n\r\n                <div slot=\"subtitle\" class=\"is-flex-row flex-1 align-items-center\">\r\n\r\n                    <div class=\"details is-flex-row align-items-end justify-content-end\">\r\n                        <div class=\"is-flex-column assist\">\r\n                            <div data-l10n-id=\"lblAssistAutoGear\"></div>\r\n                            <div data-bind-l10n-id=\"APF()?.racingSetting({{CurrentAssistPreset.automatic_gearbox}})\"></div>\r\n                        </div>\r\n                        <div class=\"is-flex-column assist\">\r\n                            <div data-l10n-id=\"lblAssistAutoClutch\"></div>\r\n                            <div data-bind-l10n-id=\"APF()?.racingSetting({{CurrentAssistPreset.automatic_clutch}})\"></div>\r\n                        </div>\r\n                        <div class=\"is-flex-column assist\">\r\n                            <div data-l10n-id=\"lblAssistStabilityControl\"></div>\r\n                            <div data-bind-value=\"Math.round({{CurrentAssistPreset.stability_control}} * 100) + '%'\"></div>\r\n                        </div>\r\n                        <div class=\"is-flex-column assist\">\r\n                            <div data-l10n-id=\"lblAssistIdealLine\"></div>\r\n                            <div data-bind-l10n-id=\"APF()?.racingSetting({{CurrentAssistPreset.ideal_line}})\"></div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"is-flex-column flex-1-50 justify-content-center align-items-center\">\r\n                        <div class=\"title\" data-l10n-id=\"panelAssists\"></div>\r\n                        <div class=\"label\" data-bind-l10n-id=\"{{Assists.current_preset}}\">\r\n                            DRIFT\r\n                        </div>\r\n                    </div>\r\n\r\n\r\n                </div>\r\n            </ks-btnpanel>\r\n        </div>\r\n\r\n        <ks-btnbasic id=\"btnStartSession\" class=\"start rounded focusable defaultFocus\">\r\n            <div slot=\"name\" data-l10n-id=\"btnStartSession\">START SESSION</div>\r\n        </ks-btnbasic>\r\n    </div>\r\n\r\n</div>";

    class SinglePlayerHub extends KsHTMLElement {


        /** @type BtnPanel */
        btnStartSession;

        /** @type BtnPanel */
        btnGameMode;

        /** @type BtnPanel */
        btnCar;

        /** @type BtnPanel */
        btnTrack;

        /** @type Btnbasic */
        btnBack;

        /** @typedef {import('../singleplayer').default} SinglePlayerPage */
        /** @type { SinglePlayerPage } */
        parentPage;


        constructor() {
            super();
            this.template = template$1d;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this.delayedInit = true;
        }

        filters = {
            racingSetting: (racing_setting) => {
                return racing_setting == eRacingSetting.On ? "lblOnUpper" : racing_setting == eRacingSetting.Off ? "lblOffUpper" : "lblFreeUpper";
            },
            weatherBehaviour: (weather_behaviour) => {
                console.warn(weather_behaviour);
                return weather_behaviour == eGameModeSelectionWeatherBehaviour.Dynamic ? "lblDynamic" : "lblStatic";
            }
        }

        onAfterRenderControlHints(controlhints) {
            this.mapElementById("btnBack", controlhints);

            this.btnBack.onBeforeRedirect = () => {
                ksUI$1.requestGoBack(eGameModeSelection.BackFrom.Singleplayer);
            };
        }

        bindControls() {

            this.btnStartSession.onPressed = () => {
                ksUI$1.setOriginAsReturnPage();
                GAMEMODESELECTION.start()
                    .then(data => {
                        console.log("Starting session");
                    })
                    .catch(data => {
                        console.error(data.response);
                        this.errorModal("lblError", data.response, false, () => { this.pageModal.Hide(); });

                    });

                //this.parentPage.GameModeSelectionClient.requestNoResponse("Start", { mode: eClientCommands.Mode.Single });
                //    ksUI.goTo("ingame.html", "event");
            };

            this.btnCar.onBeforeRedirect = () => {
                //VEHICLES.dataFilters.activeBrand = VEHICLES.allBrands;

                //VEHICLES.dataFilters.ownershipState = eCarSelection.State.Dealership;
                VEHICLES.updateDataFilters();
                ksUI$1.menuState.addToStore("caller", "fromgamemode");
            };

        }


        init() {
            super.init();

            const validcar = window["CurrentCar"] && CurrentCar.model.name != '';
            const validtrack = window["CurrentTrack"] && CurrentTrack.name != '';

            this.btnTrack.classList.toggle("error", !validtrack);
            this.btnCar.classList.toggle("error", !validcar);

            if (!validcar || !validtrack) {
                this.btnStartSession.setAttribute("disabled", "");
            } else {
                this.btnStartSession.removeAttribute("disabled");
            }

        }


        onTemplateLoaded() {
            super.onTemplateLoaded();


            localStorage.removeItem("returnPage");
            ksUI$1.menuState.storeOrigin().save();

            this.mapElementById("btnStartSession");
            this.mapElementById("btnGameMode");
            this.mapElementById("btnCar");
            this.mapElementById("btnTrack");

            this.parentPage = q("ks-page-singleplayer");
            this.parentPage.updateAssignedModels();

            //this.parentPage.getCurrentGameMode();
            this.parentPage.getCurrentTrack();

            //GAMEMODE.refreshDataModel();
            GAMEMODESELECTION.getGameModeParameters().then(data => {
                if (data.mode != eClientCommands.Mode.Single) {
                    console.error("Gamemode parameters returned are for ", data.mode);
                    this.errorModal("lblError", "msgErrorInvalidGameModeParameters", true);

                }

                if ([eGameModeType.InstantRace, eGameModeType.RaceWeekend].indexOf(data.type) > -1) {

                    const should_disable = (GAMEMODESELECTION.sessionZero.grid_type == eGameModeSelection.GridType.Custom && GAMEMODESELECTION.sessionZero.models.length == 0) || GAMEMODESELECTION.sessionZero.num_opponents == 0;

                    this.btnStartSession.classList.toggle("disabled", should_disable);
                }

            });

            VEHICLES.getCurrent();
        }


    }

    ksUI$1.registerModule('ks-page-singleplayer-hub', SinglePlayerHub);

    var template$1c = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"btnBack\">Back</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"apply focusable\" id=\"apply\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnApply\">Apply</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"cancel focusable\" id=\"cancel\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCancel\">Cancel</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n\r\n        <div class=\"group center\"></div>\r\n\r\n        <div class=\"group end\">\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\">\r\n            <div data-l10n-id=\"headerSettings\">Settings</div>\r\n            <div>/</div>\r\n            <div data-l10n-id=\"headerGameplay\">Gameplay</div>\r\n        </div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body is-flex-column\">\r\n        <div id=\"btnGroupModes\" class=\"is-flex-row tab-selectors\">\r\n            <div class=\"controltip\">\r\n\r\n            </div>\r\n\r\n            <ks-btnbasic class=\"focusable selected\" data-mode=\"gameplay\" toggle-group=\"section\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"lblGameplaySettings\">Gameplay</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic class=\"focusable hud\" data-mode=\"hud\" toggle-group=\"section\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"lblHUDSettings\">HUD</div>\r\n            </ks-btnbasic>\r\n\r\n            <div class=\"controltip\">\r\n\r\n            </div>\r\n        </div>\r\n        <div id=\"panelModes\" data-mode=\"gameplay\" class=\"column\">\r\n\r\n            <div class=\"gameplay scrollable-element scrollable-vertical is-flex-column\">\r\n                <div class=\"header-label\" data-l10n-id=\"lblGameplaySettingsGeneral\">GENERAL</div>\r\n                <hr>\r\n                <ks-slider id=\"sliderLanguage\" class=\"oneline focusable\" data-bind-ksvalue=\"{{GameplaySettings.language}}\" values='[\"en\", \"es\", \"de\", \"fr\", \"it\", \"cn\", \"ru\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblGameplayLanguage\">Language</div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-bind-ksvalue=\"{{GameplaySettings.skip_intro}}\" values='[\"optionOff\",\"optionOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblGameplaySkipIntro\">Skip Intro</div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{GameplaySettings.driver_nameplates}}\" values='[\"DriverNamePlates_MPOnly\",\"DriverNamePlates_AlwaysOff\",\"DriverNamePlates_AlwaysOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblGameplayDriverNameplates\">Driver nameplates</div>\r\n                </ks-slider>\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"lblGameplaySettingsReplay\">REPLAY</div>\r\n                <hr>\r\n                <ks-slider id=\"sliderReplayQuality\" class=\"oneline focusable\" data-bind-ksvalue=\"{{Settings.settings.quality}}\" values='[\"VeryLow\", \"Low\", \"Medium\", \"High\", \"Insane\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblGameplayReplayQuality\">Replay Quality</div>\r\n                </ks-slider>\r\n                <ks-slider id=\"sliderMaxDuration\" class=\"oneline focusable\" data-bind-ksvalue=\"{{Settings.settings.max_duration}}\" min=\"5\" max=\"45\" step=\"1\" data-setting=\"duration\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblGameplayReplayDuration\">Replay Duration</div>\r\n                    <div slot=\"unit\" data-l10n-id=\"lblMinuteLower\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-bind-ksvalue=\"{{Settings.settings.enable_autosave}}\" values='[\"optionOff\",\"optionOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblGameplayReplayEnableAutosave\">Enable Autosave</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider id=\"sliderAutosaveLength\" class=\"oneline focusable\" data-bind-ksvalue=\"{{Settings.settings.min_length_prompt_auto_save}}\" min=\"5\" max=\"30\" step=\"1\" data-setting=\"autosave-duration\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblGameplayReplayAutosaveLength\">Replay Autosave Length</div>\r\n                    <div slot=\"unit\" data-l10n-id=\"lblMinuteLower\"></div>\r\n                </ks-slider>\r\n                <ks-slider id=\"sliderRaceSlots\" class=\"oneline focusable\" data-bind-ksvalue=\"{{Settings.settings.max_autosave_other_slots}}\" min=\"1\" max=\"30\" step=\"1\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblGameplayReplayRaceSlots\">Max Autosave Race Slots</div>\r\n                </ks-slider>\r\n                <ks-slider id=\"sliderOtherSlots\" class=\"oneline focusable\" data-bind-ksvalue=\"{{Settings.settings.max_autosave_race_slots}}\" min=\"0\" max=\"30\" step=\"1\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblGameplayReplayOtherSlots\">Max Autosave Other Slots</div>\r\n                </ks-slider>\r\n            </div>\r\n\r\n            <!-- HUD SECTION -->\r\n\r\n            <div class=\"hud scrollable-element scrollable-vertical is-flex-column\">\r\n\r\n                <!-- <h3>HUD</h3>\r\n                <hr> -->\r\n\r\n                <ks-slider id=\"sliderNotificationPriority\" class=\"oneline focusable\" values='[\"UINotificationPriorityType_Low\",\"UINotificationPriorityType_Normal\",\"UINotificationPriorityType_High\",\"UINotificationPriorityType_Maximum\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblMinNotificationPriority\"></div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n                <ks-slider class=\"oneline toggle focusable\" data-widget=\"hud_damage\" values='[\"optionOff\",\"optionOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblHudDamageWidget\">Damage Widget</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-widget=\"hud_delta\" values='[\"optionOff\",\"optionOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblHudDelta\">Delta Widget</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-widget=\"hud_laptime\" values='[\"optionOff\",\"optionOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblHudLaptime\">Laptime Widget</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-widget=\"hud_mfd\" values='[\"optionOff\",\"optionOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblHudMFD\">MFD Widget</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-widget=\"hud_radar\" values='[\"optionOff\",\"optionOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblHudRadar\">Radar Widget</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-widget=\"hud_sessionbanner\" values='[\"optionOff\",\"optionOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblHudSessionBanner\">Session Banner Widget</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-widget=\"hud_speedoradial\" values='[\"optionOff\",\"optionOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblHudSpeedometer\">Speedometer</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable\" data-widget=\"hud_trackmap\" values='[\"optionOff\",\"optionZoomed\",\"optionFull\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblHudTrackMap\">Track Map</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-widget=\"hud_tyres\" values='[\"optionOff\",\"optionOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblHudTyresWidget\">Tyres Widget</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-widget=\"hud_chat\" values='[\"optionOff\",\"optionOn\"]'>\r\n                    <div slot=\"name\" data-l10n-id=\"lblHudChatWidget\">Chat Widget</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>";

    var template$1b = "<div class=\"component-body\" data-bind-carstate=\"monitor_car_change({{ModelCurrentCar}})\">\r\n\r\n    <div class=\"logo\"></div>\r\n\r\n    <div id=\"labelContinue\" data-bind-class-toggle=\"visible:IsFlagSet(InSessionFlags.CanSkip,{{ModelUISessionState}})\" data-bind-if=\"IsFlagSet(InSessionFlags.CanSkip,{{ModelUISessionState}}) || IsFlagSet(InSessionFlags.SessionEnded,{{ModelUISessionState}})\">\r\n        <div class=\"label singleplayer\" data-l10n-id=\"lblPressToContinue\"></div>\r\n        <div class=\"label multiplayer\" data-l10n-id=\"lblSessionEnded\"></div>\r\n    </div>\r\n\r\n    <div id=\"labelDisconnected\" data-bind-if=\"{{ModelUIState}}.online_status=='UIOnlineDisconnected'\" data-l10n-id=\"lblServerDisconnected\"></div>\r\n\r\n    <div id=\"labelWrongWay\" data-bind-class-toggle=\"visible:{{ModelCurrentCar}}.is_wrong_way\" data-bind-if=\"{{ModelCurrentCar}}.is_wrong_way\" data-l10n-id=\"lblWarningWrongWay\"></div>\r\n\r\n    <div id=\"warningPitlimiter\">\r\n        <div class=\"label pitlane\" data-l10n-id=\"lblWarningPitlimiter\"></div>\r\n        <div class=\"optional shift-to-second\" data-l10n-id=\"lblWarningPitlimiterShiftToSecond\"></div>\r\n        <div class=\"optional slow-down\" data-l10n-id=\"lblWarningPitlimiterSlowDown\"></div>\r\n    </div>\r\n\r\n    <ks-startlights id=\"lights\" data-bind-if=\"{{ModelUISessionState.lights_mode}} > 0\" data-bind-class-toggle=\"pitlights:{{ModelUISessionState}}.lights_mode == 2\"></ks-startlights>\r\n\r\n    <ks-laptime id=\"laptime\" class=\"verticalwipe hidable\" data-bind-if=\"{{ModelUIState.gamemode}} == 'timing' && {{ModelTiming.current}} != 'Outlap'\"></ks-laptime>\r\n\r\n    <ks-timer id=\"waittime\" data-mode=\"waittimer\" class=\"verticalwipe hidable\" data-bind-if=\"{{ModelUISessionState}}.wait_time != ''\">\r\n    </ks-timer>\r\n\r\n    <ks-timer id=\"nextsession\" data-mode=\"nextsession\" class=\"verticalwipe hidable\" data-bind-if=\"{{ModelUISessionState}}.time_to_next_session != ''\">\r\n    </ks-timer>\r\n\r\n    <ks-huddamage id=\"damage\" class=\"verticalwipe hidable\"></ks-huddamage>\r\n\r\n    <ks-hudtyres id=\"tyres\" class=\"verticalwipe hidable\"></ks-hudtyres>\r\n\r\n    <ks-hudradar id=\"radar\" class=\"verticalwipe hidable\"></ks-hudradar>\r\n\r\n    <ks-hudspeedo-radial id=\"speedoradial\" class=\"hidable\"></ks-hudspeedo-radial>\r\n\r\n    <ks-hudcardisplay id=\"cardisplay\"></ks-hudcardisplay>\r\n\r\n    <ks-delta id=\"delta\" class=\"verticalwipe hidable\"></ks-delta>\r\n\r\n    <ks-sessionbanner id=\"sessionbanner\" class=\"verticalwipe hidable\"></ks-sessionbanner>\r\n\r\n    <ks-mfd id=\"mfd\" class=\"verticalwipe hidable\" data-bind-if=\"{{ModelUIState.gamemode}} == 'timing' && {{SeasonInfo}}.mode != 'ClientCommandsMode_DRIVING_ACADEMY'\" align-bottom></ks-mfd>\r\n\r\n    <ks-hudtrackmap id=\"trackmap\" class=\"verticalwipe hidable\"></ks-hudtrackmap>\r\n\r\n    <ks-hudwidgethost id=\"serverinfo\" class=\"hidable\" data-bind-if=\"{{ModelUIState.gamemode}} != 'none'\">\r\n        <div slot=\"widget\">\r\n            <ks-serverinfo></ks-serverinfo>\r\n        </div>\r\n    </ks-hudwidgethost>\r\n\r\n    <ks-pitstoptimer id=\"pitstoptimer\" data-bind-class-toggle=\"visible:{{ModelCurrentCar.pit_info.time_in_pits}} > 0\">\r\n        <div slot=\"widget\">\r\n    </div></ks-pitstoptimer>\r\n\r\n    <ks-hudchat id=\"chat\" class=\"hidable\" data-bind-if=\"IsFlagSet(InSessionFlags.Multiplayer,{{ModelUISessionState}})\"></ks-hudchat>\r\n\r\n    <ks-hudtrackcut id=\"trackcut\" data-bind-process=\"hud_trackcut_process({{ModelCurrentCar}}.low_frequency)\"></ks-hudtrackcut>\r\n\r\n</div>";

    var template$1a = "<div class=\"laptime-body component-body\">\r\n\r\n    <div class=\"timing\" data-bind-class-toggle=\"invalid:{{ModelTiming.invalid}}\">\r\n        <div class=\"laps\">            \r\n            <div class=\"current time\">\r\n                <div class=\"label\" data-l10n-id=\"lblLaptimeCurrentLap\">CURRENT LAP</div>\r\n                <div class=\"value\" data-bind-if=\"{{ModelTiming.current}} == '' || {{ModelTiming.current}} == 'Outlap' \">--:--.---</div>\r\n                <div class=\"value\" data-bind-if=\"{{ModelTiming.current}} != '' && {{ModelTiming.current}} != 'Outlap' \" data-bind-value=\"{{ModelTiming.current}}\">-:--.---</div>\r\n            </div>\r\n        </div>\r\n\r\n        <div class=\"relative-race-timing\" data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_DRIVING_ACADEMY' || IsFlagSet(InSessionFlags.Multiplayer,{{ModelUISessionState}})\">\r\n            <div class=\"previous time\">\r\n                <div class=\"label\" data-l10n-id=\"lblLaptimeLastLap\">LAST LAP</div>\r\n                <div class=\"value\" data-bind-value=\"{{ModelTiming.last}}\" data-bind-if=\"{{ModelTiming.last}} !=''\"></div>\r\n                <div class=\"value\" data-bind-if=\"{{ModelTiming.last}} ==''\">--:--.---</div>\r\n            </div>\r\n            <div class=\"predicted time\">\r\n                <div class=\"label\" data-l10n-id=\"lblLaptimePredLap\">PRED LAP</div>\r\n                <div class=\"value\" data-bind-value=\"ksUI.formatTimeExt({{ModelCurrentCar.predicted_lap_time_ms}}, 3, false, 3)\" data-bind-if=\"{{ModelCurrentCar.predicted_lap_time_ms}} !=''\"></div>\r\n                <div class=\"value\" data-bind-if=\"{{ModelCurrentCar.predicted_lap_time_ms}} ==''\">--:--.---</div>\r\n            </div>\r\n            <div class=\"best time\">\r\n                <div class=\"label\" data-l10n-id=\"lblLaptimeBestLap\">BEST LAP</div>\r\n                <div class=\"value\" data-bind-value=\"{{ModelTiming.best}}\" data-bind-if=\"{{ModelTiming.best}} !=''\"></div>\r\n                <div class=\"value\" data-bind-if=\"{{ModelTiming.best}} ==''\">--:--.---</div>\r\n                <svg class=\"icon\" xmlns=\"http://www.w3.org/2000/svg\" width=\"23\" height=\"23\" viewBox=\"0 0 23 23\">\r\n                    <circle cx=\"11.5\" cy=\"11.5\" r=\"11.5\" fill=\"rgba(0,0,0,0.6)\"/>\r\n                    <path d=\"M9.86,19.721a9.86,9.86,0,1,1,9.86-9.86A9.872,9.872,0,0,1,9.86,19.721ZM8.261,1.688a.675.675,0,0,0-.674.674v.355a.675.675,0,0,0,.674.674h.747V4.2a5.786,5.786,0,0,0-4.96,5.658v.167c0,.118.007.233.014.341a5.87,5.87,0,0,0,5.565,5.384c.081,0,.148,0,.212,0h.055A5.808,5.808,0,0,0,10.711,4.2V3.391h.748a.675.675,0,0,0,.674-.674V2.363a.675.675,0,0,0-.674-.674Zm1.6,12.361A4.109,4.109,0,1,1,13.969,9.94,4.114,4.114,0,0,1,9.859,14.049Zm-.367-7.04a.485.485,0,0,0-.484.484v2.946L10.8,12.231a.482.482,0,0,0,.684,0l.52-.52a.483.483,0,0,0,0-.684L10.711,9.734V7.493a.484.484,0,0,0-.483-.484Z\" transform=\"translate(1.64 1.64)\" fill=\"#ce00ff\"/>\r\n                </svg>   \r\n            </div>\r\n        </div>\r\n\r\n        <div class=\"horizontal-spacer\"></div>\r\n\r\n        <div class=\"relative-academy-timing\" data-bind-if=\"{{SeasonInfo}}.mode == 'ClientCommandsMode_DRIVING_ACADEMY' && !IsFlagSet(InSessionFlags.Multiplayer, {{ModelUISessionState}})\">\r\n            <div class=\"gold time\">\r\n                <div class=\"value\" data-bind-value=\"{{ModelUISessionState.special_event_state.golden_time}}\"></div>\r\n                <div class=\"label\">\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"60.871\" height=\"16.751\" viewBox=\"0 0 60.871 16.751\">\r\n                        <path id=\"Icon_ionic-md-star\" data-name=\"Icon ionic-md-star\" d=\"M12.609,17.966l5.445,3.285-1.44-6.2,4.807-4.167-6.337-.544L12.609,4.5l-2.475,5.843L3.8,10.887,8.6,15.054l-1.441,6.2Z\" transform=\"translate(39.45 -4.5)\" fill=\"#fabc3c\"/>\r\n                        <path id=\"Icon_ionic-md-star-2\" data-name=\"Icon ionic-md-star\" d=\"M12.609,17.966l5.445,3.285-1.44-6.2,4.807-4.167-6.337-.544L12.609,4.5l-2.475,5.843L3.8,10.887,8.6,15.054l-1.441,6.2Z\" transform=\"translate(17.827 -4.5)\" fill=\"#fabc3c\"/>\r\n                        <path id=\"Icon_ionic-md-star-3\" data-name=\"Icon ionic-md-star\" d=\"M12.609,17.966l5.445,3.285-1.44-6.2,4.807-4.167-6.337-.544L12.609,4.5l-2.475,5.843L3.8,10.887,8.6,15.054l-1.441,6.2Z\" transform=\"translate(-3.797 -4.5)\" fill=\"#fabc3c\"/>\r\n                    </svg>\r\n                </div>\r\n            </div>\r\n            <div class=\"silver time\">\r\n                <div class=\"value\" data-bind-value=\"{{ModelUISessionState.special_event_state.silver_time}}\"></div>\r\n                <div class=\"label\">\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"60.871\" height=\"16.751\" viewBox=\"0 0 60.871 16.751\">\r\n                        <path id=\"Icon_ionic-md-star-outline\" data-name=\"Icon ionic-md-star-outline\" d=\"M21.42,10.887l-6.337-.544L12.609,4.5l-2.475,5.843L3.8,10.887,8.6,15.054l-1.441,6.2,5.446-3.285,5.445,3.285-1.44-6.2ZM13.33,16.77l-.721-.435-.721.435L9.271,18.349l.693-2.979.191-.82L9.518,14,7.206,12l3.046-.262.838-.072.328-.774,1.19-2.808,1.19,2.808.328.774.838.072,3.047.262L15.7,14l-.636.551.191.82.693,2.979Z\" transform=\"translate(39.45 -4.5)\" fill=\"#fabc3c\"/>\r\n                        <path id=\"Icon_ionic-md-star\" data-name=\"Icon ionic-md-star\" d=\"M12.609,17.966l5.445,3.285-1.44-6.2,4.807-4.167-6.337-.544L12.609,4.5l-2.475,5.843L3.8,10.887,8.6,15.054l-1.441,6.2Z\" transform=\"translate(17.827 -4.5)\" fill=\"#fabc3c\"/>\r\n                        <path id=\"Icon_ionic-md-star-2\" data-name=\"Icon ionic-md-star\" d=\"M12.609,17.966l5.445,3.285-1.44-6.2,4.807-4.167-6.337-.544L12.609,4.5l-2.475,5.843L3.8,10.887,8.6,15.054l-1.441,6.2Z\" transform=\"translate(-3.797 -4.5)\" fill=\"#fabc3c\"/>\r\n                    </svg>\r\n                </div>\r\n            </div>\r\n            <div class=\"bronze time\">\r\n                <div class=\"value\" data-bind-value=\"{{ModelUISessionState.special_event_state.bronze_time}}\"></div>\r\n                <div class=\"label\">\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"60.871\" height=\"16.751\" viewBox=\"0 0 60.871 16.751\">\r\n                        <path id=\"Icon_ionic-md-star-outline\" data-name=\"Icon ionic-md-star-outline\" d=\"M21.42,10.887l-6.337-.544L12.609,4.5l-2.475,5.843L3.8,10.887,8.6,15.054l-1.441,6.2,5.446-3.285,5.445,3.285-1.44-6.2ZM13.33,16.77l-.721-.435-.721.435L9.271,18.349l.693-2.979.191-.82L9.518,14,7.206,12l3.046-.262.838-.072.328-.774,1.19-2.808,1.19,2.808.328.774.838.072,3.047.262L15.7,14l-.636.551.191.82.693,2.979Z\" transform=\"translate(39.45 -4.5)\" fill=\"#fabc3c\"/>\r\n                        <path id=\"Icon_ionic-md-star-outline-2\" data-name=\"Icon ionic-md-star-outline\" d=\"M21.42,10.887l-6.337-.544L12.609,4.5l-2.475,5.843L3.8,10.887,8.6,15.054l-1.441,6.2,5.446-3.285,5.445,3.285-1.44-6.2ZM13.33,16.77l-.721-.435-.721.435L9.271,18.349l.693-2.979.191-.82L9.518,14,7.206,12l3.046-.262.838-.072.328-.774,1.19-2.808,1.19,2.808.328.774.838.072,3.047.262L15.7,14l-.636.551.191.82.693,2.979Z\" transform=\"translate(17.827 -4.5)\" fill=\"#fabc3c\"/>\r\n                        <path id=\"Icon_ionic-md-star\" data-name=\"Icon ionic-md-star\" d=\"M12.609,17.966l5.445,3.285-1.44-6.2,4.807-4.167-6.337-.544L12.609,4.5l-2.475,5.843L3.8,10.887,8.6,15.054l-1.441,6.2Z\" transform=\"translate(-3.797 -4.5)\" fill=\"#fabc3c\"/>\r\n                    </svg>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <div class=\"positioning-container\">           \r\n            <div class=\"lap\" data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_DRIVING_ACADEMY' || IsFlagSet(InSessionFlags.Multiplayer,{{ModelUISessionState}})\">\r\n                <div class=\"label\">LAP</div>\r\n                <div class=\"value\" data-bind-value=\"{{ModelCurrentCar.low_frequency.total_lap_count}}+1\">O</div>\r\n            </div>                 \r\n            <div class=\"position\" data-bind-if=\"{{ModelCurrentCar}}.low_frequency.total_drivers > 1\">\r\n                <div class=\"label\" data-l10n-id=\"lblLaptimePos\">Pos</div>\r\n                <div class=\"value\"><span class=\"carpos\" data-bind-value=\"{{ModelCurrentCar}}.low_frequency.current_pos+1\"></span><span class=\"total\" data-bind-value=\"'/' + {{ModelCurrentCar}}.low_frequency.total_drivers\"></span></div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n</div>";

    const RAD = Math.PI / 180;
    const PI_2 = Math.PI / 2;

    class KsHTMLHudElement extends KsHTMLElement {

        settings = {
            align: "top",
            visible: true,
            mode: null
        };

        ismousedown;
        #lastcoordinates = { x: 0, y: 0 };
        #offsets = { x: 0, y: 0 };
        dragdebounceid;
        mouseupdebounceid;
        #hud;
        addVisibleCssClass = true;

        alignToBottom = false;

        get isInHUD() {
            return this.#hud !== null;
        }

        get isHUDVisible() {
            return !this.#hud.classList.contains("hide");
        }

        constructor() {
            super();
            this.delayedInit = true;
        }

        get visible() {
            return this.settings.visible;
        }

        set visible(value) {
            this.settings.visible = value;
            this.classList.toggle("hidden", value === false);
        }

        get isHidden() {
            return this.classList.contains("hidden");
        }

        convert = {
            psiToBar: (value, decimals = 2) => {
                return (value * 0.0689476).toFixed(decimals);
            },
            fuelToRange: (value, decimals = 0) => {
                if (ModelCurrentCar.fuel_liter_per_km == 0) {
                    return "--"
                }            return (value / ModelCurrentCar.fuel_liter_per_km).toFixed(0);
            },
            svgPolygonToClippingPath: (value) => {
                if (value.indexOf(",") == -1) {
                    let split = value.match(/\b[\w']+(?:[^\w\n]+[\w']+){0,1}\b/g);
                    split.forEach((element, index) => {
                        split[index] = element.replaceAll(" ", "px,") + "px";
                    });
                    console.log(split.join(" "));
                } else {
                    console.log(value.replaceAll(" ", "px**").replaceAll(",", "px ").replaceAll("**", ", ") + "px");
                }
            },
            tableToClipPath: (value, table, round) => {
                const x = this.convert.interpolate(value, 0, table);
                const y = this.convert.interpolate(value, 1, table);
                if (round) {
                    return [Math.round(x), Math.round(y)];
                }
                return [x, y];
            },
            /** 
             * @param {Number} value float (0.0 - 1.0)
             * @param {Array} table
             * 
             */
            interpolate: (X, Y, ZValues) => {
                var X0Y0 = 0,
                    X0Y1 = 0,
                    X1Y0 = 0,
                    X1Y1 = 0,
                    X0 = 0,
                    Y0 = 0,
                    X1 = 0,
                    Y1 = 0,
                    X1i = 0,
                    X0i = 0,
                    Y0i = 0,
                    Y1i = 0,
                    Xmax = ZValues.length,
                    Ymax = ZValues[0].length,
                    result = 0,
                    XMY0 = 0,
                    XMY1 = 0,
                    XMYM = 0;

                if (X > ZValues[Xmax - 1][0] || X < ZValues[1][0] || Y < ZValues[0][1] || Y > ZValues[0][Ymax - 1]) {
                    console.error("Interpolation error: out of range", X, Y);
                } else {
                    for (var i = 1; i < Xmax - 1; i++) {
                        if (ZValues[i][0] == X) {
                            X0i = i;
                        } else if (ZValues[i + 1][0] == X) {
                            X1i = i + 1;
                        }
                        if (X >= ZValues[i][0] && X <= ZValues[i + 1][0]) {
                            X0i = i; X1i = i + 1;
                        }
                    }
                    for (var i = 1; i <= Ymax - 1; i++) {
                        if (ZValues[0][i] == Y) {
                            Y0i = i;
                        }
                        else if (ZValues[0][i + 1] == Y) {
                            Y1i = i + 1;
                        }
                        else if (Y >= ZValues[0][i] && Y <= ZValues[0][i + 1]) {
                            Y0i = i; Y1i = i + 1;
                        }
                    }
                    X0 = ZValues[X0i][0];
                    X1 = ZValues[X1i][0];
                    Y0 = ZValues[0][Y0i];
                    Y1 = ZValues[0][Y1i];
                    X0Y0 = ZValues[X0i][Y0i];
                    X0Y1 = ZValues[X0i][Y1i];
                    X1Y0 = ZValues[X1i][Y0i];
                    X1Y1 = ZValues[X1i][Y1i];

                    /*
                    if ((X == X0 || X == X1) && (Y == Y0 || Y == Y1))
                        console.error("Exact match. No interpolation needed.", X);
                    else console.error("Interpolated result.", X);
                    */

                    if (X == X0) {
                        XMY0 = X0Y0; XMY1 = X0Y1;
                    }
                    else if (X == X1) {
                        XMY0 = X1Y0; XMY1 = X1Y1;
                    }
                    else {
                        XMY0 = X0Y0 + (X - X0) * (X1Y0 - X0Y0) / (X1 - X0);
                        XMY1 = X0Y1 + (X - X0) * (X1Y1 - X0Y1) / (X1 - X0);
                    }
                    if (Y == Y0) {
                        XMYM = XMY0;
                    }
                    else if (Y == Y1) {
                        XMYM = XMY1;
                    }
                    else {
                        XMYM = XMY0 + (Y - Y0) * (XMY1 - XMY0) / (Y1 - Y0);
                    }

                    if (isNaN(XMYM)) {
                        console.error("Interpolation error: no values in table", X, Y);
                    }
                    else {
                        result = XMYM;
                    }
                }
                return result;
            },

            /** @param type 
        * 0 absolute
        * 1 relative
        * 2 relative with offset
        */

            getRadialWipeEffect: (target, cx, cy, r, a1, a2, type = 1) => {
                target.style["cohCustomEffectName"] = "radial-wipe";
                target.style["cohCustomEffectFloatParam1"] = cx;
                target.style["cohCustomEffectFloatParam2"] = cy;
                target.style["cohCustomEffectFloatParam3"] = r;
                target.style["cohCustomEffectFloatParam4"] = a1;
                target.style["cohCustomEffectFloatParam5"] = a2;
                target.style["cohCustomEffectFloatParam6"] = type;
            },

            getRadialWipePath: (cx, cy, r, a1, a2) => {

                var delta = a2 - a1;

                if (delta === 360) {

                    return "M " + (cx - r) + " " + cy + " a " + r + " " + r + " 0 1 0 " + r * 2 + " 0 a " + r + " " + r + " 0 1 0 " + -r * 2 + " 0z";
                }

                var largeArc = delta > 180 ? 1 : 0;

                a1 = a1 * RAD - PI_2;
                a2 = a2 * RAD - PI_2;

                var x1 = cx + r * Math.cos(a2);
                var y1 = cy + r * Math.sin(a2);

                var x2 = cx + r * Math.cos(a1);
                var y2 = cy + r * Math.sin(a1);

                return "M " + x1 + " " + y1 + " A " + r + " " + r + " 0 " + largeArc + " 0 " + x2 + " " + y2 + " L " + cx + " " + cy + "z";
            }
        }

        getStoredSettings() {

            if (HUD.layouts[HUD.currentLayout]) ;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.#hud = q("ks-hud");
            if (this.#hud) {
                const storage_id = "hud_" + this.id;
                const storedsettings = HUD.StoredData.layouts[HUD.currentLayout].elements[storage_id];

                this.alignToBottom = this.hasAttribute("align-bottom");

                if(this.alignToBottom) {
                    this.settings.align = "bottom";
                }

                if (storedsettings && storedsettings.x && storedsettings.y) {
                    console.log("Restoring position", "hud_" + this.id, storedsettings);

                    this.style.left = storedsettings.x;
                    this.style.right = "auto";

                    if (this.alignToBottom) {
                        console.log("Align to bottom", "hud_" + this.id, storedsettings.y);
                        this.style.bottom = storedsettings.y;
                        this.style.top = "auto";

                    } else {
                        this.style.top = storedsettings.y;
                        this.style.bottom = "auto";
                    }



                }

                if (this.addVisibleCssClass) {
                    this.classList.add("visible");
                }


                if (storedsettings && storedsettings.settings) {
                    Object.assign(this.settings, storedsettings.settings);
                    //this.settings = { ... storedsettings.settings};
                }

                this.settings.visible = storedsettings?.settings?.visible !== false;

                this.classList.toggle("hidden", this.settings.visible !== true);
            }

            // cancelAnimationFrame(this.resizeDebounce);

            // $.waitForFrames(() => {
            //     this.moveToViewport();
            // }, 6, this.resizeDebounce);

        }

        resizeDebounce = { id: 0 };

        moveToViewport() {
            if (this.offsetTop > this.documentBody.offsetHeight - this.offsetHeight) {
                console.log("moving", this.tagName, "vertical");
                this.style.topPX = this.documentBody.offsetHeight - this.offsetHeight;
            }

            if (this.offsetLeft > this.documentBody.offsetWidth - this.offsetWidth) {
                console.log("moving", this.tagName, "horizontal");
                this.style.leftPX = this.documentBody.offsetWidth - this.offsetWidth;
            }
        }

        bindControls() {
            if (!this.closest("ks-hud")) {
                this.classList.add("not-in-hud");
                return;
            }
            this.onmousedown = this.onMouseDown;
            this.ondblclick = (event) => {
                if (event.target != event.currentTarget) return;
                console.trace("dblclick", event.target, event.currentTarget);
                this.style.left = "";
                this.style.top = "";
                this.style.bottom = "";
                this.style.right = "";
                this.storeSettings();
            };
            window.addEventListener("resize", () => {
                cancelAnimationFrame(this.resizeDebounce);

                waitForFrames(() => {
                    this.moveToViewport();
                }, 6, this.resizeDebounce);
            });
        }

        onRemovedFromDOM() {
        }

        onMouseMove(event) {
            if (!this.targettedwidget) {
                this.onmousemove = null;
                return;
            }
            if (!this.targettedwidget.ismousedown || this.targettedwidget.dragdebounceid) return;

            this.targettedwidget.dragdebounceid = components$1.waitForFrames(
                () => this.targettedwidget.moveTo(event.x, event.y), 1);

        }

        onMouseDown(event) {
            if (this.mouseupdebounceid) ;
            if (event.target != this) return;
            this.#hud.targettedwidget = this;
            this.ismousedown = true;
            window.ismousedown = true;
            this.classList.add("mousedown");
            this.storeCoordinates(event);
            this.#hud.onmousemove = this.onMouseMove;
            this.#hud.onmouseup = this.onMouseUp.bind(this);
            ksUI$1.menuState.toggleMouseHover(true);
        }

        onMouseUp(event) {
            //this.mouseupdebounceid = components.waitForFrames(() => {
            if (this.#hud.targettedwidget) {
                cancelAnimationFrame(this.#hud.targettedwidget.dragdebounceid);
            }
            window.ismousedown = false;
            this.ismousedown = false;
            this.dragdebounceid = null;
            this.onmousemove = null;
            this.classList.remove("mousedown");
            this.#hud.targettedwidget = null;
            ksUI$1.menuState.toggleMouseHover(false);
            //}, 5);
        }

        #debouncesave;

        moveTo(x, y, centered) {

            const margin = 2 * window.FontSize;

            if (centered) {
                let target_x = ((x - this.offsetWidth / 2) / window.innerWidth) * 100;
                let target_y = ((y - this.offsetHeight / 2) / window.innerHeight) * 100;
                this.style.leftVW = target_x;
                this.style.topVH = target_y;

            } else {
                let target_x = ((x + this.#offsets.x) / window.innerWidth) * 100;
                let target_y = ((y + this.#offsets.y) / window.innerHeight) * 100;

                if (x + this.#offsets.x < 0) {
                    target_x = 0;
                }

                if (x + this.#offsets.x + this.offsetWidth > window.innerWidth) {
                    target_x = ((window.innerWidth - this.offsetWidth) / window.innerWidth) * 100;
                }

                if (y + this.#offsets.y < -margin) {
                    target_y = (-margin / window.innerHeight) * 100;
                }

                if (y + this.#offsets.y + this.offsetHeight > (window.innerHeight - margin)) {
                    target_y = ((window.innerHeight - this.offsetHeight - margin) / window.innerHeight) * 100;
                }

                this.style.leftVW = target_x;
                this.style.right = "auto";

                if (this.alignToBottom) {
                    this.style.top = "auto";

                    const element_height = ((this.offsetHeight + 2 * margin) / window.innerHeight) * 100;
                    this.style.bottomVH = 100 - target_y - element_height;

                } else {
                    this.style.topVH = target_y;
                    this.style.bottom = "auto";
                }
            }



            this.dragdebounceid = null;

            clearTimeout(this.#debouncesave);
            if (this.style.left && this.style.top)
                this.#debouncesave = setTimeout(() => {
                    this.storeSettings();
                    //ksUI.menuState.addToStore("hud_" + this.id, JSON.stringify([this.style.leftVW, this.style.topVH]));
                }, 125);

        }

        storeSettings() {
            HUD.elementModified("hud_" + this.id, { x: this.style.leftVW, y: this.alignToBottom ? this.style.bottomVH : this.style.topVH, settings: this.settings });
        }

        storeCoordinates(event) {
            this.#offsets.x = this.offsetLeft - event.x;
            this.#offsets.y = this.offsetTop - event.y;
            this.#lastcoordinates.x = event.x;
            this.#lastcoordinates.y = event.y;
        }

    }

    class HudLaptime extends KsHTMLHudElement {

        constructor() {
            super();
            this.template = template$1a;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
        }

    }
    ksUI$1.registerModule('ks-laptime', HudLaptime);

    var template$19 = "<div class=\"gauge\" data-bind-class-toggle=\"shift:{{ModelCurrentCar.rpm_percent}} > 0.8\">\r\n\r\n    <div class=\"gear\">\r\n        <div class=\"indication\" data-bind-value=\"{{ModelCurrentCar.gear}}\">N</div>\r\n    </div>\r\n\r\n    <div class=\"rpm\">\r\n        <div class=\"indication\">\r\n            <div class=\"value\" data-bind-value=\"{{ModelCurrentCar.rpm}}\">5000</div><div class=\"unit\">rpm</div>\r\n        </div>\r\n        <div class=\"indicator\">\r\n            <div class=\"value\" data-bind-style-width=\"ksUI.roundToStepPercentString({{ModelCurrentCar.rpm_percent}}, 8.5)\"></div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"speed\">\r\n        <div class=\"indication\">\r\n            <div class=\"value\" data-bind-value=\"{{ModelCurrentCar.speed}}\">000</div><div class=\"unit kmh\">Km/h</div>\r\n        </div>\r\n    </div>\r\n\r\n</div>";

    class HudSpeedo extends KsHTMLHudElement {

        constructor() {
            super();
            this.template = template$19;
        }

    }
    ksUI$1.registerModule('ks-hudspeedo', HudSpeedo);

    var template$18 = "<div class=\"gauge\">\r\n    <div class=\"wheels\">\r\n        <div class=\"type\">DRY</div>\r\n        <div class=\"front left\"></div>\r\n        <div class=\"front right\"></div>\r\n        <div class=\"rear left\"></div>\r\n        <div class=\"rear right\"></div>\r\n    </div>\r\n\r\n    <div class=\"lights\">\r\n        <div class=\"indicators\"></div>\r\n        <div class=\"low\"></div>\r\n        <div class=\"high\"></div>\r\n    </div>\r\n\r\n</div>";

    class HudVehicleStatus extends KsHTMLHudElement {

        constructor() {
            super();
            this.template = template$18;        
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
        }

        bindControls() {
            super.bindControls();
        }

    }
    ksUI.registerModule('ks-hudvehiclestatus', HudVehicleStatus);

    var template$17 = "<div class=\"host-wrapper\">\r\n    <component-slot data-name=\"widget\">\r\n\r\n    </component-slot>\r\n</div>";

    class HudWidgetHost extends KsHTMLHudElement {

        constructor() {
            super();
            this.template = template$17;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
        }

        bindControls() {
            super.bindControls();
        }


    }
    ksUI$1.registerModule('ks-hudwidgethost', HudWidgetHost);

    var template$16 = "<div class=\"lights\" data-bind-class=\"'on' + {{ModelUISessionState.lights_on}}\">\r\n    <div class=\"pit_exit\" data-l10n-id=\"lblPitExitUpper\"></div>\r\n    <div class=\"light light1\"></div>\r\n    <div class=\"light light2\"></div>\r\n    <div class=\"light light3\"></div>\r\n    <div class=\"light light4\"></div>\r\n    <div class=\"light light5\"></div>\r\n</div>";

    class HudStartLights extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$16;
            this.delayedInit = true;
        }

        onTemplateLoaded() {
            this.templateLoaded = true;
            waitForFrames(() => {
                this.classList.add("visible");
            });
        }

    }
    ksUI$1.registerModule('ks-startlights', HudStartLights);

    var template$15 = "<div class=\"tyre-panel\" data-bind-process=\"hud_tyres_process({{ModelCurrentCar}})\">\r\n      \r\n  <div class=\"compound front\" data-bind-value=\"{{ModelCurrentCar.tyre_lf.tyre_compound_front}}\"></div>\r\n  <div class=\"compound rear\" data-bind-value=\"{{ModelCurrentCar.tyre_lr.tyre_compound_rear}}\"></div>\r\n\r\n  <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 94 112\">\r\n        <defs>\r\n\r\n          <linearGradient id=\"tyreGradient_rr\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\r\n            <stop id=\"rr_inner_stop\" offset=\"0%\" stop-color=\"#00aa00\"/>\r\n            <stop id=\"rr_center_stop\" offset=\"50%\" stop-color=\"#00cc00\"/>\r\n            <stop id=\"rr_outer_stop\" offset=\"100%\" stop-color=\"#00ff00\"/>\r\n          </linearGradient>      \r\n \r\n          <linearGradient id=\"tyreGradient_rf\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\r\n            <stop id=\"rf_inner_stop\" offset=\"0%\" stop-color=\"#00aa00\"/>\r\n            <stop id=\"rf_center_stop\" offset=\"50%\" stop-color=\"#00cc00\"/>\r\n            <stop id=\"rf_outer_stop\" offset=\"100%\" stop-color=\"#00ff00\"/>\r\n          </linearGradient>      \r\n\r\n          <linearGradient id=\"tyreGradient_lr\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\r\n            <stop id=\"lr_inner_stop\" offset=\"0%\" stop-color=\"#00aa00\"/>\r\n            <stop id=\"lr_center_stop\" offset=\"50%\" stop-color=\"#00cc00\"/>\r\n            <stop id=\"lr_outer_stop\" offset=\"100%\" stop-color=\"#00ff00\"/>\r\n          </linearGradient>\r\n\r\n          <linearGradient id=\"tyreGradient_lf\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\r\n            <stop id=\"lf_inner_stop\" offset=\"0%\" stop-color=\"#00aa00\"/>\r\n            <stop id=\"lf_center_stop\" offset=\"50%\" stop-color=\"#00cc00\"/>\r\n            <stop id=\"lf_outer_stop\" offset=\"100%\" stop-color=\"#00ff00\"/>\r\n          </linearGradient>\r\n        </defs>\r\n      \r\n        <g id=\"rear\" transform=\"translate(0 72)\">\r\n          <g id=\"rr\" transform=\"translate(60)\">\r\n            <rect id=\"brake_rr\" data-name=\"brake\" width=\"4\" height=\"16.5\" rx=\"0\" x=\"-5.75\" y=\"3.5\" fill=\"#ff4d4d\"/>\r\nku          <rect id=\"tyre_rr\" width=\"22\" height=\"30\" x=\"0\" y=\"-4\" style=\"fill: url(#tyreGradient_rr);\" rx=\"5\"/>\r\n            <rect id=\"core_rr\" data-name=\"core\" width=\"15.5\" height=\"22\" rx=\"2\" x=\"3.25\" y=\"0\" fill=\"#999999\" style=\"stroke:none !important;\"/>\r\n            <rect id=\"pressureBar_rr\" width=\"2\" height=\"30\" x=\"26\" y=\"-4\" fill=\"#ffffff\" opacity=\"0.25\"/>\r\n            <rect id=\"pressureFill_rr\" width=\"1.5\" height=\"0\" x=\"26\" y=\"11\" fill=\"#ffffff\" opacity=\"1\"/>\r\n            <text class=\"psi-text\" x=\"11.25\" y=\"37\" font-size=\"11\" font-weight=\"bold\" text-anchor=\"middle\" fill=\"#ffffff\" data-bind-value=\"hud_tyres_psi({{ModelCurrentCar.tyre_rr.tyre_pression}})\"/>          \r\n            <text class=\"core-text\" x=\"12\" y=\"14.5\" font-size=\"9\" text-anchor=\"middle\" fill=\"#ffffff\" data-bind-value=\"hud_tyres_c({{ModelCurrentCar.tyre_rr.tyre_temperature_c}})\"/> \r\n          </g>\r\n      \r\n          <g id=\"lr\" transform=\"translate(13)\">\r\n            <rect id=\"brake_lr\" data-name=\"brake\" width=\"4\" height=\"16.5\" rx=\"0\" x=\"22.75\" y=\"3.5\" fill=\"#ff4d4d\"/>\r\n            <rect id=\"tyre_lr\" width=\"22\" height=\"30\" x=\"-1\" y=\"-4\" style=\"fill: url(#tyreGradient_lr);\" rx=\"5\"/>\r\n            <rect id=\"core_lr\" data-name=\"core\" width=\"15.5\" height=\"22\" rx=\"2\" x=\"2.25\" y=\"0\" fill=\"#999999\" style=\"stroke:none !important;\"/>\r\n            <rect id=\"pressureBar_lr\" width=\"2\" height=\"30\" x=\"-7\" y=\"-4\" fill=\"#ffffff\" opacity=\"0.25\"/>\r\n            <rect id=\"pressureFill_lr\" width=\"1.5\" height=\"0\" x=\"-7\" y=\"11\" fill=\"#ffffff\" opacity=\"1\"/>\r\n            <text class=\"psi-text\" x=\"10\" y=\"37\" font-size=\"11\" font-weight=\"bold\" text-anchor=\"middle\" fill=\"#ffffff\" data-bind-value=\"hud_tyres_psi({{ModelCurrentCar.tyre_lr.tyre_pression}})\"/>           \r\n            <text class=\"core-text\" x=\"10.75\" y=\"14.5\" font-size=\"9\" text-anchor=\"middle\" fill=\"#ffffff\" data-bind-value=\"hud_tyres_c({{ModelCurrentCar.tyre_lr.tyre_temperature_c}})\"/>\r\n          </g>\r\n        </g>\r\n      \r\n        <g id=\"front\" transform=\"translate(0 10)\">\r\n          <g id=\"rf\" transform=\"translate(60)\">\r\n            <rect id=\"brake_rf\" data-name=\"brake\" width=\"4\" height=\"16.5\" rx=\"0\" x=\"-5.75\" y=\"10.85\" fill=\"#ff4d4d\"/>\r\n            <rect id=\"tyre_rf\" width=\"22\" height=\"30\" x=\"0\" y=\"4\" style=\"fill: url(#tyreGradient_rf);\" rx=\"5\"/>\r\n            <rect id=\"core_rf\" data-name=\"core\" width=\"15.5\" height=\"22\" rx=\"2\" x=\"3.25\" y=\"8\" fill=\"#999999\" style=\"stroke:none !important;\"/>\r\n            <rect id=\"pressureBar_rf\" width=\"2\" height=\"30\" x=\"26\" y=\"4\" fill=\"#ffffff\" opacity=\"0.25\"/>\r\n            <rect id=\"pressureFill_rf\" width=\"1.5\" height=\"0\" x=\"26\" y=\"19\" fill=\"#ffffff\" opacity=\"1\"/>\r\n            <text class=\"psi-text\" x=\"11.25\" y=\"0\" font-size=\"11\" font-weight=\"bold\" text-anchor=\"middle\" fill=\"#ffffff\" data-bind-value=\"hud_tyres_psi({{ModelCurrentCar.tyre_rf.tyre_pression}})\"/>                       \r\n            <text class=\"core-text\" x=\"12\" y=\"22\" font-size=\"9\" text-anchor=\"middle\" fill=\"#ffffff\" data-bind-value=\"hud_tyres_c({{ModelCurrentCar.tyre_rf.tyre_temperature_c}})\"/>\r\n          </g>\r\n\r\n          <g id=\"lf\" transform=\"translate(13)\">\r\n            <rect id=\"brake_lf\" data-name=\"brake\" width=\"4\" height=\"16.5\" rx=\"0\" x=\"22.75\" y=\"10.85\" fill=\"#ff4d4d\"/>\r\n            <rect id=\"tyre_lf\" width=\"22\" height=\"30\" x=\"-1\" y=\"4\" style=\"fill: url(#tyreGradient_lf);\" rx=\"5\"/>\r\n            <rect id=\"core_lf\" data-name=\"core\" width=\"15.5\" height=\"22\" rx=\"2\" x=\"2.25\" y=\"8\" fill=\"#999999\" style=\"stroke:none !important;\"/>\r\n            <rect id=\"pressureBar_lf\" width=\"2\" height=\"30\" x=\"-7\" y=\"4\" rx=\"0\" fill=\"#ffffff\" opacity=\"0.25\"/>\r\n            <rect id=\"pressureFill_lf\" width=\"1.5\" height=\"0\" x=\"-7\" y=\"19\" fill=\"#ffffff\" opacity=\"1\"/>            \r\n            <text class=\"psi-text\" x=\"10.5\" y=\"0\" font-size=\"11\" font-weight=\"bold\" text-anchor=\"middle\" fill=\"#ffffff\" data-bind-value=\"hud_tyres_psi({{ModelCurrentCar.tyre_lf.tyre_pression}})\"/>\r\n            <text class=\"core-text\" x=\"10.75\" y=\"22\" font-size=\"9\" text-anchor=\"middle\" fill=\"#ffffff\" data-bind-value=\"hud_tyres_c({{ModelCurrentCar.tyre_lf.tyre_temperature_c}})\"/>\r\n          </g>\r\n        </g>\r\n      </svg>\r\n</div>";

    class HudTyres extends KsHTMLHudElement {

        lf;
        lf_segments = { left: null, right: null, center: null, brake: null, core: null };
        rf;
        rf_segments = { left: null, right: null, center: null, brake: null, core: null };
        lr;
        lr_segments = { left: null, right: null, center: null, brake: null, core: null };
        rr;
        rr_segments = { left: null, right: null, center: null, brake: null, core: null };

        lookup_table = [
            // 12, 184, 238
            { pct: 0.0, color: { r: 0, g: 127, b: 239 } },          
            { pct: 0.25, color: { r: 0, g: 212, b: 255 } },        
            { pct: 0.5, color: { r: 67, g: 234, b: 120 } },         
            { pct: 0.8, color: { r: 242, g: 222, b: 42 } },         
            { pct: 0.9, color: { r: 242, g: 222, b: 42 } },         
            { pct: 1.0, color: { r: 255, g: 0, b: 24 } }         
        ];

        constructor() {
            super();
            this.template = template$15;
        }

        filters = {
            hud_tyres_psi: (x) => {           
                return `${(x).toFixed(1)}`;
            },
            hud_tyres_c: (x) => {
                return `${(x).toFixed(0)}`;
            },
            hud_tyres_process: (car) => {

                if(!this.isHUDVisible) return;

                /** @type {UITyreState} */
                const tyre_lf = car.tyre_lf;
                /** @type {UITyreState} */
                const tyre_rf = car.tyre_rf;
                /** @type {UITyreState} */
                const tyre_lr = car.tyre_lr;
                /** @type {UITyreState} */
                const tyre_rr = car.tyre_rr;

                /**
                 * 
                 * @param {SVGElement} tyre 
                 * @param {UITyreState} state 
                 */

                function indicate(tyre, state, low_temp = 0, high_temp = 2) {
                  
                    tyre.classList.toggle("blowout", state.tyre_pression < 1);
                
                    const leftColor = ksUI$1.getColorForPercentage(ksUI$1.range(state.tyre_normalized_temperature_left, 0, 2, 0, 1), this.lookup_table);
                    const centerColor = ksUI$1.getColorForPercentage(ksUI$1.range(state.tyre_normalized_temperature_center, 0, 2, 0, 1), this.lookup_table);
                    const rightColor = ksUI$1.getColorForPercentage(ksUI$1.range(state.tyre_normalized_temperature_right, 0, 2, 0, 1), this.lookup_table);
                    const coreColor = ksUI$1.getColorForPercentage(ksUI$1.range(state.tyre_normalized_temperature_core, low_temp, high_temp, 0, 1), this.lookup_table);
                    const brakeColor = ksUI$1.getColorForPercentage(ksUI$1.range(state.brake_normalized_temperature, 0, 2, 0, 1), this.lookup_table);
                
                    if (tyre.id === "rr") {
                        document.getElementById("rr_inner_stop")?.setAttribute("stop-color", leftColor);
                        document.getElementById("rr_center_stop")?.setAttribute("stop-color", centerColor);
                        document.getElementById("rr_outer_stop")?.setAttribute("stop-color", rightColor);
                        this.updatePressure("rr", state);
                    } else if (tyre.id === "rf") {                    
                        document.getElementById("rf_inner_stop")?.setAttribute("stop-color", leftColor);
                        document.getElementById("rf_center_stop")?.setAttribute("stop-color", centerColor);
                        document.getElementById("rf_outer_stop")?.setAttribute("stop-color", rightColor);
                        this.updatePressure("rf", state);
                    } else if (tyre.id === "lr") {                    
                        document.getElementById("lr_inner_stop")?.setAttribute("stop-color", leftColor);
                        document.getElementById("lr_center_stop")?.setAttribute("stop-color", centerColor);
                        document.getElementById("lr_outer_stop")?.setAttribute("stop-color", rightColor);
                        this.updatePressure("lr", state);
                    } else if (tyre.id === "lf") {                    
                        document.getElementById("lf_inner_stop")?.setAttribute("stop-color", leftColor);
                        document.getElementById("lf_center_stop")?.setAttribute("stop-color", centerColor);
                        document.getElementById("lf_outer_stop")?.setAttribute("stop-color", rightColor);
                        this.updatePressure("lf", state);
                    }
                
                    if (tyre.id === "rr" || tyre.id === "rf" || tyre.id === "lr" || tyre.id === "lf" ) {
                        tyre.segments.core.style.fill = coreColor;
                        tyre.segments.brake.style.fill = brakeColor;
                    } else {                   
                        tyre.segments.left.style.fill = leftColor;
                        tyre.segments.center.style.fill = centerColor;
                        tyre.segments.right.style.fill = rightColor;
                        tyre.segments.brake.style.fill = brakeColor;
                        tyre.segments.core.style.fill = coreColor;                       
                    }
                }
                const ind = indicate.bind(this);

                ind(this.lf, tyre_lf);
                ind(this.rf, tyre_rf);
                ind(this.lr, tyre_lr);
                ind(this.rr, tyre_rr);           

                this.classList.toggle("dual-compound", tyre_lf.tyre_compound_front != tyre_lf.tyre_compound_rear);          
                
            }
        }

        updatePressure(prefix, state) {
            const bar = this.bars[prefix];
            if (!bar) return;
            const { fill, geom } = bar;

            let pressure = state.tyre_normalized_pressure;
            if (pressure == null) return;

            bar.smooth = (bar.smooth ?? pressure) + (pressure - (bar.smooth ?? pressure)) * 0.25;
            pressure = bar.smooth;

            const dev = Math.max(-1, Math.min(1, pressure - 1));
            const offsetPx = dev * geom.maxHalf;
            const center = geom.center;

            const squareH = 5;
            const squareW = parseFloat(fill.getAttribute("width") || "2.5");
            fill.setAttribute("x", String(geom.x + (geom.w - squareW) / 2));
        
            const pad = 0.5;
            const minY = geom.y + pad;
            const maxY = geom.y + geom.h - pad - squareH;
            const yPos = Math.max(minY, Math.min(maxY, center - squareH / 2 - offsetPx));
            fill.setAttribute("y", String(yPos));
            fill.setAttribute("height", String(squareH));
        
            const t = Math.min(1, Math.abs(dev));
            const opacity = 0.3 + 0.7 * t;          
            fill.style.setProperty("fill", "#ffffff");
            fill.setAttribute("opacity", String(opacity));
        }
       
        bars = {};

        setupBar(prefix, groupEl) {
            const track = q(`#pressureBar_${prefix}`, groupEl);
            const fill  = q(`#pressureFill_${prefix}`, groupEl);
            if (!track || !fill) return;

            groupEl.appendChild(track);
            groupEl.appendChild(fill);

            track.style.setProperty("fill", "#ffffff", "important");

            const x = parseFloat(track.getAttribute("x"));
            const y = parseFloat(track.getAttribute("y"));
            const w = parseFloat(track.getAttribute("width"));
            const h = parseFloat(track.getAttribute("height"));
            const center = y + h / 2;

            fill.style.transition = "y 250ms ease, height 250ms ease, fill 200ms linear";
            const sqW = parseFloat(fill.getAttribute("width") || "1.5");
            fill.setAttribute("x", String(x + (w - sqW) / 2));
            fill.setAttribute("y", String(center - 2));
            fill.setAttribute("height", "4");

            this.bars[prefix] = {
                track, fill,
                geom: { x, y, w, h, center, maxHalf: h / 2 },
                smooth: null,
            };
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            
            this.mapElementById("lf");
            this.mapElementById("rf");
            this.mapElementById("rr");
            this.mapElementById("lr");
           
            this.lf_segments.left = q("#lf_inner_stop");
            this.lf_segments.center = q("#lf_center_stop");
            this.lf_segments.right = q("#lf_outer_stop");
            this.lf_segments.brake = q("rect[data-name=brake]", this.lf);
            this.lf_segments.core = q("rect[data-name=core]", this.lf);

            this.rf_segments.left = q("#rf_inner_stop");
            this.rf_segments.center = q("#rf_center_stop");
            this.rf_segments.right = q("#rf_outer_stop");
            this.rf_segments.brake = q("rect[data-name=brake]", this.rf);
            this.rf_segments.core = q("rect[data-name=core]", this.rf);

      
            this.lr_segments.left = q("#lr_inner_stop");
            this.lr_segments.center = q("#lr_center_stop");
            this.lr_segments.right = q("#lr_outer_stop");
            this.lr_segments.brake = q("rect[data-name=brake]", this.lr);
            this.lr_segments.core = q("rect[data-name=core]", this.lr);

            this.rr_segments.left = q("#rr_inner_stop");
            this.rr_segments.center = q("#rr_center_stop");
            this.rr_segments.right = q("#rr_outer_stop");
            this.rr_segments.brake = q("rect[data-name=brake]", this.rr);
            this.rr_segments.core = q("rect[data-name=core]", this.rr);
       
            this.lf.segments = this.lf_segments;
            this.rf.segments = this.rf_segments;
            this.lr.segments = this.lr_segments;
            this.rr.segments = this.rr_segments;


            this.setupBar("lf", this.lf);
            this.setupBar("rf", this.rf);
            this.setupBar("lr", this.lr);
            this.setupBar("rr", this.rr);
        }

    }
    ksUI$1.registerModule('ks-hudtyres', HudTyres);

    var template$14 = "<div class=\"damage-panel\">\r\n    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"180.856\" height=\"198.64\" viewBox=\"0 0 180.856 198.64\">\r\n        <g id=\"car_2_\" data-name=\"car (2)\" transform=\"translate(-87.478 204.741) rotate(-90)\">\r\n          <path id=\"Path_1201\" data-name=\"Path 1201\" d=\"M13.483,176.191A4.3,4.3,0,0,0,9.192,171.9H9.033A33.352,33.352,0,0,0,8,180.284a3.674,3.674,0,0,0,1.152.159,4.249,4.249,0,0,0,4.331-4.252Z\" transform=\"translate(-1.145 -27.445)\" fill=\"#8b8b8b\"/>\r\n          <path id=\"damage_center\" data-name=\"Path 1202\" d=\"M208.723,148.009c-9.377-14.86-30.475-21.734-47.719-17.721-.6.159-4.053,1.51-6,1.987a.53.53,0,0,0-.238.914,3.108,3.108,0,0,1,1.271,2.583c-.2,1.828-2.344,1.867-3.775,2.225-6.834,1.669-13.867,2.146-20.86,2.742-6.516.556-13.032,1.073-19.588,1.51-6.556.4-13.191,1.152-19.747,1.152-19.072,0-35.64.358-39.216.04a4.27,4.27,0,0,0-1.589.2C28.019,151.7,25.516,161.717,25.4,163.863c-.119,2.463-.159,9.735-.119,15.694-.04,5.96,0,13.191.119,15.694.119,2.146,2.622,12.158,25.866,20.224a3.658,3.658,0,0,0,1.589.2c3.576-.318,20.184.04,39.216.04,6.556,0,13.191.715,19.747,1.152,6.516.4,13.032.954,19.588,1.51,6.993.6,14.026,1.073,20.86,2.742,1.43.358,3.536.4,3.775,2.225a3.008,3.008,0,0,1-1.152,2.5.568.568,0,0,0,.278.954c2.94.556,9.417,2.861,10.569,3.02,8.344,1.351,19.787-2.742,27.257-5.642,15.257-5.88,21.058-21.416,22.727-36.157a83.284,83.284,0,0,0,.556-8.423c.2-10.966-1.708-22.33-7.549-31.588ZM57.9,181.186a1.6,1.6,0,0,1-1.391-.795c-.675-.04-1.589-.079-2.662-.119.04,10.688.6,21.257,1.748,27.614a1.3,1.3,0,0,1-1.748,1.351c-5.722-1.788-21.019-7.509-21.019-17.959v-23.4c0-10.45,15.3-16.171,21.019-17.959A1.282,1.282,0,0,1,55.6,151.27c-1.152,6.318-1.709,16.847-1.748,27.5l2.662-.04a1.64,1.64,0,0,1,1.351-.755,1.611,1.611,0,0,1,1.629,1.629,1.569,1.569,0,0,1-1.589,1.582ZM159.3,216.23a1.931,1.931,0,0,1-2.622.636c-4.569-2.742-18.674-3.775-24.316-4.331a1.956,1.956,0,0,1-1.669-2.463,107.076,107.076,0,0,0,0-61.029,1.912,1.912,0,0,1,1.669-2.463c5.642-.556,19.707-1.589,24.316-4.331a1.923,1.923,0,0,1,2.622.636C172.328,163.505,172.328,195.649,159.3,216.23Zm52.6-36.673a83.283,83.283,0,0,1-.556,8.423c-1.669,14.7-7.47,30.2-22.648,36.157v-.795c13.787-6.476,19.191-21.257,20.78-35.362.318-2.742.556-8.463.556-8.463.2-10.966-1.708-22.37-7.589-31.667a31.484,31.484,0,0,0-13.748-11.96v-.755a31.606,31.606,0,0,1,15.615,12.794c5.88,9.3,7.788,20.7,7.589,31.627Z\" transform=\"translate(-11.549 -1.687)\" fill=\"#8b8b8b\"/>\r\n          <path id=\"Path_1207\" data-name=\"Path 1207\" d=\"M13.543,322.791A4.3,4.3,0,0,0,9.252,318.5a5.374,5.374,0,0,0-1.152.159,31.429,31.429,0,0,0,1.033,8.384h.159a4.282,4.282,0,0,0,4.251-4.252Z\" transform=\"translate(-1.205 -115.797)\" fill=\"#8b8b8b\"/>\r\n          <path id=\"antenna\" d=\"M57,254.858c7.072.2,19.986.834,19.986.834V254.5L57,254.818Z\" transform=\"translate(-30.676 -77.226)\" fill=\"#8b8b8b\"/>\r\n          <path id=\"damage_right\" d=\"M5825.51-8713.585l-7.151-.517a1.483,1.483,0,0,1-.834-.237l-2.265-1.907,2.7.238c.237.353.675.874,1.032.953.517.081,6,.517,6,.517a3.113,3.113,0,0,0,1.231-.677l2.344.2-2.3,1.352a2.454,2.454,0,0,1-.629.082Zm-4.613-2.939a105.3,105.3,0,0,1-5.6-10.688c14.739.478,27.853,1.391,38.5,2.343-.079,1.67-2.383,5.882-4.968,9.655q-.8.006-1.61,0Q5834.035-8715.21,5820.9-8716.524Zm34.053-8.265c12.912,1.192,22.052,2.421,26.025,3.019a.734.734,0,0,1,.618.622.727.727,0,0,1-.42.769c-7.471,3.577-19.071,4.89-30.871,5.128C5852.089-8717.915,5854.792-8722.289,5854.95-8724.789Zm-47.4,6.4c-3.022-.874-15.1-5.369-21.3-7.669a.734.734,0,0,1-.493-.816.735.735,0,0,1,.729-.613c9.5-.121,18.635,0,27.178.238.795,2.464,3.656,7.551,5.368,10.529A106.278,106.278,0,0,1,5807.553-8718.393Z\" transform=\"translate(-5739.427 8943.067)\" fill=\"#a79090\"/>\r\n          <path id=\"damage_left\" d=\"M5875.66-8802.9h0a.737.737,0,0,1-.728-.615.735.735,0,0,1,.491-.816c6.2-2.3,18.279-6.753,21.3-7.667a95.429,95.429,0,0,1,11.484-1.668c-1.708,2.94-4.569,8.064-5.363,10.527-6.29.176-12.854.285-19.652.285Q5879.468-8802.854,5875.66-8802.9Zm34.45-10.966a263.341,263.341,0,0,1,27.931-1.312c2.584,3.775,4.89,7.985,4.968,9.656-10.687.951-23.76,1.865-38.541,2.344A92.661,92.661,0,0,1,5910.109-8813.865Zm29.365-1.272c11.84.239,23.4,1.589,30.872,5.124a.732.732,0,0,1,.42.771.733.733,0,0,1-.62.622c-3.976.555-13.112,1.827-26.023,3.018C5943.924-8808.146,5941.262-8812.476,5939.474-8815.138Zm-32.817-.8a3.294,3.294,0,0,1,.834-.236l7.151-.519a1.6,1.6,0,0,1,.754.08l2.3,1.35-2.345.2a2.713,2.713,0,0,0-1.19-.754s-5.483.4-6,.516h0c-.356.077-.794.595-1.071,1.033l-2.7.236Z\" transform=\"translate(-5828.596 8943.063)\" fill=\"#a79090\"/>\r\n          <path id=\"damage_rear\" d=\"M10.55,195.809c.2-5.046.278-9.1.318-12.4v-5.245c-.04-3.3-.119-7.351-.318-12.4,7.112-24.475,50.421-28.051,52.407-32.422-13.748-4.132-33.375-1.907-46.487,3.417a14.139,14.139,0,0,0-7.986,8.781,6.127,6.127,0,0,1-.437,12.238,5.026,5.026,0,0,1-1.113-.119,41.551,41.551,0,0,0,.4,4.45,5.371,5.371,0,0,1-.2,2.384l-.675,2.146a8.325,8.325,0,0,0-.358,2.424v23.4a8.325,8.325,0,0,0,.358,2.424l.675,2.146a5.371,5.371,0,0,1,.2,2.384,40.555,40.555,0,0,0-.4,4.45,5.3,5.3,0,0,1,1.113-.119,6.127,6.127,0,0,1,.437,12.238,14.139,14.139,0,0,0,7.986,8.781c13.112,5.324,32.74,7.549,46.487,3.417C60.97,223.853,17.7,220.237,10.55,195.8Zm-2.5-2.3h-1.2V168.076H8.047Z\" transform=\"translate(0 -2.92)\" fill=\"#a79090\"/>\r\n          <path id=\"damage_front\" d=\"M208.723,148.009c-9.377-14.86-30.475-21.734-47.719-17.721-.6.159-4.053,1.51-6,1.987,0,0,46.644-4.463,46.732,47.322s-46.573,47.2-46.573,47.2c2.94.556,9.417,2.861,10.569,3.02,8.344,1.351,19.787-2.742,27.257-5.642,15.257-5.88,21.058-21.416,22.727-36.157a83.279,83.279,0,0,0,.556-8.423c.2-10.966-1.708-22.33-7.549-31.588Zm3.179,31.548a83.288,83.288,0,0,1-.556,8.423c-1.669,14.7-7.47,30.2-22.648,36.157v-.795c13.787-6.476,19.191-21.257,20.78-35.362.318-2.742.556-8.463.556-8.463.2-10.966-1.708-22.37-7.589-31.667A31.484,31.484,0,0,0,188.7,135.89v-.755a31.606,31.606,0,0,1,15.615,12.794c5.88,9.3,7.788,20.7,7.589,31.627Z\" transform=\"translate(-11.549 -1.687)\" fill=\"#a79090\"/>\r\n          <path id=\"damage_suspension_lr\" d=\"M30.737,3.254c-2.446-2.446-6.246-1.56-6.794,1.469l-.486-.486a1,1,0,0,0-1.408-.094L19.983,6.21a1,1,0,0,0,.094,1.408l.823.823-.751.751-.823-.823a1,1,0,0,0-1.408-.094,1,1,0,0,0,.094,1.408c2.251,2.251,2.148,2.151,2.154,2.154.021.021-3.18-1.629-3.377-1.692-1-.323-1.594.853-.843,1.6L18.1,13.9c-3.426-1.733-3.3-1.7-3.562-1.734a.9.9,0,0,0-.777,1.506c.081.11-.048-.028,2.273,2.294-3.346-1.693-3.191-1.617-3.2-1.617A.9.9,0,0,0,11.6,15.6c.108.2.143.213,1.031,1.1l-.752.752-.823-.823a1,1,0,0,0-1.408-.094L7.588,18.6a1,1,0,0,0,.094,1.408l.137.137L5.139,23.89c-3.31.238-4.47,4.261-1.884,6.846s6.608,1.416,6.846-1.884l3.74-2.679a1.264,1.264,0,0,0,.861.475.874.874,0,0,0,.684-.244l2.066-2.066a1,1,0,0,0-.094-1.408l-.823-.823.752-.752.823.823a.938.938,0,1,0,1.314-1.314L17.27,18.709a28.672,28.672,0,0,0,3.483,1.72.909.909,0,0,0,.793-1.57c-.051-.059.1.1-2.211-2.216,3.525,1.783,3.364,1.751,3.717,1.743a.893.893,0,0,0,.676-1.435A24.745,24.745,0,0,0,21.4,14.577a28.759,28.759,0,0,0,3.483,1.72.86.86,0,0,0,1.067-1c-.067-.444-.282-.591-1.152-1.462l.751-.751.823.823A1,1,0,0,0,27.78,14l2.066-2.066a1,1,0,0,0-.094-1.408l-.486-.486c3.074-.556,3.881-4.382,1.469-6.794ZM7.588,29.623a2.147,2.147,0,0,1-3.019-.2,2.147,2.147,0,0,1-.2-3.019,2.152,2.152,0,0,1,3.019.2,2.152,2.152,0,0,1,.2,3.019ZM29.624,7.587a2.152,2.152,0,0,1-3.019-.2,2.151,2.151,0,0,1-.2-3.019,2.148,2.148,0,0,1,3.019.2,2.148,2.148,0,0,1,.2,3.019Z\" transform=\"translate(33.455 84.873) rotate(45)\" fill=\"red\"/>\r\n          <path id=\"damage_suspension_rr\" d=\"M30.737,3.254c-2.446-2.446-6.246-1.56-6.794,1.469l-.486-.486a1,1,0,0,0-1.408-.094L19.983,6.21a1,1,0,0,0,.094,1.408l.823.823-.751.751-.823-.823a1,1,0,0,0-1.408-.094,1,1,0,0,0,.094,1.408c2.251,2.251,2.148,2.151,2.154,2.154.021.021-3.18-1.629-3.377-1.692-1-.323-1.594.853-.843,1.6L18.1,13.9c-3.426-1.733-3.3-1.7-3.562-1.734a.9.9,0,0,0-.777,1.506c.081.11-.048-.028,2.273,2.294-3.346-1.693-3.191-1.617-3.2-1.617A.9.9,0,0,0,11.6,15.6c.108.2.143.213,1.031,1.1l-.752.752-.823-.823a1,1,0,0,0-1.408-.094L7.588,18.6a1,1,0,0,0,.094,1.408l.137.137L5.139,23.89c-3.31.238-4.47,4.261-1.884,6.846s6.608,1.416,6.846-1.884l3.74-2.679a1.264,1.264,0,0,0,.861.475.874.874,0,0,0,.684-.244l2.066-2.066a1,1,0,0,0-.094-1.408l-.823-.823.752-.752.823.823a.938.938,0,1,0,1.314-1.314L17.27,18.709a28.672,28.672,0,0,0,3.483,1.72.909.909,0,0,0,.793-1.57c-.051-.059.1.1-2.211-2.216,3.525,1.783,3.364,1.751,3.717,1.743a.893.893,0,0,0,.676-1.435A24.745,24.745,0,0,0,21.4,14.577a28.759,28.759,0,0,0,3.483,1.72.86.86,0,0,0,1.067-1c-.067-.444-.282-.591-1.152-1.462l.751-.751.823.823A1,1,0,0,0,27.78,14l2.066-2.066a1,1,0,0,0-.094-1.408l-.486-.486c3.074-.556,3.881-4.382,1.469-6.794ZM7.588,29.623a2.147,2.147,0,0,1-3.019-.2,2.147,2.147,0,0,1-.2-3.019,2.152,2.152,0,0,1,3.019.2,2.152,2.152,0,0,1,.2,3.019ZM29.624,7.587a2.152,2.152,0,0,1-3.019-.2,2.151,2.151,0,0,1-.2-3.019,2.148,2.148,0,0,1,3.019.2,2.148,2.148,0,0,1,.2,3.019Z\" transform=\"translate(33.455 222.873) rotate(45)\" fill=\"blue\"/>\r\n          <path id=\"damage_suspension_lf\" d=\"M30.737,3.254c-2.446-2.446-6.246-1.56-6.794,1.469l-.486-.486a1,1,0,0,0-1.408-.094L19.983,6.21a1,1,0,0,0,.094,1.408l.823.823-.751.751-.823-.823a1,1,0,0,0-1.408-.094,1,1,0,0,0,.094,1.408c2.251,2.251,2.148,2.151,2.154,2.154.021.021-3.18-1.629-3.377-1.692-1-.323-1.594.853-.843,1.6L18.1,13.9c-3.426-1.733-3.3-1.7-3.562-1.734a.9.9,0,0,0-.777,1.506c.081.11-.048-.028,2.273,2.294-3.346-1.693-3.191-1.617-3.2-1.617A.9.9,0,0,0,11.6,15.6c.108.2.143.213,1.031,1.1l-.752.752-.823-.823a1,1,0,0,0-1.408-.094L7.588,18.6a1,1,0,0,0,.094,1.408l.137.137L5.139,23.89c-3.31.238-4.47,4.261-1.884,6.846s6.608,1.416,6.846-1.884l3.74-2.679a1.264,1.264,0,0,0,.861.475.874.874,0,0,0,.684-.244l2.066-2.066a1,1,0,0,0-.094-1.408l-.823-.823.752-.752.823.823a.938.938,0,1,0,1.314-1.314L17.27,18.709a28.672,28.672,0,0,0,3.483,1.72.909.909,0,0,0,.793-1.57c-.051-.059.1.1-2.211-2.216,3.525,1.783,3.364,1.751,3.717,1.743a.893.893,0,0,0,.676-1.435A24.745,24.745,0,0,0,21.4,14.577a28.759,28.759,0,0,0,3.483,1.72.86.86,0,0,0,1.067-1c-.067-.444-.282-.591-1.152-1.462l.751-.751.823.823A1,1,0,0,0,27.78,14l2.066-2.066a1,1,0,0,0-.094-1.408l-.486-.486c3.074-.556,3.881-4.382,1.469-6.794ZM7.588,29.623a2.147,2.147,0,0,1-3.019-.2,2.147,2.147,0,0,1-.2-3.019,2.152,2.152,0,0,1,3.019.2,2.152,2.152,0,0,1,.2,3.019ZM29.624,7.587a2.152,2.152,0,0,1-3.019-.2,2.151,2.151,0,0,1-.2-3.019,2.148,2.148,0,0,1,3.019.2,2.148,2.148,0,0,1,.2,3.019Z\" transform=\"translate(162.455 84.873) rotate(45)\" fill=\"green\"/>\r\n          <path id=\"damage_suspension_rf\" d=\"M30.737,3.254c-2.446-2.446-6.246-1.56-6.794,1.469l-.486-.486a1,1,0,0,0-1.408-.094L19.983,6.21a1,1,0,0,0,.094,1.408l.823.823-.751.751-.823-.823a1,1,0,0,0-1.408-.094,1,1,0,0,0,.094,1.408c2.251,2.251,2.148,2.151,2.154,2.154.021.021-3.18-1.629-3.377-1.692-1-.323-1.594.853-.843,1.6L18.1,13.9c-3.426-1.733-3.3-1.7-3.562-1.734a.9.9,0,0,0-.777,1.506c.081.11-.048-.028,2.273,2.294-3.346-1.693-3.191-1.617-3.2-1.617A.9.9,0,0,0,11.6,15.6c.108.2.143.213,1.031,1.1l-.752.752-.823-.823a1,1,0,0,0-1.408-.094L7.588,18.6a1,1,0,0,0,.094,1.408l.137.137L5.139,23.89c-3.31.238-4.47,4.261-1.884,6.846s6.608,1.416,6.846-1.884l3.74-2.679a1.264,1.264,0,0,0,.861.475.874.874,0,0,0,.684-.244l2.066-2.066a1,1,0,0,0-.094-1.408l-.823-.823.752-.752.823.823a.938.938,0,1,0,1.314-1.314L17.27,18.709a28.672,28.672,0,0,0,3.483,1.72.909.909,0,0,0,.793-1.57c-.051-.059.1.1-2.211-2.216,3.525,1.783,3.364,1.751,3.717,1.743a.893.893,0,0,0,.676-1.435A24.745,24.745,0,0,0,21.4,14.577a28.759,28.759,0,0,0,3.483,1.72.86.86,0,0,0,1.067-1c-.067-.444-.282-.591-1.152-1.462l.751-.751.823.823A1,1,0,0,0,27.78,14l2.066-2.066a1,1,0,0,0-.094-1.408l-.486-.486c3.074-.556,3.881-4.382,1.469-6.794ZM7.588,29.623a2.147,2.147,0,0,1-3.019-.2,2.147,2.147,0,0,1-.2-3.019,2.152,2.152,0,0,1,3.019.2,2.152,2.152,0,0,1,.2,3.019ZM29.624,7.587a2.152,2.152,0,0,1-3.019-.2,2.151,2.151,0,0,1-.2-3.019,2.148,2.148,0,0,1,3.019.2,2.148,2.148,0,0,1,.2,3.019Z\" transform=\"translate(162.455 222.873) rotate(45)\" fill=\"yellow\"/>\r\n        </g>\r\n      </svg>\r\n</div>";

    class HudDamage extends KsHTMLHudElement {

        damage_front;
        damage_rear;
        damage_left;
        damage_right;
        damage_center;
        damage_suspension_lf;
        damage_suspension_rf;
        damage_suspension_lr;
        damage_suspension_rr;

        constructor() {
            super();
            this.template = template$14;
        }

        /** @param {UIDamageState} */
        process(damage) {

            /** 
             * @param {HTMLDivElement} position
             * @param  {Number} value
             */
            function indicate(position, value) {

                if (!position) {
                    console.warn("undefined position");
                    return;
                }

                var state = "";

                if (value > 0) {
                    state = "damaged";
                }

                if (value > 0.24) {
                    state = "minor";
                }

                if (value > 0.49) {
                    state = "moderate";
                }

                if (value > 0.74) {
                    state = "high";
                }

                if (value > 0.98) {
                    state = "destroyed";
                }

                position.className = state;

                return value > 0;
            }

            const ind = indicate.bind(this);

            ind(this.damage_front, damage.damage_front);
            ind(this.damage_rear, damage.damage_rear);
            ind(this.damage_left, damage.damage_left);
            ind(this.damage_right, damage.damage_right);
            ind(this.damage_center, damage.damage_center);

            ind(this.damage_suspension_lf, damage.damage_suspension_lf);
            ind(this.damage_suspension_rf, damage.damage_suspension_rf);
            ind(this.damage_suspension_lr, damage.damage_suspension_lr);
            ind(this.damage_suspension_rr, damage.damage_suspension_rr);
        }

        onBindingUpdate(binding_param, value) {
            if (binding_param == "ksmessage") {
                this.process(value);
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.setAttribute("data-bind-ksmessage", "{{ModelCurrentCar.car_damage}}");

            this.mapElementById("damage_front");
            this.mapElementById("damage_rear");
            this.mapElementById("damage_left");
            this.mapElementById("damage_right");
            this.mapElementById("damage_center");
            this.mapElementById("damage_suspension_lf");
            this.mapElementById("damage_suspension_rf");
            this.mapElementById("damage_suspension_lr");
            this.mapElementById("damage_suspension_rr");
        }

    }
    ksUI$1.registerModule('ks-huddamage', HudDamage);

    var template$13 = "<div class=\"timer\">\r\n\r\n    <div class=\"label\">\r\n        <component-slot data-name=\"label\">\r\n        </component-slot>\r\n    </div>\r\n\r\n    <div class=\"value\">\r\n        <component-slot data-name=\"value\">\r\n        </component-slot>\r\n    </div>\r\n\r\n</div>";

    var waittimertemplate = "<div class=\"timer\">\r\n    <div class=\"label\">\r\n        <div data-l10n-id=\"lblWaitTime\" data-bind-if=\"IsFlagSet(InSessionFlags.WaitForFinish,{{ModelUISessionState}})\"></div>\r\n        <div data-l10n-id=\"lblWaitPitBoxPitlane\" data-bind-if=\"IsFlagSet(InSessionFlags.WaitForPitBox,{{ModelUISessionState}})\"></div>\r\n        <div data-l10n-id=\"labelWaitingForAIControl\" data-bind-if=\"IsFlagSet(InSessionFlags.WaitForAiControl,{{ModelUISessionState}})\"></div>\r\n        <div data-l10n-id=\"labelWaitingForLastLap\" data-bind-if=\"IsFlagSet(InSessionFlags.LastLap,{{ModelUISessionState}})\"></div>\r\n    </div>\r\n    <div class=\"value\">\r\n        <div data-bind-value=\"{{ModelUISessionState}}.wait_time\"></div>\r\n    </div>\r\n</div>";

    var nextsessiontemplate = "<div class=\"timer\">\r\n    <div class=\"label\">\r\n        <div data-l10n-id=\"lblTimeToNextSession\"></div>\r\n    </div>\r\n    <div class=\"value\">\r\n        <div data-bind-value=\"{{ModelUISessionState}}.time_to_next_session\">13:00</div>\r\n    </div>\r\n</div>";

    class HudTimer extends KsHTMLHudElement {

        constructor() {
            super();
            this.template = template$13;
            this.waittimertemplate = waittimertemplate;
            this.nextsessiontemplate = nextsessiontemplate;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            if (this.dataset.mode == "waittimer") {
                this.innerHTML = this.waittimertemplate;
            }
            if (this.dataset.mode == "nextsession") {
                this.innerHTML = this.nextsessiontemplate;
            }


        }

    }
    ksUI$1.registerModule('ks-timer', HudTimer);

    var template$12 = "<div class=\"gauge\" data-bind-class-toggle=\"shift_up:{{ModelCurrentCar.is_change_up_rpm}};shift_down:{{ModelCurrentCar.is_change_down_rpm}};limiter:{{ModelCurrentCar.is_rpm_limiter_on}}\" data-bind-process=\"hud_speedo_radial_process({{ModelCurrentCar}})\">\r\n\r\n  <svg id=\"bgr\" viewBox=\"0 0 800 800\">\r\n\r\n    <defs>\r\n      <linearGradient id=\"lgrad\" x1=\"399.96\" y1=\"582\" x2=\"399.96\" y2=\"21.2\" gradientUnits=\"userSpaceOnUse\">\r\n        <stop offset=\"0\" stop-color=\"#000\" stop-opacity=\"0\"/>\r\n        <stop offset=\"1\" stop-color=\"#000\" stop-opacity=\".5\"/>\r\n      </linearGradient>\r\n      <linearGradient id=\"lgradoff\" x1=\"399.96\" y1=\"582\" x2=\"399.96\" y2=\"21.2\" gradientUnits=\"userSpaceOnUse\">\r\n        <stop offset=\"0\" stop-color=\"#333\" stop-opacity=\"0\"/>\r\n        <stop offset=\"0.25\" stop-color=\"#333\" stop-opacity=\"0.5\"/>\r\n      </linearGradient>\r\n\r\n    </defs>\r\n\r\n    <path id=\"gradient\" d=\"M91.92,571.98C-4.5,401.83,55.26,185.74,225.4,89.32,395.54-7.1,611.63,52.66,708.06,222.8c61.37,108.29,61.38,240.85.02,349.14\"/>\r\n\r\n    <path id=\"warning_indicator_left\" class=\"warning\" d=\"M193.25,179.72h-9.42v-6.2c0-3.1-2.48-5.62-5.58-5.66-1.12,0-2.21.33-3.14.95l-24.38,16.24c-4.33,2.9-5.5,8.76-2.6,13.1.69,1.03,1.58,1.91,2.6,2.6l24.38,16.24c2.6,1.72,6.1,1.01,7.82-1.59.61-.93.94-2.01.94-3.12v-6.2h9.46c3.11,0,5.63-2.54,5.62-5.65,0,0,0,0,0,0v-15.04c0-3.13-2.53-5.68-5.66-5.7l-.04.04Z\"/>\r\n    <path id=\"warning_indicator_right\" class=\"warning\" d=\"M606.75,206.08h9.42v6.2c0,3.1,2.48,5.62,5.58,5.66,1.12,0,2.21-.33,3.14-.95l24.38-16.24c4.33-2.9,5.5-8.76,2.6-13.1-.69-1.03-1.58-1.91-2.6-2.6l-24.38-16.24c-2.6-1.72-6.1-1.01-7.82,1.59-.61.93-.94,2.01-.94,3.12v6.2h-9.46c-3.11,0-5.63,2.54-5.62,5.65h0v15.05c0,3.13,2.53,5.68,5.66,5.7l.04-.04Z\"/>\r\n\r\n    <g id=\"warning_temperature\" class=\"warning\">\r\n      <path d=\"M612.12,300.06c-1.31-1.04-2.09-2.62-2.11-4.3v-3.76c0-1.57,1.28-2.85,2.85-2.85h18.59c.37,0,.73-.15.99-.41.32-.29.48-.73.41-1.16-.12-.77-.79-1.34-1.57-1.32h-18.43c-1.57,0-2.85-1.28-2.85-2.85v-2.85c0-1.57,1.28-2.85,2.85-2.85h18.59c.37,0,.73-.15.99-.41.32-.29.48-.73.41-1.16-.12-.77-.79-1.34-1.57-1.32h-18.43c-1.57,0-2.85-1.28-2.85-2.85v-2.85c0-1.57,1.28-2.85,2.85-2.85h18.59c.37,0,.73-.15.99-.41.32-.29.48-.73.41-1.16-.12-.77-.79-1.34-1.57-1.32h-18.43c-1.57,0-2.85-1.28-2.85-2.85v-4.3c0-2.29-1.8-4.18-4.09-4.3h-.17c-1.06,0-2.09.42-2.85,1.16-.94.89-1.48,2.13-1.49,3.43v39.13c0,1.69-.78,3.29-2.11,4.34-4.23,3.55-4.77,9.86-1.22,14.08,3.55,4.23,9.86,4.77,14.08,1.22,4.23-3.55,4.77-9.86,1.22-14.08-.39-.46-.81-.88-1.27-1.26v.12Z\"/>\r\n      <path d=\"M634.68,332.04c1.97.04,3.9-.52,5.54-1.61,1.2-.83,2.63-1.27,4.09-1.24.79,0,1.44-.64,1.45-1.43,0,0,0-.01,0-.02.02-.78-.6-1.43-1.38-1.45-.02,0-.04,0-.07,0-1.97-.04-3.9.52-5.54,1.61-2.48,1.65-5.7,1.65-8.18,0-3.38-2.19-7.73-2.19-11.11,0-2.48,1.65-5.7,1.65-8.18,0-3.38-2.19-7.73-2.19-11.11,0-2.48,1.65-5.7,1.65-8.18,0-1.63-1.1-3.57-1.66-5.54-1.61-1.97-.04-3.9.52-5.54,1.61-2.48,1.65-5.7,1.65-8.18,0-1.63-1.1-3.57-1.66-5.54-1.61-.79,0-1.44.64-1.45,1.43,0,0,0,.01,0,.02-.02.78.6,1.43,1.38,1.45.02,0,.04,0,.07,0,1.46-.03,2.89.4,4.09,1.24,1.63,1.1,3.57,1.66,5.54,1.61,1.96.02,3.89-.54,5.54-1.61,2.48-1.65,5.7-1.65,8.18,0,1.63,1.1,3.57,1.66,5.54,1.61,1.96.02,3.89-.54,5.54-1.61,2.48-1.65,5.7-1.65,8.18,0,3.38,2.19,7.73,2.19,11.11,0,2.48-1.65,5.7-1.65,8.18,0,1.65,1.1,3.6,1.67,5.58,1.61Z\"/>\r\n      <path d=\"M567.12,312.04c-.79,0-1.44.64-1.45,1.43,0,0,0,.01,0,.02-.02.78.6,1.43,1.38,1.45.02,0,.04,0,.07,0,1.46-.03,2.89.4,4.09,1.24,1.63,1.1,3.57,1.66,5.54,1.61,1.96.02,3.89-.54,5.54-1.61,2.48-1.65,5.7-1.65,8.18,0,1.63,1.1,3.57,1.66,5.54,1.61.5.01.99-.01,1.49-.08-.12-.12-.29-.21-.41-.33-.81-.73-1.52-1.56-2.11-2.48-1.09-.13-2.12-.53-3.02-1.16-1.63-1.1-3.57-1.66-5.54-1.61-1.96-.02-3.89.54-5.54,1.61-2.48,1.65-5.7,1.65-8.18,0-1.63-1.1-3.57-1.66-5.54-1.61l-.04-.08Z\"/>\r\n      <path d=\"M645.75,313.45c0-.79-.64-1.44-1.43-1.45,0,0-.01,0-.02,0-1.96-.01-3.89.55-5.54,1.61-2.49,1.65-5.73,1.65-8.22,0-3.38-2.19-7.73-2.19-11.11,0-.9.62-1.93,1.02-3.02,1.16-.71,1.07-1.57,2.03-2.56,2.85.5.04.99.08,1.49.08,1.97.04,3.9-.52,5.54-1.61,2.49-1.65,5.73-1.65,8.22,0,3.38,2.19,7.73,2.19,11.11,0,1.2-.83,2.63-1.27,4.09-1.24.79,0,1.44-.64,1.45-1.43,0,0,0-.01,0-.02v.04Z\"/>\r\n    </g>\r\n\r\n    <g id=\"warning_beam\" class=\"warning\">\r\n      <path d=\"M177.6,294.2c4.6,4.8,11,7.5,17.6,7.5h3.8c2,0,3.6-1.6,3.6-3.6h0v-42.7c0-2-1.6-3.6-3.6-3.7h-3.3c-13.8-.1-25.1,11-25.3,24.9,0,6.6,2.5,13,7.1,17.7h0l.1-.1Z\"/>\r\n      <path d=\"M234.8,288.6h-19c-1.3,0-2.4,1.1-2.4,2.4s1.1,2.4,2.4,2.4h19c1.3,0,2.4-1.1,2.4-2.4s-1.1-2.4-2.4-2.4Z\"/>\r\n      <path d=\"M234.8,260h-19c-1.3,0-2.4,1.1-2.4,2.4s1.1,2.4,2.4,2.4h19c1.3,0,2.4-1.1,2.4-2.4s-1.1-2.4-2.4-2.4Z\"/>\r\n      <path d=\"M234.8,274.3h-19c-1.3,0-2.4,1.1-2.4,2.4s1.1,2.4,2.4,2.4h19c1.3,0,2.4-1.1,2.4-2.4s-1.1-2.4-2.4-2.4Z\"/>\r\n    </g>\r\n\r\n    <g id=\"warning_parking\" class=\"warning\">\r\n     <path d=\"M628,554.4c-.6,0-1.2-.2-1.6-.7-.4-.4-.7-1-.7-1.6s.2-1.2.7-1.6c5.3-5.3,8.3-12.5,8.3-20s-2.9-14.7-8.3-20c-.4-.4-.7-1-.7-1.6s.2-1.2.7-1.6c.4-.4,1-.7,1.6-.7s1.2.2,1.6.7c6.2,6.2,9.6,14.5,9.6,23.3s-3.4,17.1-9.6,23.3c-.4.4-1,.7-1.6.7v-.2Z\"/>\r\n      <path d=\"M626.9,509.9c-.6-.6-.6-1.5,0-2.1s1.5-.6,2.1,0c6.3,6.3,9.4,14.5,9.4,22.7s-3.1,16.4-9.4,22.7c-.6.6-1.5.6-2.1,0s-.6-1.5,0-2.1c5.7-5.7,8.5-13.1,8.5-20.6s-2.8-14.9-8.5-20.6h0Z\"/>\r\n      <path d=\"M584.7,554.4c-.6,0-1.2-.2-1.6-.7-6.2-6.2-9.6-14.5-9.6-23.3s3.4-17.1,9.6-23.3c.4-.4,1-.7,1.6-.7s1.2.2,1.6.7c.9.9.9,2.4,0,3.3-5.3,5.3-8.3,12.5-8.3,20s2.9,14.7,8.3,20c.4.4.7,1,.7,1.6s-.2,1.2-.7,1.6c-.4.4-1,.7-1.6.7h0v.1Z\"/>\r\n      <path d=\"M585.7,551c.6.6.6,1.5,0,2.1s-1.5.6-2.1,0c-6.3-6.3-9.4-14.5-9.4-22.7s3.1-16.4,9.4-22.7c.6-.6,1.5-.6,2.1,0s.6,1.5,0,2.1c-5.7,5.7-8.5,13.1-8.5,20.6s2.8,14.9,8.5,20.6h0Z\"/>\r\n      <path d=\"M606.3,553.9c-6.3,0-12.2-2.4-16.6-6.9-4.4-4.4-6.9-10.3-6.9-16.6s2.4-12.2,6.9-16.6c4.4-4.4,10.3-6.9,16.6-6.9s12.2,2.4,16.6,6.9c4.4,4.4,6.9,10.3,6.9,16.6s-2.4,12.2-6.9,16.6c-4.4,4.4-10.3,6.9-16.6,6.9ZM606.3,511.6c-5,0-9.8,2-13.3,5.5s-5.5,8.3-5.5,13.3,2,9.8,5.5,13.3,8.3,5.5,13.3,5.5,9.8-2,13.3-5.5,5.5-8.3,5.5-13.3-2-9.8-5.5-13.3-8.3-5.5-13.3-5.5h0Z\"/>\r\n      <path d=\"M622.3,514.4c-4.1-4.1-9.8-6.6-16-6.6h0c-6.3,0-11.9,2.5-16,6.6-4.1,4.1-6.6,9.8-6.6,16s2.5,11.9,6.6,16,9.8,6.6,16,6.6,11.9-2.5,16-6.6,6.6-9.8,6.6-16-2.5-11.9-6.6-16ZM620.2,544.3c-3.6,3.6-8.5,5.8-13.9,5.8s-10.3-2.2-13.9-5.8c-3.6-3.6-5.8-8.5-5.8-13.9s2.2-10.3,5.8-13.9c3.6-3.6,8.5-5.8,13.9-5.8s10.3,2.2,13.9,5.8h0c3.6,3.6,5.8,8.5,5.8,13.9s-2.2,10.3-5.8,13.9Z\"/>\r\n      <g>\r\n        <path d=\"M598.9,542v-22.8h.7c1.7-.4,3.5-.5,5.5-.5,2.9,0,5.1.7,6.6,2,1.4,1.2,2.2,3,2.2,5.1s-.6,3.9-1.9,5.2c-1.6,1.7-4.1,2.6-7.2,2.6s-1,0-1.4,0v8.5h-4.5v-.1ZM603.2,529.6h1.5c1.7,0,4.6-.5,4.6-3.8s-2.3-3.4-4.3-3.4-1.4,0-1.8,0v7.1h0v.1Z\"/>\r\n        <path d=\"M599.7,519.9c1.3-.2,3.1-.4,5.3-.4s4.8.6,6.1,1.8c1.2,1,1.9,2.6,1.9,4.5s-.6,3.5-1.7,4.6c-1.5,1.6-3.9,2.4-6.6,2.4s-1.6,0-2.2-.2v8.6h-2.8v-21.3h0ZM602.5,530.3c.6.2,1.4.2,2.3.2,3.4,0,5.4-1.6,5.4-4.6s-2-4.2-5.1-4.2-2.1,0-2.6.2v8.4h0Z\"/>\r\n      </g>\r\n    </g>\r\n\r\n    <g id=\"warning_rain\" class=\"warning\">\r\n      <path d=\"M221.6,532.5c1.1,0,2-.9,2-2s-.9-2-2-2h-3.2c.8-2.8,1.2-5.5,1.3-8h1.9c1.1,0,2-.9,2-2s-.9-2-2-2h-2c-.1-1.5-.4-3-.7-4.5-.3-1.1-1.3-1.8-2.4-1.5s-1.8,1.3-1.5,2.4c.3,1.2.5,2.3.6,3.6h-4.1c-1.1,0-2,.9-2,2s.9,2,2,2h4.2c-.1,2.6-.6,5.3-1.5,8h-2.7c-1.1,0-2,.9-2,2s.9,2,2,2h1.3c-.8,2.8-1.2,5.5-1.3,8h0c-1.1,0-2,.9-2,2s.9,2,2,2h0c.1,1.5.4,3,.7,4.5.3,1.1,1.3,1.8,2.4,1.5s1.8-1.3,1.5-2.4c-.3-1.2-.5-2.3-.6-3.6h5.9c1.1,0,2-.9,2-2s-.9-2-2-2h-6c.1-2.6.6-5.3,1.5-8h4.7Z\"/>\r\n      <path id=\"z\" data-name=\"Path 6911\" d=\"M179,548c4.6,4.8,11,7.5,17.6,7.5h3.8c2,0,3.6-1.6,3.6-3.6h0v-42.7c0-2-1.6-3.6-3.6-3.7h-3.3c-13.8-.1-25.1,11-25.3,24.9,0,6.6,2.5,13,7.1,17.7h0l.1-.1Z\"/>\r\n    </g>\r\n\r\n    <path class=\"inputbgr steer\" d=\"M595.1,137.1c-115.5-87-274.6-87-390.1,0l-7.6-10c120-90.4,285.3-90.4,405.2,0l-7.6,10h.1Z\"/>\r\n    <path class=\"inputbgr clutch\" d=\"M110.74,562.55c-2.45-4.28-4.83-8.6-7.11-12.98-50.04-97.18-49.94-212.58.28-309.67\"/>\r\n    <path class=\"inputbgr brake\" d=\"M693.29,563.55c2.45-4.28,4.83-8.6,7.11-12.98,50.04-97.18,49.94-212.58-.28-309.67\"/>\r\n    <path class=\"inputbgr throttle\" d=\"M128.29,552.57c-52.55-91.96-54.82-210.3-6.04-304.31\"/>\r\n\r\n    <path id=\"rpm_bgr\" d=\"M73.25,581.94C-29.02,401.48,34.36,172.29,214.82,70.03c180.45-102.27,409.65-38.88,511.91,141.57,65.09,114.85,65.1,255.45.02,370.31\"/>\r\n    <path id=\"boost_bgr\" d=\"M275.4,402.25c0,42.2-34.2,76.4-76.4,76.4s-76.4-34.2-76.4-76.4,34.2-76.4,76.4-76.4,76.4,34.2,76.4,76.4Z\"/>\r\n\r\n    <!-- <path id=\"clutch\" d=\"M110.74,562.55c-2.45-4.28-4.83-8.6-7.11-12.98-50.04-97.18-49.94-212.58.28-309.67\" /> -->\r\n    <!-- <path id=\"throttle\" d=\"M693.29,563.55c2.45-4.28,4.83-8.6,7.11-12.98,50.04-97.18,49.94-212.58-.28-309.67\" /> -->\r\n    <!-- <path id=\"brake\" d=\"M128.29,552.57c-52.55-91.96-54.82-210.3-6.04-304.31\" /> -->\r\n    <!-- <path id=\"kers\" d=\"M95.03,570.24C-.42,401.82,58.74,187.91,227.16,92.46,395.59-2.99,609.49,56.17,704.94,224.59c60.75,107.2,60.76,238.42.02,345.62\" /> -->\r\n    <!-- <path id=\"rpm_path\" d=\"M73.25,581.94C-29.02,401.48,34.36,172.29,214.82,70.03c180.45-102.27,409.65-38.88,511.91,141.57,65.09,114.85,65.1,255.45.02,370.31\" /> -->\r\n    <!-- <path id=\"boost\" class=\"with-ignition\" d=\"M275.36,406.02c0,42.2-34.21,76.41-76.41,76.41s-76.41-34.21-76.41-76.41,34.21-76.41,76.41-76.41,76.41,34.21,76.41,76.41Z\" /> -->\r\n  </svg>\r\n\r\n  <svg id=\"kers_mask\" viewBox=\"0 0 800 800\">\r\n    <path id=\"kers\" d=\"M95.03,570.24C-.42,401.82,58.74,187.91,227.16,92.46,395.59-2.99,609.49,56.17,704.94,224.59c60.75,107.2,60.76,238.42.02,345.62\"/>\r\n  </svg>\r\n\r\n  <svg id=\"rpm_mask\" viewBox=\"0 0 800 800\">\r\n    <path id=\"rpm_path\" d=\"M73.25,581.94C-29.02,401.48,34.36,172.29,214.82,70.03c180.45-102.27,409.65-38.88,511.91,141.57,65.09,114.85,65.1,255.45.02,370.31\"/>\r\n  </svg>\r\n\r\n  <svg id=\"boost_mask\" viewBox=\"0 0 800 800\">\r\n    <path id=\"boost\" class=\"with-ignition\" d=\"M275.4,402.25c0,42.2-34.2,76.4-76.4,76.4s-76.4-34.2-76.4-76.4,34.2-76.4,76.4-76.4,76.4,34.2,76.4,76.4Z\"/>\r\n  </svg>\r\n\r\n  <svg id=\"clutch_mask\" viewBox=\"0 0 800 800\">\r\n    <path id=\"clutch\" d=\"M110.74,562.55c-2.45-4.28-4.83-8.6-7.11-12.98-50.04-97.18-49.94-212.58.28-309.67\"/>\r\n  </svg>\r\n\r\n  <svg id=\"throttle_mask\" viewBox=\"0 0 800 800\">\r\n    <path id=\"throttle\" d=\"M693.29,563.55c2.45-4.28,4.83-8.6,7.11-12.98,50.04-97.18,49.94-212.58-.28-309.67\"/>\r\n  </svg>\r\n\r\n  <svg id=\"brake_mask\" viewBox=\"0 0 800 800\">\r\n    <path id=\"brake\" d=\"M128.29,552.57c-52.55-91.96-54.82-210.3-6.04-304.31\"/>\r\n  </svg>\r\n\r\n  <svg id=\"ffb_mask\" viewBox=\"0 0 800 800\">\r\n    <path id=\"ffb\" d=\"M200.21,127.49l1.64-1.2c28.46-20.91,59.83-37.11,93.26-48.14,33.88-11.18,69.19-16.85,104.93-16.85s71.05,5.67,104.92,16.85c33.41,11.03,64.77,27.22,93.2,48.14l1.64,1.2-5.14,6.77-1.59-1.17c-56.32-41.37-123.07-63.24-193.01-63.24s-136.74,21.88-193.08,63.29l-1.59,1.17-5.18-6.82Z\"/>\r\n  </svg>\r\n\r\n\r\n  <svg id=\"steer_dot\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 230.09 231.73\">\r\n    <circle cx=\"3.72\" cy=\"3.72\" r=\"3.72\" transform=\"translate(111.33 15.28)\" fill=\"#fff\"/>\r\n  </svg>\r\n\r\n  <div class=\"gear with-ignition\" data-bind-value=\"hud_speedo_radial_gear({{ModelCurrentCar.gear}})\"></div>\r\n  <div class=\"speed with-ignition\">\r\n    <div class=\"value\" data-bind-value=\"{{ModelCurrentCar.display_speed_kmh}}\">110</div>\r\n    <div class=\"unit\">km/h</div>\r\n  </div>\r\n  <div class=\"rpm with-ignition\">\r\n    <div class=\"value\" data-bind-value=\"{{ModelCurrentCar.rpm}}\"></div>\r\n    <div class=\"label\">rpm</div>\r\n  </div>\r\n\r\n  <!-- <div class=\"odometer\" data-bind-value=\"hud_speedo_radial_odometer({{ModelCurrentCar.total_km}})\">\r\n    <div>000000</div>km\r\n  </div> -->\r\n\r\n  <div class=\"pitlimiter\" data-l10n-id=\"lblPitLimiterUpper\"></div>\r\n  <div class=\"electronics pmode\"><div data-bind-value=\"{{ModelCurrentCar}}.low_frequency.performance_mode_name\"></div>\r\n  </div>\r\n  <div id=\"boostvalue\" class=\"with-ignition\"><span data-bind-value=\"{{ModelCurrentCar}}.turbo_boost.toFixed(1)\"></span>bar</div>\r\n  <div id=\"boostlevelvalue\" class=\"with-ignition\"><span data-bind-value=\"Math.round({{ModelCurrentCar}}.turbo_boost_level * 100)\"></span>%</div>\r\n  <div class=\"dynamic-elements\">\r\n    <div class=\"electronics-wrapper\">\r\n      <div class=\"electronics drs\">DRS</div>\r\n\r\n      <div class=\"electronics tc\">TC<div data-bind-value=\"{{ModelCurrentCar.low_frequency.electronics.tc_level}}\"></div>\r\n      </div>\r\n\r\n      <div class=\"electronics tcc\">TCC<div data-bind-value=\"{{ModelCurrentCar.low_frequency.electronics.tc_cut_level}}\"></div>\r\n      </div>\r\n\r\n      <div class=\"electronics esc\">ESC<div data-bind-value=\"{{ModelCurrentCar.low_frequency.electronics.esc_level}}\"></div>\r\n      </div>\r\n\r\n      <div class=\"electronics map\">MAP<div data-bind-value=\"{{ModelCurrentCar.low_frequency.electronics.engine_map_level}}+1\"></div>\r\n      </div>\r\n\r\n      <div class=\"electronics abs\">ABS<div data-bind-value=\"{{ModelCurrentCar.low_frequency.electronics.abs_level}}\"></div>\r\n      </div>\r\n\r\n      <div class=\"newline\">\r\n        <div class=\"electronics mguh\">MGU-H</div>\r\n        <div class=\"electronics ers\">\r\n          ERS <div class=\"deco ers-d\">D</div>\r\n          <div class=\"ers-d\" data-bind-value=\"{{ModelCurrentCar}}.low_frequency.electronics.ers_deployment_map + 1\"></div>\r\n          <div class=\"deco ers-r\">R</div>\r\n          <div class=\"ers-r value\" data-bind-value=\"({{ModelCurrentCar}}.low_frequency.electronics.ers_recharge_map * 100).toFixed(0)\"></div>\r\n        </div>\r\n\r\n      </div>\r\n\r\n      <div class=\"newline\">\r\n        <div class=\"electronics bb\"><span class=\"label short\">BB</span><span class=\"label full\">BRAKE BIAS</span>\r\n          <div data-bind-value=\"({{ModelCurrentCar.low_frequency.electronics.brake_bias}} * 100).toFixed(1)\"></div>%\r\n        </div>\r\n        <div class=\"electronics ebb\"><span class=\"label short\">EBB</span>\r\n          <div data-bind-value=\"{{ModelCurrentCar}}.low_frequency.electronics.ebb_level + 1\"></div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n  <div class=\"fuelbar player-visible\">\r\n\r\n    <div class=\"fuelpercent\" data-bind-value=\"(Math.min({{ModelCurrentCar}}.fuel_liter_current_quantity_percent,1) * 100).toFixed(1) + '%'\"></div>\r\n    <div class=\"fuel\" data-bind-value=\"{{ModelCurrentCar}}.fuel_liter_current_quantity.toFixed(1) + 'L'\"></div>\r\n    <div class=\"bar\" data-bind-style-width=\"(Math.min({{ModelCurrentCar}}.fuel_liter_current_quantity_percent,1)  * 100) + '%'\"></div>\r\n    <div class=\"kersbar\" data-bind-style-width=\"({{ModelCurrentCar.kers_charge_perc}}  * 100) + '%'\"></div>\r\n    <div class=\"laps\" data-bind-value=\"{{ModelCurrentCar}}.laps_possible_with_fuel.toFixed(1)\"></div>\r\n    <div class=\"perlap\" data-bind-value=\"{{ModelCurrentCar}}.fuel_liter_per_lap.toFixed(1)\"></div>\r\n  </div>\r\n</div>";

    class HudSpeedoRadial extends KsHTMLHudElement {

        bgr;

        warning_indicator_left;
        warning_indicator_right;
        warning_parking;
        warning_beam;
        warning_rain;

        rpm_mask;
        boost_mask;
        kers_mask;
        throttle_mask;
        brake_mask;
        clutch_mask;
        ffb_mask;


        rpm_path;
        kers;
        boost;
        throttle;
        brake;
        clutch;
        ffb;

        lastSteerAngle = null;
        lastThrottleAngle = null;
        lastBrakeAngle = null;
        lastClutchAngle = null;
        lastRPM = null;

        steer_dot;

        warning_abs;
        warning_tc;

        indicator_light;

        svgWidth = 0;
        center = 0;

        USEEFFECT = true;
        _prevUSEEFFECT = true;

        is_electric = false;

        constructor() {
            super();
            this.template = template$12;
            this._bindFiltersToThis = true;
        }


        capabilities = {};

        filters = {
            hud_speedo_radial_gear: (value) => {
                if (value == 1) {
                    return this.classList.contains("is-electric") ? "D" : value;
                }
                return value;
            },
            hud_speedo_radial_odometer: (value) => {
                return `${ksUI$1.pad(value, 6)} km`;
            },
            hud_speedo_radial_process: (cardata) => {

                if (!this.isHUDVisible) return;

                const classList = this.classList;

                const low_frequency = cardata.low_frequency;
                const instrumentation = cardata.low_frequency.instrumentation;


                const electronics_max = cardata.low_frequency.electronics_max_limit;
                const electronics_min = cardata.low_frequency.electronics_min_limit;
                const electronics = cardata.low_frequency.electronics;
                const electronics_is_modifiable = cardata.low_frequency.electronics_is_modifiable;

                this.is_electric = classList.toggle("is-electric", cardata.low_frequency.engine_type == "electric_motor");


                classList.toggle("ignition-on", cardata.low_frequency.electronics.is_ignition_on);
                classList.toggle("engine-on", cardata.is_engine_running);

                const hasbb = classList.toggle("has-bb", electronics_is_modifiable.brake_bias > 0);

                let haselectronics = classList.toggle("has-abs", electronics_is_modifiable.abs_level > 0);
                haselectronics = classList.toggle("has-abs-simple", electronics_is_modifiable.abs_level == 0 && electronics.abs_level > 0) || haselectronics;

                haselectronics = classList.toggle("has-tc", electronics_is_modifiable.tc_level > 0) || haselectronics;
                haselectronics = classList.toggle("has-tc-simple", electronics_is_modifiable.tc_level == 0 && electronics.tc_level > 0) || haselectronics;

                haselectronics = classList.toggle("has-esc", electronics_is_modifiable.esc_level > 0) || haselectronics;
                haselectronics = classList.toggle("has-esc-simple", electronics_is_modifiable.esc_level == 0 && electronics.esc_level > 0) || haselectronics;

                haselectronics = classList.toggle("has-tcc", electronics_is_modifiable.tc_cut_level > 0) || haselectronics;
                haselectronics = classList.toggle("has-tcc-simple", electronics_is_modifiable.tc_cut_level == 0 && electronics.tc_cut_level > 0) || haselectronics;

                haselectronics = classList.toggle("has-map", electronics_is_modifiable.engine_map_level > 0) || haselectronics;

                haselectronics = classList.toggle("has-kers", low_frequency.has_kers) || haselectronics;
                haselectronics = (this.capabilities.ersd = classList.toggle("has-ers-deployment-map", electronics_is_modifiable.ers_deployment_map > 0)) || haselectronics;
                haselectronics = (this.capabilities.ersr = classList.toggle("has-ers-recharge-map", electronics_is_modifiable.ers_recharge_map > 0)) || haselectronics;
                haselectronics = classList.toggle("has-ers-heat-charging", electronics_is_modifiable.is_ers_heat_charging_on) || haselectronics;
                
                
                haselectronics = classList.toggle("has-perfmodes", electronics_is_modifiable.active_performance_mode > 0) || haselectronics;
                haselectronics = classList.toggle("has-ebb", electronics_is_modifiable.ebb_level > 0) || haselectronics;
                haselectronics = (this.capabilities.drs = classList.toggle("has-drs", electronics_is_modifiable.is_drs_open)) || haselectronics;

                classList.toggle("has-adjustable-boost", electronics_min.turbo_level != electronics_max.turbo_level);
                classList.toggle("has-boost", cardata.turbo_boost_level > 0);

                classList.toggle("has-electronics", haselectronics);
                classList.toggle("has-gears", cardata.low_frequency.max_gears > 1);

                classList.toggle("tall", (hasbb && haselectronics) && (this.capabilities.ersd || this.capabilities.ersr));

                classList.toggle("pitlimiter", cardata.low_frequency.electronics.is_pitlimiter_on);
                classList.toggle("pitlimiter-underspeed", cardata.low_frequency.electronics.is_pitlimiter_on && cardata.pitspeeding_delta < PITLIMITDELTALOW);
                classList.toggle("pitlimiter-overspeed", cardata.low_frequency.electronics.is_pitlimiter_on && cardata.pitspeeding_delta > PITLIMITDELTAHIGH);

                classList.toggle("not-player-car", !cardata.is_player_car);


                if (!this.is_electric) {
                    classList.toggle("rpmlimiter", cardata.is_rpm_limiter_on);
                    classList.toggle("overheat", cardata.water_temperature_c >= 100);
                    classList.toggle("cold-engine", cardata.water_temperature_c <= 65);
                }

                classList.toggle("low-fuel", cardata.fuel_liter_current_quantity < 8);

                this.classList.toggle("abs-active", cardata.abs_active);
                this.classList.toggle("tc-active", cardata.tc_active);
                this.classList.toggle("esc-active", cardata.esc_active === true);
                this.classList.toggle("tc-off", low_frequency.electronics.tc_level == 0);
                this.classList.toggle("tcc-off", low_frequency.electronics.tc_cut_level == 0);
                this.classList.toggle("abs-off", low_frequency.electronics.abs_level == 0);
                this.classList.toggle("esc-off", low_frequency.electronics.esc_level == 0);
                //this.classList.toggle("ersd-off", low_frequency.electronics.ers_deployment_map == 0);
                this.classList.toggle("ersr-off", low_frequency.electronics.ers_recharge_map == 0);

                this.classList.toggle("max-deploy", cardata.is_max_kj_per_lap_reached);
                this.classList.toggle("max-recharge", cardata.is_max_charge_kj_per_lap_reached);
                
                if(this.capabilities.drs) {
                this.classList.toggle("drs-active", low_frequency.electronics.is_drs_open);
                this.classList.toggle("drs-available", cardata.is_drs_available);
            }


                this.warning_indicator_left?.classList.toggle("blink_alt", instrumentation.warning_lights);
                this.warning_indicator_right?.classList.toggle("blink_alt", instrumentation.warning_lights);

                this.warning_indicator_left?.classList.toggle("blink", instrumentation.direction_light_left);
                this.warning_indicator_right?.classList.toggle("blink", instrumentation.direction_light_right);

                this.warning_beam.classList.toggle("on", instrumentation.main_light_stage > 0);
                this.warning_beam.classList.toggle("high", instrumentation.main_light_stage > 1);
                this.warning_beam.classList.toggle("flashing", instrumentation.flashing_lights);

                this.warning_rain.classList.toggle("on", instrumentation.rain_lights > 0);
                this.warning_parking.classList.toggle("on", cardata.handbrake_percent > 0);

                this.classList.toggle("charging-battery", cardata.battery_is_charging);

                this.classList.toggle("no-estimates", cardata.fuel_liter_per_lap <= 0);

                if (low_frequency.has_kers) {
                    this.classList.toggle("charging-kers", cardata.kers_is_charging);
                    this.classList.toggle("overtake-kers", low_frequency.electronics.is_ers_overtake_mode_on);
                    this.classList.toggle("mguh-active", low_frequency.electronics.is_ers_heat_charging_on);
                }

                const throttle_angle = Math.round(ksUI$1.range(cardata.gas_percent, 0, 1, 119.5, this.USEEFFECT ? 61 : 56));
                const brake_angle = Math.round(ksUI$1.range(cardata.brake_percent, 0, 1, -119, this.USEEFFECT ? -61.5 : -59));
                const steer_angle = Math.round(ksUI$1.range(ksUI$1.clamp(cardata.steering_percent, -1, 1), -1, 1, -35, 35));
                const clutch_angle = Math.round(ksUI$1.range(cardata.clutch_percent, 0, 1, -119, this.USEEFFECT ? -61 : -62));
                const ffb_abs = Math.abs(cardata.ffb_strength);
                const ffb_angle = Math.round(ksUI$1.range(ffb_abs, 0, 1, 0, 37.5));

                const ffb_positive = cardata.ffb_strength >= 0;

                const center = this.center;

                this.steer_dot.style.transform = `rotateZ(${steer_angle.toFixed()}deg)`;

                if (this._prevUSEEFFECT != this.USEEFFECT) {
                    this.boost_mask.removeAttribute("style");
                    this.kers_mask.removeAttribute("style");
                    this.rpm_mask.removeAttribute("style");
                    this.throttle_mask.removeAttribute("style");
                    this.brake_mask.removeAttribute("style");
                    this.clutch_mask.removeAttribute("style");
                    this.ffb_mask.removeAttribute("style");
                }

                if (this.USEEFFECT) {

                    if (!this.is_electric) {
                        const rpm_angle = Math.round(ksUI$1.range(Math.round(cardata.rpm_percent * 1000) / 1000, 0, 1, -118, 118));
                        this.convert.getRadialWipeEffect(this.rpm_mask, center, center, center, -118, rpm_angle, 1);
                        this.convert.getRadialWipeEffect(this.clutch_mask, center, center, center, -119, clutch_angle, 2);
                    } else {
                        this.convert.getRadialWipeEffect(this.rpm_mask, center, center, center, -119, -119, 1);
                    }

                    if (low_frequency.has_kers) {
                        const kers_angle = Math.round(ksUI$1.range(cardata.kers_current_perc, 0, 1, -118.75, 119.5));
                        this.convert.getRadialWipeEffect(this.kers_mask, center, center, center, -119.1, kers_angle, 2);
                    }

                    if (cardata.turbo_boost_level > 0) {
                        const boost_angle = Math.round(ksUI$1.range(cardata.turbo_boost_perc, 0, 1, -180, 180));
                        this.convert.getRadialWipeEffect(this.boost_mask, center / 2, center, center / 4, -180, boost_angle, 2);
                    }

                    this.convert.getRadialWipeEffect(this.throttle_mask, center, center, center, throttle_angle, 119.5, 2);
                    this.convert.getRadialWipeEffect(this.brake_mask, center, center, center, -119, brake_angle, 2);
                    this.convert.getRadialWipeEffect(this.ffb_mask, center, center, center, ffb_positive ? -ffb_angle : 0, ffb_positive ? 0 : ffb_angle, 2);

                    this.ffb.classList.toggle("clip", ffb_abs > 1);

                    this._prevUSEEFFECT = true;

                } else {
                    if (!this.is_electric) {
                        const rpm_angle = Math.round(ksUI$1.range(cardata.rpm_percent, 0, 1, -118, 118));
                        this.rpm_mask.style.clipPath = `path('${this.convert.getRadialWipePath(center, center, center, -119, rpm_angle)}')`;
                        this.clutch_mask.style.clipPath = `path('${this.convert.getRadialWipePath(center, center, center, -119.1, clutch_angle)}')`;
                    }

                    if (low_frequency.has_kers) {
                        const kers_angle = Math.round(ksUI$1.range(cardata.kers_current_perc, 0, 1, -118.75, 118));
                        this.kers_mask.style.clipPath = `path('${this.convert.getRadialWipePath(center, center, center, -119.1, kers_angle)}')`;
                    }

                    if (cardata.turbo_boost_level > 0) {
                        const boost_angle = Math.round(ksUI$1.range(cardata.turbo_boost, 0, 1, -179.5, 180));
                        this.boost_mask.style.clipPath = `path('${this.convert.getRadialWipePath(center / 2, center, center / 3, -180, boost_angle)}')`;
                    }

                    this.throttle_mask.style.clipPath = `path('${this.convert.getRadialWipePath(center, center, center, throttle_angle, 119.1)}')`;
                    this.brake_mask.style.clipPath = `path('${this.convert.getRadialWipePath(center, center, center, -119.1, brake_angle)}')`;

                    this._prevUSEEFFECT = false;
                }

                return 0;
            }
        }

        setDimensions() {
            this.svgWidth = this.rpm_mask.getBoundingClientRect().width;
            this.center = (this.svgWidth + (this.svgWidth - this.getBoundingClientRect().width) / 2) / 2;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("warning_brake");
            this.mapElementById("warning_indicator_left");
            this.mapElementById("warning_indicator_right");
            this.mapElementById("warning_beam");
            this.mapElementById("warning_rain");
            this.mapElementById("warning_handbrake");
            this.mapElementById("warning_abs");
            this.mapElementById("warning_tc");
            this.mapElementById("warning_parking");

            this.mapElementById("rpm_mask");
            this.mapElementById("boost_mask");
            this.mapElementById("kers_mask");
            this.mapElementById("clutch_mask");
            this.mapElementById("throttle_mask");
            this.mapElementById("brake_mask");
            this.mapElementById("ffb_mask");
            this.mapElementById("ffb");

            //this.mapElementById("rpm_path");
            //this.mapElementById("kers");
            //this.mapElementById("boost");
            this.mapElementById("steer_dot");

            //this.mapElementById("throttle");
            //this.mapElementById("brake");
            //this.mapElementById("clutch");

            this.mapElementById("bgr");

            this.setDimensions();

            engine.on("onResize", () => { this.setDimensions(); });

        }

    }
    ksUI$1.registerModule('ks-hudspeedo-radial', HudSpeedoRadial);

    var template$11 = "<div class=\"flags\" data-bind-process=\"hud_flags_process({{ModelCurrentCar}})\">\r\n    <div class=\"global\">\r\n        <div data-l10n-id=\"lblFlagFullCourse\"></div>\r\n    </div>\r\n    <div class=\"local\"></div>\r\n</div>";

    class HudFlags extends KsHTMLHudElement {

        constructor() {
            super();
            this.template = template$11;
        }

        filters = {
            hud_flags_process: (car) => {
                this.dataset.local = car.low_frequency.flags.flag;
                this.dataset.global = car.low_frequency.flags.global_flag;
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
        }

    }
    ksUI$1.registerModule('ks-hudflags', HudFlags);

    var template$10 = "<div class=\"radar-panel\" data-bind-process=\"hud_radar_process({{ModelUIRadarState}})\">\r\n        \r\n        <div class=\"radar\"></div>\r\n\r\n        <div class=\"car\"></div>        \r\n        \r\n        <div class=\"left\" data-bind-class-toggle=\"visible:{{ModelUIRadarState.left_sign.is_visible}}\"></div>\r\n        <div class=\"right\" data-bind-class-toggle=\"visible:{{ModelUIRadarState.right_sign.is_visible}}\"></div>\r\n\r\n</div>";

    class HudRadar extends KsHTMLHudElement {

        leftSign;
        rightSign;
        radarPanel;

        windowResizeHandler;
        scaleMultiplier;

        markers = {};

        clearActiveHandles = {};

        constructor() {
            super();
            this.template = template$10;
            this._bindFiltersToThis = true;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.setAttribute("data-bind-ksmessage", "{{ModelUIRadarState}}");

            this.leftSign = q('.left', this);
            this.rightSign = q('.right', this);
            this.radarPanel = q('.radar', this);
            this.car = q('.car', this);

            this.windowResizeHandler = engine.on("onResize", () => {
                const size = parseFloat(window["FontSize"]);
                this.scaleMultiplier = ksUI$1.range(size, 7, 25, 2.5, 7.35);
            });

            this.radarSettings = HUD._storedData.layouts.default.elements.hud_radar;

            if (this.radarSettings && !this.radarSettings.settings.visible) {
                this.remove();
            }

        }

        onRemovedFromDOM() {
            this.windowResizeHandler.clear();
        }

        sideColor(elem, color) {
            if (elem) {
                const red = color.x;
                const green = color.y;
                const blue = color.z;
                const alpha = color.w;
                const rgba_color = `rgba(${Math.round(red * 255)}, ${Math.round(green * 255)}, ${Math.round(blue * 255)}, ${alpha})`;
                elem.style.color = rgba_color;
            }
        }

        filters = {
            hud_radar_process(radarstate) {


                if (!this.isHUDVisible) return;

                const radar_panel = this.radarPanel;
                radar_panel.style.opacity = radarstate.opacity;
                this.car.style.opacity = radarstate.opacity;
                //this.car.style.opacity = radar_panel.style.opacity; // > 0.15 ? '1' : '0'; 

                if (radarstate.opponents_data && radarstate.opponents_data.length > 0) {
                    // this.sideColor(this.leftSign, radarstate.left_sign.color);
                    // this.sideColor(this.rightSign, radarstate.right_sign.color);

                    const radar_width = radar_panel.offsetWidth;
                    const radar_height = radar_panel.offsetHeight;

                    const radar_x = radar_width / 2;
                    const radar_y = radar_height / 2;

                    radarstate.opponents_data.forEach((current_opponent, index) => {
                        if (current_opponent.relative_dist_x !== undefined && current_opponent.relative_dist_y !== undefined) {
                            const carid = current_opponent.car_id;

                            const distance = Math.sqrt(
                                Math.pow(current_opponent.relative_dist_x, 2) + Math.pow(current_opponent.relative_dist_y, 2)
                            );
                            const maxDistance = 6.8;
                            const color = distance < maxDistance ? "#FF0018" : "rgb(255, 255, 255)";

                            let opponent_elem = this.markers[carid];
                            const normalized_x = current_opponent.relative_dist_x * this.scaleMultiplier;
                            const normalized_y = current_opponent.relative_dist_y * this.scaleMultiplier;

                            const x_to_perc = ((radar_x + normalized_x) / radar_width) * 100;
                            const y_to_perc = ((radar_y - normalized_y) / radar_height) * 100;

                            if (opponent_elem) {
                                opponent_elem.classList.add("active");
                                cancelAnimationFrame(this.clearActiveHandles[carid].id);
                                waitForFrames(() => {
                                    opponent_elem.classList.remove("active");
                                }, 15, this.clearActiveHandles[carid]);
                            } else {
                                opponent_elem = document.createElement("div");
                                opponent_elem.classList.add("opponent");
                                opponent_elem.classList.add("active");
                                opponent_elem.innerHTML = `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                                                            <g>
                                                            <path d="M104.7,88.92c-0.82-0.48-2.29-1.04-4.7-1.04s-3.88,0.57-4.7,1.04
                                                                    c-0.76,0.44-1.23,1.28-1.23,2.17v18.39c0,0.85,0.53,1.62,1.33,1.91
                                                                    c0.88,0.33,2.4,0.72,4.61,0.72s3.72-0.39,4.61-0.72c0.8-0.3,1.33-1.07,
                                                                    1.33-1.91V91.09C105.93,90.2,105.46,89.37,104.7,88.92z" />
                                                            </g>
                                                        </svg>`;

                                opponent_elem.dataset.value = carid;
                                radar_panel.appendChild(opponent_elem);
                                this.markers[carid] = opponent_elem;
                                this.clearActiveHandles[carid] = { id: 0 };
                            }
                            opponent_elem.style.left = `${y_to_perc}%`;
                            opponent_elem.style.top = `${x_to_perc}%`;
                            opponent_elem.style.opacity = `${current_opponent.opacity + 0.25}`;
                            opponent_elem.querySelector("path").style.fill = color;
                        }
                    });
                }
            }
        }

    }
    ksUI$1.registerModule('ks-hudradar', HudRadar);

    var template$$ = "<div class=\"trackmap-panel\" data-bind-process=\"hud_trackmap_process({{ModelCarsOnTrack}})\">\r\n        \r\n        <div class=\"trackmap\"></div>\r\n       \r\n        <div class=\"cars-container\"></div>\r\n</div>";

    class HudTrackMap extends KsHTMLHudElement {
      
        car;
        isFullMap = false;

        trackLayout;
        trackmapRotation = 0;

        showPosition = false;

        liveIds = new Set();

         CAR_STATE_STYLE = {
            default: {color: '#000', opacity: 1},
            focused: {color: '#ff0000ff', opacity: 1},     
            in_pit:    {color: '#616161ff', opacity: 1 }
            // more car states here
        };
     
        constructor() {
            super();
            this.template = template$$;
            this._bindFiltersToThis = true;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            ksUI$1.Models.enable(DataModels.CarsOnTrack);
            
            this.trackMap = q('.trackmap', this);

            const data = HUD.StoredData;
            const layout = data.layouts[data.lastLayout || 'default'];
            if (!layout.elements.hud_trackmap) {
                HUD.elementModified('hud_trackmap', {
                    settings: { visible: true, mode: 'optionFull' }
                });
            }       
            
            this.loadFromStorage();
            
            GAMEMODESELECTION.getSeasonInfoParameters().then(season => {
                this.selectTrackMap(season);             
            });
        }

        loadFromStorage() {
            const data = HUD.StoredData;
            const trackmap = data.layouts[data.lastLayout]?.elements?.hud_trackmap;
            if (!trackmap) return;

            const settings = trackmap.settings || {};
            const mode = settings.mode;

            if (typeof settings.showPosition === 'boolean') {
                this.showPosition = settings.showPosition;
            }
         
            const isHidden = mode === 'optionHidden';
            const isVisible = (settings.visible !== false) && !isHidden;
            this.style.display = isVisible ? '' : 'none';
          
            if (mode === 'optionFull') {
                this.isFullMap = true;
            } else if (mode === 'optionZoomed') {
                this.isFullMap = false;
            }
        }

        onRemovedFromDOM() {
        }

        selectTrackMap(season) {       
            const track = season?.sessions?.find(s => s.is_current)?.track_item ?? season?.sessions?.[0]?.track_item;
            if (!track) return;

            const slug = (s) =>
                String(s || "")
                .normalize("NFKD").replace(/[\u0300-\u036f]/g, "")
                .toLowerCase().trim()
                .replace(/[^a-z0-9]+/g, "_")
                .replace(/^-+|-+$/g, "");   

            this.trackName = slug(track.name);
            this.trackLayout = slug(track.layout);
            console.log("TRACK NAME", this.trackName, this.trackLayout);

            const url = `/images/trackmaps/${this.trackName}-${this.trackLayout}.texture`;           
            this.trackMap.style.backgroundImage = `url('${url}')`;
        }

        getTrackParams(name, layout) {
            const data = this.TRACK_DATA?.[name];
            if (!data) return null;
            return data.layouts?.[layout] ?? null;
        }

        getCarState(car_state) {
            if (car_state.is_focused) return 'focused';
            if (car_state.in_pit)     return 'in_pit';
            return 'default';
        }
      
        setCarStyle(car, car_state) {
            const key = car_state.is_focused ? 'focused' : this.getCarState(car_state);
            const s = this.CAR_STATE_STYLE[key] || this.CAR_STATE_STYLE.default;
            car.style.zIndex = car_state.is_focused ? 10 : 1;
            
            const target = car_state.car_position === 0 ? (car.triangle || car.circle) : car.circle;
            if (target) {
                target.setAttribute('fill', s.color);           
            }

            if (this.isFullMap) {
                const svg = car.querySelector('.car-svg');
                if (svg) {           
                    svg.style.transformOrigin = '50% 50%';
                    svg.style.transform = `rotate(${car_state.car_angle}deg)`;
                }
            }
        }

        fullMapMode(map, cars, carsPanel, offset_X, offset_Y, drawWf, drawHf, panel) {
            map.style.transformOrigin = '0 0';
            panel.style.transform = `translate(0, 0) rotate(${this.trackmapRotation}deg) scale(1)`;
            
            this.carsMap ||= new Map();
            const liveIds = new Set();
            
            for (const c of cars) {
                if (this.removeMarker(c)) continue;
                const id = String(c.car_number);
                liveIds.add(id);
                
                let cars_container = this.carsMap.get(id);
                if (!cars_container) {
                    cars_container = document.createElement('div');
                    cars_container.className = 'car';
                    cars_container.dataset.id = id;
                    cars_container.style.position = 'absolute';

                    const svg = this.createSVG();

                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    svg.appendChild(g);
                
                    const circle = this.createCircle();
                    g.appendChild(circle);

                    const tri = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    tri.setAttribute('class', 'car-marker');
                    tri.setAttribute('d', 'M7.66,1.45L1.11,14.32c-.12.23.15.46.45.39l6.44-1.52,6.44,1.52c.3.07.57-.16.45-.39L8.34,1.45c-.13-.25-.56-.25-.69,0Z');
                    tri.style.display = 'none';
                    g.appendChild(tri);

                    const badge = document.createElement('div');
                    badge.className = 'car-number';
                    const badgeText = document.createElement('div');
                    badgeText.className = 'car-number-text';
                    badge.appendChild(badgeText);
                    
                    cars_container.appendChild(svg);
                    cars_container.appendChild(badge);
                    carsPanel.appendChild(cars_container);
                
                    cars_container.svgGroup = g;
                    cars_container.circle = circle;
                    cars_container.triangle = tri;
                    cars_container.badgeText = badgeText;

                    this.carsMap.set(id, cars_container);
                }
                
                if (cars_container.badgeText) {
                    cars_container.badgeText.textContent = this.showPosition
                        ? c.car_position + 1
                        : c.car_number;
                }

              
                if (c.car_position == 0) {
                    cars_container.circle.style.display = 'none';
                    cars_container.triangle.style.display = '';
                } else {
                    cars_container.triangle.style.display = 'none';
                    cars_container.circle.style.display = '';
                }
               
                this.setCarStyle(cars_container, c);

                const final_x = offset_X + c.coord_x * drawWf;
                const final_y = offset_Y + c.coord_y * drawHf;

                cars_container.style.left = `${final_x * 100}%`;
                cars_container.style.top  = `${final_y * 100}%`;
                cars_container.style.transform = 'translate(-50%, -50%)';
                cars_container.style.visibility = 'visible';
            }        
            return liveIds;
        }

        createSVG() {    
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('class', 'car-svg');
            svg.setAttribute('viewBox', '0 0 16 16');
            svg.style.width = '1rem';
            svg.style.height = '1rem';
            svg.style.overflow = 'visible';
            return svg;
        }

        createCircle() {
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('class', 'car-marker');
            circle.setAttribute('cx', '8');
            circle.setAttribute('cy', '8');
            circle.setAttribute('r', '6.74');
            return circle;
        }

        removeMarker(c) {
            if (!this.carsMap) return false;

            if (c.coord_x === 0 && c.coord_y === 0) {
                const id = String(c.car_number);
                const ghost = this.carsMap.get(id);
                if (ghost) {
                    ghost.remove();
                    this.carsMap.delete(id);
                }
                return true;
            }

            return false;
        }

        filters = {
        hud_trackmap_process: (state) => {
            if (!state || !state.cars_on_track) return;
            
            const focused = state.cars_on_track.find(c => c.is_focused);
            
            let x = focused.coord_x; 
            let y = focused.coord_y;
            this.heading = state.focused_car_angle;
            const zoom = 3; 
            const panel = q('.trackmap-panel', this);
            
            const carsPanel = q('.cars-container', this);
            if (!panel || !this.trackMap) return;
            
            const pw = panel.clientWidth;
            const ph = panel.clientHeight;
                
            const panelRatio = pw / Math.max(ph, 1);

            let drawWf, drawHf, offset_X = 0.05, offset_Y = 0;
            if (panelRatio >= 1) {
                drawHf = 1;
                drawWf = 1 / panelRatio;
                offset_X  = (1 - drawWf) * 0.5;
            } else {
                drawWf = 1;
                drawHf = panelRatio / 1;
                offset_Y  = (1 - drawHf) * 0.5;
            }

            offset_X = state.trackmap_offset_x/2048;
            offset_Y = state.trackmap_offset_y/2048;

            if(this.isFullMap) {
                this.liveIds = this.fullMapMode(this.trackMap, state.cars_on_track, carsPanel, offset_X, offset_Y, drawWf, drawHf, panel);
            } else {           
                panel.classList.add('mask');
                this.style.borderRadius = '50%';
                panel.style.transform = `translate(0, 0) rotate(0deg) scale(1)`;

                const pxF = offset_X + x * drawWf;
                const pyF = offset_Y + y * drawHf;
        
                const cxF = 0.5, cyF = 0.5;
                const percent_x = (cxF - pxF) * 100;
                const percent_y = (cyF - pyF) * 100;
              
                const pivot_x = pxF * 100;
                const pivot_y = pyF * 100;
        
                this.trackMap.style.transformOrigin = `${pivot_x}% ${pivot_y}%`;
                this.trackMap.style.transform = `translate(${percent_x}%, ${percent_y}%) rotate(${-this.heading}deg) scale(${zoom})`;
        
                this.carsMap ||= new Map();
                const cars = state.cars_on_track;
                this.liveIds = new Set();
               
                const theta = (-this.heading) * Math.PI / 180;
                const cosT  = Math.cos(theta);
                const sinT  = Math.sin(theta);
                
                const fxF = pxF;
                const fyF = pyF;
                
                for (const c of cars) {
                    if (this.removeMarker(c)) continue;
                    const id = String(c.car_number);
                    this.liveIds.add(id);

                    let car = this.carsMap.get(id);
                    // if (!car) {
                    //     car = document.createElement('div');
                    //     car.className = 'car';
                    //     car.dataset.id = id;

                    //     const svg = this.createSVG();
                    //     const circle = this.createCircle();

                    //     svg.appendChild(circle);
                    //     car.appendChild(svg);
                    //     carsPanel.appendChild(car);

                    //     car.circle = circle;
                    //     this.carsMap.set(id, car);
                    // }

                    if (!car) {
                        car = document.createElement('div');
                        car.className = 'car';
                        car.dataset.id = id;

                        const svg = this.createSVG();

                        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                        svg.appendChild(g);

                        const circle = this.createCircle();
                        g.appendChild(circle);

                        const tri = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        tri.setAttribute('class', 'car-marker');
                        tri.setAttribute(
                            'd',
                            'M7.66,1.45L1.11,14.32c-.12.23.15.46.45.39l6.44-1.52,6.44,1.52c.3.07.57-.16.45-.39L8.34,1.45c-.13-.25-.56-.25-.69,0Z'
                        );
                        tri.style.display = 'none';
                        g.appendChild(tri);

                        car.appendChild(svg);
                        carsPanel.appendChild(car);

                        car.svgGroup = g;
                        car.circle = circle;
                        car.triangle = tri;

                        this.carsMap.set(id, car);
                    }

                    if (c.car_position == 0) {
                        car.circle.style.display = 'none';
                        car.triangle.style.display = '';
                    } else {
                        car.triangle.style.display = 'none';
                        car.circle.style.display = '';
                    }

                    this.setCarStyle(car, c);

                    const uxF = offset_X + c.coord_x * drawWf;
                    const uyF = offset_Y + c.coord_y * drawHf;
                    const dxF = uxF - fxF;
                    const dyF = uyF - fyF;       
                    const rxF = dxF * cosT - dyF * sinT;
                    const ryF = dxF * sinT + dyF * cosT;
                    const zxF = rxF * zoom;
                    const zyF = ryF * zoom;
                    
                    const final_x = 0.5 + zxF;
                    const final_y = 0.5 + zyF;
                    
                    car.style.visibility = 'visible';
                    car.style.left = `${final_x * 100}%`;
                    car.style.top  = `${final_y * 100}%`;
                    car.style.transform = 'translate(-50%, -50%)';
                }
            }      

            for (const [id, car] of this.carsMap) {
                if (!this.liveIds.has(id)) {
                    car.remove();
                    this.carsMap.delete(id);
                }
            }
        }
    }


    }
    ksUI$1.registerModule('ks-hudtrackmap', HudTrackMap);

    var template$_ = "<div class=\"component-body\" data-bind-process=\"hud_delta_process({{ModelCurrentCar}})\">\r\n\r\n    <div class=\"timing\">\r\n        <div class=\"relative-race-timing\" data-bind-if=\"!IsFlagSet(InSessionFlags.WaitForPitBox,{{ModelUISessionState}})\">\r\n\r\n            <div class=\"delta\">\r\n                <div class=\"delta-bg-svg\">\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 435.4 37.4\">\r\n                        <path d=\"M433.2,0H2.2C1,0,0,1,0,2.2H0v5.4C0,8.9,1,9.9,2.2,9.9h159.2c2.6,0,5,1.4,6.2,3.7l11.4,21.4c.8,1.5,2.4,2.5,4.2,2.5h68.9c1.7,0,3.3-1,4.2-2.5l11.4-21.4c1.2-2.3,3.6-3.7,6.2-3.7h159.2c1.2,0,2.2-1,2.2-2.2V2.2h0c0-1.2-1-2.2-2.2-2.2Z\"/>\r\n                    </svg>\r\n                </div>\r\n\r\n                <div class=\"value\" data-bind-value=\"ksUI.formatTime({{ModelCurrentCar}}.delta_time_ms, false, false, 3, '+')\"></div>\r\n                <div class=\"bar\"></div>\r\n                <div class=\"mid\"></div>\r\n            </div>\r\n\r\n        </div>\r\n    </div>\r\n</div>";

    class HudDelta extends KsHTMLHudElement {

        deltaBar;
        deltaValue;
        prevDelta;

        minDelta = -1000;
        maxDelta = 1000;

        filters = {
            hud_delta_process: (cardata) => {
                if(this.deltaSettings) {               
                    this.classList.toggle("hide", !this.deltaSettings.settings.visible);               
                }

                let deltaValue = cardata.delta_time_ms; //;10 * Math.round(cardata.delta_time_ms / 10);
                
                deltaValue = ksUI$1.clamp(deltaValue, this.minDelta, this.maxDelta);
                
                let predictedValue = cardata.predicted_lap_time_ms;
                
                if (predictedValue < 0) {
                    predictedValue = 0;
                }
              
                this.deltaTime(deltaValue, predictedValue);           

            },
            predicted: (x) => {
                x = ksUI$1.formatTimeExt(x, 3, false, 3);
                return x;
            }
        }

        deltaTime = (delta_value, predicted_value) => {
        this.classList.toggle("no-predicted", predicted_value <= 0);

        if (!this.deltaBar) {
            this.deltaBar = q(".delta .bar", this);
            this.deltaValue = q(".delta .value", this);
            this.classList.toggle("bar", delta_value);
        }

        const RED   = "#FF0018";
        const GREEN = "#44EA78";
        const color = delta_value > 0 ? RED : GREEN;


        this.deltaValue.style.color = color;
        this.deltaBar.style.background =
            `linear-gradient(to left, ${color} 20%, ${color} 80%, transparent 100%)`;


        this.deltaBar.style.transform = delta_value < 0 ? "scaleX(-1)" : "scaleX(1)";
        const width = ksUI$1.range(Math.abs(delta_value), 0, this.maxDelta, 0, 50);
        this.deltaBar.style.width = `${width}%`;
        };
            
        constructor() {
            super();
            this.template = template$_;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.deltaSettings = HUD._storedData.layouts.default.elements.hud_delta;
        }

    }
    ksUI$1.registerModule('ks-delta', HudDelta);

    var template$Z = "<div class=\"pitstop-info\">\r\n    <div class=\"pitstop-label\" data-l10n-id=\"lblPitstopTimer\">PITSTOP</div>\r\n    \r\n    <div class=\"pitstop-timer\" data-bind-value=\"ksUI.formatTimeExt(Math.round({{ModelCurrentCar.pit_info.time_in_pits}}), 3, false, 1)\"></div>    \r\n</div>";

    class PitstopTimer extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$Z;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();        
        }

        bindControls() {
            super.bindControls();       
        }


    }
    ksUI$1.registerModule('ks-pitstoptimer', PitstopTimer);

    var template$Y = "<div class=\"cardisplay\">\r\n</div>";

    class HudCarDisplay extends KsHTMLHudElement {

        /** @type MessageHandler */
        ViewSettingsClient;

        constructor() {
            super();
            this.template = template$Y;
            this.addVisibleCssClass = false;
        }


        onTemplateLoaded() {
            super.onTemplateLoaded();
            //this.classList.remove("visible");

            this.ViewSettingsClient = new MessageHandler("ViewSettings");


            this.ViewSettingsClient.request("Options", (data) => {
                this.assignModel(data, "ViewSettings", true);
                this.setAttribute("data-bind-class-toggle", "visible:{{ViewSettings}} && {{ViewSettings}}.dash_settings.render_dash_display && {{ModelCurrentCar}}.is_player_car");
                //this.setAttribute("data-bind-if", "{{ViewSettings}}.dash_settings.render_dash_display && {{ModelCurrentCar}}.is_player_car");
            });

            const img = new Image();

            img.onload = () => {
                const ratio = img.width / img.height;

                console.log("Set dash in hud ratio", ratio);

                if (!isNaN(ratio)) {
                    this.style.setProperty("--ratio", ratio);
                }

            };

            img.src = "/custom/hud/display";



        }

    }
    ksUI$1.registerModule('ks-hudcardisplay', HudCarDisplay);

    var template$X = "<div class=\"server-info\">   \r\n    <div class=\"qos\">\r\n        <div class=\"label\" data-l10n-id=\"lblServerInfoQoS\">QoS</div>\r\n        <div class=\"value\" data-bind-value=\"{{ModelUISessionState}}.player_qos\">-</div>        \r\n    </div>   \r\n    <div class=\"ping\">\r\n        <div class=\"label\" data-l10n-id=\"lblServerInfoPing\">Ping</div>\r\n        <div class=\"value\" data-bind-value=\"{{ModelUISessionState}}.player_ping\"></div>\r\n        <div class=\"suffix connected\">ms</div>\r\n    </div>    \r\n</div>";

    class ServerInfo extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$X;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
        }

        bindControls() {
            super.bindControls();       
        }


    }
    ksUI$1.registerModule('ks-serverinfo', ServerInfo);

    var template$W = "<div class=\"session-info\" data-bind-process=\"sessioninfo_process_flags({{ModelCurrentCar}})\" data-bind-process-session=\"sessioninfo_process_session({{ModelUISessionState}})\" data-bind-class=\"'phase'+{{ModelUISessionState.phase_name}}\" data-bind-weather=\"weather_icon({{ModelUISessionState.initial_weather}})\">\r\n    \r\n    <div class=\"session-svg-bg\">\r\n        <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 480.037 47.263\" preserveAspectRatio=\"none\">\r\n            <path d=\"M0,0,19.166,42.982a6.7,6.7,0,0,0,5.953,4.282h429.8a6.7,6.7,0,0,0,5.954-4.282L480.037,0Z\" fill=\"#00000080\"/>\r\n        </svg>\r\n    </div>\r\n      \r\n    <div class=\"session-container\">        \r\n        <div class=\"session-time session-duration\" data-bind-if=\"({{ModelUISessionState}}.phase_name == 'Waiting_For_Players' && {{ModelUISessionState.time_left}} != '') || {{ModelUISessionState}}.phase_name == 'Overtime_Waiting_For_Leader' || {{ModelUISessionState.total_lap}} == 0 || {{ModelUISessionState.current_lap}} == 0 ||  ({{ModelUISessionState.current_lap}} >= {{ModelUISessionState.total_lap}} +1)\" data-bind-value=\"{{ModelUISessionState.time_left}}\">            \r\n        </div>\r\n\r\n        <div class=\"session-laps session-duration lapcounter\" data-bind-class-toggle=\"hidden:{{ModelCurrentCar.low_frequency.is_last_lap}}\" data-bind-if=\"{{ModelUISessionState.total_lap}} > 0 && {{ModelUISessionState.current_lap}} <= {{ModelUISessionState.total_lap}} \">\r\n            <div data-bind-value=\"{{ModelUISessionState.current_lap}}\"></div>/<div data-bind-value=\"{{ModelUISessionState.total_lap}}\"></div>\r\n        </div>\r\n\r\n        <div class=\"core\" data-bind-class-toggle=\"last-lap:{{ModelCurrentCar.low_frequency.is_last_lap}}\">\r\n            <div class=\"local\" data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_DRIVING_ACADEMY'\"></div>\r\n            <div class=\"session-name\" data-bind-value=\"sessioninfo_session({{ModelUISessionState.session_name}})\"></div>\r\n            <div class=\"last-lap-label\" data-l10n-id=\"lblSessionInfoLastLapUpper\">\r\n            </div>\r\n            <div class=\"last-lap-leader-label\" data-l10n-id=\"lblSessionInfoLeaderOnLastLapUpper\">\r\n            </div>\r\n            <div class=\"local right\" data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_DRIVING_ACADEMY'\"></div>\r\n        </div>\r\n        \r\n        <div class=\"info\">\r\n            <div class=\"weather\">\r\n                <div class=\"weathericon\"></div>\r\n                <div class=\"temperature\" data-bind-value=\"(Math.round({{ModelCurrentCar.air_temperature_c}}) + 'C')\"></div>\r\n            </div>\r\n            <div class=\"vertical-spacer\"></div>\r\n            <div class=\"clock-icon\"></div>\r\n            <div class=\"timeofday\" data-bind-value=\"ksUI.getTimeOfDayFromCarState({{ModelCurrentCar}})\"></div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"message-section\">\r\n        <div class=\"message finished\" data-l10n-id=\"labelFinished\">FINISHED</div>\r\n        <div class=\"message position\" data-bind-if=\"{{ModelUISessionState.session_name}} == 'Race' || {{ModelUISessionState.session_name}} == 'Qualifying'\" data-bind-value=\"session_finish_position(ksUI.getOrdinalNumber({{ModelCurrentCar}}.low_frequency.current_pos + 1))\">\r\n        </div>\r\n        <div class=\"message waiting_for_players\" data-l10n-id=\"labelWaitingForPlayers\">WAITING FOR PLAYERS</div>\r\n        <div class=\"message waiting_for_leader\" data-l10n-id=\"labelWaitingForLeader\">WAITING FOR LEADER</div>\r\n        <div class=\"message waiting_for_others\" data-l10n-id=\"labelWaitingForOthers\">WAITING FOR OTHERS</div>\r\n    </div>\r\n\r\n</div>";

    class SessionBanner extends KsHTMLHudElement {
        /** @type HTMLDivElement */
        weatherIcon;

        lastSessionNameId = null;
        lastTranslated = null;

        constructor() {
            super();
            this.template = template$W;
            this.delayedInit = true;
        }

        filters = {
            sessioninfo_process_flags: (car) => {
                this.dataset.local = car.low_frequency.flags.flag;
                this.dataset.global = car.low_frequency.flags.global_flag;
            },
            sessioninfo_session: (x) => {
                if (!x) return "";

                const id = `lblSessionName_${x}`;

                if (this.lastSessionNameId != id) {
                    this.lastTranslated = engine.translate(id);
                    this.lastSessionNameId = id;
                }

                return this.lastTranslated;
            },
            weather_icon: (weather) => {
                this.dataset.weathericon = weather.weather_preset;
            },
            sessioninfo_process_session: (x) => {
                this.dataset.sessionPhase = x.phase_name;
                this.classList.toggle("session-ended", ksUI$1.isSet(x.end_session_flag, InSessionFlags.SessionEnd));
                this.classList.toggle("hide", !HUD._storedData.layouts.default.elements.hud_sessionbanner.settings.visible);
            },
            session_finish_position: (pos) => {
                if (!pos) return "";
                return engine.translate(pos);
            }       
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            console.log(ModelUISessionState);
            this.classList.toggle("not-hud", !this.closest("ks-hud"));
            this.weatherIcon = q('.weather .weathericon');
        }

    }
    ksUI$1.registerModule('ks-sessionbanner', SessionBanner);

    var template$V = "<div class=\"trackcut\">\r\n    <div class=\"label\" data-l10n-id=\"lblLaptimeGainDetected\"></div>\r\n    \r\n    <div class=\"distance-bgr\"></div>\r\n    <div class=\"indicator\"></div>\r\n\r\n    <div class=\"distance\"></div>\r\n</div>";

    class HudTrackCut extends KsHTMLHudElement {

        panelMain;
        indicator;
        label;
        distance;
        dfrag = new DocumentFragment();
        hideTimer;
        is_visible = true;
        hide_pending = false;
        last_delta = 0;

        constructor() {
            super();
            this.template = template$V;
            this._bindFiltersToThis = true;
        }

        filters = {
            hud_trackcut_process: (cardata_lowfreq) => {

                const deadline = cardata_lowfreq.distance_to_deadline;
                const delta = cardata_lowfreq.race_cut_current_delta;

                if (deadline > 0) {
                    clearTimeout(this.hideTimer);
                    this.hide_pending = false;
                    this.show();
                } else {
                    if (this.hide_pending || !this.is_visible) return;
                    this.setIndicatorColor(this.last_delta);
                    this.hide_pending = true;
                    //console.log("Track cut widget last value", this.last_delta, delta);
                    this.hideTimer = setTimeout(() => {
                        this.hide();
                        this.hide_pending = false;
                    }, 2000);

                }

                
                this.last_delta = delta;

                if (!this.hide_pending) {
                    this.setIndicatorColor(delta);
                }

                this.distance.style.width = (delta == 0 && deadline == 0) ? '0%' : `${100 - deadline}%`;

                this.classList.toggle("complete", delta == 0 && deadline == 0);
            }
        };

        setIndicatorColor(delta) {
            this.indicator.classList.toggle("max", delta >= 0.75);
            this.indicator.classList.toggle("high", 0.25 < delta && delta < 0.75);
            this.indicator.classList.toggle("mid", 0 < delta && delta < 0.25);
            this.indicator.classList.toggle("ideal", delta <= 0);
        }

        hide() {
            if (!this.is_visible) return;
            console.log("Hiding track cut widget");
            this.is_visible = false;
            this.dfrag.appendChild(this.panelMain);
        }

        show() {
            if (this.is_visible) return;
            console.log("Showing track cut widget");
            this.appendChild(this.dfrag.children[0]);
            this.is_visible = true;
        }

        onRemovedFromDOM() {
            clearTimeout(this.hideTimer);
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.panelMain = q(".trackcut", this);
            this.indicator = q(".indicator", this);
            this.label = q(".label", this);
            this.distance = q(".distance", this);

            this.hide();

            waitForFrames(() => {
                this.classList.add("visible");
            });
        }

    }
    ksUI$1.registerModule('ks-hudtrackcut', HudTrackCut);

    var template$U = "<div class=\"mfd\">\r\n\r\n  <div class=\"mfd-content\">\r\n\r\n    <ks-leaderboard id=\"leaderboard\"></ks-leaderboard>\r\n    <ks-mfd-controls id=\"mfd-controls\"></ks-mfd-controls>\r\n    <ks-mfd-pitstop id=\"mfd-pitstop\"></ks-mfd-pitstop>\r\n    <ks-mfd-car id=\"mfd-car\"></ks-mfd-car>\r\n  \r\n\r\n  </div>\r\n\r\n  <div class=\"mfd-footer\">\r\n    <div class=\"mfd-label\">OFFICIAL</div>\r\n    <div class=\"mfd-buttons\">\r\n      <div id=\"btnRealtime\" class=\"btn realtime active\" data-name=\"Realtime\" data-target=\"#leaderboard\">\r\n      </div>\r\n      <div id=\"btnOfficial\" class=\"btn official\" data-name=\"Official\" data-target=\"#leaderboard\">\r\n      </div>\r\n      <div id=\"btnCar\" class=\"btn car\" data-name=\"MfdCarSettings\" data-target=\"#mfd-car\"></div>\r\n      <div id=\"btnPitstop\" class=\"btn pitstop\" data-name=\"Pitstop\" data-target=\"#mfd-pitstop\">\r\n      </div>\r\n      <div id=\"btnControls\" class=\"btn controls\" data-name=\"Controls\" data-target=\"#mfd-controls\">\r\n      </div>\r\n    </div>\r\n  </div>\r\n</div>";

    var template$T = "<div class=\"component-body\">\r\n    <div id=\"btnGroupModes\" class=\"is-flex-row\">\r\n        <ks-btnbasic id=\"btnSteering\" data-sn-up=\"#sliderSteeringTrueForce\" data-sn-left=\"#btnGamepad\" class=\"focusable selected\" data-mode=\"steering\" toggle-group=\"switch\" data-name=\"steering\" toggle toggle-on-focus>\r\n            <div slot=\"name\" data-l10n-id=\"lblMFDControlsSteeringWheel\">Steering Wheel</div>\r\n        </ks-btnbasic>\r\n        <ks-btnbasic id=\"btnFfb\" data-sn-up=\"#sliderFfbAbsEffects\" class=\"focusable\" data-mode=\"ffb\" toggle-group=\"switch\" data-name=\"ffb\" toggle toggle-on-focus>\r\n            <div slot=\"name\" data-l10n-id=\"lblMFDControlsForceFeedback\">Force Feedback</div>\r\n        </ks-btnbasic>\r\n        <ks-btnbasic id=\"btnGamepad\" data-sn-up=\"#sliderGamepadRumbleEffects\" data-sn-right=\"#btnSteering\" class=\"focusable\" data-mode=\"gamepad\" toggle-group=\"switch\" data-name=\"gamepad\" toggle toggle-on-focus>\r\n            <div slot=\"name\" data-l10n-id=\"lblMFDControlsGamepad\">Gamepad</div>\r\n        </ks-btnbasic>\r\n    </div>\r\n\r\n    <div id=\"panelModes\" class=\"controls-settings\">\r\n        <div class=\"group-steering settings\" data-mode=\"steering\">\r\n            <ks-mfd-slider label=\"lblMFDControlsFFBGain\" data-bind-ksvalue=\"{{Mfd}}.device_settings.ffb_gain\" min=\"0\" step=\"0.01\" max=\"1.5\" threshold=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider label=\"lblMFDControlsSteerLock\" data-bind-ksvalue=\"{{Mfd}}.device_settings.steer_lock\" min=\"0\" step=\"10\" max=\"3000\" suffix=\"\">\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider label=\"lblMFDControlsDynamicDamping\" data-bind-ksvalue=\"{{Mfd}}.device_settings.dynamic_damping\" min=\"0\" step=\"0.01\" max=\"1\" precision=\"2\" suffix=\"%\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider label=\"lblMFDControlsMinDamper\" data-bind-ksvalue=\"{{Mfd}}.device_settings.min_damper\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider label=\"lblMFDControlsDamperGain\" data-bind-ksvalue=\"{{Mfd}}.device_settings.damper_gain\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider id=\"sliderSteeringTrueForce\" data-sn-down=\"#btnSteering\" label=\"lblMFDControlsTrueForceGain\" data-bind-ksvalue=\"{{Mfd}}.device_settings.true_force_gain\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n        </div>\r\n\r\n        <div class=\"group-ffb settings\" data-mode=\"ffb\">\r\n\r\n            <ks-mfd-slider data-sn-up=\"#btnFfb\" label=\"lblMFDControlsCurbsGain\" data-bind-ksvalue=\"{{Mfd}}.ffb_enhancements.curbs_gain\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider label=\"lblMFDControlsGForceGain\" data-bind-ksvalue=\"{{Mfd}}.ffb_enhancements.gforce_gain\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider label=\"lblMFDControlsSlipsGain\" data-bind-ksvalue=\"{{Mfd}}.ffb_enhancements.slips_gain\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider id=\"sliderFfbAbsEffects\" data-sn-down=\"#btnFfb\" label=\"lblMFDControlsABSGain\" data-bind-ksvalue=\"{{Mfd}}.ffb_enhancements.abs_gain\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n        </div>\r\n\r\n        <div class=\"group-gamepad settings\" data-mode=\"gamepad\">\r\n\r\n            <ks-mfd-slider data-sn-up=\"#btnGamepad\" label=\"lblMFDControlsSpeedSensitivity\" data-bind-ksvalue=\"{{Mfd}}.device_settings.speed_sensitivity\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider label=\"lblMFDControlsSteerFilter\" data-bind-ksvalue=\"{{Mfd}}.device_settings.steer_filter\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider label=\"lblMFDControlsSteerAssistWeight\" data-bind-ksvalue=\"{{Mfd}}.device_settings.steer_assist_weight\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider label=\"lblMFDControlsVibrations\" data-bind-ksvalue=\"{{Mfd}}.device_settings.vibrations\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"assist-mode\" label=\"lblMFDControlsSteerAssistMode\" data-bind-ksvalue=\"{{Mfd}}.device_settings.joypad_steer_assist_mode\" values=\"Direct,Assisted,Smart\">\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider id=\"sliderGamepadRumbleEffects\" data-sn-down=\"#btnGamepad\" label=\"lblMFDControlsRumbleGain\" data-bind-ksvalue=\"{{Mfd}}.ffb_enhancements.rumble_gain\" min=\"0\" step=\"0.01\" max=\"1\" suffix=\"%\" precision=\"2\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n        </div>\r\n    </div>\r\n</div>";

    var template$S = "<div class=\"mfdslider-body component-body\">\r\n    <div class=\"label\"></div>\r\n    <div class=\"value_unit\">\r\n        <div class=\"value\"></div>\r\n        <div class=\"suffix\"></div>\r\n    </div>\r\n    <div class=\"left\"></div>\r\n    <div class=\"right\"></div>\r\n</div>";

    class MfdSlider extends KsHTMLElement {

        #debug;

        focused = false;

        _index = 0;
        _min = 0;
        _max = 100;
        _threshold;
        _step = 1;
        _precision = 0;
        _value = 0;

        _displayvalueoffset = 0;

        _suffix = "";

        step = 1;
        precision = 0;
        percentagedecimals = 0;
        loop = false;

        get suffix() {
            return this._suffix;
        }

        set suffix(new_suffix) {
            this._suffix = new_suffix;
            if (this.panelSuffix)
                this.panelSuffix.textContent = new_suffix;
        }

        get displayvalueoffset() {
            return this._displayvalueoffset;
        }

        set displayvalueoffset(new_offset) {
            this._displayvalueoffset = new_offset;
        }

        get min() {
            return this._min;
        }

        set min(new_min) {
            this._min = Number(new_min);

            if (!this.hasCustomValues && this.value < this._min) {
                this.value = ksUI$1.clamp(this.value, this._min, this._max);
            }

            this.classList.toggle("min-value", this.value == this.min);
        }

        get max() {
            return this._max;
        }

        set max(new_max) {

            this._max = Number(new_max);

            if (!this.hasCustomValues && this.value > this._max) {
                this.value = ksUI$1.clamp(this.value, this._min, this._max);
            }

            if (this.panelSuffix && this.showMax) {
                this.panelSuffix.textContent = `/${this.max + this.displayvalueoffset}`;
            }

            this.classList.toggle("max-value", this.value == this.max);


        }

        get threshold() {
            return this._threshold;
        }

        set threshold(new_threshold) {
            this._threshold = new_threshold;
            this.updateDisplayValue();
        }

        get value() {
            if (this.hasCustomValues) {
                return this.values[this.index];
            } else {
                return this._value;
            }
        }

        set value(new_value) {
            if (this.hasCustomValues) {
                this.index = this.values.indexOf(new_value);
            }

            //if (this.hasDisplayValues) {
            //this.index = this.displayvalues.indexOf(new_value);
            //}

            if (this._value != Number(new_value)) {
                this._value = Number(new_value);
                this.onChanged(new_value);
            }

            this.updateDisplayValue();
        }

        get index() {
            return this._index;
        }

        set index(new_index) {
            this._index = new_index;
        }

        setValueByIndex(new_index) {
            this.index = new_index;
            this.updateDisplayValue();
        }

        repeaterInterval;
        _repeatDefault = 350;
        repeaterIntervalDuration = this._repeatDefault;

        inputHandler;

        /** @type {Array} */
        values;

        /** @type {Array} */
        displayvalues;


        /** @type {HTMLDivElement} */
        panelLabel;
        /** @type {HTMLDivElement} */
        panelValue;
        /** @type {HTMLDivElement} */
        panelSuffix;

        /** @type {HTMLDivElement} */
        panelLeft;
        /** @type {HTMLDivElement} */
        panelRight;

        get asPercentage() {
            return this.hasAttribute("percentage");
        }

        get showMax() {
            return this.hasAttribute("showmax");
        }

        get boolean() {
            return this.hasAttribute("boolean");
        }

        get hasCustomValues() {
            return this.values !== undefined;
        }

        get hasDisplayValues() {
            return this.displayvalues !== undefined;
        }

        constructor() {
            super();
            this.template = template$S;
            this.delayedInit = true;
        }

        onBindingUpdate(binding_param, new_value) {
            if (this.#debug) console.warn(binding_param, new_value);
            if (!this.templateLoaded) return;
            this.value = new_value;
        }

        translateValues = true;

        updateDisplayValue(new_value) {
            const display_value = new_value != undefined ? new_value : this.value;

            if (this.hasDisplayValues) {
                if (this.panelValue)
                    this.panelValue.textContent = this.translateValues ? engine.translate(this.displayvalues[this.value]) : this.displayvalues[this.value];
                this.classList.toggle("min-value", this.value == 0);
                this.classList.toggle("max-value", this.value == this.displayvalues.length - 1);

            } else if (!this.hasCustomValues) {

                if (this.panelValue) {
                    const finaldisplayvalue = this.asPercentage ? (display_value * 100).toFixed(this.percentagedecimals) : (display_value + this._displayvalueoffset).toFixed(this.precision);
                    if (this.panelValue.textContent != finaldisplayvalue) {
                        this.panelValue.textContent = finaldisplayvalue;
                    }
                }

                if (this.panelSuffix && this.showMax) {
                    const finalsuffix = `/${this.max + this.displayvalueoffset}`;
                    if (this.panelSuffix.textContent != finalsuffix) {
                        this.panelSuffix.textContent = finalsuffix;
                    }
                }

                if (this.#debug) console.log(display_value);
                this.classList.toggle("min-value", this.value == this.min);
                this.classList.toggle("max-value", this.value == this.max);
                if (this._threshold != undefined) {
                    this.classList.toggle("over-threshold", this.value > this.threshold);
                    this.classList.toggle("under-threshold", this.value < this.threshold);
                }
            } else {
                if (this.panelValue)
                    this.panelValue.textContent = this.translateValues ? engine.translate(this.value) : this.value;
                this.classList.toggle("min-value", this.index == 0);
                this.classList.toggle("max-value", this.index == this.values.length - 1);
            }
        }

        increase(multiplier = 1) {
            if (!this.hasCustomValues) {
                if (this.value < this.max) {
                    this.value += (this.step * multiplier);
                }

                this.value = Number(ksUI$1.clamp(this.value, this.min, this.max).toFixed(this.precision));
            } else {
                if (this.index < this.values.length - 1) {
                    this.index++;
                }
                this.value = this.values[this.index];
            }
        }

        decrease(multiplier = 1) {
            if (!this.hasCustomValues) {
                if (this.value > this.min) {
                    this.value -= (this.step * multiplier);
                }

                this.value = Number(ksUI$1.clamp(this.value, this.min, this.max).toFixed(this.precision));
            } else {
                if (this.index > 0) {
                    this.index--;
                }
                this.value = this.values[this.index];
            }
        }

        timedIncrease() {
            this.increase();
            this.repeaterInterval = setTimeout(() => {
                this.timedIncrease();
                if (this.repeaterIntervalDuration > 25)
                    this.repeaterIntervalDuration -= 50;

            }, this.repeaterIntervalDuration);
        }

        timedDecrease() {
            this.decrease();
            this.repeaterInterval = setTimeout(() => {
                this.timedDecrease();
                if (this.repeaterIntervalDuration > 25)
                    this.repeaterIntervalDuration -= 50;

            }, this.repeaterIntervalDuration);
        }

        onChanged(new_value) {

        }

        blurTimer;
        lastPress;
        stepMultiplier = 1;

        setupInputHandler() {
            this.inputHandler = engine.on("UIExInputsAction", (e) => {
                //console.log("-> UIExInputsAction " + e.action);

                if (e.action == "InputAction_UI_Up" || e.action == "InputAction_UI_Down") {
                    this.classList.remove("last-focused");
                }

                if (!this.focused) return;

                if (e.action == "InputAction_UI_Left") {
                    const delta = Date.now() - this.lastPress;

                    if (delta <= 250 && delta > 190) {
                        this.stepMultiplier >= 20 ? this.stepMultiplier = 20 : this.stepMultiplier++;
                    } else {
                        this.stepMultiplier = 1;

                    }

                    this.decrease(this.stepMultiplier);
                    this.lastPress = Date.now();
                }

                if (e.action == "InputAction_UI_Right") {
                    const delta = Date.now() - this.lastPress;
                    if (delta <= 220 && delta > 190) {
                        this.stepMultiplier >= 20 ? this.stepMultiplier = 20 : this.stepMultiplier++;
                    } else {
                        this.stepMultiplier = 1;
                    }

                    this.increase(this.stepMultiplier);
                    this.lastPress = Date.now();
                }
            });
        }

        bindControls() {

            this.setupInputHandler();

            this.onfocus = () => {
                this.focused = true;
                this.classList.remove("last-focused");
                clearTimeout(this.blurTimer);

                this.blurTimer = setTimeout(() => { this.blur(); }, 3000);

            };

            this.onblur = () => {
                this.classList.add("last-focused");
                clearTimeout(this.blurTimer);
                this.focused = false;
            };




            this.panelRight.addEventListener("mousedown", () => {
                this.increase();
                this.repeaterInterval = setTimeout(() => this.timedIncrease(), this.repeaterIntervalDuration);

            });

            this.panelLeft.addEventListener("mousedown", () => {
                this.decrease();
                this.repeaterInterval = setTimeout(() => this.timedDecrease(), this.repeaterIntervalDuration);

            });

            this.panelRight.addEventListener("mouseup", () => {
                clearTimeout(this.repeaterInterval);
                this.repeaterIntervalDuration = this._repeatDefault;
            });

            this.panelRight.addEventListener("mouseout", () => {
                clearTimeout(this.repeaterInterval);
                this.repeaterIntervalDuration = this._repeatDefault;
            });

            this.panelLeft.addEventListener("mouseup", () => {
                clearTimeout(this.repeaterInterval);
                this.repeaterIntervalDuration = this._repeatDefault;
            });

            this.panelLeft.addEventListener("mouseout", () => {
                clearTimeout(this.repeaterInterval);
                this.repeaterIntervalDuration = this._repeatDefault;
            });

        }

        onTemplateLoaded() {
            this.#debug = this.hasAttribute("debug");
            this.templateLoaded = true;
            this.classList.add("focusable");
            this.dataset.snLeft = "NONE";
            this.dataset.snRight = "NONE";

            this.panelLabel = q(".label", this);
            this.panelValue = q(".value", this);
            this.panelSuffix = q(".suffix", this);
            this.panelLeft = q(".left", this);
            this.panelRight = q(".right", this);


            if (this.hasAttribute("label")) {
                this.panelLabel.textContent = engine.translate(this.getAttribute("label"));
            } else {
                this.panelLabel.textContent = this.getAttribute("text");
            }

            if (this.hasAttribute("suffix"))
                this.suffix = this.getAttribute("suffix");

            ["min", "max", "step", "precision", "threshold", "displayvalueoffset"].forEach(entry => {
                if (this.hasAttribute(entry))
                    this[entry] = Number(this.getAttribute(entry));
            });

            if (this.hasAttribute("boolean")) {
                this.max = 1;
            }

            if (this.hasAttribute("percentagedecimals"))
                this.percentagedecimals = this.getAttribute("percentagedecimals");

            ///if(this.hasAttribute(this.threshold))
            // this.threshold = this.threshold ?? this.max;

            if (this.hasAttribute("values")) {
                this.values = this.getAttribute("values").split(",");
                this.classList.add("custom-values");
            }


            if (this.hasAttribute("displayvalues")) {
                this.displayvalues = this.getAttribute("displayvalues").split(",");
                this.classList.add("display-values");
            }

            if (this.hasAttribute("unlocalized")) {
                this.translateValues = false;
            }

        }

        connectedCallback() {
            super.connectedCallback();
            if (this.templateLoaded) {
                this.setupInputHandler();
            }
        }

        onRemovedFromDOM() {
            //console.log("mfd-slider removed");
            if (this.inputHandler)
                this.inputHandler.clear();
        }

    }
    ksUI$1.registerModule('ks-mfd-slider', MfdSlider);

    class MFDControls extends KsHTMLElement {

        /** @type MessageHandler */
        Client;
        /** @type HTMLDivElement */
        panelModes;
        btnSwitch = {};
        loading = true;

        constructor() {
            super();
            this.template = template$T;
            this.delayedInit = true;
        }

        get isolationMode() {
            return HUD.isolationMode;
        }

        set isolationMode(value) {
            HUD.isolationMode = value;
        }

        load() {
            this.loading = true;
            this.Client.request("Controls", (response) => {
                //console.trace(response);
                this.assignModel(response.input_settings, "Mfd");
                ksUI$1.waitForFrames(() => {
                    this.loading = false;
                }, 4);
            });
        }

        save() {

            this.Client.request("SaveControls",
                {
                    input_settings: Mfd
                },
                (response) => {
                    ({
                        [eCommandResponse.OK]: () => {
                            //this.loading = true;
                            ksUI$1.waitForFrames(() => {
                                //  this.loading = false;
                            }, 5);
                        },
                        [eCommandResponse.Failed]: () => {
                            console.error("MFD Controls Error!");
                        }
                    }[response.response])();
                });
        }

        getSwitchButtons() {
            const names = ["steering", "ffb", "gamepad"];
            const elements = qAll("ks-btnbasic[toggle-group=switch]");
            if (elements.length === names.length) {
                elements.forEach((elem, index) => {
                    const name = names[index];
                    this.btnSwitch[name] = elem;
                });
            }
        }

        switchPanelMode(mode) {
            q(".group-steering").style.display = mode == "steering" ? "block" : "none";
            q(".group-ffb").style.display = mode == "ffb" ? "block" : "none";
            q(".group-gamepad").style.display = mode == "gamepad" ? "block" : "none";
            console.trace(this.currentMode);
        }

        bindControls() {
            qAll("ks-btnbasic[toggle-group=switch]", this).forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        this.previousPanel = this.currentMode;
                        this.currentMode = sender.dataset.mode;
                        if (state) {
                            this.switchPanelMode(this.currentMode);
                        }
                    };
                });

            qAll("ks-mfd-slider", this).forEach(
                /** @param {MfdSlider} */
                slider => {
                    slider.onChanged = (new_value) => {
                        const bindtarget = slider.dataset.bindKsvalue.split(".");

                        if (window["Mfd"]) {
                            Mfd[bindtarget[1]][bindtarget[2]] = new_value;
                        }

                        //console.trace(`${bindtarget.join(".")} ${new_value}`);

                        this.save();
                    };
                });

        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.Client = HUD.MfdClient;
            this.getSwitchButtons();
            this.mapElementById("panelModes");
            this.load();
            q(".group-steering").style.display = "block";
        }

        init() {
            super.init();
        }

    }
    ksUI$1.registerModule('ks-mfd-controls', MFDControls);

    var template$R = "<div class=\"mfd-car-body component-body\">\r\n    <div id=\"btnGroupModes\" class=\"is-flex-row\">\r\n        <ks-btnbasic id=\"btnElectronics\" data-sn-up=\"#sliderSteeringTrueForce\" data-sn-left=\"#btnGamepad\" class=\"focusable selected\" data-mode=\"electronics\" toggle-group=\"switch\" toggle toggle-on-focus>\r\n            <div slot=\"name\" data-l10n-id=\"lblMfdElectronics\">Electronics</div>\r\n        </ks-btnbasic>\r\n        <ks-btnbasic id=\"btnInstrumentation\" data-sn-up=\"#sliderFfbAbsEffects\" class=\"focusable\" data-mode=\"instrumentation\" toggle-group=\"switch\" data-name=\"instrumentation\" toggle toggle-on-focus>\r\n            <div slot=\"name\" data-l10n-id=\"lblMfdElectrics\">Electrics</div>\r\n        </ks-btnbasic>\r\n        <!-- <ks-btnbasic\r\n            id=\"btnGamepad\"\r\n            data-sn-up=\"#sliderGamepadRumbleEffects\"\r\n            data-sn-right=\"#btnSteering\"\r\n            class=\"focusable\"\r\n            data-mode=\"gamepad\"\r\n            toggle-group=\"switch\" data-name=\"gamepad\" toggle toggle-on-focus>\r\n            <div slot=\"name\" data-l10n-id=\"lblMFDControlsGamepad\">Gamepad</div>\r\n        </ks-btnbasic> -->\r\n    </div>\r\n\r\n    <div id=\"panelModes\">\r\n        <div class=\"electronics\" data-mode=\"electronics\">\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"brake_bias\" label=\"lblBrakeBiasUpper\" text=\"BRAKE BIAS\" step=\"0.002\" precision=\"3\" percentagedecimals=\"1\" suffix=\"%\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"active_performance_mode\" displayvalueoffset=\"1\" label=\"lblPerformanceMode\" text=\"PERFORMANCE MODE\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"turbo_level\" label=\"lblTurboBoostUpper\" text=\"TURBO BOOST\" step=\"0.1\" precision=\"1\" percentagedecimals=\"0\" suffix=\"%\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider data-mode=\"abs_level\" label=\"lblABSUpper\" text=\"ABS\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider data-mode=\"tc_level\" data-bind-ksvalue=\"\" label=\"lblTCUpper\" text=\"TC\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider data-mode=\"tc_cut_level\" label=\"lblTCCUTUpper\" text=\"TC CUT\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider data-mode=\"esc_level\" label=\"lblESCUpper\" text=\"ESC\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"ebb_level\" displayvalueoffset=\"1\" label=\"lblEBBUpper\" text=\"EBB\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"engine_map_level\" displayvalueoffset=\"1\" label=\"lblEngineMapUpper\" text=\"ENGINE MAP\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"ers_deployment_map\" label=\"lblErsDeployUpper\" text=\"ERS DEPLOY\" displayvalueoffset=\"1\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider data-mode=\"ers_recharge_map\" label=\"lblErsRechargeUpper\" text=\"ERS RECHARGE\" step=\"0.05\" precision=\"3\" percentagedecimals=\"0\" suffix=\"%\" percentage>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider data-mode=\"is_ers_heat_charging_on\" label=\"lblMGUHUpper\" text=\"MGU-H\" displayvalues=\"mguh_Deploy,mguh_Charge\" boolean>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"diff_coast_level\" displayvalueoffset=\"1\" label=\"lblDiffCoastUpper\" text=\"DIFF COAST\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"diff_power_level\" displayvalueoffset=\"1\" label=\"lblDiffPowerUpper\" text=\"DIFF POWER\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"front_bump_damper_level\" displayvalueoffset=\"1\" label=\"lblFrontBumpUpper\" text=\"FRONT BUMP\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"front_rebound_damper_level\" displayvalueoffset=\"1\" label=\"lblFrontReboundUpper\" text=\"FRONT REBOUND\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"rear_bump_damper_level\" displayvalueoffset=\"1\" label=\"lblRearBumpUpper\" text=\"REAR BUMP\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"rear_rebound_damper_level\" displayvalueoffset=\"1\" label=\"lblRearReboundUpper\" text=\"REAR REBOUND\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n        </div>\r\n        <div class=\"instrumentation\" data-mode=\"instrumentation\">\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"is_pitlimiter_on\" label=\"lblPitLimiterUpper\" text=\"PIT LIMITER\" displayvalues=\"lblOffUpper,lblOnUpper\" boolean>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"main_light_stage\" label=\"lblMainLightsUpper\" text=\"MAIN LIGHTS\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"special_light_stage\" label=\"lblSpecialLightsUpper\" text=\"SPECIAL LIGHTS\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"cockpit_light_stage\" label=\"lblCockpitLightsUpper\" text=\"COCKPIT LIGHTS\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"wiper_level\" label=\"lblWipersUpper\" text=\"WIPERS\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"rain_lights\" label=\"lblRainLightUpper\" text=\"RAIN LIGHT\" displayvalues=\"lblOffUpper,lblOnUpper\" boolean>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"direction_light_left\" label=\"lblLeftIndicatorUpper\" text=\"LEFT INDICATOR\" displayvalues=\"lblOffUpper,lblOnUpper\" boolean>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"direction_light_right\" label=\"lblRightIndicatorUpper\" text=\"RIGHT INDICATOR\" displayvalues=\"lblOffUpper,lblOnUpper\" boolean>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"flashing_lights\" displayvalues=\"lblOffUpper,lblOnUpper\" label=\"lblFlashingLightsUpper\" text=\"FLASHING LIGHTS\" boolean>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"warning_lights\" displayvalues=\"lblOffUpper,lblOnUpper\" label=\"lblHazardLightsUpper\" text=\"HAZARD LIGHTS\" boolean>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"selected_display_index\" label=\"lblDisplayUpper\" text=\"DISPLAY\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"current_page_index\" label=\"lblDisplayPageUpper\" text=\"DISPLAY PAGE\" showmax>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"is_ignition_on\" label=\"lblIgnitionUpper\" text=\"IGNITION\" displayvalues=\"lblOffUpper,lblOnUpper\" boolean>\r\n            </ks-mfd-slider>\r\n\r\n            <ks-mfd-btn data-mode=\"starter\" text=\"STARTER\">\r\n            </ks-mfd-btn>\r\n\r\n\r\n        </div>\r\n        <div class=\"displays\">\r\n        </div>\r\n    </div>\r\n\r\n\r\n</div>";

    var template$Q = "<div class=\"mfdbtn-body component-body\">\r\n    <div class=\"label\"></div>\r\n</div>";

    class MfdBtn extends KsHTMLElement {

        /** @type {HTMLDivElement} */
        labelBtn;

        inputHandler;

        constructor() {
            super();
            this.template = template$Q;
            this.delayedInit = true;

            this._value = false;
            this._label = '';
        }

        set label(text) {
            this._label = text ?? '';
            this.updateDisplayValue();
        }

        set value(new_value) {
            const next = !!new_value;
            if (next === this._value) return;
            this._value = next;
            this.updateDisplayValue();
        }

        get value() {
            return this._value;
        }

        onBindingUpdate(binding_param, new_value) {
            if (binding_param === this.dataset.mode) {
                this.setValue(Boolean(new_value));
            }
        }

        bindControls() {
            this.onfocus = () => {
                this.focused = true;
                this.classList.remove("last-focused");
                clearTimeout(this.blurTimer);
                this.blurTimer = setTimeout(() => { this.blur(); }, 3000);
            };

            this.onblur = () => {
                this.classList.add("last-focused");
                clearTimeout(this.blurTimer);
                this.focused = false;
            };

            this.addEventListener("mousedown", () => {
                this.toggle();
            });

            this.setupInputHandler();
        }

        setupInputHandler() {
            this.inputHandler = engine.on('UIExInputsAction', (e) => {

                if (e.action == "InputAction_UI_Up" || e.action == "InputAction_UI_Down") {
                    this.classList.remove("last-focused");
                }

                if (!this.focused) return;

                if (e.action === 'InputAction_UI_Left' || e.action === 'InputAction_UI_Right' || e.action === 'InputAction_UI_Confirm') {
                    this.toggle();
                }
            });
        }

        connectedCallback() {
            super.connectedCallback();
            if (this.templateLoaded) {
                this.setupInputHandler();
            }
        }

        onTemplateLoaded() {
            this.templateLoaded = true;

            this.classList.add('focusable');
            //this.setAttribute('role', 'button');
            //this.setAttribute('tabindex', '0');
            this.labelBtn = this.querySelector('.label');

            const text = this.getAttribute('text');
            if (text != null) this._label = text;

            this.updateDisplayValue();
        }

        toggle() {
            this.value = !this._value;
            this.dispatchEvent(new CustomEvent('toggle', {
                bubbles: true,
                detail: { value: this._value }
            }));
        }

        setVisualToggle() {
            this._value = !this._value;
            this.updateDisplayValue();
        }

        setEnabled(enabled) {
            this.classList.toggle('disabled', !enabled);
        }

        updateDisplayValue() {
            if (this.labelBtn) this.labelBtn.textContent = engine.translate(this._label);
            this.classList.toggle('is-on', this._value);
        }

        onRemovedFromDOM() {
            if (this.inputHandler) this.inputHandler.clear();
        }

    }

    ksUI$1.registerModule('ks-mfd-btn', MfdBtn);

    class MFDCar extends KsHTMLElement {

        CarElectronicsValues = {
            __Type: "CarElectronicsValues",
            abs_level: 0,
            tc_level: 0,
            tc_cut_level: 0,
            esc_level: 0,
            brake_bias: 0,
            engine_map_level: 0,
            is_ignition_on: false,
            is_pitlimiter_on: false,
            active_performance_mode: 0
        }

        CarInstrumentationValues = {
            __Type: "CarInstrumentationValues",
            main_light_stage: 0,
            special_light_stage: 0,
            cockpit_light_stage: 0,
            wiper_level: 0,
            rain_lights: false,
            direction_light_left: false,
            direction_light_right: false,
            flashing_lights: false,
            warning_lights: false,
            selected_display_index: 0
        };

        hudVisibilityHandler;

        /** @type MessageHandler */
        Client;
        /** @type HTMLDivElement */
        panelModes;
        loading = true;

        setting = false;

        sliders = {};

        constructor() {
            super();
            this.template = template$R;
            this.delayedInit = true;
        }

        filters = {
            mfd_car_values: (carstate) => {
                if(this.isInFragment) return;
                this.setValuesElectronics(carstate);
                this.setValuesInstrumentation(carstate);
            }
        }

        get isolationMode() {
            return HUD.isolationMode;
        }

        set isolationMode(value) {
            HUD.isolationMode = value;
        }

        load() {
        }

        save() {
            this.setting = true;

            this.Client.request("UpdateElectronics",
                {
                    electronics_values: this.CarElectronicsValues
                },
                data => {
                    waitForFrames(() => {
                        this.setting = false;
                    }, 1);
                });
        }

        callStarter() {
            this.setting = true;

            this.Client.request("UpdateStarter", (response) => {
                ksUI$1.waitForFrames(() => {
                    this.btnStarter.setVisualToggle();
                    this.setting = false;
                }, 5);
            });
        }

        saveInstrumentation() {
            this.setting = true;
            this.Client.request("UpdateInstrumentation",
                {
                    instrumentation_values: this.CarInstrumentationValues
                },
                data => {
                    waitForFrames(() => {
                        this.setting = false;
                    }, 1);
                });
        }

        switchPanelMode(mode) {
            //this.panelModes.dataset.mode = mode;
            q(".electronics", this).style.display = mode === "electronics" ? "block" : "none";
            q(".instrumentation", this).style.display = mode === "instrumentation" ? "block" : "none";
        }

        bindControls() {
            qAll("ks-btnbasic[toggle-group=switch]", this).forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        if (state) {
                            this.switchPanelMode(sender.dataset.mode);
                        }
                    };
                }
            );

            qAll("ks-mfd-btn", this).forEach(
                /** @param {MfdBtn} btn */
                btn => {
                    btn.addEventListener("toggle", (e) => {
                        if (this.retrieving) return;

                        if (btn.dataset.mode === "starter") {
                            this.callStarter();
                        }
                    });
                }
            );

            qAll("ks-mfd-slider", this).forEach(
                /** @param {MfdSlider} */
                slider => {
                    slider.onChanged = (new_value) => {
                        if (this.retrieving) return;

                        this.setting = true;
                        const key = slider.dataset.mode;
                        //console.trace(`${key} ${new_value}`);

                        if (key === "current_page_index") {
                            const display = this.CarInstrumentationValues.display_indexes ?? [];
                            const selected = display.length ? Math.min(Math.max(Number(this.CarInstrumentationValues.selected_display_index ?? 0), 0), display.length - 1) : 0;

                            this.CarInstrumentationValues.display_indexes[selected].current_page_index = slider.boolean ? Boolean(new_value) : new_value;

                            this.saveInstrumentation();
                            return;
                        }

                        if (key in this.CarElectronicsValues) {
                            this.CarElectronicsValues[key] = slider.boolean ? Boolean(new_value) : new_value;
                            this.save();
                            return;
                        }

                        if (key in this.CarInstrumentationValues) {
                            this.CarInstrumentationValues[key] = slider.boolean ? Boolean(new_value) : new_value;
                            console.log(key, new_value);
                            this.saveInstrumentation();
                            return;
                        }

                    };
                }
            );

            engine.on(EngineEvents.InSession.FocusedCarChanged, (id, is_player_car) => {
                console.trace("ISPLAYER", is_player_car);
                waitForFrames(() => {
                    this.setupCapabilities();
                });
            });
        }

        capabilities = {};


        setupCapabilities() {
            const car = window["ModelCurrentCar"];
            const modifiable = car.low_frequency.electronics_is_modifiable;
            const min_limit = car.low_frequency.electronics_min_limit;
            const max_limit = car.low_frequency.electronics_max_limit;
            const classList = this.panelModes.classList;

            const instr_min_limit = car.low_frequency.instrumentation_min_limit;
            const instr_max_limit = car.low_frequency.instrumentation_max_limit;

            let haselectronics = this.capabilities.abs = classList.toggle("has-abs", modifiable.abs_level > 0);
            haselectronics = (this.capabilities.tc = classList.toggle("has-tc", modifiable.tc_level > 0)) || haselectronics;
            haselectronics = (this.capabilities.tcc = classList.toggle("has-tcc", modifiable.tc_cut_level > 0)) || haselectronics;
            haselectronics = (this.capabilities.esc = classList.toggle("has-esc", modifiable.esc_level > 0)) || haselectronics;
            haselectronics = (this.capabilities.map = classList.toggle("has-map", modifiable.engine_map_level > 0)) || haselectronics;
            haselectronics = (this.capabilities.perfmode = classList.toggle("has-perfmode", modifiable.active_performance_mode > 0)) || haselectronics;
            haselectronics = (this.capabilities.bb = classList.toggle("has-bb", modifiable.brake_bias > 0)) || haselectronics;
            haselectronics = (this.capabilities.turbo_level = classList.toggle("has-turbo-level", modifiable.turbo_level > 0)) || haselectronics;
            haselectronics = (this.capabilities.ers_deployment_map = classList.toggle("has-ers-deployment-map", modifiable.ers_deployment_map > 0)) || haselectronics;
            haselectronics = (this.capabilities.ers_recharge_map = classList.toggle("has-ers-recharge-map", modifiable.ers_recharge_map > 0)) || haselectronics;
            haselectronics = (this.capabilities.is_ers_heat_charging_on = classList.toggle("has-ers-mguh", modifiable.is_ers_heat_charging_on)) || haselectronics;


            haselectronics = (this.capabilities.diff_coast_level = classList.toggle("has-diff-coast", modifiable.diff_coast_level > 0)) || haselectronics;
            haselectronics = (this.capabilities.diff_power_level = classList.toggle("has-diff-power", modifiable.diff_power_level > 0)) || haselectronics;
            haselectronics = (this.capabilities.front_bump_damper_level = classList.toggle("has-front-bump-damper", modifiable.front_bump_damper_level > 0)) || haselectronics;
            haselectronics = (this.capabilities.front_rebound_damper_level = classList.toggle("has-front-rebound-damper", modifiable.front_rebound_damper_level > 0)) || haselectronics;
            haselectronics = (this.capabilities.rear_bump_damper_level = classList.toggle("has-rear-bump-damper", modifiable.rear_bump_damper_level > 0)) || haselectronics;
            haselectronics = (this.capabilities.rear_rebound_damper_level = classList.toggle("has-rear-rebound-damper", modifiable.rear_rebound_damper_level > 0)) || haselectronics;

            haselectronics = (this.capabilities.ebb_level = classList.toggle("has-ebb", modifiable.ebb_level > 0)) || haselectronics;

            haselectronics = (this.capabilities.is_ignition_on = classList.toggle("has-ignition", modifiable?.is_ignition_on !== undefined)) || haselectronics;
            haselectronics = (this.capabilities.is_pitlimiter_on = classList.toggle("has-pit-limiter", modifiable.is_pitlimiter_on !== undefined)) || haselectronics;

            if (car.low_frequency.engine_type == "electric_motor") {
                this.btnStarter.style.display = "none";
            }

            const instr = car.low_frequency.instrumentation;
            let hasinstrumentation = false;

            hasinstrumentation = (this.capabilities.main_light_stage = classList.toggle("has-main-light", instr?.main_light_stage !== undefined)) || hasinstrumentation;
            hasinstrumentation = (this.capabilities.special_light_stage = classList.toggle("has-special-light", instr?.special_light_stage !== undefined)) || hasinstrumentation;
            hasinstrumentation = (this.capabilities.cockpit_light_stage = classList.toggle("has-cockpit-light", instr?.cockpit_light_stage !== undefined)) || hasinstrumentation;
            hasinstrumentation = (this.capabilities.wiper_level = classList.toggle("has-wipers", instr?.wiper_level !== undefined)) || hasinstrumentation;
            hasinstrumentation = (this.capabilities.rain_lights = classList.toggle("has-rain-lights", instr?.rain_lights !== undefined)) || hasinstrumentation;
            hasinstrumentation = (this.capabilities.direction_light_left = classList.toggle("has-dir-left", instr?.direction_light_left !== undefined)) || hasinstrumentation;
            hasinstrumentation = (this.capabilities.direction_light_right = classList.toggle("has-dir-right", instr?.direction_light_right !== undefined)) || hasinstrumentation;
            hasinstrumentation = (this.capabilities.flashing_lights = classList.toggle("has-flashing", instr?.flashing_lights !== undefined)) || hasinstrumentation;
            hasinstrumentation = (this.capabilities.warning_lights = classList.toggle("has-warning", instr?.warning_lights !== undefined)) || hasinstrumentation;
            hasinstrumentation = (this.capabilities.selected_display_index = classList.toggle("has-display-index", instr?.selected_display_index !== undefined)) || hasinstrumentation;
            hasinstrumentation = (this.capabilities.current_page_index = classList.toggle("has-current-page-index", instr?.display_indexes !== undefined)) || hasinstrumentation;

            this.classList.toggle("has-instrumentation", hasinstrumentation);
            this.classList.toggle("has-electronics", haselectronics);

            Object.keys(min_limit).forEach(key => {
                if (this.sliders[key])
                    this.sliders[key].min = (key === "is_ignition_on" || key === "is_pitlimiter_on") ? 0 : min_limit[key];
            });

            Object.keys(max_limit).forEach(key => {
                if (this.sliders[key])
                    this.sliders[key].max = (key === "is_ignition_on" || key === "is_pitlimiter_on") ? 1 : max_limit[key];
            });

            Object.keys(instr_min_limit).forEach(key => {
                if (key === "display_indexes") return;
                if (this.sliders[key])
                    this.sliders[key].min = instr_min_limit[key];
            });

            Object.keys(instr_max_limit).forEach(key => {
                if (key === "display_indexes") return;

                if (this.sliders[key]) {
                    this.sliders[key].max = instr_max_limit[key];
                }
                if (this.sliders[key] && (instr_max_limit[key] === -1 || instr_max_limit[key] === 0)) {
                    this.sliders[key].style.display = "none";
                    this.capabilities[key] = false;
                }
            });

            const displaySlider = this.sliders.selected_display_index;
            const pageSlider = this.sliders.current_page_index;

            const display = instr?.display_indexes ?? [];
            const selectedDisplay = Math.max(0, Math.min(Number(instr?.selected_display_index ?? 0), Math.max(0, display.length - 1)));

            displaySlider.style.display = display.length > 1 ? "" : "none";
            displaySlider.min = 0;
            displaySlider.max = Math.max(0, display.length - 1);
            displaySlider.value = selectedDisplay;


            const min = Number(instr_min_limit?.display_indexes?.[selectedDisplay]?.current_page_index ?? 0);
            const max = Number(instr_max_limit?.display_indexes?.[selectedDisplay]?.current_page_index ?? min);

            pageSlider.style.display = max > min ? "" : "none";

            const value = Math.max(min, Math.min(Number(display[selectedDisplay]?.current_page_index ?? min), max));

            pageSlider.min = min;
            pageSlider.max = max;
            pageSlider.value = value;

            if (car.is_player_car) {
                this.removeAttribute("disabled");
            } else {
                this.setAttribute("disabled", true);
                document.body.focus();
            }
        }

        retrieving = false;

        setValuesElectronics(carstate) {

            if (this.setting) return;

            this.retrieving = true;

            const electronics = carstate.low_frequency.electronics;

            this.CarElectronicsValues = electronics;

            if (this.capabilities.bb)
                this.sliders.brake_bias.value = electronics.brake_bias;

            if (this.capabilities.abs)
                this.sliders.abs_level.value = electronics.abs_level;

            if (this.capabilities.tc)
                this.sliders.tc_level.value = electronics.tc_level;

            if (this.capabilities.tcc)
                this.sliders.tc_cut_level.value = electronics.tc_cut_level;

            if (this.capabilities.esc)
                this.sliders.esc_level.value = electronics.esc_level;

            if (this.capabilities.map)
                this.sliders.engine_map_level.value = electronics.engine_map_level;

            if (this.capabilities.turbo_level)
                this.sliders.turbo_level.value = electronics.turbo_level;

            if (this.capabilities.perfmode)
                this.sliders.active_performance_mode.value = electronics.active_performance_mode;

            if (this.capabilities.ers_deployment_map)
                this.sliders.ers_deployment_map.value = electronics.ers_deployment_map;

            if (this.capabilities.ers_recharge_map)
                this.sliders.ers_recharge_map.value = electronics.ers_recharge_map;

            if (this.capabilities.is_ers_heat_charging_on)
                this.sliders.is_ers_heat_charging_on.value = electronics.is_ers_heat_charging_on;

            if (this.capabilities.diff_coast_level)
                this.sliders.diff_coast_level.value = electronics.diff_coast_level;

            if (this.capabilities.diff_power_level)
                this.sliders.diff_power_level.value = electronics.diff_power_level;

            if (this.capabilities.front_bump_damper_level)
                this.sliders.front_bump_damper_level.value = electronics.front_bump_damper_level;

            if (this.capabilities.front_rebound_damper_level)
                this.sliders.front_rebound_damper_level.value = electronics.front_rebound_damper_level;

            if (this.capabilities.rear_bump_damper_level)
                this.sliders.rear_bump_damper_level.value = electronics.rear_bump_damper_level;

            if (this.capabilities.rear_rebound_damper_level)
                this.sliders.rear_rebound_damper_level.value = electronics.rear_rebound_damper_level;

            if (this.capabilities.ebb_level)
                this.sliders.ebb_level.value = electronics.ebb_level;

            if (this.capabilities.is_ignition_on)
                this.sliders.is_ignition_on.value = electronics.is_ignition_on;

            if (this.capabilities.is_pitlimiter_on)
                this.sliders.is_pitlimiter_on.value = electronics.is_pitlimiter_on;

            this.retrieving = false;
        }

        setValuesInstrumentation(carstate) {
            if (this.setting) return;

            this.retrieving = true;

            const instr = carstate.low_frequency.instrumentation;

            this.CarInstrumentationValues = instr;

            if (this.capabilities.main_light_stage)
                this.sliders.main_light_stage.value = instr.main_light_stage;

            if (this.capabilities.special_light_stage)
                this.sliders.special_light_stage.value = instr.special_light_stage;

            if (this.capabilities.cockpit_light_stage)
                this.sliders.cockpit_light_stage.value = instr.cockpit_light_stage;

            if (this.capabilities.wiper_level)
                this.sliders.wiper_level.value = instr.wiper_level;

            if (this.capabilities.rain_lights)
                this.sliders.rain_lights.value = instr.rain_lights;

            if (this.capabilities.direction_light_left)
                this.sliders.direction_light_left.value = instr.direction_light_left;

            if (this.capabilities.direction_light_right)
                this.sliders.direction_light_right.value = instr.direction_light_right;

            if (this.capabilities.flashing_lights)
                this.sliders.flashing_lights.value = instr.flashing_lights;

            if (this.capabilities.warning_lights)
                this.sliders.warning_lights.value = instr.warning_lights;

            if (this.capabilities.selected_display_index)
                this.sliders.selected_display_index.value = instr.selected_display_index;

            if (this.capabilities.current_page_index) {
                const display = instr?.display_indexes ?? [];
                const selected = display.length ? Math.min(Math.max(Number(instr?.selected_display_index ?? 0), 0), display.length - 1) : 0;

                const value = display[selected]?.current_page_index ?? 0;
                this.sliders.current_page_index.value = value;
                this.sliders.current_page_index.setAttribute("value", String(value));
            }

            this.retrieving = false;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.Client = HUD.MfdClient;
            this.mapElementById("panelModes");
            this.load();

            this.btnStarter = q('ks-mfd-btn[data-mode="starter"]', this);
            // $.qAll(".electronics ks-mfd-slider", this).forEach(slider => {
            //     const property = slider.dataset.mode;
            //     this.sliders[property] = slider;
            // });

            qAll(".electronics ks-mfd-slider, .instrumentation ks-mfd-slider", this)
                .forEach(slider => {
                    const property = slider.dataset.mode;
                    this.sliders[property] = slider;
                });

            this.setupCapabilities();

            this.setAttribute("data-bind-process", "mfd_car_values({{ModelCurrentCar}})");


            this.hudVisibilityHandler = engine.on(EngineEvents.InSession.HudVisibility, (visible) => {
                HUD.isolationMode = visible;
            });

            this.switchPanelMode("electronics");
            const car = window["ModelCurrentCar"];
            console.log(car.low_frequency);

        }

        init() {
            super.init();
        }

        onRemovedFromDOM() {
            if (this.hudVisibilityHandler)
                this.hudVisibilityHandler.clear();
        }

    }
    ksUI$1.registerModule('ks-mfd-car', MFDCar);

    var template$P = "<div class=\"mfd-pitstop-body component-body\" data-bind-class-toggle=\"disabled:{{ModelCurrentCar}}.pit_info.time_in_pits > 0 || !{{ModelCurrentCar}}.is_player_car\" data-bind->\r\n\r\n    <div class=\"time-estimate\">\r\n        <div class=\"label\"><span></span>PIT STOP DURATION</div>\r\n        <div class=\"time-value\" data-bind-value=\"ksUI.formatTimeExt({{PitControls}}.pit_stop_values.predicted_pit_time * 1000,2,false,false)\">0:00</div>\r\n    </div>\r\n\r\n    <div class=\"tyre-change-estimate time-value\" data-bind-if=\"{{PitControls}}.tyre_change_time > 0\" data-bind-value=\"ksUI.formatTimeExt({{PitControls}}.tyre_change_time * 1000,2,false,false)\">\r\n    </div>\r\n\r\n    <ks-mfd-slider id=\"sliderPitLimiter\" class=\"no-min-highlight\" data-mode=\"is_pitlimiter_on\" label=\"lblPitLimiterUpper\" displayvalues=\"lblOffUpper,lblOnUpper\" boolean>\r\n    </ks-mfd-slider>\r\n\r\n    <ks-mfd-slider class=\"\" data-mode=\"change_front_tyres\" label=\"lblFrontTyresUpper\" data-sn-up=\"\" displayvalues=\"lblKeepUpper,lblChangeUpper\" boolean>\r\n    </ks-mfd-slider>\r\n\r\n    <ks-mfd-slider class=\"no-min-highlight indent-2 front_tyres shrink-value\" data-mode=\"front_tyre_compound\" data-type=\"compound\" label=\"lblCompoundUpper\" text=\"COMPOUND\" unlocalized>\r\n    </ks-mfd-slider>\r\n\r\n    <ks-mfd-slider class=\"no-min-highlight indent-3 front_tyres\" data-mode=\"tyre_pressure_fl\" data-pressure-index=\"0\" label=\"lblLeftUpper\" step=\"0.1\" precision=\"1\" suffix=\"PSI\">\r\n    </ks-mfd-slider>\r\n\r\n    <ks-mfd-slider class=\"no-min-highlight indent-3 front_tyres\" data-mode=\"tyre_pressure_fr\" data-pressure-index=\"1\" label=\"lblRightUpper\" step=\"0.1\" precision=\"1\" suffix=\"PSI\">\r\n    </ks-mfd-slider>\r\n\r\n    <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"change_rear_tyres\" label=\"lblRearTyresUpper\" displayvalues=\"lblKeepUpper,lblChangeUpper\" boolean>\r\n    </ks-mfd-slider>\r\n\r\n    <ks-mfd-slider class=\"no-min-highlight indent-2 rear_tyres shrink-value\" data-mode=\"rear_tyre_compound\" data-type=\"compound\" label=\"lblCompoundUpper\" unlocalized>\r\n    </ks-mfd-slider>\r\n\r\n    <ks-mfd-slider class=\"no-min-highlight indent-3 rear_tyres\" data-mode=\"tyre_pressure_rl\" data-pressure-index=\"2\" label=\"lblLeftUpper\" step=\"0.1\" precision=\"1\" suffix=\"PSI\">\r\n    </ks-mfd-slider>\r\n\r\n    <ks-mfd-slider class=\"no-min-highlight indent-3 rear_tyres\" data-mode=\"tyre_pressure_rr\" data-pressure-index=\"3\" label=\"lblRightUpper\" step=\"0.1\" precision=\"1\" suffix=\"PSI\">\r\n    </ks-mfd-slider>\r\n\r\n    <div class=\"with-estimate\">\r\n        <ks-mfd-slider class=\"yellow\" data-mode=\"fuel_to_add\" label=\"lblFuelToAddUpper\" step=\"0.1\" precision=\"1\" suffix=\"L\">\r\n        </ks-mfd-slider>\r\n        <div class=\"fuel-total\" data-bind-value=\"mfd_pitstop_currentfuel({{PitControls}})\"></div>\r\n        <div class=\"time-value\" data-bind-if=\"{{PitControls}}.refuel_time > 0\" data-bind-value=\"ksUI.formatTimeExt({{PitControls}}.refuel_time * 1000,2,false,false)\">0:30</div>\r\n    </div>\r\n\r\n    <div class=\"with-estimate hideable repair_body\">\r\n        <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"repair_body\" label=\"lblRepairBodyUpper\" displayvalues=\"lblNoUpper,lblYesUpper\" boolean>\r\n        </ks-mfd-slider>\r\n        <div class=\"time-value\" data-bind-if=\"{{PitControls}}.repair_body_time > 0\" data-bind-value=\"ksUI.formatTimeExt({{PitControls}}.repair_body_time * 1000,2,false,false)\">0:30</div>\r\n    </div>\r\n\r\n    <div class=\"with-estimate hideable repair_suspensions\">\r\n        <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"repair_suspensions\" label=\"lblRepairSuspensionUpper\" displayvalues=\"lblNoUpper,lblYesUpper\" boolean>\r\n        </ks-mfd-slider>\r\n        <div class=\"time-value\" data-bind-if=\"{{PitControls}}.repair_suspension_time > 0\" data-bind-value=\"ksUI.formatTimeExt({{PitControls}}.repair_suspension_time * 1000,2,false,false)\">0:30</div>\r\n    </div>\r\n\r\n    <div class=\"with-estimate hideable repair_engine\">\r\n        <ks-mfd-slider class=\"no-min-highlight\" data-mode=\"repair_engine\" label=\"lblRepairEngineUpper\" displayvalues=\"lblNoUpper,lblYesUpper\" boolean>\r\n        </ks-mfd-slider>\r\n        <div class=\"time-value\" data-bind-if=\"{{PitControls}}.repair_engine_time > 0\" data-bind-value=\"ksUI.formatTimeExt({{PitControls}}.repair_engine_time * 1000,2,false,false)\">0:30</div>\r\n    </div>\r\n\r\n    <div class=\"with-estimate hideable serve_stop_and_go_penalty\">\r\n        <ks-mfd-slider class=\"no-min-highlight indent-2\" data-mode=\"serve_stop_and_go_penalty\" label=\"lblServePenaltyUpper\" displayvalues=\"lblNoUpper,lblYesUpper\" boolean>\r\n        </ks-mfd-slider>\r\n        <div class=\"time-value\" data-bind-if=\"{{PitControls}}.stop_and_go_time > 0\" data-bind-value=\"ksUI.formatTimeExt({{PitControls}}.stop_and_go_time * 1000,2,false,false)\">0:30</div>\r\n    </div>\r\n\r\n\r\n</div>";

    class MFDPitstop extends KsHTMLElement {

        CarPitStopValues = {
            "__Type": "CarPitStopValues",
            "change_front_tyres": false,
            "change_rear_tyres": false,
            "front_tyre_compound": 0,
            "rear_tyre_compound": 0,
            "front_compounds": ["Slick (S)", "Wet (W)"],
            "rear_compounds": ["Slick (S)", "Wet (W)"],
            "tyre_pressure": [24, 24, 23.5, 23.5],
            "fuel_to_add": 0,
            "repair_body": false,
            "repair_suspensions": false,
            "repair_engine": false,
            "serve_stop_and_go_penalty": false,
            "predicted_pit_time": 0
        };

        sliders = {};

        isElectric = false;

        timers = {
            predicted_pit_time: 0,
            tyre_change_time: 0,
            refuel_time: 0,
            repair_body_time: 0,
            repair_engine_time: 0,
            repair_suspension_time: 0,
            stop_and_go_time: 0,
        };

        pollingTimer;

        hudVisibilityHandler;

        /** @type {MessageHandler} */
        Client;

        saving = false;
        updating = false;

        /** @type {MfdSlider} */
        sliderPitLimiter;

        constructor() {
            super();
            this.template = template$P;
            this.delayedInit = true;
        }

        get isolationMode() {
            return HUD.isolationMode;
        }

        set isolationMode(value) {
            HUD.isolationMode = value;
        }


        filters = {
            mfd_pitstop: (carstate) => {
                if (this.isInFragment) return;
                if (this.saving) return;
                this.sliderPitLimiter.value = carstate.low_frequency.electronics.is_pitlimiter_on;
            },
            mfd_pitstop_currentfuel: () => {

                if (this.isElectric) {
                    return ksUI$1.clamp(PitControls.pit_stop_values.fuel_to_add + ModelCurrentCar.fuel_liter_current_quantity_percent * 100, 0, 100).toFixed(1);
                } else {
                    return ksUI$1.clamp(PitControls.pit_stop_values.fuel_to_add + ModelCurrentCar.fuel_liter_current_quantity, 0, PitControls.pit_stop_values_max_limit.fuel_to_add).toFixed(1)
                }

            }
        }

        bindControls() {
            Object.keys(this.sliders).forEach(

                key => {
                    /** @type {MfdSlider} */
                    const slider = this.sliders[key];
                    slider.onChanged = (new_value) => {

                        if (slider.boolean) {
                            new_value = Boolean(new_value);
                        }

                        if (slider.dataset.pressureIndex) {
                            const index = Number(slider.dataset.pressureIndex);
                            this.CarPitStopValues.tyre_pressure[index] = Number(new_value);
                        } else {
                            if (key == "front_tyre_compound") {
                                this.CarPitStopValues[key] = slider.index;
                                if (this.rules.use_single_compound) {
                                    this.sliders.rear_tyre_compound.setValueByIndex(slider.index);
                                    this.CarPitStopValues.rear_tyre_compound = slider.index;
                                }
                            } else if (key == "rear_tyre_compound") {
                                this.CarPitStopValues[key] = slider.index;
                                if (this.rules.use_single_compound) {
                                    this.sliders.front_tyre_compound.setValueByIndex(slider.index);
                                    this.CarPitStopValues.front_tyre_compound = slider.index;
                                }
                            } else {
                                this.CarPitStopValues[key] = new_value;
                            }
                        }
                        this.save();
                    };
                });

            this.sliderPitLimiter.onChanged = (new_value) => {
                this.saving = true;
                const snapshot = ModelCurrentCar.low_frequency.electronics;
                snapshot.is_pitlimiter_on = Boolean(new_value);

                this.Client.request("UpdateElectronics",
                    {
                        electronics_values: snapshot
                    },
                    data => {
                        waitForFrames(() => {
                            this.saving = false;
                        }, 1);
                    });

            };
        }

        sliderLimitsSet = false;

        rules = {
            change_front_tyres: false,
            change_rear_tyres: false,
            front_tyre_compound: false,
            rear_tyre_compound: false,
            repair_body: false,
            repair_engine: false,
            repair_suspensions: false,
            use_single_compound: false,
            tyre_pressure_fl: false,
            tyre_pressure_fr: false,
            tyre_pressure_rl: false,
            tyre_pressure_rr: false,
        };

        setupLimits(data) {
            const values = data.pit_stop_values;
            const modifiable = data.pit_stop_values_is_modifiable;
            const min = data.pit_stop_values_min_limit;
            const max = data.pit_stop_values_max_limit;

            this.rules.change_front_tyres = this.classList.toggle("has-change_front_tyres", modifiable.change_front_tyres);
            this.rules.change_rear_tyres = this.classList.toggle("has-change_rear_tyres", modifiable.change_rear_tyres);
            this.rules.front_tyre_compound = this.classList.toggle("has-front_tyre_compound", modifiable.front_tyre_compound == 1);
            this.rules.rear_tyre_compound = this.classList.toggle("has-rear_tyre_compound", modifiable.rear_tyre_compound == 1);

            this.rules.use_single_compound = data.use_single_compound;

            let last = this.classList.toggle("has-repair_body", modifiable.repair_body) ? "repair_body" : "fuel_to_add";
            last = this.classList.toggle("has-repair_engine", modifiable.repair_engine) ? "repair_engine" : last;
            last = this.classList.toggle("has-repair_suspensions", modifiable.repair_suspensions) ? "repair_suspensions" : last;
            last = this.classList.toggle("has-serve_stop_and_go_penalty", modifiable.serve_stop_and_go_penalty) ? "repair_suspensions" : last;

            this.sliderPitLimiter.dataset.snUp = `[data-mode='${last}']`;
            this.sliders[last].dataset.snDown = `[data-mode='is_pitlimiter_on']`;

            if (!this.sliderLimitsSet) {
                Object.keys(this.sliders).forEach(
                    key => {
                        /** @type {MfdSlider} */
                        const slider = this.sliders[key];

                        if (slider.dataset.pressureIndex) {
                            const index = Number(slider.dataset.pressureIndex);
                            slider.min = min.tyre_pressure[index];
                            slider.max = max.tyre_pressure[index];
                            // update tyre pressures
                        } else {
                            if (min[key] === undefined || slider.boolean) {
                                return;
                            }

                            if (key == "front_tyre_compound") {
                                slider.values = values.front_compounds.map(i => i.replace(/\(.*\)/, "").trim().toUpperCase());
                            }

                            if (key == "rear_tyre_compound") {
                                slider.values = values.rear_compounds.map(i => i.replace(/\(.*\)/, "").trim().toUpperCase());
                            }

                            slider.min = min[key];
                            slider.max = max[key];
                        }
                    });
                this.sliderLimitsSet = true;
            }
        }

        setValues(values) {
            this.CarPitStopValues = values;
            this.sliders.fuel_to_add.value = values.fuel_to_add;
            this.sliders.change_front_tyres.value = values.change_front_tyres;
            this.sliders.change_rear_tyres.value = values.change_rear_tyres;
            this.sliders.repair_body.value = values.repair_body;
            this.sliders.repair_engine.value = values.repair_engine;
            this.sliders.repair_suspensions.value = values.repair_suspensions;
            this.sliders.serve_stop_and_go_penalty.value = values.serve_stop_and_go_penalty;
            this.sliders.tyre_pressure_fl.value = values.tyre_pressure[0];
            this.sliders.tyre_pressure_fr.value = values.tyre_pressure[1];
            this.sliders.tyre_pressure_rl.value = values.tyre_pressure[2];
            this.sliders.tyre_pressure_rr.value = values.tyre_pressure[3];
            this.sliders.front_tyre_compound.setValueByIndex(values.front_tyre_compound);
            this.sliders.rear_tyre_compound.setValueByIndex(values.rear_tyre_compound);

        }

        setTimers(data) {
            this.timers.predicted_pit_time = data.pit_stop_values.predicted_pit_time;
            this.timers.tyre_change_time = data.tyre_change_time;
            this.timers.refuel_time = data.refuel_time;
            this.timers.repair_body_time = data.repair_body_time;
            this.timers.repair_engine_time = data.repair_engine_time;
            this.timers.repair_suspension_time = data.repair_suspension_time;
            this.timers.stop_and_go_time = data.stop_and_go_time;

            this.classList.toggle("time-repair_body", data.repair_body_time > 0);
            this.classList.toggle("time-repair_engine", data.repair_engine_time > 0);
            this.classList.toggle("time-repair_suspension", data.repair_suspension_time > 0);
            this.classList.toggle("time-stop_and_go_time", data.stop_and_go_time > 0);
            this.classList.toggle("time-tyre_change_time", data.tyre_change_time > 0);
        }

        update() {
            if (this.saving) return;
            this.updating = true;

            this.Client.request("PitControls", (data) => {
                this.assignModel(data, "PitControls");
                this.setTimers(data);
                this.setupLimits(data);
                this.setValues(data.pit_stop_values);
                this.updating = false;
            });
        }

        getTimers() {
            this.Client.request("PitControls", (data) => {
                this.assignModel(data, "PitControls");
                this.setupLimits(data);
                this.setTimers(data);
            });
        }

        save() {
            this.saving = true;
            this.Client.request("SetPitControls", { pit_stop_values: this.CarPitStopValues }, (data) => {
                this.saving = false;
            });
        }

        onRemovedFromDOM() {
            if (this.pollingTimer)
                clearInterval(this.pollingTimer);
        }

        onMoveToBodyFragment() {
            if (this.pollingTimer)
                clearInterval(this.pollingTimer);
        }

        onRestoreFromFragment() {
            this.setPollingTimer();
        }

        setPollingTimer() {
            if (this.pollingTimer)
                clearInterval(this.pollingTimer);
            this.pollingTimer = setInterval(() => { this.getTimers(); }, 500);
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.Client = HUD.MfdClient;

            this.mapElementById("sliderPitLimiter");

            this.setAttribute("data-bind-process", "mfd_pitstop({{ModelCurrentCar}})");

            this.hudVisibilityHandler = engine.on(EngineEvents.InSession.HudVisibility, (visible) => {
                HUD.isolationMode = visible;
            });

            qAll("ks-mfd-slider", this).forEach(slider => {
                if (slider != this.sliderPitLimiter)
                    this.sliders[slider.dataset.mode] = slider;
            });

            if (window["ModelCurrentCar"]) {
                if (ModelCurrentCar.low_frequency.engine_type == "electric_motor") {
                    this.isElectric = true;
                    this.sliders.fuel_to_add.setAttribute("label", "lblChargeToAdd");
                    this.sliders.fuel_to_add.setAttribute("suffix", "%");
                }
            }

            waitForFrames(() => {
                this.update();
            });

            this.setPollingTimer();
        }


    }
    ksUI$1.registerModule('ks-mfd-pitstop', MFDPitstop);

    class MFD extends KsHTMLHudElement {

        Client = new KsHTMLElement("Mfd");

        btnOfficial;
        btnRealtime;
        btnControls;
        label;

        mfd_controls;
        mfd_section_buttons;

        constructor() {
            super();
            this.template = template$U;
            this._isnavigable = true;
            this._bindFiltersToThis = true;

        }

        bindControls() {
            super.bindControls();

            engine.on(EngineEvents.UI.UIExInputsAction, (evt) => {
                if (evt.action == "InputAction_UI_Cycle_Mfd_Up") {
                    this.cycleMFDButton(1);
                } else if (evt.action == "InputAction_UI_Cycle_Mfd_Down") {
                    this.cycleMFDButton(-1);
                }
            });

            // engine.on(EngineEvents.InSession.PlayerCarFocus, (state) => {
            //     console.warn(this.tagName, "playerfocus", state);
            // });

            qAll(".mfd-buttons .btn").forEach((btn) => {
                btn.addEventListener("click", () => {
                    qAll(".mfd-buttons .btn").forEach(b => b.classList.remove("active"));
                    if (btn.classList.contains("disabled") || btn.dataset.disabled === "true") return;
                    btn.classList.add("active");

                    const mode = btn.dataset.name || btn.id.replace("btn", "");
                    const targetSelector = btn.dataset.target;
                    const targetElement = targetSelector ? q(targetSelector) : null;

                    this.label.textContent = engine.translate(`lbl${mode}`);
                    if (this.leaderboard && targetElement === this.leaderboard)
                        this.leaderboard.mode = mode;

                    this.enableSection(targetElement);

                });
            });
        }

        cycleMFDButton(direction) {

            if (!HUD.isVisible) return;

            const buttons = qAllArray(".mfd-buttons .btn", this);

            if (buttons.length === 0) return;

            const isDisabled = btn =>
                btn.classList.contains("disabled") || btn.dataset.disabled === "true";

            let activeIndex = buttons.findIndex(btn => btn.classList.contains("active"));
            let nextIndex = activeIndex;

            do {
                nextIndex = (nextIndex + direction + buttons.length) % buttons.length;
            } while (isDisabled(buttons[nextIndex]) && nextIndex !== activeIndex);

            if (isDisabled(buttons[nextIndex])) return;

            buttons.forEach(btn => btn.classList.remove("active"));

            const nextButton = buttons[nextIndex];
            nextButton.classList.add("active");

            const mode = nextButton.dataset.name || nextButton.id.replace("btn", "");
            const targetSelector = nextButton.dataset.target;
            const targetElement = targetSelector ? q(targetSelector) : null;

            this.label.textContent = engine.translate(`lbl${mode}`);

            if (this.leaderboard && targetElement === this.leaderboard)
                this.leaderboard.mode = mode;

            if (targetSelector)
                localStorage.setItem("mfd_lastselection", targetSelector);
            else
                localStorage.removeItem("mfd_lastselection");

            this.enableSection(targetElement);
        }

        enableSection(target_section) {
            if (!target_section) return;

            this.mfdSections.forEach(section => {
                if (section != target_section) {
                    if (section.isolationMode !== undefined)
                        section.isolationMode = false;
                    section.style.display = "none";
                    section.moveBodyToFragment();
                }
            });

            if (target_section.isolationMode !== undefined)
                target_section.isolationMode = true;
            else
                HUD.isolationMode = false;

            target_section.style.display = "flex";

            target_section.restoreBodyFromFragment();

            this.setupNavigation();

            waitForFrames(() => {
                q(".last-focused", this)?.focus();
            }, 3);
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mfdSections = Array.from(qAll(".mfd-content > *"));

            this.label = q(".mfd-label");
            this.leaderboard = q("#leaderboard");

            this.label.textContent = engine.translate(`lblRealtime`);
            this.leaderboard.mode = "Realtime";

            const lastselection = localStorage.getItem("mfd_lastselection");
            if (lastselection) {

                const buttons = qAllArray(".mfd-buttons .btn", this);
                buttons.forEach(b => b.classList.remove("active"));

                const btn = q(`.mfd-buttons .btn[data-target='${lastselection}']`, this);
                if (!btn.classList.contains("disabled")) {
                    btn.classList.add("active");
                    this.label.textContent = engine.translate(`lbl${btn.dataset.name}`);
                    this.enableSection(q(lastselection, this));
                }
            } else {
                this.enableSection(q("#leaderboard", this));
            }
        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();
        }

    }
    ksUI$1.registerModule('ks-mfd', MFD);

    var template$O = "<div class=\"chat\">\r\n    <div id=\"listMessages\">\r\n        <div class=\"header\">\r\n            <div class=\"name\" data-l10n-id=\"lblChatHeader\">Room Chat</div>\r\n        </div>\r\n        <div class=\"message\" data-bind-for=\"item:{{ModelUISessionState}}.low_frequency_state.chat_messages\" data-bind-class=\"{{item}}.message_type\">\r\n\r\n            <span data-bind-value=\"chat_getName({{item}})\">Lorem</span> \r\n            <div class=\"message-body\" data-bind-value=\"{{item}}.msg_text\">Cras ac consequat massa. Nulla lobortis vehicula dui id tempor. </div>\r\n        </div>\r\n        \r\n    </div>\r\n    <div class=\"row\" id=\"input\">\r\n        <input type=\"text\" id=\"inputMessage\" class=\"focusable\" placeholder=\"TEST\" maxlength=\"256\">\r\n        <div class=\"btnEnter\"></div>\r\n    </div>\r\n\r\n</div>";

    class HudChat extends KsHTMLHudElement {

        inputListenerBound;
        inputFocusListenerBound;

        /** @type {HTMLDivElement} */
        listMessages;

        /** @type {HTMLInputElement} */
        inputMessage;

        hideTimerDuration = 5000;

        hideTimer;

        /** @type {MessageHandler} */
        Client;

        /** @type {HTMLDivElement} */
        btnEnter;

        listenerMessage;

        constructor() {
            super();
            this.template = template$O;
            this._bindFiltersToThis = true;

        }

        filters = {
            chat_getName: (message) => {

                if (message.message_type == "UIPlayer") {
                    return `${ModelUIDriverState.driver_name} ${ModelUIDriverState.driver_surname}`;
                }
                
                return message.sender_name;
            }
        };

        sendMessage(message_text) {
            this.inputMessage.value = "";
            this.Client.requestNoResponse("SendChatMessage", { message: message_text, type: "UINormal" });
        }

        inputListener(e) {
            if (e.keyCode != "13" || !this.isHUDVisible) {
                return;
            }

            if (document.activeElement == this.inputMessage) {
                const message_to_send = this.inputMessage.value.trim();



                if (message_to_send.length > 1) {
                    this.sendMessage(message_to_send);
                }

                this.inputMessage.blur();
                ksUI$1.menuState.toggleKeyboardInput(false);

                clearTimeout(this.hideTimer);

                this.hideTimer = setTimeout(() => {
                    this.classList.remove("show");
                }, this.hideTimerDuration);

            } else {
                this.classList.add("show");
                this.listMessages.scrollTop = this.listMessages.scrollHeight;
                clearTimeout(this.hideTimer);
                waitForFrames(() => {
                    this.inputMessage.focus();
                    ksUI$1.menuState.toggleKeyboardInput(true);
                }, 3);
            }
        }

        bindControls() {
            super.bindControls();

            this.btnEnter.addEventListener("mousedown", () => {
                const message_to_send = this.inputMessage.value.trim();
                if (message_to_send.length > 1) {
                    this.sendMessage(message_to_send);
                }

            });

            if (this.isInHUD && this.settings.visible) {
                window.addEventListener("keydown", this.inputListenerBound);
                console.log(this.tagName, "chat binding enabled");

                this.inputMessage.addEventListener("blur", () => {
                    this.hideTimer = setTimeout(() => {
                        this.classList.remove("show");
                    }, this.hideTimerDuration);
                });

                //engine.trigger(EngineEvents.InSession.HudVisibility, this.StoredData.visibility);

                engine.on(EngineEvents.InSession.HudVisibility, (hud_visible) => {
                    if (!hud_visible) {
                        this.inputMessage.blur();
                    }
                });
            } else {
                this.inputMessage.addEventListener("keydown", (ev) => {
                    if (ev.keyCode == 13) {
                        const message_to_send = this.inputMessage.value.trim();

                        if (message_to_send.length > 1) {
                            this.sendMessage(message_to_send);
                        }
                    }
                });
            }
        }

        addMessage(message) {

            this.classList.add("show");

            // const msg_message = document.createElement("div");
            // msg_message.classList.add("message");
            // msg_message.classList.add(message.message_type);

            // const msg_sender = document.createElement("span");

            // if (message.message_type == eUIChatMessageType.Player && window["ModelUIDriverState"]) {
            //     message.sender_name = `${ModelUIDriverState.driver_name} ${ModelUIDriverState.driver_surname}`;
            // }

            // msg_sender.textContent = message.sender_name.trim();

            // msg_message.appendChild(msg_sender);

            // const msg_body = document.createElement("div");
            // msg_body.classList.add("message-body");
            // msg_body.textContent = message.msg_text;
            // msg_message.appendChild(msg_body);

            //this.listMessages.appendChild(msg_message);
            

            // if (this.listMessages.children.length >= 20) {
            //     this.listMessages.children[0].remove();
            // }

            this.listMessages.scrollTop = this.listMessages.scrollHeight;
            clearTimeout(this.hideTimer);

            this.hideTimer = setTimeout(() => {
                this.classList.remove("show");
            }, this.hideTimerDuration);
        }

        onRemovedFromDOM() {
            // remove chat message data model from update loop

            window.removeEventListener("keydown", this.inputListenerBound);
            if (this.listenerMessage)
                this.listenerMessage.clear();
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("listMessages");
            this.mapElementById("inputMessage");
            this.btnEnter = q('.btnEnter', this);

            if (this.isInHUD && !this.settings.visible) {
                this.remove();
            } else if (!this.isInHUD) {
                this.inputMessage.addEventListener("focus", () => {
                    this.classList.remove("show-placeholder");
                });

                this.inputMessage.addEventListener("blur", () => {
                    this.classList.toggle("show-placeholder", this.inputMessage.value == "");
                });

                const placeholder = document.createElement("div");
                placeholder.textContent = engine.translate("lblPlaceholderTypeHere");
                placeholder.classList.add("placeholder");

                q("#input", this).appendChild(placeholder);

                this.classList.add("show-placeholder");
            }

            this.inputMessage.onblur = () => {
                ksUI$1.menuState.toggleKeyboardInput(false);
            };

            this.inputListenerBound = this.inputListener.bind(this);

            this.Client = new MessageHandler("GameMode");

            this.listenerMessage = engine.on("UIChatMessage", (message) => {
                this.addMessage(message);
            });
        }

    }
    ksUI$1.registerModule('ks-hudchat', HudChat);

    const HUDInitTemplate = {
        visibility: true,
        lastLayout: "default",
        layouts: {
            default: {
                elements: {}
            }
        }
    };

    class Hud extends KsHTMLElement {

        currentLayout = "default";

        warningPitlimiter;

        _storedData = { ...HUDInitTemplate };

        getStoredData() {
            return this._storedData;
        }


        get StoredData() {
            return this._storedData;
        }

        set StoredData(new_data) {
            this._storedData = new_data;
        }

        /** @type MessageHandler */
        MfdClient;

        /** @type MessageHandler */
        GameModeClient;

        /** @type MessageHandler */
        Client;

        /** @type MessageHandler */
        SeasonInfoClient = new MessageHandler("SeasonInfo");


        targettedwidget;

        autoHideMouse = true;
        handleInputActions = true;
        mouseTimer;

        currentCarId;
        isPlayerCar;

        changePageHandler;

        get isVisible() {
            return !this.classList.contains("hide");
        }


        constructor() {
            super();
            this.template = template$1b;
            this.delayedInit = true;
            this._isnavigable = false;
            this._exposeAsActivePage = true;

        }

        filters = {
            evaluateContinueLabel: (uisessionstate) => {
                return (uisessionstate.end_session_flag & globalThis.InSessionFlags.CanSkip) > 0;
            },

            process: (uisessionstate) => {

            },

            monitor_car_change: (carstate) => {

                if (this.currentCarId && this.currentCarId != carstate.focused_car_id) {
                    console.trace(EngineEvents.InSession.FocusedCarChanged, carstate.focused_car_id, carstate.is_player_car);
                    engine.trigger(EngineEvents.InSession.FocusedCarChanged, carstate.focused_car_id, carstate.is_player_car);
                }

                if (this.isPlayerCar != carstate.is_player_car) {
                    console.trace(EngineEvents.InSession.PlayerCarFocus, carstate.is_player_car);
                    engine.trigger(EngineEvents.InSession.PlayerCarFocus, carstate.is_player_car);
                }

                this.currentCarId = carstate.focused_car_id;
                this.isPlayerCar = carstate.is_player_car;

                const pitentry = carstate.car_location == "Pitentry";
                const pitlane = carstate.car_location == "Pitlane";

                if ((pitlane || pitentry) && carstate.is_player_car) {

                    HUD.warningPitlimiter.classList.toggle("visible", !carstate.low_frequency.electronics.is_pitlimiter_on && !carstate.is_wrong_way);
                    HUD.warningPitlimiter.classList.toggle("shift-to-second", carstate.gear_int > 3);
                    HUD.warningPitlimiter.classList.toggle("slow-down", carstate.display_speed_kmh > 60);
                    HUD.warningPitlimiter.classList.toggle("moving", carstate.display_speed_kmh > 20);
                    HUD.warningPitlimiter.dataset.location = carstate.car_location;

                } else {
                    HUD.warningPitlimiter.classList.remove("visible");
                }

            },

            evaluatePitLimiterWarning: (carstate) => {

            }

        }

        get isolationMode() {
            return this.dataset.isolationmode == "true";
        }

        set isolationMode(value) {
            if (this.dataset.isolationmode != String(value)) {
                const is_active = value === true;
                this.MfdClient.request("ControlIsolation", { is_mfd_on_active: is_active }, (data) => {
                    console.log("MFD controls isolation mode", is_active);
                });
            }
            this.dataset.isolationmode = value;
        }

        saveLayoutData() {
            return new Promise((resolve, reject) => {
                console.log("Saving HUD layout data",);
                STORAGE.set(eStorageContainers.HUDLayout, this.StoredData);
                STORAGE.save(eStorageContainers.HUDLayout).then(() => resolve()).catch(() => reject());
            });
        }

        get currentLayoutData() {
            return this.StoredData.layouts[this.currentLayout];
        }

        elementModified(id, properties) {
            console.trace("HUD elementModified", id, properties);
            this.StoredData.layouts[this.currentLayout].elements[id] = properties;
        }

        loadSeasonAndSessionInfo() {
            GAMEMODESELECTION.getSeasonInfoParameters();
            GAMEMODESELECTION.getSessionInfoParameters();
        }

        onTemplateLoaded() {
            ksUI$1.Models.enable(DataModels.SessionState);
            super.onTemplateLoaded();

            window["HUD"] = this;

            this.mapElementById("warningPitlimiter");

            this.initStorageContainer(eStorageContainers.HUDLayout, this.StoredData, this._storedData);

            this.autoHideMouse = !this.hasAttribute("ignoremouse");
            this.handleInputActions = !this.hasAttribute("ignoreinputs");

            this.classList.toggle("hide", !this.StoredData.visibility);

            ksUI$1.menuState.ignoreInputActions(false);
            ksUI$1.menuState.toggleMouseHover(false);


            this.Client = new MessageHandler("GameMode");
            this.MfdClient = new MessageHandler("Mfd");


            if (!this.StoredData.visibility) {
                this.isolationMode = false;
            }

            engine.trigger(EngineEvents.InSession.HudVisibility, this.StoredData.visibility);

            this.loadSeasonAndSessionInfo();

            this.changePageHandler = engine.on("changePage", () => {
                this.loadSeasonAndSessionInfo();
            });


            this.SettingsClient = new MessageHandler("Settings");
            this.SettingsClient.request("Video", (data) => {
                document.body.classList.toggle("is-triple-screen", data.video.display.is_triple === true);
            });



            //this.isolationMode = "";
            localStorage.removeItem("loadingDestination");



        }

        onRemovedFromDOM() {
            console.log("Removing HUD");
            clearTimeout(this.mouseTimer);
            window.removeEventListener(EngineEvents.UI.InputAction, this.#internal_evaluateUIActions);
            window.removeEventListener("mousemove", this.#internal_mouseToggler);
            window.removeEventListener("mousedown", this.#internal_mouseToggler);
            ksUI$1.menuState.toggleKeyboardInput(false);
            document.body.classList.remove("hide-mouse");
            this.changePageHandler.clear();
            ksUI$1.jiggleMouse();
        }

        #internal_evaluateUIActions;


        evaluateUIActions(evt) {
            if (evt.detail == "menu") {
                if (this.filters.evaluateContinueLabel(ModelUISessionState) && !document.body.classList.contains("multiplayer")) {
                    ksUI$1.requestNoResponse("GameMode", "TerminateSession");
                    // ksUI.requestNoResponse("GameMode", "BackToPit");
                } else {
                    new Promise((resolve, reject) => {
                        this.Client.request("Pause", (response) => {
                            switch (response.response) {
                                case "GameModePauseOK":
                                    this.onRemovedFromDOM();
                                    this.isolationMode = false;
                                    this.saveLayoutData().finally(() => {
                                        console.warn("saved");
                                        ksUI$1.requestNoResponse("GameMode", "Pause");
                                        ksUI$1.goTo("ingame.html", "pause");
                                        resolve(response);
                                    });
                                    break;
                                case "GameModePauseNotAllowed":
                                    console.warn("Cannot pause game!");
                                    reject(response);
                                    break;
                            }
                        });
                    });
                }
            }

            if (evt.detail == "togglehud") {
                const hudhidden = this.classList.toggle("hide");
                document.body.classList.toggle("hide-hud", hudhidden);
                this.StoredData.visibility = !hudhidden;
                engine.trigger(EngineEvents.InSession.HudVisibility, this.StoredData.visibility);
                //localStorage.setItem("HideHUD", hudhidden);
            }
        }

        #internal_mouseToggler;

        lastMouseX = 0;
        lastMouseY = 0;

        currentmouseX = 0;
        currentmouseY = 0;

        mouseToggler(evt) {
            if (evt.type == "mousemove") {
                this.currentmouseX = evt.x;
                this.currentmouseY = evt.y;

                if (Math.abs(this.currentmouseX - this.lastMouseX) > 100) {
                    document.body.classList.remove("hide-mouse");
                }

                if (Math.abs(this.currentmouseY - this.lastMouseY) > 100) {
                    document.body.classList.remove("hide-mouse");
                }
            } else {
                document.body.classList.remove("hide-mouse");
            }

            clearTimeout(this.mouseTimer);

            this.mouseTimer = setTimeout(() => {
                document.body.classList.add("hide-mouse");
                this.lastMouseX = this.currentmouseX;
                this.lastMouseY = this.currentmouseY;
            }, 3000);
        }

        bindControls() {

            if (this.autoHideMouse) {
                this.#internal_mouseToggler = this.mouseToggler.bind(this);
                this.mouseTimer = setTimeout(() => {
                    ksUI$1.jiggleMouse();
                    document.body.classList.add("hide-mouse");
                }, 3000);

                ksUI$1.jiggleMouse();
                document.body.classList.add("hide-mouse");
            }

            if (this.handleInputActions) {
                this.#internal_evaluateUIActions = this.evaluateUIActions.bind(this);
                window.addEventListener("ui.action", this.#internal_evaluateUIActions);
            }

            window.addEventListener("mousemove", this.#internal_mouseToggler);
            window.addEventListener("mousedown", this.#internal_mouseToggler);
            window.addEventListener("wheel", this.#internal_mouseToggler);
        }

    }
    engine.on("MenuStateInit", () => {
        ksUI$1.registerModule('ks-hud', Hud);
    });

    var template$N = "<div id=\"listNotifications\">\r\n\r\n</div>";

    var template$M = "<div class=\"panelBody\">\r\n    \r\n</div>";

    class NotificationItem extends KsHTMLElement {

        Message;

        shownAt;

        /** @type DivHTMLElement */
        panelBody;

        hideAfter = 5000;
        deleteAfter = 7000;

        constructor(message) {
            super();
            this.template = template$M;
            this.Message = message;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.mapElementByClass("panelBody");

            if (!this.Message) {
                console.warn("No message defined", this.tagName);
                return;
            }

            this.classList.add(this.Message.type);
            this.dataset.mode = "hidden";



            if (this.Message.time_to_hide != undefined && this.Message.time_to_hide > 1000) {

                this.hideAfter = this.Message.time_to_hide;

                //console.log("Message time to hide", this.Message.time_to_hide, this.hideAfter);

                if (this.deleteAfter - this.hideAfter < 2000) {
                    this.deleteAfter = this.hideAfter + 2000;
                }

            }

            //this.hideAfter = 10000;

            this.renderNotification();

            waitForFrames(() => this.countdown(), 1);
        }

        renderNotification() {

            this.panelBody.textContent = "";

            const types = {
                [eUINofiticationType.Debug]: () => {

                    this.panelBody.classList.add("preformatted");

                    this.Message.tuples.forEach((tuple) => {
                        this.panelBody.innerHTML +=
                            `<div class="tuple">
                        <span>${tuple.type}</span>
                        <div class="values">${tuple.values.join(",")}</div>
                    </div>`;
                    });
                },
                [eUINofiticationType.XpReward]: () => {

                    this.panelBody.innerHTML +=
                        `<div class="tuple">
                         <span>${engine.translate("lblXPReceived")}</span>
                         <div class="values">${this.Message.tuples[0].values[0]}</div>
                     </div>`;

                },
                [eUINofiticationType.CreditsReward]: () => {
                    this.panelBody.innerHTML +=
                        `<div class="tuple">
                         <span>${engine.translate("lblCreditsReceived")}</span>
                         <div class="values">${this.Message.tuples[0].values[0]}</div>
                     </div>`;
                },
                [eUINofiticationType.RentalDone]: () => {
                    this.panelBody.innerHTML +=
                        `<div class="tuple">
                         <span>${engine.translate("lblRentalDone")}</span>
                         <div class="values">${this.Message.tuples[0].values[0]}</div>
                     </div>`;
                },
                [eUINofiticationType.SessionPenalty]: () => {

                    const penalty_added = this.Message.tuples[0].values[0].split('#')[0].trim() == "{PENALTY_ADDED_KEY}";

                    this.classList.toggle("penalty-cleared", !penalty_added);

                    console.warn(penalty_added, this.Message.tuples[0].values[0]);

                    const penalty_type = this.Message.tuples[0].values[2] ?? "";
                    const penalty_type_label = engine.translate(penalty_type) ?? "";
                    
                    const penalty_reason = this.Message.tuples[0].values[1] ?? "";
                    const penalty_reason_label = engine.translate(penalty_reason) ?? "";

                    const penalty_value = this.Message.tuples[1]?.values ?? 0;

                    console.log("hasvalue", penalty_value);

                    this.panelBody.innerHTML +=
                        `<div class="tuple ${penalty_type}">

                    <span>${penalty_type == ePenaltyType.Warning ? engine.translate("lblWarningReceived") : penalty_added ? engine.translate(penalty_type ? "lblPenaltyReceived" : "lblPenaltyPending") : engine.translate("lblPenaltyCleared")}</span>
                     
                    <div class="values racenumber">${engine.translate("lblCarNumber")} ${this.Message.tuples[0].values[0].split('#')[1].trim()}</div>
                         <div class="values penaltytype">${penalty_type_label}</div>
                         <div class="values penaltyreason">${penalty_reason_label}</div>
                    </div>`;

                    this.classList.add(this.Message.tuples[0].values[2]);
                    this.classList.toggle("Penalty_Received", penalty_added && this.Message.tuples[0].values[2] != "PenaltyType_Warning");
                },
                [eUINofiticationType.ConnectionStatus]: () => {

                    const status = this.Message.tuples[0].values[0];
                    const message = engine.translate("connection_" + status);
                    this.panelBody.innerHTML +=
                        `<div class="tuple ${status}"><span>${message}</span><div>`;
                },
                [eUINofiticationType.GameplayInfo]: () => {
                    this.panelBody.innerHTML +=
                        `<div class="tuple">
                    <span>${engine.translate("lblInfo")}</span>
                    <div class="value">${engine.translate("lblPauseMenuMultiplayer")}</div>
                </div>`;
                    this.hideAfter = 1000;
                },
                [eUINofiticationType.CarSettings]: () => {
                    const setting_name = this.Message.tuples[0].values[0];
                    const setting_value = this.Message.tuples[1].values[0];

                    if (setting_name == "CAR_FFB_MULTIPLIER") {
                        const localized_settingname = engine.translate("setting_" + setting_name);
                        const processed_value = Math.round(Number(setting_value) * 100);

                        this.classList.add(setting_name);

                        this.panelBody.innerHTML +=
                            `<div class="tuple">
                         <span>${localized_settingname}</span>
                         <div class="values">${processed_value}%</div>
                     </div>`;
                    }

                },
                [eUINofiticationType.Car]: () => {

                    try {
                        let sn_type;
                        let valuetype;
                        let value;
                        let html;

                        if (this.Message.tuples.length > 1) {

                            sn_type = this.Message.tuples[0].values[0];
                            valuetype = this.Message.tuples[1].type;
                            value = this.Message.tuples[1].values[0];

                            const exceptions = ["CHANGED_ACTIVE_PERFORMANCE_MODE", "CHANGED_CURRENT_PAGE_INDEX", "CHANGED_SELECTED_DISPLAY_INDEX"];

                            if (valuetype == eUINotificationValueType.Integer && exceptions.indexOf(sn_type) == -1) {
                                if (value == "0")
                                    value = engine.translate("lblOffUpper");
                            }

                            if (valuetype == eUINotificationValueType.Boolean) {
                                if (sn_type == "CHANGED_DRS_OPEN") {
                                    value = engine.translate(value == "0" ? "lblClosedUpper" : "lblOpenUpper");
                                } else {
                                    value = engine.translate(value == "0" ? "lblOffUpper" : "lblOnUpper");
                                }
                            }

                            html = `<div class="tuple">
                    <div class="value">${value}</div>
                    <span>${engine.translate('lblNotificationCar_' + sn_type)}</span></div>`;

                        } else {

                            valuetype = this.Message.tuples[0].type;
                            sn_type = this.Message.tuples[0].values[0];

                            html = `<div class="tuple">
                    <div class="value">${engine.translate('lblNotificationCar_' + sn_type)}</div>
                    </div>`;

                        }

                        this.dataset.type = sn_type;
                        this.panelBody.innerHTML = html;
                    } catch (msg) {
                        console.error("Failed to render UINotificationType_Car", msg);
                    }
                },
                [eUINofiticationType.Session]: () => {

                    try {
                        const sn_type = this.Message.tuples[0].values[0];
                        this.classList.add(sn_type);

                        const tuple = document.createElement("div");
                        tuple.classList.add("main");

                        const title = document.createElement("span");
                        title.classList.add("title");
                        title.textContent = engine.translate('lblNotificationSession_' + sn_type);

                        tuple.appendChild(title);

                        if (sn_type == eUINotificationTypeSession.BestLap) {
                            const driver = [this.Message.tuples[1].values[1], this.Message.tuples[1].values[2]];
                            const carnumber = this.Message.tuples[2].values[0];
                            const time = this.Message.tuples[3].values[0];

                            const time_entry = document.createElement("div");
                            time_entry.classList.add("value");
                            time_entry.classList.add("time");
                            time_entry.textContent = time;
                            tuple.appendChild(time_entry);

                            const driver_entry = document.createElement("div");
                            driver_entry.classList.add("value");
                            driver_entry.classList.add("driver");
                            driver_entry.innerHTML = `<span>${carnumber}</span><div>${driver.join(" ")}</div>`;
                            tuple.appendChild(driver_entry);
                        }

                        if (sn_type == eUINotificationTypeSession.PersonalBestLap) {
                            const driver = [this.Message.tuples[1].values[1], this.Message.tuples[1].values[2]];
                            const carnumber = this.Message.tuples[2].values[0];
                            const time = this.Message.tuples[3].values[0];

                            const time_entry = document.createElement("div");
                            time_entry.classList.add("value");
                            time_entry.classList.add("time");
                            time_entry.textContent = time;
                            tuple.appendChild(time_entry);
                        }

                        this.panelBody.appendChild(tuple);
                    } catch (msg) {
                        console.error("Failed to render UINotificationType_Session", msg);
                    }
                },

                [eUINofiticationType.RaceControl]: () => {

                    try {
                        const sn_type = this.Message.tuples[0].values[0];
                        this.classList.add(sn_type);

                        const tuple = document.createElement("div");
                        tuple.classList.add("main");

                        const title = document.createElement("span");
                        title.classList.add("title");
                        title.textContent = engine.translate('lblNotificationRaceControl_' + sn_type);

                        tuple.appendChild(title);

                        if (sn_type == eUINotificationTypeSession.BestLap) {
                            const driver = [this.Message.tuples[1].values[1], this.Message.tuples[1].values[2]];
                            const carnumber = this.Message.tuples[2].values[0];
                            const time = this.Message.tuples[3].values[0];

                            const time_entry = document.createElement("div");
                            time_entry.classList.add("value");
                            time_entry.classList.add("time");
                            time_entry.textContent = time;
                            tuple.appendChild(time_entry);

                            const driver_entry = document.createElement("div");
                            driver_entry.classList.add("value");
                            driver_entry.classList.add("driver");
                            driver_entry.innerHTML = `<span>${carnumber}</span><div>${driver.join(" ")}</div>`;
                            tuple.appendChild(driver_entry);
                        }

                        if (sn_type == eUINotificationTypeSession.PersonalBestLap) {
                            const driver = [this.Message.tuples[1].values[1], this.Message.tuples[1].values[2]];
                            const carnumber = this.Message.tuples[2].values[0];
                            const time = this.Message.tuples[3].values[0];

                            const time_entry = document.createElement("div");
                            time_entry.classList.add("value");
                            time_entry.classList.add("time");
                            time_entry.textContent = time;
                            tuple.appendChild(time_entry);
                        }

                        this.panelBody.appendChild(tuple);
                    } catch (msg) {
                        console.error("Failed to render UINotificationType_Session", msg);
                    }
                },

                [eUINofiticationType.Multiplayer]: () => {

                    try {
                        const sn_type = this.Message.tuples[0].values[0];
                        this.classList.add(sn_type);

                        const tuple = document.createElement("div");
                        tuple.classList.add("main");

                        const title = document.createElement("span");
                        title.classList.add("title");
                        title.textContent = engine.translate('lblNotificationMultiplayer_' + sn_type);

                        tuple.appendChild(title);

                        if ([eUINotificationTypeMultiplayer.PlayerConnected, eUINotificationTypeMultiplayer.PlayerDisconnected].indexOf(sn_type) > -1) {
                            const driver = [this.Message.tuples[1].values[1], this.Message.tuples[1].values[2]];
                            const carnumber = this.Message.tuples[2].values[0];

                            const driver_entry = document.createElement("div");
                            driver_entry.classList.add("value");
                            driver_entry.classList.add("driver");
                            driver_entry.innerHTML = `<span>${carnumber}</span><div>${driver.join(" ")}</div>`;
                            tuple.appendChild(driver_entry);
                        }

                        this.panelBody.appendChild(tuple);
                    } catch (msg) {
                        console.error("Failed to render UINotificationType_Multiplayer", msg);
                    }
                }

            };

            if (types[this.Message.type]) {
                types[this.Message.type]();
            } else {
                this.panelBody.classList.add("preformatted");
                this.panelBody.classList.add("unknown");
                this.panelBody.innerHTML = `<span>UNKNOWN TYPE: ${this.Message.type}</span>${ksUI$1.iterateToText(this.Message)}`;
            }

        }

        get isVisible() {
            return this.dataset.mode == "active";
        }

        countdown(timeStamp) {

            if (!this.parentElement || !this.isConnected) {
                // console.warn(this._uniqueid, "removed by parent");
                return;
            }

            if (this.shownAt === undefined && timeStamp != undefined) {
                this.shownAt = timeStamp;
            } else if (timeStamp == undefined) {
                requestAnimationFrame(this.countdown.bind(this));
                return;
            }

            const elapsed = timeStamp - this.shownAt;

            if (elapsed >= this.deleteAfter) {
                console.trace(`Removing ${this.tagName}, ${this._uniqueid}`);
                this.parentElement.removeChild(this);
                return;
            }

            const hide = elapsed >= this.hideAfter;

            if (hide && this.isVisible) console.log("Hiding", this.tagName, this._uniqueid);

            this.toggleVisibility(!(elapsed >= this.hideAfter));

            // this.classList.toggle("first-notification", this.parentElement.firstElementChild == this && this.has);

            requestAnimationFrame(this.countdown.bind(this));

        }

        toggleVisibility(state) {
            this.dataset.mode = state ? "active" : "hidden";

        }


        doCountdown() {


        }

        get mode() {
            return this.dataset.mode;
        }


    }
    ksUI$1.registerModule('ks-notification', NotificationItem);

    const NotificationSettingsTemplate = {
        min_priority: eUINotificationPriorityType.Low
    };

    class NotificationPanel extends KsHTMLElement {

        eventHandler;
        queue = [];

        /** @type HTMLDivElement */
        listNotifications;

        _config = { ...NotificationSettingsTemplate };

        get Config() {
            return this._config;
        }

        set Config(new_data) {
            this._config = new_data;
        }

        constructor() {
            super();
            this.template = template$N;
        }

        bindControls() {
            this.eventHandler = engine.on("UINotification", (message) => this.handleMessage(message));
        }

        handleMessage(message) {

            if (ksUI$1.isDevMode()) {
                console.log("---\nUINotification", this.tagName);
                console.trace(message);
                console.trace(ksUI$1.stringify(message));

            } else if (message.type == eUINofiticationType.Debug) {
                return;
            }

            if(eUINotificationPriorityTypeValue[message.priority] < eUINotificationPriorityTypeValue[this.Config.min_priority]) {
                return;
            }

            console.log("UINotification", message.type);

            // ({
            //     [eUINofiticationType.BestLap]: () => {

            //     },
            //     [eUINofiticationType.LevelUp]: () => {

            //     },
            //     [eUINofiticationType.XpReward]: () => {

            //     },
            //     [eUINofiticationType.CreditsReward]: () => {

            //     },
            //     [eUINofiticationType.SessionPenalty]: () => {

            //     },
            //     [eUINofiticationType.RentalDone]: () => {

            //     }
            // }[message.type])?.();

            this.addNotification(message);
        }

        forceRendering() {
            this.classList.remove("adding");
            waitForFrames(() =>
                this.classList.add("adding")
                , 3);

        }

        notifications = [];

        addNotification(message) {
            console.log("Adding notification", message.type);


            if (message.type == eUINofiticationType.Car) {
                let found;
                for (const n of this.listNotifications.children) {

                    if (n.Message.type == eUINofiticationType.Car) {
                        found = n;
                        break;
                    }

                }

                if (found) {
                    found.shownAt = undefined;
                    found.Message = message;
                    found.renderNotification();
                    return;
                }
            }

            /** @type NotificationItem */
            let notification = document.createElement("ks-notification");

            notification.Message = message;

            if (this.listNotifications.hasChildNodes()) {

                this.listNotifications.insertBefore(notification, this.listNotifications.firstElementChild);

                if (this.listNotifications.children.length > 5) {
                    this.listNotifications.lastElementChild.remove();
                }

            }
            else {
                this.notifications.push(notification);
                this.listNotifications.appendChild(notification);
            }
        }

        onRemovedFromDOM() {
            this.eventHandler.clear();
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("listNotifications");


            this.initStorageContainer(eStorageContainers.Notifications, this.Config, this._config);

        }



    }

    ksUI$1.registerModule('ks-notificationpanel', NotificationPanel);

    const languages = {
        "en": "ENGLISH",
        "es": "ESPAOL",
        "de": "DEUTSCH",
        "fr": "FRANAIS",
        "it": "ITALIANO",
        "cn": "",
        "ru": ""
    };

    class SettingsGameplayHud extends KsHTMLElement {

        /** @type MessageHandler */
        Client;
        /** @type MessageHandler */
        Settings;

        /** @type Btnbasic */
        btnBack;
        /** @type Btnbasic */
        btnCancel;
        /** @type Btnbasic */
        btnApply;

        /** @type KsSlider */
        sliderLanguage;

        /** @type {KsSlider} */
        sliderNotificationPriority;

        /** @type HTMLDivElement */
        panelModes;

        isDirty = false;
        loading = false;

        btnSwitch = [];

        _notificationsConfig = { ...NotificationSettingsTemplate };

        get NotificationsConfig() {
            return this._notificationsConfig;
        }

        set NotificationsConfig(new_data) {
            this._notificationsConfig = new_data;
        }

        constructor() {
            super();
            this.template = template$1c;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this._bindScrollableEvents = true;
        }

        initHudSlidersFromStorage() {

            this.NotificationsConfig = STORAGE.get(eStorageContainers.Notifications);
            this.sliderNotificationPriority.valueNoEvent = this.NotificationsConfig.min_priority;

            const storage = STORAGE.get(eStorageContainers.HUDLayout);
            if (!storage) {
                qAll(".hud ks-slider[data-widget]").forEach(slider => {
                    const widget = slider.dataset.widget;

                    let val;
                    if (widget == "hud_trackmap") {
                        val = "optionZoomed";
                    } else {
                        val = "optionOn";
                    }
                    slider.valueNoEvent = val;
                });
                return;
            }

            this.storageCopy = JSON.parse(JSON.stringify(storage));

            const layout = storage.layouts[storage.lastLayout || "default"] || { elements: {} };
            const elements = layout.elements || {};

            qAll(".hud ks-slider[data-widget]").forEach(slider => {
                const node = elements[slider.dataset.widget];
                const s = node?.settings;

                const raw = slider.getAttribute("values") || "[]";
                const isMode = /optionZoomed|optionFull/.test(raw);

                let val;
                if (s) {
                    if (isMode) {
                        if (s.visible === false || s.mode === "optionOff") val = "optionOff";
                        else if (s.mode === "optionZoomed") val = "optionZoomed";
                        else val = "optionFull";
                    } else {
                        val = (s.visible !== false) ? "optionOn" : "optionOff";
                    }
                } else {
                    val = isMode ? "optionFull" : "optionOn";
                }

                slider.valueNoEvent = val;
            });

            this.clearDirty();
        }

        load(clear_dirty = true) {
            this.loading = true;
            this.Client.request("PersonalSettings", (response) => {
                ksUI$1.assignModel(response.personal_settings, "GameplaySettings");
                const injectRussian = () => {
                    const el = this.sliderLanguage;
                    if (!el) return;
                    let arr = el.valuesArray;
                    if (!arr && el.slider && el.slider._values) arr = el.slider._values;
                    if (!arr && el.hasAttribute && el.getAttribute("values")) try { arr = JSON.parse(el.getAttribute("values")); } catch (e) {}
                    if (Array.isArray(arr) && arr.length && !arr.includes("ru")) {
                        arr = [...arr, "ru"];
                        if (typeof el.values !== "undefined") el.values = JSON.stringify(arr);
                        else if (el.setAttribute) el.setAttribute("values", JSON.stringify(arr));
                        if (el.slider && el.slider.values) el.slider.values = arr;
                    }
                };
                ksUI$1.waitForFrames(injectRussian, 12);
                ksUI$1.waitForFrames(injectRussian, 30);
                ksUI$1.waitForFrames(injectRussian, 60);
                ksUI$1.waitForFrames(injectRussian, 120);
            });

            this.Settings.request("ReplaySettings", (response) => {
                ksUI$1.assignModel(response, "Settings");
                this.unitConversion("load");
                if (clear_dirty) this.clearDirty();
                ksUI$1.waitForFrames(() => {
                    this.loading = false;
                }, 4);
            });
        }

        save() {
            return Promise.all([
                new Promise((resolve, reject) => {
                    this.Client.request("SetPersonalSettings", {
                        personal_settings: GameplaySettings
                    }, (data) => {
                        {
                            console.log("Gameplay Settings Saved!");
                            this.clearDirty();
                            resolve(data);
                        }
                    });
                }),
                new Promise((resolve, reject) => {
                    this.unitConversion("save");
                    this.Settings.request("ReplaySaveSettings", {
                        settings: Settings.settings
                    }, (data) => {
                        if (data.response == "OK") {
                            console.log("Replay Settings Saved!");
                            this.load();
                            this.clearDirty();
                            resolve(data);
                        } else {
                            reject(data);
                        }
                    });
                })
            ]).then(() => {
                this.initHudSlidersFromStorage();
                this.clearDirty();
            });
        }

        unitConversion(state) {
            if (state === "load") {
                Settings.settings.max_duration /= 60;
                Settings.settings.min_length_prompt_auto_save /= 60;
            } else if (state === "save") {
                Settings.settings.max_duration *= 60;
                Settings.settings.min_length_prompt_auto_save *= 60;
            }
        }

        onRemovedFromDOM() {
            ksUI$1.unassignModel("GameplaySettings");
            ksUI$1.unassignModel("Settings");
        }

        reset() {
            if (this.storageCopy) {
                STORAGE.set("hudlayout", JSON.parse(JSON.stringify(this.storageCopy)));
            }
            this.initHudSlidersFromStorage();

            console.log("Reset Gameplay settings");
            ksUI$1.unassignModel("GameplaySettings");
            ksUI$1.unassignModel("Settings");
            this.load();

        }

        markDirty() {
            this.isDirty = true;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.removeAttribute("disabled");
            });
        }

        clearDirty() {
            this.isDirty = false;
            [this.btnApply, this.btnCancel].map(btn => {
                if (btn)
                    btn.setAttribute("disabled", "true");
            });
        }

        onAfterRenderControlHints(controlhints) {
            this.btnBack = q(".back", controlhints);
            this.btnApply = q(".apply", controlhints);
            this.btnCancel = q(".cancel", controlhints);

            const changePage = function (target, sender, is_back = true) {

                function process() {
                    if (ksUI$1.menuState.isOriginMainMenu && is_back) {
                        ksUI$1.goTo("menu.html", "main/main");
                    } else {
                        ksUI$1.changePage(target, false, false);
                    }
                }

                if (sender.isDirty) {
                    sender.pageModal.Show({
                        type: eModalDialogTypes.Warning,
                        title: "lblChangesDetected",
                        message: "msgChangesWarning",
                        confirm: "btnApply"
                    });

                    sender.pageModal.onDiscard = () => {
                        sender.reset();
                        process();
                    };

                    sender.pageModal.onConfirm = () => {
                        sender.save();
                        process();
                    };
                } else {
                    process();
                }
            };

            this.btnBack.onPressed = () => {
                changePage("settings/main", this);
            };

            this.btnApply.onPressed = () => this.save();
            this.btnCancel.onPressed = () => this.reset();
        }

        getSwitchButtons() {
            qAll("ks-btnbasic[toggle-group=section]").forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    this.btnSwitch.push(elem);
                });
        }

        bindControls() {

            qevAll("ks-slider",
                "onSliderValueChanged", (ev) => {
                    if (this.loading) return;

                    let detail = ev.detail;
                    let detaildata = detail.sender.dataset;

                    const path = detaildata.bindKsvalue.replace(/[{}]/g, "").split(".");
                    const sourcevalue = Function(`return window["${path.join('"]["')}"]`)();
                    const value = ksUI$1.sameType(sourcevalue, typeof sourcevalue == "boolean" ? detail.index : detail.value);
                    const type = typeof value;
                    Function(`window["${path.join('"]["')}"]=${type == "string" ? '"' + detail.value + '"' : type == "boolean" ? detail.sender.index == 1 : value}`)();

                    this.markDirty();
                }, this);

            qevAll(".hud ks-slider[data-widget]",
                "onSliderValueChanged", (ev) => {
                    if (this.loading) return;

                    const detail = ev.detail;
                    const widgetId = detail.sender.dataset.widget;

                    const value = detail.value;
                    const valuesAttr = detail.sender.getAttribute("values") || "[]";

                    const isMode = /optionZoomed|optionFull|optionOff/.test(valuesAttr);

                    const patch = isMode
                        ? { mode: value, visible: value !== "optionOff" }
                        : { visible: value === "optionOn" };

                    let storage = { ...HUDInitTemplate };

                    const saved_storage = STORAGE.get("hudlayout");

                    if (!saved_storage) {
                        storage.layouts.default.elements.hud_trackmap = {
                            settings: { mode: "optionZoomed", visible: true }
                        };
                        this.storageCopy = { ...storage };
                    } else {
                        storage = saved_storage;
                        this.storageCopy = { ...storage };
                    }

                    const layoutKey = storage.lastLayout || "default";
                    storage.layouts[layoutKey] ??= { elements: {} };
                    storage.layouts[layoutKey].elements ??= {};
                    const elements = storage.layouts[layoutKey].elements;

                    const node = (elements[widgetId] ??= { settings: {} });
                    node.settings ??= {};
                    Object.assign(node.settings, patch);

                    STORAGE.set(eStorageContainers.HUDLayout, storage);
                    STORAGE.save(eStorageContainers.HUDLayout);

                    this.markDirty();

                }, this);

            this.sliderLanguage.valueFilter = (value_to_filter) => {
                return languages[value_to_filter];
            };

            this.sliderLanguage.addEventListener("onSliderValueChanged", (ev) => {
                let detail = ev.detail;
                console.warn(detail.value);
                ksUI$1.changeLanguage(detail.value);
            });

            this.sliderNotificationPriority.addEventListener("onSliderValueChanged", (ev) => {
                let detail = ev.detail;
                console.warn(detail.value, detail.index);
                this.NotificationsConfig.min_priority = detail.value;
                console.warn(this.NotificationsConfig);
                STORAGE.set(eStorageContainers.Notifications, this.NotificationsConfig);
                STORAGE.save(eStorageContainers.Notifications);
                this.markDirty();
            });

            qAll("ks-btnbasic[toggle-group=section]").forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        if (state) {
                            if (this.isDirty) {
                                this.pageModal.Show({
                                    type: eModalDialogTypes.Warning,
                                    title: "lblChangesDetected",
                                    message: "msgChangesWarning",
                                    confirm: "btnApply"
                                });
                                this.pageModal.onDiscard = () => {
                                    this.reset();
                                    this.panelModes.dataset.mode = sender.dataset.mode;
                                };
                                this.pageModal.onConfirm = () => {
                                    this.save();
                                    this.panelModes.dataset.mode = sender.dataset.mode;
                                };
                                this.pageModal.onCancel = () => {
                                    this.reset();
                                    if (sender.dataset.mode === "hud") {
                                        this.btnSwitch[0].toggle(true);
                                    } else {
                                        this.btnSwitch[1].toggle(true);
                                    }
                                };
                            } else {
                                this.panelModes.dataset.mode = sender.dataset.mode;
                            }
                        }
                        if (sender.dataset.mode == "hud") {
                            q(".hud").scrollTop = 0;
                        } else {
                            q(".gameplay").scrollTop = 0;
                        }
                    };
                });
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.mapElementById("panelModes");
            this.mapElementById("sliderLanguage");
            this.mapElementById("sliderNotificationPriority");

            this.initStorageContainer(eStorageContainers.Notifications, this.NotificationsConfig, this._notificationsConfig);

            this.Client = new MessageHandler("GameEconomyClient");
            this.Settings = new MessageHandler("Settings");

            this.load();
            this.initHudSlidersFromStorage();



        }
    }

    ksUI$1.registerModule('ks-page-settings-gameplay-hud', SettingsGameplayHud);

    var template$L = "<div class=\"component-body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n\r\n            <ks-btnbasic id=\"btnBack\" class=\"back focusable test\" path=\"{activeMenu}/main\">\r\n                <div slot=\"name\" data-l10n-id=\"btnBack\">Exit</div>\r\n            </ks-btnbasic>\r\n\r\n        </div>\r\n    </component-slot>\r\n\r\n    <div class=\"submode-body centered-content\">\r\n\r\n        <ks-btnpanel id=\"btnGarage\" class=\"half focusable garage\" data-tooltip=\"tooltipGarage\" path=\"singleplayer/modelselection\" storeorigin=\"true\">\r\n            <div slot=\"subtitle\" data-l10n-id=\"btnPanelGarage\"></div>\r\n        </ks-btnpanel>\r\n\r\n        <ks-btnpanel id=\"btnRental\" class=\"half focusable rental\" data-tooltip=\"tooltipRental\" goto=\"vehicles.html\" path=\"rental/brandselection\" storeorigin=\"true\">\r\n            <div slot=\"subtitle\" data-l10n-id=\"btnPanelRental\"></div>\r\n        </ks-btnpanel>\r\n\r\n    </div>\r\n\r\n</div>";

    class GameEconomyManager extends BaseManager {

        Client = new MessageHandler("GameEconomyClient");

        constructor(parent_element) {
            super(null, parent_element);
        }

        updateDataFilters() {
            this.ParentElement.assignModel(this._dataFilters, "GameEconomyClientDataFilters");
        }

        getDriverPersonalData() {
            return new Promise((resolve, reject) => {
                this.Client.request("DriverPersonalData",
                    (data) => {
                        if (data.response == eBackendResponse.OK) {
                            this.PersonalData = data.personal_data;
                            this.assignModel(this.PersonalData, "PersonalData", true);
                            resolve(data);
                        } else {
                            reject(data);
                        }
                    });
            });
        }

        buyCar(car_model, callback) {

            this.Client.request("BuyCar", {
                model: car_model
            }, (data) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        console.log("Bought car", car_model.name);
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Could not set car_model to", car_model.name, car_model.car_guid);
                    }
                }[data.response])?.();

                console.log("received", data.response);

                $.waitForFrames(() => {
                    if (callback) {
                        callback(data.response);
                    }            }, 1);
            });
        }

        removeCar(car_pguid, callback) {
            this.Client.request("RemoveCar", {
                car_pguid: car_pguid
            }, (data) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        console.log("Removed car", car_pguid);
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Could not remove car", car_pguid);
                    }
                }[data.response])?.();

                console.log("received", data.response);

                $.waitForFrames(() => {
                    if (callback) {
                        callback(data.response);
                    }            }, 1);
            });
        }

        rentCar(car_model, callback) {

            this.Client.request("RentCar", {
                model: car_model
            }, (data) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        console.log("Rented car", car_model.name);
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Could not set car_model to", car_model.name, car_model.car_guid);
                    }
                }[data.response])?.();

                console.log("received", data.response);

                $.waitForFrames(() => {
                    if (callback) {
                        callback(data.response);
                    }            }, 1);
            });
        }

    }

    class GarageRentalPage extends BaseCarSelectionPage {


        labelHeader;
        returnPath;

        /** @type {Btnbasic} */
        btnBack;

        /** @type {BtnPanel} */
        btnRental;

        /** @type {BtnPanel} */
        btnGarage;

        constructor() {
            super();
            this.template = template$L;
            this._exposeAsActivePage = true;
            this._isnavigable = true;
            this.delayedInit = true;

        }

        bindControls() {

        }

        onAfterRenderControlHints(controlhints) {

        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();
            this.documentBody.classList.remove("garagerental");
            
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            if(isSandBox) {
                ksUI$1.changePage("singleplayer/modelselection");
            }

            this.mapElementById("btnGarage");
            this.mapElementById("btnRental");

            waitForFrames(() => {
                ksUI$1.menuState.toggleMouseHover(false);
            }, 1);

            this.mapElementById("labelHeader");

            let title = this.getAttribute("title");
            this.returnPath = this.getAttribute("returnPath");

            if (title) {
                this.labelHeader.dataset.l10nId = title;
            }
            this.documentBody.classList.add("garagerental");
            localStorage.removeItem("textfilter_modelselection");

            VEHICLES.clearHandlers();
            VEHICLES.resetFilters();

            VEHICLES.dataFilters.activeBrand = VEHICLES.allBrands;
            VEHICLES.updateDataFilters();

            SHOWROOM.resetCarState();
            SHOWROOM.showExterior();
        }

    }
    ksUI$1.registerModule('ks-page-garagerental', GarageRentalPage);

    var template$K = "<div class=\"component-body\">\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic class=\"back focusable\" id=\"btnBack\"></ks-btnbasic>            \r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\">\r\n            <div data-l10n-id=\"headerSettings\">Settings</div>\r\n            <div>/</div>\r\n            <div data-l10n-id=\"headerCredits\">Credits</div>\r\n        </div>                \r\n    </ks-pageheader>   \r\n\r\n    <div class=\"submode-body\">\r\n        <div class=\"column credits\">\r\n            <div class=\"role-item\"><div class=\"title\">Producer & Project Manager of the Assetto Corsa series</div>Marco Massarutto</div>\r\n            <div class=\"role-item\"><div class=\"title\">Game Director</div>Davide Brivio</div>\r\n            <div class=\"role-item\"><div class=\"title\">Technical Director</div>Alessandro Piva</div>\r\n            <div class=\"role-item\"><div class=\"title\">Lead Rendering Programmer</div>Leonardo Fratini</div>\r\n            <div class=\"role-item\"><div class=\"title\">Vehicle Production Director</div>Gergo Panker</div>\r\n            <div class=\"role-item\"><div class=\"title\">Environment Production & Art</div>Simone Trevisol</div>\r\n            <div class=\"role-item\"><div class=\"title\">Audio Engineering</div>Luca Sodano, Davide Cervone</div>\r\n            <div class=\"role-item\"><div class=\"title\">Vehicle R&D and Handling</div>Fernando Barbarossa, Alfredo Santarcangelo</div>\r\n            <div class=\"role-item\"><div class=\"title\">Vehicle Dynamic Testing</div>Nils Naujoks, Fernando Barbarossa, Alfredo Santarcangelo, Marco Massarutto, Davide Brivio, Luca Sodano</div>\r\n            <div class=\"role-item\"><div class=\"title\">Graphics Programming</div>Leonardo Fratini, Alessandro Piva, Fabio Luchetta</div>\r\n            <div class=\"role-item\"><div class=\"title\">Physics Programming</div>Fernando Barbarossa</div>\r\n            <div class=\"role-item\"><div class=\"title\">Gameplay, Audio & Replay Programming</div>Alvio Costantini</div>\r\n            <div class=\"role-item\"><div class=\"title\">Gameplay & Tech Programming</div>Manuel Darin</div>\r\n            <div class=\"role-item\"><div class=\"title\">Gameplay & RPG Programming</div>Paolo Ghibaudo</div>\r\n            <div class=\"role-item\"><div class=\"title\">UI Programming</div>Ithomeneas Mitsotakis, Manuel Darin, Riccardo Iengo</div>\r\n            <div class=\"role-item\"><div class=\"title\">AI & Network Programming</div>Kevin Stuck</div>\r\n            <div class=\"role-item\"><div class=\"title\">Backend Programming</div>Alfredo Santarcangelo</div>\r\n            <div class=\"role-item\"><div class=\"title\">Vehicles 3D Modeling, Animations and Texturing</div>Gianluca Miragoli, Gary Paterson, Gergo Panker, Kyrylo Kuzin, Samuele Negri, Joshua Prematta, Artery Studios, Blacksteinn, Marc Orphanos, Tatit Kisyaprakasa</div>\r\n            <div class=\"role-item\"><div class=\"title\">Environment 3D Modeling & Animations</div>Simone Trevisiol, Gianluca Miragoli, Giovanni Fam, Samuele Negri, David Pemberton, Davide Prestino, Ales Ogrinc</div>\r\n            <div class=\"role-item\"><div class=\"title\">Media & Game Cameras Management</div>Pietro Cottone</div>\r\n            <div class=\"role-item\"><div class=\"title\">2D Creative Arts</div>Emanuele Tucciarone</div>\r\n            <div class=\"role-item\"><div class=\"title\">Media Creative Director</div>Claudio Jacuzzi</div>\r\n            <div class=\"role-item\"><div class=\"title\">Test Lead</div>Steffen Lippert</div>\r\n            <div class=\"role-item\"><div class=\"title\">Licensing & Partnership Management</div>Valerio Piersanti</div>\r\n            <div class=\"role-item\"><div class=\"title\">Media, B2B & Licensing Account</div>Ivan Vallelonga</div>\r\n            <div class=\"role-item\"><div class=\"title\">Web & Digital Marketing</div>Francesca Romana D'Alessio</div>\r\n            <div class=\"role-item\"><div class=\"title\">Accounting</div>Manuela Mazzei, Valeria Bozzolan </div>\r\n            <div class=\"role-item\"><div class=\"title\">Backend & Multiplayer Partner</div>Swiss Innovative Arts And Technology Institute (S.I.A.T.I.)</div>\r\n            <div class=\"role-item\"><div class=\"title\">Special Thanks to</div>Stefano Casillo, Aristotelis Vasilakos, David Perel, Misha Charoudin, Clia Martin, Johan Hammes, Dino Grandi</div>\r\n        </div>\r\n    </div>\r\n</div>";

    class Credits extends KsHTMLElement {
     
        /** @type Btnbasic */
        btnBack;

        constructor() {
            super();
            this.template = template$K;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this._bindScrollableEvents = true;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
        }

        onAfterRenderControlHints(controlhints) {
            this.btnBack = q("#btnBack", controlhints);
            
            this.btnBack.onPressed = () => ksUI$1.returnToOrigin();
        }

        bindControls() {

        }

    }

    ksUI$1.registerModule('ks-page-credits', Credits);

    var template$J = "<div class=\"component-body\">\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic class=\"back focusable\" id=\"back\"></ks-btnbasic>\r\n            <ks-btnbasic class=\"apply focusable disabled\" id=\"apply\">\r\n                <div slot=\"name\" data-l10n-id=\"btnApply\">Apply</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"cancel focusable disabled\" id=\"cancel\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCancel\">Cancel</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n\r\n        <div class=\"group center\"></div>\r\n\r\n        <div class=\"group end\">\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\" data-l10n-id=\"headerGeneral\">General</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body\">\r\n        <div class=\"column centered\">\r\n            <ks-slider values='[\"Low\",\"Medium\",\"High\",\"Very High\", \"Ultra\"]'>\r\n                <div slot=\"name\">Option 1\r\n            </div></ks-slider>\r\n\r\n            <ks-slider values='[\"Low\",\"Medium\",\"High\",\"Very High\", \"Ultra\"]'>\r\n                <div slot=\"name\">Option 2\r\n            </div></ks-slider>\r\n\r\n            <ks-slider values='[\"Low\",\"Medium\",\"High\",\"Very High\", \"Ultra\"]'>\r\n                <div slot=\"name\">Option 3\r\n            </div></ks-slider>\r\n\r\n        </div>\r\n\r\n    </div>\r\n</div>";

    class EULA extends KsHTMLElement {

        btnBack;
        chkFullscreen;

        constructor() {
            super();
            this.template = template$J;
            this._isnavigable = true;
        }

        onTemplateLoaded() {
            this.btnBack = q("ks-btnbasic.back", this);
            this.chkFullscreen = q("#fullscreen", this);
            super.onTemplateLoaded();
        }

        bindControls() {

            this.btnBack.onPressed = () => ksUI$1.changePage("settings/main");
            
            if(this.chkFullscreen)
            this.chkFullscreen.addEventListener("click", (ev) => {
                console.log(this.chkFullscreen.state.checked);
            });

        }

    }

    ksUI$1.registerModule('ks-page-eula', EULA);

    class SinglePlayerPage extends KsHTMLElement {

        /** @type MessageHandler */
        GameModeSelectionClient;

        /** @type MessageHandler */
        RacingSettingsClient;

        AllGameModeWeatherData;
        AllAssists;

        currentGameModeWeatherType;
        currentAssistPresetListType;

        #maincontainer;
        #modaldialog;

        #btnBack;
        #btnCar;
        #btnTrack;
        #btnGameMode;

        constructor() {
            super();
            this.template = template$1k;
            this._isnavigable = true;
            this.delayedInit = false;
            this.disableCameraControl = true;
            this.title = engine.translate("headerSinglePlayer");
        }

        updateDataFilters() {
            VEHICLES.updateDataFilters();
        }

        getCurrentWeatherData(current_preset = this.currentGameModeWeatherType) {

            if (this.AllGameModeWeatherData) {
                let current_weather;
                this.AllGameModeWeatherData.forEach(element => {
                    if (element.type == current_preset) {
                        current_weather = element;
                        return false;
                    }
                });
                if (current_weather) {
                    //ksUI.iterate(current_weather);
                    this.assignModel(current_weather, "CurrentWeatherData");
                } else {
                    console.error("Failed to get currently selected GameModeWeatherData", current_preset);
                }

            } else {
                if (CurrentGameMode.weather_data) {
                    this.AllGameModeWeatherData = CurrentGameMode.weather_data;
                    this.getCurrentWeatherData(current_preset);
                } else {
                    console.error("Weather_data missing from GameModeSelectionClientResponseGameModeParameters");
                    ksUI$1.iterate(CurrentGameMode);
                }
                //this.getWeatherData(() => this.getCurrentWeatherData(this.currentGameModeWeatherType));
            }

        }

        getCurrentAssists(current_preset = this.currentAssistPresetListType, force_refresh = false) {
            if (this.AllAssists && !force_refresh) {
                let current_assist;
                this.AllAssists.forEach(element => {
                    if (element.type == current_preset) {
                        current_assist = element;
                        return false;
                    }
                });
                if (current_assist) {
                    this.assignModel(current_assist, "CurrentAssistPreset");
                } else {
                    console.error("Failed to get currentl selected RacingSettingsAssistPreset");
                }
            } else {
                this.RacingSettingsClient.request("AssistPresetList", (data) => {
                    if (data.response == eClientCommands.Response.OK) {
                        this.assignModel(data, "Assists");
                        this.AllAssists = data.presets;
                        this.currentAssistPresetListType = data.current_preset;
                        this.getCurrentAssists(this.currentAssistPresetListType);
                    } else {
                        console.error("Could not retrieve AssistPresetList");
                    }
                });
            }
        }

        getCurrentTrack() {
            this.GameModeSelectionClient.request("CurrentTrack", {
                mode: eClientCommands.Mode.Single
            }, (data) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        this.assignModel(data.track_item, "CurrentTrack");
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Received", data.response);
                    }
                }[data.response])();
            });
        }

        getCurrentGameMode(callback) {
            console.log("Requesting game mode parameters");
            this.GameModeSelectionClient.request("GameModeParameters", {
                mode: eClientCommands.Mode.Single
            }, (data) => {
                console.log("Received game mode parameters");
                ({
                    [eClientCommands.Response.OK]: () => {
                        this.assignModel(data, "CurrentGameMode");

                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Received", data.response);
                    }
                }[data.response])();

                if (callback)
                    callback(data);

            });
        }

        bindControls() {


        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            ksUI$1.Models.disable(DataModels.SessionState);
            // this.assignModel(this.CarSelection.currentCar, "CurrentCar");

            this.GameModeSelectionClient = this.getMessageHandler("GameModeSelectionClient");
            this.RacingSettingsClient = this.getMessageHandler("RacingSettings");

            //VEHICLES.resetFilters();
            VEHICLES.updateDataFilters();
            VEHICLES.getCurrent();
            GAMEMODESELECTION.getGameModeParameters().then(data => {
                this.currentGameModeWeatherType = data.weather_type;
                this.getCurrentWeatherData(this.currentGameModeWeatherType);
            });

            this.getCurrentTrack();
            this.getCurrentAssists();
            console.log("Entering singleplayer");
            document.body.classList.add("singleplayer");

            //this.cars.getCurrent();
        }

        onRemovedFromDOM() {
            console.log("singleplayer removed");
            document.body.classList.remove("singleplayer");
            VEHICLES.clearHandlers();
        }

    }
    engine.on("MenuStateInit", () => {
        ksUI$1.registerModule('ks-page-singleplayer', SinglePlayerPage);
    });

    var template$I = "<div class=\"component-body\">\r\n\r\n    <div id=\"acelogo\"></div>\r\n\r\n    <!-- <ks-playerprogress></ks-playerprogress> -->\r\n\r\n    <ks-page-multiplayer-hub opaque class=\"submode renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'hub'\">\r\n    </ks-page-multiplayer-hub>\r\n\r\n    <ks-page-serverlist opaque class=\"submode renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'serverlist'\">\r\n    </ks-page-serverlist>\r\n\r\n    <ks-page-specialevents opaque class=\"submode renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'specialevents'\">\r\n    </ks-page-specialevents>\r\n\r\n    <ks-page-carselection garage multiplayer class=\"submode carselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'carselection'\">\r\n    </ks-page-carselection>\r\n\r\n    <ks-page-brandselection opaque garage multiplayer class=\"submode brandselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'brandselection'\">\r\n    </ks-page-brandselection>\r\n\r\n    <ks-page-modelselection opaque garage multiplayer class=\"submode modelselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'modelselection'\">\r\n    </ks-page-modelselection>\r\n\r\n    <ks-page-vehiclepresetselection garage multiplayer class=\"submode presetselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'presetselection'\">\r\n    </ks-page-vehiclepresetselection>\r\n\r\n</div>";

    var template$H = "<div class=\"component-body\" data-mode=\"home\" data-bind-class-toggle=\"\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n\r\n            <ks-btnbasic id=\"btnBack\" class=\"back focusable test\" path=\"{activeMenu}/main\">\r\n            </ks-btnbasic>\r\n            \r\n            <ks-btnbasic class=\"apply focusable\" id=\"btnConfirm\" disabled=\"disabled\">\r\n                <div slot=\"name\" data-l10n-id=\"btnConfirm\">Apply</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic class=\"focusable\" id=\"btnPurchase\">\r\n                <div slot=\"name\" data-l10n-id=\"btnPurchase\">Purchase</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic class=\"focusable\" id=\"btnTestDrive\">\r\n                <div slot=\"name\" data-l10n-id=\"btnTestDrive\">Test Drive</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic class=\"focusable\" id=\"btnConfigure\" path=\"{activeMenu}/customize\" disabled=\"disabled\">\r\n                <div slot=\"name\" data-l10n-id=\"btnConfigure\">Configure</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic class=\"focusable\" id=\"btnDealership\">\r\n                <div slot=\"name\" data-bind-if=\"!{{ModelUIState}}.is_sandbox\" data-l10n-id=\"panelDealership\"></div>\r\n                <div slot=\"name\" data-bind-if=\"{{ModelUIState}}.is_sandbox\" data-l10n-id=\"lblCarHub\"></div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic class=\"focusable\" id=\"btnRent\">\r\n                <div slot=\"name\" data-l10n-id=\"panelRent\">Rent</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic class=\"focusable\" id=\"btnRemove\" data-bind-disablevalue=\"{{ModelUIState}}.garage_cars_count < 2\">\r\n                <div slot=\"name\" data-l10n-id=\"lblRemoveVehicle\">REMOVE VEHICLE</div>\r\n            </ks-btnbasic>\r\n\r\n        </div>\r\n        <div class=\"group end\">\r\n\r\n            <ks-btnbasic class=\"focusable\" id=\"btnSceneControls\" toggle>\r\n                <div slot=\"icon\"></div>\r\n            </ks-btnbasic>\r\n\r\n\r\n            <ks-btnbasic class=\"focusable\" id=\"btnCarControls\" toggle>\r\n                <div slot=\"icon\"></div>\r\n            </ks-btnbasic>\r\n\r\n        </div>\r\n\r\n    </component-slot>\r\n\r\n    <component-slot data-name=\"header\">\r\n        <ks-pageheader class=\"minimal\">\r\n            <div id=\"labelHeader\" slot=\"label\" data-l10n-id=\"headerCarSelection\">Car Selection</div>\r\n        </ks-pageheader>\r\n    </component-slot>\r\n\r\n    <div class=\"submode-body centered-content\">\r\n        <!-- \r\n        <div class=\"car-info-table is-flex-column\">\r\n            <div class=\"title\" data-l10n-id=\"labelSpecifications\">\r\n\r\n            </div>\r\n            <div class=\"specs is-table\">\r\n                <div class=\"is-flex-row\">\r\n                    <span class=\"label\">Displacement</span>\r\n                    <span class=\"value flex-1 justify-content-end\">1368</span><span class=\"suffix\">c.c.</span>\r\n                </div>\r\n                <div class=\"is-flex-row\">\r\n                    <span class=\"label\">Engine Layout</span>\r\n                    <span class=\"value flex-1 justify-content-end\">inline, 4 cylinder</span>\r\n                </div>\r\n\r\n                <div class=\"is-flex-row\">\r\n                    <span class=\"label\">Power</span>\r\n                    <span class=\"value flex-1 justify-content-end\">190</span><span class=\"suffix\">hp</span>\r\n                </div>\r\n\r\n                <div class=\"is-flex-row\">\r\n                    <span class=\"label\">Drivetrain</span>\r\n                    <span class=\"value flex-1 justify-content-end\">FWD</span>\r\n                </div>\r\n\r\n                <div class=\"is-flex-row\">\r\n                    <span class=\"label\">Transmission</span>\r\n                    <span class=\"value flex-1 justify-content-end\">Manual</span>\r\n                </div>\r\n\r\n                <div class=\"is-flex-row\">\r\n                    <span class=\"label\">Weight Power Ratio</span>\r\n                    <span class=\"value flex-1 justify-content-end\">5.2</span><span class=\"suffix\">kg/hp</span>\r\n                </div>\r\n            </div>\r\n            <div class=\"version\">\r\n\r\n            </div>\r\n            <div class=\"trim\"></div>\r\n        </div> -->\r\n\r\n        <!-- <div id=\"panelCarControls\" class=\"row car-controls is-flex-column\"> -->\r\n        <ks-showroomcarcontrol data-mode=\"electrics\" id=\"controlCar\"></ks-showroomcarcontrol>\r\n        <!-- </div> -->\r\n\r\n        <!-- <div id=\"panelSceneControls\" class=\"row car-controls is-flex-column\"> -->\r\n        <ks-showroomscenecontrol data-mode=\"\" id=\"controlScene\"></ks-showroomscenecontrol>\r\n        <!-- </div> -->\r\n\r\n        <div class=\"car-brand-selectors row\">\r\n            <ks-btnpanel id=\"btnBrandSelect\" class=\"focusable brand defaultfocus\" data-bind-ksmessage=\"{{CurrentCar.model.manufacturer}}\" path=\"{activeMenu}/brandselection\">\r\n                <div slot=\"subtitle\">BRAND</div>\r\n            </ks-btnpanel>\r\n\r\n            <div class=\"model-info is-flex-column\">\r\n\r\n                <div class=\"tag price dealership row\">\r\n                    <i class=\"icon svg-icon-credits\"></i>\r\n                    <div class=\"label row align-items-center\"><span class=\"value\" data-bind-value=\"{{CurrentCar.model.price}}\"></span><span class=\"suffix\">v$</span></div>\r\n                </div>\r\n\r\n                <div class=\"tag license dealership row\">\r\n                    <i class=\"icon svg-icon-license\"></i>\r\n                    <div class=\"label row align-items-center\"><span class=\"value\" data-bind-value=\"{{CurrentCar.model.required_rank}}\">ENTRY LICENSE</span></div>\r\n                </div>\r\n\r\n                <ks-btnpanel id=\"btnModelSelection\" class=\"focusable model\" path=\"{activeMenu}/modelselection\">\r\n                    <div slot=\"title\" data-bind-value=\"{{CurrentCar.model.display_name}}\">SELECT MODEL</div>\r\n                    <div slot=\"subtitle\" class=\"price-tag\" data-bind-value=\"{{CurrentCar.model.price}} + ' v$'\">PRICE</div>\r\n                </ks-btnpanel>\r\n            </div>\r\n\r\n            <ks-btnpanel id=\"btnPresetSelection\" class=\"focusable preset\" path=\"{activeMenu}/presetselection\">\r\n                <div slot=\"title\" data-bind-value=\"{{CurrentCar.model.translated.mech}}\"></div>\r\n                <div slot=\"subtitle\" data-bind-value=\"{{CurrentCar.model.translated.visual}}\">VARIANT</div>\r\n            </ks-btnpanel>\r\n        </div>\r\n\r\n    </div>\r\n\r\n</div>";

    class CarSelectionPage extends BaseCarSelectionPage {


        labelHeader;
        returnPath;

        /** @type {Btnbasic} */
        btnPurchase;
        /** @type {Btnbasic} */
        btnBack;
        /** @type {Btnbasic} */
        btnConfirm;
        /** @type {Btnbasic} */
        btnConfigure;
        /** @type {Btnbasic} */
        btnTestDrive;
        /** @type {Btnbasic} */
        btnCarControls;
        /** @type {Btnbasic} */
        btnSceneControls;
        /** @type {Btnbasic} */
        btnDealership;
        /** @type {Btnbasic} */
        btnBrandSelect;
        /** @type {Btnbasic} */
        btnRent;
        /** @type {Btnbasic} */
        btnRemove;


        /** @type {ShowroomCarControl} */
        controlCar;

        /** @type {ShowroomSceneControl} */
        controlScene;


        constructor() {
            super();
            this.template = template$H;
            this._exposeAsActivePage = true;
            this._isnavigable = true;
            this.delayedInit = true;

        }

        bindControls() {
            ksUI$1.menuState.delFromStore("caller");

            let buttons = qAll("ks-btnbasic.back, ks-btnbasic.confirm", this.mainControlhints());

            if (ksUI$1.menuState.isValid()) {
                if (ksUI$1.menuState.getOrigin()[0].indexOf("singleplayer") == -1 && !document.body.classList.contains("singleplayer")) {

                    for (let i = 0; i < buttons.length; i++) {
                        buttons[i].setAttribute("path", ksUI$1.menuState.getOrigin()[1]);
                        //console.log("set path to", buttons[i].className, buttons[i].getAttribute("path"));
                    }
                }
            }

            if (this.returnPath) {
                for (let i = 0; i < buttons.length; i++) {
                    buttons[i].setAttribute("path", this.returnPath);
                    console.log("set path to", buttons[i].className, buttons[i].getAttribute("path"));
                }
            }

        }

        onAfterRenderControlHints(controlhints) {


            this.mapElementById("btnPurchase", controlhints);
            this.mapElementById("btnBack", controlhints);
            this.mapElementById("btnConfirm", controlhints);
            this.mapElementById("btnConfigure", controlhints);
            this.mapElementById("btnTestDrive", controlhints);
            this.mapElementById("btnCarControls", controlhints);
            this.mapElementById("btnSceneControls", controlhints);
            this.mapElementById("btnDealership", controlhints);
            this.mapElementById("btnRent", controlhints);
            this.mapElementById("btnRemove", controlhints);


            if (isSandBox) {
                this.btnPurchase.setLabelId("btnAddToGarage");

            }

            console.log(this.classList);

            if (document.body.classList.contains("singleplayer") || document.body.classList.contains("multiplayer")) {
                q("#btnBack [data-l10n-id]", controlhints).dataset.l10nId = "btnConfirm";
            }

            if (this.btnDealership) {
                this.btnDealership.onPressed = (sender, e) => {
                    localStorage.setItem("backTo", ksUI$1.menuState.getCurrentLocation().join("|"));
                    ksUI$1.goTo("vehicles.html", "dealership/brandselection", false);
                };


            }

            if (this.isDealership() || this.isRental()) {

                if ((isCareer && CurrentCar.model.is_enabled && CurrentCar.model.price_final <= ModelUIDriverState.money) || isSandBox) {

                    if (this.btnPurchase)
                        this.btnPurchase.removeAttribute("disabled");

                    if (this.btnRent)
                        this.btnRent.removeAttribute("disabled");

                } else {
                    if (this.btnPurchase)
                        this.btnPurchase.setAttribute("disabled", "disabled");

                    if (this.btnRent)
                        this.btnRent.setAttribute("disabled", "disabled");

                }

            }

            this.btnTestDrive.onPressed = (e) => {

                if (this.isFirstPurchace()) {
                    console.log("Test drive requested on first purchase", CurrentCar.model.name);

                    this.pageModal.onConfirm = () => {
                        console.log("Test drive", CurrentCar.model.name);
                        ksUI$1.goTo("settings.html");
                        // ECONOMY.buyCar(CurrentCar.model, (response) => {
                        //     console.log("Received", response);
                        //     if (response == eGameEconomy.Response.OK) {
                        //         engine.trigger("OnCarPurchased", CurrentCar.model);
                        //     } else if (response == eGameEconomy.Response.CriticalError) {
                        //         this.errorModal("lblError", "msgCannotPurchaseVehicle", false, () => { this.pageModal.Hide(); });
                        //         console.error("Could not purchase", CurrentCar.model.name)
                        //     } else if (response == eGameEconomy.Response.NoMoney) {
                        //         this.errorModal("lblInsufficientFunds", "msgNotEnoughMoneyToBuyVehicle", false, () => { this.pageModal.Hide(); });
                        //         console.log("Could not purchase", CurrentCar.model.name, "due to lack of funds")
                        //     }
                        // });
                    };

                    this.pageModal.onDiscard = () => {
                        ksUI$1.setCurrentAsReturnPage();
                        GAMEMODESELECTION.testDrive(CurrentCar.model, (response) => {
                        });
                    };

                    this.pageModal.Show({
                        type: eModalDialogTypes.Standard,
                        title: "lblWarning",
                        message: "msgFirstTestDrive",
                        confirm: "btnProceedToSettings",
                        discard: "btnStartSession",
                        buttons: 0x111
                    });
                } else {
                    ksUI$1.setCurrentAsReturnPage();
                    GAMEMODESELECTION.testDrive(CurrentCar.model, (response) => {
                    });
                }
            };

            this.btnRemove.onPressed = (sender, e) => {
                console.log("Removing car", CurrentCar.model.name);

                this.pageModal.onConfirm = () => {
                    console.log("Removed car", CurrentCar.model.name);

                    ECONOMY.removeCar(CurrentCar.model.car_pguid, (response) => {
                        console.log("Received", response);
                        if (response == eGameEconomy.Response.OK) {
                            VEHICLES.getCurrent();
                            document.body.dataset.carstate = CurrentCar.state;
                        } else if (response == eGameEconomy.Response.CriticalError) {
                            this.errorModal("lblError", "msgCannotRemoveVehicle", false, () => { this.pageModal.Hide(); });
                            console.error("Could not remove", CurrentCar.model.name);
                        }
                    });
                };

                this.pageModal.Show({
                    type: eModalDialogTypes.Standard,
                    titleText: CurrentCar.model.display_name,
                    message: isSandBox ? "msgAreYouSureRemoveFromGarage" : "msgAreYouSureSell",
                    confirm: isSandBox ? "lblRemoveVehicle" : "btnSell",
                    buttons: 0x101
                });

                this.pageModal.onHide = () => {
                    if (ksUI$1.isSpatialNav()) {
                        waitForFrames(() => {
                            this.btnRemove.focus();
                        }, 1);
                    }
                };

            };

            this.btnPurchase.onPressed = (sender, e) => {

                console.log("Buying car", CurrentCar.model.name);

                this.pageModal.onConfirm = () => {
                    console.log("Bought car", CurrentCar.model.name);

                    ECONOMY.buyCar(CurrentCar.model, (response) => {
                        console.log("Received", response);
                        if (response == eGameEconomy.Response.OK) {
                            VEHICLES.getCurrent();
                            this.btnPurchase.disable();
                            this.btnConfigure.setLabelId("btnCustomize");
                            this.btnConfigure.setLabelId("btnCustomize");
                            this.btnConfigure.removeAttribute("path");
                            this.btnConfigure.onPressed = () => {
                                ksUI$1.setCurrentAsReturnPage();
                                //ksUI.showLoadingModal();
                                ksUI$1.requestNoResponse("CarCustomization", "GoToGarage");
                            };

                            document.body.dataset.carstate = CurrentCar.state;

                            engine.trigger("OnCarPurchased", CurrentCar.model);
                        } else if (response == eGameEconomy.Response.CriticalError) {
                            this.errorModal("lblError", "msgCannotPurchaseVehicle", false, () => { this.pageModal.Hide(); });
                            console.error("Could not purchase", CurrentCar.model.name);
                        } else if (response == eGameEconomy.Response.NoMoney) {
                            this.errorModal("lblInsufficientFunds", "msgNotEnoughMoneyToBuyVehicle", false, () => { this.pageModal.Hide(); });
                            console.log("Could not purchase", CurrentCar.model.name, "due to lack of funds");
                        }
                    });
                };

                this.pageModal.Show({
                    type: eModalDialogTypes.Standard,
                    titleText: CurrentCar.model.display_name,
                    message: isSandBox ? "msgAreYouSureAddToGarage" : "msgAreYouSurePurchaseVehicle",
                    confirm: isSandBox ? "btnAddToGarage" : "btnPurchase",
                    buttons: 0x101
                });

            };

            this.btnBack.onBeforeRedirect = () => {

                if (isSandBox && document.body.classList.contains("singleplayer")) {
                    this.btnBack.setAttribute("path", "{activeMenu}/main");
                }

                this.rootPage.enteredCarSelection = false;

                if (this.isDealership()) {
                    VEHICLES.resetFilters();
                    ksUI$1.requestGoBack(eGameModeSelection.BackFrom.Dealership);
                    ksUI$1.changePage(`${ksUI$1.menuState.get().activeMenu}/brandselection`);
                    return false;
                    //ksUI.requestGoBack(this.isUsedVehicles() ? eGameModeSelection.BackFrom.Unknown : eGameModeSelection.BackFrom.Dealership);
                } else if (this.isRental()) {
                    VEHICLES.resetFilters();
                    ksUI$1.requestGoBack(eGameModeSelection.BackFrom.Rental);
                    ksUI$1.changePage(`${ksUI$1.menuState.get().activeMenu}/brandselection`);
                    return false;
                } else {
                    ksUI$1.requestGoBack(eGameModeSelection.BackFrom.Garage);
                }
                if (ksUI$1.menuState.isOriginMainMenu || this.closest("ks-page-vehicles")) {
                    ksUI$1.goTo("menu.html", "main/main");
                }

            };


            this.btnConfirm.onBeforeRedirect = () => {
                this.rootPage.enteredCarSelection = false;
                ksUI$1.requestGoBack(eGameModeSelection.BackFrom.Garage);
            };

            if (this.isDealership() || this.isGarage()) {
                this.btnConfigure.removeAttribute("disabled");
                this.btnRent.remove();
            }

            if (this.isRental()) {
                this.btnConfigure.remove();
                this.btnDealership.remove();
            }

            //if (this.isDealership()) {
            //  $.q("div", this.btnBack).setAttribute("data-l10n-id", "btnExit");
            //}

            if (this.isGarage() && CurrentCar.model.ownership_state == eCarSelection.State.Owned) {
                localStorage.removeItem("backTo");
                this.btnConfigure.setLabelId("btnCustomize");
                this.btnConfigure.removeAttribute("path");
                this.btnConfigure.onPressed = () => {
                    ksUI$1.setCurrentAsReturnPage();
                    //ksUI.showLoadingModal();
                    ksUI$1.requestNoResponse("CarCustomization", "GoToGarage");
                };
            } else {
                this.btnConfigure.onBeforeRedirect = () => {
                    ksUI$1.menuState.overrideShowcaseCamera(true, false);
                    ksUI$1.setCurrentAsReturnPage();
                };
            }

            this.btnCarControls.onPressed = () => {
                const showing = this.classList.toggle("show-carcontrol");
                if (showing) {
                    this.setupNavigation();
                    this.controlCar.show();
                }
                //this.dataset.mode = this.dataset.mode == "carcontrol" ? "" : "carcontrol";
            };


            this.btnSceneControls.onPressed = () => {
                const showing = this.classList.toggle("show-scenecontrol");
                if (showing) {
                    this.setupNavigation();
                    this.controlScene.show();
                }
                //this.dataset.mode = this.dataset.mode == "carcontrol" ? "" : "carcontrol";
            };

            this.btnRent.onPressed = () => {
                console.log("Renting car", CurrentCar.model.name);

                this.pageModal.onConfirm = () => {
                    console.log("Rented car", CurrentCar.model.name);
                    ECONOMY.rentCar(CurrentCar.model, (response) => {
                        console.log("Received", response);
                        if (response == eGameEconomy.Response.OK) {
                            ksUI$1.requestGoBack(eGameModeSelection.BackFrom.Rental);
                            ksUI$1.goTo("singleplayer.html", "main/main");
                        } else if (response == eGameEconomy.Response.CriticalError) {
                            this.errorModal("lblError", "msgCannotRentVehicle", false, () => { this.pageModal.Hide(); });
                            console.error("Could not rent", CurrentCar.model.name);
                        } else if (response == eGameEconomy.Response.NoMoney) {
                            this.errorModal("lblInsufficientFunds", "msgNotEnoughMoneyToRentVehicle", false, () => { this.pageModal.Hide(); });
                            console.log("Could not rent", CurrentCar.model.name, "due to lack of funds");
                        }
                    });

                };

                this.pageModal.Show({
                    type: eModalDialogTypes.Standard,
                    title: "lblRentingVehicle",
                    message: "msgAreYouSureRentingVehicle",
                    buttons: 0x101
                });
            };

            if (ksUI$1.menuState.get().activeMenu == "multiplayer") {
                this.btnBack.setAttribute("path", "multiplayer/serverlist");
            }
            //ksUI.menuState.storeOrigin().save();
        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();
            delete document.body.dataset.carstate;
            waitForFrames(() => {
                ksUI$1.menuState.toggleMouseHover(true);
            }, 1);
            ksUI$1.removeClasses(this.documentBody, "carselection", "dealership");
            VEHICLES.clearHandlers();

            console.warn(">>>>", document.body.className);
            if (!document.body.classList.contains("singleplayer")) {
                VEHICLES.resetFilters();
            }
            SHOWROOM.resetCarState();

            ksUI$1.menuState.overrideShowcaseCamera(false);
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            ksUI$1.menuState.overrideShowcaseCamera(true);

            waitForFrames(() => {
                ksUI$1.menuState.toggleMouseHover(false);
            }, 1);

            this.mapElementById("btnBrandSelect");
            this.mapElementById("controlCar");
            this.mapElementById("controlScene");
            this.mapElementById("labelHeader");


            this.btnBrandSelect.onBeforeRedirect = () => {
                ksUI$1.menuState.addToStore("caller", "carselection");
                return true;
            };

            if (this.isGarage() && !this.isMultiPlayer() && !this.isSinglePlayer()) {
                VEHICLES.dataFilters.ownershipState = eCarSelection.State.Owned;
            } else if (this.isDealership()) {
                VEHICLES.dataFilters.ownershipState = eCarSelection.State.Dealership;
            } else if (this.isFirstPurchace()) {
                VEHICLES.dataFilters.ownershipState = eCarSelection.State.FirstPurchace;
            } else if (this.isRental()) {
                VEHICLES.dataFilters.ownershipState = eCarSelection.State.Rental;
            }

            VEHICLES.updateDataFilters();

            let title = this.getAttribute("title");

            this.returnPath = this.getAttribute("returnPath");

            if (title) {
                const mode_specific_title = title.split("/");
                if (mode_specific_title.length > 1) {
                    this.labelHeader.dataset.l10nId = isCareer ? mode_specific_title[0] : mode_specific_title[1];
                } else {
                    this.labelHeader.dataset.l10nId = title;
                }

            }

            this.documentBody.classList.add("carselection");

            VEHICLES.getCurrent();

            if (window["CurrentCar"]) {
                document.body.dataset.carstate = CurrentCar.state;
            }

            localStorage.removeItem("textfilter_modelselection");

            if (this.isMultiPlayer()) {
                localStorage.setItem("carselection_visited", true);
            }

            this.rootPage.enteredCarSelection = true;
        }

    }
    ksUI$1.registerModule('ks-page-carselection', CarSelectionPage);

    var template$G = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" goto=\"menu.html\" path=\"main/main\" class=\"back rounded focusable\"></ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\" data-l10n-id=\"headerMultiplayer\">Multi Player</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body\">\r\n        <div class=\"row large centered-content\">\r\n\r\n            <ks-btnpanel id=\"btnServerList\" class=\"focusable\" path=\"multiplayer/serverlist\" storeorigin=\"true\">\r\n                <div slot=\"title\" data-l10n-id=\"panelServerList\"></div>\r\n                <div slot=\"subtitle\"></div>\r\n            </ks-btnpanel>\r\n\r\n            <ks-btnpanel id=\"btnSpecialEvents\" class=\"focusable\" path=\"multiplayer/specialevents\" storeorigin=\"true\">\r\n                <div slot=\"title\" data-l10n-id=\"panelSpecialEvents\"></div>\r\n                <div slot=\"subtitle\"></div>\r\n            </ks-btnpanel>\r\n\r\n            <ks-btnpanel id=\"btnPortal\" class=\"focusable\">\r\n                <div slot=\"title\" data-l10n-id=\"panelPortal\"></div>\r\n                <div slot=\"subtitle\">\r\n                </div>\r\n            </ks-btnpanel>\r\n\r\n        </div>\r\n\r\n        \r\n    </div>\r\n\r\n</div>";

    class MultiPlayerHub extends KsHTMLElement {

        /** @type {Btnbasic} */
        btnPortal;

        /** @@type {{MessageHandler}} */
        GameModeClient;
       
        constructor() {
            super();
            this.template = template$G;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this.delayedInit = false;
        }

        filters = {
        }

        bindControls() {
            if (this.btnPortal)
                    this.btnPortal.onPressed = () => {                    
                        this.GameModeClient.request("OpenUrl", {
                                    url: "https://acevo.gg/"
                                }, (response) => {                    
                                ({
                                    [eClientCommands.Response.OK]: () => {
                                        console.log("AC portal launched!");                                        
                                    },
                                    [eClientCommands.Response.CriticalError]: () => {
                                        console.warn("AC portal failed to launch!");                                        
                                    }                                    
                                }[response.response])();
                        });
                };

        }
       
        onTemplateLoaded() {
            super.onTemplateLoaded();       
            this.mapElementById("btnPortal");

            this.GameModeClient = new MessageHandler("GameModeSelectionClient");
        }

    }

    ksUI$1.registerModule('ks-page-multiplayer-hub', MultiPlayerHub);

    var template$F = "<div class=\"serverlist-body component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" data-sn-down=\"#btnRefresh\" class=\"back rounded focusable\">\r\n            </ks-btnbasic>\r\n            <ks-btnbasic id=\"btnAssists\" class=\"focusable\" goto=\"singleplayer.html\" path=\"singleplayer/assists\">\r\n                <div slot=\"name\" data-l10n-id=\"panelAssists\">Assists</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\" data-l10n-id=\"headerServerList\">Server List</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body columns\">\r\n\r\n        <div class=\"column column-75\">\r\n            <div class=\"row controls-wrapper\">\r\n                <ks-btnbasic id=\"btnRefresh\" data-sn-right=\"#txtSearch\" data-sn-up=\"#btnBack\" class=\"focusable\">\r\n                    <div slot=\"icon\"></div>\r\n                    <div slot=\"name\" data-l10n-id=\"btnRefresh\">Refresh</div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-textinput id=\"txtSearch\" class=\"focusable\" data-sn-right=\"#btnFilterByCar\" data-sn-up=\"#btnBack\">\r\n                    <div slot=\"placeholder\" data-l10n-id=\"lblSearchServers\"></div>\r\n                </ks-textinput>\r\n\r\n                <!-- \r\n                                <ks-btnbasic id=\"btnLan\" class=\"focusable\" toggle=\"true\">\r\n                    <div slot=\"name\" data-l10n-id=\"btnLan\">LAN</div>\r\n                </ks-btnbasic>\r\n\r\n\r\n-->\r\n                <div id=\"labelServersNumber\"></div>\r\n\r\n                <div class=\"is-flex-row flex-1 justify-content-end\">\r\n                    <div id=\"panelFilters\" class=\"labeledpanel filters\">\r\n                        <div class=\"label\" data-l10n-id=\"lblFiltersUpper\"></div>\r\n                        <div class=\"items\">\r\n                            <ks-btnbasic id=\"btnFilterByTrackday\" class=\"focusable btnfilter\" data-filter=\"trackday\" data-tooltip=\"tooltipShowTrackday\" toggle toggle-group=\"gametype\" distinct-values allownonetoggled>\r\n                                <div slot=\"icon\"></div>\r\n                            </ks-btnbasic>\r\n\r\n                            <ks-btnbasic id=\"btnFilterByRaceweekend\" class=\"focusable btnfilter\" data-filter=\"race\" data-tooltip=\"tooltipShowRaceServer\" toggle toggle-group=\"gametype\" distinct-values allownonetoggled>\r\n                                <div slot=\"icon\"></div>\r\n                            </ks-btnbasic>\r\n\r\n                            <ks-btnbasic id=\"btnFilterByNotRace\" class=\"focusable btnfilter\" data-filter=\"notrace\" data-tooltip=\"tooltipShowServersNotInRaceSession\" toggle>\r\n                                <div slot=\"icon\"></div>\r\n                            </ks-btnbasic>\r\n\r\n                            <ks-btnbasic id=\"btnFilterByCar\" class=\"focusable btnfilter\" data-filter=\"eligible_car\" data-tooltip=\"tooltipShowServerEligibleCars\" toggle>\r\n                                <div slot=\"icon\"></div>\r\n                            </ks-btnbasic>\r\n\r\n                            <ks-btnbasic id=\"btnFilterNoPassword\" class=\"focusable btnfilter\" data-filter=\"no_password\" data-tooltip=\"tooltipShowServerUnlocked\" toggle>\r\n                                <div slot=\"icon\"></div>\r\n                            </ks-btnbasic>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"sorting labeledpanel\">\r\n                        <div id=\"lblSortBy\" class=\"label\" data-l10n-id=\"labelSortBy\">\r\n                        </div>\r\n\r\n                        <div class=\"items\">\r\n                            <ks-btnbasic id=\"btnSortPlayers\" data-filter=\"by_players\" class=\"focusable\" toggle stoggle-group=\"sorting\" data-tooltip=\"tooltipSortServersByPlayerCount\">\r\n                                <div slot=\"icon\"></div>\r\n                            </ks-btnbasic>\r\n                            <ks-btnbasic id=\"btnSortPing\" data-filter=\"by_ping\" class=\"focusable\" toggle stoggle-group=\"sorting\" data-tooltip=\"tooltipSortServersByPing\">\r\n                                <div slot=\"icon\"></div>\r\n                            </ks-btnbasic>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n\r\n            </div>\r\n            <div id=\"wrapperServerList\" class=\"row full serverlist-wrapper\">\r\n                <div id=\"listServers\" class=\"scrollable-vertical\">\r\n                    <div class=\"scrollable-content per-item-list\">\r\n                        <!-- <ks-serverentry\r\n                            class=\"focusable\"\r\n                            data-bind-for=\"item:{{ServerList.entry}}\"\r\n                            data-bind-ksvalue=\"{{item.server_id}}\">\r\n                        </ks-serverentry> -->\r\n                    </div>\r\n                </div>\r\n                <div id=\"lblLoading\" class=\"connection-message\">\r\n                    <span data-l10n-id=\"msgLoadingSession\"></span>\r\n                </div>\r\n                <div id=\"lblError\" class=\"connection-message\">\r\n                    <span data-l10n-id=\"BACKENDDISCONNECTED\"></span>\r\n                </div>\r\n                <div id=\"lblNoServers\">\r\n                    <span data-l10n-id=\"lblNoServersFound\"></span>\r\n                </div>\r\n            </div>\r\n\r\n            <div id=\"panelServerCount\">\r\n                <div class=\"value\">0</div>/<div class=\"total\">0</div>\r\n                <div id=\"panelPlayerCount\">\r\n                    <div class=\"value\">0</div>/<div class=\"total\">0</div>\r\n                </div>\r\n            </div>\r\n\r\n        </div>\r\n\r\n        <div class=\"column column-25 right\">\r\n\r\n            <div class=\"is-flex btn-container\">\r\n                <ks-btnbasic id=\"btnJoin\" class=\"focusable\" disabled=\"disabled\">\r\n                    <div slot=\"name\" data-l10n-id=\"btnJoin\">Join</div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic id=\"btnSpectate\" class=\"focusable\" disabled=\"disabled\">\r\n                    <div slot=\"name\" data-l10n-id=\"btnSpectate\">Spectate</div>\r\n                </ks-btnbasic>\r\n\r\n                <ks-btnbasic id=\"btnClipboard\" class=\"focusable\" data-tooltip=\"tooltipServerFromClipboard\" disabled=\"disabled\">\r\n                    <div slot=\"icon\"></div>\r\n                </ks-btnbasic>\r\n                \r\n            </div>\r\n\r\n            <ks-textinput id=\"txtPassword\" class=\"focusable\" password disabled=\"disabled\">\r\n                <div slot=\"placeholder\"><span data-l10n-id=\"lwrPassword\"></span></div>\r\n            </ks-textinput>\r\n\r\n\r\n            <div class=\"serverinfo\" data-bind-class-toggle=\"unresponsive:{{CurrentServer}}.ping == -1\">\r\n                <div class=\"no-server-selected\">No server selected</div>\r\n                <div class=\"servername\" data-bind-value=\"APF()?.server_name_overflow({{CurrentServer}}.server_name)\"></div>\r\n                <div class=\"eventname\" data-bind-value=\"{{CurrentServer}}.eventLocalized\"></div>\r\n                <div class=\"trackname\" data-bind-value=\"ksUI.concat(' ', {{CurrentServer}}.track,{{CurrentServer}}.layout)\"></div>\r\n                <div class=\"serverproperties\">\r\n                    <div class=\"password\" data-bind-if=\"{{CurrentServer}}.driver_password\" data-l10n-id=\"lblRequiresPassword\"></div>\r\n                    <div class=\"ping\">\r\n                        <div class=\"value\" data-bind-value=\"{{CurrentServer}}.ping == 0 ? '--' : {{CurrentServer}}.ping\"></div>ms\r\n                    </div>\r\n                </div>\r\n                <div class=\"unresponsive\" data-l10n-id=\"lblServerUnresponsive\"></div>\r\n                <ks-btnbasic id=\"btnShowServer\" class=\"focusable\" disabled=\"disabled\">\r\n                    <div slot=\"icon\"></div>\r\n                    <div slot=\"name\" data-l10n-id=\"btnScrollToServer\">Spectate</div>\r\n                </ks-btnbasic>\r\n            </div>\r\n\r\n            <ks-btnpanel id=\"btnCarSelect\" class=\"focusable brand hide-car-list\" data-bind-ksmessage=\"{{CurrentCar.model}}\" path=\"multiplayer/brandselection\">\r\n                <div slot=\"title\">\r\n                    <div class=\"config-name\"><span class=\"value\" data-bind-value=\"{{CurrentCar.model.translated.mech}}\"></span></div>\r\n                    <div class=\"trim-name\"><span class=\"value\" data-bind-value=\"{{CurrentCar.model.translated.visual}}\"></span></div>\r\n\r\n                </div>\r\n                <div slot=\"subtitle\">\r\n                    <div class=\"badge\"></div>\r\n                    <div class=\"model_name name\" data-bind-value=\"{{CurrentCar.model.display_name}}\"></div>\r\n                </div>\r\n                <div slot=\"extra\" class=\"extra-wrapper\">\r\n                    <div id=\"notification\">\r\n                        <div slot=\"label\"></div>\r\n                    </div>\r\n\r\n                </div>\r\n            </ks-btnpanel>\r\n\r\n            <div class=\"car-list scrollable-vertical\">\r\n                <div class=\"label\" data-l10n-id=\"lblEligibleCarsUpper\">ELIGIBLE CARS</div>\r\n                <div class=\"scrollable-content per-item-scroll\">\r\n                    Car List\r\n                </div>\r\n\r\n            </div>\r\n\r\n\r\n            <!-- <div data-l10n-id=\"lblMainClasses\"></div> -->\r\n            <!-- <div class=\"labeledpanel carcategories\">\r\n                <div class=\"label\">MAIN CLASSES</div>\r\n                <div class=\"items\">\r\n                    <ks-btnbasic class=\"focusable btnfilter\" data-filter=\"evo\" toggle=\"true\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblCarEVO\"></div>\r\n                    </ks-btnbasic>\r\n                    <ks-btnbasic class=\"focusable btnfilter\" data-filter=\"luxury\" toggle=\"true\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblCarLUXURY\"></div>\r\n                    </ks-btnbasic>\r\n                    <ks-btnbasic class=\"focusable btnfilter\" data-filter=\"heritage\" toggle=\"true\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblCarHERITAGE\"></div>\r\n                    </ks-btnbasic>\r\n                    <ks-btnbasic class=\"focusable btnfilter\" data-filter=\"racing\" toggle=\"true\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblCarRACING\"></div>\r\n                    </ks-btnbasic>\r\n                </div>\r\n            </div> -->\r\n\r\n\r\n\r\n\r\n        </div>\r\n\r\n    </div>\r\n\r\n</div>";

    var template$E = "<div class=\"component-body\">\r\n    <div class=\"unresponsive\" data-l10n-id=\"lblServerUnresponsive\"></div>\r\n    <div class=\"entry-row essential\">\r\n        <div class=\"entry-column sessioninfo\">\r\n            <div id=\"serverName\" class=\"server-name\"></div>\r\n            <div id=\"eventName\" class=\"event-name\"></div>\r\n            <div class=\"session-name\" id=\"sessionName\">\r\n            </div>\r\n            <!-- <div class=\"timeleft\">\r\n                <span class=\"svgicon timer icon-125\"></span>\r\n                <span id=\"timeLeft\" class=\"value\"></span>\r\n            </div> -->\r\n        </div>\r\n\r\n        <div class=\"entry-column trackinfo\">\r\n            <div id=\"serverTrack\" class=\"server-track\"></div>\r\n            <div id=\"serverTrackLayout\" class=\"server-track_layout\"></div>\r\n        </div>\r\n\r\n        <div class=\"entry-column conditionsinfo\">\r\n            <div class=\"server-time segmented align-items-center\">\r\n                <span class=\"svgicon icon-125 clock\"></span>\r\n                <span id=\"serverTime\" class=\"value\"></span>\r\n            </div>\r\n            <div id=\"serverWeather\" class=\"maskedIcon\">\r\n            </div>\r\n        </div>\r\n\r\n        <!-- <div class=\"entry-column carfilters\"> -->\r\n            <!-- <div class=\"carcategories\"> -->\r\n                <!-- <div -->\r\n                    <!-- class=\"tag\" -->\r\n                    <!-- data-bind-for=\"category:{{item.vehicles}}\" -->\r\n                    <!-- data-bind-class=\"{{category}}\" -->\r\n                    <!-- data-bind-value=\"entryfilters?.carfilter({{category}})\"></div>  -->\r\n            <!-- </div> -->\r\n        <!-- </div> -->\r\n\r\n        <div class=\"entry-column requirements-panel\">\r\n            <div class=\"requirements segmented\">\r\n                <span class=\"svgicon icon-175 has-driver-password lock\">\r\n                </span>\r\n                <!-- <span class=\"svgicon icon-175 is-ranked medal\">\r\n                </span> -->\r\n            </div>\r\n        </div>\r\n\r\n        <!-- <div class=\"entry-column carinfo\">\r\n            cars/safety\r\n        </div>\r\n\r\n        <div class=\"entry-column limitationsinfo\">\r\n\r\n        </div> -->\r\n\r\n        <div class=\"entry-column serverinfo\">\r\n            <div class=\"server-ping segmented\"><span id=\"serverPing\" class=\"value\">--</span><span class=\"unit\">ms</span></div>\r\n            <div class=\"server-players segmented\"><span id=\"currentPlayers\" class=\"value\"></span>/<span id=\"totalPlayers\" class=\"total\"></span></div>\r\n            <div id=\"friendsPanel\" class=\"server-friends segmented\">\r\n                <span class=\"svgicon icon-135 friends\">\r\n                </span>\r\n                <span id=\"friendsCount\" class=\"value\">0</span>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>";

    class MultiPlayerServerEntry extends KsHTMLElement {


        onPressBound;

        /** @type {TextInput} */
        txtPassword;

        /** @type {HTMLSpanElement} */
        serverPing;


        serverName;
        eventName;
        sessionName;
        timeLeft;
        serverTime;
        serverTrack;
        serverWeather;

        serverTrackLayout;
        currentPlayers;
        totalPlayers;


        friendsCount;
        friendsPanel;

        constructor() {
            super();
            this.template = template$E;
            //this._isnavigable = true;
            this.delayedInit = false;

            if (!window["entryfilters"]) {
                window["entryfilters"] = this.filters;
                console.log("added entryfilters");
            }

            this.onPressedBound = () => {
                //if(!this.selected)
                    this.select();
                // else
                //     this.deselect();
                this.onPressed();
            };
        }

        get password() {
            return this.txtPassword.value;
        }

        set password(value) {
            this.txtPassword.value = value;
        }

        set ping(value) {
            if (this.serverPing)
                this.serverPing.textContent = value > 0 ? value : "--";

            const invalid = value < 0;

            if (invalid) {
                this.classList.add("no-ping");
                //this.classList.add("disabled");
                //this.classList.remove("focusable");
            } else {
                this.classList.add("pinged");
            }

        }

        get selected() {
            return this.serverData.selected == true;
        }

        set selected(value) {
            this.serverData.selected = value;
        }

        get serverData() {
            return this._serverData;
        }

        set serverData(data) {
            this._serverData = data;
            this.serverId = data.server_id;
            if (this.isConnected)
                this.populateEntry();
        }

        get serverIndex() {
            return this.serverData.index;
        }

        get serverId() {
            return this.dataset.value;
        }

        set serverId(serverid) {
            this.dataset.value = serverid;
        }




        filters = {
            name: (str) => {
                return "Server: " + str;
            },
            weather: (str) => {
                const i = {
                    Sun: "sunny",
                    Rain: "rainy",
                    Dump: "damp"
                };

                if (i[str]) return i[str];
                else return "unknown";
            },
            trackBgr: (obj) => {

                return ("track-" + obj.track /*+ "_" + obj.layout*/).toLowerCase().replace(/\s/g, "_");
            },
            carfilter: (str) => {
                const tags = {
                    [eVehicleTagFilters.Any]: engine.translate("lblCarANY"),
                    [eVehicleTagFilters.Evo]: engine.translate("lblCarEVO"),
                    [eVehicleTagFilters.Luxury]: engine.translate("lblCarLUXURY"),
                    [eVehicleTagFilters.Heritage]: engine.translate("lblCarHERITAGE"),
                    [eVehicleTagFilters.Racing]: engine.translate("lblCarRACING")
                };

                return tags[str];
            }
        }

        onPressed() {

        }

        deselect() {
            this.selected = false;
            this.classList.remove("selected");
            this.onDeselected(this, this.serverData);
        }

        select() {

            if (this.classList.contains("no-ping")) {
                return;
            }

            if (this.serverData) {
                //console.warn(this.tagName, "SELECTING", this.serverData.server_id);
                this.selected = true;
            }

            if (!this.parentElement) return;

            for (let i = 0; i < this.parentElement.childElementCount; i++) {
                const child = this.parentElement.children[i];
                if (child != this && child.deselect) {
                    child.deselect();
                }
            }

            this.classList.add("selected");

            this.onSelected(this, this.serverData);
            this.dispatchEvent(new CustomEvent('serverentry:selected', { detail: { sender: this, value: this.dataset.value } }));

        }

        bindControls() {
            this.addEventListener("click", this.onPressedBound);
            this.addEventListener("sn:enter-down", this.onPressedBound);
        }

        onBindingUpdate(binding_param, value) {
            this.classList.add("loaded");
        }

        onSelected(sender, server) {
            // console.log("Selected server id", id);
        }

        onDeselected(sender, server) {

        }

        onRemovedFromDOM() {
            // console.log("Removed server entry", this.serverData.index);
        }

        populateEntry() {
            // console.log("Populated server entry", this.serverData.index);
            if (!this.serverData) return;
            const data = this.serverData;

            this.dataset.index = this.serverData.index;

            this.serverName.textContent = data.server_name;

            let gamemodetype = eGameModeTypeArray[data.game_mode_type];


            this.eventName.textContent = gamemodetype != eGameModeType.Practice ? engine.translate(gamemodetype) : engine.translate(eGameModeType.Trackday);
            if (gamemodetype != eGameModeType.Practice) {
                this.sessionName.textContent = engine.translate(`lblSessionName_${data.current_session}`);
            }
            //this.timeLeft.textContent = ksUI.formatTime(data.session_ends_in);
            this.serverTrack.textContent = data.track;
            this.serverTrackLayout.textContent = data.layout;
            this.serverTime.textContent = data.time_of_day;
            //this.serverPing.textContent = data.ping;
            this.ping = data.ping;
            //this.serverPing.textContent = data.ping == 0 ? "--" : data.ping;
            this.currentPlayers.textContent = Math.min(data.players?.length, data.max_players);
            this.totalPlayers.textContent = data.max_players;
            this.friendsCount.textContent = data.friends.length;
            this.friendsPanel.classList.toggle("inactive", !data.friends?.length);

            this.serverWeather.classList.add(data.weather_type);

            this.classList.toggle("has-driver-password", data.driver_password);
            this.classList.toggle("is-ranked", data.type != "MultiplayerServerListSessionType_UNRANKED");

            if (data.selected === true) {
                this.select();
            }

        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.txtPassword = q("ks-textinput.password", this);
            this.serverPing = q(".server-ping .value", this);
            //console.log("PING IS", this._serverData.ping);
            //if (!window["entryfilters"])
            //engine.registerBindingAttribute("disablevalue", ksDisableAttrHandler);
            //this.cars.getCurrent();           
            this.mapElementById("serverName");
            this.mapElementById("eventName");
            this.mapElementById("sessionName");
            this.mapElementById("timeLeft");
            this.mapElementById("serverTime");
            this.mapElementById("serverTrack");
            this.mapElementById("serverTrackLayout");
            this.mapElementById("serverPing");
            this.mapElementById("currentPlayers");
            this.mapElementById("totalPlayers");
            this.mapElementById("friendsCount");
            this.mapElementById("friendsPanel");
            this.mapElementById("serverWeather");


            this.populateEntry();

            this.closest("ks-page-serverlist")?.evaluateFocus(this);

        }

    }

    ksUI$1.registerModule('ks-serverentry', MultiPlayerServerEntry);

    (function (f) { if (typeof exports === "object" && typeof module !== "undefined") { module.exports = f(); } else if (typeof define === "function" && define.amd) { define([], f); } else { var g; if (typeof window !== "undefined") { g = window; } else if (typeof global !== "undefined") { g = global; } else if (typeof self !== "undefined") { g = self; } else { g = this; } g.HyperList = f(); } })(function () {
     return (function () { function r(e, n, t) { function o(i, f) { if (!n[i]) { if (!e[i]) { var c = "function" == typeof require && require; if (!f && c) return c(i, !0); if (u) return u(i, !0); var a = new Error("Cannot find module '" + i + "'"); throw a.code = "MODULE_NOT_FOUND", a } var p = n[i] = { exports: {} }; e[i][0].call(p.exports, function (r) { var n = e[i][1][r]; return o(n || r) }, p, p.exports, r, e, n, t); } return n[i].exports } for (var u = "function" == typeof require && require, i = 0; i < t.length; i++)o(t[i]); return o } return r })()({
            1: [function (_dereq_, module, exports) {

                // Default configuration.

                Object.defineProperty(exports, "__esModule", {
                    value: true
                });

                var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

                function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

                function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

                var defaultConfig = {
                    width: '100%',
                    height: '100%'

                    // Check for valid number.
                }; var isNumber = function isNumber(input) {
                    return Number(input) === Number(input);
                };

                // Add a class to an element.
                var addClass = 'classList' in document.documentElement ? function (element, className) {
                    element.classList.add(className);
                } : function (element, className) {
                    var oldClass = element.getAttribute('class') || '';
                    element.setAttribute('class', oldClass + ' ' + className);
                };

                /**
                 * Creates a HyperList instance that virtually scrolls very large amounts of
                 * data effortlessly.
                 */

                var HyperList = function () {
                    _createClass(HyperList, null, [{
                        key: 'create',
                        value: function create(element, userProvidedConfig) {
                            return new HyperList(element, userProvidedConfig);
                        }

                        /**
                         * Merge given css style on an element
                         * @param {DOMElement} element
                         * @param {Object} style
                         */

                    }, {
                        key: 'mergeStyle',
                        value: function mergeStyle(element, style) {
                            for (var i in style) {
                                if (element.style[i] !== style[i]) {
                                    element.style[i] = style[i];
                                }
                            }
                        }
                    }, {
                        key: 'getMaxBrowserHeight',
                        value: function getMaxBrowserHeight() {
                            // Create two elements, the wrapper is `1px` tall and is transparent and
                            // positioned at the top of the page. Inside that is an element that gets
                            // set to 1 billion pixels. Then reads the max height the browser can
                            // calculate.
                            var wrapper = document.createElement('div');
                            var fixture = document.createElement('div');

                            wrapper.id = "HYPERLIST";

                            // As said above, these values get set to put the fixture elements into the
                            // right visual state.
                            HyperList.mergeStyle(wrapper, { position: 'absolute', height: '1px', opacity: 0 });

                            var fixture_height_factor = 7;
                            HyperList.mergeStyle(fixture, { height: 10 ** fixture_height_factor + 'px' });

                            // Add the fixture into the wrapper element.
                            wrapper.appendChild(fixture);

                            // Apply to the page, the values won't kick in unless this is attached.
                            document.body.appendChild(wrapper);

                            // Get the maximum element height in pixels.
                            var maxElementHeight = fixture.offsetHeight;

                            //console.trace(maxElementHeight);

                            // Check if we can maybe get a bigger offsetHeight.
                            var max_fixture_height_factor = fixture_height_factor + 1;
                            fixture.style.height = 10 ** max_fixture_height_factor + 'px';

                            if (maxElementHeight !== fixture.offsetHeight) {
                                maxElementHeight = fixture.offsetHeight;

                                // Keep increasing the height of fixture.style.height until the offsetHeight stops changing OR until it returns 0
                                // If we are higher than the max, Chrome will return the max, Firefox will return 0.
                                while (fixture.offsetHeight !== 0 && maxElementHeight !== fixture.offsetHeight) {
                                    max_fixture_height_factor++;
                                    fixture.style.height = 10 ** max_fixture_height_factor + 'px';

                                    if (fixture.offsetHeight !== 0) {
                                        maxElementHeight = fixture.offsetHeight;
                                    }
                                }

                                // We went too high and we're on a browser that returns 0 when it's too high.
                                if (fixture.offsetHeight === 0) {
                                    var high = 10 ** max_fixture_height_factor;
                                    var low = 10 ** fixture_height_factor;
                                    var cur = high;
                                    var prevcur = high;
                                    while (maxElementHeight === 0) {
                                        prevcur = cur;
                                        cur = parseInt((high + low) / 2);
                                        fixture.style.height = cur;

                                        if (cur === prevcur) {
                                            // No more changes happening, we found the max value.
                                            maxElementHeight = cur;
                                        } else if (fixture.offsetHeight > 0) {
                                            // We found a new working value.
                                            low = cur;
                                        } else if (fixture.offsetHeight === 0) {
                                            // Half way is still too high. 
                                            high = cur;
                                        }
                                    }
                                }
                            }

                            // Remove the element immediately after reading the value.
                            //document.body.removeChild(wrapper);

                            return maxElementHeight;
                        }
                    }]);

                    function HyperList(element, userProvidedConfig) {
                        var _this = this;

                        _classCallCheck(this, HyperList);

                        this._config = {};
                        this._lastRepaint = null;
                        this._maxElementHeight = document.body.offsetHeight / 2;//HyperList.getMaxBrowserHeight();

                        this.refresh(element, userProvidedConfig);

                        var config = this._config;

                        // Create internal render loop.
                        var render = function render() {
                            var scrollTop = _this._getScrollPosition();
                            var lastRepaint = _this._lastRepaint;

                            _this._renderAnimationFrame = window.requestAnimationFrame(render);

                            if (scrollTop === lastRepaint) {
                                return;
                            }


                            var diff = lastRepaint ? scrollTop - lastRepaint : 0;
                            if (!lastRepaint || diff < 0 || diff > _this._averageHeight) {
                                var rendered = _this._renderChunk();

                                _this._lastRepaint = scrollTop;

                                if (rendered !== false && typeof config.afterRender === 'function') {
                                    config.afterRender();
                                }
                            }
                        };

                        render();
                    }

                    _createClass(HyperList, [{
                        key: 'destroy',
                        value: function destroy() {
                            window.cancelAnimationFrame(this._renderAnimationFrame);
                        }
                    }, {
                        key: 'refresh',
                        value: function refresh(element, userProvidedConfig) {
                            var _scrollerStyle;

                            Object.assign(this._config, defaultConfig, userProvidedConfig);

                            if (!element || element.nodeType !== 1) {
                                throw new Error('HyperList requires a valid DOM Node container');
                            }

                            this._element = element;

                            var config = this._config;

                            var scroller = this._scroller || config.scroller || document.createElement(config.scrollerTagName || 'tr');

                            scroller.classList.add("list-scroller");
                            // Default configuration option `useFragment` to `true`.
                            if (typeof config.useFragment !== 'boolean') {
                                this._config.useFragment = true;
                            }

                            if (!config.generate) {
                                throw new Error('Missing required `generate` function');
                            }

                            if (!isNumber(config.total)) {
                                throw new Error('Invalid required `total` value, expected number');
                            }

                            if (!Array.isArray(config.itemHeight) && !isNumber(config.itemHeight)) {
                                throw new Error('\n        Invalid required `itemHeight` value, expected number or array\n      '.trim());
                            } else if (isNumber(config.itemHeight)) {
                                this._itemHeights = Array(config.total).fill(config.itemHeight);
                            } else {
                                this._itemHeights = config.itemHeight;
                            }

                            // Width and height should be coerced to string representations. Either in
                            // `%` or `px`.
                            Object.keys(defaultConfig).filter(function (prop) {
                                return prop in config;
                            }).forEach(function (prop) {
                                var value = config[prop];
                                var isValueNumber = isNumber(value);

                                if (value && typeof value !== 'string' && typeof value !== 'number') {
                                    var msg = 'Invalid optional `' + prop + '`, expected string or number';
                                    throw new Error(msg);
                                } else if (isValueNumber) {
                                    config[prop] = value + 'px';
                                }
                            });

                            var isHoriz = Boolean(config.horizontal);
                            var value = config[isHoriz ? 'width' : 'height'];

                            if (value) {
                                var isValueNumber = isNumber(value);
                                var isValuePercent = isValueNumber ? false : value.slice(-1) === '%';
                                // Compute the containerHeight as number
                                var numberValue = isValueNumber ? value : parseInt(value.replace(/px|%/, ''), 10);
                                var innerSize = window[isHoriz ? 'innerWidth' : 'innerHeight'];

                                if (isValuePercent) {
                                    this._containerSize = innerSize * numberValue / 100;
                                } else {
                                    this._containerSize = isNumber(value) ? value : numberValue;
                                }
                            }

                            var scrollContainer = config.scrollContainer;
                            var scrollerHeight = config.itemHeight * config.total;
                            this._maxElementHeight;

                            //if (scrollerHeight > maxElementHeight) {
                            //console.warn(['HyperList: The maximum element height', maxElementHeight + 'px has', 'been exceeded; please reduce your item height.',scrollerHeight, maxElementHeight].join(' '));
                            //}

                            // Decorate the container element with styles that will match
                            // the user supplied configuration.
                            var elementStyle = {
                                width: '' + config.width,
                                height: scrollContainer ? scrollerHeight + 'px' : '' + config.height,
                                overflow: scrollContainer ? 'none' : 'auto',
                                position: 'relative'
                            };

                            HyperList.mergeStyle(element, elementStyle);

                            if (scrollContainer) {
                                HyperList.mergeStyle(config.scrollContainer, { overflow: 'auto' });
                            }

                            var scrollerStyle = (_scrollerStyle = {
                                opacity: '0',
                                position: 'absolute'
                            }, _defineProperty(_scrollerStyle, isHoriz ? 'height' : 'width', '1px'), _defineProperty(_scrollerStyle, isHoriz ? 'width' : 'height', scrollerHeight + 'px'), _scrollerStyle);

                            HyperList.mergeStyle(scroller, scrollerStyle);

                            // Only append the scroller element once.
                            if (!this._scroller) {
                                element.appendChild(scroller);
                            }

                            var padding = this._computeScrollPadding();
                            this._scrollPaddingBottom = padding.bottom;
                            this._scrollPaddingTop = padding.top;

                            // Set the scroller instance.
                            this._scroller = scroller;
                            this._scrollHeight = this._computeScrollHeight();

                            // Reuse the item positions if refreshed, otherwise set to empty array.
                            this._itemPositions = this._itemPositions || Array(config.total).fill(0);

                            // Each index in the array should represent the position in the DOM.
                            this._computePositions(0);

                            // Render after refreshing. Force render if we're calling refresh manually.
                            this._renderChunk(this._lastRepaint !== null);

                            if (typeof config.afterRender === 'function') {
                                config.afterRender();
                            }
                        }
                    }, {
                        key: '_getRow',
                        value: function _getRow(i) {
                            //console.trace("_getRow");
                            var config = this._config;
                            var item = config.generate(i);
                            var height = item.height;

                            if (height !== undefined && isNumber(height)) {
                                item = item.element;

                                // The height isn't the same as predicted, compute positions again
                                if (height !== this._itemHeights[i]) {
                                    this._itemHeights[i] = height;
                                    this._computePositions(i);
                                    this._scrollHeight = this._computeScrollHeight(i);
                                }
                            } else {
                                height = this._itemHeights[i];
                            }

                            if (!item || item.nodeType !== 1) {
                                throw new Error('Generator did not return a DOM Node for index: ' + i);
                            }

                            addClass(item, config.rowClassName || 'vrow');

                            var top = this._itemPositions[i] + this._scrollPaddingTop;

                            HyperList.mergeStyle(item, _defineProperty({
                                position: 'absolute'
                            }, config.horizontal ? 'left' : 'top', top + 'px'));

                            return item;
                        }
                    }, {
                        key: '_getScrollPosition',
                        value: function _getScrollPosition() {
                            var config = this._config;

                            if (typeof config.overrideScrollPosition === 'function') {
                                return config.overrideScrollPosition();
                            }

                            return this._element[config.horizontal ? 'scrollLeft' : 'scrollTop'];
                        }
                    }, {
                        key: '_renderChunk',
                        value: function _renderChunk(force) {
                            //console.trace("_renderChunk", this._config);
                            var config = this._config;
                            var element = this._element;
                            var scrollTop = this._getScrollPosition();
                            var total = config.total;

                            var from = config.reverse ? this._getReverseFrom(scrollTop) : this._getFrom(scrollTop) - 1;

                            if (from < 0 || from - this._screenItemsLen < 0) {
                                from = 0;
                            }

                            if (!force && this._lastFrom === from) {
                                return false;
                            }

                            if (typeof config.beforeRender === 'function') {
                                config.beforeRender();
                            }


                            this._lastFrom = from;

                            var to = from + this._cachedItemsLen;

                            if (to > total || to + this._cachedItemsLen > total) {
                                to = total;
                                //console.warn("HYPERLIST to = total", from, to, total, this._cachedItemsLen);
                            }

                            // Append all the new rows in a document fragment that we will later append
                            // to the parent node
                            var fragment = config.useFragment ? document.createDocumentFragment() : []
                                // Sometimes you'll pass fake elements to this tool and Fragments require
                                // real elements.


                                // The element that forces the container to scroll.
                                ; var scroller = this._scroller;

                            // Keep the scroller in the list of children.
                            fragment[config.useFragment ? 'appendChild' : 'push'](scroller);

                            for (var i = from; i < to; i++) {
                                var row = this._getRow(i);

                                fragment[config.useFragment ? 'appendChild' : 'push'](row);

                            }

                            if (config.applyPatch) {
                                return config.applyPatch(element, fragment);
                            }

                            element.innerHTML = '';
                            element.appendChild(fragment);
                        }
                    }, {
                        key: '_computePositions',
                        value: function _computePositions() {
                            var from = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 1;

                            var config = this._config;
                            var total = config.total;
                            var reverse = config.reverse;

                            if (from < 1 && !reverse) {
                                from = 1;
                            }

                            for (var i = from; i < total; i++) {
                                if (reverse) {
                                    if (i === 0) {
                                        this._itemPositions[0] = this._scrollHeight - this._itemHeights[0];
                                    } else {
                                        this._itemPositions[i] = this._itemPositions[i - 1] - this._itemHeights[i];
                                    }
                                } else {
                                    this._itemPositions[i] = this._itemHeights[i - 1] + this._itemPositions[i - 1];
                                }
                            }
                        }
                    }, {
                        key: '_computeScrollHeight',
                        value: function _computeScrollHeight() {
                            var _HyperList$mergeStyle2,
                                _this2 = this;

                            var config = this._config;
                            var isHoriz = Boolean(config.horizontal);
                            var total = config.total;
                            var scrollHeight = this._itemHeights.reduce(function (a, b) {
                                return a + b;
                            }, 0) + this._scrollPaddingBottom + this._scrollPaddingTop;

                            HyperList.mergeStyle(this._scroller, (_HyperList$mergeStyle2 = {
                                opacity: 0,
                                position: 'absolute',
                                top: '0px'
                            }, _defineProperty(_HyperList$mergeStyle2, isHoriz ? 'height' : 'width', '1px'), _defineProperty(_HyperList$mergeStyle2, isHoriz ? 'width' : 'height', scrollHeight + 'px'), _HyperList$mergeStyle2));

                            // Calculate the height median
                            var sortedItemHeights = this._itemHeights.slice(0).sort(function (a, b) {
                                return a - b;
                            });
                            var middle = Math.floor(total / 2);
                            var averageHeight = total % 2 === 0 ? (sortedItemHeights[middle] + sortedItemHeights[middle - 1]) / 2 : sortedItemHeights[middle];

                            var clientProp = isHoriz ? 'clientWidth' : 'clientHeight';
                            var element = config.scrollContainer ? config.scrollContainer : this._element;
                            var containerHeight = element[clientProp] ? element[clientProp] : this._containerSize;
                            this._screenItemsLen = Math.ceil(containerHeight / averageHeight);
                            this._containerSize = containerHeight;

                            // Cache 3 times the number of items that fit in the container viewport. CHANGED TO 2X
                            this._cachedItemsLen = Math.max(this._cachedItemsLen || 0, 2 * this._screenItemsLen);
                            this._averageHeight = averageHeight;

                            if (config.reverse) {
                                window.requestAnimationFrame(function () {
                                    if (isHoriz) {
                                        _this2._element.scrollLeft = scrollHeight;
                                    } else {
                                        _this2._element.scrollTop = scrollHeight;
                                    }
                                });
                            }

                            return scrollHeight;
                        }
                    }, {
                        key: '_computeScrollPadding',
                        value: function _computeScrollPadding() {
                            var config = this._config;
                            var isHoriz = Boolean(config.horizontal);
                            var isReverse = config.reverse;
                            var styles = window.getComputedStyle(this._element);

                            var padding = function padding(location) {
                                var cssValue = styles.getPropertyValue('padding-' + location);
                                return parseInt(cssValue, 10) || 0;
                            };

                            if (isHoriz && isReverse) {
                                return {
                                    bottom: padding('left'),
                                    top: padding('right')
                                };
                            } else if (isHoriz) {
                                return {
                                    bottom: padding('right'),
                                    top: padding('left')
                                };
                            } else if (isReverse) {
                                return {
                                    bottom: padding('top'),
                                    top: padding('bottom')
                                };
                            } else {
                                return {
                                    bottom: padding('bottom'),
                                    top: padding('top')
                                };
                            }
                        }
                    }, {
                        key: '_getFrom',
                        value: function _getFrom(scrollTop) {
                            var i = 0;

                            while (this._itemPositions[i] < scrollTop) {
                                i++;
                            }

                            return i;
                        }
                    }, {
                        key: '_getReverseFrom',
                        value: function _getReverseFrom(scrollTop) {
                            var i = this._config.total - 1;

                            while (i > 0 && this._itemPositions[i] < scrollTop + this._containerSize) {
                                i--;
                            }

                            return i;
                        }
                    }]);

                    return HyperList;
                }();

                exports.default = HyperList;
                module.exports = exports['default'];

            }, {}]
        }, {}, [1])(1)
    });

    var HyperList$1 = HyperList;

    class MultiPlayerServerList extends KsHTMLElement {

        ENTRIESTOFETCH = 8;
        SERVERENTRYHEIGHT = 6.5;

        /** @type MessageHandler */
        ServerClient;

        //fakeServers = new FakeServerListGenerator(36000);
        firstload = true;

        serverListPending = false;

        wrapperServerList;
        listServers;
        listServersContent;
        panelFilters;

        targetServer;

        /** @type {Btnbasic} */
        btnBack;
        /** @type {Btnbasic} */
        btnJoin;
        /** @type {Btnbasic} */
        btnCarSelect;
        /** @type {Btnbasic} */
        btnSpectate;
        /** @type {Btnbasic} */
        btnClipboard;

        /** @type {Btnbasic} */
        btnRefresh;
        /** @type {Btnbasic} */
        btnSortPing;
        /** @type {Btnbasic} */
        btnSortPlayers;

        /** @type {Btnbasic} */
        btnFilterByCar;

        /** @type {Btnbasic} */
        btnFilterNoPassword;

        /** @type {Btnbasic} */
        btnShowServer;

        /** @type {TextInput} */
        txtSearch;


        notification;
        lastSelectedServerId = "";

        ServerList = [];

        _storedServerData = {};

        get StoredData() {
            return this._storedServerData;
        }

        set StoredData(new_data) {
            this._storedServerData = new_data;
        }

        panelServerCount;

        panelServerVisible;
        panelServerTotal;

        panelPlayerCount;

        panelPlayerVisible;
        panelPlayerTotal;

        eligibleCarList;

        /** @type {HyperList} */
        hList;

        hListConfig;

        serverFilters = {
            trackday: false,
            race: false,
            notrace: false,
            by_ping: false,
            by_players: false,
            eligible_car: false,
            no_password: false,
            text: ""
        }

        constructor() {
            super();
            this.template = template$F;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this.delayedInit = false;
            this._bindScrollableEvents = true;
        }

        filters = {
            server_name_overflow: (value) => {
                const server_name = q(".servername", this);
                const overflow = Math.abs(server_name.clientHeight - server_name.scrollHeight) > 2;
                server_name.classList.toggle("overflow", overflow);

                return overflow ? `${value.substring(0, 72)} ...` : value;
            }
        }

        get sortByPlayers() {
            return this.serverFilters.by_players;
        }

        get sortByPing() {
            return this.serverFilters.by_ping;
        }

        get hasSelectedServer() {
            return this.classList.contains("server-selected");
        }

        bindControls() {

            this.btnRefresh.onPressed = (sender, e) => {
                this.getServerList();
            };

            this.btnShowServer.onPressed = () => {
                this.scrollToSelectedServer();
            };

            this.btnJoin.onPressed = () => {
                ksUI$1.setOriginAsReturnPage();
                this.connectToServer(false);
            };

            this.btnSpectate.onPressed = () => {
                ksUI$1.setOriginAsReturnPage();
                this.connectToServer(true);
            };

            this.txtSearch.onInput = (value, valid) => {
                this.serverFilters.text = value.toLowerCase().trim();

                this.applyFiltersAndSorting();
                this.refreshVirtualList();
            };

            this.btnClipboard.onPressed = (sender, e) => {
                ksUI$1.request("Multiplayer", "GoToServer", (data) => {
                    if(data.response == "MultiplayerServerListCommandsResponse_CRITICAL_ERROR") {
                        this.errorModal("lblError", "msgInvalidServerInfoInClipboard", false, null, true);
                    }
                });
            };

            qAll("ks-btnbasic", this.panelFilters).forEach(btn => {
                btn.onToggled = (sender, e, state) => {
                    console.log(sender.id, state);
                    this.serverFilters[btn.dataset.filter] = state;
                    this.applyFiltersAndSorting();
                    this.refreshVirtualList();
                };
            });



            this.btnCarSelect.onBeforeRedirect = () => {
                if (isSandBox) {
                    VEHICLES.dataFilters.carSelectionMode = eClientCommands.Mode.Multi;
                    VEHICLES.dataFilters.ownershipState = eCarSelection.State.Dealership;
                    VEHICLES.updateDataFilters();
                }
            };

            this.btnSortPing.onToggled = (sender, e, state) => {
                console.log("Sort by ping", state);
                this.serverFilters.by_ping = state;
                this.applyFiltersAndSorting();
                this.refreshVirtualList();
            };

            this.btnSortPlayers.onToggled = (sender, e, state) => {
                console.log("Sort by players", state);
                this.serverFilters.by_players = state;
                this.applyFiltersAndSorting();
                this.refreshVirtualList();
            };


            this.listServersContent.addEventListener("scroll", (e) => {
                if (!this.hasSelectedServer) return;
                this.debouncedToggleShowServer();
            });

        }

        debounceShowServer;

        debouncedToggleShowServer() {
            clearTimeout(this.debounceShowServer);
            this.debounceShowServer = setTimeout(() => this.toggleBtnShowServer(), 150);
        }

        toggleBtnShowServer() {
            // console.trace("ToggleBtnShowServer", this.isSelectedServerInView);
            if (!this.selectedServer) return;
            if (this.isSelectedServerInView) {
                this.btnShowServer.disable();
            } else {
                this.btnShowServer.enable();
            }
        }

        onAfterRenderControlHints(controlhints) {

            this.mapElementById("btnBack", controlhints);

            this.btnBack.onPressed = () => {
                VEHICLES.dataFilters.carSelectionMode = eClientCommands.Mode.Single;
                ksUI$1.changePage("multiplayer/hub");
            };

        }

        activeDefinitionFilter;

        ServerListFiltered = [];

        get isSelectedServerInView() {
            const elem = this.selectedServerEntry;
            if (!elem) return false;
            const elem_box = elem.getBoundingClientRect();
            const list_box = this.listServersContent.getBoundingClientRect();
            return (elem_box.top > list_box.top && elem_box.bottom < list_box.bottom);
        }


        filterVisibleBindingsByName(value) {
            if (!value) value = "";
            const normalized = value.trim().toLowerCase();

            this.activeDefinitionFilter = normalized;

            this.ServerListFiltered = this.ServerList.filter(server => server.server_name.toLowerCase().indexOf(normalized) > -1);

            qAll("#listServers ks-serverentry").forEach(elem => {
                const text = elem.textContent.toLowerCase();
                const shouldHide = !text.includes(normalized);
                elem.classList.toggle("hidden", shouldHide);
            });

            waitForFrames(() => {
                this.updateAllScrollBars();
            });
        }

        scrollToSelectedServer() {
            const index = this.ServerListFiltered.findIndex(server => server.selected === true);

            if (index == -1) {
                const server = this.ServerList.find(server => server.selected == true);
                if (server) {
                    this.ServerListFiltered.push(server);
                    this.refreshVirtualList();
                } else {
                    return;
                }
            }

            const height = this.listServersContent.scrollHeight / this.ServerListFiltered.length;
            this.listServersContent.scrollTop = index * height;
            this.updateAllScrollBars();
            this.btnShowServer.disable();
        }

        getServer(server_id) {
            let found_entry;

            for (const entry of this.ServerList) {
                if (entry.server_id == server_id) {
                    found_entry = entry;
                    break;
                }
            }

            return found_entry;
        }

        getServerIpPortString(server) {
            return `${server.server_ip}_${server.server_tcp_port}_${server.server_udp_port}`;
        }

        get selectedServerPassword() {
            return this.txtPassword.value;
        }

        get selectedServerIPPortString() {
            const selectedServer = this.ServerList.find(server => server.selected === true);
            if (selectedServer) {
                return this.getServerIpPortString(selectedServer);
            }

            return undefined;
        }

        get selectedServerId() {
            return this.ServerList.find(server => server.selected === true)?.server_id;
        }

        get selectedServer() {
            return this.ServerList.find(server => server.selected === true);
        }

        get selectedServerEntry() {
            return q("ks-serverentry.selected");
        }

        get selectedServerStoredData() {
            if (!this.StoredData[this.selectedServerId]) {
                this.StoredData[this.selectedServerId] = { password: "", lastcar: null };
            }
            return this.StoredData[this.selectedServerId];
        }

        selectedCarPguid = {};

        selectedCar = {};

        currentServer;

        setSelectedServer(server_id) {
            this.ServerList.forEach(server => {
                server.selected = server.server_id == server_id;
                if (server.selected) {
                    this.currentServer = server;
                    const game_mode_type = eGameModeTypeArray[server.game_mode_type];
                    this.currentServer.eventLocalized = game_mode_type != eGameModeType.Practice ? engine.translate(game_mode_type) : engine.translate(eGameModeType.Trackday);
                    this.currentServer.sessionLocalized = engine.translate(`lblSessionName_${server.current_session}`);
                }
            });
            this.refreshCurrentServer();
        }

        refreshCurrentServer() {
            this.assignModel(this.currentServer, "CurrentServer");
        }

        pingServerDelay = { id: 0 };

        pingServers() {
            console.log("Pinging servers");
            this.pingedServers = 0;
            this.pingHandler = engine.on("MultiplayerServerListResponsePingServers", this.onServerPinged.bind(this));

            cancelAnimationFrame(this.pingServerDelay.id);

            waitForFrames(() => {
                this.ServerClient.requestNoResponse("PingServers");
            }, 3, this.pingServerDelay);

        }

        debouncePingRefresh = { id: 0 };

        pingedServers = 0;

        onServerPinged(response) {
            console.log("Received ping", response.server_id, response.ping);

            const pingvalue = response.ping;

            const element = q(`ks-serverentry[data-value="${response.server_id}"]`, this);

            if (element) {
                element.ping = pingvalue;
            }
            const server = this.getServer(response.server_id);

            if (server)
                server.ping = pingvalue;

            if (server && this.currentServer && server.server_id == this.currentServer.server_id) {
                this.currentServer.ping = pingvalue;
                this.refreshCurrentServer();
                if (pingvalue < 0) {
                    this.disableJoin();
                }

            }

            this.pingedServers++;

            if (this.pingedServers > 0.25 * this.ServerList.length && this.classList.contains("loading")) {
                if (!this.hList)
                    this.initVirtualList();
                else {
                    this.refreshVirtualList();
                }

                this.classList.remove("loading");
                this.btnClipboard.enable();
            }

            cancelAnimationFrame(this.debouncePingRefresh.id);

            if (this.sortByPing)
                waitForFrames(() => {
                    this.applyFiltersAndSorting();
                    this.refreshVirtualList();
                }, 3, this.debouncePingRefresh);
        }

        bindServers() {
            console.trace("bindServers");
            this.setupNavigation();
            this.firstload = false;
        }

        disableJoin() {
            this.btnJoin.disable();
            this.btnSpectate.disable();
            this.btnClipboard.disable();
            this.txtPassword.disable();
            this.txtPassword.value = "";
        }

        setNotificationMessage(message) {
            this.notification.textContent = engine.translate(message);
        }

        setCarEligibility(is_eligible, message = "") {
            this.btnCarSelect.classList.toggle("inelegible", !is_eligible);
            this.setNotificationMessage(message);
        }

        isEligibleServer(server_id) {
            return new Promise((resolve, reject) => {
                this.ServerClient.request("SelectServer", {
                    server_id: server_id
                }, (response) => {

                    ({
                        [eJoinErrorMessage.OK]: () => {
                            this.setCarEligibility(true);
                            this.btnJoin.enable();
                        },
                        [eJoinErrorMessage.WrongCar]: () => {
                            console.warn("SelectServer: non-elegible car selection");
                            this.btnCarSelect.classList.add("inelegible");
                            this.setCarEligibility(false, "lblWrongCarSelected");
                            this.btnJoin.disable();
                        },
                        [eJoinErrorMessage.WrongCarCategory]: () => {
                            console.warn("SelectServer: non-elegible car category");
                            this.btnJoin.disable();
                        },
                        [eJoinErrorMessage.WrongCarPerformanceIndicator]: () => {
                            console.warn("SelectServer: non-elegible car performance indicator");
                            this.btnJoin.disable();
                        }
                    }[response.response])();

                    resolve(response);
                });
            });
        }

        saveServersData() {
            const serverId = this.selectedServerIPPortString;
            const password = this.txtPassword.value;
            const lastcar = this.selectedCarPguid;

            this.StoredData[serverId] = { password: password, lastcar: lastcar };

            STORAGE.set(eStorageContainers.ServerPasswords, this.StoredData);
            STORAGE.save(eStorageContainers.ServerPasswords);
        }


        onRemovedFromDOM() {
            console.log("Server list UI removed");
            this.serverListPending = false;

            cancelAnimationFrame(this.debouncePingRefresh.id);

            if (window["entryfilters"]) {
                delete window["entryfilters"];
                console.log("removed entryfilters");
            }

            //Scrollbar.components.clear();
            if (this.pingHandler) {
                console.log("Server list UI cleared ping handler");
                this.pingHandler.clear();
            }

            clearTimeout(this.pingDebounce);
            this.clearAssignedModels();

            localStorage.setItem("server_filters", JSON.stringify(this.serverFilters));
            this.saveServersData();
        }


        /**
         * returns a filtered and sorted server list with the last selected server
         */

        applyFiltersAndSorting() {

            this.ServerListFiltered = this.ServerList.filter(() => { return true; });

            const lastselected = this.ServerListFiltered.find(server => this.generateAltServerId(server) == this.lastSelectedServerId);
            if (lastselected) {
                lastselected.selected = true;
            }

            if (this.serverFilters.text != '') {
                this.ServerListFiltered = this.ServerListFiltered.filter((server) => {
                    const in_name = server.server_name.toLowerCase().indexOf(this.serverFilters.text) > -1;
                    const in_trackname = server.track.toLowerCase().indexOf(this.serverFilters.text) > -1;
                    return in_name || in_trackname || server.selected == true;
                });
            }

            if (this.serverFilters.no_password) {
                console.log("Showing only unlocked servers");
                this.ServerListFiltered = this.ServerListFiltered.filter((server) => {
                    return !server.driver_password || server.selected == true;
                });

            }

            if (this.serverFilters.eligible_car) {
                console.log("Showing only servers where car is elegible");
                this.ServerListFiltered = this.ServerListFiltered.filter((server) => {
                    return server.is_car_eligible || server.selected == true;
                });
            }

            if (this.serverFilters.race) {
                console.log("Showing only servers in race weekend config");
                this.ServerListFiltered = this.ServerListFiltered.filter((server) => {
                    return (server.game_mode_type == 1 && server.players.length < server.max_players) || server.selected;
                });
            }

            if (this.serverFilters.notrace) {
                console.log("Showing only servers not in race session");
                this.ServerListFiltered = this.ServerListFiltered.filter((server) => {
                    return (["practice", "qualifying"].indexOf(server.current_session.toLowerCase()) > -1 && server.players.length < server.max_players) || server.selected;
                });
            }


            if (this.serverFilters.trackday) {
                console.log("Showing only servers in trackday config");
                this.ServerListFiltered = this.ServerListFiltered.filter((server) => {
                    return (server.game_mode_type == 10 && server.players.length < server.max_players) || server.selected;
                });
            }


            this.ServerListFiltered.sort((a, b) => {
                if (a.selected) return -1;
                if (b.selected) return 1;
                return 0;
            });

            if (this.serverFilters.by_ping) {
                console.log("Sorting by ping");
                this.ServerListFiltered.sort((a, b) => {
                    const aping = a.ping, bping = b.ping;
                    if (aping == 0 || aping == -1) return 1;
                    if (bping == 0 || bping == -1) return -1;
                    if (aping < bping) return -1;
                    if (aping > bping) return 1;
                    return 0;
                });
            }

            if (this.serverFilters.by_players) {
                console.log("Sorting by players");
                this.ServerListFiltered.sort((a, b) => {
                    const aplayers = a.players.length, bplayers = b.players.length;
                    const aping = a.ping, bping = b.ping;
                    if (this.serverFilters.by_ping) {
                        if (aping == 0 || aping == -1) return 1;
                        if (bping == 0 || bping == -1) return -1;
                    }
                    if (aplayers < bplayers) return 1;
                    if (aplayers > bplayers) return -1;
                    return 0;
                });
            }

            this.ServerListFiltered.sort((a, b) => {
                return (a.selected == b.selected) ? 0 : a.selected ? -1 : 1;
            });

            this.ServerListFiltered = this.ServerListFiltered.filter(item => { return item.ping > -1 });


            this.updateServerAndPlayerCounts();

            return this.ServerListFiltered;
        }

        updateServerAndPlayerCounts() {
            const visible = this.ServerListFiltered.length;
            this.panelServerVisible.textContent = visible;
            this.panelServerTotal.textContent = this.ServerList.length;

            let player_total = 0;

            this.ServerList.forEach(server => {
                player_total += Math.min(server.players?.length, server.max_players);
            });

            let player_count = 0;

            this.ServerListFiltered.forEach(server => {
                player_count += Math.min(server.players?.length, server.max_players);
            });

            this.panelPlayerVisible.textContent = player_count;
            this.panelPlayerTotal.textContent = player_total;

            console.trace(`Player count:${player_total}`);

            this.classList.toggle("no-servers", visible == 0);
            this.btnClipboard.enable();
        }

        refreshVirtualList() {
            if (this.ServerListFiltered.length == 0) return;
            if (!this.hListConfig) {
                this.initVirtualList();
            }
            console.trace("refreshVirtualList", this.hListConfig.height);
            this.hListConfig.total = this.ServerListFiltered.length;
            this.hList.refresh(this.listServersContent, this.hListConfig);
        }

        initVirtualList() {
            this.hListConfig = {

                height: this.ENTRIESTOFETCH * ksUI$1.getPxFromRem(this.SERVERENTRYHEIGHT) + "px",
                itemHeight: ksUI$1.getPxFromRem(this.SERVERENTRYHEIGHT),
                total: this.ServerListFiltered.length,
                reverse: false,
                scrollerTagName: 'div',
                //useFragment: false,

                generate: (index) => {

                    const server = activePage.ServerListFiltered[index];
                    if (server) {
                        return activePage.generateServerEntry(server, index);
                    }
                },

                beforeRender: () => {
                    ksUI$1.toggleSpatialNavigation(false, true);
                },

                afterRender: () => {
                    //console.log("afterRender");
                    this.setupNavigation();

                    ksUI$1.toggleSpatialNavigation(false, false);

                    waitForFrames(() => {
                        ksUI$1.toggleSpatialNavigation(true, false);
                        //
                        this.debouncedToggleShowServer();
                    }, 10);


                },
                applyPatch: (element, fragment) => {
                    //console.log("applyPatch", fragment.children[0].dataset.index);

                    this.lastFragment = fragment;
                    element.innerHTML = "";
                    element.appendChild(fragment);
                }
            };

            this.hList = HyperList$1.create(this.listServersContent, this.hListConfig);

        }

        pingDebounce;

        getServerList(filterMode) {
            this.disableJoin();
            this.lastSelectedServerId = localStorage.getItem("lastSelectedServerId");
            this.lastFocusedServerIndex = null;
            //this.listServersContent.innerHTML = "";
            console.log("Fetching server list");

            clearTimeout(this.pingDebounce);

            if (this.pingHandler) {
                this.pingHandler.clear();
                console.log("Server list UI cleared ping handler");
            }

            this.classList.add("loading");

            this.serverListPending = true;

            this.ServerClient.request("ServerList", {

            }, (data) => {

                if (!this.serverListPending) {
                    console.warn("Aborted server list reception");
                    return;
                }

                ({
                    [eBackendResponse.OK]: () => {
                        this.ServerList = data.entry;
                        //this.ServerList = this.fakeServers.getServers();

                        let entries = this.applyFiltersAndSorting();

                        console.trace("Received servers", entries);

                        if (entries.length == 0) {
                            this.classList.remove("loading");
                            this.classList.add("no-servers");
                        }

                        let foundtargetserver = false;

                        entries.forEach(entry => {
                            const stored_data = this.getServerIpPortString(entry);
                            if (stored_data)
                                entry.storedpassword = stored_data.password;

                            if (this.targetServer) {

                                if (entry.server_ip == this.targetServer.ip && entry.server_tcp_port == this.targetServer.port) {
                                    console.log("Targetted server", entry.server_id);
                                    entry.selected = true;
                                    foundtargetserver = true;
                                    this.txtPassword.value = this.targetServer.password;
                                }


                            }
                        });

                        if (foundtargetserver) {
                            this.applyFiltersAndSorting();
                        } else if (!foundtargetserver && this.targetServer) {
                            this.errorModal("lblError", "msgCouldNotFindServer", false, null, true);
                        }


                        waitForFrames(() => {

                            this.bindServers();
                            waitForFrames(() => {

                                if (this.selectedServerId) {
                                    activePage.btnJoin.enable();
                                    activePage.btnSpectate.enable();
                                }
                                this.scrollableContainers[0].scrollToElement(q("ks-serverentry.selected"));
                            }, 3);

                            this.pingDebounce = setTimeout(() => this.pingServers(), 125);
                            this.clearAllScrollable();
                            this.setupScrollbars();
                        }, 1);

                    },
                    [eBackendResponse.BackendDisconnected]: () => {
                        this.classList.remove("loading");
                        this.classList.add("error");
                        console.error("Received", data.response);
                    }
                }[data.response])();
                this.serverListPending = false;
            });
        }

        lastFocusedServerIndex = 0;



        shouldShowCarList(server) {
            const trackdayServerThreshold = 48;
            return server.allowed_cars_list_full.length && server.allowed_cars_list_full.length < trackdayServerThreshold;
        }

        generateAltServerId(server) {
            return [server.server_ip, server.server_tcp_port, server.server_udp_port].join("_");
        }

        generateServerEntry(server, index) {

            /** @type {MultiPlayerServerEntry} */
            const serverEntry = document.createElement("ks-serverentry");

            serverEntry.dataset.snRight = "#btnJoin";
            serverEntry.dataset.snLeft = "#btnRefresh";

            serverEntry.classList.add("focusable");
            serverEntry.serverData = server;
            serverEntry.serverData.index = index;
            serverEntry.id = `serverentry${index}`;

            serverEntry.onSelected = (sender, server) => {
                this.classList.add("server-selected");
                const show_car_list = this.shouldShowCarList(server);
                console.log("Server allowed list", server.allowed_cars_list_full.length);
                const server_id = String(server.server_id);
                const alt_server_id = this.generateAltServerId(server);
                const storedserverdata = this.StoredData[this.getServerIpPortString(server)];
                //const show_car_list = server.allowed_cars_list.length + server.allowed_cars_list_full.length > 0;
                this.classList.toggle("show-car-list", show_car_list);

                console.log("server selected", server_id);

                this.selectedCar = CurrentCar.model;
                this.selectedCarPguid = CurrentCar.model.car_pguid;

                if (this.lastSelectedServerId != alt_server_id) {
                    this.isEligibleServer(server_id).then(() => {
                        if (show_car_list) this.getEligibleCars();
                        else this.eligibleCarList.innerHTML = "";
                    });
                }

                this.lastSelectedServerId = alt_server_id;
                localStorage.setItem("lastSelectedServerId", alt_server_id);

                if (this.targetServer && server.server_ip == this.targetServer.ip && server.server_tcp_port == this.targetServer.port) {
                    console.log("setting targetted server password");
                    this.txtPassword.value = this.targetServer.password;
                } else {
                    if (storedserverdata && storedserverdata.password) {
                        console.log("setting stored password");
                        this.txtPassword.value = storedserverdata.password;
                    } else {
                        console.log("clearing password");
                        this.txtPassword.value = "";
                    }
                }

                this.txtPassword.enable();
                this.btnSpectate.enable();

                this.setSelectedServer(server_id);
                this.debouncedToggleShowServer();


            };

            serverEntry.onDeselected = (sender, server) => {
                localStorage.removeItem("lastSelectedServerId");
                this.lastSelectedServerId = null;
                this.txtPassword.value = "";
                this.classList.remove("server-selected");

                //     this.applyFiltersAndSorting();
                //     this.refreshVirtualList();
            };

            serverEntry.addEventListener("focus", () => {
                //console.log("Focused", serverEntry.serverData.index);
                this.lastFocusedServerIndex = serverEntry.serverData.index;
            });

            if (server.selected) {
                const show_car_list = this.shouldShowCarList(server);
                serverEntry.select();
                if (this.lastPopulatedCarListServerId != server.server_id) {
                    this.isEligibleServer(server.server_id).then(() => {
                        if (show_car_list) this.getEligibleCars();
                    });
                }
            }

            return serverEntry;
        }

        getEligibleCars() {

            const result = [];

            VEHICLES.dataFilters.carSelectionMode = eClientCommands.Mode.Multi;
            VEHICLES.dataFilters.ownershipState = eCarSelection.State.Owned;

            VEHICLES.getModelsLite().then((owned_data) => {

                result.push(...owned_data.car_model);

                VEHICLES.dataFilters.ownershipState = eCarSelection.State.All;

                VEHICLES.getModelsLite().then((all_data) => {
                    result.push(...all_data.car_model);
                    this.populateEligibleCars(result);
                });


            });
        }

        eligibleCarButtons = [];
        lastPopulatedCarListServerId;

        populateEligibleCars(car_list) {

            this.lastPopulatedCarListServerId = this.lastSelectedServerId;

            this.eligibleCarList.innerHTML = "";
            this.eligibleCarButtons = [];

            console.log("populating car list", car_list.length);
            console.trace(car_list);

            const dfrag = new DocumentFragment();

            let selected = false;
            let selectedButton;

            car_list.forEach(car => {
                const btn = document.createElement("ks-btnpanel");
                btn.setAttribute("lazyload", "");
                btn.setAttribute("toggle", "");
                btn.setAttribute("toggle-group", "selectedcar");
                btn.classList.add("focusable");
                btn.message = car;
                this.eligibleCarButtons.push(btn);

                const sameasstored = ksUI$1.arePguidEqual(car.car_pguid, this.selectedServerStoredData.lastcar);
                const sameascurrent = ksUI$1.arePguidEqual(car.car_pguid, CurrentCar.model.car_pguid);

                if (!selected && (sameasstored || (!sameasstored && sameascurrent))) {
                    btn.classList.add("selected");
                    selected = true;
                    selectedButton = btn;
                }

                dfrag.appendChild(btn);

                btn.onToggled = (sender, e, state) => {
                    if (state) {
                        console.log("Selected", sender.message.car_pguid, sender.message.name);
                        this.selectedCar = sender.message;
                        this.selectedCarPguid = sender.message.car_pguid;
                        this.selectedServerStoredData.lastcar = sender.message.car_pguid;
                        this.btnJoin.enable();
                    }


                };

            });

            this.eligibleCarList.appendChild(dfrag);


            if (selectedButton) {
                selectedButton.toggle(true, true);
                waitForFrames(() => {
                    this.eligibleCarList.parentElement.scrollToElement(selectedButton);
                }, 3);
            } else {
                this.eligibleCarButtons[0].toggle(true, true);
            }


            this.updateAllScrollBars();
            this.setupNavigation();

        }

        connectToServer(is_spectator) {

            localStorage.setItem("loadingDestination", "Multiplayer");
            console.log("Requesting connection to", this.selectedServerId, "with password", this.txtPassword.value.length > 0, "- as spectator: ", is_spectator, this.selectedCarPguid);

            //CurrentCar.model = this.selectedCar;
            //engine.updateWholeModel(CurrentCar);
            //console.log("Updated CurrentCar model", this.selectedCar);

            VEHICLES.setCurrent(this.selectedCar, () => {

                console.log({
                    server_id: this.selectedServerId,
                    server_password: this.txtPassword.value,
                    car_pguid: this.selectedCarPguid,
                    as_spector: is_spectator
                });

                this.ServerClient.request("ConnectToServer", {
                    server_id: this.selectedServerId,
                    server_password: this.txtPassword.value,
                    car_pguid: this.selectedCarPguid,
                    as_spector: is_spectator
                }, (data) => {
                    (
                        {
                            [eJoinErrorMessage.OK]: () => {
                                console.log("Connection accepted, proceeding to server");
                                //ksUI.goToLoadingPage("ingame.html", "event/main", this);
                                this.saveServersData();
                            },
                            [eJoinErrorMessage.WrongCar]: () => {
                                this.errorModal("lblError", "msgWrongCarSelected", false, null, true);
                                console.warn("Connection rejected, wrong car selected");
                            },
                            [eJoinErrorMessage.ServerFull]: () => {
                                this.errorModal("lblError", "msgServerFull", false, null, true);
                                console.warn("Connection rejected, server full");
                            },
                            [eJoinErrorMessage.WrongPassword]: () => {
                                this.errorModal("lblError", "msgInvalidPassword", false, null, true);
                                console.warn("Connection rejected, wrong password");
                            },
                            [eJoinErrorMessage.ServerClosed]: () => {
                                this.errorModal("lblError", "msgServerClosed", false, null, true);
                                console.warn("Connection rejected, server closed");
                            },
                            [eJoinErrorMessage.RequirementsNotMet]: () => {
                                this.errorModal("lblError", "msgRequirementsNotMet", false, null, true);
                                console.warn("Connection rejected, requirements not met");
                            },
                            [eJoinErrorMessage.ClientOutdated]: () => {
                                this.errorModal("lblError", "msgClientOutdated", false, null, true);
                                console.warn("Connection rejected, client outdated");
                            },
                            [eJoinErrorMessage.ServerOutdated]: () => {
                                this.errorModal("lblError", "msgServerOutdated", false, null, true);
                                console.warn("Connection rejected, server outdated");
                            },
                            [eJoinErrorMessage.ClientRejected]: () => {
                                this.errorModal("lblError", "msgClientRejected", false, null, true);
                                console.warn("Connection rejected, client rejected");
                            }

                        }[data.response])();
                });
            });
        }

        pingHandler;

        itemHeights = [];

        evaluateFocus(server_entry) {
            if (ksUI$1.isSpatialNav() && this.lastFocusedServerIndex == server_entry.serverIndex) {

                console.log("attempting to refocus", server_entry.serverIndex);
                this.scrollableContainers[0].preventFocus = true;

                //            server_entry.classList.add("defaultfocus");
                waitForFrames(() => {
                    server_entry.focus();
                    this.scrollableContainers[0].preventFocus = false;
                });


            }
        }

        lastFragment;

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.ServerClient = new MessageHandler("MultiplayerServerList");

            const targetserver_str = ksUI$1.menuState.get().path.split("/")[2];

            if (targetserver_str) {
                const targetserver_spl = targetserver_str.split(":");
                const targetserver_spl_port = targetserver_spl[1].split("|");
                this.targetServer = {
                    ip: targetserver_spl[0],
                    port: targetserver_spl_port[0],
                    password: targetserver_spl_port[1]
                };

                console.warn(this.targetServer);
                localStorage.removeItem("lastSelectedServerId");

                ksUI$1.menuState.get().path = "multiplayer/serverlist";
                ksUI$1.menuState.save();
            }

            localStorage.removeItem("returnPage");
            localStorage.removeItem("carselection_visited");

            ksUI$1.menuState.storeOrigin().save();

            this.mapElementById("btnClipboard");
            this.mapElementById("btnJoin");
            this.mapElementById("btnSpectate");
            this.mapElementById("btnCarSelect");
            this.mapElementById("btnRefresh");
            this.mapElementById("listServers");
            this.mapElementById("wrapperServerList");
            this.mapElementById("notification");

            this.mapElementById("panelFilters");
            this.mapElementById("btnFilterByCar");
            this.mapElementById("btnFilterNoPassword");


            this.mapElementById("btnShowServer");
            this.mapElementById("txtPassword");
            this.mapElementById("txtSearch");

            this.mapElementById("btnSortPlayers");
            this.mapElementById("btnSortPing");

            this.mapElementById("panelServerCount");
            this.mapElementById("panelPlayerCount");


            this.eligibleCarList = q(".car-list .scrollable-content");

            const server_filters = localStorage.getItem("server_filters");

            this.selectedCar = CurrentCar.model;
            this.selectedCarPguid = CurrentCar.model.car_pguid;

            if (!this.targetServer)
                if (server_filters != null) {
                    try {
                        const server_filter_obj = JSON.parse(server_filters);
                        this.serverFilters = { ...server_filter_obj };
                        console.log("Restored server filters");
                    } catch {
                        console.error("Stored server filters could not be parsed");
                    }
                }

            qAllArray(".sorting ks-btnbasic,.filters ks-btnbasic").forEach(btn => {
                const filter_property = btn.dataset.filter;
                btn.toggle(this.serverFilters[filter_property]);
            });

            waitForFrames(() => {
                this.txtSearch.value = this.serverFilters.text;
            });

            this.panelServerTotal = q(".total", this.panelServerCount);
            this.panelServerVisible = q(".value", this.panelServerCount);

            this.panelPlayerTotal = q(".total", this.panelPlayerCount);
            this.panelPlayerVisible = q(".value", this.panelPlayerCount);


            this.listServersContent = q(".scrollable-content", this.listServers);

            this.initStorageContainer(eStorageContainers.ServerPasswords, this.StoredData, this._storedServerData);

            VEHICLES.getCurrent();
            VEHICLES.dataFilters.ownershipState = eCarSelection.State.Owned;
            VEHICLES.dataFilters.activeBrand = VEHICLES.allBrands;

            engine.on("onResize", (first_resize) => {
                if (first_resize) return;
                this.hListConfig.height = this.ENTRIESTOFETCH * ksUI$1.getPxFromRem(this.SERVERENTRYHEIGHT) + "px";
                this.hListConfig.itemHeight = ksUI$1.getPxFromRem(this.SERVERENTRYHEIGHT);
                this.hList.refresh(this.listServersContent, this.hListConfig);
            });

            waitForFrames(() => {
                this.setupNavigation();
                this.getServerList();
            }, 6);
        }

    }

    ksUI$1.registerModule('ks-page-serverlist', MultiPlayerServerList);

    var template$D = "<div class=\"specialevents-body component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" path=\"multiplayer/hub\" class=\"back rounded focusable\"></ks-btnbasic>\r\n            <ks-btnbasic id=\"btnRefresh\" class=\"refresh rounded focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"btnRefresh\">Refresh</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic id=\"btnAssists\" class=\"rounded focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"panelAssists\">Skip All</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal nologo\">\r\n        <div slot=\"label\" data-l10n-id=\"headerSpecialEvents\">Special Events</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body columns\">\r\n\r\n        <div id=\"listEvents\" class=\"items loading scrollable-vertical\">\r\n            <div class=\"scrollable-content per-item-scroll\">\r\n                <ks-btnpanel disable-tooltip lazyload class=\"item focusable\" data-bind-for=\"index,item:{{SpecialEvents.special_events}}\" data-bind-disablevalue=\"{{item.status}} == 'SpecialEventStatus_DISABLED'\" data-bind-class-toggle=\"played:{{item}}.player_position > 0;no-participants:{{item}}.player_count == 0\" data-bind-ksmessage=\"{{item}}\" data-bind-ksvalue=\"{{item.event_guid}}\">\r\n\r\n                    <div slot=\"title\">\r\n\r\n                        <div class=\"name\" data-bind-value=\"{{item.name}}\"></div>\r\n                        <div class=\"car-model\">\r\n                            <div class=\"badge\" data-bind-style-background-image-url=\"ksUI.getBrandBadgeTexturePath({{item}}.car_model)\"></div>\r\n                            <div class=\"brand-name\" data-bind-value=\"ksUI.getManufacturerLocName({{item}}.car_model.manufacturer)\"></div>\r\n                            <div class=\"model-name\" data-bind-value=\"ksUI.getModelWithoutBrand({{item}}.car_model)\"></div>\r\n                        </div>\r\n                        <div class=\"results\">\r\n                            <div class=\"label played\" data-l10n-id=\"lblPosition\"></div>\r\n                            <div class=\"value played\" data-bind-value=\"[{{item}}.player_position, {{item}}.player_count].join('/')\"></div>\r\n                            <div class=\"label not-played\" data-l10n-id=\"lblParticipants\"></div>\r\n                            <div class=\"value not-played\" data-bind-value=\"{{item}}.player_count\"></div>\r\n                            <div class=\"value no-participants\" data-l10n-id=\"lblNoResults\"></div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div slot=\"subtitle\">\r\n\r\n                        <div class=\"conditions\">\r\n                            <div class=\"duration\">\r\n                                <div class=\"label\" data-l10n-id=\"labelDuration\"></div>\r\n                                <div class=\"value\" data-bind-value=\"ksUI.getDurationFromSession({{item}})\"></div>\r\n                            </div>\r\n                            <div class=\"timeofday\">\r\n                                <div class=\"label\" data-l10n-id=\"labelTimeOfDay\"></div>\r\n                                <div class=\"value\" data-bind-value=\"ksUI.getTimeOfDayFromSession({{item}})\"></div>\r\n                            </div>\r\n                            <div class=\"weather\">\r\n                                <div class=\"label\" data-l10n-id=\"panelWeatherSettings\"></div>\r\n                                <div class=\"value maskedIcon\" data-bind-class=\"{{item}}.weather_preset\"></div>\r\n                                <!-- <i class=\"icon\" data-bind-class=\"{{item.weather_preset}}\"></i> -->\r\n                            </div>\r\n                            <div class=\"track-condition\">\r\n                                <div class=\"label\" data-l10n-id=\"lblTrackCondition\"></div>\r\n                                <div class=\"value\" data-bind-l10n-id=\"'UI' + {{item}}.initial_grip\"></div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div class=\"modeandtrack\">\r\n                            <div class=\"trackmap\" data-bind-style-background-image-url=\"ksUI.getTrackMapSvgPath({{item}}.track_item)\"></div>\r\n                            <div class=\"gamemode\" data-bind-value=\"APF().gamemode({{item.type}})\"></div>\r\n                            <div class=\"trackname\" data-bind-value=\"{{item.track_item.name}}\"></div>\r\n                            <div class=\"tracklayout\" data-bind-value=\"{{item.track_item.layout}}\"></div>\r\n                        </div>\r\n\r\n                        \r\n                    </div>\r\n\r\n                </ks-btnpanel>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n\r\n\r\n</div>\r\n\r\n";

    class MultiPlayerSpecialEvents extends KsHTMLElement {
        /** @type MessageHandler */
        GameModeClient;

        /** @type {Btnbasic} */
        btnRefresh;

        /** @type {Btnbasic} */
        btnBack;

        /** @type {Btnbasic} */
        btnAssists;

        listEvents;
        firstload = true;

        constructor() {
            super();
            this.template = template$D;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this.delayedInit = true;
            this.shouldRenderControlHints = true;
            this._bindScrollableEvents = true;
        }

        filters = {

            translate: (string) => {
                return engine.translate(string);
            },

            duration: (duration, duration_type) => {
                return duration_type == eGameModeSelection.RaceType.Laps ? duration : ksUI$1.formatTimeLong(duration * 1000);
            },

            duration_type: (duration_type) => {
                if (duration_type == eGameModeSelection.RaceType.Laps) {
                    return engine.translate("labelLaps")
                }
                return "";
            },

            time: (time_of_day) => {
                return [time_of_day.hour, ksUI$1.pad(time_of_day.minute, 2)].join(":");
            },

            weather: (weather) => {
                const weatherStatus = {
                    GameModeSelectionWeatherType_CLEAR : "CLEAR",
                    GameModeSelectionWeatherType_SCATTERED_CLOUDS : "SCATTERED CLOUDS",
                    GameModeSelectionWeatherType_BROKEN_CLOUDS : "BROKEN CLOUDS",
                    GameModeSelectionWeatherType_OVERCAST : "OVERCAST",
                    GameModeSelectionWeatherType_DRIZZLE : "DRIZZLE",
                    GameModeSelectionWeatherType_RAIN : "RAIN",
                    GameModeSelectionWeatherType_HEAVY_RAIN : "HEAVY RAIN",
                    GameModeSelectionWeatherType_CUSTOM : "CUSTOM",
                    GameModeSelectionWeatherType_DAMP : "DAMP",
                };        
                return weatherStatus[weather];
            },

            gamemode: (gamemode) => {
                return Object.keys(eGameModeType).find(key => eGameModeType[key] === gamemode)
                .toUpperCase();
            }
        }

        bindEvent(ev) {

            const event_id = ev.currentTarget.dataset.value;

            AP().GameModeClient.request("JoinSpecialEvent", {
                event_guid: event_id
            }

                , (data) => {
                    ({
                        [eClientCommands.Response.OK]: () => {

                            localStorage.setItem("loadingDestination", "SpecialEvent");
                            ksUI$1.setOriginAsReturnPage();
                            console.log("Selecting event", event_id);
                        },
                        [eClientCommands.Response.CriticalError]: () => {
                            this.errorModal("lblError", "msgCouldNotLoadEvent", false, null, true);
                            console.error("Could not load event", event_id);
                        }
                    }[data.response])();

                });
        }

        bindEvents() {

            if (!this.firstload) {
                //Scrollbar.updateAllComponents();
                SpatialNavigation.clear();
                this.setupNavigation();
            }
            this.firstload = false;

            qevAll("ks-btnpanel", "click sn:enter-down", this.bindEvent, this.listEvents);
        }

        bindControls() {

        }

        onAfterRenderControlHints(controlhints) {
            this.mapElementById("btnRefresh", controlhints);
            this.mapElementById("btnBack", controlhints);
            this.mapElementById("btnAssists", controlhints);

            this.btnRefresh.onPressed = () => this.load();


            this.btnAssists.onPressed = () => {
                ksUI$1.goTo("singleplayer.html","singleplayer/assists");
            };

            this.btnBack.onBeforeRedirect = () => {
                ksUI$1.requestGoBack(eGameModeSelection.BackFrom.SpecialEvents);

                if(this.documentBody.classList.contains("release-build")) {
                    ksUI$1.goTo("menu.html", "main/main");
                    return false;
                }
            };
        }

        onRemovedFromDOM() {

        }

        load() {
            this.listEvents.classList.add("loading");

            this.GameModeClient.request("SpecialEvents", {}, (data) => {

                ({
                    [eClientCommands.Response.OK]: () => {
                        this.assignModel(data, "SpecialEvents", true);
                        waitForFrames(() => this.bindEvents(), 1);
                        this.listEvents.classList.remove("loading");
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        this.listEvents.classList.add("error");
                        console.error("Could not load special events", data.response);
                    },
                    [eClientCommands.Response.BackendDisconnected]: () => {
                        this.listEvents.classList.add("error");
                        console.error("Could not load special events", data.response);

                    }
                }[data.response])();

                waitForFrames(() => {
                    this.setupNavigation();
                });
            });

        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.GameModeClient = new MessageHandler("GameModeSelectionClient");

            localStorage.removeItem("returnPage");
            ksUI$1.menuState.storeOrigin().save();

            this.mapElementById("listEvents");

            this.load();


        }

    }

    ksUI$1.registerModule('ks-page-specialevents', MultiPlayerSpecialEvents);

    class MultiPlayerPage extends KsHTMLElement {

        CarSelection = new CarSelectionManager(eClientCommands.Mode.Multi, this);

        constructor() {
            super();
            this.template = template$I;
            this._isnavigable = true;
            this.delayedInit = false;
            this.disableCameraControl = true;
            this.title = engine.translate("headerMultiplayer");
        }


        onTemplateLoaded() {
            super.onTemplateLoaded();
            ksUI$1.Models.disable(DataModels.SessionState);
            this.CarSelection.getCurrent();
            document.body.classList.add("multiplayer");
        }

        onRemovedFromDOM() {
            document.body.classList.remove("multiplayer");
        }

    }

    engine.on("MenuStateInit", () => {
        ksUI$1.registerModule('ks-page-multiplayer', MultiPlayerPage);
    });

    var template$C = "<div class=\"component-body\" data-mode=\"home\">\r\n\r\n    <div id=\"acelogo\"></div>\r\n\r\n    <!-- <ks-playerprogress></ks-playerprogress> -->\r\n\r\n    <ks-page-vehicles-hub opaque class=\"submode renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'hub'\">\r\n    </ks-page-vehicles-hub>\r\n\r\n\r\n    <ks-page-carselection garage title=\"headerYourGarage/headerMyCars\" class=\"submode carselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'garage/carselection'\">\r\n    </ks-page-carselection>\r\n\r\n    <ks-page-brandselection garage opaque class=\"submode brandselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'garage/brandselection'\">\r\n    </ks-page-brandselection>\r\n\r\n    <ks-page-modelselection garage opaque class=\"submode modelselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'garage/modelselection'\">\r\n    </ks-page-modelselection>\r\n\r\n    <ks-page-vehiclepresetselection garage class=\"submode presetselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'garage/presetselection'\">\r\n    </ks-page-vehiclepresetselection>\r\n\r\n\r\n    <ks-page-carselection dealership title=\"headerDealership/headerCarHub\" class=\"submode carselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'dealership/carselection'\">\r\n    </ks-page-carselection>\r\n\r\n    <ks-page-brandselection dealership opaque class=\"submode brandselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'dealership/brandselection'\">\r\n    </ks-page-brandselection>\r\n\r\n    <ks-page-modelselection dealership opaque class=\"submode modelselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'dealership/modelselection'\">\r\n    </ks-page-modelselection>\r\n\r\n    <ks-page-vehiclepresetselection dealership mechs class=\"submode presetselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'dealership/presetselection'\">\r\n    </ks-page-vehiclepresetselection>\r\n\r\n    <!-- <ks-page-vehiclepresetselection dealership visuals\r\n        class=\"submode presetselection renderControlHints delayedInit\"\r\n        data-bind-if=\"{{ModelMenuState.path}} === 'dealership/presetselectionvisual'\">\r\n    </ks-page-vehiclepresetselection> -->\r\n\r\n\r\n    <ks-page-paintshop dealership title=\"headerCustomizeVehicle\" class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.path}} === 'dealership/customize'\" data-mode=\"main\"></ks-page-paintshop>\r\n\r\n\r\n    <ks-page-carselection dealership usedvehicles title=\"headerDealership\" class=\"submode carselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'usedvehicles/carselection'\">\r\n    </ks-page-carselection>\r\n\r\n    <ks-page-brandselection dealership usedvehicles opaque title=\"headerDealership\" class=\"submode brandselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'usedvehicles/brandselection'\">\r\n    </ks-page-brandselection>\r\n\r\n    <ks-page-modelselection dealership usevehicles opaque class=\"submode modelselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'usedvehicles/modelselection'\">\r\n    </ks-page-modelselection>\r\n\r\n\r\n\r\n\r\n    <ks-page-carselection rental title=\"headerRental\" class=\"submode carselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'rental/carselection'\">\r\n    </ks-page-carselection>\r\n\r\n    <ks-page-brandselection rental opaque title=\"headerRentals\" class=\"submode brandselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'rental/brandselection'\">\r\n    </ks-page-brandselection>\r\n\r\n    <ks-page-modelselection rental opaque class=\"submode modelselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'rental/modelselection'\">\r\n    </ks-page-modelselection>\r\n\r\n    <ks-page-vehiclepresetselection rental class=\"submode presetselection renderControlHints delayedInit\" data-bind-if=\"{{ModelMenuState.path}} === 'rental/presetselection'\">\r\n    </ks-page-vehiclepresetselection>\r\n\r\n\r\n</div>";

    var template$B = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" goto=\"menu.html\" path=\"main/main\" class=\"back rounded focusable\"></ks-btnbasic>\r\n        </div> \r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\" data-l10n-id=\"headerVehiclesHub\">Vehicles Hub</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body\">\r\n        <div class=\"row large centered-content\">\r\n\r\n            <ks-btnpanel id=\"btnGarage\" class=\"focusable\" path=\"garage/carselection\" storeorigin=\"true\">\r\n                <div slot=\"title\" data-l10n-id=\"panelYourGarage\"></div>\r\n                <div slot=\"subtitle\"></div>\r\n            </ks-btnpanel>\r\n\r\n            <ks-btnpanel id=\"btnDealership\" class=\"focusable\" path=\"dealership/brandselection\" storeorigin=\"true\">\r\n                <div slot=\"title\" data-l10n-id=\"panelDealership\"></div>\r\n                <div slot=\"subtitle\"></div>\r\n            </ks-btnpanel>\r\n\r\n            <ks-btnpanel id=\"btnUsedVehicles\" class=\"focusable\" path=\"usedvehicles/brandselection\" disabled=\"disabled\">\r\n                <div slot=\"title\" data-l10n-id=\"panelUsedVehicles\"></div>\r\n                <div slot=\"subtitle\">\r\n                </div>\r\n            </ks-btnpanel>\r\n\r\n        </div>\r\n\r\n        \r\n    </div>\r\n\r\n</div>";

    class VehiclesHub extends KsHTMLElement {

        btnStartSession;
        btnGarage;

        constructor() {
            super();
            this.template = template$B;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this.delayedInit = true;
        }

        filters = {
        }

        bindControls() {
        }

        onRemovedFromDOM() {
            VEHICLES.clearHandlers();
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            VEHICLES.resetFilters();

            ksUI$1.menuState.toggleMouseHover(true);

            this.mapElementById("btnStartSession");
            this.mapElementById("btnGarage");

            VEHICLES.getCurrent().then((data) => {
                if(!window["CurrentCar"]) {
                    this.btnGarage.setAttribute("path", "garage/brandselection");
                }
                
            });

            
        }

    }

    ksUI$1.registerModule('ks-page-vehicles-hub', VehiclesHub);

    var template$A = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic path=\"multiplayer/hub\" class=\"back rounded focusable\"></ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"full nologo\">\r\n        <div slot=\"label\" data-l10n-id=\"headerDealership\">Special Events</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body columns\">\r\n\r\n        \r\n\r\n    </div>\r\n\r\n</div>";

    class DealershipPage extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$A;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this.delayedInit = false;
            this.shouldRenderControlHints = true;
        }

        filters = {

        }

        bindControls() {

        }

        onRemovedFromDOM() {

        }


        onTemplateLoaded() {
            super.onTemplateLoaded();
        }

    }

    ksUI$1.registerModule('ks-page-dealership', DealershipPage);

    var template$z = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic path=\"multiplayer/hub\" class=\"back rounded focusable\"></ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"full nologo\">\r\n        <div slot=\"label\" data-l10n-id=\"headerSpecialEvents\">Special Events</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body columns\">\r\n\r\n        \r\n\r\n    </div>\r\n\r\n</div>";

    class UsedVehiclesPage extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$z;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this.delayedInit = false;
            this.shouldRenderControlHints = true;
        }

        filters = {

        }

        bindControls() {

        }

        onRemovedFromDOM() {

        }


        onTemplateLoaded() {
            super.onTemplateLoaded();
        }

    }

    ksUI$1.registerModule('ks-page-usedvehicles', UsedVehiclesPage);

    class VehiclesPage extends KsHTMLElement {

               

        constructor() {
            super();
            this.template = template$C;
            this._isnavigable = true;
            this.delayedInit = false;
            this.disableCameraControl = true;
        }

        bindControls() {
            engine.on("OnCarPurchased", (car_model) => {
                console.log("Redirecting to player garage after purchase");
                ksUI$1.changePage("garage/carselection");
            });
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            //VEHICLES.getModels();
            VEHICLES.getCurrent();
            //ksUI.menuState.overrideOrigin(null, "main/hub").save();
        }

        onRemovedFromDOM() {
            VEHICLES.cleanAssignedModels();
            VEHICLES.resetFilters();
        }

    }
    engine.on("MenuStateInit", () => {
        ksUI$1.registerModule('ks-page-vehicles', VehiclesPage);
    });

    var template$y = "<div class=\"component-body\">\r\n    <div id=\"acelogo\"></div>\r\n\r\n    <div class=\"submode replays\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'replays'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'replays'\">\r\n        <ks-page-replaygallery class=\"delayedInit renderControlHints\" opaque data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'replays'\"></ks-page-replaygallery>\r\n    </div>\r\n\r\n    <div class=\"submode photo\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'photo'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'photo'\">\r\n        <ks-page-replaygallery class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'photo'\"></ks-page-replaygallery>\r\n    </div>\r\n\r\n    \r\n    \r\n\r\n</div>";

    var template$x = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" goto=\"menu.html\" path=\"main/main\" class=\"back rounded focusable\"></ks-btnbasic>\r\n        </div> \r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\" data-l10n-id=\"headerGalleryHub\">Gallery Hub</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body\">\r\n        <div class=\"row large centered-content\">\r\n\r\n            <ks-btnpanel id=\"btnReplay\" class=\"focusable\" path=\"gallery/replaygallery\" storeorigin=\"true\">\r\n                <div slot=\"title\" data-l10n-id=\"panelReplay\"></div>\r\n                <div slot=\"subtitle\"></div>\r\n            </ks-btnpanel>\r\n\r\n           \r\n        </div>\r\n\r\n        \r\n    </div>\r\n\r\n</div>";

    class GalleryHub extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$x;
            this._isnavigable = true;
        }

        onAfterRenderControlHints(controlhints) {
            this.btnBack = q(".back", controlhints);

            this.btnBack.onPressed = () => {
                 ksUI$1.returnToOrigin();
            };
        }

        bindControls() {
            qevAll(".main .btn", "click sn:enter-down",
                (e) => {
                    ksUI$1.changePage("gallery/" + e.target.dataset.submode, false, false);
                }, this);
        }


    }

    ksUI$1.registerModule('ks-page-gallery-hub', GalleryHub);

    var template$w = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back focusable\"></ks-btnbasic>\r\n        </div>\r\n\r\n        <div class=\"group center\"></div>\r\n\r\n        <div class=\"group end\">\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\">\r\n            <div data-l10n-id=\"headerGallery\">Gallery</div>\r\n            <div>/</div>\r\n            <div data-l10n-id=\"headerReplays\">Replay</div>\r\n        </div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body is-flex-column\">\r\n        <div id=\"btnGroupModes\" class=\"is-flex-row\">\r\n\r\n            <div class=\"controltip\">\r\n            </div>\r\n\r\n            <ks-btnbasic class=\"focusable selected\" data-mode=\"user\" toggle-group=\"section\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"lblReplaysUserSaved\">User Saved</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic class=\"focusable hud\" data-mode=\"auto\" toggle-group=\"section\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"lblReplaysAutoSaved\">Auto Saved</div>\r\n            </ks-btnbasic>\r\n\r\n            <div class=\"controltip\">\r\n            </div>\r\n\r\n        </div>\r\n        <div id=\"panelModes\" data-mode=\"user\" class=\"column\">\r\n\r\n            <div class=\"user scrollable-vertical is-flex-column\">\r\n                <div class=\"scrollable-content\">\r\n                    <div class=\"no-replays\" data-l10n-id=\"lblReplaysNoUserReplaysSaved\"></div>\r\n                    <div class=\"no-auto-replays\" data-l10n-id=\"lblReplaysNoAutoReplaysSaved\"></div>\r\n                    <div class=\"item focus-indicator\" lazyload data-bind-for=\"index, iter: {{Replays.replays}}\" data-bind-class=\"{{iter}}.season_type\" data-bind-class-toggle=\"corrupted:{{iter.is_corrupted}}\">\r\n\r\n                        <div class=\"season-type\" data-bind-if=\"{{iter}}.season_type != 'SeasonDefinitionType_SinglePlayer'\" data-bind-value=\"APF()?.seasontype({{iter}}.season_type)\"></div>\r\n\r\n                        <div class=\"filename\" data-bind-value=\"{{iter.filename}}\" data-bind-ksvalue=\"{{iter.filename}}\"></div>\r\n                        <div class=\"bar\"></div>\r\n                        <div class=\"data\">\r\n                            <div class=\"main\">\r\n                                <div class=\"name\" data-bind-value=\"APF()?.name({{iter}})\" data-bind-ksvalue=\"{{iter.name}}\"></div>\r\n                                <div class=\"date\">\r\n                                    <div class=\"timestamp\" data-bind-value=\"APF()?.date({{iter.timestamp}})\" data-bind-ksvalue=\"{{iter.timestamp.month}}\"></div>\r\n                                </div>\r\n                                <div class=\"verticalspacer\"></div>\r\n                                <div class=\"duration\">\r\n                                    <div class=\"label\" data-l10n-id=\"lblReplaysDuration\">:</div>\r\n                                    <div class=\"time\" data-bind-value=\"ksUI.formatTime(Math.round({{iter.duration}} * 1000), 3)\" data-bind-ksvalue=\"{{iter.duration}}\"></div>\r\n                                </div>\r\n                            </div>\r\n                            <div class=\"details\">\r\n                                <div class=\"incompatible\" data-l10n-id=\"lblReplaysIncompatibleGameVersion\"></div>\r\n                                <div class=\"info\">\r\n                                    <div class=\"track\" data-bind-value=\"{{iter.track_item.name}}\" data-bind-ksvalue=\"{{iter.track_item.name}}\"></div>\r\n                                    <div class=\"car\" data-bind-value=\"{{iter.car}}\" data-bind-ksvalue=\"{{iter.car}}\"></div>\r\n                                </div>\r\n                                <div class=\"controls\">\r\n                                    <ks-btnbasic class=\"save rounded-half-left focusable\" data-bind-ksvalue=\"{{iter}}\">\r\n                                        <div slot=\"name\" data-l10n-id=\"btnSave\"></div>\r\n                                    </ks-btnbasic>\r\n                                    <ks-btnbasic class=\"load rounded-half-left focusable\" data-bind-ksvalue=\"{{iter}}\">\r\n                                        <div slot=\"name\" data-l10n-id=\"btnLoad\"></div>\r\n                                    </ks-btnbasic>\r\n                                    <ks-btnbasic class=\"delete rounded-half-right focusable\" data-bind-ksvalue=\"{{iter}}\">\r\n                                        <div slot=\"name\" data-l10n-id=\"btnDelete\"></div>\r\n                                    </ks-btnbasic>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- AUTO SECTION -->\r\n            <!-- \r\n            <div class=\"auto scrollable-vertical is-flex-column\">\r\n                <div class=\"scrollable-content\">\r\n                    <div class=\"no-replays\" data-l10n-id=\"lblReplaysNoAutoReplaysSaved\"></div>\r\n                    <div class=\"item focus-indicator\" data-bind-for=\"index, iter: {{Replays.replays}}\"\r\n                        data-bind-class-toggle=\"corrupted:{{iter.is_corrupted}}\">\r\n                        <div class=\"season-type\" data-bind-l10n=\"\"></div>\r\n                        <div class=\"filename\" data-bind-value=\"{{iter.filename}}\" data-bind-ksvalue=\"{{iter.filename}}\"></div>\r\n                        <div class=\"bar\"></div>\r\n                        <div class=\"data\">\r\n                            <div class=\"main\">\r\n                                <div class=\"name\" data-bind-value=\"APF()?.name({{iter}})\" data-bind-ksvalue=\"{{iter.name}}\"></div>\r\n                                <div class=\"date\">\r\n                                    <div class=\"timestamp\" data-bind-value=\"APF()?.date({{iter.timestamp}})\" data-bind-ksvalue=\"{{iter.timestamp.month}}\"></div>\r\n                                </div>\r\n                                <div class=\"verticalspacer\"></div>\r\n                                <div class=\"duration\">\r\n                                    <div class=\"label\" data-l10n-id=\"lblReplaysDuration\">:</div>\r\n                                    <div class=\"time\" data-bind-value=\"ksUI.formatTime(Math.round({{iter.duration}} * 1000), 3)\" data-bind-ksvalue=\"{{iter.duration}}\"></div>\r\n                                </div>\r\n\r\n                            </div>\r\n                            <div class=\"details\">\r\n                                <div class=\"incompatible\" data-l10n-id=\"lblReplaysIncompatibleGameVersion\"></div>\r\n                                <div class=\"info\">\r\n                                    <div class=\"track\" data-bind-value=\"{{iter.track_item.name}}\" data-bind-ksvalue=\"{{iter.track_item.name}}\"></div>\r\n                                    <div class=\"car\" data-bind-value=\"{{iter.car}}\" data-bind-ksvalue=\"{{iter.car}}\"></div>\r\n                                </div>\r\n                                <div class=\"controls\">\r\n                                    <ks-btnbasic class=\"save rounded-half-left focusable\" data-bind-ksvalue=\"{{iter}}\">\r\n                                        <div slot=\"name\" data-l10n-id=\"btnSave\"></div>\r\n                                    </ks-btnbasic>\r\n                                    <ks-btnbasic class=\"load rounded-half-left focusable\" data-bind-ksvalue=\"{{iter}}\">\r\n                                        <div slot=\"name\" data-l10n-id=\"btnLoad\"></div>\r\n                                    </ks-btnbasic>\r\n                                    <ks-btnbasic class=\"delete rounded-half-right focusable\" data-bind-ksvalue=\"{{iter}}\">\r\n                                        <div slot=\"name\" data-l10n-id=\"btnDelete\"></div>\r\n                                    </ks-btnbasic>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div> -->\r\n        </div>\r\n    </div>\r\n</div>";

    class ReplayGalleryPage extends KsHTMLElement {

        /** @type MessageHandler */
        Client;
        /** @type Btnbasic */
        btnBack;
        /** @type Btnbasic */
        btnDelete;
        /** @type Btnbasic */
        btnLoad;
        /** @type Btnbasic */
        btnSave;
        /** @type HTMLDivElement */
        panelModes;

        isDirty = false;
        firstload = true;
        btnSwitch = [];

        filters = {
            date: (timestamp) => {
                const months_loc = engine.translate(`month_${timestamp.month}_short`);
                return `${months_loc} ${timestamp.day}, 20${timestamp.year} - ${String(timestamp.hour).padStart(2, '0')}:${String(timestamp.minute).padStart(2, '0')}:${String(timestamp.second).padStart(2, '0')}`;
            },
            name: (replay) => {

                let output = replay.name.toUpperCase();

                if (replay.game_mode_type != undefined && replay.game_mode_type != eGameModeType.None) {
                    output = engine.translate(replay.game_mode_type);
                }
                const fallback_id = `GameModeType_${replay.name.toUpperCase()}`;
                const translated = engine.translate(fallback_id);

                if (translated != fallback_id) {
                    output = translated;
                }

                if (replay.description != "") {
                    output = `${output} (${replay.description})`;
                }

                return output;
            },
            seasontype: (season_type) => {
                return engine.translate(season_type);
            }
        }

        constructor() {
            super();
            this.template = template$w;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this._bindScrollableEvents = true;
            this.onDeleteBound = this.onDeletePressed.bind(this);
            this.onLoadBound = this.onLoadPressed.bind(this);
            this.onSaveBound = this.onSavePressed.bind(this);
            this.replayType = "UserSaved";
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.Client = new MessageHandler("ReplayGallery");
            this.mapElementById("panelModes");
            this.load();
        }

        load(clear_dirty = true) {
            q(".user .no-replays, .auto .no-replays").style.display = "none";
            this.Client.request("Gallery", {
                type: this.replayType
            }, (response) => {
                console.log(`Loading '${this.replayType}' replay gallery!`);
                ksUI$1.assignModel(response, "Replays");

                this.checkIfReplaysAvaialable(response);

                ksUI$1.waitForFrames(() => {
                    this.onPopulated();
                }, 8);
            });
        }

        checkIfReplaysAvaialable(response) {
            if (response.replays.length == 0) {
                if (this.replayType == "UserSaved") {
                    q(".user .no-replays").style.display = "flex";
                    q(".user .no-auto-replays").style.display = "none";
                } else {
                    q(".user .no-auto-replays").style.display = "flex";
                }
            }
        }

        onRemovedFromDOM() {
            ksUI$1.unassignModel("Replays");
        }

        reset() {
            console.log("Reset Gameplay settings");
            ksUI$1.unassignModel("Replays");
            this.load();
        }

        onPopulated() {
            qevAll(".items .name", BTNEVENTS, this.onSelectBound, this);
            qevAll(".user .delete, .auto .delete", BTNEVENTS, this.onDeleteBound, this);
            qevAll(".user .load, .auto .load", BTNEVENTS, this.onLoadBound, this);
            qevAll(".save", BTNEVENTS, this.onSaveBound, this);

            if (!this.firstload) {
                //Scrollbar.updateAllComponents();
                SpatialNavigation$1.clear();
                this.setupNavigation();
            }

            this.firstload = false;
        }

        onLoadPressed(e) {
            this.loadReplay(e.currentTarget.closest('.item').querySelector('.filename').dataset.value);
        }

        onSavePressed(e) {
            this.saveReplay(e.currentTarget.closest('.item').querySelector('.filename').dataset.value);
        }

        saveReplay(replay_name) {
            console.log("Save replay", replay_name);
            this.Client.request("MoveReplay", {
                type: this.replayType,
                filename: replay_name
            }, (response) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        console.log("Replay saved!");
                        this.load();
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Replay failed to save!");
                    }
                }[response.response])();
            });
        }

        loadReplay(replay_name) {
            console.log("Load replay", replay_name);
            this.Client.request("LoadReplay", {
                type: this.replayType,
                filename: replay_name
            }, (response) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        console.log(`Loading '${this.replayType}' replay '${replay_name}'!`);
                        ksUI$1.setCurrentAsReturnPage();
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Replay failed to load!");
                    }
                }[response.response])();
            });
        }

        onDeletePressed(e) {
            let replay_name = e.currentTarget.closest('.item').querySelector('.name').dataset.value;
            replay_name += " - " + e.currentTarget.closest('.item').querySelector('.track').dataset.value;

            let replay_to_delete = e.currentTarget.closest(".item").querySelector('.filename').dataset.value;

            this.pageModal.onConfirm = () => this.deleteReplay(replay_to_delete);
            this.pageModal.Show({
                buttons: 0x101,
                title: "lblWarning",
                message: "msgAreYouSureDelete",
                confirm: "btnDelete",
                msgVariables: { filename: replay_name }
            });
        }

        deleteReplay(replay_name) {
            this.Client.request("DeleteReplay", {
                type: this.replayType,
                filename: replay_name
            }, (response) => {
                ({
                    [eClientCommands.Response.OK]: () => {
                        console.log(`Deleting '${this.replayType}' replay '${replay_name}'!`);
                        this.load();
                    },
                    [eClientCommands.Response.CriticalError]: () => {
                        console.error("Replay failed to delete!");
                    }
                }[response.response])();
            });
        }

        onAfterRenderControlHints(controlhints) {
            this.btnBack = q(".back", controlhints);

            this.btnBack.onPressed = () => {
                ksUI$1.goTo("menu.html", "main/main");
            };
        }

        getSwitchButtons() {
            qAll("ks-btnbasic[toggle-group=section]").forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    this.btnSwitch.push(elem);
                });
        }

        bindControls() {
            qAll("ks-btnbasic[toggle-group=section]").forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        if (state) {

                            this.panelModes.dataset.mode = sender.dataset.mode;
                        }

                        if (sender.dataset.mode == "auto") {
                            this.replayType = "AutoSave";
                            //$.q(".auto").scrollTop = 0;
                        } else {
                            this.replayType = "UserSaved";
                            q(".user .no-auto-replays").style.display = "none";
                            //$.q(".user").scrollTop = 0;
                        }

                        activePage.scrollableContainers[0].content.scrollTop = 0;
                        activePage.updateAllScrollBars();
                        this.load();

                    };
                });
        }
    }

    ksUI$1.registerModule('ks-page-replaygallery', ReplayGalleryPage);

    var template$v = "<div class=\"component-body\">\r\n    <component-slot data-name=\"controls\"></component-slot>\r\n\r\n    <component-slot data-name=\"header\">\r\n    </component-slot>\r\n\r\n    <div class=\"submode-body\">\r\n        <div class=\"column centered\">\r\n\r\n            <div class=\"panel\">\r\n\r\n                <div class=\"current\">\r\n                    <ks-textinput id=\"inputFilename\" class=\"focusable\" maxlength=\"25\"></ks-textinput>\r\n                    <!-- <input class=\"focusable\" name=\"presetname\" type=\"text\" value=\"\"> -->\r\n                    <ks-btnbasic id=\"savePreset\" class=\"save focusable rounded-half-right\">\r\n                        <div slot=\"name\" data-l10n-id=\"btnSave\"></div>\r\n                    </ks-btnbasic>\r\n                </div>\r\n\r\n                <div class=\"items\">\r\n                    <div class=\"content scrollable-vertical\">\r\n                        <div class=\"scrollable-content\">\r\n                            <div class=\"item focus-indicator\" data-bind-for=\"index, iter: {{PresetList.filenames}}\">\r\n                                <div class=\"name\" data-bind-value=\"{{iter}}\" data-bind-ksvalue=\"{{iter}}\">Item 1 has a very long name that might clip if the player keeps typing</div>\r\n                                <div class=\"controls\">\r\n                                    <ks-btnbasic class=\"load rounded-half-left focusable\" data-bind-ksvalue=\"{{iter}}\">\r\n                                        <div slot=\"name\" data-l10n-id=\"btnLoad\"></div>\r\n                                    </ks-btnbasic>\r\n                                    <ks-btnbasic class=\"delete rounded-half-right focusable\" data-bind-ksvalue=\"{{iter}}\">\r\n                                        <div slot=\"name\" data-l10n-id=\"btnDelete\"></div>\r\n                                    </ks-btnbasic>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n\r\n        </div>\r\n    </div>\r\n\r\n</div>";

    class PresetManager extends KsHTMLElement {

        presetType;
        loading;
        inputFilename;
        btnSave;
        btnBack;
        scrollbarItems;
        settings;
        firstload = true;

        constructor() {
            super();
            this._isnavigable = this.request;
            this.delayedInit = true;
            this.template = template$v;
            this.messagePrefix = "Settings";
            this.presetType = "";
            this.onSelectBound = this.onSelectPreset.bind(this);
            this.onDeleteBound = this.onDeletePressed.bind(this);
            this.onLoadBound = this.onLoadPressed.bind(this);
            this._exposeAsActivePage = true;
            this._bindScrollableEvents = true;
        }

        presetRequest(request_name, ...args) {
            if(this.presetType == "CarSetup") {
                this.messagePrefix = "CarSetup";
                this.request(request_name, ...args);
            } else {
                this.request(this.presetType + request_name, ...args);
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
           
            this.presetType = this.getAttribute("preset-type");

            this.inputFilename = q("#inputFilename", this);
            this.btnSave = q("#savePreset", this);
            if (this.presetType) {
                this.load();
            } else {
                console.log("ks-presetmanager", "please define preset-type attribute");
            }
        }

        onAfterRenderControlHints(controlhints) {
            this.btnBack = q("ks-btnbasic.back", controlhints);
        }

        load() {
            this.loading = true;
            this.presetRequest("PresetList", { version: 0 }, (response) => {
                console.log(response);
                ksUI$1.assignModel(response, "PresetList");
                ksUI$1.waitForFrames(() => {
                    this.loading = false;
                    this.onPopulated();
                });
            });
        }

        loadPreset(preset_name) {
            console.log("Load preset", preset_name);
            this.presetRequest("LoadPreset", {
                filename: preset_name
            }, (response) => {
                if (response.response == "OK") {
                    this.btnBack.redirect();
                } else {
                    this.rootModal().Show();
                }
            });
        }

        deletePreset(preset_name) {
            console.log("Delete preset", preset_name);
            this.presetRequest("DeletePreset", {
                filename: preset_name
            }, (response) => {
                if (response.response == "OK") {
                    this.load();
                } else {
                    this.rootModal().Show();
                }
            });

        }

        savePreset(preset_name) {        
            var payload = {
                filename: this.inputFilename.value
            };

            this.presetRequest("SavePreset", payload, (response) => {            
                if (response.response == "OK") {
                    console.log("Saved preset", preset_name);
                    this.load();
                } else {
                    console.log("Failed to save preset", preset_name);
                    this.rootModal().Show();
                }
            });
        }

        onPopulated() {
            qevAll(".items .name", BTNEVENTS, this.onSelectBound, this);
            qevAll(".items .delete", BTNEVENTS, this.onDeleteBound, this);
            qevAll(".items .load", BTNEVENTS, this.onLoadBound, this);

            if (!this.firstload) {
                //Scrollbar.updateAllComponents();
                SpatialNavigation$1.clear();
                this.setupNavigation();
            }

            this.firstload = false;
        }

        onSelectPreset(e) {
            this.inputFilename.value = e.target.dataset.value;
        }

        onDeletePressed(e) {

            let preset_name = e.currentTarget.dataset.value;

            this.pageModal.onConfirm = () => this.deletePreset(preset_name);

            this.pageModal.Show({
                buttons: 0x101,
                title: "lblWarning",
                message: "msgAreYouSureDelete",
                confirm: "btnDelete",
                msgVariables: { filename: preset_name }
            });

        }

        onLoadPressed(e) {
            this.loadPreset(e.currentTarget.dataset.value);
        }


        bindControls() {

            //this.inputFilename.value = ksUI.getGuid();

            //this.inputFilename.addEventListener("click", () => { this.inputFilename.value = ksUI.getGuid() });


            this.btnSave.onPressed = (e) => {
                let filename = this.inputFilename.value;
                

                if (!ksUI$1.validateFileName(filename)) {
                    //this.pageModal.onConfirm = () => this.savePreset(filename);

                    this.pageModal.onConfirm = () => this.pageModal.Hide();

                    this.pageModal.Show({
                        buttons: 0x100,
                        title: "lblError",
                        message: "msgInvalidFilename",
                        confirm: "btnReturn"
                        //,msgVariables: { filename: filename }
                    });

                } else if (PresetList.filenames.indexOf(filename) > -1) {
                    this.pageModal.onConfirm = () => this.savePreset(filename);

                    this.pageModal.Show({
                        buttons: 0x101,
                        title: "lblWarning",
                        message: "msgAreYouSureOverwrite",
                        confirm: "btnOverwrite",
                        msgVariables: { filename: filename }
                    });

                } else {
                    this.savePreset(this.inputFilename.value);
                }
            };

            //Scrollbar.create({ selector: '.items', contentSelector: '.content' });

            //$.q(".items", this).addEventListener("wheel", (e) => {
            //let scrl = Scrollbar.components.entries().next().value[0];
            //scrl.scrollTo(scrl.scrollPosition - (e.deltaY / 25));
            //});


        }

        onRemovedFromDOM() {
            //Scrollbar.components.clear();
            ksUI$1.unassignModel("PresetList");
        }


    }

    ksUI$1.registerModule('ks-presetmanager', PresetManager);

    class GalleryPage extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$y;
            this.delayedInit = false;
            this._isnavigable = true;
        }

        bindControls() {
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            ksUI$1.menuState.toggleMouseHover(true);
        }

        onRemovedFromDOM() {
            ksUI$1.menuState.toggleMouseHover(false);
        }

    }
    engine.on("MenuStateInit", () => {
        ksUI$1.registerModule('ks-page-gallery', GalleryPage);
    });

    var template$u = "<div class=\"component-body\">\r\n    <div id=\"background\"></div>\r\n\r\n    <div id=\"acelogo\"></div>\r\n    <div id=\"panelTrack\">\r\n        <div class=\"name\" data-bind-value=\"{{LoadingPage.track_item.name}}.toUpperCase()\">Brands Hatch</div>\r\n        <div class=\"layout\"><span data-l10n-id=\"labelLayout\"></span>: <span data-bind-value=\"{{LoadingPage.track_item.layout}}\">GP</span></div>\r\n    </div>\r\n\r\n    <div id=\"panelMain\">\r\n        <div id=\"modelName\">\r\n            <ks-btnpanel class=\"brand\" data-bind-ksmessage=\"{{CurrentCar.model.manufacturer}}\">\r\n            </ks-btnpanel>\r\n            <div class=\"name\" data-bind-value=\"{{CurrentCar.model.display_name}}\"></div>\r\n        </div>\r\n\r\n        <div id=\"panelSession\">\r\n            <div class=\"gamemodeType\" data-bind-l10n-id=\"{{LoadingPage.type}}\"></div>\r\n            <div class=\"details\">\r\n                <div class=\"item\">\r\n                    <div class=\"label\" data-l10n-id=\"labelTimeOfDay\"></div>\r\n                    <div class=\"value\" data-bind-value=\"ksUI.getTimeOfDayFromSession({{LoadingPage}})\">00:00</div>\r\n                </div>\r\n                <div class=\"item\">\r\n                    <div class=\"label\" data-l10n-id=\"panelWeatherSettings\"></div>\r\n                    <div class=\"value\" data-bind-l10n-id=\"{{LoadingPage}}.weather_type\"></div>\r\n                </div>\r\n                <div class=\"item\">\r\n                    <div class=\"label\" data-l10n-id=\"labelDuration\"></div>\r\n                    <div class=\"value\" data-bind-value=\"ksUI.getDurationFromSession({{LoadingPage}})\">8 mins</div>\r\n                </div>\r\n                <div class=\"item singleplayer\" data-bind-if=\"{{LoadingPage.players}} > 0\">\r\n                    <div class=\"label\" data-l10n-id=\"lblOpponentsUpper\"></div>\r\n                    <div class=\"value\" data-bind-value=\"{{LoadingPage.players}}\">10</div>\r\n                </div>\r\n                <div class=\"item singleplayer\" data-bind-if=\"{{LoadingPage.players}} > 0\">\r\n                    <div class=\"label\" data-l10n-id=\"lblOpponentSkill\"></div>\r\n                    <div class=\"value\" data-bind-value=\"[{{LoadingPage}}.min_strength,{{LoadingPage}}.max_strength].join('-') + ' %'\">90%</div>\r\n                </div>\r\n                <div class=\"item singleplayer\" data-bind-if=\"{{LoadingPage.players}} > 0\">\r\n                    <div class=\"label\" data-l10n-id=\"lblOpponentBehaviour\"></div>\r\n                    <div class=\"value\" data-bind-l10n-id=\"['lblBehaviour',{{LoadingPage}}.aggressivness].join('')\">90%</div>\r\n                </div>\r\n\r\n            </div>\r\n        </div>\r\n\r\n        <div id=\"panelTips\">\r\n            <span class=\"label\" data-l10n-id=\"lblTipsUpper\">TIPS</span><span class=\"value\"></span>\r\n        </div>\r\n\r\n    </div>\r\n\r\n</div>";

    class LoadingSummary extends KsHTMLElement {

        Client;

        /** @type {HTMLDivElement} */
        panelTips;

        constructor() {
            super();
            this.template = template$u;
            this.delayedInit = true;
        }

        onRemovedFromDOM() {
            document.body.classList.remove("loading-summary");
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("panelTips");

            this.Client = new MessageHandler("SeasonInfo");

            

            VEHICLES.getCurrent();

            
            if (["Multiplayer", "Session", "SpecialEvent"].indexOf(this.dataset.destination) > -1) {
                console.log("LoadingPage requesting SessionInfo");
                waitForFrames(() => {
                    this.Client.request("SessionInfo", { version: 0 }, (data) => {
                        
                        localStorage.setItem("CurrentGameEvent", JSON.stringify(data));
                        this.assignModel(data, "LoadingPage");

                        this.dataset.track = [data.track_item.name.trim().replace("-", "_"), data.track_item.layout.trim()].join("-").replaceAll(" ", "_").toLowerCase();

                        q("#background", this).style.backgroundImage = `url(/images/tracks/${this.dataset.track}.texture)`;
                        const tip_id = "tip_" + data.season_name.toLowerCase().replace(" ", "_");

                        const tip = engine.translate(tip_id);

                        if (tip != tip_id) {
                            q(".value", this.panelTips).innerHTML = tip;
                        }
                    });
                }, 1);



                // setInterval(() => {

                //     this.Client.request("SessionInfo", { version: 0 }, (data) => {
                //         this.assignModel(data, "LoadingPage", true);
                //         console.trace(data.mode);
                //     });
                // }, 1000);

            }


            waitForFrames(() => {
                this.classList.add("loaded");
            }, 1);

            document.body.classList.add("loading-summary");
        }

    }
    ksUI$1.registerModule('ks-loadingsummary', LoadingSummary);

    var template$t = "<div class=\"component-body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" goto=\"menu.html\" path=\"main/main\" class=\"back focusable\">\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnAssists\" class=\"focusable\" goto=\"singleplayer.html\" path=\"singleplayer/assists\">\r\n                <div slot=\"name\" data-l10n-id=\"panelAssists\">Assists</div>\r\n            </ks-btnbasic>\r\n\r\n        </div>\r\n    </component-slot>\r\n\r\n    <div class=\"submode main\">\r\n\r\n        <ks-pageheader class=\"full\">\r\n            <div slot=\"label\">\r\n                <div data-l10n-id=\"headerDrivingAcademy\">Driving Academy</div>\r\n                <div>/</div>\r\n                <div data-l10n-id=\"lblDrivingLicensesLower\">Licenses</div>\r\n            </div>\r\n        </ks-pageheader>\r\n\r\n\r\n        <ks-playerprogress></ks-playerprogress>\r\n\r\n        <div class=\"submode-body\">\r\n            <div id=\"panelDescription\" class=\"is-flex-column justify-content-center\">\r\n                <div class=\"title\" data-l10n-id=\"lblDrivingLicenseCategories\"></div>\r\n                <div class=\"subtitle\" data-l10n-id=\"textDrivingAcademyDescription\"></div>\r\n            </div>\r\n\r\n            <div id=\"panelMenu\" class=\"menu is-flex-row\">\r\n                <div class=\"controltip\">\r\n                </div>\r\n                <ks-btnbasic data-tooltip=\"tooltipLICENSE_SPORTSCAR\" class=\"focusable owned\" toggle-group=\"licenses\" data-mode=\"LICENSE_SPORTSCAR\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"UILicenseType_SportsCar\">\r\n                        \r\n                </div></ks-btnbasic>\r\n                <ks-btnbasic data-tooltip=\"tooltipLICENSE_SUPERCAR\" class=\"focusable\" toggle-group=\"licenses\" data-mode=\"LICENSE_SUPERCAR\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"UILicenseType_SuperCar\">\r\n                        \r\n                </div></ks-btnbasic>\r\n                <ks-btnbasic data-tooltip=\"tooltipLICENSE_HYPERCAR\" class=\"focusable\" toggle-group=\"licenses\" data-mode=\"LICENSE_HYPERCAR\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"UILicenseType_HyperCar\">\r\n                        \r\n                </div></ks-btnbasic>\r\n                <ks-btnbasic data-tooltip=\"tooltipLICENSE_RACING_1\" class=\"focusable\" toggle-group=\"licenses\" data-mode=\"LICENSE_RACING_1\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"UILicenseType_Racing_1\">\r\n                        \r\n                </div></ks-btnbasic>\r\n                <ks-btnbasic data-tooltip=\"tooltipLICENSE_RACING_2\" class=\"focusable\" toggle-group=\"licenses\" data-mode=\"LICENSE_RACING_2\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"UILicenseType_Racing_2\">\r\n                        \r\n                </div></ks-btnbasic>\r\n                <ks-btnbasic data-tooltip=\"tooltipLICENSE_RACING_3\" class=\"focusable\" toggle-group=\"licenses\" data-mode=\"LICENSE_RACING_3\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"UILicenseType_Racing_3\">\r\n                        \r\n                </div></ks-btnbasic>\r\n                <div class=\"controltip\">\r\n                </div>\r\n            </div>\r\n\r\n            <div id=\"panelEvents\" class=\"scrollable-vertical items\">\r\n                <div class=\"scrollable-content\">\r\n                    <ks-btnpanel driving-academy class=\"item focusable\" data-tooltip=\"tooltipPlaceholder\" data-bind-for=\"index,item:{{SpecialEvents.special_events}}\" data-bind-disablevalue=\"{{item.status}} == 'SpecialEventStatus_DISABLED'\" data-bind-class-toggle=\"compelted:{{item.status}} == 'SpecialEventStatus_DONE'\" data-bind-ksmessage=\"{{item}}\" data-bind-ksvalue=\"{{item.event_guid}}\">\r\n\r\n                        <div slot=\"title\">\r\n                            <div class=\"container\">\r\n                                <div class=\"name\" data-bind-value=\"{{item.name}}\"></div>\r\n                            </div>\r\n                            <div class=\"caption\" data-bind-l10n-id=\"'da_caption_' + {{item}}.name.toLowerCase()\">Caption</div>                            \r\n                        </div>\r\n                        <div slot=\"subtitle\">\r\n                            <div slot=\"rewards\" data-bind-if=\"{{item.my_time}} !=''\">\r\n                                <div class=\"my-stat\">\r\n                                    <div class=\"my-label\" data-l10n-id=\"labelMyTimeAcademy\">Your best result</div> \r\n                                    \r\n                                    <div class=\"results\">\r\n                                        <div class=\"my-value\" data-bind-value=\"{{item.my_time}}\"></div>\r\n                                        <div class=\"medal-container\" data-bind-if=\"{{item.my_medal}} > 0\">\r\n                                            <div class=\"goldmedal\" data-bind-if=\"{{item.my_medal}} == 1\">                                                \r\n                                            </div>\r\n                                            <div class=\"silvermedal\" data-bind-if=\"{{item.my_medal}} == 2\">                                                \r\n                                            </div>\r\n                                            <div class=\"bronzemedal\" data-bind-if=\"{{item.my_medal}} == 3\">                                           \r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </div>                                \r\n                            </div>\r\n                            <div class=\"horizontal-spacer\"></div>\r\n                            <div class=\"vehicle\" data-bind-value=\"{{item.car_model.display_name}}\"></div>                                               \r\n                            <div class=\"track\">\r\n                                <div class=\"wrap\">\r\n                                    <span class=\"name\" data-bind-value=\"{{item.track_item.name}}\"></span>\r\n                                    <span class=\"layout\" data-bind-value=\"{{item.track_item.layout}}\"></span>\r\n                                </div>\r\n                            </div>\r\n                            <div class=\"horizontal-spacer\"></div>\r\n                            <div class=\"race-conditions\">\r\n                                <div class=\"conditions\">\r\n                                    <div class=\"weather\">\r\n                                        <div class=\"label\" data-l10n-id=\"labelAcademyWeather\"></div>\r\n                                        <div class=\"value\" data-bind-value=\"APF().weather({{item.weather_preset}})\"></div>\r\n                                        <!-- <i class=\"icon\" data-bind-class=\"{{item.weather_preset}}\"></i> -->\r\n                                    </div>\r\n                                </div>                               \r\n                            </div>                            \r\n                        </div>\r\n\r\n                    </ks-btnpanel>\r\n                </div>\r\n            </div>\r\n\r\n\r\n        </div>\r\n\r\n    </div>\r\n\r\n</div>";

    var template$s = "<div class=\"component-body\">\r\n    <div class=\"svgcontainer\">\r\n        \r\n        <div class=\"label\">\r\n            <div class=\"value\">0</div>\r\n            <div class=\"suffix\">%</div>\r\n        </div>\r\n\r\n        <svg id=\"svg\" width=\"100%\" height=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.2\" baseProfile=\"tiny\" preserveAspectRatio=\"none\" viewBox=\"0 0 100 100\">\r\n\r\n            <g class=\"grid hidden\">\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M10 0 V100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M20 0 V100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M30 0 V100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M40 0 V100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M50 0 V100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M60 0 V100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M70 0 V100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M80 0 V100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M90 0 V100\"/>\r\n\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M0 10 H100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M0 20 H100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M0 30 H100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M0 40 H100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M0 50 H100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M0 60 H100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M0 70 H100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M0 80 H100\"/>\r\n                <path stroke=\"white\" stroke-width=\".2\" d=\"M0 90 H100\"/>\r\n\r\n            </g>\r\n            <g class=\"hidden\">\r\n                <circle cx=\"10\" cy=\"50\" r=\"1\"/>\r\n                <circle cx=\"50\" cy=\"50\" r=\"1\"/>\r\n                <circle cx=\"90\" cy=\"50\" r=\"1\"/>\r\n            </g>\r\n\r\n            <g class=\"thing\">\r\n                <circle class=\"background\" cx=\"50\" cy=\"50\" r=\"40\"/>\r\n                <path class=\"bar\" d=\"M 50 10 A 40 40 270 1 1 49.99 10\"/>\r\n            </g>\r\n        </svg>\r\n    </div>\r\n</div>";

    class RadialBar extends KsHTMLElement {

        currentPercent = 0;
        visiblePercent = 0;
        animationStep = 0.01;
        showvalue = true;
        valueLabel;

        constructor() {
            super();
            this.template = template$s;
        }

        draw = ((percent) => {
            const path = ksUI$1.svg.getSvgEllipseArc([
                50,
                50
            ], [
                40,
                40
            ], [
                0 / 180 * Math.PI,
                percent * (percent > 0.98 && percent < 1 ? 350.999 : 359.999) / 180 * Math.PI
            ], parseFloat(270) / 180 * Math.PI).join(" ");

            var newpath = q(".bar", this);
            newpath.setAttribute("d", path);
            newpath.setAttribute("fill", "none");

            newpath.classList.toggle("full", percent === 1);

            if (this.visiblePercent != this.currentPercent) {
                waitForFrames(() => {

                    if (this.goingUp()) {
                        this.visiblePercent = Math.min(this.visiblePercent += this.animationStep, this.currentPercent);
                    } else {
                        this.visiblePercent = Math.max(this.visiblePercent -= this.animationStep, this.currentPercent);
                    }

                    this.draw(this.visiblePercent);
                    if (this.showvalue) {
                        this.valueLabel.textContent = Math.round(this.visiblePercent * 100);
                    }
                }, 1);
            }


        });

        goingUp = () => {
            return this.visiblePercent < this.currentPercent;
        }

        update = ((percent) => {
            console.log("setting value to", percent);
            this.currentPercent = percent;

            if (this.visiblePercent != this.currentPercent) {
                console.log("from", this.visiblePercent, "to", percent);
                this.draw(this.visiblePercent += this.goingUp() ? 0.05 : -0.05);
            } else if (percent == 0) {
                this.draw(0);
            }

        });

        bindControls() {
            let value = this.getAttribute("value");

            if (value == "random")
                value = Math.random();

            this.update(Number(value));
        }

        onTemplateLoaded() {
            this.showvalue = this.classList.contains("showvalue");
            this.valueLabel = q(".value", this);
            this.templateLoaded = true;
        }
    }


    ksUI$1.registerModule('ks-radialbar', RadialBar);

    var template$r = "<div class=\"component-body\">\r\n    <div class=\"svgcontainer\">\r\n        <component-slot data-name=\"svg-contents\">\r\n            <svg width=\"100%\" height=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" version=\"1.2\" baseProfile=\"tiny\" preserveAspectRatio=\"none\" viewBox=\"0 0 100 100\">\r\n            </svg>\r\n        </component-slot>\r\n    </div>\r\n</div>";

    class RadialChart extends KsHTMLElement {

        currentPercent = 0;
        visiblePercent = 0;
        animationStep = 0.01;


        constructor() {
            super();
            this.template = template$r;
        }

        update(target, values, offset = 0) {
            let chart = ksUI$1.svg.Donut(50, 50, 40, values, offset);
            var paths = qAll("path", target);
            for (var i = 0; i < paths.length; i++) {
                var path = paths[i];
                var item = chart[i];
                path.setAttribute("d", item.d);
                path.setAttribute("fill", "none");
            }
        }

        draw(values) {

            let random = [
                { value: Math.random() * 100 },
                { value: Math.random() * 100 },
                { value: Math.random() * 100 }
            ];

            if (values == "random") {
                values = random;
            }

            let svg = q("svg .stats-donut", this);
            this.update(svg, values, 45);

            svg = q("svg .background", this);
            this.update(svg, values, 46);

        }

        bindControls() {
            let val = this.getAttribute("values");
            let values = "random";

            if (val && val != values) {
                values = [];
                val.split(",").forEach((element, index) => {
                    values.push({ value: Number(element) * 100 });
                });
                
            }
            
            this.draw(values);
            
        }
    }


    ksUI$1.registerModule('ks-radialchart', RadialChart);

    class DrivingAcademyPage extends KsHTMLElement {

        /** @type {Btnbasic} */
        btnBack;
        /** @type {Btnbasic} */
        btnAssists;

        /** @type {HTMLDivElement} */
        panelMenu;

        /** @type {HTMLDivElement} */
        panelEvents;

        activeCategory = eLicenseType.SportsCar;

        allEvents = {};

        licenseHierarchy = [
            "UILicenseType_Entry",
            "UILicenseType_SportsCar",
            "UILicenseType_SuperCar",
            "UILicenseType_HyperCar",
            "UILicenseType_Racing_1",
            "UILicenseType_Racing_2",
            "UILicenseType_Racing_3"
        ];
        dataModes = [
            "LICENSE_SPORTSCAR",
            "LICENSE_SUPERCAR",
            "LICENSE_HYPERCAR",
            "LICENSE_RACING_1",
            "LICENSE_RACING_2",
            "LICENSE_RACING_3"
        ];

        constructor() {
            super();
            this._exposeAsActivePage = true;
            this.template = template$t;
            this._isnavigable = true;
            this.disableCameraControl = true;
        }

        filters = {

            translate: (string) => {
                return engine.translate(string);
            },

            duration: (duration, duration_type) => {
                return duration_type == eGameModeSelection.RaceType.Laps ? duration : ksUI$1.formatTimeLong(duration * 1000);
            },

            duration_type: (duration_type) => {
                if (duration_type == eGameModeSelection.RaceType.Laps) {
                    return engine.translate("labelLaps")
                }
                return "";
            },

            time: (time_of_day) => {
                return [time_of_day.hour, ksUI$1.pad(time_of_day.minute, 2)].join(":");
            },

            credits: (credits) => {
                return credits + " v$";
            },

            xp: (xp) => {
                return xp + " XP";
            },

            weather: (weather) => {               
                return engine.translate(weather);
            }
        }

        getSpecialEvents(license) {
            const events = this.allEvents.categories.find(category => category.license_type == license);

            if (events) {
                waitForFrames(() => {
                    this.assignModel(events, "SpecialEvents");
                    ksUI$1.groupTrace("SpecialEvents", events);
                    waitForFrames(() => this.bindEvents(), 1);
                    
                }, 1);
            } else {
                console.error("No events for", license);
            }

        }
        

        bindEvent(ev) {

            const event_id = ev.currentTarget.dataset.value;
                   

            GAMEMODESELECTION.Client.request("JoinDrivingAcademy", {
                event_guid: event_id
            }
                , (data) => {
                    ({
                        [eClientCommands.Response.OK]: () => {
                            ksUI$1.setCurrentAsReturnPage();
                            console.log("Selecting event", event_id);
                        },
                        [eClientCommands.Response.CriticalError]: () => {
                            this.errorModal("lblError", "msgCouldNotLoadEvent", false, null, true);
                            console.error("Could not load event", event_id);
                        }
                    }[data.response])();

                });
        }

        bindEvents() {

            if (!this.firstload) {
                //Scrollbar.updateAllComponents();
                SpatialNavigation.clear();
                this.setupNavigation();
            }
            this.firstload = false;

            qevAll("ks-btnpanel", "click sn:enter-down", this.bindEvent, this.listEvents);
        }

        load() {
            this.classList.add("loading");
            this.allEvents = {};

            return new Promise((resolve, reject) => {
                GAMEMODESELECTION.loadAcademy().then((data) => {
                    
                    Object.assign(this.allEvents, data);
                   
        
                    resolve(data);
                }).catch((data) => {
                    console.error("Could not retrieve Driver Academy data");
                    reject(data);
                }).finally(() => {
                    this.classList.remove("loading");
                });
            });
        }

       

        bindControls() {
            qAll("ks-btnbasic", this.panelMenu).forEach(
                /** @param {Btnbasic} btn */
                btn => {
                    btn.onToggled = (sender, e, state) => {
                        if (state) {
                            this.activeCategory = btn.dataset.mode;
                            this.getSpecialEvents(this.activeCategory);
                            localStorage.setItem("section_to_display", this.activeCategory);
                        }
                    };
                });
        }

        onAfterRenderControlHints(controlhints) {
            this.mapElementById("btnBack", controlhints);
            this.mapElementById("btnAssists", controlhints);

            this.btnBack.onBeforeRedirect = () => {
                ksUI$1.requestGoBack(eGameModeSelection.BackFrom.DrivingAcademy);
                if(localStorage.getItem("section_to_display")) {
                    localStorage.removeItem("section_to_display");
                }
            };       
        }

        updateEnabledButtons(current_license) {
            const current_index = this.licenseHierarchy.indexOf(current_license);        
            this.dataModes.forEach((mode, index) => {
                const btn = q(`[data-mode="${mode}"]`);
                if (btn) {
                    if (index < current_index) {                    
                        btn.classList.add("focusable", "owned"); 
                    } else {                    
                        btn.classList.remove("owned");
                    }
                }
            });
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("panelMenu");
            this.mapElementById("panelEvents");       
            this.updateEnabledButtons(ModelUIDriverState.license_type); 
            this.load().then((data) => {
                
                if (localStorage.getItem("section_to_display")) {
                    const section = localStorage.getItem("section_to_display");
                    this.activeCategory = section;
                    localStorage.removeItem("section_to_display");
                }
                          
                q(`ks-btnbasic[data-mode=${this.activeCategory}]`, this).toggle(true, true);
            });

        }


        onRemovedFromDOM() {
            super.onRemovedFromDOM();
        }


    }

    engine.on("MenuStateInit", () => {
        ksUI$1.registerModule('ks-page-academy', DrivingAcademyPage);
    });

    var template$q = "<div class=\"body\">\r\n\r\n    <div class=\"ingame-permanent\" data-bind-class-toggle=\"disconnected:{{ModelUIState}}.online_status=='UIOnlineDisconnected'\">\r\n\r\n        <div id=\"labelDisconnected\" data-bind-if=\"{{ModelUIState}}.online_status=='UIOnlineDisconnected'\" data-l10n-id=\"lblServerDisconnected\"></div>\r\n\r\n        <ks-serverinfo id=\"serverinfo\"></ks-serverinfo>\r\n\r\n        <ks-timeofdayinfo id=\"timeofdayinfo\"></ks-timeofdayinfo>\r\n        <ks-weatherinfo id=\"weatherinfo\"></ks-weatherinfo>\r\n        <ks-trackstatusinfo id=\"trackstatusinfo\"></ks-trackstatusinfo>\r\n        <ks-sessioninfo id=\"sessioninfo\"></ks-sessioninfo>\r\n\r\n\r\n        <ks-timer id=\"nextsession\" data-mode=\"nextsession\" data-bind-if=\"{{ModelUISessionState}}.time_to_next_session != ''\">\r\n        </ks-timer>\r\n\r\n        <ks-timer id=\"waittime\" data-mode=\"waittimer\" data-bind-if=\"{{ModelUISessionState}}.wait_time != '' && {{ModelUISessionState}}.time_to_next_session == ''\">\r\n        </ks-timer>\r\n    </div>\r\n\r\n    <div class=\"wrapper\">\r\n\r\n        <ks-page-pitlane class=\"delayedInit\" data-mode=\"main\" data-bind-if=\"{{ModelMenuState.path}} === 'pitlane/main'\" rootpage>\r\n        </ks-page-pitlane>\r\n\r\n        <ks-page-timetable class=\"delayedInit\" data-mode=\"main\" data-bind-if=\"{{ModelMenuState.path}} === 'pitlane/timetable'\" rootpage>\r\n        </ks-page-timetable>\r\n\r\n        <ks-page-trackmap class=\"delayedInit\" data-mode=\"main\" data-bind-if=\"{{ModelMenuState.path}} === 'pitlane/trackmap'\" rootpage>\r\n        </ks-page-trackmap>\r\n\r\n        <ks-page-vehiclesetup class=\"delayedInit\" data-mode=\"tyres\" data-bind-if=\"{{ModelMenuState.activeMenu}} === 'vehiclesetup'\" mode-transition rootpage>\r\n        </ks-page-vehiclesetup>\r\n\r\n        <ks-viewsettings data-bind-if=\"{{ModelMenuState.path}} == 'viewsettings/main'\"></ks-viewsettings>\r\n\r\n        <ks-presetmanager preset-type=\"CarSetup\" class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeMenu}} === 'presets'\">\r\n            <div slot=\"controls\">\r\n                <div class=\"group start\">\r\n                    <ks-btnbasic id=\"btnBack\" class=\"back focusable\" path=\"vehiclesetup/{activeSubMenu}\"></ks-btnbasic>\r\n                </div>\r\n            </div>\r\n            <div slot=\"header\">\r\n                <ks-pageheader class=\"minimal\">\r\n                    <div slot=\"label\" data-l10n-id=\"headerSetupPresets\">Setup Presets</div>\r\n                </ks-pageheader>\r\n            </div>\r\n        </ks-presetmanager>\r\n\r\n        <ks-page-sessioneconomy data-bind-if=\"{{ModelMenuState.path}} == 'sessionend/economy'\" rootpage opaque></ks-page-sessioneconomy>\r\n\r\n    </div>\r\n</div>";

    var template$p = "<div class=\"component-body verticalwipe\">\r\n\r\n    <div class=\"ingame-permanent\" data-bind-class-toggle=\"disconnected:{{ModelUIState}}.online_status=='UIOnlineDisconnected'\">\r\n\r\n        <div id=\"labelDisconnected\" data-bind-if=\"{{ModelUIState}}.online_status=='UIOnlineDisconnected'\" data-l10n-id=\"lblServerDisconnected\"></div>\r\n\r\n        <ks-serverinfo id=\"serverinfo\"></ks-serverinfo>\r\n\r\n        <ks-timeofdayinfo id=\"timeofdayinfo\"></ks-timeofdayinfo>\r\n        <ks-weatherinfo id=\"weatherinfo\"></ks-weatherinfo>\r\n        <ks-trackstatusinfo id=\"trackstatusinfo\"></ks-trackstatusinfo>\r\n        <ks-sessioninfo id=\"sessioninfo\"></ks-sessioninfo>\r\n\r\n\r\n        <ks-timer id=\"nextsession\" data-mode=\"nextsession\" data-bind-if=\"{{ModelUISessionState}}.time_to_next_session != ''\">\r\n        </ks-timer>\r\n\r\n        <ks-timer id=\"waittime\" data-mode=\"waittimer\" data-bind-if=\"{{ModelUISessionState}}.wait_time != '' && {{ModelUISessionState}}.time_to_next_session == ''\">\r\n        </ks-timer>\r\n    </div>\r\n\r\n    <div class=\"menu\">\r\n\r\n        <div id=\"acelogo\"></div>\r\n        <ks-btnbasic id=\"btnResume\" data-sn-up=\"#btnExit\" class=\"focusable rounded-half\">\r\n            <div slot=\"name\" data-l10n-id=\"btnResume\">Resume\r\n        </div></ks-btnbasic>\r\n        <ks-btnbasic id=\"btnReplay\" class=\"focusable rounded-half\" ndata-bind-disablevalue=\"{{ModelUISessionState}}.phase_name == 'Waiting_For_Start' || ({{ModelUISessionState}}.phase_name == 'Waiting_For_Players' && !IsFlagSet(InSessionFlags.Multiplayer, {{ModelUISessionState}}))\">\r\n            <div slot=\"name\" data-l10n-id=\"lblReplayUpper\">Replay\r\n        </div></ks-btnbasic>\r\n        <ks-btnbasic id=\"btnOptions\" class=\"focusable rounded-half\">\r\n            <div slot=\"name\" data-l10n-id=\"mainMenuSettings\">Settings\r\n        </div></ks-btnbasic>\r\n        <ks-btnbasic id=\"btnViewSettings\" class=\"focusable rounded-half\">\r\n            <div slot=\"name\" data-l10n-id=\"mainMenuViewSettings\">View Settings\r\n        </div></ks-btnbasic>\r\n        <ks-btnbasic id=\"btnPitlane\" data-bind-if=\"{{ModelUISessionState.session_name}} != '' &&\r\n    {{ModelCurrentCar.pit_info.time_in_pits}} <= 0\" class=\"focusable rounded-half\">\r\n            <div slot=\"name\" data-l10n-id=\"btnReturnPitlane\">Go to Pitlane\r\n        </div></ks-btnbasic>\r\n        <ks-btnbasic id=\"btnRestart\" data-bind-if=\"{{ModelUISessionState.session_name}} != ''\" class=\"focusable rounded-half\">\r\n            <div slot=\"name\" data-l10n-id=\"mainMenuRestartSession\">Restart\r\n        </div></ks-btnbasic>\r\n        <ks-btnbasic id=\"btnExit\" data-sn-down=\"#btnResume\" class=\"focusable rounded-half\">\r\n            <div slot=\"name\" data-l10n-id=\"btnReturnToMainMenu\">Exit to Main Menu\r\n        </div></ks-btnbasic>\r\n        <div id=\"currentServerPing\">\r\n            <div class=\"label connected\" data-l10n-id=\"lblServerPing\"></div>\r\n            <div class=\"value connected\" data-bind-value=\"{{ModelUISessionState}}.player_ping\">--</div>\r\n            <div class=\"suffix connected\">ms</div>\r\n            <div class=\"disconnected\" data-l10n-id=\"lblServerDisconnected\"></div>\r\n        </div>\r\n\r\n    </div>\r\n</div>";

    class PauseMenu extends KsHTMLElement {

        btnResume;
        btnPitlane;
        btnOptions;
        btnRestart;
        btnReplay;
        btnViewSettings;

        btnExit;

        /** @type {{MessageHandler}} */
        MPClient;




        constructor() {
            super();
            this.template = template$p;
            this.delayedInit = true;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            ksUI$1.menuState.toggleMouseHover(true);

            this.mapElementById("btnResume");
            this.mapElementById("btnOptions");
            this.mapElementById("btnPitlane");
            this.mapElementById("btnExit");
            this.mapElementById("btnRestart");
            this.mapElementById("btnReplay");
            this.mapElementById("btnViewSettings");

            if (this.documentBody.classList.contains("multiplayer")) {
                this.MPClient = new MessageHandler("MultiplayerServerList");
            }

            this.btnResume.focus();
        }

        onRemovedFromDOM() {

        }

        bindControls() {
            super.bindControls();

            window.addEventListener("ui.action", (evt) => {

                if (evt.detail == "cancel" && this.classList.contains("visible") && !this.documentBody.classList.contains("ks-modaldialog-active")) {
                    this.onResume();
                }
            });

            this.btnResume.onPressed = (sender, e) => this.onResume(sender, e);

            if (this.btnPitlane)
                this.btnPitlane.onPressed = (sender, e) => this.onPitlane(sender, e);

            this.btnOptions.onPressed = this.onOptions.bind(this);
            this.btnViewSettings.onPressed = (sender, e) => this.onViewSettings(sender, e);
            this.btnExit.onPressed = (sender, e) => this.onExit(sender, e);


            if (this.btnRestart)
                this.btnRestart.onPressed = (sender, e) => this.onRestart(sender, e);

            this.btnReplay.onPressed = (sender, e) => this.onReplay(sender, e);
        }

        onResume(sender, e) {
            console.log("HudPauseMenu: Resume");
            ksUI$1.request("GameMode", "Resume");
        }

        onReplay(sender, e) {
            ksUI$1.requestNoResponse("Replay", "TogglePlay");
            ksUI$1.goTo("replay.html", "main/main");
        }

        onRestart(sender, e) {
            ksUI$1.requestNoResponse("GameMode", "RestartSession");
        }

        onPitlane(sender, e) {
            ksUI$1.requestNoResponse("GameMode", "BackToPit");
            this.Hide();
        }

        onOptions(sender, e) {
            console.log("HudPauseMenu: Options");
            ksUI$1.goTo("settings.html");
            this.Hide();
            this.btnOptions.onPressed = () => {
                console.warn("Duplicate input triggered");
            };
        }

        onViewSettings(sender, e) {
            console.log("HudPauseMenu: ViewSettings");
            ksUI$1.goTo("ingame.html", "viewsettings/main");
            this.Hide();
            // this.btnViewSettings.onPressed =  () => {
            //     console.warn("Duplicate input triggered");
            // };
        }

        onExit(sender, e) {
            console.log("HudPauseMenu: Exit");


            this.pageModal.Show({
                title: "lblQuitSession",
                message: "msgQuitSession",
                buttons: 0x101
            });

            this.pageModal.onConfirm = () => {
                ksUI$1.requestNoResponse("GameMode", "Exit");
            };
        }



        Show() {
            console.log("PauseMenu Show");
            this.classList.add("visible");
            waitForFrames(() => q("body").classList.add("pausemenu"), 2);


            SpatialNavigation.clear();

            SpatialNavigation.add("ks-pausemenu", {
                selector: '.focusable'
            });

            SpatialNavigation.makeFocusable();
            components$1.waitForFrames(() => {
                SpatialNavigation.focus();
            }, 3);

            ksUI$1.menuState.ignoreInputActions(true);


        }

        Hide() {
            if (this.classList.contains("visible")) {
                console.log("PauseMenu Hide");
                this.classList.remove("visible");
                waitForFrames(() => q("body").classList.remove("pausemenu"), 2);

                SpatialNavigation.remove("ks-pausemenu");
                ksUI$1.menuState.ignoreInputActions(false);
            }
            clearInterval(this.pingIntervalTimer);
        }

    }
    ksUI$1.registerModule('ks-pausemenu', PauseMenu);

    var template$o = "<div class=\"component-body\">\r\n\r\n\r\n    <div id=\"acelogo\"></div>\r\n\r\n    <div class=\"submode main\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'main'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'main' \">\r\n        <ks-page-settings-hub class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'main' \"></ks-page-settings-hub>\r\n\r\n    </div>\r\n\r\n    <div class=\"submode audio\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'audio'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'audio'\">\r\n        <ks-page-settings-audio class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'audio'\"></ks-page-settings-audio>\r\n    </div>\r\n\r\n    <div class=\"submode audiopresets\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'audiopresets'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'audiopresets'\">\r\n        <ks-presetmanager preset-type=\"Audio\" class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'audiopresets'\">\r\n            <div slot=\"controls\">\r\n                <div class=\"group start\">\r\n                    <ks-btnbasic id=\"btnBack\" class=\"back focusable\" path=\"settings/audio\"></ks-btnbasic>\r\n                </div>\r\n            </div>\r\n            <div slot=\"header\">\r\n                <ks-pageheader class=\"minimal\">\r\n                    <div slot=\"label\" data-l10n-id=\"headerAudioPresets\">Audio Presets</div>\r\n                </ks-pageheader>\r\n            </div>\r\n        </ks-presetmanager>\r\n    </div>\r\n\r\n    <div class=\"submode video\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'video'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'video'\">\r\n        <ks-page-settings-video class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'video'\">\r\n            \r\n    </ks-page-settings-video></div>\r\n\r\n    <div class=\"submode videopresets\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'videopresets'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'videopresets'\">\r\n        <ks-presetmanager preset-type=\"Video\" class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'videopresets'\">\r\n            <div slot=\"controls\">\r\n                <div class=\"group start\">\r\n                    <ks-btnbasic class=\"back focusable\" id=\"btnBack\" path=\"settings/video\"></ks-btnbasic>\r\n                </div>\r\n            </div>\r\n            <div slot=\"header\">\r\n                <ks-pageheader class=\"minimal\">\r\n                    <div slot=\"label\" data-l10n-id=\"headerVideoPresets\">Video Presets</div>\r\n                </ks-pageheader>\r\n            </div>\r\n        </ks-presetmanager>\r\n    </div>\r\n\r\n    <!--\r\n    <div class=\"submode assists\"\r\n        data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'assists'\"\r\n        data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'assists'\">\r\n        <ks-page-assists class=\"delayedInit renderControlHints\"\r\n            data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'assists'\">\r\n        </ks-page-assists>\r\n    </div>\r\n    -->\r\n\r\n\r\n    <div class=\"submode gameplay\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'gameplay-hud'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'gameplay-hud'\">\r\n        <ks-page-settings-gameplay-hud class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'gameplay-hud'\">\r\n        </ks-page-settings-gameplay-hud>\r\n    </div>\r\n\r\n    <div class=\"submode credits\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'credits'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'credits'\">\r\n        <ks-page-credits class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'credits'\">\r\n        </ks-page-credits>\r\n    </div>\r\n\r\n    <div class=\"submode gameplaypresets\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'gameplaypresets'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'gameplaypresets'\">\r\n        <ks-presetmanager preset-type=\"Gameplay\" class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'gameplaypresets'\">\r\n            <div slot=\"controls\">\r\n                <div class=\"group start\">\r\n                    <ks-btnbasic class=\"back focusable\" id=\"btnBack\" path=\"settings/gameplay-hud\"></ks-btnbasic>\r\n                </div>\r\n            </div>\r\n            <div slot=\"header\">\r\n                <ks-pageheader class=\"minimal\">\r\n                    <div slot=\"label\" data-l10n-id=\"headerGameplayPresets\">Gameplay Presets</div>\r\n                </ks-pageheader>\r\n            </div>\r\n        </ks-presetmanager>\r\n    </div>\r\n\r\n    <div class=\"submode controls\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'controls'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'controls'\">\r\n        <ks-page-settings-controls class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'controls' \"></ks-page-settings-controls>\r\n    </div>\r\n\r\n    <div class=\"submode controlpresets\" data-bind-class-toggle=\"connected:{{ModelMenuState.activeSubMenu}} === 'controlpresets'\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'controlpresets'\">\r\n        <ks-presetmanager preset-type=\"InputConfiguration\" class=\"delayedInit renderControlHints\" data-bind-if=\"{{ModelMenuState.activeSubMenu}} === 'controlpresets'\">\r\n            <div slot=\"controls\">\r\n                <div class=\"group start\">\r\n                    <ks-btnbasic class=\"back focusable\" id=\"btnBack\" path=\"settings/controls\"></ks-btnbasic>\r\n                </div>\r\n            </div>\r\n            <div slot=\"header\">\r\n                <ks-pageheader class=\"minimal\">\r\n                    <div slot=\"label\" data-l10n-id=\"headerControlPresets\">Control Presets</div>\r\n                </ks-pageheader>\r\n            </div>\r\n        </ks-presetmanager>\r\n    </div>\r\n\r\n</div>";

    var template$n = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back focusable delayedInit\"></ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\" data-l10n-id=\"headerSettings\">Settings</div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body\">\r\n        <div class=\"tiles\">\r\n            <div id=\"btnControls\" class=\"btn controls focusable\" data-submode=\"controls\" data-l10n-id=\"settingsControls\" data-tooltip=\"tooltipSettingsControls\">CONTROLS</div>\r\n            <div id=\"btnGeneral\" class=\"btn general focusable\" data-submode=\"gameplay-hud\" data-l10n-id=\"settingsGameplay\">GENERAL</div>\r\n            <div id=\"btnVideo\" class=\"btn video focusable\" data-submode=\"video\" data-l10n-id=\"settingsVideo\" data-tooltip=\"tooltipSettingsVideo\">VIDEO</div>\r\n            <div id=\"btnAudio\" class=\"btn audio focusable\" data-submode=\"audio\" data-l10n-id=\"settingsAudio\" data-tooltip=\"tooltipSettingsAudio\">AUDIO</div>\r\n            <!-- <div id=\"btnAssists\" class=\"btn assists focusable\" data-submode=\"assists\" data-l10n-id=\"panelAssists\">AUDIO</div> -->\r\n            <!--<div id=\"btnHud\" class=\"btn hud disabled focusable\" data-submode=\"hud\" data-l10n-id=\"settingsHud\">HUD</div>\r\n            <div id=\"btnCredits\" class=\"btn credits disabled focusable\" data-submode=\"credits\" data-l10n-id=\"settingsCredits\">CREDITS & EULA</div> -->\r\n        </div>\r\n    </div>\r\n\r\n</div>";

    class SettingsHub extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$n;
            this._isnavigable = true;
        }

        onAfterRenderControlHints(controlhints) {
            this.btnBack = q(".back", controlhints);

            this.btnBack.onPressed = () => {
                this.btnBack.onPressed =  () => {
                    console.warn("Duplicate input triggered");
                };
                console.log("Returning to origin");
                ksUI$1.returnToOrigin();
                
            };
        }

        bindControls() {
            qevAll(".main .btn", "click sn:enter-down",
                (e) => {
                    ksUI$1.changePage("settings/" + e.target.dataset.submode, false, false);
                }, this);
        }


    }

    ksUI$1.registerModule('ks-page-settings-hub', SettingsHub);

    var template$m = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back focusable\"></ks-btnbasic>\r\n            <ks-btnbasic class=\"apply focusable\" id=\"apply\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnApply\">Apply</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"cancel focusable\" id=\"cancel\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCancel\">Cancel</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n\r\n        <div class=\"group center\"></div>\r\n\r\n        <div class=\"group end\">\r\n            <ks-btnbasic class=\"presets focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"btnManagePresets\">Manage Presets</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\">\r\n            <div data-l10n-id=\"headerSettings\">Settings</div>\r\n            <div>/</div>\r\n            <div data-l10n-id=\"headerAudio\">Audio</div>\r\n        </div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body is-flex-column\">\r\n        <div class=\"panel\">\r\n            <div class=\"group\">\r\n                <div class=\"header\" data-l10n-id=\"lblAudioSettingsAudioSource\">AUDIO SOURCE</div>\r\n                <ks-modalselect class=\"devices focusable\" extracssclass=\"limitheight\">\r\n\r\n                    <div slot=\"current\" data-bind-ksvalue=\"{{SettingsAudio.device.DeviceId}}\" data-bind-value=\"{{SettingsAudio.device.DeviceName}}\">Test</div>\r\n\r\n                    <div slot=\"options\">\r\n                        <div class=\"title\" data-l10n-id=\"labelAudioDevices\">Audio Devices</div>\r\n                        <div class=\"list scrollable-vertical\">\r\n                            <div class=\"scrollable-content per-item-scroll\">\r\n                                <div class=\"option focusable\" data-bind-class-toggle=\"selected:{{SettingsAudio.device.DeviceId}} == {{index}}\" data-bind-for=\"index, iter: {{SettingsAudioDevices.devices}}\" data-bind-ksvalue=\"{{index}}\" data-bind-value=\"{{iter}}\"></div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </ks-modalselect>\r\n\r\n                <ks-slider class=\"focusable master\" data-volumetype=\"MainVolume\" data-bind-ksvalue=\"{{SettingsAudio.volumes.main}} * 100\">\r\n                    <div slot=\"name\" data-l10n-id=\"volumeMaster\">Master</div>\r\n                    <div slot=\"unit\">%</div>\r\n                </ks-slider>\r\n            </div>\r\n\r\n            <div class=\"audio scrollable-vertical is-flex-column\">\r\n                <div class=\"scrollable-content\">\r\n                    <div class=\"header-label\" data-l10n-id=\"lblAudioSettingsGeneral\">GENERAL</div>\r\n                    <hr>\r\n                    <ks-slider class=\"oneline focusable\" data-volumetype=\"MusicVolume\" data-bind-ksvalue=\"{{SettingsAudio.volumes.music}} * 100\">\r\n                        <div slot=\"name\" data-l10n-id=\"volumeMusic\">Music</div>\r\n                        <div slot=\"unit\" data-bind-value=\"\">%</div>\r\n                    </ks-slider>\r\n\r\n                    <ks-slider class=\"oneline focusable\" data-volumetype=\"UIVolume\" data-bind-ksvalue=\"{{SettingsAudio.volumes.gui}} * 100\">\r\n                        <div slot=\"name\" data-l10n-id=\"volumeUserInterface\">User Interface</div>\r\n                        <div slot=\"unit\" data-bind-value=\"\">%</div>\r\n                    </ks-slider>\r\n\r\n                    <div class=\"header-label\" data-l10n-id=\"lblAudioSettingsCarAudio\">CAR AUDIO</div>\r\n                    <hr>\r\n                    <ks-slider class=\"oneline focusable\" data-volumetype=\"EngineIntVolume\" data-bind-ksvalue=\"Math.round({{SettingsAudio.volumes.engine_int}} * 100)\">\r\n                        <div slot=\"name\" data-l10n-id=\"volumeEngineInterior\">Interior</div>\r\n                        <div slot=\"unit\">%</div>\r\n                    </ks-slider>\r\n\r\n                    <ks-slider class=\"oneline focusable\" data-volumetype=\"EngineExtVolume\" data-bind-ksvalue=\"{{SettingsAudio.volumes.engine_ext}} * 100\">\r\n                        <div slot=\"name\" data-l10n-id=\"volumeEngineExterior\">Exterior</div>\r\n                        <div slot=\"unit\">%</div>\r\n                    </ks-slider>\r\n\r\n                    <ks-slider class=\"oneline focusable\" data-volumetype=\"BodyworkVolume\" data-bind-ksvalue=\"{{SettingsAudio.volumes.bodywork}} * 100\">\r\n                        <div slot=\"name\" data-l10n-id=\"volumeBodywork\">Bodywork</div>\r\n                        <div slot=\"unit\" data-bind-value=\"\">%</div>\r\n                    </ks-slider>\r\n\r\n                    <ks-slider class=\"oneline focusable\" data-volumetype=\"PartsVolume\" data-bind-ksvalue=\"{{SettingsAudio.volumes.parts}} * 100\">\r\n                        <div slot=\"name\" data-l10n-id=\"volumeParts\">Parts</div>\r\n                        <div slot=\"unit\" data-bind-value=\"\">%</div>\r\n                    </ks-slider>\r\n\r\n                    <ks-slider class=\"oneline focusable\" data-volumetype=\"TyresVolume\" data-bind-ksvalue=\"{{SettingsAudio.volumes.tyres}} * 100\">\r\n                        <div slot=\"name\" data-l10n-id=\"volumeTyres\">Tyres</div>\r\n                        <div slot=\"unit\" data-bind-value=\"\">%</div>\r\n                    </ks-slider>\r\n\r\n                    <ks-slider class=\"oneline focusable\" data-volumetype=\"OpponentVolume\" data-bind-ksvalue=\"{{SettingsAudio.volumes.opponent}} * 100\">\r\n                        <div slot=\"name\" data-l10n-id=\"lblOpponents\">Opponents</div>\r\n                        <div slot=\"unit\" data-bind-value=\"\">%</div>\r\n                    </ks-slider>\r\n\r\n                    <div class=\"header-label\" data-l10n-id=\"lblAudioSettingsEnvironment\">ENVIRONMENT</div>\r\n                    <hr>\r\n                    <ks-slider class=\"oneline focusable\" data-volumetype=\"EnvironmentVolume\" data-bind-ksvalue=\"{{SettingsAudio.volumes.environment}} * 100\">\r\n                        <div slot=\"name\" data-l10n-id=\"volumeEnvironment\">Environment</div>\r\n                        <div slot=\"unit\" data-bind-value=\"\">%</div>\r\n                    </ks-slider>\r\n\r\n                    <ks-slider class=\"oneline focusable\" data-volumetype=\"WindVolume\" data-bind-ksvalue=\"{{SettingsAudio.volumes.wind}} * 100\">\r\n                        <div slot=\"name\" data-l10n-id=\"volumeWind\">Wind</div>\r\n                        <div slot=\"unit\" data-bind-value=\"\">%</div>\r\n                    </ks-slider>\r\n\r\n\r\n                </div>\r\n\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n\r\n</div>";

    class SettingsAudio extends KsHTMLElement {

        btnBack;
        btnCancel;
        btnApply;
        btnPresets;

        modalDevice;
        debounceid;
        isDirty = false;
        loading = false;

        constructor() {
            super();
            this.template = template$m;
            this._isnavigable = true;
            this.messagePrefix = "Settings";
            this.delayedInit = true;
            this._exposeAsActivePage = true;
            this._bindScrollableEvents = true;
        }

        loadDevices(callback) {
            this.request("AudioDeviceList", (response) => {
                this.assignModel(response, "SettingsAudioDevices");
                if (callback) {
                    callback();
                }
            });
        }

        load(clear_dirty = true) {
            this.loading = true;
            this.request("Audio", (response) => {
                this.assignModel(response.settings, "SettingsAudio");
                if (clear_dirty) this.clearDirty();
                ksUI$1.waitForFrames(() => {
                    this.loading = false;
                });
            });
        }

        save(callback, skip_load = false) {
            console.log("Requesting SaveAudio");
            this.request("SaveAudio", (response) => {
                ({
                    "OK": () => {
                        console.log("Audio settings saved");
                        if (!skip_load) this.load();
                    },
                    "FAILED": () => {
                        console.log("ERROR", "Audio settings failed to save");
                    },
                    "RESTART": () => {
                        console.log("Audio settings require restart");
                    }
                }[response.response])();
                if (callback)
                    callback();
            });
        }

        reset(unassign_model = true) {
            console.log("Reset Audio");
            if (unassign_model)
                this.unassignModel("SettingsAudio");
            this.request("ResetAudio");
            this.load();
            this.loadDevices();
        }

        markDirty() {
            this.isDirty = true;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.removeAttribute("disabled");
            });
        }

        clearDirty() {
            this.isDirty = false;
            [this.btnApply, this.btnCancel].map(btn => {
                if (btn)
                    btn.setAttribute("disabled", true);
            });
        }

        onRemovedFromDOM() {

        }

        onAfterRenderControlHints(controlhints) {

            this.btnBack = q(".back", controlhints);
            this.btnApply = q(".apply", controlhints);
            this.btnCancel = q(".cancel", controlhints);
            this.btnPresets = q(".presets", controlhints);

            const changePage = function (target, sender, is_back = true) {

                function process() {
                    if (ksUI$1.menuState.isOriginMainMenu && is_back) {
                        ksUI$1.goTo("menu.html", "main/main");
                    } else {
                        ksUI$1.changePage(target, false, false);
                    }
                }

                if (sender.isDirty) {

                    sender.pageModal.Show({
                        type: eModalDialogTypes.Warning,
                        title: "lblChangesDetected",
                        message: "msgChangesWarning",
                        confirm: "btnApply"
                    });

                    sender.pageModal.onDiscard = () => {
                        sender.request("ResetAudio");
                        waitForFrames(() => {
                            process();
                        }, 1);
                    };

                    sender.pageModal.onConfirm = () => {
                        sender.save(() => {
                            process();
                        }, true);
                    };
                } else {
                    process();
                }
            };

            this.btnBack.onPressed = () => {
                changePage("settings/main", this);
            };

            this.btnPresets.onPressed = () => {
                changePage("settings/audiopresets", this, false);
            };

            this.btnApply.onPressed = () => this.save();
            this.btnCancel.onPressed = () => this.reset();
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.load();
            this.modalDevice = q("ks-modalselect.devices", this);
        }

        bindControls() {

            this.modalDevice.onSelected = (ev, new_value, old_value) => {
                console.log("Setting audio device to", new_value);
                this.request("AudioChangeDevice", {
                    device_index: Number(new_value)
                }, (response) => {
                    this.load(false);
                    this.markDirty();
                });
            };

            this.modalDevice.onShow = (e) => {
                this.loadDevices(() => {
                    this.modalDevice.onPopulated();
                });
            };

            qevAll("ks-page-settings-audio ks-slider[data-volumetype]",
                "onSliderValueChanged", (ev) => {
                    let detail = ev.detail;

                    if (this.debounceid) clearTimeout(this.debounceid);

                    if (!this.loading) {
                        this.debounceid = setTimeout(() => {
                            console.log(detail.sender.dataset.volumetype, detail.value, typeof detail.value, detail.value / 100);
                            this.request("AudioChangeVolume",
                                {
                                    volume_type: detail.sender.dataset.volumetype,
                                    volume_value: detail.value / 100
                                });
                        }, 250);
                        this.markDirty();
                    }
                });
        }

    }

    ksUI$1.registerModule('ks-page-settings-audio', SettingsAudio);

    var template$l = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back focusable\"></ks-btnbasic>\r\n            <ks-btnbasic class=\"apply focusable\" id=\"apply\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnApply\">Apply</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"cancel focusable\" id=\"cancel\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCancel\">Cancel</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n\r\n        <div class=\"group center\"></div>\r\n\r\n        <div class=\"group end\">\r\n            <ks-btnbasic class=\"presets focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"btnManagePresets\">Manage Presets</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\">\r\n            <div data-l10n-id=\"headerSettings\">Settings</div>\r\n            <div>/</div>\r\n            <div data-l10n-id=\"headerVideo\">Video</div>\r\n        </div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body is-flex-column\">\r\n        <div id=\"btnGroupModes\" class=\"is-flex-row tab-selectors\">\r\n            <div class=\"controltip\">\r\n\r\n            </div>\r\n\r\n            <ks-btnbasic id=\"btnSettingsDisplay\" class=\"focusable selected\" data-mode=\"display\" toggle-group=\"section\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"videoSettingsDisplay\">Display</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnSettingsGraphics\" class=\"focusable\" data-mode=\"graphics\" toggle-group=\"section\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"videoSettingsGraphics\">Graphics</div>\r\n            </ks-btnbasic>\r\n\r\n            <div class=\"controltip\">\r\n\r\n            </div>\r\n        </div>\r\n        <div id=\"panelModes\" data-mode=\"display\" class=\"column\">\r\n            <div class=\"display scrollable-element scrollable-vertical is-flex-column\">\r\n\r\n                <div class=\"group resolution-group res\">\r\n\r\n                    <div class=\"group\">\r\n\r\n                        <div class=\"label\" data-l10n-id=\"videoSettingsMonitor\">Monitor</div>\r\n                        <div class=\"group-body\">\r\n                            <ks-modalselect static=\"true\" class=\"devices focusable custom-button\" name=\"modalMonitor\">\r\n\r\n                                <div slot=\"current\" data-bind-ksvalue=\"{{SettingsVideo.display.monitor}}\" data-bind-value=\"{{SettingsVideo.display.monitor}}\">Monitor Selected</div>\r\n\r\n                                <div slot=\"options\" id=\"monitorOptions\">\r\n                                    <div class=\"title\" data-l10n-id=\"labelMonitor\">Monitors</div>\r\n                                </div>\r\n                            </ks-modalselect>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"group\">\r\n                        <div class=\"label\" data-l10n-id=\"videoSettingsAspectRatio\">Aspect Ratio</div>\r\n                        <div class=\"group-body\">\r\n                            <ks-modalselect static=\"true\" class=\"devices focusable custom-button\" name=\"modalAspectRatio\">\r\n                                <div slot=\"current\" id=\"ar\" data-bind-ksvalue=\"mergeAR({{SettingsVideo.display.aspect_ratio_x}},{{SettingsVideo.display.aspect_ratio_y}})\" data-bind-value=\"mergeAR({{SettingsVideo.display.aspect_ratio_x}},{{SettingsVideo.display.aspect_ratio_y}})\">Aspect Ratio Selected</div>\r\n\r\n                                <div slot=\"options\" id=\"aspectRatioOptions\">\r\n                                    <div class=\"title\" data-l10n-id=\"labelAspectRatio\">Aspect Ratio</div>\r\n                                </div>\r\n                            </ks-modalselect>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class=\"group\">\r\n                        <div class=\"label\" data-l10n-id=\"videoSettingsResolution\">Resolution</div>\r\n                        <div class=\"group-body\">\r\n                            <ks-modalselect static=\"true\" class=\"devices focusable custom-button\" name=\"modalResolution\">\r\n\r\n                                <div slot=\"current\" data-bind-ksvalue=\"merge({{SettingsVideo.display.window_width}},{{SettingsVideo.display.window_height}})\" data-bind-value=\"merge({{SettingsVideo.display.window_width}},{{SettingsVideo.display.window_height}})\">Resolution Selected</div>\r\n\r\n                                <div slot=\"options\" id=\"resolutionOptions\">\r\n                                    <div class=\"title\" data-l10n-id=\"labelResolutions\">Resolution</div>\r\n                                </div>\r\n                            </ks-modalselect>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionDisplay\">DISPLAY</div>\r\n                <hr>\r\n                <ks-slider id=\"sliderFrameLimit\" class=\"oneline focusable hide-unit-min\" data-bind-ksvalue=\"{{SettingsVideo.display.frame_rate_limit.gameplay_frame_rate_limit}}\" min=\"30\" max=\"240\" step=\"1\" off=\"0\" _values='[\"optionOff\",30,60,90,120,240]' data-tooltip=\"tooltipVideoSettingsFrameRateLimit\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsGameplayFPSLimit\">Gameplay Frame Rate Limit</div>\r\n                    <div slot=\"unit\">fps</div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-bind-ksvalue=\"{{SettingsVideo.display.frame_rate_limit.menu_frame_rate_limit}}\" values='[\"optionOff\",\"optionOn\"]' data-tooltip=\"tooltipVideoSettingsEnableMenuFPSLimit\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsMenuFPSLimit\">Menu Frame Rate Limit</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{SettingsVideo.display.v_sync}}\" values='[\"Adaptive\",\"Off\",\"On\"]' data-tooltip=\"tooltipVideoSettingsVSync\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsVerticalSync\">Vertical Sync</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable fullscreen\" data-bind-ksvalue=\"{{SettingsVideo.display.is_fullscreen}}\" values='[\"optionOff\",\"optionOn\"]' data-tooltip=\"tooltipVideoSettingsEnableFullscreen\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsFullscreen\">Fullscreen</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-bind-ksvalue=\"{{SettingsVideo.display.is_triple}}\" values='[\"optionOff\",\"optionOn\"]' data-tooltip=\"tooltipVideoSettingsEnableTripleScreen\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsTripleScreen\">Triple Screen</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n                <div class=\"group-triplescreen\">\r\n                </div>\r\n\r\n            </div>\r\n\r\n            <!-- GRAPHICS SECTION  -->\r\n\r\n            <div class=\"graphics scrollable-element scrollable-vertical is-flex-column\">\r\n\r\n                <ks-slider id=\"sliderGraphicsPreset\" class=\"focusable main-graphics\" data-bind-ksvalue=\"{{SettingsVideo.graphics.overallGraphics}}\" values='[\"videoOptionCustom\",\"videoOptionVeryLow\",\"videoOptionLow\",\"videoOptionMedium\",\"videoOptionHigh\",\"videoOptionUltra\"]' data-tooltip=\"tooltipVideoSettingsGraphicsPresets\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsGraphicsPreset\">Graphics</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionUpscaling\">UPSCALING</div>\r\n                <hr>\r\n                <ks-slider data-sn-up=\"#sliderGraphicsPreset\" id=\"sliderUpscalingMode\" class=\"oneline focusable upscaling\" data-path=\"{{SettingsVideo.graphics.upscaling.mode}}\" data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsUpscalingMode\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsUpscalingMode\">Upscaling Mode</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <div class=\"group-upscaling\" data-mode=\"Upscaling_None\">\r\n                    <ks-slider class=\"oneline focusable show-dlss\" data-bind-ksvalue=\"{{SettingsVideo.graphics.upscaling.dlss_preset}}\" values='[\"DLSS_Performance\",\"DLSS_Balanced\",\"DLSS_Quality\",\"DLSS_UltraQuality\",\"DLSS_DLAA\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsDLSSPresets\">\r\n                        <div slot=\"name\" data-l10n-id=\"videoSettingsUpscalingDLSSPreset\">DLSS Preset</div>\r\n                        <div slot=\"unit\"></div>\r\n                    </ks-slider>\r\n                    <ks-slider class=\"oneline focusable show-fsr3\" data-bind-ksvalue=\"{{SettingsVideo.graphics.upscaling.fsr3_preset}}\" values='[\"FSR3_Performance\",\"FSR3_Balanced\",\"FSR3_Quality\",\"FSR3_UltraQuality\",\"FSR3_NativeAA\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsFSR3Preset\">\r\n                        <div slot=\"name\" data-l10n-id=\"videoSettingsUpscalingFSR3Preset\">FSR3 Preset</div>\r\n                        <div slot=\"unit\"></div>\r\n                    </ks-slider>\r\n                </div>\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionAA\">ANTI-ALIASING</div>\r\n                <hr>\r\n                <ks-slider class=\"oneline focusable graphics-setting msaa\" data-bind-ksvalue=\"{{SettingsVideo.graphics.msaa}}\" values='[\"MSAA_Off\",\"MSAA_2x\",\"MSAA_4x\",\"MSAA_8x\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsMSAA\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsMSAA\">MSAA</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting show-filmic\" data-bind-ksvalue=\"{{SettingsVideo.graphics.antialising.filmicAntialiasing.setting}}\" values='[\"Type_Off\",\"Type_Sharp\",\"Type_Balanced\",\"Type_Cinematic\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsFilmicAA\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsFilmicAntialiasing\">Filmic Antialiasing</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable graphics-setting fxaa\" data-bind-ksvalue=\"{{SettingsVideo.graphics.antialising.fxaa.enable}}\" values='[\"optionOff\",\"optionOn\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsFXAA\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsFXAA\">FXAA</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionTexture\">TEXTURE</div>\r\n                <hr>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.anisotropicFiltering.anisotropicFilteringQuality}}\" values='[\"AnisotropicFilteringQuality_VeryLow\",\"AnisotropicFilteringQuality_Low\",\"AnisotropicFilteringQuality_Medium\",\"AnisotropicFilteringQuality_High\",\"AnisotropicFilteringQuality_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsAnisotropicFiltering\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsAnisotropic\">Anisotropic Filtering</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting texturepool\" data-bind-ksvalue=\"{{SettingsVideo.graphics.texturePoolSize}}\" values='[\"TexturePoolSize_Low\",\"TexturePoolSize_Medium\",\"TexturePoolSize_High\",\"TexturePoolSize_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsTexturePoolSize\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsTexturePoolSize\">Texture Pool Size</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionLOD\">LEVEL OF DETAIL</div>\r\n                <hr>\r\n                <ks-slider class=\"oneline focusable graphics-setting lod\" data-bind-ksvalue=\"{{SettingsVideo.graphics.levelOfDetail.levelOfDetail}}\" values='[\"LevelOfDetailQuality_Low\",\"LevelOfDetailQuality_Medium\",\"LevelOfDetailQuality_High\",\"LevelOfDetailQuality_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsLOD\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsLevelOfDetail\">Level Of Detail</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable graphics-setting experimental-static-lod\" data-bind-ksvalue=\"{{SettingsVideo.graphics.levelOfDetail.experimentalStaticLevelOfDetail}}\" values='[\"optionOff\",\"optionOn\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsExperimentalStaticLOD\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsExperimentalStaticLOD\">Experimental Static LOD</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting static-lod-quality\" data-bind-ksvalue=\"{{SettingsVideo.graphics.levelOfDetail.staticLevelOfDetail}}\" values='[\"StaticLevelOfDetailQuality_Low\",\"StaticLevelOfDetailQuality_Medium\",\"StaticLevelOfDetailQuality_High\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsStaticLOD\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsStaticLevelOfDetail\">Static Level Of Detail</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.vehicleLevelOfDetail}}\" values='[\"VehicleLevelOfDetailQuality_Low\",\"VehicleLevelOfDetailQuality_Medium\",\"VehicleLevelOfDetailQuality_High\",\"VehicleLevelOfDetailQuality_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsVehicleLOD\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsVehicleLevelOfDetail\">Vehicle Level Of Detail</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionCarsVisibility\">CARS VISIBILITY</div>\r\n                <hr>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.car_visibility.max_ahead_car}}\" min=\"1\" max=\"50\" step=\"1\" data-tooltip=\"tooltipVideoSettingsMaxCarAhead\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsMaxCarAhead\">Max Car Ahead</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.car_visibility.max_behind_car}}\" min=\"1\" max=\"50\" step=\"1\" data-tooltip=\"tooltipVideoSettingsMaxCarBehind\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsMaxCarBehind\">Max Car Behind</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable\" data-bind-ksvalue=\"{{SettingsVideo.graphics.car_visibility.filter_when_spectating}}\" values='[\"optionOff\",\"optionOn\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsFilterWhenSpectating\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsFilterWhenSpectating\">Filter When Spectating</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionLighting\">LIGHTING</div>\r\n                <hr>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.giUpdateFrequency}}\" values='[\"GlobalIlluminationUpdateFrequency_Medium\",\"GlobalIlluminationUpdateFrequency_High\",\"GlobalIlluminationUpdateFrequency_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsGIFrequency\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsGlobalIllumination\">Global Illumination Update Frquency</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.ambientOcclusion}}\" values='[\"AmbientOcclusionQuality_Off\",\"AmbientOcclusionQuality_Low\",\"AmbientOcclusionQuality_Medium\",\"AmbientOcclusionQuality_High\",\"AmbientOcclusionQuality_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsAO\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsAmbientOcclusion\">Ambient Occlusion</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.volumetricsQuality}}\" values='[\"VolumetricsQuality_Low\",\"VolumetricsQuality_Medium\",\"VolumetricsQuality_High\"]' data-setting=\"graphics\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsVolumetrics\">Volumetrics</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionReflections\">REFLECTIONS</div>\r\n                <hr>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.enviromentReflection}}\" values='[\"EnvironmentReflectionQuality_Low\",\"EnvironmentReflectionQuality_Medium\",\"EnvironmentReflectionQuality_High\"]' data-setting=\"graphics\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsEnvironmentReflection\">Environment Reflection</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.carReflection.carReflectionQuality}}\" values='[\"CarReflectionQuality_Low\",\"CarReflectionQuality_Medium\",\"CarReflectionQuality_High\",\"CarReflectionQuality_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsCarReflection\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsCarReflection\">Car Reflection</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionShadows\">SHADOWS</div>\r\n                <hr>\r\n                <ks-slider class=\"oneline focusable graphics-setting shadow\" data-bind-ksvalue=\"{{SettingsVideo.graphics.shadow.shadowQuality}}\" values='[\"ShadowQuality_VeryLow\",\"ShadowQuality_Low\",\"ShadowQuality_Medium\",\"ShadowQuality_High\",\"ShadowQuality_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsShadows\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsShadows\">Shadows</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline toggle focusable graphics-setting experimental-sim-shadow\" data-bind-ksvalue=\"{{SettingsVideo.graphics.shadow.experimentalSimShadow}}\" values='[\"optionOff\",\"optionOn\"]' data-tooltip=\"tooltipVideoSettingsExperimentalSimShadows\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsExperimentalSimShadows\">Experimental Sim Shadows</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting sim-shadow\" data-bind-ksvalue=\"{{SettingsVideo.graphics.shadow.simShadowQuality}}\" values='[\"SimShadowQuality_Low\",\"SimShadowQuality_Medium\",\"SimShadowQuality_High\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsSimShadows\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsSimShadows\">Sim Shadows</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting sim-shadow\" data-bind-ksvalue=\"{{SettingsVideo.graphics.shadow.screenSpaceShadowQuality}}\" values='[\"ScreenSpaceShadowQuality_0ff\",\"ScreenSpaceShadowQuality_HalfRes\",\"ScreenSpaceShadowQuality_FullRes\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsScreenSpaceShadows\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsScreenSpaceShadows\">Screen Space Shadows</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <!-- <h3>PARTICLES</h3>\r\n                <hr>\r\n                <ks-slider\r\n                    class=\"oneline focusable graphics-setting\"\r\n                    data-bind-ksvalue=\"{{SettingsVideo.graphics.particlesQuality}}\"\r\n                    values='[\"ParticlesQuality_Low\",\"ParticlesQuality_Medium\",\"ParticlesQuality_High\"]'\r\n                    data-setting=\"graphics\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsParticles\">Particles</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider> -->\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionEnvironment\">ENVIRONMENT</div>\r\n                <hr>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.grass}}\" values='[\"GrassDensity_Off\",\"GrassDensity_Low\",\"GrassDensity_Medium\",\"GrassDensity_High\",\"GrassDensity_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsGrass\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsGrass\">Grass</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.clouds.cloudsQuality}}\" values='[\"CloudsQuality_Low\",\"CloudsQuality_Medium\",\"CloudsQuality_High\",\"CloudsQuality_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsCloudsQuality\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsCloudsQuality\">Clouds Quality</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionPP\">POST PROCESSING</div>\r\n                <hr>\r\n                <div class=\"group pp-group\">\r\n                    <div class=\"label\" data-l10n-id=\"videoSettingsPostProcessingPresets\">Post Processing Presets</div>\r\n                    <ks-modalselect static=\"true\" extracssclass=\"postprocessing-selector\" class=\"devices focusable custom-button\" name=\"modalPostProcessing\">\r\n                        <div slot=\"current\" data-bind-ksvalue=\"{{SettingsVideo.graphics.post_processing_preset}}\" data-bind-value=\"{{SettingsVideo.graphics.post_processing_preset}}\">Post Processing</div>\r\n\r\n                        <div slot=\"options\" id=\"ppOptions\">\r\n                            <div class=\"title\" data-l10n-id=\"labelPostProcessingPresets\">Post Processing Presets</div>\r\n                            <div class=\"list\">\r\n                                <div id=\"pp-list\">\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </ks-modalselect>\r\n                </div>\r\n                <ks-slider class=\"oneline focusable graphics-setting numeric\" data-bind-ksvalue=\"{{SettingsVideo.graphics.exposureBias}}\" min=\"-1\" step=\"0.1\" precision=\"1\" max=\"1\" data-setting=\"exposure\" data-tooltip=\"tooltipVideoSettingsExposureBias\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsExposure\">Exposure</div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting numeric\" data-bind-ksvalue=\"{{SettingsVideo.graphics.sharpening.strength}}\" min=\"0\" step=\"0.01\" precision=\"2\" max=\"2\" data-setting=\"sharpening\" data-tooltip=\"tooltipVideoSettingsFidelityFXCAS\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsFidelityFXCAS\">FidelityFX CAS</div>\r\n                    <div slot=\"unit\">%</div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.veil}}\" values='[\"Veil_Soft\",\"Veil_Natural\",\"Veil_Cinematic\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsVeilType\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsVeilType\">Veil Type</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.depthOfField}}\" values='[\"DepthOfFieldQuality_Off\",\"DepthOfFieldQuality_Low\",\"DepthOfFieldQuality_Medium\",\"DepthOfFieldQuality_High\", \"DepthOfFieldQuality_Ultra\"]' data-setting=\"graphics\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsDepthOfFieldQuality\">DOF Quality</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionMotionBlur\">MOTION BLUR</div>\r\n                <hr>\r\n                <ks-slider class=\"oneline focusable graphics-setting\" data-bind-ksvalue=\"{{SettingsVideo.graphics.motionBlur.quality}}\" values='[\"MotionBlurQuality_Off\",\"MotionBlurQuality_Low\",\"MotionBlurQuality_Medium\",\"MotionBlurQuality_High\", \"MotionBlurQuality_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsMBQuality\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsMotionBlurQuality\">Motion Blur Quality</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting numeric\" data-bind-ksvalue=\"{{SettingsVideo.graphics.motionBlur.strength}}\" min=\"0\" step=\"0.01\" precision=\"2\" max=\"3\" data-setting=\"blur\" data-tooltip=\"tooltipVideoSettingsMBStrength\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsMotionBlurStrength\">Motion Blur Strength</div>\r\n                    <div slot=\"unit\">%</div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable graphics-setting numeric\" data-bind-ksvalue=\"{{SettingsVideo.graphics.motionBlur.centralClarity}}\" min=\"0\" step=\"0.01\" precision=\"2\" max=\"1\" data-setting=\"blur-quality\" data-tooltip=\"tooltipVideoSettingsMBCentralQuality\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsMotionBlurCentralQuality\">Motion Blur Central Quality</div>\r\n                    <div slot=\"unit\">%</div>\r\n                </ks-slider>\r\n\r\n                <div class=\"header-label\" data-l10n-id=\"videoSettingsSectionMirrors\">MIRRORS</div>\r\n                <hr>\r\n                <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{SettingsVideo.graphics.mirror.mirror_mode}}\" values='[\"Mirror_Off\",\"Mirror_Single\",\"Mirror_Multi\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsMirrorMode\">\r\n                    <div slot=\"name\" data-l10n-id=\"videoSettingsMirrorMode\">Mirror Mode</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n\r\n                <div class=\"group-mirror\" data-mode=\"Mirror_Off\">\r\n                    <ks-slider class=\"oneline focusable show-single\" data-bind-ksvalue=\"{{SettingsVideo.graphics.mirror.mirror_resolution}}\" values='[\"MirrorResolution_Low\",\"MirrorResolution_Medium\",\"MirrorResolution_High\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsMirrorResolution\">\r\n                        <div slot=\"name\" data-l10n-id=\"videoSettingsMirrorResolution\">Mirror Resolution</div>\r\n                        <div slot=\"unit\"></div>\r\n                    </ks-slider>\r\n                    <ks-slider class=\"oneline focusable show-single\" data-bind-ksvalue=\"{{SettingsVideo.graphics.mirror.mirror_level_of_detail}}\" values='[\"MirrorLevelOfDetailQuality_Low\",\"MirrorLevelOfDetailQuality_Medium\",\"MirrorLevelOfDetailQuality_High\", \"MirrorLevelOfDetailQuality_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsMirrorLODQuality\">\r\n                        <div slot=\"name\" data-l10n-id=\"videoSettingsMirrorLODQuality\">Mirror LOD Quality</div>\r\n                        <div slot=\"unit\"></div>\r\n                    </ks-slider>\r\n                    <ks-slider class=\"oneline focusable show-single\" data-bind-ksvalue=\"{{SettingsVideo.graphics.mirror.mirror_view_distance}}\" values='[\"MirrorViewDistance_Low\",\"MirrorViewDistance_Medium\",\"MirrorViewDistance_High\", \"MirrorViewDistance_Ultra\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsMirrorViewDistance\">\r\n                        <div slot=\"name\" data-l10n-id=\"videoSettingsMirrorViewDistance\">Mirror View Distance</div>\r\n                        <div slot=\"unit\"></div>\r\n                    </ks-slider>\r\n                    <ks-slider class=\"oneline toggle focusable show-multi\" data-bind-ksvalue=\"{{SettingsVideo.graphics.mirror.alternate_rendering}}\" values='[\"optionOff\",\"optionOn\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsAlternateRendering\">\r\n                        <div slot=\"name\" data-l10n-id=\"videoSettingsAlternateRendering\">Alternate Rendering</div>\r\n                        <div slot=\"unit\"></div>\r\n                    </ks-slider>\r\n                    <ks-slider class=\"oneline toggle focusable show-multi\" data-bind-ksvalue=\"{{SettingsVideo.graphics.mirror.multi_mode}}\" values='[\"Multi_Fixed\",\"Multi_VR\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsMirrorMultiMode\">\r\n                        <div slot=\"name\" data-l10n-id=\"videoSettingsMultiMode\">Multi Mode</div>\r\n                        <div slot=\"unit\"></div>\r\n                    </ks-slider>\r\n                    <ks-slider data-sn-down=\"#btnBack\" class=\"oneline focusable\" data-bind-ksvalue=\"{{SettingsVideo.graphics.num_dash_displays}}\" values='[\"NumDashDisplays_MaxOne\",\"NumDashDisplays_MaxTwo\",\"NumDashDisplays_All\"]' data-setting=\"graphics\" data-tooltip=\"tooltipVideoSettingsNumDashDisplays\">\r\n                        <div slot=\"name\" data-l10n-id=\"videoSettingsNumDashDisplays\">Num Dash Displays</div>\r\n                        <div slot=\"unit\"></div>\r\n                    </ks-slider>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n</div>";

    class SettingsPageVideo extends KsHTMLElement {

        /** @type MessageHandler */
        Client;
        /** @type Btnbasic */
        btnBack;
        /** @type Btnbasic */
        btnCancel;
        /** @type Btnbasic */
        btnApply;
        /** @type Btnbasic */
        btnPresets;

        /** @type HTMLDivElement */
        panelModes;

        /** @type {KsSlider} */
        sliderFrameLimit;

        /** @type {KsSlider} */
        sliderUpscalingMode;

        /** @type {ModalSelect} */
        modalPostProcessing;

        /** @type {ModalSelect} */
        modalMonitor;

        /** @type {ModalSelect} */
        modalAspectRatio;

        /** @type {ModalSelect} */
        modalResolution;


        actualMonitor;
        actualAspectRatio;

        nativeAspectRatio_width;
        nativeAspectRatio_height;
        nativeResolution_width;
        nativeResolution_height;

        originalMonitor;
        originalWindowHeight;
        originalAspectRatioY;
        labelNative = " (Native)";
        labelDefault = " (Default)";

        revertDisplayValue;
        actualResolution;
        displaySettings;
        postProcessingSettings;
        isDirty = false;
        loading = false;
        has_res = false;

        is_display = false;

        btnSwitch = [];

        allowedAspectRatios = [
            { x: 4, y: 3 },
            { x: 16, y: 9 },
            { x: 16, y: 10 },
            { x: 21, y: 9 },
            { x: 32, y: 9 }
        ];

        constructor() {
            super();
            this.template = template$l;
            this._isnavigable = true;
            this.messagePrefix = "Settings";
            this._exposeAsActivePage = true;
            this._bindScrollableEvents = true;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.mapElementById("panelModes");
            this.mapElementById("sliderFrameLimit");
            this.mapElementById("sliderUpscalingMode");

            this.modalMonitor = q("ks-modalselect[name=modalMonitor]", this);
            this.modalAspectRatio = q("ks-modalselect[name=modalAspectRatio]", this);
            this.modalResolution = q("ks-modalselect[name=modalResolution]", this);
            this.modalPostProcessing = q("ks-modalselect[name=modalPostProcessing]", this);
            this.Client = new MessageHandler("Settings");
            this.load();
            this.getSwitchButtons();
            this.handleDeviceScrolling();
            document.body.classList.add("left-restricted-tooltips");

            const _settingsNavConfig = {
                selector: '#panelModes .graphics .focusable',
                leaveFor: {
                    up: "#btnSettingsGraphics",
                    down: "#btnBack"
                }
            };

            SpatialNavigation$1.add("scrollables", _settingsNavConfig);

        }

        load(clear_dirty = true) {
            this.loading = true;
            this.Client.request("Video", (response) => {
                ksUI$1.assignModel(response.video, "SettingsVideo");
                console.log(response.video);

                this.displaySettings = response.video_settings_rules;
                this.postProcessingSettings = response.additional_settings;
                this.preliminarySetup();
                this.populateSliderValues();
                if (clear_dirty) this.clearDirty();
                ksUI$1.waitForFrames(() => {
                    this.loading = false;
                }, 4);
            });
        }

        upscalingSlider() {
            let upscalingValueArray = ["Upscaling_None"];

            if (SettingsVideo.graphics.is_dlss_available) {
                upscalingValueArray.push("Upscaling_DLSS");
            } else {
                q("ks-slider.show-dlss").style.display = "none";
            }

            if (SettingsVideo.graphics.is_fsr_available) {
                upscalingValueArray.push("Upscaling_FSR3");
            } else {
                q("ks-slider.show-fsr3").style.display = "none";
            }

            this.sliderUpscalingMode.values = JSON.stringify(upscalingValueArray);

            if (!SettingsVideo.graphics.is_fsr_available && !SettingsVideo.graphics.is_dlss_available) {
                SettingsVideo.graphics.upscaling.mode = "Upscaling_None";
                this.sliderUpscalingMode.setAttribute('disabled', 'disabled');
                return;
            }
            this.sliderUpscalingMode.value = SettingsVideo.graphics.upscaling.mode;

        }


        populateSliderValues() {
            const slider = q("#post-processing-slider");
            if (slider && SettingsVideo.post_processing_presets_list.length) {
                const pp_values = SettingsVideo.post_processing_presets_list.map(item => `"${item}"`).join(',');

                slider.setAttribute('values', `[${pp_values}]`);
            }
        }

        updatePostProcessingFirstStart() {
            if (SettingsVideo.graphics.post_processing_preset == "") {
                SettingsVideo.graphics.post_processing_preset = "Natural 7";
            }
        }

        canEnableFullscreen() {
            this.cleanUpNative();
            this.canGoFullscreen();
            if (SettingsVideo.display.is_fullscreen) {
                this.modalAspectRatio.removeAttribute('disabled');
            } else {
                this.modalAspectRatio.setAttribute('disabled', 'disabled');
            }
        }

        canGoFullscreen() {
            const resolutionOptions = document.getElementById("resolutionOptions");
            this.clearChildren(resolutionOptions);
            const selectedAspectRatio = this.actualAspectRatio;
            this.revertDisplayValue = `${SettingsVideo.display.window_width}x${SettingsVideo.display.window_height}`;        let selectedAspectRatioX, selectedAspectRatioY;
            const monitor = this.displaySettings.adapters[0].monitors[this.actualMonitor - 1];
            const resolutionsByRatio = monitor.resolutions_by_ratio;
            if (typeof selectedAspectRatio === 'string' && selectedAspectRatio.includes(':')) {
                [selectedAspectRatioX, selectedAspectRatioY] = selectedAspectRatio.split(':').map(Number);
            }
            for (const ratioEntry of resolutionsByRatio) {
                const aspectRatio = ratioEntry.aspect_ratio;
                if (aspectRatio.x === selectedAspectRatioX && aspectRatio.y === selectedAspectRatioY) {

                    for (const resolution of ratioEntry.resolutions) {
                        if (resolution.x >= 1280 && resolution.y >= 720) {
                            const textContent = `${resolution.x}x${resolution.y}`;

                            if (this.revertDisplayValue === textContent) {
                                q('ks-slider.fullscreen').removeAttribute('disabled');
                                return;
                            }
                        }
                    }
                    q('ks-slider.fullscreen').setAttribute('disabled', 'disabled');
                    return;
                }
            }
        }

        preliminarySetup() {
            this.upscalingSlider();
            this.updatePostProcessingFirstStart();
            this.updateShadowVisibility("experimentalSimShadow", SettingsVideo.graphics.shadow.experimentalSimShadow);
            this.updateUpscalingVisibility("upscaling", SettingsVideo.graphics.upscaling.mode);
            this.updateLevelOfDetailVisibility("experimentalStaticLevelOfDetail", SettingsVideo.graphics.levelOfDetail.experimentalStaticLevelOfDetail);
            this.setupMirrorsVisibility(SettingsVideo.graphics.mirror.mirror_mode);
            q(".group-triplescreen").style.display = SettingsVideo.display.is_triple ? "block" : "none";

            if (SettingsVideo.display.aspect_ratio_x === 0) {
                this.setNativeDisplaySettings(0);
            } else {
                SettingsVideo.display.window_width = window.innerWidth;
                SettingsVideo.display.window_height = window.innerHeight;
                this.actualMonitor = SettingsVideo.display.monitor;
                this.actualAspectRatio = `${SettingsVideo.display.aspect_ratio_x}:${SettingsVideo.display.aspect_ratio_y}`;
                this.actualResolution = `${SettingsVideo.display.window_width}x${SettingsVideo.display.window_height}`;
                console.log("STARTING MONITOR IS:", this.actualMonitor);
                console.log("STARTING ASPECT RATIO IS:", this.actualAspectRatio);
                console.log("STARTING RESOLUTION IS", `${SettingsVideo.display.window_width}x${SettingsVideo.display.window_height}`);
                console.log("ACTUAL RESOLUTION IS:", this.actualResolution);
                this.initNative();
            }
            this.canEnableFullscreen();
        }

        // unfair hack (???)
        initNative() {
            const monitor = this.displaySettings.adapters[0].monitors[this.actualMonitor - 1];

            if (SettingsVideo.display.monitor == 1) {
                this.originalMonitor = SettingsVideo.display.monitor;
                SettingsVideo.display.monitor = SettingsVideo.display.monitor + this.labelDefault;
            } else {
                this.originalMonitor = SettingsVideo.display.monitor;
            }
            if (SettingsVideo.display.window_width == monitor.native_resolution.x && SettingsVideo.display.window_height == monitor.native_resolution.y) {
                this.originalWindowHeight = SettingsVideo.display.window_height;

                SettingsVideo.display.window_height = SettingsVideo.display.window_height + this.labelNative;
                this.actualResolution = `${SettingsVideo.display.window_width}x${SettingsVideo.display.window_height}`;
            } else {
                this.originalWindowHeight = SettingsVideo.display.window_height;
            }
            if (SettingsVideo.display.aspect_ratio_x == monitor.native_aspect_ratio.x && SettingsVideo.display.aspect_ratio_y == monitor.native_aspect_ratio.y) {
                this.originalAspectRatioY = SettingsVideo.display.aspect_ratio_y;
                SettingsVideo.display.aspect_ratio_y = SettingsVideo.display.aspect_ratio_y + this.labelNative;
            } else {
                this.originalAspectRatioY = SettingsVideo.display.aspect_ratio_y;
            }
            console.log("NATIVE SAVED HEIGHT IS:", this.originalWindowHeight);
            console.log("NATIVE SAVED ASPECT RATIO Y IS:", this.originalAspectRatioY);
        }

        // TO UPDATE 
        setNativeDisplaySettings(monitorNumber) {
            console.log("FIRST VIDEO SETTINGS STARTUP!");
            SettingsVideo.display.monitor = 1 + this.labelDefault;
            this.originalMonitor = 1;
            this.actualMonitor = 1;

            // displaying current resolution until rework -> client should start the game at native resolution (?)
            // SettingsVideo.display.window_width = this.displaySettings.adapters[0].monitors[monitorNumber].native_resolution.x;
            // SettingsVideo.display.window_height = this.displaySettings.adapters[0].monitors[monitorNumber].native_resolution.y + this.labelNative;
            // this.originalWindowHeight = this.displaySettings.adapters[0].monitors[monitorNumber].native_resolution.y;

            this.originalWindowHeight = SettingsVideo.display.window_height;
            SettingsVideo.display.aspect_ratio_x = this.displaySettings.adapters[0].monitors[monitorNumber].native_aspect_ratio.x;
            SettingsVideo.display.aspect_ratio_y = this.displaySettings.adapters[0].monitors[monitorNumber].native_aspect_ratio.y + this.labelNative;
            this.actualAspectRatio = `${this.displaySettings.adapters[0].monitors[monitorNumber].native_aspect_ratio.x}:${this.displaySettings.adapters[0].monitors[monitorNumber].native_aspect_ratio.y}`;
            this.originalAspectRatioY = this.displaySettings.adapters[0].monitors[monitorNumber].native_aspect_ratio.y;
            this.actualResolution = `${SettingsVideo.display.window_width}x${SettingsVideo.display.window_height}`;
            console.log("NATIVE FIRST START MONITOR IS:", SettingsVideo.display.monitor);
            console.log("NATIVE FIRST START HEIGHT IS:", SettingsVideo.display.window_height);
            console.log("NATIVE FIRST START ASPECT RATIO Y IS:", SettingsVideo.display.aspect_ratio_y);
        }

        createOptionElement(dataValue, textContent, isNative = false, isMain = false) {
            let div = document.createElement("div");
            div.className = "option centered focusable";
            div.setAttribute("data-value", dataValue);
            div.textContent = textContent;
            if (isMain) {
                div.textContent += this.labelDefault;
                console.log(textContent);
            } else if (isNative) {
                div.textContent += this.labelNative;
            }
            return div;
        }

        cleanUpNative() {
            SettingsVideo.display.window_height = this.originalWindowHeight;
            SettingsVideo.display.aspect_ratio_y = this.originalAspectRatioY;
            this.actualResolution = `${SettingsVideo.display.window_width}x${SettingsVideo.display.window_height}`;
            SettingsVideo.display.monitor = this.originalMonitor;
        }

        checkForResolutionChange(x, y, displayvalue) {
            this.pageModal.Show({
                type: eModalDialogTypes.Warning,
                title: "lblConfirmResolution",
                message: "msgConfirmResolutionChange",
                buttons: 0x101
            });

            let resTimer;
            let timeleft = 10;

            resTimer = setInterval(() => {
                if (timeleft <= 0) {
                    this.pageModal.onCancel();
                    this.pageModal.Hide();
                } else {
                    timeleft--;
                    q(".timer").textContent = timeleft + 1;
                }
            }, 1000);

            this.pageModal.onConfirm = () => {
                this.actualResolution = displayvalue;
                this.modalResolution.setCurrentText(displayvalue);
                clearInterval(resTimer);
                this.canGoFullscreen();
            };

            this.pageModal.onCancel = () => {
                let [x, y] = this.actualResolution.split('x');
                displayvalue = this.revertDisplayValue;
                SettingsVideo.display.window_width = parseInt(x, 10);
                SettingsVideo.display.window_height = parseInt(y, 10);
                this.originalWindowHeight = SettingsVideo.display.window_height;
                this.modalResolution.setCurrentText(displayvalue);
                this.save();
                clearInterval(resTimer);
            };
        }

        save() {
            this.cleanUpNative();
            this.canEnableFullscreen();
            this.Client.request("SaveVideo",
                {
                    display: SettingsVideo.display,
                    graphics: SettingsVideo.graphics,
                    is_display: this.is_display
                },
                (response) => {
                    ({
                        [eCommandResponse.OK]: () => {
                            console.log("Video settings saved!");
                            this.clearDirty();
                            this.loading = true;
                            ksUI$1.waitForFrames(() => {
                                this.loading = false;
                            }, 15);
                        },
                        [eCommandResponse.Failed]: () => {
                            console.error("Video settings failed to save!");
                        },
                        [eCommandResponse.Restart]: () => {
                            console.log("Video settings require restart!");
                        }
                    }[response.response])();
                });
        }

        onRemovedFromDOM() {
            ksUI$1.unassignModel("SettingsVideo");
            SpatialNavigation$1.remove("scrollables");
            document.body.classList.remove("left-restricted-tooltips");
        }

        reset() {
            console.log("Reset Video settings");
            ksUI$1.unassignModel("SettingsVideo");
            this.Client.request("ResetVideo");
            this.load();
        }

        markDirty() {
            this.isDirty = true;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.removeAttribute("disabled");
            });
        }

        clearDirty() {
            this.isDirty = false;
            [this.btnApply, this.btnCancel].map(btn => {
                if (btn)
                    btn.setAttribute("disabled", "true");
            });
        }

        onAfterRenderControlHints(controlhints) {

            this.btnBack = q(".back", controlhints);
            this.btnApply = q(".apply", controlhints);
            this.btnCancel = q(".cancel", controlhints);
            this.btnPresets = q(".presets", controlhints);

            const changePage = function (target, sender, is_back = true) {

                function process() {
                    if (ksUI$1.menuState.isOriginMainMenu && is_back) {
                        ksUI$1.goTo("menu.html", "main/main");
                    } else {
                        ksUI$1.changePage(target, false, false);
                    }
                }

                if (sender.isDirty) {
                    sender.pageModal.Show({
                        type: eModalDialogTypes.Warning,
                        title: "lblChangesDetected",
                        message: "msgChangesWarning",
                        confirm: "btnApply"
                    });

                    sender.pageModal.onDiscard = () => {
                        sender.reset();
                        process();
                    };

                    sender.pageModal.onConfirm = () => {
                        sender.save();
                        process();
                    };
                } else {
                    process();
                }
            };

            this.btnBack.onPressed = () => {
                changePage("settings/main", this);
            };

            this.btnPresets.onPressed = () => {
                changePage("settings/videopresets", this, false);
            };

            this.btnApply.onPressed = () => this.save();
            this.btnCancel.onPressed = () => this.reset();
        }


        handleDeviceScrolling() {
            const graphicsContainer = document.querySelector(".graphics");
            const displayContainer = document.querySelector(".display");
            function handleSliderFocus(container) {
                const sliders = container.querySelectorAll("ks-slider");

                sliders.forEach(slider => {
                    slider.addEventListener("focus", function () {
                        const sliderRect = slider.getBoundingClientRect();
                        const parentRect = container.getBoundingClientRect();
                        const offset = sliderRect.top - parentRect.top;

                        if (offset < 0) {
                            container.scrollTop += offset - 20;
                        } else if (offset + sliderRect.height > parentRect.height) {
                            container.scrollTop += (offset + sliderRect.height - parentRect.height) + 20;
                        }
                    });
                });
            }
            if (graphicsContainer) { handleSliderFocus(graphicsContainer); }
            if (displayContainer) { handleSliderFocus(displayContainer); }
        }

        getSwitchButtons() {
            qAll("ks-btnbasic[toggle-group=section]").forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    this.btnSwitch.push(elem);
                });
        }

        updateAllDisplay(monitorNumber) {
            const monitor = this.displaySettings.adapters[0].monitors[monitorNumber];
            SettingsVideo.display.aspect_ratio_x = monitor.native_aspect_ratio.x;
            SettingsVideo.display.aspect_ratio_y = monitor.native_aspect_ratio.y;
            this.originalAspectRatioY = SettingsVideo.display.aspect_ratio_y;
            this.actualAspectRatio = `${SettingsVideo.display.aspect_ratio_x}:${SettingsVideo.display.aspect_ratio_y}`;
            this.modalAspectRatio.setCurrentText(`${monitor.native_aspect_ratio.x}:${monitor.native_aspect_ratio.y} (Native)`);
            SettingsVideo.display.window_width = monitor.native_resolution.x;
            SettingsVideo.display.window_height = monitor.native_resolution.y;
            this.originalWindowHeight = SettingsVideo.display.window_height;
            this.modalResolution.setCurrentText(`${monitor.native_resolution.x}x${monitor.native_resolution.y} (Native)`);
        }

        populatePostProcessing(pp_options, post_processing) {
            post_processing.post_processing_presets.forEach(ppEntry => {
                const entry = engine.translate(ppEntry);      
                pp_options.appendChild(this.createOptionElement(entry, entry, false, false));
            });
        }

        populateMonitors(monitorOptions, parsedVideoSettings) {
            let monitorCount = 0;
            const adapter = parsedVideoSettings.adapters[0];
            adapter.monitors.forEach((monitor, index) => {
                monitorCount++;
                console.log("NUMBER OF MONITORS AVAILABLE IS:", monitorCount);
                const isMain = index === 0;
                monitorOptions.appendChild(this.createOptionElement(monitorCount, monitorCount, false, isMain));
            });
        }

        updateResolution(displayvalue, monitorNumber) {
            const [aspectRatioX, aspectRatioY] = displayvalue.split(':').map(Number);
            const adapter = this.displaySettings.adapters[0];
            const monitor = adapter.monitors[monitorNumber - 1];

            for (const resolutionByAspect of monitor.resolutions_by_ratio) {
                if (resolutionByAspect.aspect_ratio.x === aspectRatioX && resolutionByAspect.aspect_ratio.y === aspectRatioY) {
                    if (Array.isArray(resolutionByAspect.resolutions) && resolutionByAspect.resolutions.length > 0) {
                        //resolutionByAspect.resolutions.find(resolution => resolution.x >= 1280 && resolution.y >= 720);
                        const firstResolution = resolutionByAspect.resolutions.find(resolution => resolution.x >= 1280 && resolution.y >= 720);
                        SettingsVideo.display.window_width = firstResolution.x;
                        SettingsVideo.display.window_height = firstResolution.y;
                        this.originalWindowHeight = SettingsVideo.display.window_height;
                        this.modalResolution.setCurrentText(`${SettingsVideo.display.window_width}x${SettingsVideo.display.window_height}`);
                    }

                }
            }
        }

        clearChildren(modalOption) {
            modalOption.children.forEach(child => {
                if (!child.classList.contains('title')) {
                    modalOption.removeChild(child);
                }
            });
        }

        populateAspectRatios(monitor) {
            const arOptions = document.getElementById("aspectRatioOptions");
            const resolutionsByRatio = monitor.resolutions_by_ratio;
            resolutionsByRatio.forEach(ratioEntry => {

                let acceptedRes = 0;

                ratioEntry.resolutions.forEach(resolution => {
                    if (resolution.x >= 1280 && resolution.y > 720) {
                        acceptedRes++;
                    }
                });

                if (acceptedRes == 0) return;

                const aspectRatio = ratioEntry.aspect_ratio;
                const textContent = `${aspectRatio.x}:${aspectRatio.y}`;
                const isNative = aspectRatio.x === monitor.native_aspect_ratio.x && aspectRatio.y === monitor.native_aspect_ratio.y;

                if (aspectRatio.x < 100 && aspectRatio.y < 100) {
                    arOptions.appendChild(this.createOptionElement(textContent, textContent, isNative));
                }
            });
        }

        updateGraphicsSettings(path, value) {
            if (path.includes("upscaling") ||
                path.includes("motionBlur", "strength") ||
                path.includes("motionBlur", "centralClarity") ||
                path.includes("veil") ||
                path.includes("sharpening") ||
                path.includes("multi_mode") ||
                path.includes("exposureBias")
            ) { return; }

            if (path == "SettingsVideo,graphics,overallGraphics") {
                const videoMap = {
                    "videoSettingsMSAA": ["MSAA_Off", "MSAA_2x", "MSAA_2x", "MSAA_2x", "MSAA_2x"],
                    "videoSettingsFilmicAntialiasing": ["Type_Off", "Type_Off", "Type_Sharp", "Type_Sharp", "Type_Sharp"],
                    "videoSettingsFXAA": ["optionOn", "optionOn", "optionOff", "optionOff", "optionOff"],
                    "videoSettingsAnisotropic": ["AnisotropicFilteringQuality_VeryLow", "AnisotropicFilteringQuality_Low", "AnisotropicFilteringQuality_Medium", "AnisotropicFilteringQuality_High", "AnisotropicFilteringQuality_Ultra"],
                    "videoSettingsTexturePoolSize": ["TexturePoolSize_Low", "TexturePoolSize_Medium", "TexturePoolSize_Medium", "TexturePoolSize_Medium", "TexturePoolSize_High"],
                    "videoSettingsCloudsQuality": ["CloudsQuality_Low", "CloudsQuality_Low", "CloudsQuality_Medium", "CloudsQuality_High", "CloudsQuality_Ultra"],
                    "videoSettingsGrass": ["GrassDensity_Off", "GrassDensity_Low", "GrassDensity_Medium", "GrassDensity_High", "GrassDensity_Ultra"],
                    "videoSettingsGlobalIllumination": ["GlobalIlluminationUpdateFrequency_Medium", "GlobalIlluminationUpdateFrequency_Medium", "GlobalIlluminationUpdateFrequency_Medium", "GlobalIlluminationUpdateFrequency_High", "GlobalIlluminationUpdateFrequency_Ultra"],
                    "videoSettingsVolumetrics": ["VolumetricsQuality_Low", "VolumetricsQuality_Low", "VolumetricsQuality_Medium", "VolumetricsQuality_High", "VolumetricsQuality_High"],
                    "videoSettingsAmbientOcclusion": ["AmbientOcclusionQuality_Off", "AmbientOcclusionQuality_Off", "AmbientOcclusionQuality_Medium", "AmbientOcclusionQuality_High", "AmbientOcclusionQuality_Ultra"],
                    "videoSettingsCarReflection": ["CarReflectionQuality_Low", "CarReflectionQuality_Low", "CarReflectionQuality_Medium", "CarReflectionQuality_High", "CarReflectionQuality_Ultra"],
                    "videoSettingsEnvironmentReflection": ["EnvironmentReflectionQuality_Low", "EnvironmentReflectionQuality_Low", "EnvironmentReflectionQuality_Medium", "EnvironmentReflectionQuality_High", "EnvironmentReflectionQuality_High"],
                    "videoSettingsLevelOfDetail": ["LevelOfDetailQuality_Low", "LevelOfDetailQuality_Low", "LevelOfDetailQuality_Medium", "LevelOfDetailQuality_High", "LevelOfDetailQuality_Ultra"],
                    "videoSettingsVehicleLevelOfDetail": ["VehicleLevelOfDetailQuality_Low", "VehicleLevelOfDetailQuality_Low", "VehicleLevelOfDetailQuality_Medium", "VehicleLevelOfDetailQuality_High", "VehicleLevelOfDetailQuality_Ultra"],
                    "videoSettingsParticles": ["ParticlesQuality_Low", "ParticlesQuality_Low", "ParticlesQuality_Medium", "ParticlesQuality_High", "ParticlesQuality_High"],
                    "videoSettingsShadows": ["ShadowQuality_VeryLow", "ShadowQuality_Low", "ShadowQuality_Medium", "ShadowQuality_High", "ShadowQuality_Ultra"],
                    "videoSettingsScreenSpaceShadows": ["ScreenSpaceShadowQuality_0ff", "ScreenSpaceShadowQuality_HalfRes", "ScreenSpaceShadowQuality_HalfRes", "ScreenSpaceShadowQuality_FullRes", "ScreenSpaceShadowQuality_FullRes"],
                    "videoSettingsDepthOfFieldQuality": ["DepthOfFieldQuality_Low", "DepthOfFieldQuality_Low", "DepthOfFieldQuality_Medium", "DepthOfFieldQuality_High", "DepthOfFieldQuality_Ultra"],
                    "videoSettingsDepthOfField": ["DepthOfFieldQuality_Off", "DepthOfFieldQuality_Low", "DepthOfFieldQuality_Medium", "DepthOfFieldQuality_High", "DepthOfFieldQuality_Ultra"],
                    "videoSettingsMotionBlurQuality": ["MotionBlurQuality_Off", "MotionBlurQuality_Low", "MotionBlurQuality_Medium", "MotionBlurQuality_High", "MotionBlurQuality_Ultra"],
                    "videoSettingsMirrorMode": ["Mirror_Single", "Mirror_Single", "Mirror_Single", "Mirror_Multi", "Mirror_Multi"],
                    "videoSettingsMirrorResolution": ["MirrorResolution_Low", "MirrorResolution_Low", "MirrorResolution_Medium", "MirrorResolution_Medium", "MirrorResolution_High"],
                    "videoSettingsMirrorViewDistance": ["MirrorViewDistance_Low", "MirrorViewDistance_Low", "MirrorViewDistance_Medium", "MirrorViewDistance_High", "MirrorViewDistance_Ultra"],
                    "videoSettingsAlternateRendering": ["optionOn", "optionOn", "optionOn", "optionOn", "optionOn"],
                    "videoSettingsExperimentalStaticLOD": ["optionOff", "optionOff", "optionOff", "optionOff", "optionOff"],
                    "videoSettingsMirrorLODQuality": ["MirrorLevelOfDetailQuality_Low", "MirrorLevelOfDetailQuality_Low", "MirrorLevelOfDetailQuality_Medium", "MirrorLevelOfDetailQuality_High", "MirrorLevelOfDetailQuality_Ultra"],
                    "videoSettingsNumDashDisplays": ["NumDashDisplays_MaxOne", "NumDashDisplays_MaxOne", "NumDashDisplays_MaxTwo", "NumDashDisplays_MaxTwo", "NumDashDisplays_MaxTwo"]
                };

                if (value == "videoOptionCustom") { return; }            const optionMap = {
                    "videoOptionVeryLow": 0,
                    "videoOptionLow": 1,
                    "videoOptionMedium": 2,
                    "videoOptionHigh": 3,
                    "videoOptionUltra": 4
                };

                q(".main-graphics").dataset.value = value;


                qAll("ks-slider[data-setting=graphics]").forEach(
                    elem => {
                        const data = elem.querySelector("[slot=name]").getAttribute("data-l10n-id");
                        const valueArray = videoMap[data];
                        if (valueArray) {
                            const index = optionMap[value] !== undefined ? optionMap[value] : 0;
                            elem.value = valueArray[index];
                        }
                    });

            } else {
                q(".main-graphics").dataset.value = value;
            }
        }

        setupMirrorsVisibility(mirror_mode) {
            const sliders = qAll('ks-slider.show-multi, ks-slider.show-single');
            switch (mirror_mode) {
                case "Mirror_Off":
                    sliders.forEach(slider => {
                        slider.setAttribute('disabled', 'disabled');
                    });
                    break;
                case "Mirror_Single":
                    sliders.forEach(slider => {
                        if (slider.classList.contains('show-multi')) {
                            slider.setAttribute('disabled', 'disabled');
                        } else if (slider.classList.contains('show-single')) {
                            slider.removeAttribute('disabled');
                        }
                    });
                    break;
                case "Mirror_Multi":
                    sliders.forEach(slider => {
                        slider.removeAttribute('disabled');
                    });
                    break;
            }
        }

        updateUpscalingVisibility(path, upscaling_mode) {
            if (!path.includes("upscaling")) { return; }        switch (upscaling_mode) {
                case "Upscaling_None":
                    q("ks-slider.show-dlss").setAttribute("disabled", "disabled");
                    q("ks-slider.show-fsr3").setAttribute("disabled", "disabled");
                    q("ks-slider.fxaa").removeAttribute("disabled");
                    q("ks-slider.show-filmic").removeAttribute("disabled");
                    break;
                case "Upscaling_DLSS":
                    q("ks-slider.show-dlss").removeAttribute("disabled");
                    q("ks-slider.show-fsr3").setAttribute("disabled", "disabled");
                    q("ks-slider.fxaa").setAttribute("disabled", "disabled");
                    q("ks-slider.show-filmic").setAttribute("disabled", "disabled");
                    break;
                case "Upscaling_FSR3":
                    q("ks-slider.show-fsr3").removeAttribute("disabled");
                    q("ks-slider.show-dlss").setAttribute("disabled", "disabled");
                    q("ks-slider.fxaa").setAttribute("disabled", "disabled");
                    q("ks-slider.show-filmic").setAttribute("disabled", "disabled");
                    break;
            }
        }

        updateLevelOfDetailVisibility(path, level_of_detail_mode) {
            if (!path.includes("experimentalStaticLevelOfDetail")) { return; }        switch (level_of_detail_mode) {
                case false:
                    q("ks-slider.static-lod-quality").setAttribute("disabled", "disabled");
                    q("ks-slider.lod").removeAttribute("disabled");
                    break;
                case true:
                    q("ks-slider.lod").setAttribute("disabled", "disabled");
                    q("ks-slider.static-lod-quality").removeAttribute("disabled");
                    break;
            }
        }

        updateShadowVisibility(path, shadow_mode) {
            if (!path.includes("experimentalSimShadow")) { return; }        if (shadow_mode) {
                q("ks-slider.shadow").setAttribute("disabled", "disabled");
                q("ks-slider.sim-shadow").removeAttribute("disabled");
            } else {
                q("ks-slider.sim-shadow").setAttribute("disabled", "disabled");
                q("ks-slider.shadow").removeAttribute("disabled");
            }
        }

        updateMSAA(path) {
            if (!path.includes("dlss_preset") && !path.includes("fsr3_preset") && !path.includes("mode")) { return; }        q(".msaa").value = "MSAA_Off";        
        }

        bindControls() {
            this.windowResizeHandler = engine.on("onResize", () => {
                if (this.loading) return;

                SettingsVideo.display.window_width = window.innerWidth;
                SettingsVideo.display.window_height = window.innerHeight;
                this.originalWindowHeight = window.innerHeight;
                this.actualResolution = `${SettingsVideo.display.window_width}x${SettingsVideo.display.window_height}`;
                this.modalResolution.setCurrentText(this.actualResolution);
                this.is_display = true;
                this.canEnableFullscreen();
                this.save();
            });


            this.sliderFrameLimit.valueFilter = (value_to_filter) => {
                if (value_to_filter == 0) {
                    return engine.translate("optionOff");
                } else return value_to_filter;
            };

            window["merge"] = (x, y) => {
                return x + "x" + y;
            };
            window["mergeAR"] = (x, y) => {
                return x + ":" + y;
            };

            qevAll("ks-slider",
                "onSliderValueChanged", (ev) => {
                    let detail = ev.detail;
                    let detaildata = detail.sender.dataset;
                    if (!this.loading) {
                        const target = detaildata.bindKsvalue ? detaildata.bindKsvalue : detaildata.path;
                        const path = target.replace(/[{}]/g, "").split(".");
                        const sourcevalue = Function(`return window["${path.join('"]["')}"]`)();
                        const value = ksUI$1.sameType(sourcevalue, typeof sourcevalue == "boolean" ? detail.index : detail.value);
                        const type = typeof value;
                        Function(`window["${path.join('"]["')}"]=${type == "string" ? '"' + detail.value + '"' : type == "boolean" ? detail.sender.index == 1 : value}`)();

                        this.updateMSAA(path);
                        this.updateUpscalingVisibility(path, value);
                        this.updateGraphicsSettings(path, value);
                        this.updateLevelOfDetailVisibility(path, value);
                        this.updateShadowVisibility(path, value);
                        this.is_display = path.includes("display") ? true : false;
                        this.setupMirrorsVisibility(SettingsVideo.graphics.mirror.mirror_mode);
                        this.markDirty();
                    }
                }, this);

            qAll("ks-btnbasic[toggle-group=section]").forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        if (state) {
                            if (this.isDirty) {
                                this.pageModal.Show({
                                    type: eModalDialogTypes.Warning,
                                    title: "lblChangesDetected",
                                    message: "msgChangesWarning",
                                    confirm: "btnApply"
                                });
                                this.pageModal.onDiscard = () => {
                                    this.reset();
                                    this.panelModes.dataset.mode = sender.dataset.mode;
                                };
                                this.pageModal.onConfirm = () => {
                                    this.save();
                                    this.panelModes.dataset.mode = sender.dataset.mode;
                                };
                                this.pageModal.onCancel = () => {
                                    if (sender.dataset.mode === "graphics") {
                                        this.btnSwitch[0].toggle(true);
                                    } else {
                                        this.btnSwitch[1].toggle(true);
                                    }
                                };
                            } else {
                                this.panelModes.dataset.mode = sender.dataset.mode;
                            }
                        }

                        if (sender.dataset.mode == "graphics") {
                            q(".graphics").scrollTop = 0;
                        } else {
                            q(".display").scrollTop = 0;
                        }
                    };
                });

            q('ks-slider[data-setting=blur]').valueFilter = (value_to_filter) => {
                const displayedValue = Math.floor((value_to_filter / 3) * 100);
                return displayedValue;
            };

            q('ks-slider[data-setting=sharpening]').valueFilter = (value_to_filter) => {
                const displayedValue = Math.floor((value_to_filter / 2) * 100);
                return displayedValue;
            };

            q('ks-slider[data-setting=blur-quality]').valueFilter = (value_to_filter) => {
                const displayedValue = Math.floor(value_to_filter * 100);
                return displayedValue;
            };

            this.modalPostProcessing.onShow = () => {
                const pp_options = q("#pp-list");
                //pp_options.classList.add("scrollable-vertical");
                // #TODO IM - Check the scrollable container implementation in ksHTMLElement for nested containers

                this.clearChildren(pp_options);
                this.populatePostProcessing(pp_options, this.postProcessingSettings);
            };

            this.modalPostProcessing.onSelected = (event, value, displayvalue) => {
                SettingsVideo.graphics.post_processing_preset = value;
                this.modalPostProcessing.setCurrentText(displayvalue);
                this.markDirty();
            };

            this.modalMonitor.onShow = (e) => {
                const monitorOptions = document.getElementById("monitorOptions");
                this.clearChildren(monitorOptions);
                this.populateMonitors(monitorOptions, this.displaySettings);
            };

            this.modalMonitor.onSelected = (event, value, displayvalue) => {
                this.updateAllDisplay(value - 1);
                SettingsVideo.display.monitor = parseInt(value, 10);
                this.originalMonitor = SettingsVideo.display.monitor;
                this.modalMonitor.setCurrentText(displayvalue);
                this.actualMonitor = value;
                this.is_display = true;
                this.markDirty();
            };

            this.modalAspectRatio.onShow = (e) => {
                const arOptions = document.getElementById("aspectRatioOptions");
                this.clearChildren(arOptions);
                const monitor = this.displaySettings.adapters[0].monitors[this.actualMonitor - 1];
                this.populateAspectRatios(monitor);
            };

            this.modalAspectRatio.onSelected = (event, value, displayvalue) => {
                if (displayvalue != this.actualAspectRatio) this.updateResolution(value, this.actualMonitor);
                const [x, y] = event.target.innerHTML.split(':');
                SettingsVideo.display.aspect_ratio_x = parseInt(x, 10);
                SettingsVideo.display.aspect_ratio_y = parseInt(y, 10);
                this.originalAspectRatioY = SettingsVideo.display.aspect_ratio_y;
                this.modalAspectRatio.setCurrentText(displayvalue);
                this.actualAspectRatio = value;
                this.is_display = true;
                this.markDirty();
            };

            this.modalResolution.onShow = (e) => {
                const resolutionOptions = document.getElementById("resolutionOptions");
                this.clearChildren(resolutionOptions);
                const selectedAspectRatio = this.actualAspectRatio;
                console.log("ACTUAL ASPECT RATIO:", this.actualAspectRatio);
                this.revertDisplayValue = this.actualResolution;
                let selectedAspectRatioX, selectedAspectRatioY;
                const monitor = this.displaySettings.adapters[0].monitors[this.actualMonitor - 1];
                const resolutionsByRatio = monitor.resolutions_by_ratio;
                if (typeof selectedAspectRatio === 'string' && selectedAspectRatio.includes(':')) {
                    [selectedAspectRatioX, selectedAspectRatioY] = selectedAspectRatio.split(':').map(Number);
                }
                resolutionsByRatio.forEach(ratioEntry => {
                    const aspectRatio = ratioEntry.aspect_ratio;
                    if (aspectRatio.x === selectedAspectRatioX && aspectRatio.y === selectedAspectRatioY) {
                        ratioEntry.resolutions.forEach(resolution => {
                            if (resolution.x >= 1280 && resolution.y >= 720) {
                                const isNativeResolution = resolution.x === monitor.native_resolution.x && resolution.y === monitor.native_resolution.y;
                                const textContent = `${resolution.x}x${resolution.y}`;
                                resolutionOptions.appendChild(this.createOptionElement(textContent, textContent, isNativeResolution));
                            }
                        });
                    }
                });
            };

            this.modalResolution.onSelected = (event, value, displayvalue) => {
                let [x, y] = event.target.innerHTML.split('x');
                y = y.replace(/\(Native\)/g, "");
                console.log("ACTUAL RESOLUTION IS:", this.actualResolution);
                this.actualResolution = this.actualResolution.replace(/\(Native\)/g, "");
                if (this.actualResolution == `${x}x${y}`) { return }            ksUI$1.waitForFrames(() => {
                    SettingsVideo.display.window_width = parseInt(x, 10);
                    SettingsVideo.display.window_height = parseInt(y, 10);
                    this.originalWindowHeight = SettingsVideo.display.window_height;
                    this.is_display = true;
                    this.save();
                    this.checkForResolutionChange(x, y, displayvalue);
                }, 1);
            };
        }

    }

    ksUI$1.registerModule('ks-page-settings-video', SettingsPageVideo);

    var template$k = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic class=\"back focusable\" id=\"btnBack\" data-sn-right=\"#btnApply\" data-sn-left=\"#btnManagePresets\"></ks-btnbasic>\r\n            <ks-btnbasic class=\"apply focusable\" id=\"btnApply\" disabled=\"disabled\">\r\n                <div slot=\"name\" data-l10n-id=\"btnApply\">Apply</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"cancel focusable\" id=\"btnCancel\" data-sn-right=\"#btnManagePresets\" disabled=\"disabled\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCancel\">Cancel</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n\r\n        <div class=\"group center\"></div>\r\n\r\n        <div class=\"group end\">\r\n            <ks-btnbasic class=\"presets focusable\" id=\"btnManagePresets\" data-sn-left=\"#btnCancel\" data-sn-right=\"#btnBack\">\r\n                <div slot=\"name\" data-l10n-id=\"btnManagePresets\">Manage Presets</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\">\r\n            <div data-l10n-id=\"headerSettings\">Settings</div>\r\n            <div>/</div>\r\n            <div data-l10n-id=\"headerControls\">Controls</div>\r\n        </div>\r\n    </ks-pageheader>\r\n\r\n    <div class=\"submode-body is-flex-row flex-1\">\r\n        <div class=\"overview is-flex-column width-20\">\r\n            <div id=\"panelSearch\">\r\n                <div data-l10n-id=\"lblSearchByAction\"></div>\r\n\r\n                <ks-textinput id=\"inputSearch\" class=\"focusable\"></ks-textinput>\r\n            </div>\r\n\r\n            <div id=\"panelActiveControls\" class=\"loading\">\r\n                <div class=\"title\" data-l10n-id=\"lblActiveControls\"></div>\r\n                <div class=\"steering\" data-bind-class-toggle=\"bound:{{DominantDevices}}.steering.guid != undefined\">\r\n                    <div data-l10n-id=\"binding-steer\"></div>\r\n                    <div class=\"device-name\" data-bind-value=\"{{DominantDevices}}.steering.name\"></div>\r\n                    <div class=\"bar from-center\"></div>\r\n                </div>\r\n                <div class=\"throttle\" data-bind-class-toggle=\"bound:{{DominantDevices}}.throttle.guid != undefined\">\r\n                    <div data-l10n-id=\"binding-gas\"></div>\r\n                    <div class=\"device-name\" data-bind-value=\"{{DominantDevices}}.throttle.name\"></div>\r\n                    <div class=\"bar\"></div>\r\n                </div>\r\n                <div class=\"brakes\" data-bind-class-toggle=\"bound:{{DominantDevices}}.brakes.guid != undefined\">\r\n                    <div data-l10n-id=\"binding-brake\"></div>\r\n                    <div class=\"device-name\" data-bind-value=\"{{DominantDevices}}.brakes.name\"></div>\r\n                    <div class=\"bar\"></div>\r\n                </div>\r\n                <div class=\"clutch\" data-bind-class-toggle=\"bound:{{DominantDevices}}.clutch.guid != undefined\">\r\n                    <div data-l10n-id=\"binding-clutch\"></div>\r\n                    <div class=\"device-name\" data-bind-value=\"{{DominantDevices}}.clutch.name\"></div>\r\n                    <div class=\"bar\"></div>\r\n                </div>\r\n                <div class=\"handbrake\" data-bind-class-toggle=\"bound:{{DominantDevices}}.handbrake.guid != undefined\">\r\n                    <div data-l10n-id=\"binding-handbrake\"></div>\r\n                    <div class=\"device-name\" data-bind-value=\"{{DominantDevices}}.handbrake.name\"></div>\r\n                    <div class=\"bar\"></div>\r\n                </div>\r\n\r\n            </div>\r\n\r\n        </div>\r\n\r\n        <div class=\"config-panel is-flex-column flex-1\">\r\n            <div class=\"devices is-flex-row scrollable-horizontal\">\r\n                <div class=\"scrollable-content\">\r\n                    <ks-btnbasic class=\"device-keyboard selected focusable\" data-value=\"keyboard\" toggle-group=\"devices\" toggle>\r\n                        <div slot=\"name\" data-l10n-id=\"lblKeyboard&Mouse\">Keyboard & Mouse</div>\r\n                    </ks-btnbasic>\r\n\r\n                    <ks-btnbasic class=\"focusable\" data-bind-for=\"index, iter: {{InputConfiguration.settings.input_devices.input_controllers}}\" data-bind-class=\"'device-'+{{iter.controller.product_guid}}.toLowerCase()\" data-bind-class-toggle=\"disconnected:{{InputConfiguration}}.connected_guids.indexOf({{iter.controller.instance_guid}}) == -1\" data-bind-ksvalue=\"{{iter.controller.instance_guid}}\" toggle-group=\"devices\" toggle>\r\n                        <div slot=\"name\" data-bind-value=\"{{iter.controller.product_name}}\"></div>\r\n                    </ks-btnbasic>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"groups is-flex-row\">\r\n                <div class=\"togglers is-flex-row width-50\">\r\n                    <ks-btnbasic class=\"group focusable\" data-bind-for=\"index, iter: {{InputConfigurationGroups.asArray}}\" data-bind-class=\"'group-'+{{iter.name}}.toLowerCase()\" data-bind-l10n-id=\"APF()?.evaluateGroup({{iter.name}})\" data-bind-ksvalue=\"{{iter.name}}\" toggle-group=\"controlgroup\" toggle>\r\n                        <div slot=\"name\" data-bind-value=\"{{iter.name}}\"></div>\r\n                    </ks-btnbasic>\r\n                    <ks-btnbasic class=\"btnShifts focusable\" data-mode=\"shifts\" toggle-group=\"controlgroup\" toggle>\r\n                        <div slot=\"name\" data-l10n-id=\"btnShiftButtons\"></div>\r\n                    </ks-btnbasic>\r\n\r\n                </div>\r\n                <div class=\"extras is-flex-row\">\r\n                    <ks-btnbasic class=\"btnProperties focusable\" data-mode=\"param\" toggle-group=\"sidepanel\" toggle disabled=\"disabled\">\r\n                        <div slot=\"name\" data-l10n-id=\"btnProperties\"></div>\r\n                    </ks-btnbasic>\r\n\r\n                    <ks-btnbasic class=\"btnSettings focusable\" data-mode=\"settings\" toggle-group=\"sidepanel\" toggle>\r\n                        <div slot=\"name\" data-l10n-id=\"btnSettings\"></div>\r\n                    </ks-btnbasic>\r\n\r\n                    <ks-btnbasic class=\"btnTrackIR focusable\" data-mode=\"settings\" toggle-group=\"sidepanel\" toggle>\r\n                        <div slot=\"name\" data-l10n-id=\"btnTrackIR\"></div>\r\n                    </ks-btnbasic>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"is-flex-row flex-1\">\r\n                <div id=\"panelMain\" data-mode=\"definitions\" class=\"is-flex-row width-50\">\r\n                    <div class=\"panelDefinitions is-flex-column scrollable-element scrollable-vertical\">\r\n\r\n                    </div>\r\n                    <div class=\"panelShifts is-flex-column flex-1\" data-mode=\"keyboard\">\r\n                        <div class=\"panelShiftsKeyboard is-flex-column justify-content-center\">\r\n                            <div class=\"title\" data-l10n-id=\"lblAllowedModifiers\"></div>\r\n                            <ks-btnbasic class=\"modifierShift focusable\" data-mode=\"shift\" data-bind-class-toggle=\"selected:{{InputConfiguration}}.settings.keyboard.allowed_keyboard_modifiers.indexOf(16) > -1\" toggle>\r\n                                <div slot=\"name\" data-l10n-id=\"keyShift\"></div>\r\n                            </ks-btnbasic>\r\n                            <ks-btnbasic class=\"modifierCtrl focusable\" data-mode=\"ctrl\" data-bind-class-toggle=\"selected:{{InputConfiguration}}.settings.keyboard.allowed_keyboard_modifiers.indexOf(17) > -1\" toggle>\r\n                                <div slot=\"name\" data-l10n-id=\"keyControl\"></div>\r\n                            </ks-btnbasic>\r\n                            <ks-btnbasic class=\"modifierAlt focusable\" data-mode=\"alt\" data-bind-class-toggle=\"selected:{{InputConfiguration}}.settings.keyboard.allowed_keyboard_modifiers.indexOf(18) > -1\" toggle>\r\n                                <div slot=\"name\" data-l10n-id=\"keyAlt\"></div>\r\n                            </ks-btnbasic>\r\n                        </div>\r\n\r\n                        <div class=\"panelShiftsDevice\">\r\n                            <ks-btnbasic id=\"btnAddModifier\" class=\"focusable\">\r\n                                <div slot=\"name\" data-l10n-id=\"btnAddModifier\"></div>\r\n                            </ks-btnbasic>\r\n\r\n                            <div class=\"shift-list\">\r\n                            </div>\r\n                        </div>\r\n\r\n                    </div>\r\n                </div>\r\n\r\n                <div id=\"panelExtras\" class=\"is-flex-column width-50\" data-mode=\"help\">\r\n                    <div class=\"panelHelp\">\r\n\r\n                    </div>\r\n                    <div class=\"panelProperties\">\r\n                        <div class=\"properties is-key is-command is-flex-column\">\r\n                            <div class=\"title\" data-l10n-id=\"lblTriggerOn\">\r\n                            </div>\r\n                            <div class=\"modes modes-key modes-command is-flex justify-space-around\">\r\n                                <ks-btnbasic class=\"trigger-press focusable\" data-mode=\"press\" toggle-group=\"keymode\" toggle>\r\n                                    <div slot=\"name\" data-l10n-id=\"btnOnPress\"></div>\r\n                                </ks-btnbasic>\r\n                                <ks-btnbasic class=\"trigger-release focusable\" data-mode=\"release\" toggle-group=\"keymode\" toggle>\r\n                                    <div slot=\"name\" data-l10n-id=\"btnOnRelease\"></div>\r\n                                </ks-btnbasic>\r\n                                <ks-btnbasic class=\"trigger-hold focusable\" data-mode=\"hold\" toggle-group=\"keymode\" toggle>\r\n                                    <div slot=\"name\" data-l10n-id=\"btnOnHold\"></div>\r\n                                </ks-btnbasic>\r\n                                <ks-btnbasic class=\"trigger-constant focusable\" data-mode=\"constant\" toggle-group=\"keymode\" toggle>\r\n                                    <div slot=\"name\" data-l10n-id=\"btnConstant\"></div>\r\n                                </ks-btnbasic>\r\n                                <ks-btnbasic class=\"trigger-repeat focusable\" data-mode=\"repeat\" toggle-group=\"keymode\" toggle>\r\n                                    <div slot=\"name\" data-l10n-id=\"btnRepeatOnHold\"></div>\r\n                                </ks-btnbasic>\r\n                            </div>\r\n\r\n                            <ks-btnbasic id=\"btnRequiresShift\" class=\"focusable\" toggle>\r\n                                <div slot=\"name\" data-l10n-id=\"btnRequiresShift\"></div>\r\n                            </ks-btnbasic>\r\n\r\n                            <ks-slider class=\"sliderTriggerTime focusable\" step=\"25\" min=\"50\" value=\"50\" max=\"5000\">\r\n                                <div class=\"labelTriggerTime\" slot=\"name\">Trigger After</div>\r\n                                <div slot=\"unit\">msec</div>\r\n                            </ks-slider>\r\n\r\n                        </div>\r\n\r\n                        <div class=\"properties is-axis is-flex-column\">\r\n                            <div class=\"is-flex-row flex-1 justify-content-center axis-options\">\r\n                                <ks-btnbasic id=\"btnIsInverted\" class=\"axis-settings focusable\" data-setting=\"is_inverted\" toggle>\r\n                                    <div slot=\"name\" data-l10n-id=\"btnIsInverted\"></div>\r\n                                </ks-btnbasic>\r\n\r\n                                <ks-btnbasic id=\"btnIsSlider\" class=\"axis-settings focusable\" data-setting=\"is_slider\" toggle>\r\n                                    <div slot=\"name\" data-l10n-id=\"btnIsSlider\"></div>\r\n                                </ks-btnbasic>\r\n\r\n                            </div>\r\n\r\n                            <div>\r\n                                <ks-slider class=\"focusable\" min=\"0\" max=\"100\" step=\"1\" value=\"0\" data-setting=\"deadzone\">\r\n                                    <div slot=\"name\" data-l10n-id=\"controlsDeadzone\"></div>\r\n                                    <div slot=\"unit\">%</div>\r\n                                </ks-slider>\r\n                                <ks-slider class=\"focusable\" min=\"0\" max=\"100\" step=\"1\" value=\"0\" data-setting=\"saturation_x\">\r\n                                    <div slot=\"name\" data-l10n-id=\"controlsSaturationX\"></div>\r\n                                    <div slot=\"unit\">%</div>\r\n                                </ks-slider>\r\n\r\n                                <ks-slider class=\"focusable\" min=\"0\" max=\"100\" step=\"1\" value=\"0\" data-setting=\"saturation_y\">\r\n                                    <div slot=\"name\" data-l10n-id=\"controlsSaturationY\"></div>\r\n                                    <div slot=\"unit\">%</div>\r\n                                </ks-slider>\r\n\r\n                                <ks-slider class=\"focusable\" min=\"-100\" max=\"100\" step=\"1\" value=\"0\" data-setting=\"curvature\">\r\n                                    <div slot=\"name\" data-l10n-id=\"controlsCurvature\"></div>\r\n                                    <div slot=\"unit\">%</div>\r\n                                </ks-slider>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"is-flex justify-content-center\">\r\n                            <ks-btnbasic id=\"btnRebind\" class=\"focusable\" disabled=\"disabled\">\r\n                                <div slot=\"name\" data-l10n-id=\"btnRebind\"></div>\r\n                            </ks-btnbasic>\r\n\r\n                            <ks-btnbasic id=\"btnDelBinding\" class=\"focusable\">\r\n                                <div slot=\"name\" data-l10n-id=\"btnClearBinding\"></div>\r\n                            </ks-btnbasic>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"panelSettings scrollable-vertical is-flex-column\">                        \r\n                        <div class=\"scrollable-content\">\r\n                            <div class=\"label header\" data-l10n-id=\"lblControls\">CONTROLS</div>\r\n                            <ks-slider class=\"focusable\" min=\"0\" max=\"1500\" step=\"10\" data-setting=\"steer_lock\" data-tooltip=\"tooltipSteerLock\" data-bind-ksvalue=\"Math.round({{InputConfiguration}}.settings.settings.device_settings.steer_lock)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsSteerLock\"></div>\r\n                                <div slot=\"unit\">&deg;</div>\r\n                            </ks-slider>\r\n    \r\n                            <div class=\"tip\" data-l10n-id=\"controlsSteerLockTip\"></div>\r\n                            <div class=\"horizontal-spacer\"></div>\r\n    \r\n                            <ks-slider class=\"focusable\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"ffb_gain\" data-tooltip=\"tooltipFfbGain\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.device_settings.ffb_gain}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsFfbGain\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                        \r\n                            <ks-slider class=\"focusable\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"dynamic_damping\" data-tooltip=\"tooltipDynamicDamping\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.device_settings.dynamic_damping}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsDynamicDamping\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            <ks-slider class=\"focusable\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"min_damper\" data-tooltip=\"tooltipMinDamper\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.device_settings.min_damper}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsMinDamper\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            <ks-slider class=\"focusable\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"damper_gain\" data-tooltip=\"tooltipDamperGain\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.device_settings.damper_gain}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsDamperGain\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            <ks-slider class=\"focusable\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"true_force_gain\" data-tooltip=\"tooltipTrueForceGain\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.device_settings.true_force_gain}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsTrueForceGain\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            <ks-slider class=\"toggle focusable softlock\" data-bind-ksvalue=\"{{InputConfiguration.settings.settings.device_settings.soft_lock}}\" values='[\"optionOff\",\"optionOn\"]' data-setting=\"soft_lock\" data-tooltip=\"tooltipSoftLock\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsSoftLock\">Soft Lock</div>\r\n                                <div slot=\"unit\"></div>\r\n                            </ks-slider>\r\n                            <ks-slider class=\"focusable hide\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"minimum_ffb\" data-tooltip=\"tooltipMinimumFfb\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.device_settings.minimum_ffb}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsMinimumFfb\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n\r\n                        <div class=\"label header\" data-l10n-id=\"lblFFBEnhancements\">FFB ENHANCEMENTS</div>        \r\n                            <ks-slider class=\"focusable ffb\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"curbs_gain\" data-tooltip=\"tooltipCurbsGain\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.ffb_enhancements.curbs_gain}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsCurbsGain\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            <ks-slider class=\"focusable hide\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"road_effects\" data-tooltip=\"tooltipRoadEffects\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.device_settings.road_effects}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsRoadEffects\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            <ks-slider class=\"focusable ffb\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"gforce_gain\" data-tooltip=\"tooltipGForceGain\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.ffb_enhancements.gforce_gain}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsGForceGain\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            <ks-slider class=\"focusable ffb\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"slips_gain\" data-tooltip=\"tooltipSlipsGain\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.ffb_enhancements.slips_gain}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsSlipsGain\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            <ks-slider class=\"focusable ffb\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"abs_gain\" data-tooltip=\"tooltipAbsGain\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.ffb_enhancements.abs_gain}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsAbsGain\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            \r\n                            <div class=\"label header\" data-l10n-id=\"lblGamepadSettings\">GAMEPAD SETTINGS</div>\r\n                            \r\n                            <ks-slider class=\"focusable controller enum\" data-bind-ksvalue=\"{{InputConfiguration.settings.settings.device_settings.joypad_steer_assist_mode}}\" values='[\"Direct\",\"Assisted\", \"Smart\"]' data-setting=\"joypad_steer_assist_mode\" disabled-data-tooltip=\"tooltipSteerAssistWeight\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsSteerAssistWeight\"></div>\r\n                            </ks-slider>                        \r\n                            <ks-slider class=\"focusable controller\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"speed_sensitivity\" data-tooltip=\"tooltipSpeedSensitivity\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.device_settings.speed_sensitivity}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsSpeedSensitivity\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>                    \r\n                            <ks-slider class=\"focusable controller\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"steer_filter\" data-tooltip=\"tooltipSteerFilter\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.device_settings.steer_filter}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsSteerFilter\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>                \r\n                            <ks-slider class=\"focusable hide\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"limit_oversteer\" data-tooltip=\"tooltipLimitOversteer\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.device_settings.limit_oversteer}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsLimitOversteer\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            <ks-slider class=\"focusable controller\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"vibrations\" data-tooltip=\"tooltipVibrations\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.device_settings.vibrations}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsGamepadVibrations\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            <ks-slider class=\"focusable ffb\" min=\"0\" max=\"100\" step=\"1\" data-setting=\"rumble_gain\" data-tooltip=\"tooltipRumbleGain\" data-bind-ksvalue=\"Math.round({{InputConfiguration.settings.settings.ffb_enhancements.rumble_gain}} * 100)\">\r\n                                <div slot=\"name\" data-l10n-id=\"controlsRumbleGain\"></div>\r\n                                <div slot=\"unit\">%</div>\r\n                            </ks-slider>\r\n                            <!-- <ks-slider\r\n                                class=\"oneline toggle focusable\"\r\n                                data-bind-ksvalue=\"{{InputConfiguration.settings.settings.device_settings.use_manufacturers_extras}}\"\r\n                                values='[\"optionOff\",\"optionOn\"]'\r\n                                data-setting=\"use_manufacturers_extras\">\r\n                                <div slot=\"name\" data-l10n-id=\"manufacturerExtra\">Manufacturer Extra</div>\r\n                                <div slot=\"unit\"></div>\r\n                            </ks-slider> -->\r\n                        </div>\r\n                        </div>\r\n                    <div class=\"panelTrackIR\">\r\n                        <!-- trackir -->\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n        </div>\r\n\r\n\r\n    </div>\r\n</div>";

    var template$j = "<div class=\"component-body\">\r\n    <div class=\"barAxisIndicator\">\r\n        <div class=\"bar\"></div>\r\n        <div class=\"middle\"></div>\r\n        <div class=\"raw\"></div>\r\n    </div>\r\n    <div class=\"main\">\r\n        <div class=\"is-axis-label\" data-l10n-id=\"lblAxis\"></div>\r\n        \r\n        <div class=\"panelName\"></div>\r\n        <div class=\"panelKeycode\"></div>\r\n        <div class=\"panelModifiers\"></div>\r\n        <div class=\"panelExisting\"></div>\r\n    </div>\r\n        \r\n    <div class=\"controls\"></div>\r\n    \r\n</div>";

    class InputBindingElement extends KsHTMLElement {
        /** @typedef {import('../settings-controls').default} SettingsControls */
        /** @typedef {import('../settings-controls').ControlDefinitionLoc} ControlDefinitionLoc */

        selected = false;

        readOnly = false;

        /**@type {ControlDefinitionLoc} */
        bindingId;


        /** @type { SettingsControls } */
        parentPage;

        messages = {};

        onPressBound;

        barAxisIndicator;
        barAxisIndicatorProgress;

        /** @type HTMLDivElement */
        panelName;

        /** @type HTMLDivElement */
        panelExisting;

        /** @type HTMLDivElement */
        panelKeycode;
        /** @type HTMLDivElement */
        panelModifiers;

        /** @type HTMLDivElement */
        //btnDel;

        /** @typedef {import('../settings-controls').ControlDefinition} ControlDefinition */
        /** @returns {ControlDefinition} */
        get ControlDefinition() {
            return this._controldefinition;
        }

        /** @param {ControlDefinition} value */
        set ControlDefinition(value) {
            this._controldefinition = value;

            this.setAttribute("action_number", value.number);
            this.setAttribute("action_payload", value.payload);
        }

        /** @type ControlDefinition */
        _controldefinition;

        /** @type String */
        ControlDefinitionGroup = "";

        _controlbinding;

        get ControlBinding() {
            return this._controlbinding;
        }

        set ControlBinding(value) {
            this._controlbinding = value;

            if (value == undefined) return;
            this.setAttribute("axis_name", value.input);
        }

        get inputName() {
            let name = this.ControlDefinition.input.replace("_UI_", "_" + this.ControlDefinitionGroup + "_").split(" ").join("");
            return name;
        }

        get isShift() {
            return this.classList.contains("is-shift");
        }


        get isAxis() {
            return this.classList.contains("is-axis");
        }

        constructor() {
            super();
            this.template = template$j;
            this.delayedInit = true;

            this.onPressedBound = () => {
                //this.select();
            };

            if (!window["inputBindingFilters"]) {
                window["inputBindingFilters"] = this.filters;
            }

        }

        filters = {

        }

        select() {

        }

        showDelConfirmation(ev) {

            rootModal().Show({
                title: "lblAreYouSure",
                message: "msgClearBindingFor",
                extraCssClass: "controls-delete-confirmation",
                buttons: 0x101,
                msgVariables: { target_binding: this.panelName.innerHTML }
            });

        }

        bindControls() {
            //this.btnDel.addEventListener("click", (ev) => this.showDelConfirmation(ev));
            this.addEventListener("click", (ev) => this.toggleDetection(ev));
            this.addEventListener("sn:enter-down", (ev) => this.toggleDetection(ev));
            //this.btnDel.addEventListener("click", (ev) => this.showDelConfirmation(ev));
        }

        hasBinding() {
            return this.classList.contains("bound");
        }

        clearSelectedSiblings() {
            qAll("ks-inputbinding", this.parentPage).forEach(elem => {
                if (elem != this) {
                    elem.classList.remove("selected");
                }
            });
        }

        highlight() {
            if (!this.classList.contains("highlight") && this.hasBinding()) {
                this.classList.add("highlight");
                setTimeout(() => this.classList.remove("highlight"), 150);
            }
        }

        axisActivity(value, fromcenter) {

            //console.log(value);

            const positive = value >= 0;
            this.barAxisIndicator.classList.toggle("from-center", fromcenter);

            if (fromcenter) {
                this.barAxisIndicator.classList.toggle("positive", positive);
                const progress = ksUI$1.range(Math.abs(value), 0, 1, 0, 50);
                this.barAxisIndicatorProgress.style.width = `${progress}%`;

            } else {
                const progress = ksUI$1.range(value, 0, 1, 0, 100);
                this.barAxisIndicatorProgress.style.width = `${progress}%`;
            }

        }

        toggleDetection(ev) {

            if (!this.hasBinding()) {
                if (this.classList.contains("armed")) {
                    this.disarmDetection();
                } else {
                    this.armDetection();
                }
            } else {
                this.clearSelectedSiblings();
                let is_selected = this.classList.toggle("selected");
                console.log("toggleDetection showproperties", is_selected);
                if (is_selected)
                    this.parentPage.showProperties(this.ControlDefinition, this.ControlBinding);
                else
                    this.parentPage.hideProperties();
            }
        }

        armDetection() {
            if (this.readOnly) return;
            this.clearSelectedSiblings();
            this.classList.add("armed");

            //$.waitForFrames(() => {
            this.parentPage.addBinding(this.ControlDefinition,
                () => {
                    this.populateBinding();
                    this.disarmDetection();
                },
                this.isShift);
            //}, 3);

        }

        disarmDetection() {
            this.classList.remove("armed");
        }

        onSelected(sender, id) { // eslint-disable-line no-unused-vars
            // console.log("Selected server id", id);
        }

        onRemovedFromDOM() {

        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.parentPage = q("ks-page-settings-controls");
            this.selected = this.classList.contains("selected");

            this.mapElementByClass("barAxisIndicator");
            this.barAxisIndicatorProgress = q(".bar", this.barAxisIndicator);


            this.mapElementByClass("panelName");
            this.mapElementByClass("panelExisting");
            this.mapElementByClass("panelKeycode");
            this.mapElementByClass("panelModifiers");
            //this.mapElementByClass("btnDel");

            this.populateControlDefinition();
            this.populateBinding();

            this.classList.add("focusable");
        }

        populateControlDefinition() {
            if (!this.ControlDefinition) return;
            this.classList.add(this.ControlDefinition.is_axis ? "is-axis" : "is-button");
            this.bindingId = this.parentPage.getControlDefinitionLocId(this.ControlDefinition);
            this.classList.add(this.bindingId.id, "binding-" + this.ControlDefinition.number);
            this.panelName.textContent = this.parentPage.getTranslatedControlDefinition(this.bindingId);
            this.dataset.locName = this.panelName.textContent;
            if(!this.ControlDefinition.is_axis) {
                this.barAxisIndicator.remove();
            }
        }

        populateBinding() {

            let binding = this.parentPage.getActiveBinding(this.ControlDefinition.number, this.ControlDefinition.payload, this.ControlDefinition.is_axis);

            // console.log("populateBinding", this.ControlDefinition.name, this.ControlDefinition.number, this.ControlDefinition.payload, this.ControlDefinition.is_axis, (binding) ? binding.__Type : "unbound");

            this.ControlBinding = binding;

            this.panelKeycode.innerHTML = "";
            this.panelModifiers.innerHTML = "";

            if (binding) {

                if (binding.__Type == "KeyboardCommand" && this.ControlDefinition.is_axis) {
                    console.warn("KeyboardCommand in axis binding");

                    return;
                }

                ({

                    [BindingType.InputDeviceCommand]: () => {
                        let label = "";
                        if (binding.index >= 100000) {
                            let str = String(binding.index);
                            let index = str.substring(0, 1);
                            let direction = Number(str.substr(-5));
                            //console.log(direction);
                            let mappedvalue = ["buttonPOV", POVDirections[direction]].join("");
                            this.panelExisting.dataset.key = mappedvalue.toLowerCase();
                            label = engine.translate(mappedvalue).replace("{0}", index);

                        } else {
                            label = binding.index;
                        }
                        //ksUI.iterate(binding);
                        this.classList.toggle("has-modifiers", binding.require_shift);
                        this.panelModifiers.innerHTML = binding.require_shift ? "SHIFT" : "";
                        this.panelExisting.innerHTML = label;

                    },

                    [BindingType.InputDeviceAxis]: () => {
                        this.panelExisting.innerHTML = binding.index;
                    },

                    [BindingType.KeyboardCommand]: () => {
                        const key = ksUI$1.getKeyFromKeyCode(binding.key);
                        this.panelExisting.innerHTML = key.text.toUpperCase();
                        this.panelKeycode.innerHTML = binding.key;
                        if (key.mappedvalue) {
                            this.panelExisting.dataset.key = key.mappedvalue.toLowerCase();
                        }
                        this.panelModifiers.innerHTML = "";
                        this.classList.toggle("has-modifiers", binding.required_modifiers.length > 0);
                        if (binding.required_modifiers.length > 0) {
                            binding.required_modifiers.forEach((modifier) => {
                                const modifier_tag = document.createElement("div");
                                modifier_tag.innerHTML = ksUI$1.getKeyFromKeyCode(modifier).text.toUpperCase();
                                this.panelModifiers.appendChild(modifier_tag);
                            });

                        }
                    }

                }[binding.__Type])?.();

                this.classList.add("bound");
                // this.panelExisting.innerHTML = binding.__Type;
                //binding.
            } else {
                this.classList.remove("bound");
                this.panelExisting.innerHTML = "";
            }
        }

    }

    ksUI$1.registerModule('ks-inputbinding', InputBindingElement);

    class InputDeviceAxisSettings {
        __Type = "InputDeviceAxisSettings";
        curvature = 0;
        deadzone = 0;
        deprecated_use_curve = false;
        is_inverted = false;
        is_slider = false;
        saturation_x = 0;
        saturation_y = 0;
    }

    class SettingsControls extends KsHTMLElement {

        /** @type MessageHandler */
        Client;

        /** @type Btnbasic */
        btnBack;
        /** @type Btnbasic */
        btnApply;
        /** @type Btnbasic */
        btnCancel;
        /** @type Btnbasic */
        btnPresets;
        /** @type Btnbasic */
        btnSettings;
        /** @type Btnbasic */
        btnProperties;
        /** @type Btnbasic */
        btnTrackIR;
        /** @type Btnbasic */
        btnShifts;
        /** @type Btnbasic */
        btnDelBinding;
        /** @type Btnbasic */
        btnIsSlider;
        /** @type Btnbasic */
        btnIsInverted;
        /** @type Btnbasic */
        btnRequiresShift;
        /** @type Btnbasic */
        btnAddModifier

        /** @type KsSlider */
        sliderTriggerTime;

        /** @type HTMLDivElement */
        panelDefinitions;
        /** @type HTMLDivElement */
        panelShifts;
        /** @type HTMLDivElement */
        panelShiftsKeyboard;
        /** @type HTMLDivElement */
        panelShiftsDevice;

        /** @type HTMLDivElement */
        panelExtras;
        /** @type HTMLDivElement */
        panelProperties;
        /** @type HTMLDivElement */
        panelSettings;
        /** @type HTMLDivElement */
        panelTrackIR;
        /** @type HTMLDivElement */
        panelActiveControls;

        /** @type HTMLDivElement */
        barSteering;
        /** @type HTMLDivElement */
        barThrottle;
        /** @type HTMLDivElement */
        barBrakes;
        /** @type HTMLDivElement */
        barClutch;
        /** @type HTMLDivElement */
        barHandbrake;

        /** @type TextInput */
        inputSearch;



        /** @type HTMLDivElement */
        panelDevices;
        /** @type HTMLDivElement */
        panelGroups;
        /** @type HTMLDivElement */
        panelMain;

        isDirty = false;

        engineActionHandle;
        engineAxisHandle;

        // groups = { asArray: []};
        currentSettings = {};
        connectedGuids = [];

        lastResponse = {};

        activeDevice = "keyboard";
        activeDefinitionGroup = 0;

        filters = {
            evaluateGroup: (group_name) => {
                const show = ["Car", "UI", "Camera", "Showroom"].indexOf(group_name) > -1;
                if (show) return `controlGroup_${group_name}`;
                return "";
            },
            getActiveGroup: (arr) => {
                return arr.asArray[AP().activeDefinitionGroup].definitions;
            },

            getCurrentBinding: (number) => {

                return " " + number;
            }
        }

        constructor() {
            super();
            this.template = template$k;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this._bindScrollableEvents = true;
        }

        getActiveDeviceGuid() {
            return this.activeDevice == "keyboard" ? "" : this.activeDevice;
        }

        save(callback) {
            this.Client.request("Apply", (data) => {
                ({
                    [eCommandResponse.OK]: () => {
                        this.clearDirty();
                        if (callback)
                            callback();
                    },
                    [eCommandResponse.Failed]: () => {
                        console.error("Error enabling InputConfiguration");
                    }
                }[data.response])();
            });
        }

        markDirty() {
            this.isDirty = true;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.removeAttribute("disabled");
            });
        }

        clearDirty() {
            this.isDirty = false;
            [this.btnApply, this.btnCancel].map(btn => {
                if (btn)
                    btn.setAttribute("disabled", true);
            });
            this.btnBack.focus();
            waitForFrames(() => {
                waitForFrames(() => {
                    this.setupNavigation();
                });
            }, 3);

        }

        page(is_enter) {
            console.log(this.tagName, "page", is_enter);
            this.Client.request("Page", { is_enter: is_enter }, (data) => {
                ({
                    [eCommandResponse.OK]: () => {
                        if (is_enter) {
                            console.log("Enabled InputConfiguration");

                            this.Client.request("AxiiListenerMode", {
                                mode: "UIAxiiListenerMode_InputControllerAxii"
                            });


                        } else {
                            console.log("Disabled InputConfiguration");

                            this.Client.request("AxiiListenerMode", {
                                mode: "UIAxiiListenerMode_None"
                            });

                            //this.refresh();
                            //$.waitForFrames(() => this.getGroups(), 1);
                        }
                    },
                    [eCommandResponse.Failed]: () => {
                        console.error("Error enabling InputConfiguration");
                    }
                }[data.response])();
            });
        }

        listen(should_listen) {
            this.Client.requestNoResponse("ListeningMode", { enable: should_listen });
        }

        getConnectedControllerSettings() {
            var output = { keyboard: {} };
            for (const entry of this.currentSettings.input_devices.input_controllers) {
                if (this.connectedGuids.includes(entry.controller.instance_guid)) {

                    output[entry.controller.instance_guid] = entry;
                    output[entry.controller.instance_guid].name = entry.controller.product_name;

                    // output.push({
                    //     guid: entry.controller.instance_guid,
                    //     name: entry.controller.product_name,
                    //     settings: entry
                    // });
                }
            }

            output.keyboard = this.currentSettings.keyboard;
            //output.push({ name: "keyboard", settings: this.currentSettings.keyboard });
            return output;

        }

        updateDominantDevices() {
            const output = {
                steering: this.getDominantBinding(0),
                throttle: this.getDominantBinding(1),
                brakes: this.getDominantBinding(2),
                clutch: this.getDominantBinding(3),
                handbrake: this.getDominantBinding(4)
            };

            this.assignModel(output, "DominantDevices");
            this.panelActiveControls.classList.remove("loading");
        }

        getDefinition(number, is_axis = false) {
            InputConfigurationGroups.asArray.forEach(group => {
                if (isNaN(group)) return;
                for (let definition of InputConfigurationGroups.asArray[group].definitions) {
                    if (definition.number === number && definition.is_axis === is_axis) {
                        // console.log(group, ">", definition.name, "- axis:", definition.is_axis, "- payload:", definition.payload);
                        return definition;
                    }
                }
            });
        }


        getBoundDefinition(number, is_axis) {

            let data = this.getActiveDeviceSettings();
            let found;
            let found_number;
            if (data.__Type == "KeyboardInputConfiguration") {
                found = data.keyboard_commands.find((elem) => elem.key == number);
                if (found) found_number = found.action.number;

            } else {
                found = is_axis ?
                    data.axii.find((elem) => elem.index == number) :
                    data.commands.find((elem) => elem.index == number);

                if (found)
                    found_number = is_axis ? found.number : found.action.number;
            }

            if (found_number == undefined) return undefined;

            return this.getDefinition(found_number, is_axis);
        }

        getDefinitions(category) {

        }

        updateSettings(new_settings) {
            console.log("Updating InputConfiguration settings");
            window["b"] = new_settings;

            Object.assign(InputConfiguration.settings, new_settings);
            engine.updateWholeModel(InputConfiguration);
            const selectedBinding = this.getSelectedInputBinding();
            if (selectedBinding)
                selectedBinding.populateBinding();
            this.markDirty();

            this.updateDominantDevices();
        }

        getActiveDeviceSettings() {
            return this.activeDevice == "keyboard" ?
                InputConfiguration.settings.keyboard
                :
                InputConfiguration.settings.input_devices.input_controllers.find((element) => element.controller.instance_guid == this.activeDevice);
        }

        get activeDefinitionGroupName() {
            return InputConfigurationGroups.asArray[this.activeDefinitionGroup].name;
        }

        getBinding(guid, number, payload, is_axis = false) {

            let data;
            let result;

            if (guid == "keyboard") {
                data = InputConfiguration.settings.keyboard;
                result = data.keyboard_commands.find((element) => element.action.number == number && element.action.payload == payload);

            } else {
                data = InputConfiguration.settings.input_devices.input_controllers.find((element) => element.controller.instance_guid == guid);

                result = is_axis ?
                    data.axii.find((element) => element.number == number) :
                    data.commands.find((element) => element.action.number == number && element.action.payload == payload);
            }

            return result;
        }

        getActiveBinding(number, payload, is_axis = false) {
            return this.getBinding(this.activeDevice, number, payload, is_axis);
        }


        getDominantBinding(number, is_axis = false) {

            let result;
            let guid;

            InputConfiguration.settings.input_devices.input_controllers.forEach((elem) => {
                if (InputConfiguration.connected_guids.indexOf(elem.controller.instance_guid) > -1) {
                    let found = elem.axii.find(axis => axis.number == number);
                    if (found) {
                        result = elem.controller.product_name;
                        guid = elem.controller.instance_guid;
                        //console.log(elem);
                        return result;
                    }
                }
            });

            const output = {
                name: result ? result : engine.translate("lblNone"),
                guid: guid
            };

            return output;
        }


        #addHandler;

        clearAddHandler() {
            if (this.#addHandler)
                this.#addHandler.clear();
        }

        cancelAddBinding() {
            this.listen(false);
            this.clearAddHandler();
            const binding = this.getArmedInputBinding();
            if (binding)
                binding.disarmDetection();
            //$.waitForFrames(() => this.listen(true), 3);
        }

        /** 
         * @param {ControlDefinition} control_definition 
         * @returns {ControlDefinitionLoc} loc
        */
        getControlDefinitionLocId(control_definition) {
            if (!control_definition) {
                return { id: "binding-Unknown", suffix: "", original: "" }
            }
            let idarr = control_definition.name.split(" ");
            let suffix = "";
            if (!isNaN(Number(idarr[idarr.length - 1]))) {
                suffix = Number(idarr.pop());
            }
            return { id: "binding-" + idarr.join("-").toLowerCase(), suffix: suffix, original: idarr.join("-").toLowerCase() };
        }

        /** @param {ControlDefinition|ControlDefinitionLoc} input */
        getTranslatedControlDefinition(input) {
            let loc;
            if (input.id != undefined && input.suffix != undefined) {
                loc = input;
            } else {
                loc = this.getControlDefinitionLocId(input);
            }

            let output;

            const exceptions = ["paddle-gear", "e-s-c-cycle", "performance-mode-cycle", 
                
                "a-b-s-direct", "e-s-c-direct", "traction-control-cut-direct", "traction-control-direct",

                "traction-control-cycle", "a-b-s-cycle", "engine-map-cycle", "brake-bias-cycle", "binding-f-f-b-gain", "turbo-level-cycle", 
                
                "ers-recharge-cycle", "ers-deployment-cycle", "ers-heat-charging-cycle"];

            if (exceptions.indexOf(loc.original) == -1) {
                output = engine.translate(loc.id) + ((loc.suffix != "") ? " " + loc.suffix : "");
            }

            for (let i = 0; i < exceptions.length; i++) {
                if (loc.id.indexOf(exceptions[i]) > -1) {
                    if (loc.id.indexOf("direct") > -1) {
                        output = `${engine.translate(loc.id)} ${loc.suffix - 1}`;
                    } else {
                        output = engine.translate(loc.id + loc.suffix);
                    }
                }
            }

            return output;
        }

        /** @returns {InputBindingElement} */
        getSelectedInputBinding() {
            return q("ks-inputbinding.selected", this);
        }

        /** @returns {InputBindingElement} */
        getArmedInputBinding() {
            return q("ks-inputbinding.armed", this);
        }

        removeBinding(control_definition, is_shift = false, guid = this.activeDevice) {
            console.log("removeBinding", control_definition.name, "shift:", is_shift, guid);
            //ksUI.iterate(control_definition);

            this.Client.request("Remove", {
                definition: control_definition,
                guid: guid == "keyboard" ? "" : guid,
                is_shift_button: is_shift
            }, (data) => {
                ({
                    [eCommandResponse.OK]: () => {
                        console.log("Removed binding", control_definition.name, is_shift, guid);

                        this.sortDevices(data, this.connectedGuids);
                        this.updateSettings(data.settings);

                        waitForFrames(() => {
                            this.getSelectedInputBinding().populateBinding();
                            this.getSelectedInputBinding().classList.remove("selected");
                        }, 1);
                    },
                    [eCommandResponse.Failed]: () => {
                        console.error("Error removing", control_definition.name, is_shift, guid);
                    }
                }[data.response])();
            });
        }

        lastErrorKey;

        addBinding(control_definition, callback, is_shift = false, guid = this.activeDevice, listen_to_all = false, retry = false) {
            this.hideProperties();
            ksUI$1.toggleSpatialNavigation(false);
            console.log("addBinding", control_definition.name, is_shift, guid, listen_to_all);

            //if (control_definition.is_axis) {
            //window["debug_control"] = control_definition;
            //ksUI.iterate(control_definition);
            //}

            rootModal().onHide = () => {
                waitForFrames(() => {
                    ksUI$1.toggleSpatialNavigation(true);
                }, 3);
            };

            if (!retry) {

                rootModal().Show({
                    title: "lbl" + (control_definition.is_axis ? "MoveAxis" : "PressButton"),
                    message: "msgAssignBindingFor",
                    extraCssClass: "controls-binding new-binding",
                    buttons: 0x000,
                    useKeyEvent: true,
                    msgVariables: {
                        // target_group: this.activeDefinitionGroupName,
                        target_binding: this.getTranslatedControlDefinition(control_definition),
                        bottom_message: engine.translate("lblPressEscToCancel")
                    }
                }).onCancel = () => {
                    console.log("aborted addBinding 1", control_definition.name, is_shift, guid, listen_to_all);
                    this.cancelAddBinding();
                    rootModal().useKeyEvent = false;
                };
            }

            this.#addHandler =
                this.Client.request("Add", {
                    definition: control_definition,
                    guid: guid == "keyboard" ? "" : guid,
                    is_shift_button: is_shift,
                    listen_to_all: listen_to_all
                }, (data) => {
                    ({
                        [eCommandResponse.OK]: () => {
                            console.log("Added binding", control_definition.name);

                            this.lastErrorKey = undefined;

                            this.sortDevices(data, this.connectedGuids);
                            this.updateSettings(data.settings);

                            waitForFrames(() => {
                                if (callback)
                                    callback(data);

                                rootModal().Hide();
                            }, 1);
                        },
                        [eCommandResponse.Failed]: () => {
                            if (!retry)
                                console.warn("Double binding detected for", control_definition.name, control_definition.is_axis ? "axis" : "key", data.error_key);

                            if (this.lastErrorKey == data.error_key) {
                                // console.log("Second attempt");
                                this.listen(false);
                                waitForFrames(() => {
                                    window["force_add"] = {
                                        definition: control_definition,
                                        guid: guid == "keyboard" ? "" : guid,
                                        key: data.error_key,
                                        required_modifiers: data.error_required_modifiers
                                    };

                                    this.Client.request("ForceAdd", {
                                        definition: control_definition,
                                        guid: guid == "keyboard" ? "" : guid,
                                        key: data.error_key,
                                        required_modifiers: data.error_required_modifiers
                                    }, (forced_data) => {
                                        if (forced_data.response == eCommandResponse.OK) {
                                            console.log("Forced binding", control_definition.name);
                                            this.sortDevices(forced_data, this.connectedGuids);
                                            this.updateSettings(forced_data.settings);

                                            waitForFrames(() => {
                                                if (callback)
                                                    callback(forced_data);

                                                rootModal().Hide();
                                            }, 1);

                                            this.lastErrorKey = undefined;
                                        }
                                    });
                                    //this.listen(true);
                                });
                            } else {

                                rootModal().Show({
                                    title: "lbl" + (control_definition.is_axis ? "AxisAlreadyAssigned" : "ButtonAlreadyAssigned"),
                                    message: control_definition.is_axis ? "msgAlreadyBoundAxis" : "msgAlreadyBoundButton",
                                    extraCssClass: "controls-binding new-binding",
                                    buttons: 0x000,
                                    useKeyEvent: true,
                                    msgVariables: {
                                        found_binding: engine.translate(this.getControlDefinitionLocId(this.getBoundDefinition(data.error_key, control_definition.is_axis)).id),
                                        force_message: engine.translate(control_definition.is_axis ? "lblMoveAgainToAdd" : "lblPressAgainToAdd"),


                                        // target_group: this.activeDefinitionGroupName,
                                        target_binding: this.getTranslatedControlDefinition(control_definition),

                                        bottom_message: engine.translate("lblPressEscToCancel")

                                    }
                                }).onCancel = () => {
                                    console.log("aborted addBinding 2", control_definition.name, is_shift, guid, listen_to_all);
                                    this.cancelAddBinding();
                                    rootModal().useKeyEvent = false;
                                };

                                this.lastErrorKey = data.error_key;

                                this.listen(false);

                                waitForFrames(() => {
                                    //this.listen(true);
                                    this.addBinding(control_definition, callback, is_shift, guid, listen_to_all, true);
                                }, 10);
                            }
                        }
                    }[data.response])();

                });
        }

        //editBinding(control_definition, guid, )

        getGroups() {
            this.Client.request("Groups", (data) => {
                ({
                    [eCommandResponse.OK]: () => {
                        //console.log("received groups");
                        //Object.assign(this.groups, data.groups);

                        let groups = { asArray: [] };


                        for (let x in data.groups) {
                            if (typeof data.groups[x] == "object") {
                                groups.asArray.push(data.groups[x]);
                            }
                        }

                        this.assignModel(groups, "InputConfigurationGroups");

                        waitForFrames(() => {

                            /** @type Btnbasic[] */

                            let btnGroups = qAll(".groups .togglers ks-btnbasic", this);

                            for (const btn of btnGroups) {
                                btn.onToggled = (sender, e, state) => {

                                    const isGroup = sender.classList.contains("group");

                                    if (state) {
                                        if (isGroup) {
                                            console.log("Group", sender.dataset.value);
                                            this.activeDefinitionGroup = InputConfigurationGroups.asArray.findIndex(group => {
                                                return group.name == sender.dataset.value
                                            });

                                            this.populateDefinitions();

                                        } else {

                                            ({
                                                shifts: () => {
                                                    this.showShifts();
                                                }
                                            }[sender.dataset.mode])?.();

                                        }

                                        this.hideProperties();

                                        waitForFrames(() => {
                                            engine.updateWholeModel(InputConfigurationGroups);
                                            waitForFrames(() => {
                                                this.setupNavigation();
                                            });
                                        }, 1);
                                    }
                                };
                            }

                            if (this.panelMain.dataset.mode == "definitions")
                                btnGroups[this.activeDefinitionGroup].classList.add("selected");
                            engine.updateWholeModel(InputConfigurationGroups);

                            this.initialized = true;
                        }, 1);

                        if (this.panelMain.dataset.mode == "definitions")
                            this.populateDefinitions();


                    },
                    [eCommandResponse.Failed]: () => {
                        console.error("Error getting InputConfigurationResponseGroups");
                    }
                }[data.response])();
            });

            this.populateShifts();
        }

        showShifts() {
            this.panelMain.dataset.mode = "shifts";
        }

        populateShifts() {
            if (this.panelShifts.dataset.mode != "keyboard") ;
        }

        populateDefinitions() {
            this.panelMain.dataset.mode = "definitions";
            //console.log("populateDefinitions", this.activeDefinitionGroupName, this.activeDefinitionGroup);
            this.panelDefinitions.classList.add("loading");
            this.panelDefinitions.innerHTML = "";


            InputConfigurationGroups.asArray[this.activeDefinitionGroup].definitions.forEach((value) => {
                if (value.is_axis && this.activeDevice == "keyboard") {
                    return true;
                }
                /** @type InputBindingElement */
                let inputBinding = document.createElement("ks-inputbinding");
                inputBinding.setAttribute("lazyload", true);
                inputBinding.ControlDefinition = value;
                inputBinding.ControlDefinitionGroup = this.activeDefinitionGroupName;

                // if (this.activeDevice == "keyboard") {
                //     const readonly = [516, 517];
                //     inputBinding.readOnly = readonly.indexOf(value.number) > -1;
                // }

                this.panelDefinitions.appendChild(inputBinding);

            });



            waitForFrames(() => {
                this.filterVisibleBindingsByName(this.activeDefinitionFilter);
                this.panelDefinitions.classList.remove("loading");
            }, 3);
        }

        cancel() {
            this.Client.request("Cancel", (data) => {
                console.log("Cancel InputConfiguration");
                this.clearDirty();
            });
        }

        refresh() {

            this.hideProperties();

            this.Client.request("Refresh", (data) => {
                ({
                    [eCommandResponse.OK]: () => {
                        // console.log("Received OK");
                        this.clearDirty();
                    },
                    [eCommandResponse.Failed]: () => {
                        console.error("Error refreshing InputConfiguration");
                    }
                }[data.response])?.();

            });
        }

        getConnectedControllers() {
            var output = [];
            for (const entry of this.currentSettings.input_devices.input_controllers) {
                if (this.connectedGuids.includes(entry.controller.instance_guid)) {
                    output.push(entry.controller.product_name);
                }
            }
            return output;
        }

        sortDevices(data, connected_guids) {
            //return;
            if (!connected_guids) {
                this.connectedGuids = [...data.connected_guids];
                connected_guids = data.connected_guids;
            }

            data.settings.input_devices.input_controllers.sort((a, b) => {

                let a_guid = a.controller.instance_guid;
                let b_guid = b.controller.instance_guid;
                let a_name = a.controller.product_name.toUpperCase();
                let b_name = b.controller.product_name.toUpperCase();

                if (connected_guids.indexOf(a_guid) > -1 && connected_guids.indexOf(b_guid) > -1 ||
                    connected_guids.indexOf(a_guid) == -1 && connected_guids.indexOf(b_guid) == -1) {
                    return (a_name < b_name) ? -1 : (a_name > b_name) ? 1 : 0;
                }
                return connected_guids.indexOf(a_guid) > -1 ? -1 : 1;
            });
        }

        settingsSliderState(state) {
            const elem = qAll('.controller');
            elem.forEach(slider => {
                slider.style.display = state;
            });
        }

        controllerSettingsVisibility() {
            if (this.activeDevice == "0" || this.activeDevice == "1" || this.activeDevice == "2" || this.activeDevice == "3" || this.activeDevice == "keyboard") {
                this.settingsSliderState("flex");
            } else {
                this.settingsSliderState("none");
            }
        }

        onDevicesChanged(data) {
            Object.assign(this.currentSettings, data.settings);

            this.sortDevices(data);
            this.assignModel(data, "InputConfiguration");

            waitForFrames(() => {
                let btns = qAll(".devices ks-btnbasic", this);

                for (const btn of btns) {
                    btn.onToggled = (sender, e, state) => {

                        if (state) {
                            console.log("Device", sender.dataset.value);
                            this.activeDevice = sender.dataset.value;
                            this.panelShifts.dataset.mode = this.activeDevice;
                            // this.controllerSettingsVisibility();
                            this.getGroups();
                            this.hideProperties();
                            waitForFrames(() => this.setupNavigation(), 3);
                            // this.activeDefinitionGroup = InputConfigurationGroups.asArray.findIndex(group => {
                            //     return group.name == sender.dataset.value
                            // });
                            // $.waitForFrames(() => {
                            //     engine.updateWholeModel(InputConfigurationGroups);
                            // }, 1);
                        }
                    };
                }

                this.getGroups();
                this.updateDominantDevices();
            }, 1);


            //ksUI.iterate(data.connected_guids);
        }

        isDeviceConnected(guid) {

        }

        onAfterRenderControlHints(controlhints) {

            this.mapElementById("btnBack", controlhints);
            this.btnApply = q(".apply", controlhints);
            this.btnCancel = q(".cancel", controlhints);
            this.btnPresets = q(".presets", controlhints);


            const changePage = function (target, sender, is_back = true) {

                function process() {
                    if (ksUI$1.menuState.isOriginMainMenu && is_back) {
                        ksUI$1.goTo("menu.html", "main/main");
                    } else {
                        ksUI$1.changePage(target, false, false);
                    }
                }

                if (sender.isDirty) {

                    sender.pageModal.Show({
                        type: eModalDialogTypes.Warning,
                        title: "lblChangesDetected",
                        message: "msgChangesWarning",
                        confirm: "btnApply",
                        useKeyEvent: false
                    });

                    sender.pageModal.onDiscard = () => {
                        //$.waitForFrames(() => {
                        process();
                        //}, 1);
                    };

                    sender.pageModal.onConfirm = () => {

                        sender.save(() => {
                            process();
                        });
                    };

                } else {
                    process();
                }
            };

            this.btnBack.onPressed = () => {
                changePage("settings/main", this);
            };

            this.btnPresets.onPressed = () => {
                changePage("settings/controlpresets", this, false);
            };


            this.btnApply.onPressed = () => this.save();
            this.btnCancel.onPressed = () => this.cancel();

        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            waitForFrames(() => ksUI$1.menuState.ignoreInputActions(false), 12);

            this.Client = new MessageHandler("InputConfiguration");

            console.log("Showing control settings");

            this.refreshHandler = engine.on("InputConfigurationResponseRefresh", (data) => {
                //ksUI.iterate(data);
                cancelAnimationFrame(this.refreshDebounce.id);
                // read the sharedcommands
                if (!data.is_soft_set) {
                    console.log("Received InputConfigurationResponseRefresh hard");
                    waitForFrames(() => {
                        this.onDevicesChanged(data);
                    }, 1, this.refreshDebounce);
                } else {
                    console.log("Received InputConfigurationResponseRefresh soft");
                }
            });

            this.panelDevices = q(".devices", this);
            this.panelGroups = q(".groups", this);

            this.mapElementByClass("panelDefinitions");
            this.mapElementByClass("panelShifts");
            this.mapElementByClass("panelShiftsKeyboard");
            this.mapElementByClass("panelShiftsDevice");
            this.mapElementByClass("panelProperties");
            this.mapElementByClass("panelSettings");
            this.mapElementByClass("panelTrackIR");

            this.mapElementById("panelMain");
            this.mapElementById("panelExtras");

            this.mapElementByClass("btnShifts");
            this.mapElementByClass("btnProperties");
            this.mapElementByClass("btnSettings");
            this.mapElementByClass("btnTrackIR");

            this.mapElementById("btnDelBinding");
            this.mapElementById("btnIsInverted");
            this.mapElementById("btnIsSlider");
            this.mapElementById("btnRequiresShift");
            this.mapElementByClass("sliderTriggerTime");

            this.mapElementById("btnAddModifier");

            this.mapElementById("inputSearch");

            this.mapElementById("panelActiveControls");


            this.barSteering = q(".steering .bar", this.panelActiveControls);
            this.barThrottle = q(".throttle .bar", this.panelActiveControls);
            this.barBrakes = q(".brakes .bar", this.panelActiveControls);
            this.barClutch = q(".clutch .bar", this.panelActiveControls);
            this.barHandbrake = q(".handbrake .bar", this.panelActiveControls);



            this.page(true);

            // $.waitForFrames(() => {
            //     SpatialNavigation.clear();
            // }, 3);
            //this.init();
        }

        initialized = false;

        init() {
            super.init();

            this.engineActionHandle = engine.on("UIExInputsAction", (e) => {
                if (this.activeDevice == "keyboard" && e.guid == 0 || this.activeDevice == e.guid) {
                    const elem = q('ks-inputbinding.bound.is-button[action_number="' + e.action_number + '"][action_payload="' + e.action_payload + '"]');
                    if (elem)
                        elem.highlight();
                }
            });

            this.engineAxisHandle = engine.on("UIExInputsAxii", (e) => {

                const axii = e.axii;

                for (let i = 0; i < axii.length; i++) {
                    const axis = axii[i];
                    const elem = q(`ks-inputbinding.bound.is-axis[axis_name="${axis.axis}"]`);

                    const value = axis.current_value;

                    if (elem) {
                        elem.axisActivity(value, axis.axis == "InputAxis_Car_Steer");
                        //console.log(axis.raw_value, axis.current_value);
                    }



                    if (window["DominantDevices"]) {
                        if (DominantDevices.steering.guid == axis.guid && axis.axis == "InputAxis_Car_Steer") {
                            const positive = value >= 0;
                            this.barSteering.classList.toggle("positive", positive);
                            this.barSteering.style.width = `${ksUI$1.range(Math.abs(value), 0, 1, 0, 50)}%`;
                        }

                        if (DominantDevices.throttle.guid == axis.guid && axis.axis == "InputAxis_Car_Gas") {
                            this.barThrottle.style.width = `${ksUI$1.range(value, 0, 1, 0, 100)}%`;
                        }
                        if (DominantDevices.brakes.guid == axis.guid && axis.axis == "InputAxis_Car_Brake") {
                            this.barBrakes.style.width = `${ksUI$1.range(value, 0, 1, 0, 100)}%`;
                        }
                        if (DominantDevices.clutch.guid == axis.guid && axis.axis == "InputAxis_Car_Clutch") {
                            this.barClutch.style.width = `${ksUI$1.range(value, 0, 1, 0, 100)}%`;
                        }
                        if (DominantDevices.handbrake.guid == axis.guid && axis.axis == "InputAxis_Car_Handbrake") {
                            this.barHandbrake.style.width = `${ksUI$1.range(value, 0, 1, 0, 100)}%`;
                        }

                    }
                }
                // if (this.activeDevice == "keyboard" && e.guid == 0 || this.activeDevice == e.guid) {
                //     const elem = $.q('ks-inputbinding.is-button[action_number="' + e.action_number + '"][action_payload="' + e.action_payload + '"]');
                //     if (elem)
                //         elem.highlight();
                // }
            });



        }

        refreshHandler;
        refreshDebounce = { id: 0 };

        sliderDebounce;

        bindControls() {

            // this.panelDevices.addEventListener("wheel", (e) => {
            //     /** @type HTMLDivElement */
            //     const p = e.currentTarget;
            //     const s = getComputedStyle(e.currentTarget);
            //     e.currentTarget.scrollLeft -= e.deltaY * ((p.scrollWidth - p.offsetWidth) / 4);
            // });

            // this.panelDefinitions.addEventListener("wheel", (e) => {

            //     /** @type HTMLDivElement */
            //     const p = e.currentTarget;
            //     const v = p.scrollHeight - p.offsetHeight;

            //     e.currentTarget.scrollTop -= e.deltaY * (v / (p.scrollHeight / p.offsetHeight) * 0.5);

            // });

            this.btnSettings.onPressed = () => this.showSettings();
            this.btnTrackIR.onPressed = () => this.showTrackIR();
            this.btnProperties.onPressed = () => { this.panelExtras.dataset.mode = "properties"; };

            this.btnDelBinding.onPressed = () => {
                let binding = this.getSelectedInputBinding();

                rootModal().Show({
                    title: "lblClearBinding",
                    message: "msgClearBindingFor",
                    buttons: 0x101,
                    extraCssClass: "controls-binding del-binding",
                    useKeyEvent: true,
                    msgVariables: {
                        // target_group: this.activeDefinitionGroupName,
                        target_binding: this.getTranslatedControlDefinition(binding.ControlDefinition)
                    }
                }).onConfirm = () => {
                    let binding = this.getSelectedInputBinding();
                    this.hideProperties();
                    this.removeBinding(binding.ControlDefinition, binding.isShift);
                };
            };

            /** bind the button trigger modes */

            qAll(".modes ks-btnbasic").forEach(elem => {
                elem.onToggled = (sender, e, state) => {
                    q(".is-command", this.panelProperties).dataset.mode = sender.dataset.mode;
                    q(".labelTriggerTime", this.sliderTriggerTime).innerHTML = engine.translate(sender.dataset.mode == "repeat" ? "lblTriggerEvery" : "lblTriggerAfter");

                    const binding = this.editingBinding;
                    const action = binding.action;
                    const control_definition = this.editingControlDefinition;

                    switch (sender.dataset.mode) {
                        case "constant":
                            action.repeat_time_ms = 0;
                            action.trigger_time_ms = 0;
                            break;
                        case "release":
                            action.repeat_time_ms = -1;
                            action.trigger_time_ms = 0;
                            break;
                        case "press":
                            action.repeat_time_ms = -1;
                            action.trigger_time_ms = 1;
                            break;
                        case "hold":
                            action.repeat_time_ms = -1;
                            action.trigger_time_ms = this.sliderTriggerTime.value;
                            this.sliderTriggerTime.dataset.mode = "trigger_time_ms";
                            break;
                        case "repeat":
                            action.repeat_time_ms = this.sliderTriggerTime.value;
                            action.trigger_time_ms = 0;
                            this.sliderTriggerTime.dataset.mode = "repeat_time_ms";
                            break;
                    }

                    let settings = {
                        definition: control_definition,
                        guid: this.getActiveDeviceGuid(),
                        trigger_time_ms: action.trigger_time_ms,
                        repeat_time_ms: action.repeat_time_ms,
                        require_shift: binding.require_shift ? true : false,
                        axis_settings: new InputDeviceAxisSettings()
                    };

                    this.Client.request("Edit", settings, (data) => {
                        if (data.response == "OK") {
                            this.updateSettings(data.settings);
                        } else {
                            console.error("Error updating InputConfiguration");
                        }
                    });

                    /* 
                        Constant - repeat_time_ms: 0, trigger_time_ms: 0
                        OnRelease - repeat_time_ms: -1, trigger_time_ms: 0
                        OnPress - repeat_time_ms: -1, trigger_time_ms: 1
                        OnHold - repeat_time_ms: -1, trigger_time_ms: > 1
                        OnRepeat - repeat_time_ms: > 0, trigger_time_ms: 0
                    */
                };
            });

            qAll("ks-btnbasic.axis-settings", this.panelProperties).forEach(elem => {

                elem.onToggled = (sender, e, state) => {
                    const binding = this.editingBinding;
                    //const action = binding.action;
                    const control_definition = this.editingControlDefinition;

                    binding.settings[sender.dataset.setting] = state;

                    //                console.log(sender.dataset.setting, state);

                    const settings = {
                        definition: control_definition,
                        guid: this.getActiveDeviceGuid(),
                        trigger_time_ms: 0,
                        repeat_time_ms: 0,
                        require_shift: binding.require_shift ? true : false,
                        axis_settings: binding.settings
                    };

                    waitForFrames(() => {
                        this.Client.request("Edit", settings, (data) => {
                            if (data.response == "OK") {
                                this.updateSettings(data.settings);
                            } else {
                                console.error("Error updating InputConfiguration");
                            }
                        });
                    }, 3);

                };
            });

            qAll(".is-axis ks-slider", this.panelProperties).forEach(elem => {
                elem.addEventListener("onSliderValueChanged", (ev) => {
                    const binding = this.editingBinding;

                    const control_definition = this.editingControlDefinition;

                    const detail = ev.detail;
                    const sender = detail.sender;

                    binding.settings[sender.dataset.setting] = detail.value / 100;

                    let settings = {
                        definition: control_definition,
                        guid: this.getActiveDeviceGuid(),
                        trigger_time_ms: 0,
                        repeat_time_ms: 0,
                        require_shift: binding.require_shift ? true : false,
                        axis_settings: binding.settings
                    };

                    cancelAnimationFrame(this.refreshDebounce.id);

                    waitForFrames(() => {
                        this.Client.request("Edit", settings, (data) => {
                            if (data.response == "OK") {
                                this.updateSettings(data.settings);
                            } else {
                                console.error("Error updating InputConfiguration");
                            }
                        });
                    }, 10, this.refreshDebounce);


                });
            });



            qAll("ks-btnbasic", this.panelShiftsKeyboard).forEach(elem => {
                elem.onToggled = (sender, e, state) => {

                    this.Client.request("UpdateKeyboardModifiers", {
                        is_ctrl_enabled: q(".modifierCtrl", this.panelShiftsKeyboard).isSelected(),
                        is_shift_enabled: q(".modifierShift", this.panelShiftsKeyboard).isSelected(),
                        is_alt_enabled: q(".modifierAlt", this.panelShiftsKeyboard).isSelected()
                    }, (data) => {
                        if (data.response == eCommandResponse.OK) {
                            this.updateSettings(data.settings);
                        }
                    });

                };
            });

            this.sliderTriggerTime.addEventListener("onSliderValueChanged", (ev) => {

                const binding = this.editingBinding;
                const action = binding.action;
                const control_definition = this.editingControlDefinition;

                const detail = ev.detail;
                const sender = detail.sender;

                action[sender.dataset.mode] = detail.value;

                let settings = {
                    definition: control_definition,
                    guid: this.getActiveDeviceGuid(),
                    trigger_time_ms: action.trigger_time_ms,
                    repeat_time_ms: action.repeat_time_ms,
                    require_shift: binding.require_shift ? true : false,
                    axis_settings: new InputDeviceAxisSettings()
                };

                //ksUI.iterate(settings);

                this.Client.request("Edit", settings, (data) => {
                    if (data.response == "OK") {
                        this.updateSettings(data.settings);
                    } else {
                        console.error("Error updating InputConfiguration");
                    }
                });

            });

            this.btnRequiresShift.onToggled = (sender, e, state) => {
                const binding = this.editingBinding;
                const action = binding.action;
                const control_definition = this.editingControlDefinition;

                binding.require_shift = state;

                let settings = {
                    definition: control_definition,
                    guid: this.getActiveDeviceGuid(),
                    trigger_time_ms: action.trigger_time_ms,
                    repeat_time_ms: action.repeat_time_ms,
                    require_shift: binding.require_shift ? true : false,
                    axis_settings: new InputDeviceAxisSettings()
                };

                this.Client.request("Edit", settings, (data) => {
                    if (data.response == "OK") {
                        this.updateSettings(data.settings);
                    } else {
                        console.error("Error updating InputConfiguration");
                    }
                });
            };

            this.btnIsInverted.onPressed = (sender, e) => {
                const binding = this.editingBinding;
                binding.action;
                this.editingControlDefinition;
            };

            qevAll("ks-slider", "onSliderValueChanged", (ev) => {
                if (!this.initialized) return;

                console.log(ev.detail.sender.dataset.setting, ev.detail.value);
                const target = ev.detail.sender.dataset.setting;
                const settings = InputConfiguration.settings.settings.device_settings;

                if (ev.detail.sender.classList.contains("ffb")) {
                    const ffb_settings = InputConfiguration.settings.settings.ffb_enhancements;
                    ffb_settings[target] = Number(ev.detail.value) / 100;
                    this.Client.request("UpdateForceFeedbackEnhancements",
                        { force_feedback_enhancements: ffb_settings },
                        (data) => {
                            if (data.response == eCommandResponse.OK) {
                                this.updateSettings(data.settings);
                            } else {
                                console.error("Error updating InputDeviceSettings");
                            }
                        });
                } else {
                    let targetvalue;
                    const isBool = typeof settings[target] === "boolean";

                    if (ev.detail.sender.classList.contains("enum")) {
                        targetvalue = String(ev.detail.value);
                    } else if (isBool) {
                        const v = ev.detail.value;
                        const i = ev.detail.index;                      
                        targetvalue = typeof v === "boolean" ? v : i !== undefined ? i === 1 : Number(v) === 1 || v === "true"; 
                    } else {
                        const isSteerLock = target === "steer_lock";
                        targetvalue = isSteerLock ? Number(ev.detail.value) : Number(ev.detail.value) / 100;
                    }

                    settings[target] = targetvalue;

                    this.Client.request("UpdateInputDeviceSettings",
                        { input_device_settings: settings },
                        (data) => {
                            if (data.response == eCommandResponse.OK) {
                                this.updateSettings(data.settings);
                            } else {
                                console.error("Error updating InputDeviceSettings");
                            }
                        });
                }
                //this.markDirty();

            }, this.panelSettings);

            this.inputSearch.onInput = (value, valid) => {
                this.filterVisibleBindingsByName(value);
            };

            this.inputSearch.onChange = (value, valid) => {
                this.filterVisibleBindingsByName(value);
            };

        }

        activeDefinitionFilter;

        filterVisibleBindingsByName(value) {
            if (!value) value = "";
            const normalized = value.trim().toLowerCase();

            this.activeDefinitionFilter = normalized;

            qAll(".panelDefinitions ks-inputbinding").forEach(elem => {
                
                const text = elem.dataset.locName.toLowerCase();
                elem.classList.toggle("hidden", text.indexOf(normalized) == -1);
            });

        }

        editingBinding = null;
        editingControlDefinition = null;

        showProperties(control_definition, binding) {
            if (!this.getSelectedInputBinding()) {
                console.log("cannot find selected binding");
                return;
            }

            this.sliderTriggerTime.preventEvent = true;

            this.btnDelBinding.removeAttribute("disabled");

            const lockedbindings = [
                "InputAction_UI_Up", "InputAction_UI_Down", "InputAction_UI_Left", "InputAction_UI_Right",
                "InputAction_UI_PageUp", "InputAction_UI_PageDown", "InputAction_UI_Confirm", "InputAction_UI_Cancel", "InputAction_UI_Menu"];

            if (this.activeDevice == "keyboard" && lockedbindings.indexOf(binding.action.input) > -1) {
                this.btnDelBinding.setAttribute("disabled", true);
            }

            qAll(".panelProperties ks-slider").forEach(elem => elem.slider.setup());
            // console.log(control_definition, binding);
            this.btnProperties.enable();

            this.btnProperties.press();

            this.editingBinding = binding;
            this.editingControlDefinition = control_definition;

            this.panelProperties.classList.toggle("disabled", this.getSelectedInputBinding().readOnly);

            const mapping = {
                [BindingType.InputDeviceAxis]: "axis",
                [BindingType.KeyboardCommand]: "key",
                [BindingType.InputDeviceCommand]: "command",
            };

            const action = binding.action;

            this.panelProperties.dataset.mode = mapping[binding.__Type];

            if (binding.__Type == BindingType.InputDeviceAxis) {

                qAll(".is-axis ks-slider", this.panelProperties).forEach(elem => {
                    //elem.preventEvent = true;
                    elem.valueNoEvent = Number(binding.settings[elem.dataset.setting]) * 100;
                    //elem.preventEvent = false;
                });

                this.btnIsSlider.toggle(binding.settings.is_slider);
                this.btnIsInverted.toggle(binding.settings.is_inverted);

            } else {

                let triggermode = "none";

                if (action.repeat_time_ms == 0 && action.trigger_time_ms == 0) {
                    triggermode = "constant";
                }

                if (action.repeat_time_ms == -1 && action.trigger_time_ms == 0) {
                    triggermode = "release";
                }

                if (action.repeat_time_ms == -1 && action.trigger_time_ms == 1) {
                    triggermode = "press";
                }

                if (action.repeat_time_ms == -1 && action.trigger_time_ms > 1) {
                    triggermode = "hold";
                    this.sliderTriggerTime.dataset.mode = "trigger_time_ms";
                    this.sliderTriggerTime.value = action.trigger_time_ms;
                }

                if (action.repeat_time_ms > 0 && action.trigger_time_ms == 0) {
                    triggermode = "repeat";
                    this.sliderTriggerTime.dataset.mode = "repeat_time_ms";
                    this.sliderTriggerTime.value = action.repeat_time_ms;
                }



                q(".is-command", this.panelProperties).dataset.mode = triggermode;

                console.log(".modes-" + mapping[binding.__Type] + " ." + triggermode, action.repeat_time_ms, action.trigger_time_ms);

                const modebutton = q(".modes-" + mapping[binding.__Type] + " .trigger-" + triggermode, this.panelProperties);

                // $.q(".modes-" + mapping[binding.__Type] + " .sliderTriggerTime", this.panelProperties)

                //this.sliderTriggerTime.preventEvent = true;
                this.sliderTriggerTime.valueNoEvent = triggermode == "repeat" ? binding.action.repeat_time_ms : binding.action.trigger_time_ms;
                //this.sliderTriggerTime.preventEvent = false;
                q(".labelTriggerTime", this.sliderTriggerTime).innerHTML = engine.translate(triggermode == "repeat" ? "lblTriggerEvery" : "lblTriggerAfter");

                q(".modes-" + mapping[binding.__Type], this.panelProperties).dataset.mode = triggermode;
                q(".properties.is-" + mapping[binding.__Type], this.panelProperties).dataset.mode = triggermode;

                if (modebutton) {
                    modebutton.toggle(true);
                }

                this.btnRequiresShift.toggle(binding.require_shift);
                this.sliderTriggerTime.preventEvent = false;
            }

            // if(this.panelExtras.dataset.mode == "help") {
            //     this.btnProperties.classList.add("selected");
            //     this.panelExtras.dataset.mode = "properties";
            // }

            /* 
                Constant - repeat_time_ms: 0, trigger_time_ms: 0
                OnRelease - repeat_time_ms: -1, trigger_time_ms: 0
                OnPress - repeat_time_ms: -1, trigger_time_ms: 1
                OnHold - repeat_time_ms: -1, trigger_time_ms: > 1
                OnRepeat - repeat_time_ms: > 0, trigger_time_ms: 0
            */

        }

        hideProperties() {
            this.btnProperties.classList.remove("selected");
            this.btnProperties.disable();
            if (this.panelExtras.dataset.mode == "properties") {
                this.panelExtras.dataset.mode = "help";
            }
            this.editingBinding = null;
            this.editingControlDefinition = null;
        }

        showSettings() {
            this.panelExtras.dataset.mode = "settings";
            qAll(".panelSettings ks-slider").forEach(elem => elem.slider.setup());
        }

        showTrackIR() {
            this.panelExtras.dataset.mode = "trackir";
        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();

            console.log(this.tagName, "removed");

            this.refreshHandler.clear();
            this.clearAddHandler();

            this.listen(false);
            this.page(false);

            this.clearAssignedModels();

            if (window["inputBindingFilters"]) {
                delete window["inputBindingFilters"];
            }

            this.engineActionHandle.clear();
            this.engineAxisHandle.clear();
        }

    }

    ksUI$1.registerModule('ks-page-settings-controls', SettingsControls);

    var template$i = "<div class=\"component-body\" data-mode=\"home\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n\r\n            <ks-btnbasic id=\"btnContinue\" class=\"focusable defaultfocus\">\r\n                <div slot=\"name\" data-l10n-id=\"btnContinue\">Continue</div>\r\n            </ks-btnbasic>\r\n    \r\n        </div>\r\n    </component-slot>\r\n\r\n    <div class=\"submode-body centered-content align-items-center\">\r\n\r\n        <div class=\"roadmap\"></div>\r\n\r\n    </div>\r\n    \r\n</div>";

    class RoadmapPage extends KsHTMLElement {

        /** @type {Btnbasic} */
        btcContinue;

        constructor() {
            super();
            this.template = template$i;
            this._exposeAsActivePage = true;
            this._isnavigable = true;
            this.delayedInit = true;
            this.shouldRenderControlHints = true;
            this.handleInputAction = this.handleInputAction.bind(this);
        }

        bindControls() {
            window.addEventListener(EngineEvents.UI.InputAction, this.handleInputAction);
        }

        onAfterRenderControlHints(controlhints) {
            this.btnContinue = q("ks-btnbasic", controlhints);
            this.mapElementById("btnContinue", controlhints);

            this.btnContinue.onPressed = () => {
                this.continue();
            };
        }

        continue() {
            this.btnContinue.setAttribute("disabled", "true");
            this.classList.add("continue");
            document.body.classList.add("fade-controlhints");
            ksUI$1.UIUtilityCommand(eUIUtilityCommandType.OnRoadmapEnd);
            waitForFrames(() => {
                ksUI$1.request("GameEconomyClient", "PlayerMode",
                    (response) => {
                        localStorage.setItem("playermodeset", "true");
                        console.log("Set to open mode");
                    },
                    {
                        is_sandbox: true
                    }
                );
            }, 30);
        }

        handleInputAction(evt) {
            if (evt.detail == "confirm" || evt.detail == "cancel") {
                this.clearAssignedModels();
                this.clearAssignedFilters();
                this.continue();
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.documentBody.classList.remove("ui-locked");
            document.body.classList.add("roadmap");
        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();
            window.removeEventListener(EngineEvents.UI.InputAction, this.handleInputAction);
            //document.body.classList.remove("roadmap");
        }

    }
    ksUI$1.registerModule('ks-page-roadmap', RoadmapPage);

    class SettingsPage extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$o;
            this.delayedInit = false;
            this._isnavigable = true;
        }

        bindControls() {
        }

        onTemplateLoaded() {
            ksUI$1.Models.enable(DataModels.SessionState);
            super.onTemplateLoaded();
            ksUI$1.menuState.toggleMouseHover(true);

            waitForFrames(() => {
                const is_ingame = window[DataModels.SessionState] !== undefined && ModelUISessionState.session_name != "" && ModelUISessionState.phase_name != "";

                console.warn(this.tagName, is_ingame);

                document.body.classList.toggle("ingame", is_ingame);

                if (!is_ingame) ksUI$1.Models.disable(DataModels.SessionState);
            }, 1);
        }

        onRemovedFromDOM() {
            ksUI$1.menuState.toggleMouseHover(false);
        }

    }
    engine.on("MenuStateInit", () => {
        ksUI$1.registerModule('ks-page-settings', SettingsPage);
    });

    var template$h = "<div class=\"component-body\" data-bind-class=\"activePage.filters.getSessionCssClass({{ModelUISessionState}})\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <!-- <div id=\"currentServerPing\">\r\n                <div class=\"label connected\" data-l10n-id=\"lblServerPing\"></div>\r\n                <div class=\"value connected\" data-bind-value=\"{{ModelUISessionState}}.player_ping\">--</div>\r\n                <div class=\"suffix connected\">ms</div>\r\n                <div class=\"disconnected\" data-l10n-id=\"lblServerDisconnected\"></div>\r\n            </div> -->\r\n        </div>\r\n        <div class=\"group end\">\r\n        </div>\r\n    </component-slot>\r\n\r\n    <div class=\"header\">\r\n\r\n\r\n        <div id=\"acelogo\">\r\n            <div class=\"session-name\" data-bind-value=\"sessioninfo_session({{ModelUISessionState.session_name}})\">\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n\r\n    <div class=\"submode-body\">\r\n        <div class=\"menu row\">\r\n\r\n            <ks-btnbasic id=\"btnDrive\" class=\"focusable defaultfocus\" data-bind-if=\"{{ModelMenuState.path}} == 'pitlane/main'\" data-bind-disablevalue=\"!{{ModelUISessionState.ui_enable_drive}}\">\r\n                <div slot=\"name\" data-l10n-id=\"mainMenuDrive\">Drive</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnReadyForNext\" class=\"focusable\" data-bind-disablevalue=\"!{{ModelUISessionState}}.is_ready_to_next_blinking\" data-bind-class-toggle=\"hidden:{{ModelUISessionState}}.time_to_next_session == ''\">\r\n                <div slot=\"name\" data-l10n-id=\"lblReadyForNextSession\">Ready for Next Session</div>\r\n            </ks-btnbasic>\r\n\r\n\r\n            <ks-btnbasic id=\"btnTimetable\" class=\"focusable\" data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_SPECIAL_EVENT'\" path=\"pitlane/timetable\">\r\n                <div slot=\"name\" data-l10n-id=\"mainMenuTimetable\">Timetable</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnTrackMap\" class=\"focusable\" data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_SPECIAL_EVENT'\" path=\"pitlane/trackmap\">\r\n                <div slot=\"name\" data-l10n-id=\"mainMenuTrackMap\">Track Map</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnLeaderboard\" class=\"focusable\" data-bind-if=\"{{SeasonInfo}}.mode == 'ClientCommandsMode_SPECIAL_EVENT'\" path=\"pitlane/timetable\">\r\n                <div slot=\"name\" data-l10n-id=\"mainMenuLeaderboard\">Leaderboard</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnSetup\" class=\"focusable\" data-bind-if=\"{{ModelUISessionState.ui_enable_setup}}\" path=\"vehiclesetup/tyres\">\r\n                <div slot=\"name\" data-l10n-id=\"mainMenuVehicleSetup\">Vehicle Setup</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnReplay\" storeorigin=\"true\" ndata-bind-disablevalue=\"{{ModelUISessionState}}.phase_name == 'Waiting_For_Start' || ({{ModelUISessionState}}.phase_name == 'Waiting_For_Players' && !IsFlagSet(InSessionFlags.Multiplayer, {{ModelUISessionState}}))\" class=\"focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"lblReplayUpper\">Options</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnOptions\" goto=\"settings.html\" path=\"settings/main\" storeorigin=\"true\" class=\"focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"mainMenuSettings\">Options</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnNext\" class=\"focusable\" data-bind-class-toggle=\"hidden:!{{ModelUISessionState.has_next_session}}\" data-bind-disablevalue=\"!{{ModelUISessionState.has_next_session}}\">\r\n                <div slot=\"name\" data-l10n-id=\"mainMenuNextSession\">Next Session</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnRestart\" class=\"focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"mainMenuRestartSession\">Restart Session</div>\r\n            </ks-btnbasic>\r\n\r\n\r\n            <ks-btnbasic id=\"btnRestartFull\" class=\"focusable\" data-bind-class-toggle=\"hidden:!{{ModelUISessionState.restart_season_enabled}}\" data-bind-disablevalue=\"!{{ModelUISessionState.restart_season_enabled}}\">\r\n                <div slot=\"name\" data-l10n-id=\"mainMenuRestartSeason\">Restart Event</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnExit\" class=\"focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"mainMenuQuit\">Quit</div>\r\n            </ks-btnbasic>\r\n\r\n        </div>\r\n        <div class=\"pitlane-content\">\r\n\r\n            <div class=\"main-panel\">\r\n                <ks-leaderboard id=\"leaderboard\" data-bind-if=\"{{ModelMenuState.path}} == 'pitlane/main'\" class=\"showready\" bindscrollable>\r\n                </ks-leaderboard>\r\n\r\n                <ks-timetable data-bind-if=\"{{ModelMenuState.path}} == 'pitlane/timetable'\">\r\n                </ks-timetable>\r\n\r\n                <div class=\"right-wrapper\">\r\n                    <ks-eventinfo></ks-eventinfo>\r\n                    <ks-hudchat data-bind-if=\"IsFlagSet(InSessionFlags.Multiplayer,{{ModelUISessionState}})\"></ks-hudchat>\r\n                </div>\r\n\r\n\r\n            </div>\r\n\r\n            <div class=\"bottom-panel\">\r\n\r\n                <div class=\"track-name\">\r\n                    <div class=\"name\" data-bind-value=\"{{SeasonInfo}}.sessions[0].track_item.name\"></div>\r\n                    <div class=\"layout\" data-bind-value=\"{{SeasonInfo}}.sessions[0].track_item.layout\"></div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>";

    var template$g = "<div class=\"session-info\" data-bind-process=\"sessioninfo_process_flags({{ModelCurrentCar}})\" data-bind-process-session=\"sessioninfo_process_session({{ModelUISessionState}})\" data-bind-class=\"'phase'+{{ModelUISessionState.phase_name}}\">\r\n\r\n    <!-- <div class=\"flags\">\r\n        <div class=\"global\">\r\n            <div data-l10n-id=\"lblFlagFullCourse\"></div>\r\n        </div>\r\n    </div> -->\r\n\r\n\r\n    <div class=\"session-container\" data-bind-class-toggle=\"last-lap:{{ModelCurrentCar.low_frequency.is_last_lap}}\">\r\n        <div class=\"local\" data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_DRIVING_ACADEMY'\"></div>\r\n        <div class=\"local right\" data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_DRIVING_ACADEMY'\"></div>\r\n        <div class=\"session-name\" data-bind-value=\"sessioninfo_session({{ModelUISessionState.session_name}})\">\r\n        </div>\r\n        <div class=\"last-lap-label\" data-l10n-id=\"lblSessionInfoLastLapUpper\">\r\n        </div>\r\n        <div class=\"last-lap-leader-label\" data-l10n-id=\"lblSessionInfoLeaderOnLastLapUpper\">\r\n        </div>\r\n    </div>\r\n\r\n\r\n    <div class=\"session-time session-duration\" data-bind-if=\"({{ModelUISessionState}}.phase_name == 'Waiting_For_Players' && {{ModelUISessionState.time_left}} != '') || {{ModelUISessionState}}.phase_name == 'Overtime_Waiting_For_Leader' || {{ModelUISessionState.total_lap}} == 0 || {{ModelUISessionState.current_lap}} == 0 ||  ({{ModelUISessionState.current_lap}} >= {{ModelUISessionState.total_lap}} +1)\" data-bind-value=\"{{ModelUISessionState.time_left}}\"></div>\r\n\r\n    <div class=\"session-laps session-duration\" data-bind-if=\"{{ModelUISessionState.total_lap}} > 0 && {{ModelUISessionState.current_lap}} <= {{ModelUISessionState.total_lap}}\">\r\n\r\n        <div data-bind-value=\"{{ModelUISessionState.current_lap}}\"></div>/<div data-bind-value=\"{{ModelUISessionState.total_lap}}\"></div>\r\n    </div>\r\n\r\n    <div class=\"message finished\" data-l10n-id=\"labelFinished\">FINISHED</div>\r\n    <div class=\"message waiting_for_players\" data-l10n-id=\"labelWaitingForPlayers\">WAITING FOR PLAYERS</div>\r\n    <div class=\"message waiting_for_leader\" data-l10n-id=\"labelWaitingForLeader\">WAITING FOR LEADER</div>\r\n    <div class=\"message waiting_for_others\" data-l10n-id=\"labelWaitingForOthers\">WAITING FOR OTHERS</div>\r\n\r\n</div>";

    class SessionInfo extends KsHTMLElement {

        lastSessionNameId = null;
        lastTranslated = null;

        constructor() {
            super();
            this.template = template$g;
            this.delayedInit = true;
        }

        filters = {
            sessioninfo_process_flags: (car) => {
                this.dataset.local = car.low_frequency.flags.flag;
                this.dataset.global = car.low_frequency.flags.global_flag;
            },
            sessioninfo_session: (x) => {
                if (!x) return "";

                const id = `lblSessionName_${x}`;

                if (this.lastSessionNameId != id) {
                    this.lastTranslated = engine.translate(id);
                    this.lastSessionNameId = id;
                }

                return this.lastTranslated;
            },
            sessioninfo_process_session: (x) => {
                this.dataset.sessionPhase = x.phase_name;
                this.classList.toggle("session-ended", ksUI$1.isSet(x.end_session_flag, InSessionFlags.SessionEnd));
            }

        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.classList.toggle("not-hud", !this.closest("ks-hud"));
            //this.setAttribute("data-bind-ksmessage", "{{ModelCurrentCar}}");
        }

    }
    ksUI$1.registerModule('ks-sessioninfo', SessionInfo);

    var template$f = "<div class=\"session-info\">\r\n\r\n    <div class=\"timeicon\"></div>\r\n    <div class=\"session-name\" data-bind-value=\"ksUI.getTimeOfDayFromCarState({{ModelCurrentCar}})\">\r\n    </div>\r\n    \r\n</div>";

    class TimeOfDayInfo extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$f;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
        }

        bindControls() {
            super.bindControls();       
        }


    }
    ksUI$1.registerModule('ks-timeofdayinfo', TimeOfDayInfo);

    var template$e = "<div class=\"track-info\">\r\n    \r\n    <div class=\"trackicon\"></div>\r\n    <div class=\"track-label\" data-bind-value=\"trackstatusinfo_process({{ModelUISessionState.initial_grip}})\">Track</div>\r\n         \r\n</div>";

    class TrackStatusInfo extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$e;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();        
        }

        filters = {
            trackstatusinfo_process: (grip) => {
                return engine.translate(grip);
            }
        }

    }
    ksUI$1.registerModule('ks-trackstatusinfo', TrackStatusInfo);

    var template$d = "<div class=\"leaderboard\" data-bind-class=\"'session_' + {{ModelUISessionState}}.session_name.toLowerCase()\">\r\n\r\n    <div class=\"official-panel scrollable-vertical\">\r\n        <div class=\"leaderboardline official focusable\" data-bind-for=\"index,line:{{ModelLeaderboard.lines}}\" data-bind-class-toggle=\"focused:{{line.focused}};checkered:{{line}}.state == 'UICheckered';outlap:{{line}}.state == 'UIOutLap'\" data-bind-class=\"'location-' + {{line.car_location}}; 'driver' + {{index}}\">\r\n\r\n            <div class=\"core\">\r\n                <div class=\"raceposition\" data-bind-value=\"{{index}}+1\"></div>\r\n\r\n                <div class=\"driver-name\" data-bind-value=\"{{line}}.first_name + ' ' + {{line.last_name}}\"></div>\r\n                <div class=\"model-name\" data-bind-value=\"{{line}}.car_name\"></div>\r\n                <div class=\"tyre-compound\" data-bind-value=\"{{line}}.tyre_compound\"></div>\r\n\r\n                <div class=\"driver-number\" data-bind-value=\"{{line}}.car_number\"></div>\r\n                <div class=\"driver-ping\">\r\n                    <div class=\"fill\" data-bind-value=\"official_ping({{line.ping}},{{index}})\"></div>\r\n                </div>\r\n\r\n                <div class=\"timing\">\r\n                    <div class=\"driver-car-brand\" data-bind-style-background-image-url=\"timetable_brandlogo({{line.car_brand}})\"></div>\r\n                    <div class=\"driver-time\" data-bind-if=\"!{{line.is_ready}} && {{ModelUISessionState.session_name}} != 'Race'\" data-bind-value=\"{{line.best_lap_time}}\"></div>\r\n                    <div class=\"driver-penalty\" data-bind-if=\"{{line}}.penalties != ''\" data-bind-value=\"{{line}}.penalties\" data-bind-class=\"'penalty_' + {{line}}.penalties\"></div>\r\n                    <div class=\"driver-time\" sdata-bind-if=\"!{{line.is_ready}} && {{ModelUISessionState.session_name}} == 'Race'\" data-bind-value=\"{{line.time_diff}}\"></div>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"location\">\r\n                <div class=\"pitlane\">P</div>\r\n            </div>\r\n\r\n            <div class=\"ready\" data-bind-if=\"{{line.is_ready}}\" data-l10n-id=\"lblReady\">\r\n                READY\r\n            </div>\r\n\r\n            <div class=\"handicap\" data-bind-if=\"{{line}}.ballast > 0 || {{line}}.restrictor > 0\" data-bind-class-toggle=\"has-ballast-and-restrictor:{{line}}.ballast > 0 && {{line}}.restrictor > 0\">\r\n                <div class=\"ballast\" title=\"ballast\" data-bind-if=\"{{line}}.ballast > 0\">+<span data-bind-value=\"{{line}}.ballast\">200</span>kg</div>\r\n                <div class=\"restrictor\" data-bind-if=\"{{line}}.restrictor > 0\"><span data-bind-value=\"({{line}}.restrictor * 100).toFixed(0)\">50</span>%</div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"realtime-panel\">\r\n        <div class=\"leaderboardline realtime\" data-bind-for=\"index,line:{{ModelUIRealtimeLeaderboard.lines}}\" data-bind-class-toggle=\"focused:{{line.focused}};lapped:{{line}}.lapped < 0;lap-ahead:{{line}}.lapped > 0;checkered:{{line}}.state == 'UICheckered';outlap:{{line}}.state == 'UIOutLap'\" data-bind-class=\"'location-' + {{line.car_location}}; 'driver' + {{index}}\">\r\n\r\n            <div class=\"core\">\r\n                <div class=\"raceposition\" data-bind-value=\"{{line.pos}}+1\"></div>\r\n\r\n                <div class=\"driver-name\" data-bind-value=\"{{line}}.first_name + ' ' + {{line.last_name}}\"></div>\r\n\r\n                <div class=\"driver-number\" data-bind-value=\"{{line}}.car_number\"></div>\r\n                <div class=\"driver-ping-realtime\">\r\n                    <div class=\"fill\" data-bind-value=\"realtime_ping({{line.ping}},{{index}})\"></div>\r\n                </div>\r\n\r\n                <div class=\"timing\">\r\n                    <div class=\"driver-car-brand\" data-bind-style-background-image-url=\"timetable_brandlogo({{line.car_brand}})\"></div>\r\n                    <div class=\"driver-time\" data-bind-if=\"!{{line.is_ready}} && {{ModelUISessionState.session_name}} != 'Race'\" data-bind-value=\"{{line.time_gap}}\"></div>\r\n                    <div class=\"driver-penalty\" data-bind-if=\"{{line}}.penalties != ''\" data-bind-value=\"{{line}}.penalties\" data-bind-class=\"'penalty_' + {{line}}.penalties\"></div>\r\n\r\n                    <div class=\"driver-time\" data-bind-if=\"!{{line.is_ready}} && {{ModelUISessionState.session_name}} == 'Race'\" data-bind-value=\"{{line.time_gap}}\"></div>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"location\">\r\n                <div class=\"pitlane\">P</div>\r\n            </div>\r\n\r\n            <div class=\"ready\" data-bind-if=\"{{line.is_ready}}\" data-l10n-id=\"lblReady\">\r\n                READY\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n</div>";

    class Leaderboard extends KsHTMLElement {

        leaderboardOfficial;
        leaderboardRealtime;
        /** @type {HTMLDivElement} */
        listLeaderboardLine;
        pingBar;
        fillBar;

        lineHeight = 0;
        rowHeight = 0;
        maxScroll = -1;

        mouseClickListener;
        inputListener;

        constructor() {
            super();
            this.template = template$d;
        }

        focusCarHandler(ev) {
            if (ev.target.classList.contains("leaderboardline")) {
                const line = ev.target;
                const number = Number(q(".driver-number", line).textContent);
                ksUI$1.requestNoResponse("GameMode", "SpecificCar", { car_number: number });
            }
        }

        bindingsSet = false;

        bindControls() {
            if (this.bindingsSet) return;

            super.bindControls();

            engine.on("onResize", () => {
                this.lineHeight = 0;
            });

            if (!this.isInHUD) {
                this.addEventListener("click", this.focusCarHandler);
                this.addEventListener("sn:enter-down", this.focusCarHandler);
            }

            this.bindingsSet = true;
        }

        get mode() {
            return this.dataset.mode;
        }

        set mode(value) {
            this.dataset.mode = value;
            if (value == "Realtime") {
                ksUI$1.Models.disable(DataModels.Leaderboard);
                ksUI$1.Models.enable(DataModels.RealtimeLeaderboard);
            } else if (value == "Official") {
                ksUI$1.Models.disable(DataModels.RealtimeLeaderboard);
                ksUI$1.Models.enable(DataModels.Leaderboard);
            }
        }

        filters = {
            hud_leaderboard_process: (leaderboard) => {
                if (this.mode != "Official") return;

                if (leaderboard.lines.length <= 7) return;

                if (!this.listLeaderboardLine || this.listLeaderboardLine.getBoundingClientRect().height == 0) {
                    this.listLeaderboardLine = q(".leaderboardline.official", this);
                }
                if (this.lineHeight == 0) {
                    this.lineHeight = this.listLeaderboardLine.getBoundingClientRect().height;
                    this.rowHeight = this.lineHeight + (window.FontSize * 0.1);
                    this.maxScroll = -1 * (this.rowHeight * (leaderboard.lines.length - 7));
                }
                const pos = leaderboard.lines.findIndex(line => line.focused);
                if (pos == -1) return;

                let topinPx = 0;

                if (pos > 3 && pos < leaderboard.lines.length - 3) {
                    topinPx = -((pos - 3) * this.rowHeight);
                }
                else if (pos >= leaderboard.lines.length - 3) {
                    topinPx = this.maxScroll;
                }
                else {
                    topinPx = 0;
                }
                topinPx = Math.max(this.maxScroll, Math.min(0, topinPx));
                this.leaderboardOfficial.style.top = `${topinPx}px`;
            },
            hud_leaderboard_realtime: (leaderboard) => {
                if (this.mode != "Realtime") return;

                const visibleLines = 7;
                const center = Math.floor(visibleLines / 2);
                const lines = leaderboard.lines;
                const total = lines.length;

                if (total <= visibleLines) return;

                const focusedIndex = lines.findIndex(line => line.focused);
                if (focusedIndex === -1) return;



                ModelUIRealtimeLeaderboard.lines = Array.from({ length: visibleLines }, (_, i) => {
                    const offset = i - center;
                    const realIndex = (focusedIndex + offset + total) % total;

                    return {
                        ...lines[realIndex],
                        racePosition: realIndex + 1
                    };
                });
            },
            timetable_brandlogo: (carbrand) => {
                const id = carbrand.toLowerCase().replace(/[ -]+/g, "_");
                return `/branding/oem/${id}/logo.texture`;
            },
            official_ping: (x, i) => {
                const fill = q(`.driver${i} .driver-ping .fill`, this);
                let height = '25%';
                let color = 'grey';
                if (x < 0) {
                    height = '10%';
                    color = 'grey';
                } else if (x <= 60) {
                    height = '100%';
                    color = '#44EA78';
                } else if (x <= 100) {
                    height = '75%';
                    color = '#F2DE2A';
                } else if (x <= 150) {
                    height = '50%';
                    color = '#F2CA2A';
                } else {
                    height = '25%';
                    color = '#FF0018';
                }
                fill.style.height = height;
                fill.style.backgroundColor = color;
            },
            realtime_ping: (x, i) => {
                const fill = q(`.driver${i} .driver-ping-realtime .fill`, this);
                let height = '25%';
                let color = 'grey';
                if (x < 0) {
                    height = '10%';
                    color = 'grey';
                } else if (x <= 60) {
                    height = '100%';
                    color = '#44EA78';
                } else if (x <= 100) {
                    height = '75%';
                    color = '#F2DE2A';
                } else if (x <= 150) {
                    height = '50%';
                    color = '#F2CA2A';
                } else {
                    height = '25%';
                    color = '#FF0018';
                }
                fill.style.height = height;
                fill.style.backgroundColor = color;
            }
        }

        isInHUD = false;

        onMoveToBodyFragment() {
            this.removeAttribute("data-bind-process");
            this.removeAttribute("data-bind-realtime");
        }

        onRestoreFromFragment() {
            this.setAttribute("data-bind-process", "hud_leaderboard_process({{ModelLeaderboard}})");
            this.setAttribute("data-bind-realtime", "hud_leaderboard_realtime({{ModelUIRealtimeLeaderboard}})");
        }

        onRemovedFromDOM() {
            this.removeEventListener("click", this.focusCarHandler);
            this.removeEventListener("sn:enter-down", this.focusCarHandler);
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            if (this.closest("ks-hud")) {
                this.isInHUD = true;
                this.setAttribute("data-bind-process", "hud_leaderboard_process({{ModelLeaderboard}})");
                this.setAttribute("data-bind-realtime", "hud_leaderboard_realtime({{ModelUIRealtimeLeaderboard}})");
            }
            this.leaderboardOfficial = q(".official-panel", this);
            this.leaderboardRealtime = q(".realtime-panel", this);

        }

    }
    ksUI$1.registerModule('ks-leaderboard', Leaderboard);

    var template$c = "<div class=\"trackmap-panel\" data-bind-process=\"hud_trackmap_process({{ModelCarsOnTrack}})\">\r\n        \r\n        <div class=\"trackmap\"></div>\r\n       \r\n        <div class=\"cars-container\"></div>\r\n</div>";

    class TrackmapPitlane extends KsHTMLElement {
       
        car;
        trackName;
        trackLayout;
        trackmapRotation;

        showPosition = false;
        lastCarsState = null;

        /** @type {HTMLDivElement} */
        trackMap;

        CAR_STATE_STYLE = {
            default: {color: '#000', opacity: 1},
            focused: {color: '#ff0000ff', opacity: 1},     
            in_pit:    {color: '#616161ff', opacity: 1 }
            // more car states here
        };
       
        constructor() {
            super();
            this.template = template$c;
            this._bindFiltersToThis = true;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            ksUI$1.Models.enable(DataModels.CarsOnTrack);
         
            this.trackMap = q('.trackmap', this);       
            this.loadShowPositionSetting();
            
            GAMEMODESELECTION.getSeasonInfoParameters().then(season => {
                this.selectTrackMap(season);              
            });              
        }

        onRemovedFromDOM() {        
        }

        bindControls() {  
            this.trackMap.addEventListener("mousedown", () => {
                this.showPosition = !this.showPosition;

                if (!this.carsMap || !this.lastCarsState) return;
                
                for (const [id, car] of this.carsMap) {
                    if (!car.badgeText) continue;

                    const data = this.lastCarsState.find(c => String(c.car_number) === id);
                    if (!data) continue;

                    car.badgeText.textContent = this.showPosition
                        ? data.car_position + 1
                        : data.car_number;
                }

                this.saveShowPositionSetting();
            });  

        }

        saveShowPositionSetting() {
            let storage = STORAGE.get("hudlayout");

            storage.layouts ??= {};
            storage.lastLayout ||= "default";

            const layoutKey = storage.lastLayout;
            storage.layouts[layoutKey] ??= { elements: {} };
            const elements = storage.layouts[layoutKey].elements;
           
            const node = (elements.hud_trackmap ??= { settings: {} });
            node.settings ??= {};

            node.settings.showPosition = this.showPosition;

            STORAGE.set("hudlayout", storage);
            STORAGE.save("hudlayout");
        }

        loadShowPositionSetting() {
            const storage = STORAGE.get("hudlayout");
            if (!storage || !storage.layouts) return;

            const layoutKey = storage.lastLayout || "default";
            const layout = storage.layouts[layoutKey] || storage.layouts.default;
            if (!layout || !layout.elements || !layout.elements.hud_trackmap) return;

            const settings = layout.elements.hud_trackmap.settings;
            if (typeof settings.showPosition === "boolean") {
                this.showPosition = settings.showPosition;
            }
        }

        selectTrackMap(season) {       
            const track = season?.sessions?.find(s => s.is_current)?.track_item ?? season?.sessions?.[0]?.track_item;
            if (!track) return;

            const slug = (s) =>
                String(s || "")
                .normalize("NFKD").replace(/[\u0300-\u036f]/g, "")
                .toLowerCase().trim()
                .replace(/[^a-z0-9]+/g, "_")
                .replace(/^-+|-+$/g, "");   

            this.trackName = slug(track.name);
            this.trackLayout = slug(track.layout);

            const url = `/images/trackmaps/${this.trackName}-${this.trackLayout}.texture`;           
            this.trackMap.style.backgroundImage = `url('${url}')`;
        }
       
        getTrackParams(name, layout) {
            const data = this.TRACK_DATA?.[name];
            if (!data) return null;
            return data.layouts?.[layout] ?? null;
        }

        getCarState(car_state) {
            if (car_state.is_focused) return 'focused';
            if (car_state.in_pit)     return 'in_pit';
            return 'default';
        }
      
        setCarStyle(car, car_state) {
            const key = car_state.is_focused ? 'focused' : this.getCarState(car_state);
            const s = this.CAR_STATE_STYLE[key] || this.CAR_STATE_STYLE.default;
            car.style.zIndex = car_state.is_focused ? 10 : 1;  
            
            const target = car_state.car_position === 0 ? (car.triangle || car.circle) : car.circle;
            if (target) {
                target.setAttribute('fill', s.color);           
            }

            const svg = car.querySelector('.car-svg');
            if (svg) {
                svg.style.transformOrigin = '50% 50%';
                svg.style.transform = `rotate(${car_state.car_angle}deg)`;
            }
        }
        
        removeMarker(c) {
            if (!this.carsMap) return false;

            if (c.coord_x === 0 && c.coord_y === 0) {
                const id = String(c.car_number);
                const ghost = this.carsMap.get(id);
                if (ghost) {
                    ghost.remove();
                    this.carsMap.delete(id);
                }
                return true;
            }

            return false;
        }

        fullMapMode(map, cars, carsPanel, offset_X, offset_Y, drawWf, drawHf, panel) {
            map.style.transformOrigin = '0 0';
            panel.style.transform = `translate(0, 0) rotate(${this.trackmapRotation}deg) scale(1)`;

            this.carsMap ||= new Map();
            const liveIds = new Set();

            const SVG = 'http://www.w3.org/2000/svg';

            for (const c of cars) {
                if (this.removeMarker(c)) continue;
                const id = String(c.car_number);
                liveIds.add(id);

                let cars_container = this.carsMap.get(id);
                if (!cars_container) {
                    cars_container = document.createElement('div');
                    cars_container.className = 'car';
                    cars_container.dataset.id = id;
                    cars_container.style.position = 'absolute';

                    const svg = document.createElementNS(SVG, 'svg');
                    svg.setAttribute('class', 'car-svg');
                    svg.setAttribute('viewBox', '0 0 16 16');

                    const g = document.createElementNS(SVG, 'g');
                    svg.appendChild(g);
                
                    const circle = document.createElementNS(SVG, 'circle');
                    circle.setAttribute('class', 'car-marker');
                    circle.setAttribute('cx', '8');
                    circle.setAttribute('cy', '8');
                    circle.setAttribute('r', '6.74');
                    g.appendChild(circle);

                    const tri = document.createElementNS(SVG, 'path');
                    tri.setAttribute('class', 'car-marker');
                    tri.setAttribute('d', 'M7.66,1.45L1.11,14.32c-.12.23.15.46.45.39l6.44-1.52,6.44,1.52c.3.07.57-.16.45-.39L8.34,1.45c-.13-.25-.56-.25-.69,0Z');
                    tri.style.display = 'none';
                    g.appendChild(tri);

                    const badge = document.createElement('div');
                    badge.className = 'car-number';
                    const badgeText = document.createElement('div');
                    badgeText.className = 'car-number-text';
                    badge.appendChild(badgeText);

                    cars_container.appendChild(svg);
                    cars_container.appendChild(badge);
                    carsPanel.appendChild(cars_container);
                
                    cars_container.svgGroup = g;
                    cars_container.circle = circle;
                    cars_container.triangle = tri;
                    cars_container.badgeText = badgeText;

                    this.carsMap.set(id, cars_container);
                }
             
                if (cars_container.badgeText) { 
                    cars_container.badgeText.textContent = this.showPosition
                        ? c.car_position + 1
                        : c.car_number;
                }

              
                if (c.car_position == 0) {
                    cars_container.circle.style.display = 'none';
                    cars_container.triangle.style.display = '';
                } else {
                    cars_container.triangle.style.display = 'none';
                    cars_container.circle.style.display = '';
                }

                this.setCarStyle(cars_container, c);

                const final_x = offset_X + c.coord_x * drawWf;
                const final_y = offset_Y + c.coord_y * drawHf;

                cars_container.style.left = `${final_x * 100}%`;
                cars_container.style.top  = `${final_y * 100}%`;
                cars_container.style.transform = 'translate(-50%, -50%)';
                cars_container.style.visibility = 'visible';
            }
            
            for (const [id, car] of this.carsMap) {
                if (!liveIds.has(id)) {
                car.remove();
                this.carsMap.delete(id);
                }
            }
            }



        filters = {
        hud_trackmap_process: (state) => {
            if (!state || !state.cars_on_track) return;

            const panel = q('.trackmap-panel', this);        
            const carsPanel = q('.cars-container', this);
            if (!panel || !this.trackMap) return;
            this.lastCarsState = state.cars_on_track;

            const pw = panel.clientWidth;
            const ph = panel.clientHeight;
                 
            const panelRatio = pw / Math.max(ph, 1);

            let drawWf, drawHf, offset_X = 0, offset_Y = 0;
            if (panelRatio >= 1) {
                drawHf = 1;
                drawWf = 1 / panelRatio;
                offset_X  = (1 - drawWf) * 0.5;
            } else {
                drawWf = 1;
                drawHf = panelRatio / 1;
                offset_Y  = (1 - drawHf) * 0.5;
            }

            offset_X = state.trackmap_offset_x/2048;
            offset_Y = state.trackmap_offset_y/2048;

            this.fullMapMode(this.trackMap, state.cars_on_track, carsPanel, offset_X, offset_Y, drawWf, drawHf, panel);

        }
    }


    }
    ksUI$1.registerModule('ks-trackmap-pitlane', TrackmapPitlane);

    var template$b = "<div class=\"weather-info\" data-bind-class=\"weather_icon({{ModelUISessionState.initial_weather}})\">\r\n\r\n    <div class=\"weather\">\r\n        <div class=\"weathericon\"></div>\r\n        <div class=\"temperature\" data-bind-value=\"(Math.round({{ModelCurrentCar.air_temperature_c}}) + 'C')\">\r\n        </div>\r\n    </div>  \r\n</div>";

    class WeatherInfo extends KsHTMLElement {

        constructor() {
            super();
            this.template = template$b;
        }

        filters = {
            weather_icon: (weather) => {
                this.dataset.weathericon = weather.weather_preset;            
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
        }

        bindControls() {
            super.bindControls();       
        }


    }
    ksUI$1.registerModule('ks-weatherinfo', WeatherInfo);

    var template$a = "<div class=\"timetable-body component-body\">\r\n    <div class=\"driverdetails\" data-bind-class-toggle=\"dsq:{{TimeTable}}.driver.high_penalty == 'DSQ'\">\r\n        <div class=\"dsq\" data-l10n-id=\"lblDisqualifiedUpper\"></div>\r\n        <ks-btnbasic id=\"btnReturn\" class=\"focusable\">\r\n            <div slot=\"name\">\r\n                <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 14.533 22.507\">\r\n                    <path d=\"M2.229,16.8l9.563-9.562a1.681,1.681,0,0,1,2.384,0l1.589,1.589a1.681,1.681,0,0,1,0,2.384L8.993,18l6.778,6.778a1.681,1.681,0,0,1,0,2.384l-1.589,1.6a1.681,1.681,0,0,1-2.384,0L2.236,19.2A1.683,1.683,0,0,1,2.229,16.8Z\" transform=\"translate(-1.734 -6.746)\" fill=\"#f2f2f2\"/>\r\n                </svg>\r\n\r\n            </div>\r\n        </ks-btnbasic>\r\n        <div class=\"number\" data-bind-value=\"'#' + {{TimeTable}}.driver.car_number\"></div>\r\n        <div class=\"drivername\" data-bind-value=\"timetable_merge({{TimeTable.driver.driver_name}},{{TimeTable.driver.driver_surname}})\">Driver Name</div>\r\n\r\n        <div class=\"brand\" data-bind-style-background-image-url=\"timetable_brandlogo({{TimeTable.driver.car_brand}})\"></div>\r\n        <div class=\"modelwrapper\">\r\n            <div class=\"model\" data-bind-value=\"{{TimeTable}}.driver.car_name\"></div>\r\n            <div class=\"handicap\" data-bind-if=\"{{TimeTable}}.driver.ballast > 0 || {{TimeTable}}.driver.restrictor > 0\" data-bind-class-toggle=\"has-ballast-and-restrictor:{{TimeTable}}.driver.ballast > 0 && {{TimeTable}}.driver.restrictor > 0\">\r\n                <div class=\"restrictor\" data-bind-if=\"{{TimeTable}}.driver.restrictor > 0\"><span data-bind-value=\"({{TimeTable}}.driver.restrictor * 100).toFixed(0)\">50</span>%</div>\r\n                <div class=\"ballast\" title=\"ballast\" data-bind-if=\"{{TimeTable}}.driver.ballast > 0\">+<span data-bind-value=\"{{TimeTable}}.driver.ballast\">200</span>kg</div>\r\n            </div>\r\n\r\n        </div>\r\n\r\n\r\n\r\n\r\n        <div class=\"vertical position-driver\">\r\n            <div class=\"label\" data-l10n-id=\"timeTablePosition\"></div>\r\n            <div class=\"value\" data-bind-value=\"{{TimeTable}}.driver.position +1\"></div>\r\n        </div>\r\n\r\n\r\n        <div class=\"vertical bestlap-driver\" data-bind-if=\"{{TimeTable}}.driver.best_lap != ''\">\r\n            <div class=\"label\" data-l10n-id=\"timeTableBestLap\"></div>\r\n            <div class=\"value\" data-bind-value=\"{{TimeTable}}.driver.best_lap\"></div>\r\n        </div>\r\n\r\n        <div class=\"vertical laps-driver\">\r\n            <div class=\"label\" data-l10n-id=\"timeTableLaps\"></div>\r\n            <div class=\"value\" data-bind-value=\"{{TimeTable}}.driver.laps\"></div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"top-info\">\r\n        <div class=\"slot-info slot-small slot-position\">\r\n            <div data-name=\"position\" data-l10n-id=\"timeTablePosition\"></div>\r\n        </div>\r\n        <div class=\"slot-info slot-driver\">\r\n            <div data-name=\"name\" data-l10n-id=\"timeTableDriverName\"></div>\r\n        </div>\r\n        <div class=\"slot-info slot-make\">\r\n            <div data-name=\"make\"></div>\r\n        </div>\r\n        <div class=\"slot-info slot-small carnumber slot-number\">\r\n            <div data-name=\"car-number\" data-l10n-id=\"timeTableCarNumber\"></div>\r\n        </div>\r\n        <div class=\"slot-info slot-small lapnumber slot-number\">\r\n            <div data-name=\"lap-number\" data-l10n-id=\"timeTableLapNumber\"></div>\r\n        </div>\r\n\r\n        <div class=\"slot-info slot-split split1\">\r\n            <div data-name=\"split-1\" data-l10n-id=\"timeTableSplit\"></div>\r\n        </div>\r\n        <div class=\"slot-info slot-split split2\">\r\n            <div data-name=\"split-2\" data-l10n-id=\"timeTableSplit\"></div>\r\n        </div>\r\n        <div class=\"slot-info slot-split split3\">\r\n            <div data-name=\"split-3\" data-l10n-id=\"timeTableSplit\"></div>\r\n        </div>\r\n\r\n        <div class=\"slot-info bestlap session_qualifying\" data-l10n-id=\"timeTableLapTime\">\r\n\r\n        </div>\r\n\r\n        <div class=\"slot-info racetime session_race\" data-l10n-id=\"timeTableRaceTime\">\r\n\r\n        </div>\r\n\r\n        <div class=\"slot-info laptime session_race\" data-l10n-id=\"timeTableLapTime\">\r\n\r\n        </div>\r\n        <div class=\"slot-info slot-medium laps\" sdata-bind-if=\"{{SeasonInfo}}.mode == 'ClientCommandsMode_SPECIAL_EVENT'\">\r\n            <div data-name=\"laps\" data-l10n-id=\"timeTableLaps\"></div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"timetable-column scrollable-vertical\">\r\n        <div class=\"scrollable-content per-item-scroll\">\r\n            <ks-timetablebtnrow class=\"focusable\" data-bind-for=\"row:{{TimeTable.drivers}}\" data-bind-ksmessage=\"{{row}}\" data-bind-class-toggle=\"invalid:{{row}}.is_valid === false;best:{{row}}.lap_time == {{row}}.best_lap;cancel:{{row}}.laps <= 0;dsq:{{row}}.high_penalty == 'DSQ'\">\r\n            </ks-timetablebtnrow>\r\n\r\n            <div class=\"specialevents\" data-bind-if=\"{{SeasonInfo}}.mode == 'ClientCommandsMode_SPECIAL_EVENT'\">\r\n                <ks-timetablebtnrow class=\"focusable\" data-bind-for=\"row:{{SpecialEvents.rows}}\" data-bind-class-toggle=\"mydriver:{{row.isPlayer}} \" data-bind-if=\"{{row.time}} != ''\">\r\n                </ks-timetablebtnrow>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n\r\n    <div class=\"loading message\" data-l10n-id=\"lblLoading\"></div>\r\n\r\n    <div class=\"error message\" data-l10n-id=\"BACKENDDISCONNECTED\"></div>\r\n\r\n</div>";

    var template$9 = "<div class=\"timetablebtnrow-body\">\r\n    <div class=\"timetables\" data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_SPECIAL_EVENT'\">\r\n        <div class=\"slot slot-small position-box position\" data-bind-value=\"timetable_position({{row.position}})\"></div>\r\n        <div class=\"slot slot-driver dark-box driver\">\r\n            <div class=\"drivername\" data-bind-value=\"timetable_merge({{row.driver_name}},{{row.driver_surname}})\">Driver Name</div>\r\n            <div class=\"modelwrapper\">\r\n                <div class=\"model\" data-bind-value=\"{{row.car_name}}\">Model Name</div>\r\n                <div class=\"handicap\" data-bind-if=\"{{row}}.ballast > 0 || {{row}}.restrictor > 0\" data-bind-class-toggle=\"has-ballast-and-restrictor:{{row}}.ballast > 0 && {{row}}.restrictor > 0\">\r\n                    <div class=\"restrictor\" data-bind-if=\"{{row}}.restrictor > 0\"><span data-bind-value=\"({{row}}.restrictor * 100).toFixed(0)\">50</span>%</div>\r\n                    <div class=\"ballast\" title=\"ballast\" data-bind-if=\"{{row}}.ballast > 0\">+<span data-bind-value=\"{{row}}.ballast\">200</span>kg</div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <div class=\"slot-logo brand\" data-bind-style-background-image-url=\"timetable_brandlogo({{row.car_brand}})\"></div>\r\n        <div class=\"slot slot-small dark-box carnumber\" data-bind-value=\"{{row.car_number}}\">Car Number</div>\r\n        <div class=\"slot slot-small dark-box lapnumber\" data-bind-value=\"{{row.lap}} +1\">Lap Number</div>\r\n\r\n        <div class=\"slot light-box time split1 split\" data-bind-value=\"timetable_split({{row.splits[0]}})\">Split 1</div>\r\n        <div class=\"slot light-box time split2 split\" data-bind-value=\"timetable_split({{row.splits[1]}})\">Split 2</div>\r\n        <div class=\"slot light-box time split3 split\" data-bind-value=\"timetable_split({{row.splits[2]}})\">Split 3</div>\r\n        \r\n        <div class=\"slot grey-box time bestlap\" data-mode=\"timed\">\r\n            <div class=\"bestlaptime\" data-bind-value=\"{{row.best_lap}}\"></div>\r\n            <div class=\"diff\" data-bind-if=\"{{row}}.position > 0 && {{row}}.diff_first != ''\" data-bind-value=\"'+' + {{row.diff_first}}\"></div>\r\n        </div>\r\n\r\n        <div class=\"slot grey-box time racetime\" data-bind-class-toggle=\"timediff:{{row}}.position > 0\" data-bind-if=\"{{row}}.diff_first != '' || {{row}}.position == 0\" data-bind-value=\"{{row}}.position == 0 ? {{row}}.total_time : '+' + {{row}}.diff_first\" data-mode=\"race\">Race Time</div>\r\n        <div class=\"slot grey-box time racetime\" data-bind-if=\"{{row}}.position > 0 && {{row}}.diff_first == ''\" data-mode=\"race\">--</div>\r\n\r\n        <div class=\"slot grey-box time laptime\" data-bind-value=\"{{row.lap_time}}\" data-mode=\"timed\">Race Time</div>\r\n        <div class=\"slot slot-medium light-box laps\" data-bind-value=\"{{row.laps}}\">Laps</div>\r\n        \r\n    </div>\r\n    <div class=\"specialevents\" data-bind-if=\"{{SeasonInfo}}.mode == 'ClientCommandsMode_SPECIAL_EVENT'\">\r\n        <div class=\"slot slot-small position-box position\" data-bind-value=\"{{row.position}}\"></div>\r\n        <div class=\"slot slot-driver dark-box driver\" data-bind-value=\"{{row.driver}}\">Driver</div>\r\n        <div class=\"slot slot-small grey-box laps\" data-bind-value=\"{{row.total_laps}}\">Laps</div>\r\n        <div class=\"slot grey-box time racetime\" data-bind-value=\"{{row.time}}\">Time</div>\r\n    </div>\r\n\r\n    <div class=\"dsq\" data-l10n-id=\"lblDisqualifiedUpper\"></div>\r\n</div>";

    class TimeTableBtnRow extends Btnbasic {

        constructor() {
            super();
            this.template = template$9;
            this.delayedInit = true;
            this._bindScrollableEvents = true;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
        }
    }
    ksUI$1.registerModule('ks-timetablebtnrow', TimeTableBtnRow);

    class Timetable extends KsHTMLElement {

        /** @type MessageHandler */
        Client;
        btnReturn;

        timetableType = "";

        constructor() {
            super();
            this.template = template$a;
            this._isnavigable = true;
            this.delayedInit = true;
            this.delayFramesInit = 6;
            this._bindScrollableEvents = true;
            this.persistModels = false;
        }

        filters = {
            timetable_merge: (x, y) => {
                return x + " " + y;
            },
            timetable_position: (x) => {
                return x + 1;
            },
            timetable_split: (time) => {
                if (time == undefined) return "-";
                return time;
            },
            timetable_brandlogo: (carbrand) => {
                const id = carbrand.toLowerCase().replace(/[ -]+/g, "_");
                return `/branding/oem/${id}/logo.texture`;
            }
        }

        changePageListener;
        delayArmListener;

        delayInit;

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.dataset.stage = "loading";

            this.mapElementById("btnReturn");

            GAMEMODESELECTION.getSeasonInfoParameters().then((data) => {
                this.dataset.gamemode = data.mode;
                this.dataset.type = data.type;
            });

            const session_name = `session_${ModelUISessionState?.session_name.toLowerCase()}`;

            if (SeasonInfo.mode == "ClientCommandsMode_SPECIAL_EVENT") {
                this.Client = new MessageHandler("GameModeSelectionClient");
                this.requestLeaderboard(session_name);

            } else {
                this.Client = new MessageHandler("TimeTable");

                this.delayInit = setTimeout(() => {
                    this.Client.request("Sessions", data => {
                        if (!this.isConnected) {
                            console.trace("disconnected");
                            return;
                        }
                        const is_ended = data.sessions[ModelUISessionState.session_id].have_results;
                        this.requestTimeTable(session_name, is_ended, ModelUISessionState.event_id, ModelUISessionState.session_id);
                    });

                    this.delayArmListener = setTimeout(() => {
                        this.changePageListener = engine.on("changePage", () => {
                            if (!this.isConnected) {
                                console.trace("disconnected");
                                return;
                            }
                            this.requestTimeTable(session_name, false, ModelUISessionState.event_id, ModelUISessionState.session_id);
                        });
                    }, 3000);
                }, 500);

            }




        }


        requestLeaderboard(timetable_type) {
            this.dataset.stage = "loading";
            console.log("Requesting SpecialEventResults");
            this.Client.request("SpecialEventResults", {
                event_guid: ModelUISessionState.special_event_state.event_id,
                num_results: 20
            }, (response) => {
                if (!this.isConnected) return;
                console.log("Received SpecialEventResults", response.response);
                if (response.response == eClientCommands.Response.OK) {
                    this.dataset.stage = "done";
                    response.driver_row.isPlayer = true;
                    response.rows = [...[response.driver_row], ...response.rows];
                    ksUI$1.assignModel(response, "SpecialEvents");
                    this.setupScrollbars();

                    this.dataset.mode = timetable_type;
                } else {
                    this.dataset.stage = "error";
                }
            });
        }

        bindRowTimerId = { id: 0 };

        requestTimeTable(timetable_type, saved, event_id = 0, session_id = 0, show_message = true) {

            clearTimeout(this.repeatRequestTimeout);

            if (show_message)
                this.dataset.stage = "loading";

            const target_message = saved ? "Drivers" : "RuntimeDrivers";

            console.trace("requestTimeTable", timetable_type, saved, target_message, event_id, session_id);

            this.timetableType = timetable_type;

            this.dataset.viewmode = "overall";

            this.Client.request(target_message, {
                event_id: event_id,
                session_id: session_id
            }, (response) => {
                if (response.response == eClientCommands.Response.OK) {
                    if (!this.isConnected) return;
                    this.assignModel(response, "TimeTable");
                    //ksUI.assignModel(response, "TimeTable");

                    this.dataset.mode = timetable_type;
                    this.dataset.stage = "done";
                    this.dataset.sectors = response.drivers[0]?.splits.length;

                    waitForFrames(() => {
                        this.bindRows(saved, event_id, session_id);
                        this.setupNavigation();
                        this.updateAllScrollBars();
                    }, 1, this.bindRowTimerId);
                } else {
                    this.dataset.stage = "error";
                }
            });

            if (!saved) {
                this.repeatRequestTimeout = setTimeout(() => {
                    this.requestTimeTable(timetable_type, saved, event_id, session_id, false);
                }, 10000);
            }
        }

        repeatRequestTimeout;

        requestDriverLaps(saved, driver_id, event_id, session_id, show_message = true) {
            clearTimeout(this.repeatRequestTimeout);

            if (show_message)
                this.dataset.stage = "loading";

            const target_message = saved ? "Laps" : "RuntimeLaps";

            console.log("requestDriverLaps", target_message, driver_id, event_id, session_id);

            this.Client.request(target_message, {
                driver_id: driver_id,
                event_id: event_id,
                session_id: session_id
            }, data => {

                if (!this.isConnected) return;

                this.dataset.stage = "done";

                const driver = data.driver;
                data.drivers = [];

                data.laps.forEach(lap => {
                    delete driver.splits;
                    delete driver.total_time;
                    delete driver.diff_previous;
                    delete driver.__Type;

                    const entry = { ...lap, ...driver };


                    data.drivers.push(entry);

                });

                this.dataset.viewmode = "driver";

                //data.drivers = data.laps;
                this.assignModel(data, "TimeTable", false, false);

                waitForFrames(() => {
                    this.bindRowsLaps(saved, event_id, session_id);
                    this.setupNavigation();
                    this.updateAllScrollBars();
                }, 1);

            });

            if (!saved) {
                this.repeatRequestTimeout = setTimeout(() => {
                    this.requestDriverLaps(saved, driver_id, event_id, session_id, false);
                }, 5000);
            }

            //console.log("requestDriverLaps", driver_id, event_id, session_id);

        }

        bindRows(saved, event_id, session_id) {
            const rows = qAll("ks-timetablebtnrow", this);
            console.trace(this.tagName, "rows", rows.length, saved);

            rows.forEach(
                /** @param {TimeTableBtnRow} btn */
                btn => {
                    const driver = btn.messages?.TimeTableDriver;
                    const lap_count = driver?.laps;


                    btn.onPressed = (sender, e) => {
                        if (lap_count > 0)
                            this.requestDriverLaps(saved, driver.driver_id, event_id, session_id);
                        else
                            ksUI$1.Audio(eAudioEvents.Cancel);
                    };

                });
        }

        bindRowsLaps(saved, event_id, session_id) {
            const rows = qAll("ks-timetablebtnrow", this);

            this.btnReturn.onPressed = (sender, e) => {
                this.requestTimeTable(this.timetableType, saved, event_id, session_id);
            };

            rows.forEach(
                /** @param {TimeTableBtnRow} btn */
                btn => {
                    btn.onPressed = (sender, e) => {
                        this.requestTimeTable(this.timetableType, saved, event_id, session_id);
                    };

                });
        }


        onAfterRenderControlHints(controlhints) {

        }

        bindControls() {
            qAll('.slot-info.slot-split div').forEach((element, index) => {
                element.textContent += " " + (index + 1);
            });

        }

        init() {
            super.init();
        }

        onRemovedFromDOM() {
            console.log("Timetable removed");
            clearTimeout(this.repeatRequestTimeout);
            cancelAnimationFrame(this.bindRowTimerId.id);

            clearTimeout(this.delayArmListener);

            if (this.Client)
                this.Client.clearResponseHandlerQueue();

            if (this.changePageListener) {
                console.log(this.tagName, 'Clearing changePageListener');
                this.changePageListener.clear();
            }
        }

    }
    ksUI$1.registerModule('ks-timetable', Timetable);

    var template$8 = "<div class=\"event-info\">\r\n    <div data-bind-for=\"index,session:{{SeasonInfo}}.sessions\" data-bind-if=\"{{SeasonInfo}}.sessions.length > 1\">\r\n        <div class=\"session\" data-bind-class-toggle=\"current:{{session}}.is_current;ended:{{session}}.is_ended\">\r\n            <div class=\"session-time monospace\" data-bind-value=\"ksUI.getTimeOfDayFromCarState({{session}})\"></div>\r\n            <div class=\"session-name\" data-bind-l10n-id=\"'lblSessionName_' + {{session}}.session_name\"></div>\r\n            <div class=\"session-duration is-flex-row\" data-bind-if=\"{{session}}.duration_type == 'GameModeSelectionDuration_TIME'\">\r\n                <div class=\"value monospace\" data-bind-value=\"{{session}}.duration/60000\"></div>\r\n                <div class=\"unit\" data-l10n-id=\"labelAbbrMinutes\"></div>\r\n            </div>\r\n            <div class=\"session-duration is-flex-row\" data-bind-if=\"{{session}}.duration_type == 'GameModeSelectionDuration_LAPS'\">\r\n                <div class=\"value monospace\" data-bind-value=\"{{session}}.duration\"></div>\r\n                <div class=\"unit\" data-l10n-id=\"labelLaps\"></div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>";

    class EventInfo extends KsHTMLElement {

        //Client = new MessageHandler("SeasonInfo");
        //changePageHandler;

        constructor() {
            super();
            this.template = template$8;
            this.delayedInit = true;

        }

        load() {
            // this.Client.request("SeasonInfo", (data) => {
            //     this.assignModel(data, "EventInfo");
            //     console.trace("SeasonInfo", data);
            // });

            //  this.Client.request("SessionInfo", { version: 0 }, (data) => {
            //     this.assignModel(data, "CurrentGameEvent");
            //     console.trace("CurrentGameEvent", data);
            //  });
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            // this.load();

            // this.changePageHandler = engine.on("changePage", () => { 
            //     this.load();
            // });

        }

        onRemovedFromDOM() {
            // this.changePageHandler.clear();
        }

    }
    ksUI.registerModule('ks-eventinfo', EventInfo);

    class PitlanePage extends KsHTMLElement {

        /** @type {Btnbasic} */
        btnDrive;
        /** @type {Btnbasic} */
        btnTimetable;
        /** @type {Btnbasic} */
        btnReplay;
        /** @type {Btnbasic} */
        btnSettings;
        /** @type {Btnbasic} */
        btnSetup;
        /** @type {Btnbasic} */
        btnRestart;
        /** @type {Btnbasic} */
        btnRestartFull;
        /** @type {Btnbasic} */
        btnNext;
        /** @type {Btnbasic} */
        btnReadyForNext;
        /** @type {Btnbasic} */
        btnExit;

        changePageHandler;


        constructor() {
            super();
            this.template = template$h;
            this.shouldRenderControlHints = true;
            this._exposeAsActivePage = true;
            this._isnavigable = true;
            this.delayedInit = true;
            this._bindFiltersToThis = true;

        }

        filters = {
            getSessionCssClass(sessionstate) {
                let classes = `session${sessionstate.session_name.replaceAll(" ", "_")} phase${sessionstate.phase_name}`;
                classes += (sessionstate.end_session_flag & globalThis.InSessionFlags.CanSkip) > 0 ? "sessionEnd" : "";

                activePage.classList.toggle("sessionEnd", (sessionstate.end_session_flag & globalThis.InSessionFlags.CanSkip) > 0);

                activePage.dataset.phase = sessionstate.phase_name;
                return classes;
            }
        };

        bindControls() {

            if (ksUI$1.menuState.get().path == "pitlane/main") {

                if (this.btnDrive)
                    this.btnDrive.onPressed = () => {
                        console.log("GameModeRequestStart");
                        ksUI$1.request("GameMode", "Start", (response) => {
                            console.log("Received GameModeResponseStart");
                        });
                    };

                if (this.btnExit)
                    this.btnExit.onPressed = () => {
                        this.handleQuit();
                    };

                if (this.btnReplay)
                    this.btnReplay.onPressed = () => {
                        ksUI$1.requestNoResponse("Replay", "TogglePlay", (response) => { }, { play: true });
                        ksUI$1.goTo("replay.html", "main/main");
                    };

                if (this.btnRestart)
                    this.btnRestart.onPressed = () => {
                        // ksUI.goToLoadingPage(null, null, this);
                        ksUI$1.requestNoResponse("GameMode", "RestartSession", (response) => { });
                    };

                if (this.btnRestartFull)
                    this.btnRestartFull.onPressed = () => {
                        //ksUI.goToLoadingPage(null, null, this);
                        ksUI$1.requestNoResponse("GameMode", "RestartSeason", (response) => { });
                    };

                if (this.btnNext)
                    this.btnNext.onPressed = () => {
                        //ksUI.goToLoadingPage(null, null, this);
                        ksUI$1.requestNoResponse("GameMode", "NextSession", (response) => { });
                        activePage.btnDrive.focus();
                    };

                if (this.btnReadyForNext)
                    this.btnReadyForNext.onPressed = () => {

                        console.log("Player ready for next session");
                        ksUI$1.request("GameMode", "ReadyForNext", (response) => {
                            console.log(response);
                            this.btnReadyForNext.disable();
                            this.btnReadyForNext.style.animation = "none";
                        },
                            {
                                im_empty: false
                            }
                        );

                    };

                this.#internal_handleInputAction = this.handleInputAction.bind(this);

                window.addEventListener(EngineEvents.UI.InputAction, this.#internal_handleInputAction);
            }
        }

        handleQuit() {
            console.warn("Requesting exit from game mode - showing modal");
            this.pageModal.Show({
                type: eModalDialogTypes.Warning,
                title: "lblQuitSession",
                message: "msgQuitSession",
                buttons: 0x101,
                confirm: "btnConfirm",
                useKeyEvent: false
            });

            this.pageModal.onConfirm = () => {
                ksUI$1.requestNoResponse("GameMode", "Exit");
            };
        }

        #internal_handleInputAction;


        handleInputAction(evt) {
            switch (evt.detail) {
                case "cancel":
                    if (ksUI$1.isUIHidden) {
                        return;
                    }

                    if (!this.pageModal.isVisible) {
                        waitForFrames(() => {
                            this.handleQuit();
                        });
                    }
                    break;
            }
        }

        onRemovedFromDOM() {
            console.log("Pitlane UI removed");
            window.removeEventListener("click", this.handleWindowClick);
            window.removeEventListener(EngineEvents.UI.InputAction, this.#internal_handleInputAction);
            ksUI$1.menuState.ignoreInputActions(false);

            if (this.changePageHandler) {
                console.log("Pitlane UI changePage handler cleared");
                this.changePageHandler.clear();
            }


            this.clearAssignedModels();
        }

        onChangePage(target) {
            console.log("Pitlane changepage", target);
            waitForFrames(() => {
                //this.mapElements();
                //this.bindControls();
                this.setupNavigation();
                //this.btnReadyForNext.enable();
            }, 3);
        }

        mapElements() {
            this.mapElementById("btnExit");
            this.mapElementById("btnDrive");
            this.mapElementById("btnTimetable");
            this.mapElementById("btnReplay");
            this.mapElementById("btnRestart");
            this.mapElementById("btnRestartFull");
            this.mapElementById("btnNext");
            this.mapElementById("btnReadyForNext");
        }


        /** @@type {{MessageHandler}} */
        MPClient;

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.mapElements();

            ksUI$1.menuState.ignoreInputActions(true);

            this.changePageHandler = engine.on("changePage", this.onChangePage.bind(this));

            if (this.documentBody.classList.contains("multiplayer") && !this.documentBody.classList.contains("disconnected")) {
                this.MPClient = new MessageHandler("MultiplayerServerList");
            }

            const leaderboard = q("#leaderboard", this);

            leaderboard.mode = "Official";
            leaderboard.clearAllScrollable();
            leaderboard.setupScrollbars();



        }
    }

    ksUI$1.registerModule('ks-page-pitlane', PitlanePage);

    var template$7 = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"focusable defaultfocus\" path=\"pitlane/main\">\r\n                <div slot=\"name\" data-l10n-id=\"btnBack\">Back</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n        <div class=\"group end\"></div>\r\n    </component-slot>\r\n\r\n    <div class=\"header\">\r\n        <div id=\"acelogo\"> \r\n            <div class=\"session-name\" data-bind-value=\"sessioninfo_session({{ModelUISessionState.session_name}})\">\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"submode-body\">\r\n        <div id=\"menu\" class=\"menu row\">\r\n            <div class=\"menuwrapper\"></div>\r\n        </div>\r\n        <ks-timetable data-stage=\"loading\" data-viewmode=\"overall\" id=\"timetable\"> </ks-timetable>\r\n    </div>\r\n</div>";

    class TimetablePage extends KsHTMLElement {

        /** @type {MessageHandler} */
        Client;

        /** @type {Timetable} */
        timetable;

        /** @type {Array} */
        sessions;

        /** @type {HTMLDivElement} */
        menu;

        /** @type  {Array<Btnbasic>} */
        sessionButtons = [];

        showingCurrentSession = false;
        currentSessionEnded = false;

        constructor() {
            super();
            this.template = template$7;
            this.shouldRenderControlHints = true;
            this._exposeAsActivePage = true;
            this._isnavigable = true;
            this.delayedInit = true;
            this._bindScrollableEvents = true;
        }

        populateSessions() {

            this.Client.request("Sessions", data => {

                if (data.response == eClientCommands.Response.OK) {
                    this.sessions = cloneDeep(data.sessions);
                }

                q(".menuwrapper", this.menu).innerHTML = "";
                this.sessionButtons = [];

                this.sessions.forEach((session, index) => {

                    const is_current_session = (session.session_id == ModelUISessionState.session_id && session.event_id == ModelUISessionState.event_id);
                    const is_session_ended = session.have_results; // is_current_session && ksUI.hasSessionFlag(InSessionFlags.SessionEnd);
                    const session_name = `session_${session.session_name.toLowerCase()}`;

                    /** @type {Btnbasic} */
                    const btn = document.createElement("ks-btnbasic");

                    btn.id = "sessionbtn";

                    btn.setAttribute("l10nId", `lblSessionName_${session.session_name}`);
                    btn.setAttribute("toggle", true);
                    btn.setAttribute("toggle-group", "sessions");
                    btn.classList.add("focusable");

                    btn.dataset.event_id = session.event_id;
                    btn.dataset.session_id = session.session_id;
                    btn.dataset.session_type = session_name;
                    btn.dataset.session_ended = is_session_ended;

                    if (!session.have_results && !is_current_session) {
                        btn.setAttribute("disabled", true);
                    }

                    btn.toggle(is_current_session, false);

                    btn.onPressed = this.sessionToggle.bind(this);

                    this.sessionButtons.push(btn);
                    q(".menuwrapper", this.menu).appendChild(btn);

                    console.log("Selected session", session.session_name, is_current_session, is_session_ended);

                });


            });

        }

        sessionToggle(btn, e, state) {

            const event_id = Number(btn.dataset.event_id);
            const session_id = Number(btn.dataset.session_id);
            const session_type = btn.dataset.session_type;
            const is_ended = btn.dataset.session_ended == "true";

            const is_current = (event_id == ModelUISessionState.event_id && session_id == ModelUISessionState.session_id);



            console.log("sessionToggle", "current:", is_current, "ended:", is_ended);

            //this.timetable.re

            // this.Client.request(target_message,
            //     {
            //         event_id: event_id,
            //         session_id: session_id
            //     },
            //     (data) => {

            //     }
            // );

            this.timetable.requestTimeTable(session_type, is_ended, event_id, session_id);
        }

        onAfterRenderControlHints(controlhints) {
            const btnBack = q("#btnBack", controlhints);
            btnBack.onBeforeRedirect = () => {
                console.log("Clearing repeat timer");
                clearTimeout(this.timetable.repeatRequestTimeout);
                if (this.changePageListener) {
                    this.changePageListener.clear();
                }
                this.timetable.onRemovedFromDOM();
            };

        }

        onBindingUpdate(binding_param, value) {
            if (binding_param == 'ksmessage') {
                this.dataset.mode = value.session_name;
            }
        }

        changePageListener;
        delayArmListener;

        onTemplateLoaded() {
            console.trace("timetable page init");
            this.setAttribute("data-bind-ksmessage", "{{ModelUISessionState}}");
            super.onTemplateLoaded();

            this.mapElementById("timetable");
            this.mapElementById("menu");

            this.Client = new MessageHandler("TimeTable");

            this.populateSessions();

            this.delayArmListener = setTimeout(() => {
                this.changePageListener = engine.on("changePage", () => {
                    console.trace(this.tagName, "changePage handled");
                    this.populateSessions();
                });
            }, 5000);

        }


        onRemovedFromDOM() {
            clearTimeout(this.timetable.repeatRequestTimeout);
            clearTimeout(this.delayArmListener);

            this.sessions = null;

            if(this.Client) 
                this.Client.clearResponseHandlerQueue();

            if (this.changePageListener) {
                console.log(this.tagName, 'Clearing changePageListener');
                this.changePageListener.clear();
            }
        }

    }

    ksUI$1.registerModule('ks-page-timetable', TimetablePage);

    var template$6 = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n\r\n            <ks-btnbasic id=\"btnContinue\" class=\"focusable defaultfocus\">\r\n                <div slot=\"name\" data-l10n-id=\"btnContinue\">Continue</div>\r\n            </ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnExit\" class=\"focusable defaultfocus\">\r\n                <div slot=\"name\" data-l10n-id=\"btnExit\">Continue</div>\r\n            </ks-btnbasic>\r\n\r\n        </div>\r\n    </component-slot>\r\n\r\n\r\n    <div id=\"acelogo\"></div>\r\n\r\n    <div class=\"loading\">\r\n        <div class=\"text\" data-l10n-id=\"lblLoadingDataFromServer\"></div>\r\n    </div>\r\n\r\n\r\n    <div class=\"noresponse\">\r\n        <div class=\"text\" data-l10n-id=\"lblCannotRetrieveData\"></div>\r\n    </div>\r\n\r\n\r\n\r\n    <div class=\"main-panel\">\r\n        <div data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_DRIVING_ACADEMY'\" class=\"left-column\">\r\n            <div class=\"top single-panel\">\r\n                <div class=\"row-xp\" data-bind-for=\"row:{{SessionEconomyDataXP.rows}}\" data-bind-class=\"{{row.key}}\">\r\n                    <div class=\"stat-title\" data-bind-l10n-id=\"{{row.key}}\">Title</div>\r\n                    <div class=\"stat-multiplier\" data-bind-value=\"'x' + {{row.multiplier}}\"></div>\r\n                    <div class=\"stat-xp\" data-bind-value=\"APF()?.xp({{row.reward}})\"></div>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"bottom single-panel scrollable-element scrollable-vertical\">\r\n                <div class=\"scrollable-content justify-content-center\">\r\n                    <div class=\"row-credits tyre\" data-bind-for=\"row:{{SessionEconomyDataTyre.rows}}\" data-bind-class=\"{{row.key}}\">\r\n                        <div class=\"stat-title\" data-bind-l10n-id=\"{{row.key}}\">Title</div>\r\n                        <div class=\"stat-multiplier\" data-bind-htmlvalue=\"APF()?.multiplier({{row}})\"></div>\r\n                        <div class=\"stat-credits\" data-bind-value=\"APF()?.row_credits({{row}})\"></div>\r\n                    </div>\r\n                    <div class=\"row-credits\" data-bind-for=\"row:{{SessionEconomyDataCredits.rows}}\" data-bind-class=\"{{row.key}}\">\r\n                        <div class=\"stat-title\" data-bind-l10n-id=\"{{row.key}}\">Title</div>\r\n                        <div class=\"stat-multiplier\" data-bind-htmlvalue=\"APF()?.multiplier({{row}})\"></div>\r\n                        <div class=\"stat-credits\" data-bind-value=\"APF()?.row_credits({{row}})\"></div>\r\n                    </div>\r\n                    <div class=\"row-credits\" data-bind-for=\"row:{{SessionEconomyDataFuel.rows}}\" data-bind-class=\"{{row.key}}\">\r\n                        <div class=\"stat-title\" data-bind-l10n-id=\"{{row.key}}\">Title</div>\r\n                        <div class=\"stat-multiplier\" data-bind-htmlvalue=\"APF()?.multiplier({{row}})\"></div>\r\n                        <div class=\"stat-credits\" data-bind-value=\"APF()?.row_credits({{row}})\"></div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <div class=\"right-column\">\r\n            <div class=\"top single-panel\">\r\n                <div class=\"position finished\">\r\n                    <div class=\"position-row align-items-center justify-content-start\" data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_DRIVING_ACADEMY'\">\r\n                        <div class=\"label\" data-l10n-id=\"sessionEconomyFinished\">FINISHED</div>\r\n                        <div class=\"value\" data-bind-value=\"APF()?.position({{DriverPosition.drivers}})\">1ST</div>\r\n                    </div>\r\n                </div>\r\n                <!-- <div class=\"spacer\"></div> -->\r\n                <div class=\"timed\">\r\n                    <div data-bind-if=\"{{SeasonInfo}}.mode == 'ClientCommandsMode_DRIVING_ACADEMY' || \r\n                    {{SeasonInfo}}.mode == 'ClientCommandsMode_SPECIAL_EVENT'\" class=\"resultlabel\" data-bind-l10n-id=\"lblSessionEconomyResult\">RESULT:</div>\r\n                    <div data-bind-if=\"{{ModelTiming.best}} != '' && {{SeasonInfo}}.type == 'GameModeType_PRACTICE'\" class=\"besttime position-row align-items-center justify-content-start smaller\">\r\n                        <div class=\"bestlap label\" data-l10n-id=\"timeTableBestLap\">BEST LAP</div>\r\n                        <div class=\"value\" data-bind-value=\"{{ModelTiming.best}}\">1:00:00</div>\r\n                    </div>\r\n                    <div class=\"medaltime position-row\">\r\n                        <div class=\"medal-value\"></div>\r\n                    </div>\r\n                    <div class=\"invalid position-row align-items-center justify-content-center smaller\">\r\n                        <div class=\"failed\" data-l10n-id=\"labelFailedLicense\">Failed</div>\r\n                    </div>\r\n                    <div class=\"stars-container\">\r\n                        <div class=\"star-wrapper\">\r\n                            <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"142.25\" height=\"40\" viewBox=\"0 0 142.25 40\">\r\n                                <g id=\"empty-stars\" data-name=\"Group 1414\" transform=\"translate(-1202.938 -230)\">\r\n                                    <path id=\"Icon_ionic-md-star-outline\" data-name=\"Icon ionic-md-star-outline\" d=\"M45.88,19.751l-15.132-1.3L24.839,4.5,18.928,18.451,3.8,19.751,15.275,29.7,11.834,44.5l13-7.845,13,7.845L34.4,29.7ZM26.561,33.8l-1.722-1.039L23.117,33.8l-6.249,3.77,1.654-7.114.455-1.957-1.518-1.316L11.938,22.4l7.275-.625,2-.172L22,19.752l2.841-6.706,2.841,6.706.783,1.849,2,.172,7.276.625-5.52,4.785L30.7,28.5l.455,1.957,1.654,7.114Z\" transform=\"translate(1299.308 225.5)\" fill=\"#fabc3c\"/>\r\n                                    <path id=\"Icon_ionic-md-star-outline-2\" data-name=\"Icon ionic-md-star-outline\" d=\"M45.88,19.751l-15.132-1.3L24.839,4.5,18.928,18.451,3.8,19.751,15.275,29.7,11.834,44.5l13-7.845,13,7.845L34.4,29.7ZM26.561,33.8l-1.722-1.039L23.117,33.8l-6.249,3.77,1.654-7.114.455-1.957-1.518-1.316L11.938,22.4l7.275-.625,2-.172L22,19.752l2.841-6.706,2.841,6.706.783,1.849,2,.172,7.276.625-5.52,4.785L30.7,28.5l.455,1.957,1.654,7.114Z\" transform=\"translate(1249.225 225.5)\" fill=\"#fabc3c\"/>\r\n                                    <path id=\"Icon_ionic-md-star-outline-3\" data-name=\"Icon ionic-md-star-outline\" d=\"M45.88,19.751l-15.132-1.3L24.839,4.5,18.928,18.451,3.8,19.751,15.275,29.7,11.834,44.5l13-7.845,13,7.845L34.4,29.7ZM26.561,33.8l-1.722-1.039L23.117,33.8l-6.249,3.77,1.654-7.114.455-1.957-1.518-1.316L11.938,22.4l7.275-.625,2-.172L22,19.752l2.841-6.706,2.841,6.706.783,1.849,2,.172,7.276.625-5.52,4.785L30.7,28.5l.455,1.957,1.654,7.114Z\" transform=\"translate(1199.142 225.5)\" fill=\"#fabc3c\"/>\r\n                                </g>\r\n                            </svg>\r\n                            <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"142.25\" height=\"40\" viewBox=\"0 0 142.25 40\">\r\n                                <g id=\"full-stars\" data-name=\"Group 1414\" transform=\"translate(-1202.938 -230)\">\r\n                                    <path id=\"fullstar1\" data-name=\"Icon ionic-md-star\" d=\"M24.839,36.655l13,7.845L34.4,29.7,45.88,19.751l-15.132-1.3L24.839,4.5,18.928,18.451,3.8,19.751,15.275,29.7,11.834,44.5Z\" transform=\"translate(1299.308 225.5)\" fill=\"#fabc3c\"/>\r\n                                    <path id=\"fullstar2\" data-name=\"Icon ionic-md-star\" d=\"M24.839,36.655l13,7.845L34.4,29.7,45.88,19.751l-15.132-1.3L24.839,4.5,18.928,18.451,3.8,19.751,15.275,29.7,11.834,44.5Z\" transform=\"translate(1249.225 225.5)\" fill=\"#fabc3c\"/>\r\n                                    <path id=\"fullstar3\" data-name=\"Icon ionic-md-star\" d=\"M24.839,36.655l13,7.845L34.4,29.7,45.88,19.751l-15.132-1.3L24.839,4.5,18.928,18.451,3.8,19.751,15.275,29.7,11.834,44.5Z\" transform=\"translate(1199.142 225.5)\" fill=\"#fabc3c\"/>\r\n                                </g>\r\n                            </svg>\r\n                        </div>\r\n                    </div>\r\n                    <div data-bind-if=\"{{ModelTiming.best}} == '' && {{SeasonInfo}}.mode != 'ClientCommandsMode_DRIVING_ACADEMY'\r\n                        && ['GameModeType_INSTANT_RACE','GameModeType_RACE_WEEKEND'].indexOf({{SeasonInfo}}.type) == -1\" class=\"invalid position-row align-items-center justify-content-center smaller\">\r\n                        <div class=\"label\" data-l10n-id=\"labelNoValidLaps\">Invalid</div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"bottom single-panel is-flex-column align-items-center\">\r\n                <div class=\"row-final consumables\" data-bind-if=\"{{SeasonInfo}}.mode != 'ClientCommandsMode_DRIVING_ACADEMY' && \r\n                {{FinalStats.total_stats.total_costs}} != 0\">\r\n                    <div class=\"stat-title consumable-title\" data-l10n-id=\"lblSessionConsumables\">Title</div>\r\n                    <div class=\"stat-earned\" data-bind-value=\"APF()?.costs({{FinalStats.total_stats.total_costs}}, true)\">Earned</div>\r\n                </div>\r\n                <div class=\"row-final xp\">\r\n                    <div class=\"stat-title\" data-l10n-id=\"totalXPSessionEconomy\">Title</div>\r\n                    <div class=\"stat-earned\" data-bind-value=\"APF()?.xp({{FinalStats.total_stats.earned_xp}})\">Earned</div>\r\n                </div>\r\n                <div class=\"row-final credits\">\r\n                    <div class=\"stat-title\" data-l10n-id=\"lblSessionEarnedCredits\">Title</div>\r\n                    <div class=\"stat-earned\" data-bind-value=\"APF()?.credits({{FinalStats.total_stats.earned_credits}}, true)\">Earned</div>\r\n                </div>\r\n\r\n                <div class=\"row-final wallet\">\r\n                    <div class=\"stat-title\" data-l10n-id=\"totalWalletSessionEconomy\">Title</div>\r\n                    <div class=\"stat-earned\" data-bind-value=\"APF()?.credits({{FinalStats.total_stats.wallet}})\">Value</div>\r\n                </div>\r\n                <ks-playerprogress data-bind-class-toggle=\"new-rank:{{FinalStats.total_stats.is_new_rank}}\"></ks-playerprogress>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n</div>";

    class SessionEconomy extends KsHTMLElement {

        /** @type {MessageHandler} */
        Client;


        wrapperXP = { rows: [] };
        wrapperCredits = { rows: [] };
        wrapperDistance = { rows: [] };
        wrapperTyres = { rows: [] };
        wrapperFuel = { rows: [] };

        isDataLoaded = false;

        /** @type {Btnbasic} */
        btnContinue;

        /** @type {Btnbasic} */
        btnExit;


        constructor() {
            super();
            this.delayedInit = true;
            this.template = template$6;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this._bindScrollableEvents = true;
            this.shouldRenderControlHints = true;

            this.handleInputAction = this.handleInputAction.bind(this);
        }

        filters = {

            position: (drivers_array) => {
                const position = drivers_array.find(driver => driver.is_current_driver)?.position + 1;
                if (isNaN(position)) return "";

                return ksUI$1.getOrdinalNumber(position);
            },

            xp: (x) => {
                return `+${x} xp`;
            },

            credits: (value, addprefix = false) => {
                let prefix = "";
                if (addprefix) {
                    prefix = value > 0 ? "+" : value < 0 ? "-" : "";
                }
                return `${prefix}${value} v$`;
            },

            multiplier: (row) => {
                return `x${row.multiplier}${row.key == eEndSessionRowKeys.ConsumedFuel ? "<span>lt</span>" : ""}`;
            },

            costs: (value) => {
                let prefix = "-";
                return `${prefix}${value} v$`;
            },

            row_credits: (item) => {
                let prefix = "";

                if (item.reward_type == "EndSessionDriverStatsRow_Consumed_Tyre" ||
                    item.reward_type == "EndSessionDriverStatsRow_Consumed_Fuel") {
                    prefix = "-";
                } else {
                    prefix = "+";
                }

                // if (item.key == eEndSessionRowKeys.ConsumedFuel && item.reward > 0 && item.reward_type == "EndSessionDriverStatsRow_Consumed_Tyre" ) {
                //     prefix = "-";
                // } else if (item.reward > 0) {
                //     prefix = "+";
                // } 

                return `${prefix}${item.reward} v$`;
            }

        }

        requestTimeTable() {
            this.Client.request("RuntimeDrivers", (response) => {
                this.assignModel(response, "DriverPosition");
            });
        }

        setSpecialEventsStats() {
            if (SeasonInfo.mode != "ClientCommandsMode_SPECIAL_EVENT") { return; }
            const reward = "EndSessionDriverStatsRow_License_Medal";
            const license_event_time = FinalStats.rows.find(r => r.key === "LICENSE_EVENT_TIME" && r.reward_type === reward);
            q(".timed").style.flexDirection = "row";
            if (license_event_time.multiplier == 0) {
                const invalidLabel = q(".invalid .label");
                if (invalidLabel) {
                    invalidLabel.style.display = "none";
                }
                const invalidFailed = q(".invalid .failed");
                if (invalidFailed) {
                    q(".invalid").style.display = "flex";
                    invalidFailed.style.display = "flex";
                    invalidFailed.style.marginRight = "18rem";
                }

            } else {
                q(".medaltime .medal-value").innerHTML = ksUI$1.formatTimeExt(license_event_time.multiplier, 3, false, 3);
            }

        }

        setDrivingAcademyStats() {
            if (SeasonInfo.mode != "ClientCommandsMode_DRIVING_ACADEMY") { return; }
            const reward = "EndSessionDriverStatsRow_License_Medal";
            q(".timed").style.flexDirection = "row";
            const academy_event_result = FinalStats.rows.find(r => r.key === "EVENT_LICENSE_RESULT" && r.reward_type === reward);
            if (academy_event_result.multiplier == 0) {
                q(".invalid").style.display = "flex";
                q(".invalid .failed").style.display = "flex";
            } else {
                const license_event_time = FinalStats.rows.find(r => r.key === "LICENSE_EVENT_TIME" && r.reward_type === reward);
                q(".medaltime .medal-value").innerHTML = ksUI$1.formatTimeExt(license_event_time.multiplier, 3, false, 3);

                const license_medal = FinalStats.rows.find(r => r.key === "NEW_LICENSE_MEDAL" && r.reward_type === reward);
                q(".timed").style.display = "flex";
                q(".timed").style.position = "absolute";
                q(".stars-container").style.display = "flex";
                let multiplier = license_medal.multiplier;
                for (let i = 1; i <= 3; i++) {
                    const star = q(`#fullstar${i}`);
                    if (star) {
                        if (i >= multiplier) {
                            star.style.opacity = '1';
                        } else {
                            star.style.opacity = '0';
                        }
                    }
                }
            }
        }

        requestStats() {
            console.log("Requesting EndSessionDriverStats");
            //this.dataset.stage = "loading";
            this.Client.request("EndSessionDriverStats", (response) => {
                console.log("Received EndSessionDriverStats", response.response);
                if (response.response == eClientCommands.Response.OK) {
                    this.isDataLoaded = true;
                    q(".main-panel").style.display = "flex";

                    this.assignModel(response, "FinalStats");
                    this.evaluateStats(response);

                    this.assignRows(response, this.wrapperXP, "XP");
                    this.assignRows(response, this.wrapperCredits, "Credits");
                    this.assignRows(response, this.wrapperDistance, "Distance");
                    this.assignRows(response, this.wrapperTyres, "Consumed_Tyre");
                    this.assignRows(response, this.wrapperFuel, "Consumed_Fuel");
                    this.wrapperCredits.rows.sort((a, b) => {
                        return (a.key == "CONSUMED_FUEL" || b.key == "CONSUMED_FUEL") ? -1 : 0;
                    });

                    this.assignModel(this.wrapperXP, "SessionEconomyDataXP");
                    this.assignModel(this.wrapperCredits, "SessionEconomyDataCredits");
                    this.assignModel(this.wrapperDistance, "SessionEconomyDataDistance");
                    this.assignModel(this.wrapperTyres, "SessionEconomyDataTyre");
                    this.assignModel(this.wrapperFuel, "SessionEconomyDataFuel");

                    this.setDrivingAcademyStats();
                    this.setSpecialEventsStats();
                    this.dataset.stage = "done";
                } else {
                    this.dataset.stage = "error";
                }
            });
        }

        evaluateStats(stats) {

            let total_multipliers = 0;

            stats.rows.forEach(row => {
                total_multipliers += row.multiplier;
            });

            this.classList.toggle("zero-xp", stats.total_stats.earned_xp == 0);
            this.classList.toggle("zero-credits", stats.total_stats.earned_credits == 0);
            this.classList.toggle("zero-rank", stats.total_stats.rank == 0);
            this.classList.toggle("zero-wallet", stats.total_stats.wallet == 0);
            this.classList.toggle("zero-multipliers", total_multipliers == 0);

        }

        assignRows(response, wrapper, type) {
            response.rows.forEach(row => {
                if (row.reward_type == `EndSessionDriverStatsRow_${type}`) {
                    wrapper.rows.push(row);
                }
            });
            return wrapper;
        }

        bindControls() {

            window.addEventListener(EngineEvents.UI.InputAction, this.handleInputAction);
        }

        continue() {
            if (SeasonInfo.mode == "ClientCommandsMode_DRIVING_ACADEMY") ;
            ksUI$1.requestGoBack(eGameModeSelection.BackFrom.Stats);
        }

        #internal_handleInputAction;

        handleInputAction(evt) {
            if (evt.detail == "confirm" || evt.detail == "cancel") {
                this.clearAssignedModels();
                this.clearAssignedFilters();

                this.continue();
            }
        }

        onAfterRenderControlHints(controlhints) {

            this.btnContinue = q("ks-btnbasic", controlhints);
            this.mapElementById("btnExit", controlhints);

            if (this.btnContinue) {

                this.btnContinue.onPressed = () => {
                    this.continue();
                };

                waitForFrames(() => {
                    this.btnContinue.focus();
                });
            } else {
                console.warn(this.tagName, "error rendering control hints");
            }

            if (this.btnExit) {
                this.btnExit.onPressed = () => {
                    ksUI$1.requestNoResponse("GameMode", "Exit");
                };

                waitForFrames(() => {
                    this.btnExit.focus();
                });
            } else {
                console.warn(this.tagName, "error rendering control hints");
            }
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.setAttribute("data-bind-ksmessage", "{{FinalStats}}");
            console.log("Displaying Session Summary");
            this.Client = new MessageHandler("TimeTable");

            GAMEMODESELECTION.getSessionInfoParameters().then((data) => {
                this.dataset.mode = data.mode;
                this.dataset.type = data.type;
            });

            this.requestStats();
            this.requestTimeTable();

            document.body.classList.add("spatialnav");

            document.body.classList.add("sessioneconomy");
        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();
            window.removeEventListener(EngineEvents.UI.InputAction, this.handleInputAction);
            document.body.classList.remove("sessioneconomy");
        }

    }
    ksUI$1.registerModule('ks-page-sessioneconomy', SessionEconomy);

    var template$5 = "<div class=\"component-body\">\r\n\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back rounded focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"btnBack\">Back</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"apply focusable\" id=\"apply\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnApply\">Apply</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"cancel focusable\" id=\"cancel\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCancel\">Cancel</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n        <div class=\"group end\">\r\n            <ks-btnbasic class=\"default focusable\" id=\"default\">\r\n                <div slot=\"name\" data-l10n-id=\"btnDefaultSetup\">Default Setup</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"focusable\" id=\"btnPresets\">\r\n                <div slot=\"name\" data-l10n-id=\"lblSetupLoadSave\">Load/Save</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <div class=\"header\">\r\n\r\n        <div id=\"acelogo\">\r\n            <div class=\"session-name\" data-bind-value=\"sessioninfo_session({{ModelUISessionState.session_name}})\">\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n\r\n    <div id=\"panelMain\" class=\"submode-body\" data-mode=\"tyres\">\r\n        <div id=\"panelMenu\" class=\"menu row\">\r\n            <ks-btnbasic id=\"btnTyres\" data-tooltip=\"tooltip_carsetup_Tyres\" class=\"focusable rounded\" toggle-group=\"setup\" data-mode=\"tyres\" toggle>\r\n                <div slot=\"name\" data-l10n-id=\"lblSetupTyres\">Tyres\r\n            </div></ks-btnbasic>\r\n            <ks-btnbasic id=\"btnElectronics\" data-tooltip=\"tooltip_carsetup_Electronics\" class=\"focusable rounded\" toggle-group=\"setup\" data-mode=\"electronics\" toggle disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"lblSetupElectronics\">Electronics\r\n            </div></ks-btnbasic>\r\n            <ks-btnbasic id=\"btnFuelStrategy\" data-tooltip=\"tooltip_carsetup_FuelStrategy\" class=\"focusable rounded\" toggle-group=\"setup\" data-mode=\"fuel\" toggle disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"lblSetupFuelStrategy\">Fuel & Strategy\r\n            </div></ks-btnbasic>\r\n            <ks-btnbasic id=\"btnMechanical\" data-tooltip=\"tooltip_carsetup_Suspension\" class=\"focusable rounded\" toggle-group=\"setup\" data-mode=\"suspension\" toggle disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"lblSuspension\">Suspension\r\n            </div></ks-btnbasic>\r\n            <ks-btnbasic id=\"btnDampers\" data-tooltip=\"tooltip_carsetup_Dampers\" class=\"focusable rounded\" toggle-group=\"setup\" data-mode=\"dampers\" toggle disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"lblSetupDampers\">Dampers\r\n            </div></ks-btnbasic>\r\n            <ks-btnbasic id=\"btnAero\" data-tooltip=\"tooltip_carsetup_Aero\" class=\"focusable rounded\" toggle-group=\"setup\" data-mode=\"aero\" toggle disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"lblSetupAero\">Aero\r\n            </div></ks-btnbasic>\r\n        </div>\r\n\r\n        <div id=\"tyres\" class=\"setup-section is-flex-row\">\r\n            <div class=\"is-flex-column\">\r\n                <ks-setup-infopanel id=\"infoFL\" title=\"labelLastReadings\" wheel-index=\"0\" properties=\"tyre_pressure,omi,tyre_wear,pad_wear,disc_wear\">\r\n                </ks-setup-infopanel>\r\n\r\n                <ks-setup-infopanel id=\"infoRL\" title=\"labelLastReadings\" wheel-index=\"2\" properties=\"tyre_pressure,omi,tyre_wear,pad_wear,disc_wear\">\r\n                </ks-setup-infopanel>\r\n            </div>          \r\n\r\n            <div class=\"is-flex-column\">\r\n                <ks-setup-group id=\"tyresFL\" title=\"labelFrontLeft\" suffix=\"_FL\" properties=\"pressure,toe,camber,caster\">\r\n                </ks-setup-group>\r\n\r\n                <ks-setup-group id=\"tyresRL\" title=\"labelRearLeft\" suffix=\"_RL\" properties=\"pressure,toe,camber\">\r\n                </ks-setup-group>\r\n            </div>\r\n\r\n            <div class=\"deco car-top\">\r\n                <div class=\"layer-top drivetrain\"></div>\r\n                <div class=\"layer-top engine\"></div>\r\n            </div>\r\n\r\n            <div class=\"is-flex-column\">\r\n                <ks-setup-group id=\"tyresFR\" title=\"labelFrontRight\" suffix=\"_FR\" properties=\"pressure,toe,camber,caster\">\r\n                </ks-setup-group>\r\n\r\n                <ks-setup-group id=\"tyresRR\" title=\"labelRearRight\" suffix=\"_RR\" properties=\"pressure,toe,camber\">\r\n                </ks-setup-group>\r\n            </div>\r\n\r\n\r\n            <div class=\"is-flex-column\">\r\n                <ks-setup-infopanel id=\"infoFR\" title=\"labelLastReadings\" wheel-index=\"1\" properties=\"tyre_pressure,imo,tyre_wear,pad_wear,disc_wear\">\r\n                </ks-setup-infopanel>\r\n\r\n                <ks-setup-infopanel id=\"infoRR\" title=\"labelLastReadings\" wheel-index=\"3\" properties=\"tyre_pressure,imo,tyre_wear,pad_wear,disc_wear\">\r\n                </ks-setup-infopanel>\r\n            </div>\r\n        </div>\r\n\r\n        <div id=\"electronics\" class=\"setup-section is-flex-row\">\r\n\r\n            <ks-setup-group id=\"groupElectronics\" title=\"lblSetupElectronics\" customvalues_ers_heat_charging=\"mguh_Deploy,mguh_Charge\" offset_engine_map=\"1\" offset_ers_deployment_map=\"1\" properties=\"tc1,tc2,abs,esc,engine_map,turbo_boost_lv,ers_deployment_map,ers_recharge_lv,ers_heat_charging\">\r\n            </ks-setup-group>\r\n\r\n            <!-- <div class=\"parameter-guide is-flex-column\">\r\n                <div class=\"title is-flex-row justify-content-center\" data-l10n-id=\"lblTrackConditionsParameters\"></div>\r\n                <div class=\"legend is-flex-row\">\r\n                    <div></div>\r\n                    <div data-l10n-id=\"lblTrackOptimum\"></div>\r\n                    <div data-l10n-id=\"lblTrackGreen\"></div>\r\n                    <div data-l10n-id=\"lblTrackMedium\"></div>\r\n                    <div data-l10n-id=\"lblTrackDamp\"></div>\r\n                    <div class=\"pAbsolute gradient\"></div>\r\n                    <div data-l10n-id=\"lblTrackWet\"></div>\r\n\r\n                </div>\r\n                <div class=\"row is-flex-row\">\r\n                    <div data-l10n-id=\"labelSetup-tc\"></div>\r\n                    <div>0-2</div>\r\n                    <div>3-6</div>\r\n                    <div>4-7</div>\r\n                    <div>6-8</div>\r\n                    <div>8-12</div>\r\n                </div>\r\n                <div class=\"row is-flex-row\">\r\n                    <div data-l10n-id=\"labelSetup-tc2\"></div>\r\n                    <div>0-2</div>\r\n                    <div>3-6</div>\r\n                    <div>4-7</div>\r\n                    <div>6-8</div>\r\n                    <div>8-12</div>\r\n                </div>\r\n                <div class=\"row is-flex-row\">\r\n                    <div data-l10n-id=\"labelSetup-abs\"></div>\r\n                    <div>0-2</div>\r\n                    <div>3-6</div>\r\n                    <div>4-7</div>\r\n                    <div>6-8</div>\r\n                    <div>8-12</div>\r\n                </div>\r\n                <div class=\"row is-flex-row\">\r\n                    <div data-l10n-id=\"labelSetup-ecu\"></div>\r\n                    <div>0-2</div>\r\n                    <div>3-6</div>\r\n                    <div>4-7</div>\r\n                    <div>6-8</div>\r\n                    <div>8-12</div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- <div class=\"deco car-side\"></div> -->\r\n        </div> \r\n\r\n        <div id=\"fuel\" class=\"setup-section is-flex-row\">\r\n            <ks-setup-group id=\"groupFuel\" title=\"lblSetupFuelStrategy\" properties=\"fuel,compound_FL,compound_RL\">\r\n            </ks-setup-group>\r\n            \r\n        </div>\r\n\r\n        <div id=\"suspension\" class=\"setup-section is-flex-column\">\r\n\r\n            <div class=\"is-flex-column\">\r\n                <ks-setup-group id=\"suspensionF\" title=\"labelFront\" suffix=\"\" properties=\"arbs0,brakestorque_multiplier,brakesfront_bias,steer_ratio\">\r\n                </ks-setup-group>\r\n            </div>\r\n\r\n            <div class=\"is-flex-row\">\r\n\r\n                <div class=\"is-flex-column\">\r\n                    <ks-setup-group id=\"suspensionFL\" title=\"labelFrontLeft\" suffix=\"_FL\" properties=\"wheel_rate,bump_stop_uprate,bump_stop_uprange\">\r\n                    </ks-setup-group>\r\n\r\n                    <ks-setup-group id=\"suspensionRL\" title=\"labelRearLeft\" suffix=\"_RL\" properties=\"wheel_rate,bump_stop_uprate,bump_stop_uprange\">\r\n                    </ks-setup-group>\r\n                </div>\r\n\r\n                <div class=\"deco car-top\">\r\n                    <div class=\"layer-top drivetrain\"></div>\r\n                    <div class=\"layer-top engine\"></div>\r\n                </div>\r\n\r\n                <div class=\"is-flex-column\">\r\n                    <ks-setup-group id=\"suspensionFR\" title=\"labelFrontRight\" suffix=\"_FR\" properties=\"wheel_rate,bump_stop_uprate,bump_stop_uprange\">\r\n                    </ks-setup-group>\r\n\r\n                    <ks-setup-group id=\"suspensionRR\" title=\"labelRearRight\" suffix=\"_RR\" properties=\"wheel_rate,bump_stop_uprate,bump_stop_uprange\">\r\n                    </ks-setup-group>\r\n                </div>\r\n            </div>\r\n\r\n            <div class=\"is-flex-column\">\r\n                <ks-setup-group id=\"suspensionR\" title=\"labelRear\" properties=\"arbs1,differentialpreload,differentialcoast,differentialpower\">\r\n                </ks-setup-group>\r\n            </div>\r\n\r\n\r\n        </div>\r\n\r\n        <div id=\"dampers\" class=\"setup-section is-flex-row\">\r\n\r\n            <div class=\"is-flex-column\">\r\n                <ks-setup-group id=\"damperFL\" title=\"labelFrontLeft\" suffix=\"_FL\" properties=\"slow_bump,slow_rebound,fast_bump,fast_rebound\">\r\n                </ks-setup-group>\r\n\r\n                <ks-setup-group id=\"damperRL\" title=\"labelRearLeft\" suffix=\"_RL\" properties=\"slow_bump,slow_rebound,fast_bump,fast_rebound\">\r\n                </ks-setup-group>\r\n            </div>\r\n\r\n            <div class=\"deco car-top\">\r\n                <div class=\"layer-top drivetrain\"></div>\r\n                <div class=\"layer-top engine\"></div>\r\n            </div>\r\n\r\n            <div class=\"is-flex-column\">\r\n                <ks-setup-group id=\"damperFR\" title=\"labelFrontRight\" suffix=\"_FR\" properties=\"slow_bump,slow_rebound,fast_bump,fast_rebound\">\r\n                </ks-setup-group>\r\n\r\n                <ks-setup-group id=\"damperRR\" title=\"labelRearRight\" suffix=\"_RR\" properties=\"slow_bump,slow_rebound,fast_bump,fast_rebound\">\r\n                </ks-setup-group>\r\n            </div>\r\n\r\n\r\n        </div>\r\n\r\n        <div id=\"aero\" class=\"setup-section is-flex-row\">\r\n            <div class=\"is-flex-column\">\r\n                <ks-setup-group id=\"aeroRear\" title=\"labelRear\" properties=\"rear_target_height,rear_wing_angle,brake_duct\">\r\n                </ks-setup-group>\r\n            </div>\r\n\r\n            <div class=\"deco car-side\">\r\n                <div class=\"layer-side front-wing\"></div>\r\n                <div class=\"layer-side rear-wing\"></div>\r\n            </div>\r\n\r\n            <div class=\"is-flex-column\">\r\n                <ks-setup-group id=\"aeroFront\" title=\"labelFront\" properties=\"front_target_height,front_wing_angle,brake_duct\">\r\n                </ks-setup-group>\r\n            </div>\r\n        </div>\r\n\r\n\r\n\r\n    </div>\r\n</div>";

    var template$4 = "<div>\r\n    <div class=\"panelTitle\">Title</div>\r\n</div>";

    class SetupInfoPanel extends KsHTMLElement {

        /** @type HTMLDivElement */
        elementBody;

        /** @type HTMLDivElement */
        panelTitle;

        properties = [];
        datasource = {};


        /** @typedef {import('./vehiclesetup').default} VehicleSetupPage */
        /** @type { VehicleSetupPage } */
        rootPage;
        

        constructor() {
            super();
            this.template = template$4;
            this.delayedInit = true;
        }
        
        

       populate() { 
        qAllArray(".row", this.elementBody).forEach(item => {
            this.elementBody.removeChild(item);
        });
        
        const formatNumber = (num) => {
            return (typeof num === "number") ? num.toFixed(1) : num;
        };

        this.properties.forEach(property => {
            const source = this.datasource[property];   
            let value = "";

            if (property === "omi") {
            value = `${formatNumber(this.datasource.tyre_temp_l)} - ` +
                    `${formatNumber(this.datasource.tyre_temp_c)} - ` +
                    `${formatNumber(this.datasource.tyre_temp_r)}`;
            } else if (property === "imo") {
            value = `${formatNumber(this.datasource.tyre_temp_r)} - ` +
                    `${formatNumber(this.datasource.tyre_temp_c)} - ` +
                    `${formatNumber(this.datasource.tyre_temp_l)}`;
            } else {
            switch (typeof source) {
                case "object":
                value = Array.isArray(source)
                    ? source.map(formatNumber).join(" / ")
                    : "";
                break;
                case "undefined":
                value = "--";
                break;
                default:
                value = formatNumber(source);
            }
            }
            const row = document.createElement("div");
            row.className = "row";
            row.innerHTML = `<div>${engine.translate("labelSetup-" + property)}</div><div>${value}</div>`;
            this.elementBody.appendChild(row);
        });
    }

        bindControls() {
            engine.on(EngineEvents.VehicleSetup.Init, () => {
                //console.log(`[SetupInfoPanel ${this.id}] received VehicleSetup.Init`);
                this.populate();
            });
        }

        onRemovedFromDOM() {
        }
        
        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.elementBody = this.firstChild;
            this.properties = this.getAttribute("properties").split(",");

            this.mapElementByClass("panelTitle");
            if (this.hasAttribute("title")) {
                this.panelTitle.innerHTML = engine.translate(this.getAttribute("title"));
            }

            
        }


    }

    ksUI$1.registerModule('ks-setup-infopanel', SetupInfoPanel);

    class SetupGroupPanel extends KsHTMLElement {

        /** @type HTMLDivElement */
        elementBody;

        /** @type HTMLDivElement */
        panelTitle;

        offsets = [];
        properties = [];
        datasource = {};

        /** @typedef {import('./vehiclesetup').default} VehicleSetupPage */
        /** @type { VehicleSetupPage } */
        rootPage;

        UNIT_RULES = {
            fuel: { unit: 'L' },

            pressure: { unit: 'PSI' },
            toe: { unit: '' },
            camber: { unit: '' },
            caster: { unit: '' },

            arbs0: { unit: 'N/m' },
            arbs1: { unit: 'N/m' },
            brakesfront_bias: { unit: '%' },
            wheel_rate: { unit: 'N/m' },
            bump_stop_uprate: { unit: 'N' },
            bump_stop_uprange: { unit: 'mm', scale: 1000 },
            differentialpreload: { unit: 'N/m' },
            differentialcoast: { unit: '%' },
            differentialpower: { unit: '%' },

            slow_bump: { unit: 'Ns/m' },
            slow_rebound: { unit: 'Ns/m' },
            fast_bump: { unit: 'Ns/m' },
            fast_rebound: { unit: 'Ns/m' },

            front_target_height: { unit: 'mm' },
            rear_target_height: { unit: 'mm' }
        };

        constructor() {
            super();
            this.template = template$4;
            this.delayedInit = true;
        }

        bindControls() {

            engine.on(EngineEvents.VehicleSetup.Init, () => {
                //console.warn(this.id, "SETUP INIT");
                this.populate();
            });

        }

        get suffix() {
            return this.getAttribute("suffix") || "";
        }

        set suffix(value) {
            this.setAttribute("suffix", value);
        }

        populate() {
            qAllArray(".row", this.elementBody).forEach(item => {
                this.elementBody.removeChild(item);
            });

            let hasContent = false;

            this.properties.forEach((property, property_index) => {

                const id = `${property}${this.suffix}`;

                
                const is_supported = this.rootPage.activeSettings.indexOf(id) > -1;
                
                if (!is_supported) {
                    //console.log(id, "not supported");           
                    return;
                }
                
                this.rootPage.enableSetupSection(property);
                
                const state = this.rootPage.getSliderState(id);
                
                //console.warn(id, "supported", is_supported, this.rootPage.availableSettings.length);
                
                if (this.rootPage.singleCompound && property === "compound_RL") {           
                    return;
                }

                let min = state.min;
                let max = state.max;
                let step = state.step;
                let value = state.value;
                let unit = state.unit;
                state.hide_value; // Fernando says this should be used to hide the units actually for properties that are in clicks
                let fromcenter = Math.abs(state.min) == Math.abs(state.max);

                //console.log(state.name);

                if (!state.is_active || state.min == state.max) {
                    return false;
                }

                hasContent = true;

                let precision = Math.max(0, ksUI$1.getNonZeroDecimalPosition(state.step));// 4; //state.precision;

                const row = document.createElement("div");
                const source = this.datasource[property];
                row.className = "row";
                const label_key = (this.rootPage.singleCompound && property === "compound_FL")
                    ? "labelSetup-tyres_compound"
                    : "labelSetup-" + property;
                row.innerHTML = "<div>" + engine.translate(label_key) + "</div>";            
                let htmlOut = "";

                switch (typeof source) {
                    case "object":
                        if (Array.isArray(source)) {
                            htmlOut = source.join(" / ");
                        } else {
                            console.warn(this.tagName, "cannot handle this type of datasource");
                            htmlOut = "";
                        }
                        break;
                    case "undefined": {
                        htmlOut = `<ks-slider class="oneline focusable" 
                    data-tooltip="tooltip_carsetup_${id}"
                    precision="${precision}" 
                    step="${step}" 
                    min="${min}" max="${max}" 
                    unit="${unit}"
                    value="${value}" 
                    data-setting="${id}" ${fromcenter ? "fromcenter" : ""} ${is_supported ? "" : "disabled"}><div class="unit"></div></ks-slider>`;
                        break;
                    }
                    default:
                        htmlOut = this.datasource[property];
                }

                row.innerHTML += htmlOut;
                this.elementBody.appendChild(row);

                /** @type {KsSlider} */
                const slider = q("ks-slider", row);
                slider.setting = this.rootPage.getSliderState(id);

                const offset_attrib = `offset_${property}`;

                if (this.hasAttribute(offset_attrib)) {
                    slider.valueFilter = (value_to_filter) => {
                        let number_to_show = Number(value_to_filter);
                        return number_to_show + Number(this.getAttribute(offset_attrib));
                    };
                }

                const customvalues_attrib = `customvalues_${property}`;

                if (this.hasAttribute(customvalues_attrib)) {
                    const customvalues = this.getAttribute(customvalues_attrib).split(",");
                    slider.valueFilter = (value_to_filter) => {
                        if (customvalues[slider.index]) {
                            return engine.translate(customvalues[slider.index]);
                        }
                        return value_to_filter;
                    };
                }

                // const rule = this.UNIT_RULES[property];
                // if (rule) {
                //     if (hide_value) {
                //         rule.unit = null;
                //     }
                //     const basePrecision = Math.max(0, ksUI.getNonZeroDecimalPosition(state.step));
                //     slider.valueFilter = (raw) => {
                //         const n = Number(raw);
                //         if (!Number.isFinite(n)) return String(raw);
                //         let v = n;
                //         if (rule.scale) v *= rule.scale;
                //         const p = ('precision' in rule) ? rule.precision : basePrecision;
                //         const txt = v.toFixed(p);
                //         return txt;
                //     };

                //     slider.slider?.setup();


                // }

                waitForFrames(() => {
                    slider.unit = unit;
                }, 1);

                if (id == "compound_FL") {                
                    max = this.rootPage.frontCompounds.length - 1;
                    slider.valueFilter = (value_to_filter) => {
                        return this.rootPage.frontCompounds[value_to_filter];
                    };
                }
                if (id == "compound_RL") {                
                    max = this.rootPage.rearCompounds.length - 1;
                    slider.valueFilter = (value_to_filter) => {
                        return this.rootPage.rearCompounds[value_to_filter];
                    };
                }
            });

            if (!hasContent) {
                this.panelTitle.style.display = "none";
            } else {
                this.panelTitle.style.display = "";
            }

            activePage.setupNavigation();

            waitForFrames(() => {
                qevAll("ks-slider", "onSliderValueChanged", (ev) => {
                    if (this.rootPage?.loading) return;
                    const detail = ev.detail;
                    const sender = detail.sender;
                    const value = detail.value;
                    sender.setting.value = value;

                    if (this.rootPage.singleCompound && sender.dataset.setting === `compound_FL${this.suffix}`) {
                        const rearId = `compound_RL${this.suffix}`;
                        const rearState = this.rootPage.getSliderState(rearId);
                        if (rearState) rearState.value = value;
                    }

                    this.rootPage?.markDirty();
                    this.rootPage?.applySliderStates().then(() => {
                        console.log(this.tagName, sender.dataset.setting, value);
                    });

                }, this);
            }, 3);

        }

        onRemovedFromDOM() {
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.elementBody = this.firstChild;

            this.properties = this.getAttribute("properties").split(",");

            if (this.hasAttribute("offsets")) {
                this.offsets = this.getAttribute("offsets").split(",");
                this.offsets.forEach((offset, index) => this.offsets[index] = Number(offset));
            }


            this.mapElementByClass("panelTitle");

            if (this.hasAttribute("title")) {
                this.panelTitle.innerHTML = engine.translate(this.getAttribute("title"));
            }
            // console.log(this.id, this.tagName, this.rootPage.tagName);
        }


    }

    ksUI$1.registerModule('ks-setup-group', SetupGroupPanel);

    class VehicleSetupPage extends KsHTMLElement {

        isDirty = false;
        loading = false;
        saveDebounce = { id: 0 };

        initialState = [];

        activeSettings = [];
        availableSettings = [];
        sliderState = {};

        frontCompounds = [];
        rearCompounds = [];
        singleCompound;

        buttonMappings = {
            electronics: "btnElectronics",
            fuel: "btnFuelStrategy",
            suspension: "btnMechanical",
            dampers: "btnDampers",
            aero: "btnAero"
        };
        enabledSections = {};

        /** @type MessageHandler */
        Client;

        panelMenu;
        panelMain;

        /** @type Btnbasic */
        btnBack;
        /** @type Btnbasic */
        btnCancel;
        /** @type Btnbasic */
        btnApply;
        /** @type Btnbasic */
        btnPresets;
        /** @type Btnbasic */
        btnDefaultSetup;



        constructor() {
            super();
            this.template = template$5;
            this.shouldRenderControlHints = true;
            this._exposeAsActivePage = true;
            this._isnavigable = true;
            this.delayedInit = true;
            this.Client = new MessageHandler("CarSetup");
        }

        get initialCarSetup() {
            return message("CarSetupUIData", {
                sliders: this.initialState
            });

        }

        get carSetup() {
            return message("CarSetupUIData", {
                sliders: this.sliderState
            });
        }

        canClosePage(sender, path) {
            this.documentBody.classList.add("ui-locked");
            this.Client.request("Close", (response) => {
                if (response.can_exit) {
                    this.documentBody.classList.remove("ui-locked");
                    ksUI$1.changePage(path);
                } else {
                    this.documentBody.classList.remove("ui-locked");
                    console.error("Setup has not fully converged");
                }
            });
        }

        bindControls() {

            qAll("ks-btnbasic", this.panelMenu).forEach(
                /** @param Btnbasic */
                btn => {

                    btn.onToggled = (sender, e, state) => {
                        if (state) {

                            this.removeAttribute("mode-transition");
                            waitForFrames(() => {
                                this.setAttribute("mode-transition", "");
                            }, 3);

                            if (this.dataset.mode == btn.dataset.mode) return;
                            this.dataset.mode = btn.dataset.mode;
                            ksUI$1.menuState.get().activeSubMenu = this.dataset.mode;

                            qAll("#" + this.dataset.mode + " ks-slider").forEach(elem => elem.slider.setup());

                        }
                    };
                });
        }

        applyDefaultSetup() {
            this.Client.request("LoadDefault",
                (response) => {
                    ({
                        [eCommandResponse.OK]: () => {
                            console.log("Default setup Loaded!");
                            ksUI$1.waitForFrames(() => {
                                this.init();
                                this.clearDirty();
                            }, 3);
                        },
                        [eCommandResponse.Failed]: () => {
                            console.error("Failed to load default setup!");
                        }
                    }[response.response])();
                });
        }

        onRemovedFromDOM() {
            console.log("removed vehiclesetup");
            ksUI$1.menuState.ignoreInputActions(false);
            document.body.classList.remove("vehiclesetup");
        }

        storeInitialState() {
            this.initialState = this.sliderState.map(i => { return { ...i } });
        }

        restoreInitialState() {
            this.sliderState = this.initialState.map(i => { return { ...i } });
        }

        markDirty() {
            this.isDirty = true;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.removeAttribute("disabled");
            });
        }

        clearDirty() {
            this.isDirty = false;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.setAttribute("disabled", true);
            });
        }

        apply() {
            console.log(this.tagName, "applied");
            this.applySliderStates(this.carSetup, 1, false).then(
                () => {
                    this.storeInitialState();
                    this.clearDirty();
                }
            );
        }

        reset() {
            console.log(this.tagName, "reset");
            this.clearDirty();
            this.restoreInitialState();
            //this.classList.add("cancel");
            //this.loading = true;
            this.applySliderStates(this.initialCarSetup, 3, false).then(() => {
                engine.trigger(EngineEvents.VehicleSetup.Init);
                waitForFrames(() => {
                    //this.classList.remove("cancel");
                    //this.loading = false;
                }, 3);
                this.clearDirty();
            });
        }

        applySliderStates(datasource = this.carSetup, debouncetimer = 6, markdirty = true) {
            return new Promise((resolve) => {
                cancelAnimationFrame(this.saveDebounce.id);
                waitForFrames(() => {
                    console.log("applying", datasource);
                    ksUI$1.jiggleMouse();
                    this.Client.request("Apply", {
                        car_setup: datasource
                    }, (data) => {
                        console.warn(data);
                        if (markdirty)
                            this.markDirty();

                        resolve();
                        console.log("applied", datasource);
                    });

                }, debouncetimer, this.saveDebounce);
            });
        }

        getSliderState(name) {
            return this.sliderState.find(slider => slider.name == name);
        }

        onAfterRenderControlHints(controlhints) {
            this.btnBack = q(".back", controlhints);
            this.btnPresets = q("#btnPresets", controlhints);
            this.btnApply = q(".apply", controlhints);
            this.btnCancel = q(".cancel", controlhints);
            this.btnDefaultSetup = q(".default", controlhints);

            this.btnApply.onPressed = () => {
                this.apply();
            };

            this.btnCancel.onPressed = () => this.reset();

            let sender = this;

            const changePage = function (page, path, close) {
                if (sender.isDirty) {

                    sender.pageModal.Show({
                        title: "lblChangesDetected",
                        message: "msgChangesWarning",
                        confirm: "btnApply"
                    });

                    sender.pageModal.onDiscard = () => {
                        sender.reset();

                        sender.canClosePage(sender, path);

                    };

                    sender.pageModal.onConfirm = () => {
                        sender.apply();
                        sender.canClosePage(sender, path);
                    };

                } else {
                    sender.canClosePage(sender, path);
                }

            };

            this.btnBack.onPressed = () => {
                changePage("ingame.html", "pitlane/main");
            };

            this.btnPresets.onPressed = () => {
                changePage("ingame.html", "presets/" + ksUI$1.menuState.get().activeSubMenu);
            };

            this.btnDefaultSetup.onPressed = () => {
                sender.pageModal.Show({
                    type: eModalDialogTypes.Warning,
                    title: "lblDefaultSetupWarning",
                    message: "msgDefaultSetupWarning",
                    confirm: "btnApply",
                    buttons: 0x101
                });

                this.pageModal.onConfirm = () => {
                    this.applyDefaultSetup();
                };

            };
        }

        enableSetupSection(property) {
            for (const [section] of Object.entries(this.buttonMappings)) {
                const section_element = document.getElementById(section);
                if (section_element.contains(q(`[properties*="${property}"]`))) {
                    this.enabledSections[section] = true;
                    break;
                }
            }
            for (const [section, is_enabled] of Object.entries(this.enabledSections)) {
                if (is_enabled) {
                    const elem = document.getElementById(this.buttonMappings[section]);
                    if (elem) {
                        elem.removeAttribute("disabled");
                    }
                }
            }
        }

        init() {
            this.loading = true;
            console.log("CarSetupRequestInit");
            this.Client.request("Init", (data) => {


                console.log("CarSetupResponseInit");
                console.trace(data);
                
                this.activeSettings.length = 0;
                this.availableSettings.length = 0;

                this.frontCompounds = [...data.tyres_runtime_settings.front_compounds];
                this.rearCompounds = [...data.tyres_runtime_settings.rear_compounds];
                this.singleCompound = data.use_single_compound;

                data.state.car_setup.sliders.forEach(slider => {

                    if (slider.is_active) {
                        this.activeSettings.push(slider.name);
                    }

                    this.availableSettings.push(slider.name);
                });

                console.log("Settings active/available:", this.activeSettings.length, "/", this.availableSettings.length);

                this.activeSettings.sort();
                this.availableSettings.sort();

                this.sliderState = data.state.car_setup.sliders;
                this.storeInitialState();

                qAll("ks-setup-infopanel").forEach(panel => {
                    panel.rootPage = this;
                    const wheelIndex = parseInt(panel.getAttribute("wheel-index"));
                    const readings = data.readings;
                    const wheelData = {};
                    Object.keys(readings).forEach(prop => {
                        wheelData[prop] = readings[prop][wheelIndex];
                    });
                    panel.datasource = wheelData;
                });

                waitForFrames(() => {
                    engine.trigger(EngineEvents.VehicleSetup.Init);
                }, 1);
                
                waitForFrames(() => {
                    this.documentBody.classList.remove("ui-locked");
                    this.loading = false;
                }, 60);

                console.trace(data);

                if (this.availableSettings.includes("front_target_height") || this.availableSettings.includes("front_wing_angle")) {
                    q('.front-wing').style.visibility = "visible";    
                    q('.front-wing').style.backgroundImage = 'url(/images/carsetup/common-car_side-front-aero.svg)';                
                }

                if (this.availableSettings.includes("rear_target_height") || this.availableSettings.includes("rear_wing_angle")) {
                    q('.rear-wing').style.visibility = "visible";    
                    q('.rear-wing').style.backgroundImage = 'url(/images/carsetup/common-car_side-rear-aero.svg)';
                }  

            });
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            document.body.classList.add("vehiclesetup");
            ksUI$1.menuState.ignoreInputActions(true);

            this.mapElementById("panelMain");
            this.mapElementById("panelMenu");

            this.dataset.mode = ksUI$1.menuState.get().activeSubMenu;
            q(`ks-btnbasic[data-mode=${this.dataset.mode}]`, this.panelMenu).classList.add("selected");

            this.documentBody.classList.add("ui-locked");

            this.init();

            VEHICLES.getCurrent().then(data => {   
                const subs = data.model.sub_categories;

                const engine =
                subs.some(s => s.categories.includes('CarCategoryEnum_front_engine')) ? 'front': 
                subs.some(s => s.categories.includes('CarCategoryEnum_mid_engine')) ? 'mid': 
                subs.some(s => s.categories.includes('CarCategoryEnum_rear_engine')) ? 'rear':
                subs.some(s => s.categories.includes('CarCategoryEnum_battery')) ? 'ev': 
                null;

                const drivetrain =
                subs.some(s => s.categories.includes('CarCategoryEnum_rwd')) ? 'rwd' :
                subs.some(s => s.categories.includes('CarCategoryEnum_fwd')) ? 'fwd' :
                subs.some(s => s.categories.includes('CarCategoryEnum_awd')) ? 'awd' :
                null;

                const map = {
                    fwd: "drivetrain_fwd.svg",
                    rwd: "drivetrain_rwd.svg",
                    awd: "drivetrain_awd.svg",
                    front: "engine_front.svg",
                    mid: "engine_mid.svg",
                    rear: "engine_rear.svg",
                    ev: "engine_ev.svg"
                };

                if (subs.some(s => s.categories.includes('CarCategoryEnum_formula'))) {
                    qAll('.car-top').forEach(elem => {
                        elem.style.backgroundImage = 'url(/images/carsetup/formula-car_top.svg)';
                    });
                    qAll('.car-side').forEach(elem => {
                        elem.style.backgroundImage = 'url(/images/carsetup/formula-car_side.svg)';
                    });
                    qAll('.layer-side').forEach(elem => {
                        elem.style.display = 'none';
                    });
                } else {
                    qAll('.drivetrain').forEach(elem => {
                        elem.style.backgroundImage = `url('/images/carsetup/${map[drivetrain]}')`;
                    });
                    qAll('.engine').forEach(elem => {
                        elem.style.backgroundImage = `url('/images/carsetup/${map[engine]}')`;
                    });                       
                }
            });
        }

    }

    ksUI$1.registerModule('ks-page-vehiclesetup', VehicleSetupPage);

    var template$3 = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back focusable\"></ks-btnbasic>\r\n            <ks-btnbasic class=\"apply focusable\" id=\"apply\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnApply\">Apply</div>\r\n            </ks-btnbasic>\r\n            <ks-btnbasic class=\"cancel focusable\" id=\"cancel\" disabled=\"true\">\r\n                <div slot=\"name\" data-l10n-id=\"btnCancel\">Cancel</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n\r\n        <div class=\"group center\"></div>\r\n\r\n        <div class=\"group end\">\r\n            <ks-btnbasic class=\"default focusable\">\r\n                <div slot=\"name\" data-l10n-id=\"btnDefault\">Default Presets</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <div id=\"acelogo\"></div>\r\n\r\n    <ks-pageheader class=\"minimal\">\r\n        <div slot=\"label\">\r\n            <div data-l10n-id=\"lblheaderViewSettings\">ViewSettings</div>\r\n        </div>\r\n    </ks-pageheader>\r\n\r\n    <div id=\"btnGroupModes\" class=\"is-flex-row\">\r\n        <div class=\"controltip\">\r\n\r\n        </div>\r\n        <ks-btnbasic class=\"focusable selected\" data-mode=\"camera\" toggle-group=\"switch\" data-name=\"camera\" toggle>\r\n            <div slot=\"name\" data-l10n-id=\"lblViewSettingsCamera\">Camera</div>\r\n        </ks-btnbasic>\r\n        <ks-btnbasic class=\"focusable\" data-mode=\"motion\" toggle-group=\"switch\" data-name=\"motion\" toggle>\r\n            <div slot=\"name\" data-l10n-id=\"lblViewSettingsMotion\">Motion</div>\r\n        </ks-btnbasic>\r\n        <ks-btnbasic class=\"focusable\" data-mode=\"wheel\" toggle-group=\"switch\" data-name=\"wheel\" toggle>\r\n            <div slot=\"name\" data-l10n-id=\"lblViewSettingsWheel\">Wheel & Dash</div>\r\n        </ks-btnbasic>\r\n        <ks-btnbasic class=\"focusable\" data-mode=\"mirrors\" toggle-group=\"switch\" data-name=\"mirrors\" toggle>\r\n            <div slot=\"name\" data-l10n-id=\"lblViewSettingsMirrors\">Mirrors</div>\r\n        </ks-btnbasic>\r\n        <ks-btnbasic class=\"focusable\" data-mode=\"triplescreen\" toggle-group=\"switch\" data-name=\"triplescreen\" toggle>\r\n            <div slot=\"name\" data-l10n-id=\"lblViewSettingsTripleScreen\">Triple Screen</div>\r\n        </ks-btnbasic>\r\n        <div class=\"controltip\">\r\n\r\n        </div>\r\n    </div>\r\n\r\n    <div id=\"panelModes\" class=\"view-settings\">\r\n\r\n        <!-- CAMERA SETTINGS -->\r\n\r\n        <div class=\"group-camera settings\" data-mode=\"camera\">\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsCamera.seat_height}}\" min=\"-25\" step=\"1\" max=\"25\" data-setting=\"camera\" data-option=\"seat_height\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsSeatHeight\">Height</div>\r\n                <div slot=\"unit\">cm</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsCamera.seat_lateral}}\" min=\"-25\" step=\"1\" max=\"25\" data-setting=\"camera\" data-option=\"seat_lateral\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsSeatLateral\">Lateral</div>\r\n                <div slot=\"unit\">cm</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsCamera.seat_distance}}\" min=\"-60\" step=\"1\" max=\"60\" data-setting=\"camera\" data-option=\"seat_distance\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsSeatDistance\">Distance</div>\r\n                <div slot=\"unit\">cm</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsCamera.fov}}\" min=\"10\" step=\"1\" max=\"90\" data-setting=\"camera\" data-option=\"fov\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsFOV\">FOV</div>\r\n                <div slot=\"unit\"></div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsCamera.seat_pitch}}\" min=\"-20\" step=\"1\" max=\"20\" data-setting=\"camera\" data-option=\"seat_pitch\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsSeatPitch\">Pitch</div>\r\n                <div slot=\"unit\"></div>\r\n            </ks-slider>\r\n        </div>\r\n\r\n        <!-- MOTION SETTINGS   -->\r\n\r\n        <div class=\"group-motion settings\" data-mode=\"motion\">\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsMotion.horizon_lock}}\" min=\"0\" step=\"1\" max=\"100\" data-setting=\"motion\" data-option=\"horizon_lock\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsLockToHorizon\">Lock To Horizon</div>\r\n                <div slot=\"unit\">%</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsMotion.general_movement}}\" min=\"0\" step=\"1\" max=\"100\" data-setting=\"motion\" data-option=\"general_movement\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsMovement\">Movement</div>\r\n                <div slot=\"unit\">%</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsMotion.dashcam_factor}}\" min=\"0\" step=\"1\" max=\"100\" data-setting=\"motion\" data-option=\"dashcam_factor\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsDashcamFactor\">Dashcam Factor</div>\r\n                <div slot=\"unit\">%</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsMotion.bonnet_factor}}\" min=\"0\" step=\"1\" max=\"100\" data-setting=\"motion\" data-option=\"bonnet_factor\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsBonnetFactor\">Bonnet Factor</div>\r\n                <div slot=\"unit\">%</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsMotion.look_with_steer_gain}}\" min=\"0\" step=\"1\" max=\"100\" data-setting=\"motion\" data-option=\"look_with_steer_gain\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsLookWithWheel\">Look With Wheel</div>\r\n                <div slot=\"unit\">%</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsMotion.look_with_steer_gamma}}\" min=\"0\" step=\"1\" max=\"100\" data-setting=\"motion\" data-option=\"look_with_steer_gamma\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsLWWGamma\">LWW Gamma</div>\r\n                <div slot=\"unit\">%</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsMotion.look_with_steer_smoothing}}\" min=\"0\" step=\"1\" max=\"100\" data-setting=\"motion\" data-option=\"look_with_steer_smoothing\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsLWWSmooth\">LWW Smooth</div>\r\n                <div slot=\"unit\">%</div>\r\n            </ks-slider>\r\n        </div>\r\n\r\n        <!-- WHEEL & DASH SETTINGS  -->\r\n\r\n        <div class=\"group-wheel settings\" data-mode=\"wheel\">\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsDash.visibility}}\" values='[\"SeatVisibility_AllVisible\",\"SeatVisibility_HideDriver\",\"SeatVisibility_LockSteeringWheel\", \"SeatVisibility_HideSteeringWheel\"]' data-setting=\"dash\" data-option=\"visibility\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsVisibility\">Visibility</div>\r\n                <div slot=\"unit\"></div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{ViewSettingsDash.halo_visibility}}\" values='[\"HaloVisibility_Hidden\",\"HaloVisibility_Visible\"]' data-setting=\"dash\" data-option=\"halo_visibility\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsHaloVisibility\">Halo Visibility</div>\r\n                <div slot=\"unit\"></div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline toggle focusable\" data-bind-ksvalue=\"{{ViewSettingsDash.render_dash_display}}\" values='[\"optionOff\",\"optionOn\"]' data-setting=\"dash\" data-option=\"render_dash_display\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsDashboardDisplayInHUD\">Dashboard Display in HUD</div>\r\n                <div slot=\"unit\"></div>\r\n            </ks-slider>\r\n            <!-- <ks-slider\r\n                class=\"oneline focusable\"\r\n                data-bind-ksvalue=\"{{ViewSettingsDash.dash_display_transparency}}\"\r\n                min=\"0\"\r\n                step=\"0.01\"\r\n                precision=\"2\"\r\n                max=\"1\"\r\n                data-setting=\"dash\"\r\n                data-option=\"dash_display_transparency\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsDashboardVisibility\">Dashboard Display Transparency</div>\r\n                <div slot=\"unit\">%</div>\r\n            </ks-slider> -->\r\n        </div>\r\n\r\n        <!-- MIRRORS -->\r\n        <div class=\"group-mirrors settings\" data-mode=\"mirrors\">\r\n            <div class=\"virtual-mirror\">\r\n                <ks-slider class=\"oneline toggle focusable mirror-disable\" data-bind-ksvalue=\"{{ViewSettingsMirrors.virtual_mirror_enabled}}\" values='[\"optionOff\",\"optionOn\"]' data-setting=\"mirrors\" data-option=\"virtual_mirror_enabled\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsVMEnable\">Virtual Mirror Switch</div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable virtual-mirror-slider\" data-bind-ksvalue=\"{{ViewSettingsMirrors.single_mode_fov}}\" min=\"-30\" step=\"1\" max=\"50\" data-setting=\"mirrors\" data-option=\"single_mode_fov\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsVirtualMirrorFOV\">Virtual Mirror FOV</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable virtual-mirror-slider\" data-bind-ksvalue=\"{{ViewSettingsMirrors.virtual_mirror_scale}}\" min=\"5\" step=\"1\" max=\"15\" data-setting=\"mirrors\" data-option=\"virtual_mirror_scale\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsVMScale\">Virtual Mirror Scale</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable virtual-mirror-slider\" data-bind-ksvalue=\"{{ViewSettingsMirrors.virtual_mirror_horizontal_offset}}\" min=\"-100\" step=\"1\" max=\"100\" data-setting=\"mirrors\" data-option=\"virtual_mirror_horizontal_offset\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsVMHorizontalOffset\">Virtual Mirror Horizontal Offset</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable virtual-mirror-slider\" data-bind-ksvalue=\"{{ViewSettingsMirrors.virtual_mirror_vertical_offset}}\" min=\"0\" step=\"1\" max=\"100\" data-setting=\"mirrors\" data-option=\"virtual_mirror_vertical_offset\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsVMVerticalOffset\">Virtual Mirror Vertical Offset</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n            </div>\r\n\r\n            <div class=\"mirrors-selector settings\">\r\n                <ks-btnbasic class=\"focusable selected\" data-mode=\"left\" toggle-group=\"section\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"viewSettingsMirrorLeft\">Left</div>\r\n                </ks-btnbasic>\r\n                <ks-btnbasic class=\"focusable selected\" data-mode=\"center\" toggle-group=\"section\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"viewSettingsMirrorCenter\">Center</div>\r\n                </ks-btnbasic>\r\n                <ks-btnbasic class=\"focusable selected\" data-mode=\"right\" toggle-group=\"section\" toggle>\r\n                    <div slot=\"name\" data-l10n-id=\"viewSettingsMirrorRight\">Right</div>\r\n                </ks-btnbasic>\r\n            </div>\r\n            <!-- MULTI MIRROR VR SECTION -->\r\n            <div class=\"multi-mirrors-vr\">\r\n                <ks-slider class=\"oneline toggle focusable mirror-disable\" data-bind-ksvalue=\"{{ViewSettingsMirrors.disable}}\" values='[\"optionOff\",\"optionOn\"]' data-setting=\"mirrors\" data-option=\"disable\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsDisableMirror\">Disable Mirror</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable mirror-slider\" data-bind-ksvalue=\"{{ViewSettingsMirrors.vr_fov}}\" min=\"-5\" step=\"1\" max=\"50\" data-setting=\"mirrors\" data-option=\"vr_fov\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsVRMirrorFOV\">VR Mirror FOV</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable mirror-slider\" data-bind-ksvalue=\"{{ViewSettingsMirrors.vr_yaw}}\" min=\"-15\" step=\"1\" max=\"15\" data-setting=\"mirrors\" data-option=\"vr_yaw\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsVRMirrorYaw\">VR Mirror Yaw</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable mirror-slider\" data-bind-ksvalue=\"{{ViewSettingsMirrors.vr_pitch}}\" min=\"-10\" step=\"1\" max=\"10\" data-setting=\"mirrors\" data-option=\"vr_pitch\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsVRMirrorPitch\">VR Mirror Pitch</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n            </div>\r\n            <!-- MULTI MIRROR SECTION  -->\r\n            <div class=\"multi-mirrors\">\r\n                <ks-slider class=\"oneline toggle focusable mirror-disable\" data-bind-ksvalue=\"{{ViewSettingsMirrors.disable}}\" values='[\"optionOff\",\"optionOn\"]' data-setting=\"mirrors\" data-option=\"disable\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsDisableMirror\">Disable Mirror</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable mirror-slider\" data-bind-ksvalue=\"{{ViewSettingsMirrors.fov}}\" min=\"-5\" step=\"1\" max=\"50\" data-setting=\"mirrors\" data-option=\"fov\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsMirrorFOV\">Mirror FOV</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable mirror-slider\" data-bind-ksvalue=\"{{ViewSettingsMirrors.yaw}}\" min=\"-15\" step=\"1\" max=\"15\" data-setting=\"mirrors\" data-option=\"yaw\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsMirrorYaw\">Mirror Yaw</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n                <ks-slider class=\"oneline focusable mirror-slider\" data-bind-ksvalue=\"{{ViewSettingsMirrors.pitch}}\" min=\"-10\" step=\"1\" max=\"10\" data-setting=\"mirrors\" data-option=\"pitch\">\r\n                    <div slot=\"name\" data-l10n-id=\"lblViewSettingsMirrorPitch\">Mirror Pitch</div>\r\n                    <div slot=\"unit\"></div>\r\n                </ks-slider>\r\n            </div>\r\n        </div>\r\n\r\n\r\n        <!-- TRIPLE AND WIDE SCREEN -->\r\n\r\n        <div class=\"group-triple settings\" data-mode=\"triplescreen\">\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{VideoSettings.display.triple_screen.distance}}\" min=\"100\" step=\"1\" max=\"3000\" data-setting=\"triplescreen\" data-option=\"distance\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsDistanceFromScreens\">Distance From Screens</div>\r\n                <div slot=\"unit\">mm</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{VideoSettings.display.triple_screen.width}}\" min=\"100\" step=\"1\" max=\"3000\" data-setting=\"triplescreen\" data-option=\"width\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsScreenWidth\">Screen Width</div>\r\n                <div slot=\"unit\">mm</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{VideoSettings.display.triple_screen.bezel}}\" min=\"-100\" step=\"1\" max=\"100\" data-setting=\"triplescreen\" data-option=\"bezel\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsBezelWidth\">Bezel Width</div>\r\n                <div slot=\"unit\">mm</div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{VideoSettings.display.triple_screen.screen_angle}}\" min=\"0\" step=\"1\" max=\"90\" data-setting=\"triplescreen\" data-option=\"screen_angle\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsSideScreenAngle\">Side Screen Angle</div>\r\n                <div slot=\"unit\"></div>\r\n            </ks-slider>\r\n        </div>\r\n\r\n        <!-- HDR -->\r\n\r\n        <div class=\"group-hdr settings\">\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{}}\" min=\"0\" step=\"1\" max=\"1\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsHDRExposure\">HDR Exposure</div>\r\n                <div slot=\"unit\"></div>\r\n            </ks-slider>\r\n            <ks-slider class=\"oneline focusable\" data-bind-ksvalue=\"{{}}\" min=\"0\" step=\"1\" max=\"1\">\r\n                <div slot=\"name\" data-l10n-id=\"lblViewSettingsHDRContrast\">HDR Contrast</div>\r\n                <div slot=\"unit\"></div>\r\n            </ks-slider>\r\n        </div>\r\n\r\n    </div>\r\n\r\n    <!-- <div class=\"bottom-panel\">\r\n        <div class=\"left\">\r\n            <ks-btnbasic id=\"btnBack\" data-sn-down=\"#btnResume\" class=\"focusable rounded-half\">\r\n                <div slot=\"name\" data-l10n-id=\"btnBack\">Back to Pause Menu</name>\r\n            </ks-btnbasic>\r\n        </div>        \r\n        <div class=\"center\">\r\n            <ks-btnbasic id=\"btnDefault\" data-sn-down=\"#btnResume\" class=\"focusable rounded-half\">\r\n                <div slot=\"name\" data-l10n-id=\"btnDefault\">Set default values</name>\r\n            </ks-btnbasic>\r\n        </div>\r\n        <div class=\"right\">\r\n            <ks-btnbasic id=\"btnSave\" data-sn-down=\"#btnResume\" class=\"focusable rounded-half\">\r\n                <div slot=\"name\" data-l10n-id=\"btnSave\">Save values</name>\r\n            </ks-btnbasic>\r\n        </div>\r\n            <div class=\"spacing\"></div>\r\n    </div> -->\r\n\r\n</div>";

    class ViewSettings extends KsHTMLElement {


        /** @type Btnbasic */
        btnBack;
        /** @type Btnbasic */
        btnCancel;
        /** @type Btnbasic */
        btnApply;
        /** @type Btnbasic */
        btnDefault;
        /** @type MessageHandler */
        Client;
        /** @type MessageHandler */
        ClientVideo;

        /** @type HTMLDivElement */
        panelModes;


        // GENERAL
        currentMode = "camera";
        previousPanel = "camera";
        isDirty = false;
        loading = false;
        btnSwitch = {};

        // CAMERA SETTINGS
        originalSeatDistance = 0;
        originalSeatFOV = 0;
        originalSeatHeight = 0;
        originalSeatLateral = 0;
        originalSeatPitch = 0;
        is_auto_request = false;
        is_vr = false;

        // MOTION
        modelBackupMotion = [];

        // DASH
        modelBackupDash = [];

        // MIRRORS
        mirror_index = 1;
        mirrors_num = 0;
        btnSwitchMirrors = [];
        modelBackupMirrors = [];
        isMultiVR = "";
        isSingleMirror = false;
        hasMirrorsSetup = false;

        // TRIPLE SCREEN
        isTripleScreenActive = false;
        modelBackupTripleScreen = [];

        constructor() {
            super();
            this.template = template$3;
            this._isnavigable = true;
            this._exposeAsActivePage = true;
            this._bindScrollableEvents = true;
            this.shouldRenderControlHints = true;
            this.delayedInit = true;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();
            this.getSwitchButtons();
            this.mapElementById("panelModes");
            this.ClientVideo = new MessageHandler("Settings");
            this.Client = new MessageHandler("ViewSettings");

            q(".group-camera").style.display = "block";
            this.loadVideoSettings();
            this.load();
            ksUI$1.menuState.ignoreInputActions(true);
            document.body.classList.add("viewsettings");
        }

        getSwitchButtons() {
            this.btnSwitch = {};
            qAll("ks-btnbasic[toggle-group=switch]").forEach((elem) => {
                const name = elem.dataset.mode;
                if (name) this.btnSwitch[name] = elem;
            });
        }

        save(skip_load = false) {
            this.Client.request("SaveOptions",
                {
                    visibility: ViewSettingsDash.visibility,
                    render_dash_display: ViewSettingsDash.render_dash_display
                },
                (response) => {
                    console.log(response);
                    ({
                        ["ViewSettingsCommandsResponse_OK"]: () => {
                            console.log("View Settings Saved!");
                            console.log(ViewSettingsDash);
                            if (!skip_load) {
                                this.load();
                            }
                            this.clearDirty();
                        },
                        ["ViewSettingsCommandResponse_CRITICAL_ERROR"]: () => {
                            console.log("View Settings Error!");
                        }
                    }[response.response])();
                });
        }

        load(clear_dirty = true) {
            this.loading = true;
            this.Client.request("Options",
                {
                    is_auto_request: this.is_auto_request,
                    mirror_index: this.mirror_index
                },
                (response) => {
                    this.is_auto_request = false;

                    ksUI$1.assignModel(response.seat_settings, "ViewSettingsCamera");
                    ksUI$1.assignModel(response.dash_settings, "ViewSettingsDash");
                    console.log(response.dash_settings);
                    Object.assign(this.modelBackupDash, response.dash_settings);
                    ksUI$1.assignModel(response.mirrors_settings, "ViewSettingsMirrors");
                    Object.assign(this.modelBackupMirrors, response.mirrors_settings);
                    this.mirrorsPanelSetup();                
                    ksUI$1.assignModel(response.motion_settings, "ViewSettingsMotion");
                    Object.assign(this.modelBackupMotion, response.motion_settings);
                    this.setOriginalCameraValues(response);

                    this.is_vr = response.is_vr_enabled;
                    const FOVElem = q("ks-slider[data-option=fov]");
                    this.is_vr ? FOVElem.setAttribute("disabled", "disabled") : FOVElem.removeAttribute("disabled", "disabled");

                    if (this.btnSwitchMirrors.length == 0)
                        this.updateButtons(response.mirrors_settings.mirrors_set.length);

                    if (clear_dirty) this.clearDirty();
                    ksUI$1.waitForFrames(() => {
                        this.loading = false;
                    }, 4);
                });
        }

        //////////////////////////
        // TRIPLE SCREEN SETTINGS
        //////////////////////////
        loadVideoSettings() {
            this.ClientVideo.request("Video", (response) => {
                ksUI$1.assignModel(response.video, "VideoSettings");
                Object.assign(this.modelBackupTripleScreen, response.video);
                const tripleElem = q("ks-btnbasic[data-name=triplescreen]");
                const FOVElem = q("ks-slider[data-option=fov]");

                response.video.display.is_triple == true ? tripleElem.setAttribute("toggle", "") : tripleElem.setAttribute("disabled", "");
                response.video.display.is_triple == true ? FOVElem.setAttribute("disabled", "disabled") : FOVElem.removeAttribute("disabled", "disabled");

                switch (response.video.graphics.mirror.mirror_mode) {
                    case "Mirror_Off":
                        q("ks-btnbasic[data-name=mirrors]").setAttribute("disabled", "");
                        return;
                    case "Mirror_Single":
                        this.isSingleMirror = true;
                        q("ks-btnbasic[data-name=mirrors]").setAttribute("toggle", "");
                        break;
                    case "Mirror_Multi":
                        this.isSingleMirror = false;
                        q("ks-btnbasic[data-name=mirrors]").setAttribute("toggle", "");
                        break;
                }
                this.isMultiVR = (response.video.graphics.mirror.multi_mode == "Multi_VR") ? true : false;
            });
        }

        saveVideoSettings() {
            this.ClientVideo.request("SaveVideo",
                {
                    display: VideoSettings.display,
                    graphics: VideoSettings.graphics,
                    is_display: true
                },
                (response) => {
                    ({
                        [eCommandResponse.OK]: () => {
                            console.log("Video settings saved!");
                            this.clearDirty();
                            this.loading = true;

                            ksUI$1.waitForFrames(() => {
                                this.loading = false;
                            }, 5);
                        },
                        [eCommandResponse.Failed]: () => {
                            console.error("Video settings failed to save!");
                        },
                        [eCommandResponse.Restart]: () => {
                            console.log("Video settings require restart!");
                        }
                    }[response.response])();
                });
        }

        // FAST FIX TO REWORK
        mirrorsPanelSetup() {
            this.disableMirrorSlider(ViewSettingsMirrors.disable);
            this.setVirtualMirrorVisibility(ViewSettingsMirrors.virtual_mirror_enabled);

            if (this.hasMirrorsSetup) { return; }

            this.hasMirrorsSetup = true;
            if (this.isSingleMirror) {
                q('.mirrors-selector.settings').remove();
                q('.multi-mirrors-vr').remove();
                q('.multi-mirrors').remove();

                return;
            }
            if (this.isMultiVR) {
                q('.multi-mirrors').remove();
                return;
            }
            q('.multi-mirrors-vr').remove();
        }



        default() {        
            this.pageModal.Show({
                        type: eModalDialogTypes.Warning,
                        title: "lblChangesDefault",
                        message: "msgViewSettingsDefault",
                        confirm: "btnApply",
                        buttons: 0x101
                    });

                    this.pageModal.onCancel = () => {                    
                    };

                    this.pageModal.onConfirm = () => {
                        switch (this.currentMode) {
                            case "camera":
                                this.setDefaultOptions("ViewSettingsOptions_Camera");
                                this.save();
                                break;
                            case "motion":
                                this.setDefaultOptions("ViewSettingsOptions_Motion");
                                this.save();
                                break;
                            case "wheel":
                                this.setDefaultOptions("ViewSettingsOptions_Dash");
                                this.save();
                                break;
                            case "mirrors":
                                this.setDefaultOptions("ViewSettingsOptions_Mirrors");
                                this.save();
                                this.mirror_index = 1;
                                if (!this.isSingleMirror)
                                    this.btnSwitchMirrors[0].toggle(true);
                                break;
                            case "triplescreen":
                                ksUI$1.unassignModel("VideoSettings");
                                ksUI$1.assignModel(this.modelBackupTripleScreen, "VideoSettings");                           
                                this.setDefaultTripleScreenValues();
                                ksUI$1.waitForFrames(() => {
                                    this.clearDirty();
                                    this.saveVideoSettings();
                                }, 4);
                                return;
                            
                        }
                    };        
        }


        reset(active_panel) {
            switch (active_panel) {
                case "camera":
                    ksUI$1.unassignModel("ViewSettingsOptions");
                    this.setCameraOptions("original");
                    this.load();
                    break;
                case "motion":
                    this.load();
                    break;
                case "mirrors":
                    ksUI$1.unassignModel("ViewSettingsMirrors");
                    ksUI$1.assignModel(this.modelBackupMirrors, "ViewSettingsMirrors");
                    this.setMirrorsOptions();
                    ksUI$1.waitForFrames(() => {
                        this.clearDirty();
                    }, 4);
                    return;
                case "wheel":
                    ksUI$1.unassignModel("ViewSettingsDash");
                    ksUI$1.assignModel(this.modelBackupDash, "ViewSettingsDash");
                    this.setDashOptions();
                    this.loading = true;
                    this.clearDirty();
                    ksUI$1.waitForFrames(() => {
                        this.loading = false;
                    }, 4);
                    return;
                case "triplescreen":
                    ksUI$1.unassignModel("VideoSettings");
                    ksUI$1.assignModel(this.modelBackupTripleScreen, "VideoSettings");
                    this.setTripleScreenOptions();
                    this.loadVideoSettings();
                    ksUI$1.waitForFrames(() => {
                        this.clearDirty();
                    }, 4);
                    return;
            }
        }

        markDirty() {
            this.isDirty = true;
            [this.btnApply, this.btnCancel].map(btn => {
                btn.removeAttribute("disabled");
            });
        }

        clearDirty() {
            this.isDirty = false;
            [this.btnApply, this.btnCancel].map(btn => {
                if (btn)
                    btn.setAttribute("disabled", "true");
            });
        }

        onAfterRenderControlHints(controlhints) {
            this.btnBack = q(".back", controlhints);
            this.btnApply = q(".apply", controlhints);
            this.btnCancel = q(".cancel", controlhints);
            this.btnDefault = q(".default", controlhints);

            const changePage = function (target, sender, is_back = true) {

                function process() {
                    if (ksUI$1.menuState.isOriginMainMenu && is_back) {
                        ksUI$1.returnToOrigin();
                    } else {
                        ksUI$1.returnToOrigin();
                    }
                }
                if (sender.isDirty) {
                    sender.pageModal.Show({
                        type: eModalDialogTypes.Warning,
                        title: "lblChangesDetected",
                        message: "msgChangesWarning",
                        confirm: "btnApply"
                    });

                    sender.pageModal.onDiscard = () => {
                        sender.reset(sender.currentMode);
                        process();
                    };

                    sender.pageModal.onConfirm = () => {
                        sender.save(true);
                        process();
                    };
                } else {
                    process();
                }
            };

            this.btnBack.onPressed = () => {
                changePage("ingame/pausemenu", this);
            };

            this.btnDefault.onPressed = () => {
                this.default();
            };

            this.btnApply.onPressed = () => this.currentMode == "triplescreen" ? this.saveVideoSettings() : this.save();
            this.btnCancel.onPressed = () => { this.reset(this.currentMode); };
        }

        updateButtons(total_mirrors) {
            if (this.isSingleMirror) {
                if (q('.mirrors-selector.settings')) {
                    q('.mirrors-selector.settings').remove();
                    q('ks-slider[data-option="yaw"]').remove();
                    q('ks-slider[data-option="pitch"]').remove();
                    this.mirrors_num = 0;
                    return;
                }
            } else {
                this.mirrors_num = total_mirrors;
                console.log("TOTAL MIRRORS ARE", this.mirrors_num);

                if (this.mirrors_num == 2) {
                    q('[data-mode="center"]')?.remove();
                }
                qAll("ks-btnbasic[toggle-group=section]").forEach(
                    /** @param {Btnbasic} elem */
                    elem => {
                        if (this.btnSwitchMirrors.length == 0)
                            this.btnSwitchMirrors.push(elem);
                    });
                this.btnSwitchMirrors[0].toggle(true);
                if (total_mirrors == 1) {
                    q('ks-btnbasic[data-mode="center"]').remove();
                }
            }
        }

        setDefaultTripleScreenValues() {
            VideoSettings.display.triple_screen.distance = 640;
            VideoSettings.display.triple_screen.width = 520;
            VideoSettings.display.triple_screen.bezel = 20;
            VideoSettings.display.triple_screen.screen_angle = 45;
            this.setTripleScreenOptions();
        }
      
        setOriginalCameraValues(response) {
            this.originalSeatDistance = response.seat_settings.seat_distance;
            this.originalSeatFOV = response.seat_settings.fov;
            this.originalSeatHeight = response.seat_settings.seat_height;
            this.originalSeatLateral = response.seat_settings.seat_lateral;
            this.originalSeatPitch = response.seat_settings.seat_pitch;
            this.convertOriginalCameraValues();
        }

        convertOriginalCameraValues() {
            ViewSettingsCamera.fov = this.originalSeatFOV;
            ViewSettingsCamera.seat_distance = this.originalSeatDistance;
            ViewSettingsCamera.seat_height = this.originalSeatHeight;
            ViewSettingsCamera.seat_lateral = this.originalSeatLateral;
            ViewSettingsCamera.seat_pitch = this.originalSeatPitch;
        }

        //////////////////////////
        // SET OPTIONS REQUESTS
        //////////////////////////
        setDefaultOptions(option) {
            this.Client.request("DefaultOptions",
                { options: option },
                () => {
                    console.log("Defaults Applied");
                }
        );
    }

        setCameraOptions(condtion) {        
            switch (condtion) {
                case "default":
                    this.setDefaultsCameraValues();
                    break;
                case "original":
                    this.convertOriginalCameraValues();
                    break;
            }
            this.Client.request("SetOptions", {
                seat_settings: message("SeatSettings", {
                    fov: ViewSettingsCamera.fov,
                    seat_distance: ViewSettingsCamera.seat_distance,
                    seat_height: ViewSettingsCamera.seat_height,
                    seat_lateral: ViewSettingsCamera.seat_lateral,
                    seat_pitch: ViewSettingsCamera.seat_pitch
                })
            });
        }

        setDashOptions() {
            this.Client.request("SetDashOptions", {
                dash_settings: message("DashSettings", {
                    visibility: ViewSettingsDash.visibility,
                    halo_visibility: ViewSettingsDash.halo_visibility,
                    render_dash_display: ViewSettingsDash.render_dash_display
                    // dash_display_transparency: ViewSettingsDash.dash_display_transparency
                })
            });
        }

        setMirrorsOptions() {
            console.log("MIRROR INDEX IS:", this.mirror_index);
            this.Client.request("SetMirrorsOptions", {
                mirrors_settings: message("MirrorsSettings", {
                    yaw: ViewSettingsMirrors.yaw,
                    pitch: ViewSettingsMirrors.pitch,
                    fov: ViewSettingsMirrors.fov,
                    mirrors_set: [this.mirror_index],
                    mirror_type: this.mirror_index,
                    is_single_mirror: this.isSingleMirror,
                    is_vr: this.isMultiVR,
                    vr_yaw: ViewSettingsMirrors.vr_yaw,
                    vr_pitch: ViewSettingsMirrors.vr_pitch,
                    vr_fov: ViewSettingsMirrors.vr_fov,
                    single_mode_fov: ViewSettingsMirrors.single_mode_fov,
                    disable: ViewSettingsMirrors.disable,
                    virtual_mirror_enabled: ViewSettingsMirrors.virtual_mirror_enabled,
                    virtual_mirror_scale: ViewSettingsMirrors.virtual_mirror_scale,
                    virtual_mirror_horizontal_offset: ViewSettingsMirrors.virtual_mirror_horizontal_offset,
                    virtual_mirror_vertical_offset: ViewSettingsMirrors.virtual_mirror_vertical_offset
                })
            });
        }

        setMotionOptions() {
            this.Client.request("SetMotionOptions", {
                motion_settings: message("CameraSettings", {
                    horizon_lock: ViewSettingsMotion.horizon_lock,
                    general_movement: ViewSettingsMotion.general_movement,
                    dashcam_factor: ViewSettingsMotion.dashcam_factor,
                    bonnet_factor: ViewSettingsMotion.bonnet_factor,
                    look_with_steer_gain: ViewSettingsMotion.look_with_steer_gain,
                    look_with_steer_gamma: ViewSettingsMotion.look_with_steer_gamma,
                    look_with_steer_smoothing: ViewSettingsMotion.look_with_steer_smoothing
                })
            });
        }

        setTripleScreenOptions() {
            this.Client.request("SetTripleScreenOptions", {
                triple_screen_settings: message("TripleScreenSettings", {
                    bezel: VideoSettings.display.triple_screen.bezel,
                    width: VideoSettings.display.triple_screen.width,
                    distance: VideoSettings.display.triple_screen.distance,
                    screen_angle: VideoSettings.display.triple_screen.screen_angle
                })
            });
        }

        switchPanelMode(viewsettings_mode) {
            q(".group-camera").style.display = viewsettings_mode == "camera" ? "block" : "none";
            q(".group-motion").style.display = viewsettings_mode == "motion" ? "block" : "none";
            q(".group-wheel").style.display = viewsettings_mode == "wheel" ? "block" : "none";
            q(".group-mirrors").style.display = viewsettings_mode == "mirrors" ? "block" : "none";

            if (this.btnSwitchMirrors.length > 0)
                this.btnSwitchMirrors[0].toggle(true);
            this.mirror_index = 1;
            this.load();

            q(".group-triple").style.display = viewsettings_mode == "triplescreen" ? "block" : "none";        
        }

        disableMirrorSlider(disable_mirror) {
            const sliders = qAll('ks-slider.mirror-slider');
            sliders.forEach(slider => {
                disable_mirror == true ? slider.setAttribute('disabled', 'disabled') : slider.removeAttribute('disabled');
            });
        }

        setVirtualMirrorVisibility(enable_virtual_mirror) {
            const sliders = qAll('ks-slider.virtual-mirror-slider');
            sliders.forEach(slider => {
                enable_virtual_mirror == true ? slider.removeAttribute('disabled') : slider.setAttribute('disabled', 'disabled');
            });
        }

        //////////////////
        // CONTROLS
        //////////////////
        bindControls() {
            engine.on("UIExInputsAction", (e) => {
                if (e.action == "InputAction_Camera_Drivable" && this.currentMode == "camera") {
                    this.is_auto_request = true;
                    this.isDirty == true ? this.save() : this.load();
                }
            });

            qAll("ks-btnbasic[toggle-group=switch]").forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        this.previousPanel = this.currentMode;
                        this.currentMode = sender.dataset.mode;
                        if (state) {
                            if (this.isDirty) {
                                this.pageModal.Show({
                                    type: eModalDialogTypes.Warning,
                                    title: "lblChangesDetected",
                                    message: "msgChangesWarning",
                                    confirm: "btnApply"
                                });
                                this.pageModal.onDiscard = () => {
                                    this.reset(this.previousPanel);
                                    ksUI$1.waitForFrames(() => {
                                        this.switchPanelMode(this.currentMode);
                                    }, 4);
                                };
                                this.pageModal.onConfirm = () => {
                                    this.save();
                                    this.switchPanelMode(this.currentMode);
                                };
                                this.pageModal.onCancel = () => {
                                    this.btnSwitch[this.previousPanel].toggle(true);
                                    this.currentMode = this.previousPanel;
                                };
                            } else {
                                this.switchPanelMode(this.currentMode);
                            }
                        }
                    };
                });

            qevAll("ks-slider[data-setting=camera]",
                "onSliderValueChanged", (ev) => {
                    let detail = ev.detail;
                    if (!this.loading) {
                        let currentSetting = detail.sender.dataset.option;
                        ViewSettingsCamera[currentSetting] = detail.sender.value;
                        this.setCameraOptions();
                        this.markDirty();
                    }
                });

            qevAll("ks-slider[data-setting=dash]",
                "onSliderValueChanged", (ev) => {
                    let detail = ev.detail;
                    let detaildata = detail.sender.dataset;
                    if (!this.loading) {
                        const path = detaildata.bindKsvalue.replace(/[{}]/g, "").split(".");
                        const sourcevalue = Function(`return window["${path.join('"]["')}"]`)();
                        const value = ksUI$1.sameType(sourcevalue, typeof sourcevalue == "boolean" ? detail.index : detail.value);
                        const type = typeof value;
                        Function(`window["${path.join('"]["')}"]=${type == "string" ? '"' + detail.value + '"' : type == "boolean" ? detail.sender.index == 1 : value}`)();

                        let currentSetting = detail.sender.dataset.option;
                      
                        ViewSettingsDash[currentSetting] = value;
                       
                        this.setDashOptions();
                        this.markDirty();
                    }
                });
            
            // $.q('ks-slider[data-option=dash_display_transparency]').valueFilter = (value_to_filter) => {
            //             const displayedValue = Math.floor(value_to_filter * 100);
            //             return displayedValue;
            //         };

            qevAll("ks-slider[data-setting=mirrors]",
                "onSliderValueChanged", (ev) => {
                    let detail = ev.detail;
                    let detaildata = detail.sender.dataset;
                    if (!this.loading) {
                        const path = detaildata.bindKsvalue.replace(/[{}]/g, "").split(".");
                        const sourcevalue = Function(`return window["${path.join('"]["')}"]`)();
                        const value = ksUI$1.sameType(sourcevalue, typeof sourcevalue == "boolean" ? detail.index : detail.value);
                        const type = typeof value;
                        Function(`window["${path.join('"]["')}"]=${type == "string" ? '"' + detail.value + '"' : type == "boolean" ? detail.sender.index == 1 : value}`)();

                        let currentSetting = detail.sender.dataset.option;
                        ViewSettingsMirrors[currentSetting] = value;

                        if (path.includes("disable"))
                            this.disableMirrorSlider(value);
                        if (path.includes("virtual_mirror_enabled"))
                            this.setVirtualMirrorVisibility(value);

                        this.setMirrorsOptions();
                        this.markDirty();
                    }
                });

            qevAll("ks-slider[data-setting=motion]",
                "onSliderValueChanged", (ev) => {
                    let detail = ev.detail;
                    if (!this.loading) {
                        let currentSetting = detail.sender.dataset.option;
                        ViewSettingsMotion[currentSetting] = detail.sender.value;
                        console.log(currentSetting);
                        this.setMotionOptions();
                        this.markDirty();
                    }
                });

            qevAll("ks-slider[data-setting=triplescreen]",
                "onSliderValueChanged", (ev) => {
                    let detail = ev.detail;
                    if (!this.loading) {
                        let currentSetting = detail.sender.dataset.option;
                        VideoSettings.display.triple_screen[currentSetting] = detail.sender.value;
                        this.setTripleScreenOptions();
                        this.markDirty();
                    }
                });

            qAll("ks-btnbasic[toggle-group=section]").forEach(
                /** @param {Btnbasic} elem */
                elem => {
                    elem.onToggled = (sender, e, state) => {
                        if (state) {
                            console.log("TOTAL MIRRORS ARE:", this.mirrors_num);
                            switch (sender.dataset.mode) {
                                case "left":
                                    console.log("LEFT MIRROR SELECTED!");
                                    this.mirror_index = 1;
                                    break;
                                case "center":
                                    console.log("CENTER MIRROR SELECTED!");
                                    this.mirror_index = 0;
                                    break;
                                case "right":
                                    console.log("RIGHT MIRROR SELECTED!");
                                    this.mirror_index = 2;
                                    break;
                            }
                            this.save();
                        }
                    };
                });

        }

        init() {
            super.init();
        }

        onRemovedFromDOM() {
            ksUI$1.unassignModel("ViewSettingsCamera");
            ksUI$1.unassignModel("ViewSettingsDash");
            ksUI$1.unassignModel("ViewSettingsMirrors");
            ksUI$1.unassignModel("ViewSettingsMotion");
            ksUI$1.unassignModel("VideoSettings");
            document.body.classList.remove("viewsettings");
            ksUI$1.menuState.ignoreInputActions(false);
        }
    }

    ksUI$1.registerModule('ks-viewsettings', ViewSettings);

    var template$2 = "<div class=\"component-body\">\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"focusable defaultfocus\" path=\"pitlane/main\">\r\n                <div slot=\"name\" data-l10n-id=\"btnBack\">Back</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n        <div class=\"group end\"></div>\r\n    </component-slot>\r\n\r\n    <div class=\"header\">\r\n        <div id=\"acelogo\"> \r\n            <div class=\"session-name\" data-bind-value=\"sessioninfo_session({{ModelUISessionState.session_name}})\">\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"submode-body\">\r\n        <ks-trackmap-pitlane class=\"trackmap\"></ks-trackmap-pitlane>\r\n    </div>\r\n</div>";

    class TrackMapPage extends KsHTMLElement {

        
        constructor() {
            super();
            this.template = template$2;
            this.shouldRenderControlHints = true;
            this._exposeAsActivePage = true;
            this._isnavigable = true;
            this._bindScrollableEvents = true;
        }


        onTemplateLoaded() {      
            super.onTemplateLoaded();

        }
    }

    ksUI$1.registerModule('ks-page-trackmap', TrackMapPage);

    class InGame extends KsHTMLElement {

        Client = new MessageHandler("SeasonInfo");
        changePageHandler;


        pageSettings;
        pauseMenu;

        constructor() {
            super();
            this.template = template$q;

            //this._exposeAsActivePage = true;
            console.log("Ingame");
        }

        filters = {
            ingame_process: (session_state) => {

                const classList = document.body.classList;

                classList.toggle("sessionEnd", (session_state.end_session_flag & globalThis.InSessionFlags.SessionEnd) > 0);

                if (window["SeasonInfo"] && !document.body.classList.contains("multiplayer")) {
                    classList.toggle("driving-academy", SeasonInfo.mode == "ClientCommandsMode_DRIVING_ACADEMY");
                }
            }
        }

        onTemplateLoaded() {
            console.log("Ingame templateloaded");
            ksUI$1.Models.enable(DataModels.SessionState);
            this.pageSettings = q("ks-page-settings");
            this.pauseMenu = q("ks-pausemenu");
            super.onTemplateLoaded();

            document.body.classList.add("in-pitlane");

            // GAMEMODESELECTION.getGameModeParameters();

            this.loadSeasonAndSessionInfo();
            ksUI$1.menuState.toggleKeyboardInput(false);

            this.changePageHandler = engine.on("changePage", () => {
                this.loadSeasonAndSessionInfo();
            });

        }

        loadSeasonAndSessionInfo() {
            GAMEMODESELECTION.getSeasonInfoParameters();
            GAMEMODESELECTION.getSessionInfoParameters();
        }

        onRemovedFromDOM() {
            console.log("Exiting ingame root");
            this.changePageHandler.clear();
        }

        bindControls() {

            engine.on("onStateLoaded", () => {
                if (ModelMenuState.activeMenu === "pause" && ModelMenuState.activeMenu) {
                    this.pauseMenu.Show();
                } else {
                    this.pauseMenu.Hide();
                }

            });


        }

    }
    engine.on("MenuStateInit", () => {
        ksUI$1.registerModule('ks-ingame', InGame);
    });

    var template$1 = "<div class=\"replay-body component-body\" data-mode=\"home\">\r\n\r\n    <div class=\"ingame-permanent\">\r\n        <ks-timer id=\"nextsession\" data-mode=\"nextsession\" class=\"verticalwipe hidable\" data-bind-if=\"{{ModelUISessionState}}.time_to_next_session != ''\">\r\n        </ks-timer>\r\n    </div>\r\n\r\n    <component-slot data-name=\"controls\">\r\n        <div class=\"group start\">\r\n            <ks-btnbasic id=\"btnBack\" class=\"back rounded focusable\"></ks-btnbasic>\r\n\r\n            <ks-btnbasic id=\"btnSave\" class=\"focusable apply\" data-bind-disablevalue=\"{{ModelUIReplayState}}.total_time_ms == 0\">\r\n                <div slot=\"name\" data-l10n-id=\"btnSave\">Save</div>\r\n            </ks-btnbasic>\r\n        </div>\r\n    </component-slot>\r\n\r\n    <div class=\"replay-submode submode main\">\r\n\r\n        <div class=\"replay-submode-body centered-content\">\r\n\r\n            <div id=\"pnlControls\" class=\"row controls show-lap-markers show-incident-markers\">\r\n\r\n                <div id=\"lblNoReplayRecorded\" data-l10n-id=\"lblNoReplayRecorded\"></div>\r\n\r\n                <div id=\"timeline\">\r\n                    <div class=\"current\" data-bind-value=\"ksUI.formatTimeExt(Math.round({{ModelUIReplayState.current_time_ms}}), 2, false, 0)\"></div>\r\n                    <div class=\"separator\">/</div>\r\n                    <div class=\"total\" data-bind-value=\"ksUI.formatTimeExt(Math.round({{ModelUIReplayState.total_time_ms}}), 2, false, 0)\"></div>\r\n                </div>\r\n\r\n                <div id=\"scroller\" class=\"focusable\">\r\n                    <div id=\"indicatorPlayed\" class=\"played\"></div>\r\n                    <div id=\"markersPanel\"></div>\r\n                    <div id=\"indicatorPosition\" class=\"indicator\" data-bind-ksvalue=\"activePage.filters.positionPercent({{ModelUIReplayState.current_time_ms}},{{ModelUIReplayState.total_time_ms}})\"></div>\r\n                </div>\r\n\r\n                <div class=\"buttons\">\r\n\r\n                    <ks-btnbasic id=\"btnReverse\" class=\"focusable\" toggle>\r\n                        <div slot=\"name\">R</div>\r\n                    </ks-btnbasic>\r\n\r\n                    <ks-btnbasic id=\"btnGoToStart\" class=\"focusable\">\r\n                        <div slot=\"name\">\r\n                            <div class=\"label gotostart\">\r\n                                <svg viewBox=\"0 0 15 21\">\r\n                                    <path d=\"M4.5,22.728V2.813a.565.565,0,0,1,.564-.564H7.318a.565.565,0,0,1,.564.564V11.1l9.182-8.5A1.505,1.505,0,0,1,19.53,3.753V21.789a1.505,1.505,0,0,1-2.466,1.155l-9.182-8.45v8.233a.565.565,0,0,1-.564.564H5.064A.565.565,0,0,1,4.5,22.728Z\" transform=\"translate(-4.5 -2.25)\" fill=\"#f2f2f2\"/>\r\n                                </svg>\r\n                            </div>\r\n                        </div>\r\n                    </ks-btnbasic>\r\n\r\n                    <div class=\"lapselector\">\r\n                        <ks-btnbasic id=\"btnPrevLap\" class=\"focusable\">\r\n                            <div slot=\"name\">\r\n                                <div class=\"label\">\r\n                                    <svg class=\"decrease\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 14.533 22.507\">\r\n                                        <path d=\"M2.229,16.8l9.563-9.562a1.681,1.681,0,0,1,2.384,0l1.589,1.589a1.681,1.681,0,0,1,0,2.384L8.993,18l6.778,6.778a1.681,1.681,0,0,1,0,2.384l-1.589,1.6a1.681,1.681,0,0,1-2.384,0L2.236,19.2A1.683,1.683,0,0,1,2.229,16.8Z\" transform=\"translate(-1.734 -6.746)\" fill=\"#f2f2f2\"/>\r\n                                    </svg>\r\n                                </div>\r\n\r\n                            </div>\r\n                        </ks-btnbasic>\r\n                        <div class=\"label\" data-l10n-id=\"labelLaps\"></div>\r\n                        <ks-btnbasic id=\"btnNextLap\" class=\"focusable\">\r\n                            <div slot=\"name\">\r\n                                <div class=\"label\">\r\n                                    <svg class=\"increase\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 14.533 22.507\">\r\n                                        <path d=\"M.495,10.058,10.057.5a1.681,1.681,0,0,1,2.384,0L14.03,2.085a1.681,1.681,0,0,1,0,2.384L7.259,11.254l6.778,6.778a1.681,1.681,0,0,1,0,2.384l-1.589,1.6a1.681,1.681,0,0,1-2.384,0L.5,12.449a1.683,1.683,0,0,1-.007-2.391Z\" transform=\"translate(14.533 22.507) rotate(180)\" fill=\"#f2f2f2\"/>\r\n                                    </svg>\r\n                                </div>\r\n                            </div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n\r\n\r\n\r\n\r\n                    <ks-btnbasic id=\"btnMinusFive\" class=\"focusable\">\r\n                        <div slot=\"name\">\r\n                            <div class=\"label\">\r\n                                <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 19 24\">\r\n                                    <g id=\"Group_1513\" data-name=\"Group 1513\" transform=\"translate(-973.279 -946)\">\r\n                                        <text transform=\"translate(980.88 957)\" fill=\"#f2f2f2\" font-size=\"9\" font-family=\"Rajdhani-Bold, Rajdhani\" font-weight=\"700\">\r\n                                            <tspan x=\"0\" y=\"0\">5</tspan>\r\n                                        </text>\r\n                                        <path d=\"M6,15.9a9.6,9.6,0,1,0,19.2,0H22.8a7.2,7.2,0,1,1-7.2-7.2v4.8l6-6-6-6V6.3A9.628,9.628,0,0,0,6,15.9Z\" transform=\"translate(998.479 971.5) rotate(180)\" fill=\"#f2f2f2\"/>\r\n                                    </g>\r\n                                </svg>\r\n\r\n                            </div>\r\n                        </div>\r\n                    </ks-btnbasic>\r\n\r\n                    <ks-btnbasic id=\"btnPlay\" class=\"focusable\" data-bind-class-toggle=\"play:{{ModelUIReplayState.time_multiplier}} == 0\">\r\n                        <div slot=\"name\">\r\n                            <div class=\"label play\">\r\n                                <svg viewBox=\"-256 0 1024 1024\" baseProfile=\"tiny\" preserveAspectRatio=\"none\">\r\n                                    <path d=\"M0 192l512 320L0 832V192z\"/>\r\n                                </svg>\r\n                            </div>\r\n                            <div class=\"label pause\">\r\n                                <svg viewBox=\"-256 0 1024 1024\" baseProfile=\"tiny\" preserveAspectRatio=\"none\">\r\n                                    <path d=\"M0 832h192V192H0V832zM320 192v640h192V192H320z\"/>\r\n                                </svg>\r\n                            </div>\r\n                        </div>\r\n                    </ks-btnbasic>\r\n\r\n                    <ks-btnbasic id=\"btnPlusFive\" class=\"focusable\">\r\n                        <div slot=\"name\">\r\n                            <div class=\"label\">\r\n                                <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 19 24\">\r\n                                    <g transform=\"translate(-1080.479 -946)\">\r\n                                        <text transform=\"translate(1087.579 965)\" fill=\"#f2f2f2\" font-size=\"9\" font-family=\"Rajdhani-Bold, Rajdhani\" font-weight=\"700\">\r\n                                            <tspan x=\"0\" y=\"0\">5</tspan>\r\n                                        </text>\r\n                                        <path d=\"M6,15.9a9.6,9.6,0,1,0,19.2,0H22.8a7.2,7.2,0,1,1-7.2-7.2v4.8l6-6-6-6V6.3A9.628,9.628,0,0,0,6,15.9Z\" transform=\"translate(1074.479 944.5)\" fill=\"#f2f2f2\"/>\r\n                                    </g>\r\n                                </svg>\r\n\r\n                            </div>\r\n                        </div>\r\n                    </ks-btnbasic>\r\n\r\n                    <ks-slider id=\"sliderMultiplier\" class=\"oneline focusable\" fromcenter values=\"[0.125,0.25,0.5,1,2,4,8]\" value=\"1\">\r\n                        <div slot=\"unit\">X</div>\r\n                    </ks-slider>\r\n\r\n                    <div class=\"carselector\">\r\n                        <ks-btnbasic id=\"btnPrevCar\" class=\"focusable\">\r\n                            <div slot=\"name\">\r\n                                <div class=\"label\">\r\n                                    <svg class=\"decrease\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 14.533 22.507\">\r\n                                        <path d=\"M2.229,16.8l9.563-9.562a1.681,1.681,0,0,1,2.384,0l1.589,1.589a1.681,1.681,0,0,1,0,2.384L8.993,18l6.778,6.778a1.681,1.681,0,0,1,0,2.384l-1.589,1.6a1.681,1.681,0,0,1-2.384,0L2.236,19.2A1.683,1.683,0,0,1,2.229,16.8Z\" transform=\"translate(-1.734 -6.746)\" fill=\"#f2f2f2\"/>\r\n                                    </svg>\r\n                                </div>\r\n\r\n                            </div>\r\n                        </ks-btnbasic>\r\n                        <div class=\"label\" data-l10n-id=\"panelSelectCar\"></div>\r\n                        <ks-btnbasic id=\"btnNextCar\" class=\"focusable\">\r\n                            <div slot=\"name\">\r\n                                <div class=\"label\">\r\n                                    <svg class=\"increase\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 14.533 22.507\">\r\n                                        <path d=\"M.495,10.058,10.057.5a1.681,1.681,0,0,1,2.384,0L14.03,2.085a1.681,1.681,0,0,1,0,2.384L7.259,11.254l6.778,6.778a1.681,1.681,0,0,1,0,2.384l-1.589,1.6a1.681,1.681,0,0,1-2.384,0L.5,12.449a1.683,1.683,0,0,1-.007-2.391Z\" transform=\"translate(14.533 22.507) rotate(180)\" fill=\"#f2f2f2\"/>\r\n                                    </svg>\r\n                                </div>\r\n                            </div>\r\n                        </ks-btnbasic>\r\n                    </div>\r\n\r\n                    <div class=\"camera-grid\">\r\n                        <ks-btnbasic id=\"btnDrivable\" class=\"focusable drivable\" data-tooltip=\"tooltipReplayCameraCycle\"></ks-btnbasic>\r\n                        <ks-btnbasic id=\"btnTrack\" class=\"focusable track\" data-tooltip=\"tooltipReplayCameraCycle\"></ks-btnbasic>\r\n                        <ks-btnbasic id=\"btnHelicopter\" class=\"focusable heli\" data-tooltip=\"tooltipReplayCameraCycle\"></ks-btnbasic>\r\n                        <ks-btnbasic id=\"btnOrbit\" class=\"focusable orbit\" data-tooltip=\"tooltipReplayCameraCycle\"></ks-btnbasic>\r\n                        <ks-btnbasic id=\"btnOnboard\" class=\"focusable onboard\" data-tooltip=\"tooltipReplayCameraCycle\"></ks-btnbasic>\r\n                        <ks-btnbasic id=\"btnFree\" class=\"focusable free\" data-tooltip=\"tooltipReplayCameraCycle\"></ks-btnbasic>\r\n                    </div>\r\n                </div>\r\n\r\n            </div>\r\n\r\n        </div>\r\n\r\n    </div>\r\n\r\n</div>";

    var verticalTemplate = "<!--Copyright (c) Coherent Labs AD. All rights reserved. Licensed under the MIT License. See License.txt in the project root for license information. -->\r\n<div class=\"guic-vertical-slider-wrapper\">\r\n    <div class=\"guic-slider-vertical-arrow up\"><div class=\"guic-slider-arrow-up\"></div></div>\r\n    <div class=\"guic-slider-vertical-slider\">\r\n        <div class=\"guic-slider-vertical-handle handle\"></div>\r\n    </div>\r\n    <div class=\"guic-slider-vertical-arrow down\"><div class=\"guic-slider-arrow-down\"></div></div>\r\n</div>\r\n";

    var horizontalTemplate = "<!--Copyright (c) Coherent Labs AD. All rights reserved. Licensed under the MIT License. See License.txt in the project root for license information. -->\r\n<div class=\"guic-horizontal-slider-wrapper\">\r\n    <div class=\"guic-slider-horizontal-arrow up\"><div class=\"guic-slider-arrow-left\"></div></div>\r\n    <div class=\"guic-slider-horizontal-slider\">\r\n        <div class=\"guic-slider-horizontal-handle handle\"></div>\r\n    </div>\r\n    <div class=\"guic-slider-horizontal-arrow down\"><div class=\"guic-slider-arrow-right\"></div></div>\r\n</div>\r\n";

    /*---------------------------------------------------------------------------------------------
     *  Copyright (c) Coherent Labs AD. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/

    const orientationUnitsNames = new Map([
        ['vertical', {
            mouseAxisCoords: 'clientY',
            size: 'height',
            sizePX: 'heightPX',
            position: 'top',
            scroll: 'scrollHeight',
        }],
        ['horizontal', {
            mouseAxisCoords: 'clientX',
            size: 'width',
            sizePX: 'widthPX',
            position: 'left',
            scroll: 'scrollWidth',
        }]
    ]);

    /* eslint-disable linebreak-style */


    /**
     * Slider component; can be independently or as a building block of another
     * component - for example a scrollbar. This is a custom slider control, do not
     * confuse with the standard input type slider HTML element.
    */
    class Slider extends HTMLElement {
        /**
         * Set the position of the slider's handler.
         * @param {number} value - the new value in percents.
        */
        set handlePosition(value) {
            this._handlePosition = value;
            // The names of the units vary depending on the orientation
            // of the slider - width for horizontal, height for vertical etc.
            this.handle.style[this.units.position] = value + '%';
        }

        /**
         * Get the current position of the slider's handle in percents.
         * @returns {number} - the value of the position.
        */
        get handlePosition() {
            return this._handlePosition;
        }

        /**
         * Get the current position of the slider's handle in pixels.
         * @returns {number} - the value of the position.
        */
        get handlePositionPx() {
            const sliderSize = this.slider.getBoundingClientRect()[this.units.size];
            return this.handlePosition / 100 * sliderSize;
        }

        // eslint-disable-next-line require-jsdoc
        constructor() {
            super();
            // the amount of units that the slider will be updated
            this.step = this.getAttribute('step') || 10;
            // the initial position of the handle
            this._handlePosition = 0;

            // vertical or horizontal
            this.orientation = this.getAttribute('orientation') || 'vertical';
            // use the template for the current slider orientation
            this.template = (this.orientation === 'vertical') ? verticalTemplate : horizontalTemplate;
            /**
             * The names of the units are different for the two slider types.
             * ['clientY', 'height', 'heightPX', 'top', 'scrollHeight] for vertical and
             * ['clientX', 'width', 'widthPX', 'left', 'scrollWidth] for horizontal
            */
            this.units = orientationUnitsNames.get(this.orientation);

            this.onSlideUp = (e) => { this.onSlideWithArrorws(-1); };
            this.onSlideDown = (e) => { this.onSlideWithArrorws(1); };
            this.onClick = this.onClick.bind(this);
            this.onWheel = this.onWheel.bind(this);
            this.onMouseDown = this.onMouseDown.bind(this);
            this.onMouseMove = this.onMouseMove.bind(this);
            this.onMouseUp = this.onMouseUp.bind(this);
        }

        /**
         * Called when the element was attached to the DOM.
        */
        connectedCallback() {
            // Load the template
            components$1.loadResource(this)
                .then((result) => {
                    this.template = result.template;
                    // render the template
                    components$1.renderOnce(this);
                    // do the initial setup - add event listeners, assign members
                    this.setup();
                })
                .catch(err => console.error(err));
        }

        /**
         * Set the slider and handle members and add event listeners.
        */
        setup() {
            this.slider = this.getElementsByClassName(`guic-slider-${this.orientation}-slider`)[0];
            this.handle = this.getElementsByClassName(`guic-slider-${this.orientation}-handle`)[0];

            this.attachEventListeners();
        }

        // eslint-disable-next-line require-jsdoc
        disconnectedCallback() {
            this.removeEventListeners();
        }
        /**
         * Gets the size of an element in px.
         * Uses the computed styles which return the size in pixels as a string.
         * @param {HTMLElement} element
         * @returns {number} - the size in pixels.
        */
        _getPxSizeWithoutUnits(element) {
            let unitsName = this.units.sizePX;
            if (!navigator.userAgent.includes('Cohtml')) unitsName = unitsName.substring(0, unitsName.length - 2);

            const size = getComputedStyle(element)[unitsName];
            return Number(size.substring(0, size.length - 2));
        }

        /**
         * Update the size of the slider thumb.
         * @param {HTMLElement} scrollableContainer
        */
        resize(scrollableContainer) {
            return components$1.waitForFrames(() => {

                if(!this.slider) {
                    console.log("Trying to resize dead slider");
                    return;
                }

                // get the size of the whole slider element
                const sliderWrapperSize = this._getPxSizeWithoutUnits(this.querySelector(`.guic-${this.orientation}-slider-wrapper`));
                // get the size of the up or down buttons in px
                const controlsSize = this._getPxSizeWithoutUnits(this.querySelector(`.guic-slider-${this.orientation}-arrow`));
                // get the combined size of the up and down buttons in % of the sliderWrapperSize
                const controlsSizePercent = controlsSize * 2 / sliderWrapperSize * 100;

                // get the size of the slider area
                const sliderSize = this.slider.getBoundingClientRect()[this.units.size];
                // get the size of the handle in percents relative to the current scroll(Height/Width)
                const handleSizePercent = (sliderSize / scrollableContainer[this.units.scroll]) * 100;
                // get the size of the handle in px; exclude the controlsSizePercent from the whole size
                const handleSize = (sliderSize / (100 - controlsSizePercent)) * handleSizePercent;
                // set the new size of the handle
                this.handle.style[this.units.size] = handleSize + 'px';

                this.scrollTo(this.handlePositionPx);
            });
        }

        /**
         * Remove event listeners.
         */
        removeEventListeners() {
            // document listeners
            document.removeEventListener('mousemove', this.onMouseMove);
            document.removeEventListener('mouseup', this.onMouseUp);
        }

        /**
         * Add event listeners to handle user interaction.
        */
        attachEventListeners() {
            // local listeners
            this.slider.addEventListener('click', this.onClick);
            this.slider.addEventListener('wheel', this.onWheel);
            this.handle.addEventListener('mousedown', this.onMouseDown);
            this.querySelector('.up').addEventListener('mousedown', this.onSlideUp);
            this.querySelector('.down').addEventListener('mousedown', this.onSlideDown);

            // document listeners
            document.addEventListener('mousemove', this.onMouseMove);
            document.addEventListener('mouseup', this.onMouseUp);
        }

        /**
         * Executed on mousedown. Moves the handle towards the position of the mouse
         * with one step.
         * @param {MouseEvent} event
        */
        onMouseDown(event) {
            // set a flag to help the detection of drag
            this.mousedown = true;
            // get the bounding rectangles of the slider area and the handle
            const handleRect = this.handle.getBoundingClientRect();
            const sliderRect = this.slider.getBoundingClientRect();

            // get the current position of the slider (top or left)
            const sliderY = sliderRect[this.units.position];
            // get the handle position within the slider's coordinates
            const handleY = handleRect[this.units.position] - sliderY;
            const mouseY = event[this.units.mouseAxisCoords] - sliderY;

            // set the difference between the mouse click and the handle position
            // used for better looking drag
            this.delta = mouseY - handleY;
        }

        /**
         * Called on mouseup.
         * Resets the mousedown, dragging and slidingWithArrows properties
         * and clears intervals.
        */
        onMouseUp() {
            this.mousedown = false;
            this.dragging = false;

            if (this.slidingWithArrows) {
                this.slidingWithArrows = false;
                clearInterval(this.interval);
            }
        }

        /**
         * Called on mousemove.
         * Detects dragging and scrolls to the current position of the mouse.
         * @param {MouseEvent} event
        */
        onMouseMove(event) {
            if (!this.mousedown) return;
            this.dragging = true;
            const sliderRect = this.slider.getBoundingClientRect();
            // get the mouse position within the slider coordinates
            const mouseY = event[this.units.mouseAxisCoords] - sliderRect[this.units.position];
            this.scrollTo(mouseY - this.delta);
        }

        /**
         * Called when the arrow controls are used for sliding.
         * Starts an interval and updates the slider position until mouseup occurs.
         * @param {number} direction - 1 for down, -1 for up
        */
        onSlideWithArrorws(direction) {
            this.slidingWithArrows = true;
            this.interval = setInterval(() => this.scrollTo(this.getNextScrollPosition(direction, this.step)), 10);
        }

        /**
         * Scrolls the a given position.
         * @param {number} position
        */
        scrollTo(position) {
            const handleRect = this.handle.getBoundingClientRect();
            const sliderRect = this.slider.getBoundingClientRect();

            const handleSizePercent = (handleRect[this.units.size] / sliderRect[this.units.size]) * 100;
            // new position in %
            let newPosPercents = (position / sliderRect[this.units.size]) * 100;

            // the slider range in percents is [0 - 100 - handleSizePercent]
            // if the new position is outside of this range - snap the handle and
            // scroll to the top or to the bottom
            if (newPosPercents < 0) newPosPercents = 0;
            if (newPosPercents + handleSizePercent > 100) newPosPercents = 100 - handleSizePercent;
            this.handlePosition = newPosPercents;

            // dispatch an event in case something needs to be done on scroll
            this.dispatchEvent(new CustomEvent('slider-scroll', { detail: { handlePosition: newPosPercents } }));
        }

        /**
         * Called on wheel event of the mouse.
         * Scrolls the slider in the position of which the wheel is rotated
         * @param {WheelEvent} event
        */
        onWheel(event) {
            const direction = (event.deltaY < 0) ? -1 : 1;
            this.scrollTo(this.getNextScrollPosition(direction, this.step));
        }

        /**
         * Called on click of the mouse.
         * Updated the handle's position with one step towards the position of the
         * mouse click.
         * @param {MouseEvent} event
        */
        onClick(event) {
            if (event.target.classList.contains('handle')) return;
            let direction = -1;
            if (this.handle.getBoundingClientRect()[this.units.position] < event[this.units.mouseAxisCoords]) direction = 1;
            this.scrollTo(this.getNextScrollPosition(direction, this.step));
        }

        /**
         * Gets the next value of the scroll.
         * @param {number} direction
         * @param {number} step
         * @returns {number} - the new scroll position
        */
        getNextScrollPosition(direction, step = this.step) {
            // get the current scroll postition in px
            const scrollTop = this.handlePosition * this.slider.getBoundingClientRect()[this.units.size] / 100;
            return scrollTop + (direction * step);
        }
    }

    components$1.defineCustomElement('gameface-slider', Slider);

    class ReplayPage extends KsHTMLElement {

        /** @type {MessageHandler} */
        GameModeClient;

        /** @type {MessageHandler} */
        Client;
        /** @type {Btnbasic} */
        btnBack;
        /** @type {Btnbasic} */
        btnSave;

        /** @type {Btnbasic} */
        btnPlay;

        /** @type {Btnbasic} */
        btnGoToStart;

        /** @type {Btnbasic} */
        btnMinusFive;

        /** @type {Btnbasic} */
        btnPlusFive;

        /** @type {Btnbasic} */
        btnReverse;

        /** @type {Btnbasic} */
        btnNextCar;

        /** @type {Btnbasic} */
        btnPrevCar;

        /** @type {Btnbasic} */
        btnDrivable;

        /** @type {Btnbasic} */
        btnTrack;

        /** @type {Btnbasic} */
        btnHelicopter;

        /** @type {Btnbasic} */
        btnOrbit;

        /** @type {Btnbasic} */
        btnFree;

        /** @type {Btnbasic} */
        btnOnboard;



        /** @type {Btnbasic} */
        btnNextLap;

        /** @type {Btnbasic} */
        btnPrevLap;

        // /** @type {Btnbasic} */
        // btnPlayerCar;

        /** @type {HTMLDivElement} */
        markersPanel;

        /** @type {Slider} */
        sliderMultiplier;

        currentMultiplier = 1;

        advanceStep = 1000;

        pnlControls;

        scroller;
        indicatorPosition;
        indicatorPlayed;

        isControlled = false;

        timerHideUI;
        hideInMs = 2000;

        wasPlaying = false;

        isDirty = true;
        exitMessage = "msgConfirmExitReplay";

        listenerActionHandle;
        listenerCarChanged;
        listenerCameraChanged;

        currentCameraModeIndex = 0; 

        filters = {
            positionPercent: (current, total) => {
                let percent = (current / total) * 100;

                activePage.indicatorPosition.style.left = percent + "%";
                activePage.indicatorPlayed.style.width = percent + "%";


                this.classList.toggle("last-lap", current >= this.timestamps[eReplayMarkerType.Laps]?.at(-1));
                this.classList.toggle("first-lap", current <= this.timestamps[eReplayMarkerType.Laps]?.at(0));

                return current;
            }
        };

        constructor() {
            super();
            this.template = template$1;
            this._isnavigable = true;
            this.delayedInit = true;
            this._exposeAsActivePage = true;
            this.messagePrefix = "Replay";
        }

        isPlaying() {
            if (!window["ModelUIReplayState"]) return false;
            return ModelUIReplayState.time_multiplier != 0;
        }

        togglePlay() {
            this.requestNoResponse("TogglePlay", { play: !this.isPlaying() }, false);
        }

        play() {
            this.requestNoResponse("TogglePlay", { play: true }, false);
        }

        focusPlayerCar() {
            this.GameModeClient.requestNoResponse("PlayerCar", { request_type: "GameModeRequestCarNextnSpline" });
        }

        focusNextCar() {
            this.GameModeClient.requestNoResponse("NextCar", { request_type: "GameModeRequestCarNextnSpline" });
        }

        focusPreviousCar() {
            this.GameModeClient.requestNoResponse("PreviousCar", { request_type: "GameModeRequestCarNextnSpline" });
        }

        getCurrentCameraMode() {
            return eCameraModes[this.currentCameraModeIndex];
        }
      
        selectCamera(mode) {       
            this.GameModeClient.requestNoResponse("SpecificCameraMode", {         
                mode           
            });
        }

        pause() {
            this.requestNoResponse("TogglePlay", { play: false });
        }

        goto(msec) {
            this.requestNoResponse("GoToPosition", { msec: Number(msec) });
        }

        nextLap() {
            if (this.currentMsec >= this.timestamps[eReplayMarkerType.Laps].at(-1)) {
                //this.goto(this.timestamps[eReplayMarkerType.Laps].at(0));
                return;
            }
            const nextlaptimestamp = ksUI$1.getNextPreviousInArray(this.currentMsec, this.timestamps[eReplayMarkerType.Laps]);
            console.log("Next lap", nextlaptimestamp);
            this.goto(nextlaptimestamp);
        }

        previousLap() {
            if (this.currentMsec <= this.timestamps[eReplayMarkerType.Laps].at(0)) {
                //this.goto(this.timestamps[eReplayMarkerType.Laps].at(-1));
                return;
            }
            const prevlaptimestamp = ksUI$1.getNextPreviousInArray(this.currentMsec - 1000, this.timestamps[eReplayMarkerType.Laps], true);
            console.log("Previous lap", prevlaptimestamp);
            this.goto(prevlaptimestamp);
        }

        advanceBy(msec) {
            const targetTime = ksUI$1.clamp(this.currentMsec + msec, 0, this.totalMsec);
            if (msec < 0 && Math.abs(msec) > this.currentMsec) {
                this.goto(1);
                return;
            }
            this.goto(targetTime);
        }

        get startingTime() {
            return ModelUIReplayState.starting_time_ms * 1000;
        }

        get currentMsec() {
            return ModelUIReplayState.current_time_ms;
        }

        get totalMsec() {
            return ModelUIReplayState.total_time_ms;
        }

        get multiplier() {
            return this.sliderMultiplier.value;
        }

        get isReverse() {
            return this.btnReverse.isSelected();
        }

        get directionMult() {
            if (this.isReverse) return -1;
            return 1;
        }

        showUIBound;

        showUI(event) {

            if (this.inControls) return;

            const classList = document.body.classList;

            classList.remove("ks-replay-invisible");
            clearTimeout(activePage.timerHideUI);
            this.timerHideUI = setTimeout(() => {
                if (activePage.isPlaying() && !activePage.classList.contains("no-replay")) {
                    classList.add("ks-replay-invisible");
                }
            }, this.hideInMs);


            if (event) {
                if (event.y / window.innerHeight > 0.98) {
                    classList.add("ks-replay-invisible");
                }
            }
        }

        savedReplayModal(message) {
            this.pageModal.Show({
                type: eModalDialogTypes.Warning,
                title: "lblReplayModal",
                message: message,
                buttons: 0x100
            });
        }

        save() {
            this.Client.request("Save",
                {
                    filename: "replay"
                },
                (response) => {
                    ({
                        ["ReplayCommandsResponse_OK"]: () => {
                            console.log("Replay saved");
                            this.savedReplayModal("msgConfrimReplaySaved");
                            this.isDirty = false;
                        },
                        ["ReplayResponse_CRITICAL_ERROR"]: () => {
                            console.error("Replay failed to save");

                            this.savedReplayModal("msgFailedToSaveReplay");
                        }
                    }[response.response])();
                });
        }

        advanceTimer;
        lastAdvance = 0;

        inControls = true;

        bindControls() {
            this.listenerCarChanged = engine.on("FocusedCarChangedEvent", () => {
                console.trace("FocusedCarChangedEvent");
                waitForFrames(() => {
                    this.getMarkers();
                });
            });

            this.btnPlay.onPressed = (sender, e) => {
                this.togglePlay();
            };

            this.btnGoToStart.onPressed = () => {
                this.goto(1);
            };

            this.btnPlusFive.onPressed = () => {
                this.advanceBy(5000);
            };

            this.btnMinusFive.onPressed = () => {
                this.advanceBy(-5000);
            };

            this.btnNextLap.onPressed = this.nextLap.bind(this);
            this.btnPrevLap.onPressed = this.previousLap.bind(this);

            this.btnNextCar.onPressed = this.focusNextCar.bind(this);
            this.btnPrevCar.onPressed = this.focusPreviousCar.bind(this);
            //this.btnPlayerCar.onPressed = this.focusPlayerCar.bind(this);

            this.btnDrivable.onPressed = this.handleCameraSelection(eGameModeCameraMode.Drivable);
            this.btnTrack.onPressed = this.handleCameraSelection(eGameModeCameraMode.Track);
            this.btnHelicopter.onPressed = this.handleCameraSelection(eGameModeCameraMode.Helicopter);
            this.btnOrbit.onPressed = this.handleCameraSelection(eGameModeCameraMode.Orbit);
            this.btnFree.onPressed = this.handleCameraSelection(eGameModeCameraMode.Free);
            this.btnOnboard.onPressed = this.handleCameraSelection(eGameModeCameraMode.OnBoard);

            this.sliderMultiplier.addEventListener("onSliderValueChanged", (ev) => {
                const value = ev.detail.value;
                this.requestNoResponse("SetTimeMultiplier", { time_mutiplayer: Number(value), pause: !this.isPlaying() }, false);
            });

            this.btnReverse.onToggled = (sender, e, state) => {
                console.log("Toggling replay reverse direction", state);
                this.requestNoResponse("ToggleReverse", { reverse: state }, false);
            };

            this.scroller.onmousedown = (event) => {

                //console.log(event.target.className, event.currentTarget.id);

                if (event.target.classList.contains("label")) {
                    console.log("Skip to laptime", event.target.parentElement.timestamp);
                    this.goto(event.target.parentElement.timestamp);
                    return;
                }

                this.isControlled = true;
                this.scroller.classList.add("controlled");

                //this.pause();

                let rect = this.scroller.getBoundingClientRect();
                let x = event.x - rect.left;
                let percent = x / rect.width;

                this.goto(Math.min(Math.round(this.totalMsec * percent), this.totalMsec));

            };

            this.pnlControls.addEventListener("mouseenter", (event) => {
                ksUI$1.menuState.toggleMouseHover(true);
                this.inControls = true;
                clearTimeout(this.timerHideUI);
            });

            this.pnlControls.addEventListener("mouseleave", (event) => {
                ksUI$1.menuState.toggleMouseHover(false);
                this.inControls = false;
                this.showUI();
            });

            this.pnlControls.onmousemove = (event) => {
                if (!this.isControlled) return;

                let rect = this.scroller.getBoundingClientRect();
                let x = event.x - rect.left;
                let percent = x / rect.width;
                this.goto(Math.min(Math.round(this.totalMsec * percent), this.totalMsec));
            };

            this.onmouseup = (event) => {
                this.isControlled = false;
                this.scroller.classList.remove("controlled");
            };

            this.pnlControls.onmouseleave = this.scroller.onmouseup;

            this.showUIBound = this.showUI.bind(this);

            window.addEventListener("mousemove", this.showUIBound);
            window.addEventListener("mousedown", this.showUIBound);

            this.listenerActionHandle = engine.on("UIExInputsAction", (e) => {

                if (e.action.indexOf("InputAction_UI") > -1) {
                    this.inControls = false;
                    this.showUI();
                }

                let delta;

                function advance(value, perc = 0.01) {
                    clearTimeout(this.advanceTimer);
                    this.advanceBy(value);

                    delta = Date.now() - this.lastAdvance;

                    if (this.lastAdvance != null && delta >= 200 && delta <= 215) {
                        this.advanceStep = ksUI$1.clamp(this.advanceStep + (this.totalMsec * perc), 1000, 60000);
                    }

                    this.lastAdvance = Date.now();
                }

                const adv = advance.bind(this);

                switch (e.action) {
                    case ("InputAction_UI_Confirm"):
                        if (document.activeElement == this.scroller) {
                            this.togglePlay();
                        }
                        break;
                    case ("InputAction_UI_Left"):
                        if (document.activeElement == this.scroller) {
                            adv(-this.advanceStep, 0.005);
                        }
                        break;
                    case ("InputAction_UI_Right"):
                        if (document.activeElement == this.scroller) {
                            adv(this.advanceStep, 0.005);
                        }
                        break;
                    case ("InputAction_UI_PageUp"):
                        this.nextLap();
                        //adv(this.advanceStep);
                        break;
                    case ("InputAction_UI_PageDown"):
                        this.previousLap();
                        //adv(-this.advanceStep);
                        break;
                }

                this.advanceTimer = setTimeout(() => {
                    this.advanceStep = 1000;
                }, 225);
            });
        }

        handleCameraSelection(mode) {
            return () => {            
                this.currentCameraModeIndex = eCameraModes.indexOf(mode);          
                this.selectCamera(this.getCurrentCameraMode());
            };
        }

        exitReplay() {
            if (this.isDirty && this.totalMsec > 0) {
                this.pageModal.Show({
                    type: eModalDialogTypes.Warning,
                    title: "lblReplayModal",
                    message: this.exitMessage,
                    buttons: 0x101
                });

                this.pageModal.onConfirm = () => {
                    this.requestNoResponse("Quit");
                    ksUI$1.returnToOrigin();
                };
            } else {
                this.requestNoResponse("Quit");
                ksUI$1.returnToOrigin();
            }
        }

        timestamps = {};

        markersData = null;

        clearMarkers() {
            this.timestamps = {};
            this.markersData = null;
            this.markersPanel.innerHTML = "";
        }

        getMarker(markerdata, markertype) {
            const elem = document.createElement("div");
            elem.classList.add("marker");
            elem.classList.add(markertype);
            //elem.classList.add(eReplayMarkerType.Incidents);

            const icon = document.createElement("div");
            icon.classList.add("icon");
            elem.appendChild(icon);

            const text = document.createElement("div");
            text.classList.add("label");
            if (markerdata.lap_number != undefined) {
                text.textContent = markerdata.lap_number;
                elem.classList.add(`lap${markerdata.lap_number}`);
            }
            elem.appendChild(text);

            elem.timestamp = markerdata.timestamp;

            if (!this.timestamps[markertype]) {
                this.timestamps[markertype] = [markerdata.timestamp];
            } else {
                this.timestamps[markertype].push(markerdata.timestamp);
            }

            elem.style.left = `${(markerdata.timestamp / this.totalMsec) * 100}%`;
            return elem;
        }

        renderMarkers(laps, markertype) {
            const dfrag = document.createDocumentFragment();

            laps.forEach(lap => {
                if (lap.timestamp <= this.totalMsec) {
                    dfrag.appendChild(this.getMarker(lap, markertype));
                }
            });

            this.markersPanel.appendChild(dfrag);
        }

        getMarkers() {
            this.Client.request("FocusedCarMarker",
                {
                    request_type: eReplayMarkerType.All
                },
                (data) => {

                    this.clearMarkers();
                    this.markersData = data;
                    this.renderMarkers(data.laps, eReplayMarkerType.Laps);
                    this.renderMarkers(data.incidents, eReplayMarkerType.Incidents);

                });
        }

        onAfterRenderControlHints(controlhints) {

            this.btnBack = q(".back", controlhints);
            this.btnSave = q(".apply", controlhints);

            this.btnBack.onPressed = () => {
                this.exitReplay();
            };

            this.btnSave.onPressed = () => {
                this.save();
                this.btnSave.setAttribute('disabled', 'disabled');
            };
        }

        onTemplateLoaded() {
            ksUI$1.Models.enable(DataModels.SessionState);
            ksUI$1.Models.enable(DataModels.ReplayState);

            super.onTemplateLoaded();
            this.mapElementById("btnPlay");
            this.mapElementById("btnGoToStart");
            this.mapElementById("btnPlusFive");
            this.mapElementById("btnMinusFive");
            this.mapElementById("btnReverse");
            this.mapElementById("sliderMultiplier");
            this.mapElementById("indicatorPosition");
            this.mapElementById("indicatorPlayed");
            this.mapElementById("scroller");
            this.mapElementById("pnlControls");

            this.mapElementById("btnNextCar");
            this.mapElementById("btnPrevCar");
            this.mapElementById("btnDrivable");
            this.mapElementById("btnTrack");
            this.mapElementById("btnHelicopter");
            this.mapElementById("btnOrbit");
            this.mapElementById("btnFree");
            this.mapElementById("btnOnboard");

            this.mapElementById("btnDrivable");
            this.mapElementById("btnTrack");
            this.mapElementById("btnHelicopter");
            this.mapElementById("btnOrbit");
            this.mapElementById("btnFree");
            this.mapElementById("btnOnboard");

            this.mapElementById("btnNextLap");
            this.mapElementById("btnPrevLap");

            this.mapElementById("markersPanel");

            this.Client = new MessageHandler("Replay");
            this.GameModeClient = new MessageHandler("GameMode");

            this.showUI();

            this.togglePlay();

            if (ksUI$1.menuState.getOrigin().some(origin => origin.includes("gallery"))) {
                this.exitMessage = "msgGoBackToReplayGallery";
                q("#btnSave").style.display = "none";
            }


            this.getMarkers();
        }

        onRemovedFromDOM() {
            super.onRemovedFromDOM();
            window.removeEventListener("mousemove", this.showUIBound);
            window.removeEventListener("mousedown", this.showUIBound);

            if (this.listenerCameraChanged) this.listenerCameraChanged.clear();
            if (this.listenerCarChanged) this.listenerCarChanged.clear();
            if (this.listenerActionHandle) this.listenerActionHandle.clear();

            ksUI$1.Models.disable(DataModels.ReplayState);

        }

    }
    engine.on("MenuStateInit", () => {
        ksUI$1.registerModule('ks-page-replay', ReplayPage);
    });

    var template = "<div class=\"component-body\">\r\n\r\n    <div class=\"safety\"></div>\r\n    <div class=\"buttons\">\r\n        <ks-btnbasic class=\"language\" data-language=\"en\">\r\n            <div slot=\"name\">EN</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic class=\"language\" data-language=\"it\">\r\n            <div slot=\"name\">IT</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic class=\"language\" data-language=\"es\">\r\n            <div slot=\"name\">ES</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic class=\"language\" data-language=\"fr\">\r\n            <div slot=\"name\">FR</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic class=\"language\" data-language=\"de\">\r\n            <div slot=\"name\">DE</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic class=\"language\" data-language=\"cn\">\r\n            <div slot=\"name\">CN</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic class=\"language\" data-language=\"ru\">\r\n            <div slot=\"name\">RU</div>\r\n        </ks-btnbasic>\r\n\r\n\r\n        <ks-btnbasic class=\"main\" goto=\"/menu.html\" path=\"main/main\" reload>\r\n            <div slot=\"name\">Main Menu</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic id=\"btnIntro\" class=\"main\" goto=\"/intro.html\" path=\"firststart/playerinfo\" reload>\r\n            <div slot=\"name\">First Start</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic class=\"hud\" goto=\"/hud.html\" path=\"main/main\" reload>\r\n            <div slot=\"name\">HUD</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic class=\"pitlane\" goto=\"/ingame.html\" path=\"pitlane/main\" reload>\r\n            <div slot=\"name\">Pitlane</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic class=\"paintshop\" goto=\"/paintshop.html\" path=\"main/main\" reload>\r\n            <div slot=\"name\">Paintshop</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic class=\"empty\" goto=\"/demo.html\" path=\"main/main\" reload>\r\n            <div slot=\"name\">Timetable</div>\r\n        </ks-btnbasic>\r\n\r\n\r\n        <ks-btnbasic class=\"empty\" goto=\"/empty.html\" path=\"main/main\" reload>\r\n            <div slot=\"name\">None</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic id=\"btnToggleRelease\" toggle>\r\n            <div slot=\"name\">R</div>\r\n        </ks-btnbasic>\r\n\r\n        <ks-btnbasic class=\"reload\">\r\n            <div slot=\"name\">Reload</div>\r\n        </ks-btnbasic>\r\n    </div>\r\n</div>";

    class DevReloadButton extends KsHTMLElement {

        /** @type Btnbasic */
        btnMain;
        /** @type Btnbasic */
        btnHud;
        /** @type Btnbasic */
        btnIntro;
        /** @type Btnbasic */
        btnToggleRelease;

        constructor() {
            super();
            this.template = template;
            this.delayedInit = true;
        }

        onTemplateLoaded() {
            super.onTemplateLoaded();

            this.mapElementById("btnIntro");
            this.mapElementById("btnToggleRelease");

            let fakingRelease = localStorage.getItem("fakeRelease") == "true";
            document.body.classList.toggle("release-build", fakingRelease);
            this.btnToggleRelease.classList.toggle("selected", fakingRelease);
        }

        bindControls() {


            qAll("ks-btnbasic.language").forEach(
                /** @param {Btnbasic} btn */
                (btn) => {
                    btn.onPressed = (sender, e) => {
                        ksUI$1.changeLanguage(sender.dataset.language);
                        waitForFrames(() => window.location.reload(true), 1);
                    };
                }
            );

            this.btnToggleRelease.onPressed = (e) => {
                let b = document.body.classList.toggle("release-build");
                b ? localStorage.setItem("fakeRelease", b) : localStorage.removeItem("fakeRelease");
            };

            this.btnIntro.onBeforeRedirect = () => {
                ksUIConfig.skipintro = false;
                ksUI$1.storeUIConfig();
            };

            this.onmouseenter = () => {

            };

            document.addEventListener("keydown", (event) => {
                if (event.keyCode === 116) {
                    window.location.reload(true);
                    //ksUI.goTo(window.location.pathname);                
                }
            });

            this.querySelector("ks-btnbasic.reload").addEventListener("click", (e) => {
                window.location.reload(true);
                //ksUI.goTo(window.location.pathname);
            });
        }

    }

    if (ksUI$1.isDevOrTester()) {
        ksUI$1.registerModule('ks-dev-reloadbutton', DevReloadButton);
    }

    class StorageManager extends BaseManager {

        Client = new MessageHandler("UIStorage");

        /** @type {Array} */
        #data = [];

        /** @type {Array} */
        dataParsed = [];

        /** @type {Map} */
        dataMap = new Map();

        constructor(parent_element) {
            super(null, parent_element);

            this.load().then(response => {
                console.log("StorageManager data loaded");
            }).catch(response => {
                console.log("StorageManager new data file", response.response);
            });

        }

        stringifyValues() {
            const temp_data = Array.from(this.dataMap, ([key, value]) => ({ key, value }));
            temp_data.forEach(item => {
                item.value = JSON.stringify(item.value, (key, value) =>
                    typeof value === "bigint" ? value.toString() + "n" : value
                );
                item.__Type = "StorageEntry";
            });
            return temp_data;
        }

        load() {
            return new Promise((resolve, reject) => {
                this.Client.request("Storage", (data) => {
                    if (data.response == "UIStorageCommandsResponse_OK") {
                        this.#data = data.storage.storage;

                        this.dataMap = new Map();

                        this.#data.forEach(item => {
                            let value = "";

                            try {
                                value = JSON.parse(item.value, (key, value) => {
                                    if (typeof value === "string" && /^\d+n$/.test(value)) {
                                        return BigInt(value.substr(0, value.length - 1));
                                    }
                                    return value;
                                });
                            } catch {
                                console.trace("StorageManager", item.key, "value is not valid JSON");
                            }

                            this.dataMap.set(item.key, value);
                        });

                        resolve(data.storage.storage);
                    } else {
                        console.error("StorageManager unable to retrieve stored data", data.response);
                        reject(data);
                    }
                });
            });
        }

        save(calling_key) {
            return new Promise((resolve, reject) => {
                this.Client.request("SetStorage", {
                    storage: { __Type: "UIStorage", storage: this.stringifyValues() }
                }, (data) => {
                    if (data.response == "UIStorageCommandsResponse_OK") {
                        console.log("StorageManager data saved", calling_key ?? "");
                        resolve();
                    } else {
                        console.error("StorageManager unable to save data", calling_key ?? "");
                        reject();
                    }
                });
            });
        }

        /**
         * 
         * @param {*} key 
         * ATTENTION: returns a reference
         */
        get(key) {
            return this.dataMap.get(key);
        }

        has(key) {
            return this.dataMap.has(key);
        }

        set(key, value) {
            this.dataMap.set(key, value);
        }

        delete(key, soft = false) {
            if (soft === true) {
                this.dataMap.delete(key);
            } else {
                this.Client.request("DeleteKey", { key: key }, data => {
                    this.dataMap.delete(key);
                    console.trace(`StorageManager permanently deleted key '${key}'`);
                });
            }
        }

        get entries() {
            return this.dataMap.entries();
        }

        get keys() {
            return this.dataMap.keys();
        }

        get values() {
            return this.dataMap.values();
        }

        get size() {
            return this.dataMap.size;
        }


    }

    if (window.console && console.trace) {
        var oldTrace = console.trace;
        console.trace = function (msg, ... params) {
            console.groupCollapsed(msg || 'trace');
            oldTrace.apply(this, params);
            console.groupEnd();
        };
    }

    window["Language"] = "en";

    function Init() {

        console.log("UI init called");

        let normalload = localStorage.getItem("game_loaded") == 'true';

        waitForFrames(() => {
            q("body").classList.add("loaded");
        }, normalload ? 1 : 1);

        waitForFrames(() => {
            q("body").classList.add("transition");
        }, normalload ? 2 : 2);

        console.log("Register page events");

        if (localStorage.getItem("force-playermodeselection") == null) {
            localStorage.setItem("force-playermodeselection", true);
        }

        engine.on('changePage', (new_path, notransition, silent = false) => {

            console.warn(document.body.className);

            if (!silent)
                console.log(">> changePage", location.pathname, "::", state.activeMenu, state.activeSubMenu, notransition);

            if (!notransition) {
                q("body").classList.remove("transition");
            }

            let path_split = new_path.split("/");
            let state = ksUI$1.menuState.get();

            state.path = new_path;

            state.activeMenu = path_split[0];
            state.activeSubMenu = path_split[1] ? path_split[1] : "main";

            ksUI$1.menuState.save();

            waitForFrames(() => {
                q("body").classList.add("transition");
                //ksUI.validateComponents();
            }, 3);

            console.trace(">> changePage", window.location.pathname, location.pathname, "::", state.activeMenu, state.activeSubMenu, notransition);
            engine.trigger("afterChangePage");

        });

        engine.on("afterChangePage", () => {
            ksUI$1.triggerUICommand("OnPageLoaded", { path: location.pathname, page: ModelMenuState.activeMenu, subpage: ModelMenuState.activeSubMenu }, true);

            if (ksUI$1.isInLoadingTransition()) {
                ksUI$1.hideLoadingModal();
            }
        });

        engine.on("goTo", (page, path, notransition) => {
            ksUI$1.goTo(page, path, notransition);
        });

        console.log("Arming UIGameModeEvent");

        engine.on("UIGameModeEvent", (message) => {
            console.log("UIGameModeEvent", message, message.command, message.parameters);
            // ksUI.iterate(message);
            switch (message.command) {
                case "goto":
                    ksUI$1.goTo(message.parameters[0],
                        message.parameters[1],
                        message.parameters[2],
                        message.parameters[3]);
                    break;
                case "goto_loadingpage":
                    ksUI$1.showLoadingModal();
                    break;
                case "hide_loadingpage":
                    ksUI$1.hideLoadingModal();
                    break;
                case "goto_origin":
                    ksUI$1.exitToReturnPageNoLoading(false);
                    break;
                case "reload":
                    window.location.reload(true);
                    break;
            }
        });

        //console.log("Arming UINotification");

        //notificationHandler = engine.on("UINotification", (message) => {

        if (!q("ks-notificationpanel")) {
            /** @type NotificationPanel */
            const notificationpanel = document.createElement("ks-notificationpanel");
            const container = q(".absolutecenter #main-container");

            if (container) {
                container.appendChild(notificationpanel);
            } else {
                document.body.appendChild(notificationpanel);
            }

        }

        //notificationHandler.clear();
        //});
        window["STORAGE"] = new StorageManager();
        window["VEHICLES"] = new CarSelectionManager();
        window["CUSTOMIZATION"] = new CarCustomizationManager();
        window["SHOWROOM"] = new ShowroomManager();

        window["ECONOMY"] = new GameEconomyManager();
        window["GAMEMODESELECTION"] = new GameModeSelectionManager();

        engine.trigger("onInit");

        ksUI$1.triggerUICommand("OnPageLoaded", { path: location.pathname, page: ModelMenuState.activeMenu, subpage: ModelMenuState.activeSubMenu }, true);
    }

    class ksUILockedStateHandler {
        init(element, value) {
            element.isUILocked = value;
            window.isUILocked = value;
        }

        deinit(element) {
        }

        update(element, value) {


            if (element.isUILocked != value) {
                engine.trigger("OnUILocked", value);
            }

            document.body.classList.toggle("ui-locked", value);

            element.isUILocked = value;
            window.isUILocked = value;
        }
    }

    class ksBackendStateHandler {
        init(element, value) {
            element.isBackendConnected = value.is_backend_connected;
            element.isSandBox = value.is_sandbox;
            window.isSandBox = value.is_sandbox;
            window.isBackendConnected = value;
        }

        deinit(element) {
        }

        update(element, value) {

            if (element.isBackendConnected != value.is_backend_connected) {
                engine.trigger("OnBackendConnectionChanged", value.is_backend_connected);
            }

            element.classList.toggle("offline-mode", !value.is_backend_connected);

            element.isBackendConnected = value.is_backend_connected;
            window.isBackendConnected = value;

            element.classList.toggle("sandbox-mode", value.is_sandbox);
            element.classList.toggle("career-mode", !value.is_sandbox);

            element.isSandBox = value.is_sandbox;
            element.isCareer = !value.is_sandbox;

            window.isSandBox = value.is_sandbox;
            window.isCareer = !value.is_sandbox;

        }

    }

    class ksValueHandler {

        init(element, value) {
            if (element.dataset)
                element.dataset.value = value;
            element.setAttribute("data-value", value);

            if (element.bindValue) {
                element.bindValue(value);
            }
        }

        deinit(element) {
        }

        update(element, value) {
            element.setAttribute("data-value", value);
            if (element.dataset)
                element.dataset.value = value;

            if (element.onBindingUpdate) {
                element.onBindingUpdate("ksvalue", value);
            }
        }
    }

    class ksHtmlValueHandler {

        init(element, value) {
            element.innerHTML = value;
            if (element.bindValue) {
                element.bindValue(value);
            }
        }

        deinit(element) {
        }

        update(element, value) {
            // console.log("update", element.tagName, value);
            element.innerHTML = value;

            if (element.onBindingUpdate) {
                element.onBindingUpdate("htmlvalue", value);
            }

        }
    }

    class ksInputValueHandler {

        init(element, value) {
            element.setAttribute("value", value);
            element.value = value;

            if (element.bindValue) {
                element.bindValue(value);
            }
        }

        deinit(element) {
        }

        update(element, value) {
            element.value = value;
            //console.log("update", element.tagName, value);
            element.setAttribute("value", value);
            if (element.onBindingUpdate) {
                element.onBindingUpdate("inputvalue", value);
            }

        }
    }

    class ksDisableAttrHandler {

        init(element, value) {

            if (value == false || value == "") {
                element.removeAttribute("disabled");
            } else {
                element.setAttribute("disabled", value);
            }

            if (element.bindValue) {
                element.bindValue(value);
            }
        }

        deinit(element) {
        }

        update(element, value) {
            if (value == false || value == "") {
                element.removeAttribute("disabled");
            } else {
                element.setAttribute("disabled", value);
            }
        }
    }

    class ksMessageHandler {
        init(element, value) {
            if (value)
                if (value.__Type) {
                    if (!element.messages) {
                        element.messages = {};
                        if (element.onBindingUpdate) {
                            element.onBindingUpdate("ksmessage", value, true);
                        }
                    }
                    element.messages[value.__Type] = value;
                } else {
                    console.warn("Attempting to use ksMessageHandler on non-message object (init)");
                }
        }

        deinit(element) {
            if (element.onMessageBindingRemoved) {
                element.onMessageBindingRemoved();
            }
        }

        update(element, value) {
            if (value)
                if (value.__Type) {
                    element.messages[value.__Type] = value;
                    if (element.onBindingUpdate) {
                        element.onBindingUpdate("ksmessage", value, false);
                    }
                } else {
                    console.warn("Attempting to use ksMessageHandler on non-message object (update)");
                }
        }
    }

    class ksLocalizationHandler {
        init(element, value) {
            if (value != undefined) {
                element.innerHTML = engine.translate(value);
            }
        }
        deinit(element) {

        }
        update(element, value) {
            if (value != undefined)
                element.innerHTML = engine.translate(value);
        }
    }

    resize();
    window.addEventListener('resize', resize);
    window.addEventListener("wheel", (e) => { e.preventDefault(); });

    engine.on("Error", (message) => {
        console.error("Engine error", message);
    });

    engine.on("TriggerValidation", () => { ksUI$1.validateComponents(); });

    engine.whenReady.then(() => {
        console.log(">> Gameface Engine Ready");

        window["buildTags"] = [];
        navigator.userAgent.toLowerCase().match(/[^{\}]+(?=})/g)?.forEach(tag => {
            document.body.setAttribute(`tag-${tag}`, "");
            window["buildTags"].push(tag);
        });
        engine.registerBindingAttribute("ksvalue", ksValueHandler);
        engine.registerBindingAttribute("inputvalue", ksInputValueHandler);
        engine.registerBindingAttribute("htmlvalue", ksHtmlValueHandler);
        engine.registerBindingAttribute("disablevalue", ksDisableAttrHandler);
        engine.registerBindingAttribute("backend-state", ksBackendStateHandler);
        engine.registerBindingAttribute("ui-lock-state", ksUILockedStateHandler);
        engine.registerBindingAttribute("ksmessage", ksMessageHandler);
        engine.registerBindingAttribute("l10n-id", ksLocalizationHandler);


        window["AP"] = (context = "activePage") => {
            return window[context];
        };

        window["APF"] = (context = "activePage") => {
            return window[context]?.filters;
        };

        window["APRF"] = (context = "activePage") => {
            return window[context]?.rootPage?.filters;
        };

        window["rootModal"] = () => {
            return q("ks-modaldialog");
        };

        const localstoredLanguage = localStorage.getItem("language");

        if (localstoredLanguage != null) {
            document.documentElement.setAttribute("lang", localstoredLanguage);
        } else {
            ksUI$1.request("GameEconomyClient", "PersonalSettings", response => {
                const language = response.personal_settings.language != "" ? response.personal_settings.language : "en";
                document.documentElement.setAttribute("lang", language);
                localStorage.setItem("language", language);
            });
        }

        ksUI$1.menuState.update((model) => {
            engine.trigger("MenuStateInit");
            Init();
            ksUI$1.Init();
            console.log("Init: menuState updated", window.location.pathname, ModelMenuState.activeMenu, ModelMenuState.activeSubMenu, "- full path:", ModelMenuState.path);
            localStorage.setItem("game_loaded", true);
        });


        engine.on("UIGameModeEvent", (message) => {
            if (message.command == "scene_loaded") {
                console.log("scene_loaded");
            }
        });

        document.addEventListener("mouseout", (e) => {

            if (document.body.classList.contains("spatialnav")) return;
            ksUI$1.clearFocus();

        });

        document.addEventListener("transitionend", (e) => {
            if (e.target.id == "main-container" && !(document.body.classList.contains("modalselect-active") || document.body.classList.contains("ks-modaldialog-active"))) {
                if (ksUI$1.lastFocusedElement) {
                    ksUI$1.indicateFocus(ksUI$1.lastFocusedElement, true);
                }
            }
        });

        if(document.body.hasAttribute("data-bind-class-toggle")) {
            const current = document.body.getAttribute("data-bind-class-toggle");
            document.body.setAttribute("data-bind-class-toggle", `${current};ui-locked:{{ModelUIState.lock_ui}}`);
        } else {
            document.body.setAttribute("data-bind-class-toggle", "ui-locked:{{ModelUIState.lock_ui}}");
        }

        const overlay_locked = document.createElement("div");
        overlay_locked.id = "locked-overlay";
        overlay_locked.innerHTML = "<div class='logo'></div><div class='indicator'></div>";
        document.body.appendChild(overlay_locked);

        initComponents();
    });

    function initComponents() {
        console.log("Init Components");
        engine.trigger(EngineEvents.UI.RegisterModules);
    }

    var handleRegister = engine.on(EngineEvents.UI.RegisterModules, () => {
        handleRegister.clear();
    });

    Array.prototype.forEachAsync = async function (fn) {
        for (let t of this) { await fn(t); }
    };

    Array.prototype.forEachAsyncParallel = async function (fn) {
        await Promise.all(this.map(fn));
    };

    Storage.prototype.setObject = function (key, value) {
        this.setItem(key, JSON.stringify(value));
    };

    Storage.prototype.getObject = function (key) {
        var value = this.getItem(key);
        return value && JSON.parse(value);
    };

}));
//# sourceMappingURL=components.js.map
